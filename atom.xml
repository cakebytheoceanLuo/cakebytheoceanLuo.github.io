<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å…³äºæ•°æ®åº“çš„ä¸€åˆ‡</title>
  <icon>https://www.gravatar.com/avatar/60437615b712b01d1a7c334c61fc1a4f</icon>
  <subtitle>ç½—æµé«˜çš„åšå®¢</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://cakebytheoceanluo.github.io/"/>
  <updated>2020-04-11T14:24:49.993Z</updated>
  <id>https://cakebytheoceanluo.github.io/</id>
  
  <author>
    <name>ç½—æµé«˜</name>
    <email>luojigao@outlook.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>DSC [11.6-11.7] Hashing</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/11/DSC-11-6-11-7-Hashing/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/11/DSC-11-6-11-7-Hashing/</id>
    <published>2020-04-11T14:19:16.000Z</published>
    <updated>2020-04-11T14:24:49.993Z</updated>
    
    <content type="html"><![CDATA[<h1 id="11-6-Static-Hashing"><a href="#11-6-Static-Hashing" class="headerlink" title="11.6 Static Hashing"></a>11.6 Static Hashing</h1><ul><li>One disadvantage of <strong>sequential file organization</strong> is that we must access an index structure to locate data, or must use binary search, and that results in more I/O operations. æ€»ä¹‹å¾ˆæ…¢ </li><li>File organizations based on the technique of hashing allow us to avoid accessing an index structure. Hashing also provides a way of constructing indices.</li></ul><p><br></p><p><strong>Bucket</strong> := a unit of storage that can store one or more records. <strong>A bucket is typically a disk block, but could be chosen to be smaller or larger than a disk block.</strong> Bucketä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé¡µ(page)</p><p>$K$ := the set of all search-key values</p><p>$B$ := the set of all bucket addresses. </p><p>A hash function $h: K \rightarrow B$</p><p>$n_b$ := number of buckets</p><p><br></p><p><strong>Insert</strong> a record with search key $K_i$ at bucket with address $h(K_i)$. Assume for now that there is space in the bucket to store the record. Then, the record is stored in that bucket</p><p><strong>Look up</strong>: <em>check the search-key value</em> of every record in bucket with address $h(K_i)$</p><p><strong>Delete</strong>: Loop up + delete the found record</p><p><strong>Two different purposes of Hasing:</strong></p><ul><li>In a <strong>hash file organization</strong>, we obtain the address of the disk block containing a desired record directly byã€€computing a function on the search-key value of the record. </li><li>In a <strong>hash index organization</strong> we organize the search keys, with their associated pointers, into a hash file structure. ã€€ã€€è§11.6.3</li></ul><p>å…¶å®å“ˆå¸Œè¡¨åœ¨æ•°æ®åº“ä¸­æœ‰æ›´å¤šç”¨é€”ï¼Œè§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Data-Structure-in-DBMS">[CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨ Data Structure in DBMS</a></p><h2 id="11-6-1-Hash-Function"><a href="#11-6-1-Hash-Function" class="headerlink" title="11.6.1 Hash Function"></a>11.6.1 Hash Function</h2><p>Typical hash functions perform computation on the internal binary machine representation of characters in the search key. A simple hash function of this type first computes the sum of the binary representations of the characters of a key, then returns the sum modulo the number of buckets. åŸºäºäºŒè¿›åˆ¶å½¢å¼ï¼Œåšä¸€äº›ä½æ“ä½œ(bit operation)</p><p>Hash functions require careful design. A bad hash function may result in lookup taking time proportional to the number of search keys in the file. A well-designed function gives an average-case lookup time that is a (small) constant, independent of the number of search keys in the file.</p><h3 id="Two-Qualities"><a href="#Two-Qualities" class="headerlink" title="Two Qualities"></a>Two Qualities</h3><p>An ideal hash function distributes the stored keys uniformly across all the buckets, so that every bucket has the same number of records. We want to choose a hash function that assigns search-key values to buckets in such a way that the distribution has <em>two</em> qualities:</p><ul><li><strong>The distribution is uniform</strong>: the hash function <strong>assigns each bucket the same number of search-key values</strong> from the set of all possible search-key values.</li><li><strong>The distribution is random</strong>: in the average case, each bucket will have nearly the same number of values assigned to it, <strong>regardless of the actual distribution of search-key values</strong>. More precisely, <strong>the hash value will not be correlated to any externally visible ordering on the search-key values</strong>, such as alphabetic ordering or ordering by the length of the search keys; the hash function will appear to be </li><li>ç¬¬ä¸€ç‚¹æŒ‡çš„æ˜¯<strong>distribution of search-key values is uniform</strong>, è¿™ä¸ªåˆ†å¸ƒå’Œå®é™…çš„æ•°æ®é›†(record)æ— å…³ã€‚åªæ˜¯è€ƒè™‘æ¯ä¸€ä¸ªbucketç†è®ºæ¥æ”¶çš„search keyçš„æ•°é‡ã€‚</li><li>ç¬¬äºŒç‚¹æŒ‡çš„æ˜¯<strong>distribution of search-key values is random</strong>, èƒ½è·å¾—<strong>distribution of records is uniform</strong>, å³æ•°æ®é›†(record)ç›¸å…³ã€‚å®ƒå¯ä»¥å»æ‰ç›¸å…³è”(ä¸ç›¸ç­‰)çš„search-keyä¸­çš„å…³è”, ä½¿è¿™äº›å…³è”çš„search-keyçš„å“ˆå¸Œå€¼éšæœºåŒ–, ä¹Ÿå¤±å»åŸæœ‰çš„å…³è”ã€‚</li></ul><h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>1.<em>People Name</em>â€˜s Hash Function: mapping names beginning with the ith letter of the alphabet to the ith bucket and having 26 buckets.</p><ul><li>simple</li><li>no uniform distribution: <strong>more</strong> names to begin with such letters as B and R than Q and X, for example.</li></ul><p>2.Salaryâ€™s Hash Function: the minimum salary is $30,000 and the maximum salary is $130,000, and we use a hash function that <strong>divides the values into 10 ranges</strong>, $30,000-$40,000, $40,001-$50,000 and so on.</p><ul><li><strong>uniform</strong> distribution of search-key values (since each bucket has the same number of different salary values)</li><li>no random distribution. Records with salaries between $60,001 and $70,000 are <strong>far more common than</strong> are<br>records with salaries between $30,001 and $40,000. As a result, <strong><em>the distribution of records</em></strong> is not uniform - some buckets receive more records than others do. <strong>If the function has a random distribution, even if there are such correlations in the search keys, the randomness of the distribution will make it very likely that all buckets will have roughly the same number of records, as long as each search key occurs in only a small fraction of the records.</strong> (If a single search key occurs in a large fraction of the records, the bucket containing it is likely to have more records than other buckets, regardless of the hash function used.)</li></ul><p>3.Let $s$ be a string of length $n$, and let $s[i]$ denote the $i$th byte of the string. </p><ul><li>The hash function is defined as: $h(s) = s[0] âˆ— 31(nâˆ’1) + s[1] âˆ— 31(nâˆ’2) + Â·Â·Â· + s[n âˆ’ 1] \; \% \; n_b$</li></ul><p><br></p><h2 id="11-6-2-Handling-of-Bucket-Overflows"><a href="#11-6-2-Handling-of-Bucket-Overflows" class="headerlink" title="11.6.2 Handling of Bucket Overflows"></a>11.6.2 Handling of Bucket Overflows</h2><p>Bucket overflow can occur for several reasons:</p><ul><li><strong>Insufficient buckets</strong>:<br>The number of buckets $n_b$ must be chosen such that $n_b &gt; n_r / f_r$, where $n_r$ denotes the total number of records that will be stored and $f_r$ denotes the number of records that will fit in a bucket. <strong>This designation assumes that the total number of records is known when the hash function is chosen.</strong> The probability of bucket overflow is reduced, the number of buckets<br>is chosen to be $(n_r / f_r) âˆ— (1 + d)$, where d is a fudge factor, typically around 0.2. Some space is wasted: About 20 percent of the space in the buckets will be empty.</li><li><strong>Skew</strong>:<br>Some buckets are <strong>assigned more records than are others</strong>, so a bucket may overflow even when other buckets still have space. This situation is called bucket <em>skew</em>. Skew can occur for two reasons:<ol><li>Multiple records may have <strong>the same search key</strong>.ã€€(è§åé¢<a href="#insertion">Dynamic Hashing - Insertion</a>ä¸­çš„å¯¹é‡å¤çš„æè¿° å’Œ <a href="#ä¾‹å­">ä¾‹å­ä¸­ç¬¬äº”æ­¥</a>)</li><li>The chosen hash function may result in non-uniform distribution of search keys (å·²ç»åœ¨<a href="#two-qualities">Two Qualities</a>ä¸­è®¨è®ºè¿‡)</li></ol></li></ul><h3 id="Overflow-Buckets"><a href="#Overflow-Buckets" class="headerlink" title="Overflow Buckets"></a>Overflow Buckets</h3><p>We handle bucket overflow by using <strong>overflow buckets</strong>. If a record must be inserted into a bucket b, and b is already full, the system provides an overflow bucket for $b$, and inserts the record into the overflow bucket. If the overflow bucket is also full, the system provides another overflow bucket, and so on. </p><p>All the overflow buckets of a given bucket are chained together in a linked list, as in <em>Figure 11.24</em>. Overflow handling using such a linked list is called <strong>overflow chaining</strong>. ä¹Ÿå«hashing with chainingæˆ–chained hashing, è§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Chained-Hashing">[CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨- Chained Hashing</a></p><p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.24.png" alt="Figure 11.24 Overflow chaining in a hash structure."></p><h4 id="Lookup-Algorithm"><a href="#Lookup-Algorithm" class="headerlink" title="Lookup Algorithm"></a>Lookup Algorithm</h4><p>The system uses the hash function on the search key to identify a bucket $b$. The system must examine all the records in bucket $b$ to see whether they match the search key, as before. In addition, if bucket $b$ has overflow buckets, the system must examine the records in all the overflow buckets also.</p><h4 id="Closed-Addressing-Hashing-amp-Open-Addressing-Hashing"><a href="#Closed-Addressing-Hashing-amp-Open-Addressing-Hashing" class="headerlink" title="Closed Addressing Hashing &amp; Open Addressing Hashing"></a>Closed Addressing Hashing &amp; Open Addressing Hashing</h4><p>The form of hash structure with <strong>overflow buckets</strong> referred to as <strong>closed addressing hashing</strong>. An important drawback of closed addressing hashing is that we must choose the hash function when we implement the system, and itã€€cannot be changed easily thereafter if the file being indexed grows or shrinks. Since the function $h$ maps search-key values to a fixed set $B$ of bucket addresses, we waste space if $B$ is made large to handle future growth of the file. If $B$ is too small, the buckets contain records of many different search-key values, and bucket overflows can occur. <strong>As the file grows, performance suffers</strong>. </p><p>An alternative approach <strong>open addressing hashing</strong>: </p><ul><li>the set of buckets is fixed, and there are no overflow chains. </li><li>Instead, if a bucket is full, the system inserts records in some other bucket in the initial set of buckets $B$.<ul><li>One policy <strong>linear probing</strong> is to use the next bucket (in cyclic order) that has space</li><li>Other policies, such as computing further hash functions, are also used. </li></ul></li></ul><p>Open addressing hashing has been used to construct symbol tables for compilers and assemblers, but closed addressing hashing is preferable for database systems. The reason is that <strong>deletion under open addressing hashing</strong> is troublesome. Usually, compilers and assemblers perform only lookup and insertion operations on their symbol tables. However, in a database system, it is important to be able to handle deletion as<br>well as insertion. Thus, open addressing hashing is of only minor importance in database implementation.</p><p>å®é™…ä¸Šopen addressing hashingåœ¨æ•°æ®åº“ä¾ç„¶å¾ˆå¸¸è§è¢«åº”ç”¨çš„ï¼Œç‰¹åˆ«æ˜¯hash joinä¸­æˆ‘ä»¬åªä½¿ç”¨hash tableçš„lookupå’Œinsert, æ ¹æœ¬ä¸deleteã€‚æ›´å¤šç”¨é€”è§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Data-Structure-in-DBMS">[CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨ Data Structure in DBMS</a></p><h2 id="11-6-3-Hash-Indices"><a href="#11-6-3-Hash-Indices" class="headerlink" title="11.6.3 Hash Indices"></a>11.6.3 Hash Indices</h2><p>Hashing can be used not only for file organization, but also for <strong>index-structure creation</strong>. </p><p><strong>A hash index organizes the search keys, with their associated pointers, into a hash file structure</strong>. We construct a hash index as follows. We apply a hash function on a search key to identify a bucket, and store the key and its associated pointers in the bucket (or in overflow buckets). <em>Figure 11.25</em> shows a secondary hash index on the instructor file, for the search key ID. The hash function in the figure computes the sum of the digits of the ID modulo 8. The hash index has eight buckets, each of size 2 (realistic indices would, of course, have much larger bucket sizes). One of the buckets has three keys mapped to it, so it has an overflow bucket. In this example, ID is a primary key for instructor, so each search key has only one associated pointer. In general, multiple pointers can be associated with each key.</p><p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.25.png" alt="Figure 11.25 Hash index on search key *ID* of instructor file."></p><ul><li>å›¾ä¸­<code>33456</code>æ˜¯ä¸€ä¸ª<strong>åˆ°å¦ä¸€ä¸ªbucketçš„æŒ‡é’ˆ</strong>ï¼Œå…¶ä½™çš„æŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘æ–‡ä»¶ä½ç½®ã€‚åœ¨è¿™è¿™é‡Œæˆ‘ä»¬æ··æ·†æˆ–è€…æ™®éåŒ–<em>æŒ‡é’ˆ</em>è¿™ä¸ªè¯ï¼Œå®ƒåœ¨è¿™é‡ŒæŒ‡å†…å­˜ä¸Šçš„åœ°å€å’Œç¡¬ç›˜ä¸Šçš„åœ°å€ã€‚</li></ul><p>We use the term hash index to denote hash file structures as well as secondary hash indices. Strictly speaking, hash indices are only secondary index structures. A hash index is never needed as a clustering index structure, since, if a file itself is organized by hashing, there is no need for a separate hash index structure on it. However, since hash file organization provides the same direct access to records that indexing provides, we pretend that a file organized by hashing also has a clustering hash index on it.</p><h1 id="11-7-Dynamic-Hashing"><a href="#11-7-Dynamic-Hashing" class="headerlink" title="11.7 Dynamic Hashing"></a>11.7 Dynamic Hashing</h1><p>Extendable hashing is one form of dynamic hashing techniques, which allow the hash function to be <strong>modified dynamically to accommodate the growth or shrinkage of the database</strong>. </p><h2 id="11-7-1-Data-Structure"><a href="#11-7-1-Data-Structure" class="headerlink" title="11.7.1 Data Structure"></a>11.7.1 Data Structure</h2><ul><li>Space Efficiency: Extendable hashing copes with changes in database size by splitting and coalescing buckets as the database grows and shrinks. </li><li>Low Performance Overhead: the reorganization is performed on only one bucket at a time</li></ul><p>Hash Function: $h$ generates values over a relatively large range ($b$-bit binary integers). A typical value for $b$ is 32.</p><p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.26.png" alt="Figure 11.26 General extendable hash structure"></p><ul><li>We do not create a bucket for each hash value. Indeed, $2^{32}$ is over 4 billion, and that many buckets is unreasonable for all but the largest databases. </li><li>Instead, we <strong>create buckets on demand</strong>, as records are inserted into the file. We do not use the entire b bits of the hash value initially. </li><li>At any point, we use <strong>$i$ bits indicating that $i$ bits of the hash value $h(K)$ are required to determine the correct bucket for $K$</strong>, where $0 \leq i \leq b$. These $i$ bits are used as an offset into an additional table of bucket addresses. The value of $i$ grows and shrinks with the size of the database.</li><li>All such entries will have <strong>a common hash prefix</strong>, but the length of this prefix may be <strong>less than $i$</strong>. Therefore, we associate with each bucket an integer giving the length of the common hash prefix. In <em>Figure 11.26</em> the integer associated with bucket $j$ is shown as $i_j$. The number of bucket-address-tableentries that point to bucket $j$ is $2^{(i-i_j)}$</li><li>å›¾ä¸­å·¦ä¾§<code>bucket address table</code>ä¹Ÿç§°ä¸º<code>global directory</code></li><li>å›¾ä¸­å³ä¾§<code>bucket</code>ä¹Ÿç§°ä¸º<code>local bucket</code></li></ul><h2 id="11-7-2-Queries-and-Updates"><a href="#11-7-2-Queries-and-Updates" class="headerlink" title="11.7.2 Queries and Updates"></a>11.7.2 Queries and Updates</h2><p>search-key value $K_l$</p><h3 id="Lookup"><a href="#Lookup" class="headerlink" title="Lookup"></a>Lookup</h3><ol><li>take the first $i$ high-order bits of $h(K_l)$</li><li>look at the corresponding <strong>bucket address table entry</strong> for this bit string</li><li>follow the <strong>bucket pointer</strong> in the table entry.</li></ol><h3 id="Insertion"><a href="#Insertion" class="headerlink" title="Insertion"></a>Insertion</h3><ol><li>å…ˆæŒ‰ç…§Lookup æ‰¾åˆ°å¯¹åº”çš„bucket (è§<a href="#-loopup">Loopupæ­¥éª¤</a>)</li><li>bucketæ˜¯å¦æ»¡äº†: <ul><li>æ²¡æœ‰æ»¡: ç®€å•æ’å…¥å³å¯</li><li>æ»¡: If the bucket is full, it <strong>must split the bucket</strong> and <strong>redistribute the current records</strong>, plus the new one. To split the bucket, the system <strong>must first determine from the hash value whether it needs to increase the number of bits that it uses</strong>.<ul><li>If $i = i_j$, only one entry in the bucket address table points to bucket $j$: <ul><li>The system needs to <strong>increase the size of the bucket address table</strong> so that it can include pointers to the two buckets that result from splitting bucket $j$. It does so by considering an additional bit of the hash value. It increments the value of $i$ by 1, thus doubling the size of the bucket address table. <strong>It replaces each entry by two entries, both of which contain the same pointer as the original entry. Now two entries in <em>the bucket address table</em> point to bucket $j$</strong>. </li><li>The system allocates a new bucket (bucket $z$), and sets the second entry to point to the new bucket. It sets $i_j$ and $i_z$ equal to $i$. </li><li>Next, it rehashes each record in bucket $j$ and, depending on the first $i$ bits (remember the system has added 1 to $i$), either keeps it in bucket $j$ or allocates it to the newly created bucket $z$.</li><li>The system now reattempts the insertion of the new record. <ul><li>Usually, the attempt will succeed. </li><li>However, if all the records in bucket $j$, as well as the new  record, have the same hash-value prefix, it will be necessary to split a bucket again, since all the records in bucket $j$ and the new record are assigned to the same bucket. If the hash function has been chosen carefully, it is unlikely that a single insertion will require that a bucket be split more than once, <strong>unless there are a large number of records with the same search key</strong>.<br>If all the records in bucket $j$ have the <strong>same search-key value (å³å…è®¸å‡ºç°é‡å¤çš„key value)</strong>, no amount of splitting will help. In such cases, overflow buckets are used to store the records, as in static hashing. (è§<a href="#ä¾‹å­">ä¾‹å­ä¸­ç¬¬äº”æ­¥</a>)</li></ul></li></ul></li><li>If $i &gt; i_j$, then more than one entry in the bucket address table points to bucket $j$. <ul><li><strong>The system can split bucket $j$ without increasing the size of the bucket address table</strong>. Observe that all the entries that point to bucket $j$ correspond to hash prefixes that have the same value on the leftmost $i_j$ bits.</li><li><strong>The system allocates a new bucket (bucket $z$), and sets $i_j$ and $i_z$ to the value that results from adding 1 to the original $i_j$ value.</strong> </li><li>Next, the system needs to <strong>adjust the entries in <em>the bucket address table</em> that previously pointed to bucket $j$</strong>. (Note that with the new value for $i_j$, not all the entries correspond to hash prefixes that have the same value on the leftmost $i_j$ bits.) The system leaves the first half of the entries as they were (pointing to bucket $j$), and sets all the remaining entries to point to the newly created bucket (bucket $z$).</li><li>Next, as in the previous case, the system rehashes each record in bucket $j$, and allocates it either to bucket $j$ or to the newly created bucket $z$.</li></ul></li><li><strong>Note that, in both cases, the system needs to recompute the hash function on only the records in bucket $j$.</strong></li><li>æ€»ä½“ä¸Š: $i = i_j$çš„æƒ…å†µåªæ¯”$i &gt; i_j$çš„æƒ…å†µå¤šäº†ä¸€æ­¥, å³<strong>increase the size of the bucket address table</strong>ã€‚</li></ul></li></ul></li></ol><h3 id="Deletion"><a href="#Deletion" class="headerlink" title="Deletion"></a>Deletion</h3><ol><li>å…ˆæŒ‰ç…§Lookup æ‰¾åˆ°å¯¹åº”çš„bucket (è§<a href="#-loopup">Loopupæ­¥éª¤</a>)</li><li>It removes both the search key from the bucket and the record from the file. </li><li>The bucket is removed if it becomes empty. Note that, at this point, several buckets can be coalesced, and the size of the bucket address table can be cut in half.</li><li>The bucket address table can be reduced in size. Unlike coalescing of buckets, changing the size of the bucket address table is a rather expensive operation if the table is large. Therefore it may be worthwhile to reduce the bucket-address-table size only if the number of buckets reduces greatly.</li></ol><p><br></p><blockquote><p>Let $i$ denote the number of bits of the hash value used in the hash table. Let <strong>bsize</strong> denote the maximum capacity of each bucket. The pseudocode is shown in Figure 11.2.<br>Note that we can <strong>only merge two buckets at a time</strong>. The common hash prefix of the resultant bucket will have length one less than the two buckets merged. Hence we look at the buddy bucket of bucket $j$ differing from it only at the last bit. If the common hash prefix of this bucket is not $i_j$, then this implies that the buddy bucket has been further split and merge is not possible.<br>When merge is successful, further merging may be possible, which is handled by a recursive call to <em>coalesce</em> at the end of the function. <sup><a href="#fn1">1</a></sup></p></blockquote><p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.S4.png" alt="11.Solution. <sup>[1](#fn1)</sup>"></p><p><br><br><br></p><h3 id="ä¾‹å­-1"><a href="#ä¾‹å­-1" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>Search Key: <em>dept_name</em> with 32-bit hash value<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.27.png" alt="Figure 11.27 Hash Function for *dept_name*."></p><p><br><br><br></p><p>To illustrate all the features of extendable hashing in a small structure, we shall make the unrealistic assumption that a bucket can hold only two records.</p><ol><li><p>The file is empty:<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.28.png" alt="Figure 11.28 Initial extendable hash structure."></p></li><li><ul><li>insert record (10101, Srinivasan, Comp. Sci., 65000); </li><li>insert record (12121, Wu, Finance, 90000); </li><li>insert record (15151, Mozart, Music, 40000);<ul><li>split since $i_0$ full and $i=i_0$;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.29.png" alt="Figure 11.29 Hash structure after three insertions."></li></ul></li></ul></li><li><ul><li>insert record (22222,Einstein,Physics,95000);<ul><li>split since $i_1$ full and $i=i_1$;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.30.png" alt="Figure 11.30 Hash structure after four insertions."></li></ul></li></ul></li><li><ul><li>insert record (32343, El Said, History, 60000);</li><li>insert record (33456, Gold, Physics, 87000);<ul><li>split since $i_1$ full and $i=i_1$;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.31.png" alt="Figure 11.31 Hash structure after six insertions."></li></ul></li></ul></li><li><ul><li>insert record (45565, Katz, Comp. Sci., 75000);<ul><li>split since $i_3$ full;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.32.png" alt="Figure 11.32 Hash structure after seven insertions."></li></ul></li></ul></li><li><ul><li>insert record (58583, Califieri, History, 62000);</li><li>insert record (83821, Brandt, Comp. Sci., 92000);<ul><li>This overflow cannot be handled by increasing the number of bits, since there are three records with exactly the same hash value. Hence the system uses an overflow bucket.<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.33.png" alt="Figure 11.33 Hash structure after eleven insertions."></li></ul></li></ul></li><li><ul><li>insert record (98345, Kim, Elec. Eng., 80000);<ul><li>split since $i_0$ full;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.34.png" alt="Figure 11.34 Extendable hash structure for the instructor file."></li></ul></li></ul></li></ol><h1 id="11-7-3-Static-Hashing-versus-Dynamic-Hashing"><a href="#11-7-3-Static-Hashing-versus-Dynamic-Hashing" class="headerlink" title="11.7.3 Static Hashing versus Dynamic Hashing"></a>11.7.3 Static Hashing versus Dynamic Hashing</h1><p>å®é™…ä¸Šæ˜¯è®¨è®º<strong>extendable hashingçš„ä¼˜ç¼ºç‚¹</strong></p><h2 id="Advantages"><a href="#Advantages" class="headerlink" title="Advantages"></a>Advantages</h2><ul><li><strong>performance does not degrade</strong> as the file grows </li><li><strong>minimal space overhead</strong>: Although the bucket address table incurs additional overhead, it contains one pointer for each hash value for the current prefix length. This table is thus small. The main space saving of extendable hashing over other forms of hashing is that no buckets need to be reserved for future growth; rather, buckets can be allocated dynamically.</li></ul><h2 id="Disadvantages"><a href="#Disadvantages" class="headerlink" title="Disadvantages"></a>Disadvantages</h2><ul><li>lookup involves <strong>an additional level of indirection (ä½¿ç”¨ä¸€æ¬¡æŒ‡é’ˆ)</strong>, since the system <strong>must access the bucket address table</strong> before accessing the bucket itself. This extra reference has only a minor effect on performance. Although the hash structures that we discussed in Section 11.6 do not have this extra level of indirection, they lose their minor performance advantage as they become full.</li></ul><p>another form of dynamic hashing: <strong>linear hashing</strong>, which avoids the extra level of indirection associated with extendable hashing, at the possible cost of more overflow buckets. <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Linear-Hashing">è§åšå®¢å¦ä¸€ç¯‡æ–‡ç« : [CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨ - Linear Hashing</a></p><hr><h1 id="Errata-2"><a href="#Errata-2" class="headerlink" title="Errata 2"></a>Errata <sup><a href="#fn2">2</a></sup></h1><p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.E1.png" alt="Errata"></p><p>17å·²ç»è¢«æˆ‘åœ¨è¿™ç¯‡æ–‡ç« ä¸­çº æ­£</p><p>18åœ¨å›¾ä¸­ï¼Œä½†æ˜¯ä¸é‡è¦</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><p><a name="#fn1">1</a>: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L3ByYWN0aWNlLWV4ZXItZGlyL2luZGV4Lmh0bWw=" title="https://www.db-book.com/db6/practice-exer-dir/index.html">https://www.db-book.com/db6/practice-exer-dir/index.html<i class="fa fa-external-link"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L3ByYWN0aWNlLWV4ZXItZGlyLzExcy5wZGY=" title="https://www.db-book.com/db6/practice-exer-dir/11s.pdf">https://www.db-book.com/db6/practice-exer-dir/11s.pdf<i class="fa fa-external-link"></i></span></p></li><li><p><a name="#fn2">2</a>: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L2VycmF0YS1kaXIvZXJyYXRhLXBhcnQzLnBkZg==" title="https://www.db-book.com/db6/errata-dir/errata-part3.pdf">https://www.db-book.com/db6/errata-dir/errata-part3.pdf<i class="fa fa-external-link"></i></span></p></li><li><p>Abraham Silberschatz, Henry F. Korth, S. Sudarshan: <strong>Database System Concepts</strong>, 6th Edition. McGraw-Hill Book Company 2010</p><ul><li>6th Edition: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db6/index.html">https://www.db-book.com/db6/index.html<i class="fa fa-external-link"></i></span></li><li>7th Edition: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI3L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db7/index.html">https://www.db-book.com/db7/index.html<i class="fa fa-external-link"></i></span></li></ul></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;11-6-Static-Hashing&quot;&gt;&lt;a href=&quot;#11-6-Static-Hashing&quot; class=&quot;headerlink&quot; title=&quot;11.6 Static Hashing&quot;&gt;&lt;/a&gt;11.6 Static Hashing&lt;/h1&gt;&lt;ul&gt;

      
    
    </summary>
    
    
      <category term="Database System Concepts" scheme="https://cakebytheoceanluo.github.io/categories/Database-System-Concepts/"/>
    
    
      <category term="Hash Function" scheme="https://cakebytheoceanluo.github.io/tags/Hash-Function/"/>
    
      <category term="Hash Scheme" scheme="https://cakebytheoceanluo.github.io/tags/Hash-Scheme/"/>
    
      <category term="Static Hashing Scheme" scheme="https://cakebytheoceanluo.github.io/tags/Static-Hashing-Scheme/"/>
    
      <category term="Dynamic Hashing Scheme" scheme="https://cakebytheoceanluo.github.io/tags/Dynamic-Hashing-Scheme/"/>
    
      <category term="Chained Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Chained-Hashing/"/>
    
      <category term="Extendible Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Extendible-Hashing/"/>
    
      <category term="Books" scheme="https://cakebytheoceanluo.github.io/tags/Books/"/>
    
  </entry>
  
  <entry>
    <title>Database System Concepts-ç²¾è¯»</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/10/DSC-0/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/10/DSC-0/</id>
    <published>2020-04-10T16:41:55.000Z</published>
    <updated>2020-04-10T16:45:58.202Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¬”è®°æ–‡ç« é“¾æ¥"><a href="#ç¬”è®°æ–‡ç« é“¾æ¥" class="headerlink" title="ç¬”è®°æ–‡ç« é“¾æ¥"></a>ç¬”è®°æ–‡ç« é“¾æ¥</h1><!-- - Chapter 11 Indexing and Hashing: -->  <!-- - 11.6-7 Hashing: TODO: LINK --><p>æ­¤åŒºåŸŸæŒç»­æ›´æ–°</p><hr><a id="more"></a><h1 id="ç¬”è®°æ¦‚è¦"><a href="#ç¬”è®°æ¦‚è¦" class="headerlink" title="ç¬”è®°æ¦‚è¦"></a>ç¬”è®°æ¦‚è¦</h1><p>æ­¤ç³»åˆ—æ–‡ç« ä¼šä¸å®šæ—¶æ›´æ–°ã€‚<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8">ğŸ˜„</span></p><p>æˆ‘åœ¨è¿™é‡Œåˆ†äº«æˆ‘çš„è¯»ä¹¦ç¬”è®°, æˆ‘ä½¿ç”¨æ˜¯è¿™æœ¬ä¹¦ç¬¬å…­ç‰ˆ: Abraham Silberschatz, Henry F. Korth, S. Sudarshan: <strong>Database System Concepts</strong>, 6th Edition. McGraw-Hill Book Company 2010</p><blockquote><ul><li>å¸†èˆ¹ä¹¦ï¼šAbraham Silberschatz, Henry F. Korth, S. Sudarshan: <strong>Database System Concepts</strong>, 6th Edition. McGraw-Hill Book Company 2010<ul><li>ç¬¬å…­ç‰ˆ: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db6/index.html">https://www.db-book.com/db6/index.html<i class="fa fa-external-link"></i></span></li><li>ç¬¬ä¸ƒç‰ˆ 2019: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI3L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db7/index.html">https://www.db-book.com/db7/index.html<i class="fa fa-external-link"></i></span></li><li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8xMDU0ODM3OS8=" title="https://book.douban.com/subject/10548379/">https://book.douban.com/subject/10548379/<i class="fa fa-external-link"></i></span></li><li>æ³¨: é«˜ç­‰æ•™è‚²å‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yNjA0NTkzMS8=" title="https://book.douban.com/subject/26045931/">https://book.douban.com/subject/26045931/<i class="fa fa-external-link"></i></span></li><li>æ³¨: æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yMDQ4MDY5My8=" title="https://book.douban.com/subject/20480693/">https://book.douban.com/subject/20480693/<i class="fa fa-external-link"></i></span></li></ul></li></ul></blockquote><p>â€” å¼•ç”¨è‡ªæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/10/books/">[DBMS Books] æ•°æ®åº“ä¹¦ç±æ¨è</a></p><p>æˆ‘çš„ç¬”è®°å±äº<strong>ç²¾è¯»ç»†è¯»</strong>, å¤§è‡´ä¸Šæˆ‘ä¼šä»”ç»†çœ‹å¯¹åº”çš„éƒ¨åˆ†ä¸¤æ¬¡, ç„¶åç•™ä¸‹ç¬”è®°ã€‚æˆ‘çš„ç›®æ ‡æ˜¯: </p><ul><li>åœ¨æˆ‘<strong>é‡è§†éƒ¨åˆ†</strong>ç¬”è®°ä¼šä½¿ç”¨åŸæ–‡é‡çš„50%ã€‚æˆ‘é‡è§†éƒ¨åˆ†å¤§è‡´å’Œ<strong>æ•°æ®åº“çš„å®ç°å’Œç®—æ³•ç›¸å…³</strong>ã€‚</li><li>æˆ‘ç›®å‰å…ˆä¸å¤„ç†<strong>ä¸å¤ªé‡è§†éƒ¨åˆ†</strong>ã€‚æ¯”å¦‚æ•°æ®åº“çš„ç†è®ºçš„éƒ¨åˆ†: Relation Algebra, Function Dependence.</li></ul><p>å› æ­¤æˆ‘çš„ç¬”è®°ä¼šå¼ºçƒˆä¾èµ–äºè‹±æ–‡åŸæ–‡ã€‚ç¬”è®°å¯¹æˆ‘ä¸ªäººçš„ç”¨é€”æ˜¯ï¼Œåœ¨å®ç°çš„æ—¶å€™å¯ä»¥æœ‰å¾ˆå¤§çš„å¸®åŠ©å’Œæç¤º(æ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä¸ä¼šå¤§é‡æ›´æ”¹åŸæ–‡)ã€‚å¯¹äºå¤§å®¶ï¼Œå¯ä»¥æŠŠæˆ‘çš„ç¬”è®°æƒ³è±¡æˆåŸä¹¦çš„ç²¾ç®€ç‰ˆã€‚æˆ–è€…å¯ä»¥è¯»å®Œä¹¦ä»¥åï¼Œé‚£æˆ‘çš„ç¬”è®°å»å¤ä¹ ã€‚</p><p>æˆ‘å…·ä½“ä¼š<strong>å¢åŠ </strong>çš„åœ°æ–¹:</p><ul><li>æ®µè½é‡æ–°æ’åº</li><li>æ·»åŠ å°‘é‡æ³¨é‡Šå’Œè§£é‡Š(<strong>ä½¿ç”¨ä¸­æ–‡</strong>)</li><li>æ·»åŠ åˆ°å…¶å®ƒç¬”è®°çš„é“¾æ¥</li><li>é‡æ–°ç»„ç»‡è¯­è¨€</li></ul><p>æˆ‘å…·ä½“ä¼š<strong>ä¿ç•™</strong>çš„éƒ¨åˆ†:</p><ul><li>æ•°æ®åº“å®ç°ç›¸å…³<ul><li>æ•°æ®åº“ä¸­çš„ç®—æ³•å’Œæ•°æ®ç»“æ„</li></ul></li><li>å„ä¸ªæ¦‚å¿µçš„å®šä¹‰</li><li>å„ä¸ªéƒ¨åˆ†çš„å…³è”æ€§å’Œä¼˜ç¼ºç‚¹</li></ul><p>æˆ‘å…·ä½“ä¼š<strong>å»æ‰</strong>çš„åœ°æ–¹:</p><ul><li>éæ ¸å¿ƒä¾‹å­</li><li>å»æ‰æ•™ç§‘ä¹¦ä¸­é‡å¤æç¤ºçš„éƒ¨åˆ†</li></ul><h1 id="å£°æ˜"><a href="#å£°æ˜" class="headerlink" title="å£°æ˜"></a>å£°æ˜</h1><p>æ­¤ç³»åˆ—æ–‡ç« ä¸æ„æˆå•†ä¸šè¡Œä¸ºï¼Œè‹¥æœ‰ä¾µæƒï¼Œæˆ‘ç«‹å³åˆ é™¤ã€‚</p><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><p>æˆ‘åœ¨è¿™ä¸€ç¯‡æ–‡ç« ä¸­å¯¹æˆ‘è¿™æœ¬ä¹¦çš„è¯»ä¹¦ç¬”è®°å¼•ç”¨è¿›è¡Œå£°æ˜:</p><p>Abraham Silberschatz, Henry F. Korth, S. Sudarshan: <strong>Database System Concepts</strong>, 6th Edition. McGraw-Hill Book Company 2010</p><ul><li>6th Edition: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db6/index.html">https://www.db-book.com/db6/index.html<i class="fa fa-external-link"></i></span></li><li>7th Edition: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI3L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db7/index.html">https://www.db-book.com/db7/index.html<i class="fa fa-external-link"></i></span></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ç¬”è®°æ–‡ç« é“¾æ¥&quot;&gt;&lt;a href=&quot;#ç¬”è®°æ–‡ç« é“¾æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç¬”è®°æ–‡ç« é“¾æ¥&quot;&gt;&lt;/a&gt;ç¬”è®°æ–‡ç« é“¾æ¥&lt;/h1&gt;&lt;!-- - Chapter 11 Indexing and Hashing: --&gt;
  &lt;!-- - 11.6-7 Hashing: TODO: LINK --&gt;
&lt;p&gt;æ­¤åŒºåŸŸæŒç»­æ›´æ–°&lt;/p&gt;
&lt;hr&gt;
    
    </summary>
    
    
      <category term="Database System Concepts" scheme="https://cakebytheoceanluo.github.io/categories/Database-System-Concepts/"/>
    
    
      <category term="Books" scheme="https://cakebytheoceanluo.github.io/tags/Books/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(7)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/09/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-7/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/09/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-7/</id>
    <published>2020-04-09T13:37:29.000Z</published>
    <updated>2020-04-09T13:38:14.738Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨äº†è§£äº†çª—å£å‡½æ•°åï¼Œ æˆ‘ä»¬è¿™æ¬¡å¯¹å®ƒè¿›è¡Œæœ€å(?)ä¸€æ¬¡ç»ƒä¹ ã€‚æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªç§‹æœ‰é—®é¢˜ï¼Œå³ä¸€äº›è¿ç»­çš„æ•°å­—æ˜¯å¦è¢«ä½¿ç”¨å®Œã€‚è¿™æ¬¡çš„æ•°æ®é›†ç›´æ¥å­˜åœ¨äºSQLè¯­å¥é‡Œé¢ã€‚</p><a id="more"></a><h1 id="ç§‹æ¸¸é—®é¢˜"><a href="#ç§‹æ¸¸é—®é¢˜" class="headerlink" title="ç§‹æ¸¸é—®é¢˜"></a>ç§‹æ¸¸é—®é¢˜</h1><p>æˆ‘ä»¬ç”¨SQLä¸ºä¸‹é¢çš„é—®é¢˜å»ºç«‹ä¸€ä¸ªæ¨¡å‹ï¼š</p><ul><li>æˆ‘ä»¬åœ¨Aç‚¹åˆ°Bç‚¹æ¸¸ç©ï¼Œè¿™ä¸¤ç‚¹ä¹‹å‰æœ‰å¾ˆå¤šè·¯æ®µå¯ä»¥å»æ¸¸ç©ï¼Œè€Œæˆ‘ä»¬ä»¥åŠæ¸¸ç©è¿‡å…¶ä¸­éƒ¨åˆ†çš„è·¯æ®µäº†</li><li><code>trails</code>æŒ‡æ‰€æœ‰çš„è·¯æ®µï¼Œè¿™äº›è·¯æ®µæœ‰è‡ªå·±çš„<code>id</code>å»ç¡®å®šå”¯ä¸€æ€§<ul><li>æˆ‘ä»¬ä¸€å…±æœ‰ä¸¤ç§è·¯æ®µ, åˆ†åˆ«ä¸º<code>id</code>0å’Œ1ï¼Œ <code>leg</code>é•¿åº¦ä¸º28å’Œ15</li></ul></li><li><code>completed</code>æŒ‡æˆ‘ä»¬å·²ç»ç©è¿‡çš„è·¯æ®µ</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> completed;</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="å®Œæˆè¿ç»­çš„è·¯æ®µçš„æ•°é‡"><a href="#å®Œæˆè¿ç»­çš„è·¯æ®µçš„æ•°é‡" class="headerlink" title="å®Œæˆè¿ç»­çš„è·¯æ®µçš„æ•°é‡"></a>å®Œæˆè¿ç»­çš„è·¯æ®µçš„æ•°é‡</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span> (*)</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> trail_id,</span><br><span class="line">                    leg - row_number() <span class="keyword">over</span> (</span><br><span class="line">                        <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">                        <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">section</span></span><br><span class="line">    <span class="keyword">from</span> completed</span><br><span class="line">) <span class="keyword">as</span> temp;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> count </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line">     5</span><br><span class="line">(1 row)</span><br></pre></td></tr></tbody></table></figure><p>è¿™é¢˜ä¸­è¡¨æ ¼çš„æ€è·¯æ˜¯</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> trail_id,</span><br><span class="line">                leg,</span><br><span class="line">                row_number() <span class="keyword">over</span> (</span><br><span class="line">                    <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> leg),</span><br><span class="line">                leg - row_number() <span class="keyword">over</span> (</span><br><span class="line">                    <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">section</span></span><br><span class="line"><span class="keyword">from</span> completed</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> trail_id, <span class="keyword">section</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> trail_id | leg | row_number | section </span><br><span class="line"><span class="comment">----------+-----+------------+---------</span></span><br><span class="line">        1 |   1 |          1 |       0</span><br><span class="line">        1 |   2 |          2 |       0</span><br><span class="line">        1 |   3 |          3 |       0</span><br><span class="line">        1 |   8 |          4 |       4</span><br><span class="line">        1 |   9 |          5 |       4</span><br><span class="line">        1 |  22 |          6 |      16</span><br><span class="line">        1 |  23 |          7 |      16</span><br><span class="line">        2 |   1 |          1 |       0</span><br><span class="line">        2 |   2 |          2 |       0</span><br><span class="line">        2 |  11 |          3 |       8</span><br><span class="line">        2 |  12 |          4 |       8</span><br><span class="line">(11 rows)</span><br></pre></td></tr></tbody></table></figure><p><code>section</code>å€¼ç›¸åŒçš„éƒ¨åˆ†ï¼Œå±äºè¿ç»­çš„è·¯æ®µ</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> trail_id,</span><br><span class="line">                leg - row_number() <span class="keyword">over</span> (</span><br><span class="line">                    <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">section</span></span><br><span class="line"><span class="keyword">from</span> completed</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> trail_id, <span class="keyword">section</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> trail_id | section </span><br><span class="line"><span class="comment">----------+---------</span></span><br><span class="line">        1 |       0</span><br><span class="line">        1 |       4</span><br><span class="line">        1 |      16</span><br><span class="line">        2 |       0</span><br><span class="line">        2 |       8</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="æ±‚è¿ç»­è·¯æ®µé•¿åº¦çš„å¹³å‡å€¼ï¼Œæœ€å¤§å€¼å’Œæœ€å°å€¼"><a href="#æ±‚è¿ç»­è·¯æ®µé•¿åº¦çš„å¹³å‡å€¼ï¼Œæœ€å¤§å€¼å’Œæœ€å°å€¼" class="headerlink" title="æ±‚è¿ç»­è·¯æ®µé•¿åº¦çš„å¹³å‡å€¼ï¼Œæœ€å¤§å€¼å’Œæœ€å°å€¼"></a>æ±‚è¿ç»­è·¯æ®µé•¿åº¦çš„å¹³å‡å€¼ï¼Œæœ€å¤§å€¼å’Œæœ€å°å€¼</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(c), <span class="keyword">min</span>(c), <span class="keyword">max</span>(c)</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> c</span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">select</span> trail_id,</span><br><span class="line">        leg - row_number() <span class="keyword">over</span> (</span><br><span class="line">            <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">            <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">as</span> <span class="keyword">section</span></span><br><span class="line">        <span class="keyword">from</span> completed</span><br><span class="line">    ) <span class="keyword">as</span> temp_count</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> trail_id , <span class="keyword">section</span></span><br><span class="line">) <span class="keyword">as</span> temp_stat;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        avg         | min | max </span><br><span class="line"><span class="comment">--------------------+-----+-----</span></span><br><span class="line"> 2.2000000000000000 |   2 |   3</span><br><span class="line">(1 row)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="å¯¹æœªå®Œæˆçš„è·¯æ®µè¿›è¡Œåˆ†æ"><a href="#å¯¹æœªå®Œæˆçš„è·¯æ®µè¿›è¡Œåˆ†æ" class="headerlink" title="å¯¹æœªå®Œæˆçš„è·¯æ®µè¿›è¡Œåˆ†æ"></a>å¯¹æœªå®Œæˆçš„è·¯æ®µè¿›è¡Œåˆ†æ</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">id</span>,</span><br><span class="line">    <span class="keyword">min</span>(leg) <span class="keyword">as</span> firstLeg,</span><br><span class="line">    <span class="keyword">max</span>(leg) <span class="keyword">as</span> LastLeg,</span><br><span class="line">    <span class="keyword">max</span>(leg) - <span class="keyword">min</span>(leg) + <span class="number">1</span> <span class="keyword">as</span> <span class="keyword">length</span>,</span><br><span class="line">    <span class="keyword">section</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span>,</span><br><span class="line">           leg,</span><br><span class="line">           leg - row_number() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">section</span></span><br><span class="line">    <span class="keyword">from</span> trails</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> completed c</span><br><span class="line">        <span class="keyword">where</span> trail_id = trails.id</span><br><span class="line">        <span class="keyword">and</span> trails.leg = c.leg</span><br><span class="line">    )</span><br><span class="line">) <span class="keyword">as</span> temp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>, <span class="keyword">section</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">length</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> id | firstleg | lastleg | length | section </span><br><span class="line"><span class="comment">----+----------+---------+--------+---------</span></span><br><span class="line">  2 |       13 |      15 |      3 |       4</span><br><span class="line">  1 |        4 |       7 |      4 |       3</span><br><span class="line">  1 |       24 |      28 |      5 |       7</span><br><span class="line">  2 |        3 |      10 |      8 |       2</span><br><span class="line">  1 |       10 |      21 |     12 |       5</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure><p>æ€è·¯:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,</span><br><span class="line">       leg,</span><br><span class="line">       row_number() <span class="keyword">over</span> w,</span><br><span class="line">       leg - row_number() <span class="keyword">over</span> w <span class="keyword">section</span></span><br><span class="line"><span class="keyword">from</span> trails</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> completed c</span><br><span class="line">    <span class="keyword">where</span> trail_id = trails.id</span><br><span class="line">    <span class="keyword">and</span> trails.leg = c.leg</span><br><span class="line">)</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">id</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> leg</span><br><span class="line">)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>, leg;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> id | leg | row_number | section </span><br><span class="line"><span class="comment">----+-----+------------+---------</span></span><br><span class="line">  1 |   4 |          1 |       3</span><br><span class="line">  1 |   5 |          2 |       3</span><br><span class="line">  1 |   6 |          3 |       3</span><br><span class="line">  1 |   7 |          4 |       3</span><br><span class="line">  1 |  10 |          5 |       5</span><br><span class="line">  1 |  11 |          6 |       5</span><br><span class="line">  1 |  12 |          7 |       5</span><br><span class="line">  1 |  13 |          8 |       5</span><br><span class="line">  1 |  14 |          9 |       5</span><br><span class="line">  1 |  15 |         10 |       5</span><br><span class="line">  1 |  16 |         11 |       5</span><br><span class="line">  1 |  17 |         12 |       5</span><br><span class="line">  1 |  18 |         13 |       5</span><br><span class="line">  1 |  19 |         14 |       5</span><br><span class="line">  1 |  20 |         15 |       5</span><br><span class="line">  1 |  21 |         16 |       5</span><br><span class="line">  1 |  24 |         17 |       7</span><br><span class="line">  1 |  25 |         18 |       7</span><br><span class="line">  1 |  26 |         19 |       7</span><br><span class="line">  1 |  27 |         20 |       7</span><br><span class="line">  1 |  28 |         21 |       7</span><br><span class="line">  2 |   3 |          1 |       2</span><br><span class="line">  2 |   4 |          2 |       2</span><br><span class="line">  2 |   5 |          3 |       2</span><br><span class="line">  2 |   6 |          4 |       2</span><br><span class="line">  2 |   7 |          5 |       2</span><br><span class="line">  2 |   8 |          6 |       2</span><br><span class="line">  2 |   9 |          7 |       2</span><br><span class="line">  2 |  10 |          8 |       2</span><br><span class="line">  2 |  13 |          9 |       4</span><br><span class="line">  2 |  14 |         10 |       4</span><br><span class="line">  2 |  15 |         11 |       4</span><br><span class="line">(32 rows)</span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨äº†è§£äº†çª—å£å‡½æ•°åï¼Œ æˆ‘ä»¬è¿™æ¬¡å¯¹å®ƒè¿›è¡Œæœ€å(?)ä¸€æ¬¡ç»ƒä¹ ã€‚æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªç§‹æœ‰é—®é¢˜ï¼Œå³ä¸€äº›è¿ç»­çš„æ•°å­—æ˜¯å¦è¢«ä½¿ç”¨å®Œã€‚è¿™æ¬¡çš„æ•°æ®é›†ç›´æ¥å­˜åœ¨äºSQLè¯­å¥é‡Œé¢ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(6)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/08/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-6/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/08/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-6/</id>
    <published>2020-04-08T17:34:47.000Z</published>
    <updated>2020-04-08T17:44:29.206Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬ç»§ç»­ç»ƒä¹ çª—å£å‡½æ•°ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨TPC-Hæ•°æ®é›†æ¥ç»ƒä¹ ã€‚TPC-Hæ˜¯ä¸€ä¸ªå•†ä¸šå†³ç­–æ–¹å‘çš„æ•°æ®é›†ï¼Œå› æ­¤é‡Œé¢æœ‰å¾ˆå¤šé‡‘é¢/é”€å”®é¢/å¹´åº¦é”€å”®é¢/å›½å®¶é”€å”®é¢ç­‰ç­‰OLAPçš„æ•°ç›®å¯ä»¥è¢«è®¡ç®—ã€‚</p><a id="more"></a><h1 id="TPC-H-æ•°æ®é›†"><a href="#TPC-H-æ•°æ®é›†" class="headerlink" title="TPC-H æ•°æ®é›†"></a>TPC-H æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br><code>TPC-H</code>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p><p><strong>æœ¬åœ°è½½å…¥æ”¹æ•°æ®é›†</strong>çš„æ–¹æ³•è§æˆ‘çš„åšå®¢ä¸¤ç¯‡æ–‡ç« :</p><ul><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥ TPC-H æ•°æ®é›†</a></li><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†</a></li></ul><p><br><br><br></p><h2 id="sets-rollup-cube"><a href="#sets-rollup-cube" class="headerlink" title="sets, rollup, cube"></a>sets, rollup, cube</h2><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/36.jpg" alt="36.jpg"></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">group by grouping sets ((a, b), (a), ())</span><br><span class="line">``` </span><br><span class="line">= </span><br><span class="line">```SQL</span><br><span class="line">group by rollup (a, b)</span><br></pre></td></tr></tbody></table></figure><p>=<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a, b, <span class="keyword">sum</span>(x) <span class="keyword">from</span> r <span class="keyword">group</span> <span class="keyword">by</span> a, b</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> a, <span class="literal">null</span>, <span class="keyword">sum</span>(x) <span class="keyword">from</span> r <span class="keyword">group</span> <span class="keyword">by</span> a</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="literal">null</span>, <span class="literal">null</span>, <span class="keyword">sum</span>(x) <span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure><p></p><p><br><br><br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">group by cube (a, b)</span><br><span class="line">``` </span><br><span class="line">= </span><br><span class="line">```SQL</span><br><span class="line">group by grouping sets ((a, b), (a), (b), ())</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><ul><li>å…¶ä¸­<code>()</code>æŒ‡çš„æ˜¯ç©ºé›†</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                        (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                        (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                        (<span class="literal">NULL</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(y)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> x;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> x | sum </span><br><span class="line"><span class="comment">---+-----</span></span><br><span class="line">   |   4</span><br><span class="line"> 1 |   5</span><br><span class="line">(2 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                        (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                        (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                        (<span class="literal">NULL</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(y), <span class="keyword">grouping</span>(x)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">rollup</span>(x);</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> x | sum | grouping </span><br><span class="line"><span class="comment">---+-----+----------</span></span><br><span class="line">   |   9 |        1</span><br><span class="line">   |   4 |        0</span><br><span class="line"> 1 |   5 |        0</span><br><span class="line">(3 rows)</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><h3 id="è®¡ç®—å„ä¸ªnation-region-all-å…¨çƒ-çš„revenue"><a href="#è®¡ç®—å„ä¸ªnation-region-all-å…¨çƒ-çš„revenue" class="headerlink" title="è®¡ç®—å„ä¸ªnation, region, all(å…¨çƒ)çš„revenue:"></a>è®¡ç®—å„ä¸ªnation, region, all(å…¨çƒ)çš„revenue:</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/37.jpg" alt="37.jpg"></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> revenue, r_name, n_name</span><br><span class="line"><span class="keyword">from</span> orders, customer, nation, region</span><br><span class="line"><span class="keyword">where</span> o_custkey = c_custkey <span class="keyword">and</span> c_nationkey = n_nationkey <span class="keyword">and</span> n_regionkey = r_regionkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">rollup</span>(r_name, n_name)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> r_name, n_name;</span><br></pre></td></tr></tbody></table></figure><h4 id="grouping"><a href="#grouping" class="headerlink" title="grouping"></a>grouping</h4><p>ä¸‹é¢è¿™ä¸ªç‰ˆæœ¬åœ¨ä¸Šé¢SQLåŸºç¡€ä¸ŠåŠ ä¸Šäº†<code>grouping</code>, å®ƒä»£è¡¨<strong>è¢«èšåˆæˆç»„çš„ä¸ªæ•°</strong>ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> revenue, r_name, n_name, <span class="keyword">grouping</span>(r_name, n_name)</span><br><span class="line"><span class="keyword">from</span> orders, customer, nation, region</span><br><span class="line"><span class="keyword">where</span> o_custkey = c_custkey <span class="keyword">and</span> c_nationkey = n_nationkey <span class="keyword">and</span> n_regionkey = r_regionkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">rollup</span>(r_name, n_name)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> r_name, n_name;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">     revenue     |          r_name           |          n_name           | grouping </span><br><span class="line"><span class="comment">-----------------+---------------------------+---------------------------+----------</span></span><br><span class="line">   9065723966.78 | AFRICA                    | ALGERIA                   |        0</span><br><span class="line">   9032642974.38 | AFRICA                    | ETHIOPIA                  |        0</span><br><span class="line">   8897163266.18 | AFRICA                    | KENYA                     |        0</span><br><span class="line">   8985579085.22 | AFRICA                    | MOROCCO                   |        0</span><br><span class="line">   9249114609.66 | AFRICA                    | MOZAMBIQUE                |        0</span><br><span class="line">  45230223902.22 | AFRICA                    |                           |        1</span><br><span class="line">   9022490350.05 | AMERICA                   | ARGENTINA                 |        0</span><br><span class="line">   9107367126.70 | AMERICA                   | BRAZIL                    |        0</span><br><span class="line">   9143635385.19 | AMERICA                   | CANADA                    |        0</span><br><span class="line">   8946481134.38 | AMERICA                   | PERU                      |        0</span><br><span class="line">   9086969258.89 | AMERICA                   | UNITED STATES             |        0</span><br><span class="line">  45306943255.21 | AMERICA                   |                           |        1</span><br><span class="line">   9161685172.34 | ASIA                      | CHINA                     |        0</span><br><span class="line">   9035791922.09 | ASIA                      | INDIA                     |        0</span><br><span class="line">   9300830039.29 | ASIA                      | INDONESIA                 |        0</span><br><span class="line">   8993418470.64 | ASIA                      | JAPAN                     |        0</span><br><span class="line">   9121689438.20 | ASIA                      | VIETNAM                   |        0</span><br><span class="line">  45613415042.56 | ASIA                      |                           |        1</span><br><span class="line">   9318715232.78 | EUROPE                    | FRANCE                    |        0</span><br><span class="line">   9039194008.74 | EUROPE                    | GERMANY                   |        0</span><br><span class="line">   9196280024.51 | EUROPE                    | ROMANIA                   |        0</span><br><span class="line">   9282323186.28 | EUROPE                    | RUSSIA                    |        0</span><br><span class="line">   8956753007.40 | EUROPE                    | UNITED KINGDOM            |        0</span><br><span class="line">  45793265459.71 | EUROPE                    |                           |        1</span><br><span class="line">   8925726169.17 | MIDDLE EAST               | EGYPT                     |        0</span><br><span class="line">   9025552858.09 | MIDDLE EAST               | IRAN                      |        0</span><br><span class="line">   8892603095.99 | MIDDLE EAST               | IRAQ                      |        0</span><br><span class="line">   9229296044.98 | MIDDLE EAST               | JORDAN                    |        0</span><br><span class="line">   8812280619.53 | MIDDLE EAST               | SAUDI ARABIA              |        0</span><br><span class="line">  44885458787.76 | MIDDLE EAST               |                           |        1</span><br><span class="line"> 226829306447.46 |                           |                           |        3</span><br><span class="line">(31 rows)</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><h2 id="cube"><a href="#cube" class="headerlink" title="cube"></a><code>cube</code></h2><h2 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h2><ul><li>æ±‚å‡ºæ‰€æœ‰è¦æ±‚çš„lineitemçš„trade volume(å³l_quantity * l_extendedprice)çš„æ€»å’Œ<ul><li>è¿™äº›lineitemè¢«è¦æ±‚ï¼šå¯¹åº”<code>nation.n_name</code>æ˜¯<code>UNITED STATES</code>, å¯¹åº”çš„<code>c_mktsegment</code>æ˜¯<code>AUTOMOBILE</code></li></ul></li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span> (l_quantity * l_extendedprice)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    lineitem,</span><br><span class="line">    orders,</span><br><span class="line">    customer,</span><br><span class="line">    nation</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_orderkey = o_orderkey <span class="keyword">and</span></span><br><span class="line">    o_custkey = c_custkey <span class="keyword">and</span></span><br><span class="line">    c_nationkey = n_nationkey <span class="keyword">and</span></span><br><span class="line">    c_mktsegment = <span class="string">'AUTOMOBILE'</span> <span class="keyword">and</span></span><br><span class="line">    n_name = <span class="string">'UNITED STATES'</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>æ±‚æ‰€æœ‰è¦æ±‚çš„lineitemçš„trade volumeçš„æ€»å’Œ<ul><li>è¿™äº›lineitemè¢«è¦æ±‚æ˜¯æ¥è‡ªè¢«åŒä¸€ä¸ªnationçš„supplierå’Œcustomer</li></ul></li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">sum</span>(l_quantity * l_extendedprice)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    lineitem,</span><br><span class="line">    orders,</span><br><span class="line">    customer,</span><br><span class="line">    supplier</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_orderkey = o_orderkey <span class="keyword">and</span></span><br><span class="line">    o_custkey = c_custkey <span class="keyword">and</span></span><br><span class="line">    l_suppkey = s_suppkey <span class="keyword">and</span></span><br><span class="line">    s_nationkey = c_nationkey;</span><br></pre></td></tr></tbody></table></figure><p>ä¸ºäº†å¯¹ç±»ä¼¼è¿™äº›Queryè¿›è¡ŒåŠ é€Ÿï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>cube</code>å‡½æ•°æ¥ç‰©è´¨åŒ–(materialize)é¢„å…ˆè®¡ç®—(precompute)é›†åˆ(aggregates)ã€‚</p><p><br></p><h3 id="ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦c-mktsegment-c-nation-s-nationä¸Šçš„cube-åœ¨ç»„é‡Œé¢å¯¹l-quantity-l-extendedpriceæ±‚å’Œ"><a href="#ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦c-mktsegment-c-nation-s-nationä¸Šçš„cube-åœ¨ç»„é‡Œé¢å¯¹l-quantity-l-extendedpriceæ±‚å’Œ" class="headerlink" title="ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦c_mktsegment, c_nation, s_nationä¸Šçš„cube, åœ¨ç»„é‡Œé¢å¯¹l_quantity * l_extendedpriceæ±‚å’Œ"></a>ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦<code>c_mktsegment, c_nation, s_nation</code>ä¸Šçš„<code>cube</code>, åœ¨ç»„é‡Œé¢å¯¹<code>l_quantity * l_extendedprice</code>æ±‚å’Œ</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> volume_cube (</span><br><span class="line">    volume <span class="built_in">bigint</span>,</span><br><span class="line">    c_mktsegment <span class="built_in">character</span> (<span class="number">10</span>),</span><br><span class="line">    c_nationkey <span class="built_in">integer</span>,</span><br><span class="line">    s_nationkey <span class="built_in">integer</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> volume_cube2 (</span><br><span class="line">    volume <span class="built_in">bigint</span>,</span><br><span class="line">    c_mktsegment <span class="built_in">character</span> (<span class="number">10</span>),</span><br><span class="line">    c_nationkey <span class="built_in">integer</span>,</span><br><span class="line">    s_nationkey <span class="built_in">integer</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> volume_cube2 <span class="keyword">select</span></span><br><span class="line">    <span class="keyword">sum</span>(l_quantity * l_extendedprice),</span><br><span class="line">    c_mktsegment,</span><br><span class="line">    c_nationkey,</span><br><span class="line">    s_nationkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    lineitem,</span><br><span class="line">    orders,</span><br><span class="line">    customer,</span><br><span class="line">    supplier</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_orderkey = o_orderkey <span class="keyword">and</span></span><br><span class="line">    o_custkey = c_custkey <span class="keyword">and</span></span><br><span class="line">    l_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    <span class="keyword">cube</span> (</span><br><span class="line">    c_mktsegment,</span><br><span class="line">    c_nationkey,</span><br><span class="line">    s_nationkey</span><br><span class="line">    );</span><br></pre></td></tr></tbody></table></figure><h3 id="æ”¹å†™å¼•å…¥ä¸­çš„ä¸¤ä¸ªä¾‹å­"><a href="#æ”¹å†™å¼•å…¥ä¸­çš„ä¸¤ä¸ªä¾‹å­" class="headerlink" title="æ”¹å†™å¼•å…¥ä¸­çš„ä¸¤ä¸ªä¾‹å­"></a>æ”¹å†™å¼•å…¥ä¸­çš„ä¸¤ä¸ªä¾‹å­</h3><p>å¯ä»¥å¯¹è¿è¡Œæ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨<code>psql</code>å‘½ä»¤è¡Œä¸­è¾“å…¥<code>\timing</code>:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tpch1=# \timing</span><br><span class="line">Timing is on.</span><br></pre></td></tr></tbody></table></figure><p><br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> volume</span><br><span class="line"><span class="keyword">from</span> volume_cube2, nation</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    c_mktsegment = <span class="string">'AUTOMOBILE'</span> <span class="keyword">and</span></span><br><span class="line">    c_nationkey = n_nationkey <span class="keyword">and</span></span><br><span class="line">    n_name = <span class="string">'UNITED STATES'</span> <span class="keyword">and</span></span><br><span class="line">    s_nationkey <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   volume    </span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"> 59435954414</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 1.048 ms</span><br></pre></td></tr></tbody></table></figure><p>&lt;/br&gt;<br>&lt;/br&gt;</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(volume)</span><br><span class="line"><span class="keyword">from</span> volume_cube2</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    c_nationkey = s_nationkey <span class="keyword">and</span></span><br><span class="line">    c_mktsegment <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">     sum      </span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line"> 309577834070</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 1.505 ms</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><p>ä¸‹é¢æ˜¯å¼•å…¥ä¾‹å­æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå®ƒä»¬å¾ˆæ…¢ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">       sum        </span><br><span class="line"><span class="comment">------------------</span></span><br><span class="line"> 59435954414.0900</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 1301.876 ms (00:01.302)</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        sum        </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> 309577834069.9700</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 4526.136 ms (00:04.526)</span><br></pre></td></tr></tbody></table></figure><h3 id="è€ƒè™‘ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦p-partkey-s-partkey-o-orderkey-c-custkeyä¸Šçš„cubeæ˜¯å¦åˆç†"><a href="#è€ƒè™‘ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦p-partkey-s-partkey-o-orderkey-c-custkeyä¸Šçš„cubeæ˜¯å¦åˆç†" class="headerlink" title="è€ƒè™‘ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦p_partkey, s_partkey, o_orderkey, c_custkeyä¸Šçš„cubeæ˜¯å¦åˆç†"></a>è€ƒè™‘ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦<code>p_partkey, s_partkey, o_orderkey, c_custkey</code>ä¸Šçš„<code>cube</code>æ˜¯å¦åˆç†</h3><p>å³ä½¿æ˜¯å”¯ä¸€çš„å…ƒç´ (unique elements)çš„ä¸ªæ•°ï¼š200k <em> 800k </em> 1500k * 150k = 3.6e22</p><p>è¿™ä¸ªæ•°å­—æ˜¯cubeè‡³å°‘æ‹¥æœ‰çš„æ¡ç›®æ€»æ•°çš„ä¸‹é™</p><p>å‡è®¾æ¯ä¸ªå…ƒç´ éƒ½æ˜¯4Byteçš„Intï¼Œé¢„å…ˆè®¡ç®—éœ€è¦çš„ç©ºé—´æ˜¯ï¼š1.44e23 Byte = 192 Zebibyte </p><p>è¿™ä¸ªç©ºé—´å ç”¨è¿‡å¤§ï¼Œè¿™ä¸ªè€ƒè™‘æ˜¯éå¸¸ä¸åˆç†çš„</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æˆ‘ä»¬ç»§ç»­ç»ƒä¹ çª—å£å‡½æ•°ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨TPC-Hæ•°æ®é›†æ¥ç»ƒä¹ ã€‚TPC-Hæ˜¯ä¸€ä¸ªå•†ä¸šå†³ç­–æ–¹å‘çš„æ•°æ®é›†ï¼Œå› æ­¤é‡Œé¢æœ‰å¾ˆå¤šé‡‘é¢/é”€å”®é¢/å¹´åº¦é”€å”®é¢/å›½å®¶é”€å”®é¢ç­‰ç­‰OLAPçš„æ•°ç›®å¯ä»¥è¢«è®¡ç®—ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="TUM-IN2326" scheme="https://cakebytheoceanluo.github.io/categories/TUM-IN2326/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(5)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/06/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-5/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/06/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-5/</id>
    <published>2020-04-06T13:16:29.000Z</published>
    <updated>2020-04-06T13:46:10.936Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬ç»§ç»­ç»ƒä¹ çª—å£å‡½æ•°ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨TPC-Hæ•°æ®é›†æ¥ç»ƒä¹ ã€‚TPC-Hæ˜¯ä¸€ä¸ªå•†ä¸šå†³ç­–æ–¹å‘çš„æ•°æ®é›†ï¼Œå› æ­¤é‡Œé¢æœ‰å¾ˆå¤šé‡‘é¢/é”€å”®é¢/å¹´åº¦é”€å”®é¢/å›½å®¶é”€å”®é¢ç­‰ç­‰OLAPçš„æ•°ç›®å¯ä»¥è¢«è®¡ç®—ã€‚</p><a id="more"></a><h1 id="TPC-H-æ•°æ®é›†"><a href="#TPC-H-æ•°æ®é›†" class="headerlink" title="TPC-H æ•°æ®é›†"></a>TPC-H æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br><code>TPC-H</code>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p><p><strong>æœ¬åœ°è½½å…¥æ”¹æ•°æ®é›†</strong>çš„æ–¹æ³•è§æˆ‘çš„åšå®¢ä¸¤ç¯‡æ–‡ç« :</p><ul><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥ TPC-H æ•°æ®é›†</a></li><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†</a></li></ul><h2 id="ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o-totalprice"><a href="#ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o-totalprice" class="headerlink" title="ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o_totalprice"></a>ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o_totalprice</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o_custkey, o_orderdate,</span><br><span class="line">       <span class="keyword">sum</span>(o_totalprice) <span class="keyword">over</span> <span class="comment">-- window function</span></span><br><span class="line">    (<span class="keyword">partition</span> <span class="keyword">by</span> o_custkey <span class="comment">-- partitioning clause</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> o_orderdate <span class="comment">-- ordering clause</span></span><br><span class="line">    <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">    ) <span class="comment">-- framing clause</span></span><br><span class="line">    <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders;</span><br></pre></td></tr></tbody></table></figure><p>è¯¾ä»¶ä¸Šé¢çš„ç‰ˆæœ¬å…¶å®ä¸èƒ½å……åˆ†æ˜¾ç¤ºå‡ºwindow functionçš„ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ç‰ˆæœ¬ï¼ŒåŒæ—¶çœ‹ä¸€ä¸‹å¯¹åº”çš„è¾“å‡ºï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o_custkey, o_orderdate, o_totalprice,</span><br><span class="line">       <span class="keyword">sum</span>(o_totalprice) <span class="keyword">over</span> <span class="comment">-- window function</span></span><br><span class="line">    (<span class="keyword">partition</span> <span class="keyword">by</span> o_custkey <span class="comment">-- partitioning clause</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> o_orderdate <span class="comment">-- ordering clause</span></span><br><span class="line">    <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">    ) <span class="comment">-- framing clause</span></span><br><span class="line">    <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_custkey, o_orderdate;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> o_custkey | o_orderdate | o_totalprice | o_totalprice_sum </span><br><span class="line"><span class="comment">-----------+-------------+--------------+------------------</span></span><br><span class="line">         1 | 1992-10-21  |    202660.52 |        202660.52</span><br><span class="line">         1 | 1993-08-05  |      4225.26 |        206885.78</span><br><span class="line">         1 | 1997-05-09  |    113954.89 |        320840.67</span><br><span class="line">         1 | 1997-11-21  |     39835.54 |        360676.21</span><br><span class="line">         1 | 1998-05-31  |    159171.69 |        519847.90</span><br><span class="line">         2 | 1992-07-08  |     44777.63 |         44777.63</span><br><span class="line">         2 | 1992-08-28  |     89399.40 |        134177.03</span><br><span class="line">         2 | 1993-03-09  |    169847.63 |        304024.66</span><br><span class="line">         2 | 1993-07-31  |     29305.47 |        333330.13</span><br><span class="line">         2 | 1993-12-31  |    179984.42 |        513314.55</span><br><span class="line">         2 | 1994-04-20  |     41433.48 |        554748.03</span><br><span class="line">         2 | 1996-08-16  |     63873.14 |        618621.17</span><br><span class="line">         2 | 1997-06-09  |     24362.39 |        642983.56</span><br><span class="line">         2 | 1998-05-28  |    140363.70 |        783347.26</span><br><span class="line">         .................................................</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å¯ä»¥å…³æ³¨<code>o_totalprice_sum</code>è¿™ä¸ªå­—æ®µï¼Œå®ƒå¯¹æ¯ä¸€ä¸ªç‹¬ç«‹çš„<code>o_custkey</code>çš„ä¸åŒ<code>o_orderdate</code>çš„<code>o_totalprice</code>è¿›è¡Œç´¯åŠ ã€‚</p><ul><li><code>o_custkey</code>: partition</li><li><code>o_orderdate</code>: order by è¿›è¡Œæ’åº</li><li><code>range between unbounded preceding and current row</code>ï¼š ä»è¿™ä¸ª<code>o_custkey</code>ç¬¬ä¸€ä¸ª<code>o_orderdate</code>åˆ°å½“å‰<code>o_orderdate</code></li></ul><p><br></p><p>é’ˆå¯¹è¿™ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ¥ç”¨<strong>ä¸å¸¦window functionçš„ç‰ˆæœ¬</strong>å»å®ŒæˆåŒæ ·è¿™ä¸ªä»»åŠ¡ï¼Œ<strong>ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o_totalprice</strong>:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o1.o_custkey, o1.o_orderdate, o1.o_totalprice, <span class="keyword">sum</span>(o2.o_totalprice) <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders o1, orders o2</span><br><span class="line"><span class="keyword">where</span> o1.o_custkey = o2.o_custkey <span class="keyword">and</span> o1.o_orderdate &gt;= o2.o_orderdate</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o1.o_custkey, o1.o_orderdate, o1.o_totalprice</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o1.o_custkey, o1.o_orderdate;</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œè¿˜éœ€è¦æä¸€ä¸‹ï¼Œä¸Šé¢è¿™ä¸ªä¸å¸¦window functionçš„ç‰ˆæœ¬è¿è¡Œå¾ˆæ…¢ï¼Œè€Œå¸¦window functionä¼šå¿«å¾ˆå¤šã€‚(æˆ‘åœ¨PostgreSQLå’ŒHyPerå‡æ¯”è¾ƒè¿‡ã€‚)</p><p><br></p><h2 id="ç´¯è®¡æ¯ä¸€ä¸ªo-orderdate-customerçš„o-totalpriceï¼ŒæŒ‰ç…§o-custkeyæ¥é¡ºåºç´¯åŠ "><a href="#ç´¯è®¡æ¯ä¸€ä¸ªo-orderdate-customerçš„o-totalpriceï¼ŒæŒ‰ç…§o-custkeyæ¥é¡ºåºç´¯åŠ " class="headerlink" title="ç´¯è®¡æ¯ä¸€ä¸ªo_orderdate customerçš„o_totalpriceï¼ŒæŒ‰ç…§o_custkeyæ¥é¡ºåºç´¯åŠ "></a>ç´¯è®¡æ¯ä¸€ä¸ªo_orderdate customerçš„o_totalpriceï¼ŒæŒ‰ç…§o_custkeyæ¥é¡ºåºç´¯åŠ </h2><p>ç´¯è®¡æ¯ä¸€ä¸ªo_orderdate(æ¯ä¸€å¤©)customerçš„o_totalpriceï¼ŒæŒ‰ç…§o_custkeyæ¥é¡ºåºç´¯åŠ </p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o_orderdate, o_custkey, o_totalprice, <span class="keyword">sum</span>(o_totalprice) <span class="keyword">over</span></span><br><span class="line">    (<span class="keyword">partition</span> <span class="keyword">by</span> o_orderdate</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> o_custkey</span><br><span class="line">    <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">    ) <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderdate, o_custkey;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> o_orderdate | o_custkey | o_totalprice | o_totalprice_sum </span><br><span class="line"><span class="comment">-------------+-----------+--------------+------------------</span></span><br><span class="line"> 1992-01-01  |        34 |     86534.05 |         86534.05</span><br><span class="line"> 1992-01-01  |        92 |     24660.06 |        111194.11</span><br><span class="line"> 1992-01-02  |        17 |     40975.96 |         40975.96</span><br><span class="line"> 1992-01-02  |        49 |    210713.88 |        251689.84</span><br><span class="line"> 1992-01-02  |        64 |    127527.05 |        379216.89</span><br><span class="line"> 1992-01-04  |        70 |     84053.93 |         84053.93</span><br><span class="line"> 1992-01-06  |        11 |    118570.79 |        118570.79</span><br><span class="line"> 1992-01-06  |        37 |     91795.13 |        210365.92</span><br><span class="line"> 1992-01-07  |        62 |     58168.07 |         58168.07</span><br><span class="line"> 1992-01-09  |        13 |    145040.38 |        145040.38</span><br><span class="line"> 1992-01-09  |        25 |    145906.24 |        290946.62</span><br><span class="line"> .........................................................</span><br></pre></td></tr></tbody></table></figure><p>ä¸å¸¦window functionçš„ç‰ˆæœ¬ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o1.o_orderdate, o1.o_custkey, o1.o_totalprice, <span class="keyword">sum</span>(o2.o_totalprice) <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders o1, orders o2</span><br><span class="line"><span class="keyword">where</span> o1.o_orderdate = o2.o_orderdate <span class="keyword">and</span> o1.o_custkey &gt;= o2.o_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o1.o_orderdate, o1.o_custkey, o1.o_totalprice</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderdate, o_custkey;</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="è®¡ç®—æ¯ä¸€ä¸ªGERMANYçš„customeræ¯ä¸€å¹´çš„running-sum-o-totalprice"><a href="#è®¡ç®—æ¯ä¸€ä¸ªGERMANYçš„customeræ¯ä¸€å¹´çš„running-sum-o-totalprice" class="headerlink" title="è®¡ç®—æ¯ä¸€ä¸ªGERMANYçš„customeræ¯ä¸€å¹´çš„running sum(o_totalprice)"></a>è®¡ç®—æ¯ä¸€ä¸ªGERMANYçš„customeræ¯ä¸€å¹´çš„running sum(o_totalprice)</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> base_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> c_custkey, <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> o_orderdate) <span class="keyword">as</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> yr_revernue</span><br><span class="line">    <span class="keyword">from</span> nation, customer, orders</span><br><span class="line">    <span class="keyword">where</span> n_name = <span class="string">'GERMANY'</span> <span class="keyword">and</span> n_nationkey = c_nationkey <span class="keyword">and</span> c_custkey = o_custkey</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_custkey, <span class="keyword">year</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> c_custkey, <span class="keyword">year</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *,</span><br><span class="line">       <span class="keyword">sum</span>(yr_revernue) <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> c_custkey</span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span></span><br><span class="line">           <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">0</span> <span class="keyword">following</span></span><br><span class="line">           ) <span class="keyword">as</span> running_sum</span><br><span class="line"><span class="keyword">from</span> base_table;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">c_custkey | year | yr_revernue | running_sum </span><br><span class="line"><span class="comment">-----------+------+-------------+-------------</span></span><br><span class="line">        62 | 1992 |   169991.32 |   169991.32</span><br><span class="line">        62 | 1993 |   174385.47 |   344376.79</span><br><span class="line">        62 | 1994 |    89262.19 |   433638.98</span><br><span class="line">        62 | 1995 |   526408.33 |   960047.31</span><br><span class="line">        62 | 1996 |   412013.97 |  1372061.28</span><br><span class="line">        62 | 1997 |   286185.97 |  1658247.25</span><br><span class="line">        62 | 1998 |   397422.69 |  2055669.94</span><br><span class="line">        71 | 1992 |   403017.41 |   403017.41</span><br><span class="line">        71 | 1993 |   348239.45 |   751256.86</span><br><span class="line">        71 | 1994 |   270189.86 |  1021446.72</span><br><span class="line">        71 | 1995 |   239565.38 |  1261012.10</span><br><span class="line">        71 | 1997 |   203579.58 |  1464591.68</span><br><span class="line">        71 | 1998 |   174001.98 |  1638593.66</span><br><span class="line">        .....................................</span><br></pre></td></tr></tbody></table></figure><p>&lt;/br&gt;</p><h3 id="å¯¹ä¸åŒå›½å®¶çš„orderæ•°é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå‰å‡ å"><a href="#å¯¹ä¸åŒå›½å®¶çš„orderæ•°é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå‰å‡ å" class="headerlink" title="å¯¹ä¸åŒå›½å®¶çš„orderæ•°é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå‰å‡ å"></a>å¯¹ä¸åŒå›½å®¶çš„orderæ•°é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå‰å‡ å</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/28.jpg" alt="28.jpg"></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *, </span><br><span class="line">        <span class="keyword">case</span> (<span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>)) </span><br><span class="line">              <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">              <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">              <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c</span><br><span class="line">    <span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line">    <span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_custkey) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c,</span><br><span class="line">       <span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">rank</span>,</span><br><span class="line">       <span class="keyword">case</span> (<span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>))  </span><br><span class="line">             <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">else</span> <span class="string">' '</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line"><span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_custkey</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> c_custkey | c  | case </span><br><span class="line"><span class="comment">-----------+----+------</span></span><br><span class="line">      3451 | 41 | gold</span><br><span class="line">    102022 | 41 | gold</span><br><span class="line">    102004 | 41 | gold</span><br><span class="line">    122623 | 40 | </span><br><span class="line">     79300 | 40 | </span><br><span class="line">    117082 | 40 | </span><br><span class="line">     69682 | 39 | </span><br><span class="line">    143500 | 39 | </span><br><span class="line">    129637 | 38 | </span><br><span class="line">    124048 | 38 |</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *, </span><br><span class="line">       <span class="keyword">case</span> (<span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>)) </span><br><span class="line">             <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c</span><br><span class="line">    <span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line">    <span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_custkey) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c,</span><br><span class="line">       <span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">rank</span>,</span><br><span class="line">       <span class="keyword">case</span> (<span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>))  </span><br><span class="line">             <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">else</span> <span class="string">' '</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line"><span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_custkey</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> c_custkey | c  |  case  </span><br><span class="line"><span class="comment">-----------+----+--------</span></span><br><span class="line">      3451 | 41 | gold</span><br><span class="line">    102022 | 41 | gold</span><br><span class="line">    102004 | 41 | gold</span><br><span class="line">    122623 | 40 | silver</span><br><span class="line">     79300 | 40 | silver</span><br><span class="line">    117082 | 40 | silver</span><br><span class="line">     69682 | 39 | bronze</span><br><span class="line">    143500 | 39 | bronze</span><br><span class="line">    129637 | 38 | </span><br><span class="line">    124048 | 38 |</span><br></pre></td></tr></tbody></table></figure><p>ç»™å‡ºäº†ä¸¤ç§ä¸åŒæ–¹æ³•ï¼Œå–å†³äºæˆ‘ä»¬æ€ä¹ˆå®šä¹‰å¥–ç‰Œ(æ€ä¹ˆå®šä¹‰æ’å)ã€‚</p><p><br><br><br>s</p><h3 id="æ±‚æ¯ä¸€å¹´çš„revenueçš„ç™¾åˆ†æ¯”æ¯”å‰ä¸€å¹´çš„å˜åŒ–ï¼š"><a href="#æ±‚æ¯ä¸€å¹´çš„revenueçš„ç™¾åˆ†æ¯”æ¯”å‰ä¸€å¹´çš„å˜åŒ–ï¼š" class="headerlink" title="æ±‚æ¯ä¸€å¹´çš„revenueçš„ç™¾åˆ†æ¯”æ¯”å‰ä¸€å¹´çš„å˜åŒ–ï¼š"></a>æ±‚æ¯ä¸€å¹´çš„revenueçš„ç™¾åˆ†æ¯”æ¯”å‰ä¸€å¹´çš„å˜åŒ–ï¼š</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/29.jpg" alt="29.jpg"></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> orders_with_years <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> * , <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> o_orderdate) <span class="keyword">as</span> <span class="keyword">year</span></span><br><span class="line">    <span class="keyword">from</span> orders</span><br><span class="line">    ), tmp_re <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> revenue</span><br><span class="line">    <span class="keyword">from</span> orders_with_years</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">year</span></span><br><span class="line">    ), tmp_re_comp <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *, lag(revenue, <span class="number">1</span>, <span class="literal">null</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span>) <span class="keyword">as</span> prev</span><br><span class="line">    <span class="keyword">from</span> tmp_re</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *, <span class="keyword">round</span>(<span class="number">100</span> * ((revenue - prev) / prev), <span class="number">2</span>) <span class="keyword">as</span> differ_percentage</span><br><span class="line"><span class="keyword">from</span> tmp_re_comp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> year |    revenue     |      prev      | differ_percentage </span><br><span class="line"><span class="comment">------+----------------+----------------+-------------------</span></span><br><span class="line"> 1992 | 34330674052.43 |                |                  </span><br><span class="line"> 1993 | 34340410079.03 | 34330674052.43 |              0.03</span><br><span class="line"> 1994 | 34416369052.97 | 34340410079.03 |              0.22</span><br><span class="line"> 1995 | 34546133183.60 | 34416369052.97 |              0.38</span><br><span class="line"> 1996 | 34609364760.86 | 34546133183.60 |              0.18</span><br><span class="line"> 1997 | 34373633413.04 | 34609364760.86 |             -0.68</span><br><span class="line"> 1998 | 20212721905.53 | 34373633413.04 |            -41.20</span><br></pre></td></tr></tbody></table></figure><hr><p>å¼•ç”¨: </p><p>è¯¾ä»¶: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æˆ‘ä»¬ç»§ç»­ç»ƒä¹ çª—å£å‡½æ•°ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨TPC-Hæ•°æ®é›†æ¥ç»ƒä¹ ã€‚TPC-Hæ˜¯ä¸€ä¸ªå•†ä¸šå†³ç­–æ–¹å‘çš„æ•°æ®é›†ï¼Œå› æ­¤é‡Œé¢æœ‰å¾ˆå¤šé‡‘é¢/é”€å”®é¢/å¹´åº¦é”€å”®é¢/å›½å®¶é”€å”®é¢ç­‰ç­‰OLAPçš„æ•°ç›®å¯ä»¥è¢«è®¡ç®—ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="TUM-IN2326" scheme="https://cakebytheoceanluo.github.io/categories/TUM-IN2326/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(4)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/05/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-4/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/05/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-4/</id>
    <published>2020-04-05T18:08:57.000Z</published>
    <updated>2020-04-05T18:09:42.250Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å‰ä¸‰ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åŸºæœ¬ä¸Šè®¤è¯†äº†window functionã€‚è¿™æ¬¡æˆ‘ä»¬æœ‰å…·ä½“çš„æ•°æ®é›†å»è¿›è¡Œå¤§é‡ç»ƒä¹ (ç»å¤§éƒ¨åˆ†æ˜¯æ’å)ã€‚</p><a id="more"></a><h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p><p>æ¶æ„ Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p><p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p><p>ä¸‹è½½:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p><p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p><p>è¯¾ä»¶ï¼š</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li></ul><p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p><p><br><br><br></p><h1 id="çª—å£å‡½æ•°"><a href="#çª—å£å‡½æ•°" class="headerlink" title="çª—å£å‡½æ•°"></a>çª—å£å‡½æ•°</h1><h2 id="æ•™æˆä¾‹å­"><a href="#æ•™æˆä¾‹å­" class="headerlink" title="æ•™æˆä¾‹å­"></a>æ•™æˆä¾‹å­</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> Professors;</span><br><span class="line"></span><br><span class="line"> persnr |    name     | paygrade | room | salary | taxclass </span><br><span class="line"><span class="comment">--------+-------------+----------+------+--------+----------</span></span><br><span class="line">   2125 | Sokrates    | C4       |  226 |  85000 |        1</span><br><span class="line">   2126 | Russel      | C4       |  232 |  80000 |        3</span><br><span class="line">   2127 | Kopernikus  | C3       |  310 |  65000 |        5</span><br><span class="line">   2128 | Aristoteles | C4       |  250 |  85000 |        1</span><br><span class="line">   2133 | Popper      | C3       |   52 |  68000 |        1</span><br><span class="line">   2134 | Augustinus  | C3       |  309 |  55000 |        5</span><br><span class="line">   2136 | Curie       | C4       |   36 |  95000 |        3</span><br><span class="line">   2137 | Kant        | C4       |    7 |  98000 |        1</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="æ ¹æ®salaryæ’å"><a href="#æ ¹æ®salaryæ’å" class="headerlink" title="æ ¹æ®salaryæ’å:"></a>æ ¹æ®salaryæ’å:</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary,</span><br><span class="line">       <span class="keyword">rank</span>() <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span></span><br><span class="line">       ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">rank</span> <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary | rank </span><br><span class="line"><span class="comment">--------+-------------+--------+------</span></span><br><span class="line">   2137 | Kant        |  98000 |    1</span><br><span class="line">   2136 | Curie       |  95000 |    2</span><br><span class="line">   2125 | Sokrates    |  85000 |    3</span><br><span class="line">   2128 | Aristoteles |  85000 |    3</span><br><span class="line">   2126 | Russel      |  80000 |    5</span><br><span class="line">   2133 | Popper      |  68000 |    6</span><br><span class="line">   2127 | Kopernikus  |  65000 |    7</span><br><span class="line">   2134 | Augustinus  |  55000 |    8</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œæ ¹æ®salaryæ’å"><a href="#åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œæ ¹æ®salaryæ’å" class="headerlink" title="åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œæ ¹æ®salaryæ’å:"></a>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œæ ¹æ®salaryæ’å:</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary, paygrade,</span><br><span class="line">       <span class="keyword">rank</span>() <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> paygrade</span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span></span><br><span class="line">       ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> paygrade <span class="keyword">asc</span>, <span class="keyword">rank</span> <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary | paygrade | rank </span><br><span class="line">--------+-------------+--------+----------+------</span><br><span class="line">   2133 | Popper      |  68000 | C3       |    1</span><br><span class="line">   2127 | Kopernikus  |  65000 | C3       |    2</span><br><span class="line">   2134 | Augustinus  |  55000 | C3       |    3</span><br><span class="line">   2137 | Kant        |  98000 | C4       |    1</span><br><span class="line">   2136 | Curie       |  95000 | C4       |    2</span><br><span class="line">   2128 | Aristoteles |  85000 | C4       |    3</span><br><span class="line">   2125 | Sokrates    |  85000 | C4       |    3</span><br><span class="line">   2126 | Russel      |  80000 | C4       |    5</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œè®¡ç®—salary-running-sum"><a href="#åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œè®¡ç®—salary-running-sum" class="headerlink" title="åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—salary running sum:"></a>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—salary running sum:</h3><p>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—æ¯ä¸€ä¸ªprofessorçš„salary running sum(å³salaryå°äºè¯¥professorçš„å…¶ä»–professorçš„salaryæ€»å’Œ)</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">sum</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">        )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure><p>æˆ–è€…åŠ ä¸Šä¸€è¡Œ<code>range</code>:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">sum</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">           <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="keyword">UNBOUNDED</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span> <span class="comment">-- è¿™è¡Œæ˜¯é»˜è®¤å€¼</span></span><br><span class="line">        )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | paygrade | salary |  sum   </span><br><span class="line"><span class="comment">--------+-------------+----------+--------+--------</span></span><br><span class="line">   2134 | Augustinus  | C3       |  55000 |  55000</span><br><span class="line">   2127 | Kopernikus  | C3       |  65000 | 120000</span><br><span class="line">   2133 | Popper      | C3       |  68000 | 188000</span><br><span class="line">   2126 | Russel      | C4       |  80000 |  80000</span><br><span class="line">   2125 | Sokrates    | C4       |  85000 | 250000</span><br><span class="line">   2128 | Aristoteles | C4       |  85000 | 250000</span><br><span class="line">   2136 | Curie       | C4       |  95000 | 345000</span><br><span class="line">   2137 | Kant        | C4       |  98000 | 443000</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œè®¡ç®—salary-running-average"><a href="#åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œè®¡ç®—salary-running-average" class="headerlink" title="åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—salary running average:"></a>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—salary running average:</h3><ul><li>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—æ¯ä¸€ä¸ªprofessorçš„salary running average(å³è€ƒè™‘ä¸¤ä¸ªä¸Šæ–¹çš„professorï¼Œå†è€ƒè™‘ä¸¤ä¸ªä¸‹æ–¹çš„professor)</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">avg</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">           <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="number">2</span> <span class="keyword">FOLLOWING</span></span><br><span class="line">           )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | paygrade | salary |        avg         </span><br><span class="line"><span class="comment">--------+-------------+----------+--------+--------------------</span></span><br><span class="line">   2134 | Augustinus  | C3       |  55000 | 62666.666666666667</span><br><span class="line">   2127 | Kopernikus  | C3       |  65000 | 62666.666666666667</span><br><span class="line">   2133 | Popper      | C3       |  68000 | 62666.666666666667</span><br><span class="line">   2126 | Russel      | C4       |  80000 | 83333.333333333333</span><br><span class="line">   2125 | Sokrates    | C4       |  85000 | 86250.000000000000</span><br><span class="line">   2128 | Aristoteles | C4       |  85000 | 88600.000000000000</span><br><span class="line">   2136 | Curie       | C4       |  95000 | 90750.000000000000</span><br><span class="line">   2137 | Kant        | C4       |  98000 | 92666.666666666667</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><ul><li>åœ¨pay gradeç»„ä¸­ï¼Œè®¡ç®—æ¯ä¸€ä¸ªprofessorçš„salary running average(å³è€ƒè™‘æ¯”è¯¥professorçš„salaryä½5000,é«˜5000åŒºé—´ä¸­professorçš„salaryçš„å¹³å‡å€¼)ï¼š</li></ul><p>PostgreSQLæ— æ³•æ‰§è¡Œè¿™ä¸€æ¡ï¼Œéœ€ä½¿ç”¨HyPerç½‘é¡µæ¥å£ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">avg</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">           <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="number">5000</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="number">5000</span> <span class="keyword">FOLLOWING</span></span><br><span class="line">           )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | paygrade | salary |        avg         </span><br><span class="line"><span class="comment">--------+-------------+----------+--------+--------------------</span></span><br><span class="line">   2134 | Augustinus  | C3       |  55000 | 55000.0000</span><br><span class="line">   2127 | Kopernikus  | C3       |  65000 | 66500.0000</span><br><span class="line">   2133 | Popper      | C3       |  68000 | 66500.0000</span><br><span class="line">   2126 | Russel      | C4       |  80000 | 83333.3333</span><br><span class="line">   2125 | Sokrates    | C4       |  85000 | 83333.3333</span><br><span class="line">   2128 | Aristoteles | C4       |  85000 | 83333.3333</span><br><span class="line">   2136 | Curie       | C4       |  95000 | 96500.0000</span><br><span class="line">   2137 | Kant        | C4       |  98000 | 96500.0000</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="æ ¹æ®salaryæ’åï¼Œç»™å‡ºå‰ä¸€åå’Œåä¸€åï¼š"><a href="#æ ¹æ®salaryæ’åï¼Œç»™å‡ºå‰ä¸€åå’Œåä¸€åï¼š" class="headerlink" title="æ ¹æ®salaryæ’åï¼Œç»™å‡ºå‰ä¸€åå’Œåä¸€åï¼š"></a>æ ¹æ®salaryæ’åï¼Œç»™å‡ºå‰ä¸€åå’Œåä¸€åï¼š</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary,</span><br><span class="line">       lag(<span class="keyword">name</span>) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">           ),</span><br><span class="line">       <span class="keyword">lead</span>(<span class="keyword">name</span>) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">           )</span><br><span class="line"><span class="keyword">FROM</span> Professors;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary |     lag     |    lead     </span><br><span class="line"><span class="comment">--------+-------------+--------+-------------+-------------</span></span><br><span class="line">   2137 | Kant        |  98000 |             | Curie</span><br><span class="line">   2136 | Curie       |  95000 | Kant        | Sokrates</span><br><span class="line">   2125 | Sokrates    |  85000 | Curie       | Aristoteles</span><br><span class="line">   2128 | Aristoteles |  85000 | Sokrates    | Russel</span><br><span class="line">   2126 | Russel      |  80000 | Aristoteles | Popper</span><br><span class="line">   2133 | Popper      |  68000 | Russel      | Kopernikus</span><br><span class="line">   2127 | Kopernikus  |  65000 | Popper      | Augustinus</span><br><span class="line">   2134 | Augustinus  |  55000 | Kopernikus  | </span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><ul><li>è®¡ç®—å‡ºsalaryçš„å‰ä¸‰åï¼š</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary, <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> *,</span><br><span class="line">           <span class="keyword">rank</span>() <span class="keyword">OVER</span> (</span><br><span class="line">               <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">desc</span></span><br><span class="line">               ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line">    <span class="keyword">FROM</span> Professors</span><br><span class="line">) <span class="keyword">as</span> temp</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">rank</span> &lt; <span class="number">4</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">), temp <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> *,</span><br><span class="line">           <span class="keyword">rank</span>() <span class="keyword">OVER</span> (</span><br><span class="line">               <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">desc</span></span><br><span class="line">               ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line">    <span class="keyword">FROM</span> Professors</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary, <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> temp</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">rank</span> &lt; <span class="number">4</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary | rank </span><br><span class="line"><span class="comment">--------+-------------+--------+------</span></span><br><span class="line">   2137 | Kant        |  98000 |    1</span><br><span class="line">   2136 | Curie       |  95000 |    2</span><br><span class="line">   2125 | Sokrates    |  85000 |    3</span><br><span class="line">   2128 | Aristoteles |  85000 |    3</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure><p>ä¸ä½¿ç”¨çª—å£å‡½æ•°çš„ç‰ˆæœ¬ï¼š<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary</span><br><span class="line"><span class="keyword">FROM</span> Professors p</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">3</span> &gt; (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">FROM</span> Professors c</span><br><span class="line">    <span class="keyword">WHERE</span> p.salary &lt; c.salary</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary </span><br><span class="line"><span class="comment">--------+-------------+--------</span></span><br><span class="line">   2125 | Sokrates    |  85000</span><br><span class="line">   2128 | Aristoteles |  85000</span><br><span class="line">   2136 | Curie       |  95000</span><br><span class="line">   2137 | Kant        |  98000</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>è¿™é‡Œè¦æä¸€ä¸‹ï¼Œä¸‹é¢è¿™ä¸ªç‰ˆæœ¬ä¸å¯¹ï¼Œå®ƒæ— æ³•ç…§é¡¾åˆ°å¹¶åˆ—çš„åæ¬¡:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">values</span> (<span class="number">2125</span>,<span class="string">'Sokrates'</span>,<span class="string">'C4'</span>,<span class="number">226</span>,<span class="number">85000</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2126</span>,<span class="string">'Russel'</span>,<span class="string">'C4'</span>,<span class="number">232</span>,<span class="number">80000</span>,<span class="number">3</span>),</span><br><span class="line">(<span class="number">2127</span>,<span class="string">'Kopernikus'</span>,<span class="string">'C3'</span>,<span class="number">310</span>,<span class="number">65000</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">2128</span>,<span class="string">'Aristoteles'</span>,<span class="string">'C4'</span>,<span class="number">250</span>,<span class="number">85000</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2133</span>,<span class="string">'Popper'</span>,<span class="string">'C3'</span>,<span class="number">52</span>,<span class="number">68000</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2134</span>,<span class="string">'Augustinus'</span>,<span class="string">'C3'</span>,<span class="number">309</span>,<span class="number">55000</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">2136</span>,<span class="string">'Curie'</span>,<span class="string">'C4'</span>,<span class="number">36</span>,<span class="number">95000</span>,<span class="number">3</span>),</span><br><span class="line">(<span class="number">2137</span>,<span class="string">'Kant'</span>,<span class="string">'C4'</span>,<span class="number">7</span>,<span class="number">98000</span>,<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> persnr, <span class="keyword">name</span>, salary</span><br><span class="line"><span class="keyword">from</span> Professors</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary </span><br><span class="line"><span class="comment">--------+-------------+--------</span></span><br><span class="line">   2137 | Kant        |  98000</span><br><span class="line">   2136 | Curie       |  95000</span><br><span class="line">   2128 | Aristoteles |  85000</span><br><span class="line">(3 rows)</span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å‰ä¸‰ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åŸºæœ¬ä¸Šè®¤è¯†äº†window functionã€‚è¿™æ¬¡æˆ‘ä»¬æœ‰å…·ä½“çš„æ•°æ®é›†å»è¿›è¡Œå¤§é‡ç»ƒä¹ (ç»å¤§éƒ¨åˆ†æ˜¯æ’å)ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(3)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/04/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-3/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/04/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-3/</id>
    <published>2020-04-04T15:12:47.000Z</published>
    <updated>2020-04-04T15:13:47.357Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åŸºæœ¬ä¸Šè®¤è¯†äº†window functionã€‚è¿™æ¬¡æˆ‘ä»¬æœ‰å…·ä½“çš„æ•°æ®é›†å»è¿›è¡Œå¤§é‡ç»ƒä¹ (ç»å¤§éƒ¨åˆ†æ˜¯æ’å)ã€‚</p><a id="more"></a><h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p><p>æ¶æ„ Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p><p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p><p>ä¸‹è½½:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p><p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p><p>è¯¾ä»¶ï¼š</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li></ul><p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p><p><br><br><br></p><h1 id="çª—å£å‡½æ•°"><a href="#çª—å£å‡½æ•°" class="headerlink" title="çª—å£å‡½æ•°"></a>çª—å£å‡½æ•°</h1><h2 id="æˆç»©ä¾‹å­"><a href="#æˆç»©ä¾‹å­" class="headerlink" title="æˆç»©ä¾‹å­"></a>æˆç»©ä¾‹å­</h2><p>æˆ‘ä»¬é‡‡ç”¨ä¸€ä¸ªæ›´å¤§çš„è¡¨æ ¼ï¼ŒåŸºäºåŸæ•°æ®é›†è¡¨æ ¼<code>pruefen</code>ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> examination;</span><br><span class="line"></span><br><span class="line"> matrnr | coursenr | persnr | grade </span><br><span class="line"><span class="comment">--------+----------+--------+-------</span></span><br><span class="line">  28106 |     5001 |   2126 |   1.0</span><br><span class="line">  27550 |     4630 |   2137 |   2.0</span><br><span class="line">  29555 |        0 |      0 |   1.3</span><br><span class="line">  29120 |        0 |      0 |   3.0</span><br><span class="line">  25403 |     5041 |   2125 |   2.0</span><br><span class="line">  29555 |        0 |      0 |   2.0</span><br><span class="line">  29555 |        0 |      0 |   1.0</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»©-ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å"><a href="#åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»©-ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å" class="headerlink" title="åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»© ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å:"></a>åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»© ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å:</h3><p>åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»© ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å(å’ŒåŒä¸€ä¸ªå­¦æœŸçš„åŒå­¦æ¯”è¾ƒ)</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- è®¡ç®—å¹³å‡æˆç»©</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * , </span><br><span class="line">       <span class="keyword">rank</span> () <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> Semester <span class="comment">-- å’ŒåŒä¸€å­¦æœŸçš„åŒå­¦æ¯”è¾ƒ</span></span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> Grade <span class="keyword">asc</span>    <span class="comment">-- æ•°å­—å°æ˜¯é«˜åˆ†ã€€æ’åä¹Ÿé å‰</span></span><br><span class="line">           ) <span class="keyword">as</span> Rang</span><br><span class="line"><span class="keyword">from</span> grades</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>ä¸ä½¿ç”¨çª—å£å‡½æ•°çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- è®¡ç®—å¹³å‡æˆç»©</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * ,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">count</span>(*) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> Grades x</span><br><span class="line">        <span class="keyword">where</span> x.Semester = n.Semester <span class="keyword">and</span> x.Grade &lt; n.Grade) <span class="keyword">as</span> Rang</span><br><span class="line"><span class="keyword">from</span> grades n</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> matrnr | semester |         grade          | rang </span><br><span class="line"><span class="comment">--------+----------+------------------------+------</span></span><br><span class="line">  29555 |        2 |     1.4333333333333333 |    1</span><br><span class="line">  29120 |        2 |     3.0000000000000000 |    2</span><br><span class="line">  28106 |        3 | 1.00000000000000000000 |    1</span><br><span class="line">  27550 |        6 |     2.0000000000000000 |    1</span><br><span class="line">  25403 |       12 |     2.0000000000000000 |    1</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h3 id="åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¦»å¹³å‡æˆç»©çš„å·®è·"><a href="#åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¦»å¹³å‡æˆç»©çš„å·®è·" class="headerlink" title="åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¦»å¹³å‡æˆç»©çš„å·®è·:"></a>åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¦»å¹³å‡æˆç»©çš„å·®è·:</h3><p>åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ æ¯ä¸ªåŒå­¦ç¦»å¹³å‡æˆç»©çš„å·®è·ï¼Œå’ŒåŒå¹´çº§å¹³å‡æˆç»©çš„å·®è·(å’ŒåŒä¸€ä¸ªå­¦æœŸçš„åŒå­¦æ¯”è¾ƒ)</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- è®¡ç®—å¹³å‡æˆç»©</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * ,</span><br><span class="line">       <span class="keyword">rank</span> () <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> Semester <span class="comment">-- å’ŒåŒä¸€å­¦æœŸçš„åŒå­¦æ¯”è¾ƒ</span></span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> Grade <span class="keyword">asc</span>    <span class="comment">-- æ•°å­—å°æ˜¯é«˜åˆ†ã€€æ’åä¹Ÿé å‰</span></span><br><span class="line">           ) <span class="keyword">as</span> Rang,</span><br><span class="line">       <span class="keyword">avg</span> (Grade) <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> Semester  <span class="comment">-- å’ŒåŒä¸€å­¦æœŸçš„åŒå­¦æ¯”è¾ƒ</span></span><br><span class="line">       ) <span class="keyword">as</span> GPA ,                 <span class="comment">-- åŒå¹´çº§çš„å¹³å‡æˆç»©</span></span><br><span class="line">       <span class="keyword">avg</span> (Grade) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> Semester) - Grade <span class="keyword">as</span> <span class="keyword">difference</span></span><br><span class="line"><span class="keyword">from</span> grades</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>ä¸ä½¿ç”¨çª—å£å‡½æ•°çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- è®¡ç®—å¹³å‡æˆç»©</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * ,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">count</span>(*) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> Grades x</span><br><span class="line">        <span class="keyword">where</span> x.Semester = n.Semester <span class="keyword">and</span> x.Grade &lt; n.Grade) <span class="keyword">as</span> Rang,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">avg</span>(x.Grade)</span><br><span class="line">       <span class="keyword">from</span> Grades x</span><br><span class="line">       <span class="keyword">where</span> x.Semester = n.Semester) <span class="keyword">as</span> GPA,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">avg</span>(x.Grade)</span><br><span class="line">       <span class="keyword">from</span> Grades x</span><br><span class="line">       <span class="keyword">where</span> x.Semester = n.Semester) - Grade <span class="keyword">as</span> <span class="keyword">difference</span></span><br><span class="line"><span class="keyword">from</span> grades n</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> matrnr | semester |         grade          | rang |          gpa           |       difference       </span><br><span class="line"><span class="comment">--------+----------+------------------------+------+------------------------+------------------------</span></span><br><span class="line">  29555 |        2 |     1.4333333333333333 |    1 |     2.2166666666666667 |     0.7833333333333334</span><br><span class="line">  29120 |        2 |     3.0000000000000000 |    2 |     2.2166666666666667 |    -0.7833333333333333</span><br><span class="line">  28106 |        3 | 1.00000000000000000000 |    1 | 1.00000000000000000000 | 0.00000000000000000000</span><br><span class="line">  27550 |        6 |     2.0000000000000000 |    1 |     2.0000000000000000 |     0.0000000000000000</span><br><span class="line">  25403 |       12 |     2.0000000000000000 |    1 |     2.0000000000000000 |     0.0000000000000000</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åŸºæœ¬ä¸Šè®¤è¯†äº†window functionã€‚è¿™æ¬¡æˆ‘ä»¬æœ‰å…·ä½“çš„æ•°æ®é›†å»è¿›è¡Œå¤§é‡ç»ƒä¹ (ç»å¤§éƒ¨åˆ†æ˜¯æ’å)ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(2)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/02/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-2/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/02/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-2/</id>
    <published>2020-04-02T13:04:31.000Z</published>
    <updated>2020-04-02T13:06:21.074Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨<a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/">[CMU-15445]Lec02_part2 Advanced SQL - é«˜çº§ SQL</a>ä¸­éå¸¸åˆæ­¥äº†äº†è§£äº†window functionçª—å£å‡½æ•°ã€‚å®ƒæ˜¯åœ¨OLAPä¸­éå¸¸é«˜æ•ˆçš„ä¸€ç§å‡½æ•°ï¼Œåœ¨å·¥ä¸šä¸šåŠ¡ä¸­éå¸¸å¸¸è§ã€‚å¦å¤–æˆ‘åœ¨Leetcodeä¸­çš„SQLéƒ¨åˆ†ä¹Ÿå‘ç°å¾ˆå¤šé¢˜ç›®å¯ä»¥é€‚ç”¨window functionã€‚CMUè¯¾å®é™…ä¸Šæœ‰ä¸€äº›ç®€ç•¥ã€‚æˆ‘ä¼šä½¿ç”¨TUMçš„<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en">Foundations in Data Engineering<i class="fa fa-external-link"></i></span>è¯¾ä»¶æ¥é‡ç‚¹å­¦ä¹ ç»ƒä¹ è¿™å—å†…å®¹ã€‚</p><p>æˆ‘ä»¬è¿™æ¬¡ç»ƒä¹  ä½¿ç”¨frameçš„window function</p><a id="more"></a><h1 id="ä½¿ç”¨frameçš„window-functions"><a href="#ä½¿ç”¨frameçš„window-functions" class="headerlink" title="ä½¿ç”¨frameçš„window functions"></a>ä½¿ç”¨frameçš„window functions</h1><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/30.jpg" alt="30.jpg"></p><h2 id="rows"><a href="#rows" class="headerlink" title="rows"></a><code>rows</code></h2><h3 id="ä¸Šä¸€è¡Œï½ä¸‹ä¸€è¡Œ"><a href="#ä¸Šä¸€è¡Œï½ä¸‹ä¸€è¡Œ" class="headerlink" title="ä¸Šä¸€è¡Œï½ä¸‹ä¸€è¡Œ"></a>ä¸Šä¸€è¡Œï½ä¸‹ä¸€è¡Œ</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |  20</span><br><span class="line"> 10 |  34</span><br><span class="line"> 14 |  41</span><br><span class="line"> 17 |  48</span><br><span class="line"> 17 |  52</span><br><span class="line"> 18 |  55</span><br><span class="line"> 20 |  38</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="ä¸Šä¸€è¡Œï½æœ€åä¸€è¡Œ"><a href="#ä¸Šä¸€è¡Œï½æœ€åä¸€è¡Œ" class="headerlink" title="ä¸Šä¸€è¡Œï½æœ€åä¸€è¡Œ"></a>ä¸Šä¸€è¡Œï½æœ€åä¸€è¡Œ</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">unbounded</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 106</span><br><span class="line"> 10 | 106</span><br><span class="line"> 14 |  96</span><br><span class="line"> 17 |  86</span><br><span class="line"> 17 |  72</span><br><span class="line"> 18 |  55</span><br><span class="line"> 20 |  38</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h2 id="range"><a href="#range" class="headerlink" title="range"></a><code>range</code></h2><p>PostgreSQLä¸èƒ½å¤„ç†ä¸‹é¢çš„SQLï¼Œä½†æ˜¯HyPerå¯ä»¥ã€‚</p><h3 id="forall-x-x-x-1"><a href="#forall-x-x-x-1" class="headerlink" title="$\forall x: [x, x+1]$"></a>$\forall x: [x, x+1]$</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 20</span><br><span class="line"> 10 | 20</span><br><span class="line"> 14 | 14</span><br><span class="line"> 17 | 52</span><br><span class="line"> 17 | 52</span><br><span class="line"> 18 | 18</span><br><span class="line"> 20 | 20</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="forall-x-x-x-2"><a href="#forall-x-x-x-2" class="headerlink" title="$\forall x: [x, x+2]$"></a>$\forall x: [x, x+2]$</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">2</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 20</span><br><span class="line"> 10 | 20</span><br><span class="line"> 14 | 14</span><br><span class="line"> 17 | 52</span><br><span class="line"> 17 | 52</span><br><span class="line"> 18 | 38</span><br><span class="line"> 20 | 20</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p>ç›¸æ¯”è¾ƒä¸Šé¢ä¸¤ä¸ªä¾‹å­ï¼Œ ç»“æœä¸­ä»<code>18 | 18</code>å˜æˆ<code>18 | 38</code>ï¼Œå› ä¸º<code>18</code>è¿™ä¸ªtupelå¯ä»¥æ¶‰åŠçš„å€¼åŸŸèŒƒå›´ä»$[18, 19]$å˜æˆ$[18, 20]$</p><h3 id="forall-x-mathrm-unbounded-x"><a href="#forall-x-mathrm-unbounded-x" class="headerlink" title="$\forall x: [\mathrm{unbounded}, x]$"></a>$\forall x: [\mathrm{unbounded}, x]$</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">0</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><p>æˆ–</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |  20</span><br><span class="line"> 10 |  20</span><br><span class="line"> 14 |  34</span><br><span class="line"> 17 |  68</span><br><span class="line"> 17 |  68</span><br><span class="line"> 18 |  86</span><br><span class="line"> 20 | 106</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="forall-x-y-1-y-1"><a href="#forall-x-y-1-y-1" class="headerlink" title="$\forall x: [y-1, y+1]$"></a>$\forall x: [y-1, y+1]$</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                       (<span class="number">10</span>, <span class="number">1</span>),</span><br><span class="line">                       (<span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">                       (<span class="number">14</span>, <span class="number">2</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">3</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">4</span>),</span><br><span class="line">                       (<span class="number">18</span>, <span class="number">15</span>),</span><br><span class="line">                       (<span class="number">20</span>, <span class="number">6</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> y <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> y;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 10</span><br><span class="line"> 14 | 24</span><br><span class="line"> 17 | 41</span><br><span class="line"> 17 | 58</span><br><span class="line"> 20 | 78</span><br><span class="line"> 10 | 88</span><br><span class="line"> 18 | 106</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                       (<span class="number">10</span>, <span class="number">1</span>),</span><br><span class="line">                       (<span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">                       (<span class="number">14</span>, <span class="number">2</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">3</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">4</span>),</span><br><span class="line">                       (<span class="number">18</span>, <span class="number">15</span>),</span><br><span class="line">                       (<span class="number">20</span>, <span class="number">6</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> y)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> y;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |  10</span><br><span class="line"> 14 |  24</span><br><span class="line"> 17 |  41</span><br><span class="line"> 17 |  58</span><br><span class="line"> 20 |  78</span><br><span class="line"> 10 |  88</span><br><span class="line"> 18 | 106</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><hr><p>å¼•ç”¨: </p><p>è¯¾ä»¶: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æˆ‘ä»¬åœ¨&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/&quot;&gt;[CMU-15445]Lec02_part2 Advanced SQL - é«˜çº§ SQL&lt;/a&gt;ä¸­éå¸¸åˆæ­¥äº†äº†è§£äº†window functionçª—å£å‡½æ•°ã€‚å®ƒæ˜¯åœ¨OLAPä¸­éå¸¸é«˜æ•ˆçš„ä¸€ç§å‡½æ•°ï¼Œåœ¨å·¥ä¸šä¸šåŠ¡ä¸­éå¸¸å¸¸è§ã€‚å¦å¤–æˆ‘åœ¨Leetcodeä¸­çš„SQLéƒ¨åˆ†ä¹Ÿå‘ç°å¾ˆå¤šé¢˜ç›®å¯ä»¥é€‚ç”¨window functionã€‚CMUè¯¾å®é™…ä¸Šæœ‰ä¸€äº›ç®€ç•¥ã€‚æˆ‘ä¼šä½¿ç”¨TUMçš„&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=&quot; title=&quot;https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en&quot;&gt;Foundations in Data Engineering&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;è¯¾ä»¶æ¥é‡ç‚¹å­¦ä¹ ç»ƒä¹ è¿™å—å†…å®¹ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬è¿™æ¬¡ç»ƒä¹  ä½¿ç”¨frameçš„window function&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="TUM-IN2326" scheme="https://cakebytheoceanluo.github.io/categories/TUM-IN2326/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(1)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/01/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-1/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/01/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-1/</id>
    <published>2020-04-01T14:55:49.000Z</published>
    <updated>2020-04-02T13:05:39.306Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨<a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/">[CMU-15445]Lec02_part2 Advanced SQL - é«˜çº§ SQL</a>ä¸­éå¸¸åˆæ­¥äº†äº†è§£äº†window functionçª—å£å‡½æ•°ã€‚å®ƒæ˜¯åœ¨OLAPä¸­éå¸¸é«˜æ•ˆçš„ä¸€ç§å‡½æ•°ï¼Œåœ¨å·¥ä¸šä¸šåŠ¡ä¸­éå¸¸å¸¸è§ã€‚å¦å¤–æˆ‘åœ¨Leetcodeä¸­çš„SQLéƒ¨åˆ†ä¹Ÿå‘ç°å¾ˆå¤šé¢˜ç›®å¯ä»¥é€‚ç”¨window functionã€‚CMUè¯¾å®é™…ä¸Šæœ‰ä¸€äº›ç®€ç•¥ã€‚æˆ‘ä¼šä½¿ç”¨TUMçš„<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en">Foundations in Data Engineering<i class="fa fa-external-link"></i></span>è¯¾ä»¶æ¥é‡ç‚¹å­¦ä¹ ç»ƒä¹ è¿™å—å†…å®¹ã€‚</p><p>æˆ‘ä»¬è¿™æ¬¡ç»ƒä¹  ä¸ä½¿ç”¨frameçš„window function</p><a id="more"></a><h1 id="ä¸ä½¿ç”¨frameçš„window-functions"><a href="#ä¸ä½¿ç”¨frameçš„window-functions" class="headerlink" title="ä¸ä½¿ç”¨frameçš„window functions"></a>ä¸ä½¿ç”¨frameçš„window functions</h1><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/27.jpg" alt="27.jpg"></p><h2 id="ranking-æ’åº"><a href="#ranking-æ’åº" class="headerlink" title="ranking æ’åº"></a>ranking æ’åº</h2><h3 id="rank"><a href="#rank" class="headerlink" title="rank()"></a>rank()</h3><p>å¹¶åˆ—ä¼šå ç”¨åé¢çš„æ’åæ•°å­—ã€‚</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | rank </span><br><span class="line"><span class="comment">----+------</span></span><br><span class="line"> 10 |    1</span><br><span class="line"> 10 |    1</span><br><span class="line"> 14 |    3</span><br><span class="line"> 17 |    4</span><br><span class="line"> 17 |    4</span><br><span class="line"> 18 |    6</span><br><span class="line"> 20 |    7</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="dense-rank"><a href="#dense-rank" class="headerlink" title="dense_rank()"></a>dense_rank()</h3><p>å¹¶åˆ—ä¸ä¼šå ç”¨åé¢çš„æ’åæ•°å­—ã€‚</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | dense_rank </span><br><span class="line"><span class="comment">----+------------</span></span><br><span class="line"> 10 |          1</span><br><span class="line"> 10 |          1</span><br><span class="line"> 14 |          2</span><br><span class="line"> 17 |          3</span><br><span class="line"> 17 |          3</span><br><span class="line"> 18 |          4</span><br><span class="line"> 20 |          5</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="row-number"><a href="#row-number" class="headerlink" title="row_number()"></a>row_number()</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, row_number() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | row_number </span><br><span class="line"><span class="comment">----+------------</span></span><br><span class="line"> 10 |          1</span><br><span class="line"> 10 |          2</span><br><span class="line"> 14 |          3</span><br><span class="line"> 17 |          4</span><br><span class="line"> 17 |          5</span><br><span class="line"> 18 |          6</span><br><span class="line"> 20 |          7</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="ntile-INT"><a href="#ntile-INT" class="headerlink" title="ntile(INT)"></a>ntile(INT)</h3><p>æŠŠè¡¨æ ¼å‡åˆ†ä¸º<code>INT</code>ä»½</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, ntile(<span class="number">2</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | ntile </span><br><span class="line"><span class="comment">----+-------</span></span><br><span class="line"> 10 |     1</span><br><span class="line"> 10 |     1</span><br><span class="line"> 14 |     1</span><br><span class="line"> 17 |     1</span><br><span class="line"> 17 |     2</span><br><span class="line"> 18 |     2</span><br><span class="line"> 20 |     2</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, ntile(<span class="number">3</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | ntile </span><br><span class="line"><span class="comment">----+-------</span></span><br><span class="line"> 10 |     1</span><br><span class="line"> 10 |     1</span><br><span class="line"> 14 |     1</span><br><span class="line"> 17 |     2</span><br><span class="line"> 17 |     2</span><br><span class="line"> 18 |     3</span><br><span class="line"> 20 |     3</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h2 id="distribution-åˆ†å¸ƒ"><a href="#distribution-åˆ†å¸ƒ" class="headerlink" title="distribution åˆ†å¸ƒ"></a>distribution åˆ†å¸ƒ</h2><h3 id="percent-rank"><a href="#percent-rank" class="headerlink" title="percent_rank()"></a>percent_rank()</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">percent_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  |   percent_rank    </span><br><span class="line"><span class="comment">----+-------------------</span></span><br><span class="line"> 10 |                 0</span><br><span class="line"> 10 |                 0</span><br><span class="line"> 14 | 0.333333333333333</span><br><span class="line"> 17 |               0.5</span><br><span class="line"> 17 |               0.5</span><br><span class="line"> 18 | 0.833333333333333</span><br><span class="line"> 20 |                 1</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="cume-dist"><a href="#cume-dist" class="headerlink" title="cume_dist()"></a>cume_dist()</h3><p>cumulative distribution function(cdf): æ¦‚ç‡ç´¯åŠ å‡½æ•°</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">cume_dist</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  |     cume_dist     </span><br><span class="line"><span class="comment">----+-------------------</span></span><br><span class="line"> 10 | 0.285714285714286</span><br><span class="line"> 10 | 0.285714285714286</span><br><span class="line"> 14 | 0.428571428571429</span><br><span class="line"> 17 | 0.714285714285714</span><br><span class="line"> 17 | 0.714285714285714</span><br><span class="line"> 18 | 0.857142857142857</span><br><span class="line"> 20 |                 1</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h2 id="navigation-in-partition-åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­è¿›è¡Œå®šä½"><a href="#navigation-in-partition-åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­è¿›è¡Œå®šä½" class="headerlink" title="navigation in partition åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­è¿›è¡Œå®šä½"></a>navigation in partition åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­è¿›è¡Œå®šä½</h2><h3 id="lag-expr-offset-default"><a href="#lag-expr-offset-default" class="headerlink" title="lag(expr, offset, default)"></a>lag(expr, offset, default)</h3><p>å¯ä»¥å¾—åˆ°åŒç»„å‰<code>offset</code>çš„tupelçš„æ•°å€¼ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, lag(x, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | lag </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |    </span><br><span class="line"> 10 |  10</span><br><span class="line"> 14 |  10</span><br><span class="line"> 17 |  14</span><br><span class="line"> 17 |  17</span><br><span class="line"> 18 |  17</span><br><span class="line"> 20 |  18</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ç©ºç€çš„é‚£ä¸€æ ¼æ˜¯<code>NULL</code>ï¼Œæ˜¯æˆ‘ä»¬è®¾ç½®çš„defaulté»˜è®¤å€¼ã€‚</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, lag(<span class="number">2</span> * x, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | lag </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |    </span><br><span class="line"> 10 |  20</span><br><span class="line"> 14 |  20</span><br><span class="line"> 17 |  28</span><br><span class="line"> 17 |  34</span><br><span class="line"> 18 |  34</span><br><span class="line"> 20 |  36</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="lead-expr-offset-default"><a href="#lead-expr-offset-default" class="headerlink" title="lead(expr, offset, default)"></a>lead(expr, offset, default)</h3><p>å¯ä»¥å¾—åˆ°åŒç»„å‰<code>offset</code>çš„tupelçš„æ•°å€¼ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">lead</span>(<span class="number">2</span> * x, <span class="number">2</span>, <span class="number">-1</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | lead </span><br><span class="line"><span class="comment">----+------</span></span><br><span class="line"> 10 |   28</span><br><span class="line"> 10 |   34</span><br><span class="line"> 14 |   34</span><br><span class="line"> 17 |   36</span><br><span class="line"> 17 |   40</span><br><span class="line"> 18 |   -1</span><br><span class="line"> 20 |   -1</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><hr><p>å¼•ç”¨: </p><p>è¯¾ä»¶: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æˆ‘ä»¬åœ¨&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/&quot;&gt;[CMU-15445]Lec02_part2 Advanced SQL - é«˜çº§ SQL&lt;/a&gt;ä¸­éå¸¸åˆæ­¥äº†äº†è§£äº†window functionçª—å£å‡½æ•°ã€‚å®ƒæ˜¯åœ¨OLAPä¸­éå¸¸é«˜æ•ˆçš„ä¸€ç§å‡½æ•°ï¼Œåœ¨å·¥ä¸šä¸šåŠ¡ä¸­éå¸¸å¸¸è§ã€‚å¦å¤–æˆ‘åœ¨Leetcodeä¸­çš„SQLéƒ¨åˆ†ä¹Ÿå‘ç°å¾ˆå¤šé¢˜ç›®å¯ä»¥é€‚ç”¨window functionã€‚CMUè¯¾å®é™…ä¸Šæœ‰ä¸€äº›ç®€ç•¥ã€‚æˆ‘ä¼šä½¿ç”¨TUMçš„&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=&quot; title=&quot;https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en&quot;&gt;Foundations in Data Engineering&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;è¯¾ä»¶æ¥é‡ç‚¹å­¦ä¹ ç»ƒä¹ è¿™å—å†…å®¹ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬è¿™æ¬¡ç»ƒä¹  ä¸ä½¿ç”¨frameçš„window function&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="TUM-IN2326" scheme="https://cakebytheoceanluo.github.io/categories/TUM-IN2326/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(6)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/31/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-6/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/31/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-6/</id>
    <published>2020-03-31T20:57:49.000Z</published>
    <updated>2020-03-31T21:02:41.291Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Six-Degrees-of-Kevin-Bacon"><a href="#Six-Degrees-of-Kevin-Bacon" class="headerlink" title="Six Degrees of Kevin Bacon"></a>Six Degrees of Kevin Bacon</h1><p>å…·ä½“æè¿°è§: <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2l4X0RlZ3JlZXNfb2ZfS2V2aW5fQmFjb24=" title="https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon">https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon<i class="fa fa-external-link"></i></span></p><p>Six Degrees of Kevin Baconæˆ–â€Baconâ€™s Lawâ€æ˜¯åŸºäºâ€six degrees of separationå…­åº¦åˆ†ç¦»â€ï¼Œå®ƒå‡å®šåœ°çƒä¸Šä»»ä½•ä¸¤ä¸ªäººç›¸è·å…­ä¸ªæˆ–æ›´å°‘çš„ç†Ÿäººé“¾æ¥ã€‚ æ¯”å¦‚å¯»æ‰¾ä»»æ„æ¼”å‘˜å’Œå¤šäº§æ¼”å‘˜Kevin Baconä¹‹é—´çš„æœ€çŸ­è·¯å¾„ã€‚ å®ƒåŸºäºä¸€ä¸ªå‡è®¾ï¼Œå³å¥½è±åç”µå½±ç•Œçš„ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡å…¶ç”µå½±è§’è‰²åœ¨å…­ä¸ªæ­¥éª¤ä¸­å°†å…¶ä¸Kevin Baconè”ç³»èµ·æ¥ã€‚è¿™ä¸ªæ¦‚å¿µä¹Ÿç±»ä¼¼Fackbookæå‡ºçš„æ¦‚å¿µã€‚å½“ç„¶åœ¨è®¡ç®—æœºæˆ–è€…ç®—æ³•è§’åº¦ï¼Œè¿™æ˜¯ä¸€ä¸ªBFSå¹¿åº¦ä¼˜å…ˆçš„å›¾é—®é¢˜ã€‚é€šè¿‡é—´æ¥çš„6æ­¥å¯èƒ½ä¼šæ¥è§¦éå¸¸å¤šäººï¼Œäº§ç”Ÿéå¸¸å¤§çš„æ•°æ®ã€‚å…·ä½“æˆ‘ä»¬ä¼šåœ¨ä¸‹é¢çš„ç»ƒä¹ ä¸­ä½“éªŒåˆ°ã€‚</p><p>è¿™é‡Œå†é™„ä¸ŠKevin Baconçš„ä¸€äº›é“¾æ¥:</p><ul><li>ä¸ªäººç½‘ç«™(ä»–ç›´æ¥ç”¨äº†six degreeè¿™ä¸ªæ¦‚å¿µ): <span class="exturl" data-url="aHR0cHM6Ly93d3cuc2l4ZGVncmVlcy5vcmc=" title="https://www.sixdegrees.org">https://www.sixdegrees.org<i class="fa fa-external-link"></i></span></li><li>è±†ç“£ä¸»é¡µ: <span class="exturl" data-url="aHR0cHM6Ly9tb3ZpZS5kb3ViYW4uY29tL2NlbGVicml0eS8xMDA5MjYwLw==" title="https://movie.douban.com/celebrity/1009260/">https://movie.douban.com/celebrity/1009260/<i class="fa fa-external-link"></i></span></li></ul><a id="more"></a><h2 id="IMDbæ•°æ®é›†"><a href="#IMDbæ•°æ®é›†" class="headerlink" title="IMDbæ•°æ®é›†"></a>IMDbæ•°æ®é›†</h2><p>æˆ‘ä»¬è¿™æ¬¡ä½¿ç”¨IMDbæ•°æ®é›†ï¼Œæœ¬åœ°è½½å…¥æ•°æ®é›†çš„æ–¹å¼è§æˆ‘ä»¥å‰çš„ä¸€ç¯‡æ–‡ç« : <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#IMDb-%E6%95%B0%E6%8D%AE%E9%9B%86">[DBMS]PostgreSQLå¯¼å…¥æ•°æ®é›† - IMDb æ•°æ®é›†</a></p><p><br></p><p>æˆ‘ä»¬æ‰“å¼€psqlçš„è®¡æ—¶å™¨:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">imdb=# \timing</span><br><span class="line">Timing is on.</span><br></pre></td></tr></tbody></table></figure><h2 id="è°ƒæ•´buffer-poolå’Œcacheå¤§å°"><a href="#è°ƒæ•´buffer-poolå’Œcacheå¤§å°" class="headerlink" title="è°ƒæ•´buffer poolå’Œcacheå¤§å°"></a>è°ƒæ•´buffer poolå’Œcacheå¤§å°</h2><p>æˆ‘ä»¬ç”¨è‡ªå·±å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨å»æ‰“å¼€<code>/etc/postgresql/10/main/postgresql.conf</code>æ–‡ä»¶:</p><ul><li>æ³¨æ„æˆ‘<code>postgresql</code>çš„ç‰ˆæœ¬æ˜¯<code>10</code></li><li>å…·ä½“çš„é…ç½®æ–‡ä»¶ä½ç½®å’Œ<code>postgresql</code>å®‰è£…ä½ç½®å’Œå®‰è£…ç‰ˆæœ¬æœ‰å…³</li></ul><p>æ‰¾åˆ°ä¸‹é¢å¯¹åº”çš„<code>shared_buffers</code>å»ºè®®æ›´æ”¹æ•°å€¼ä¸º1024MBï¼Œ <code>work_mem</code>å»ºè®®æ›´æ”¹ä¸º1024MB (æˆ‘éƒ½æ”¹æˆæ¯”å»ºè®®å€¼å¤§ï¼Œè¿™é‡Œå¤§å®¶æŒ‰ç…§è‡ªå·±æœºå™¨çš„ç¡¬ä»¶é…ç½®æ¥ä¼°è®¡):</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># RESOURCE USAGE (except WAL)</span></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Memory -</span></span><br><span class="line"></span><br><span class="line">shared_buffers = 2048MB                 <span class="comment"># min 128kB</span></span><br><span class="line">                                        <span class="comment"># (change requires restart)</span></span><br><span class="line"><span class="comment">#huge_pages = try                       # on, off, or try</span></span><br><span class="line">                                        <span class="comment"># (change requires restart)</span></span><br><span class="line"><span class="comment">#temp_buffers = 8MB                     # min 800kB </span></span><br><span class="line"><span class="comment">#max_prepared_transactions = 0          # zero disables the feature</span></span><br><span class="line">                                        <span class="comment"># (change requires restart)</span></span><br><span class="line"><span class="comment"># Caution: it is not advisable to set max_prepared_transactions nonzero unless</span></span><br><span class="line"><span class="comment"># you actively intend to use prepared transactions.</span></span><br><span class="line">work_mem = 8196MB                               <span class="comment"># min 64kB  </span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>æ›´æ”¹å¥½åä¿å­˜ï¼Œæ‰§è¡Œä¸‹é¢çš„æŒ‡ä»¤ï¼Œè®©psqlé‡å¯æ¥ä½¿é…ç½®ç”Ÿæ•ˆ:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="æ±‚Bacon-Kevinæ¼”è¿‡çš„ç”µå½±æ•°é‡"><a href="#æ±‚Bacon-Kevinæ¼”è¿‡çš„ç”µå½±æ•°é‡" class="headerlink" title="æ±‚Bacon, Kevinæ¼”è¿‡çš„ç”µå½±æ•°é‡"></a>æ±‚<code>Bacon, Kevin</code>æ¼”è¿‡çš„ç”µå½±æ•°é‡</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> movie_name)</span><br><span class="line"><span class="keyword">from</span> playedin_text</span><br><span class="line"><span class="keyword">where</span> actor_name = <span class="string">'Bacon, Kevin'</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> count </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line">   322</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 838.464 ms</span><br></pre></td></tr></tbody></table></figure><h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº1çš„æ¼”å‘˜æ•°é‡"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº1çš„æ¼”å‘˜æ•°é‡" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº1çš„æ¼”å‘˜æ•°é‡"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº1çš„æ¼”å‘˜æ•°é‡</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (<span class="keyword">id</span>, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> p2.actor_name, baconnr.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> baconnr, playedin_text p1, playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> baconnr.id = p1.actor_name <span class="keyword">and</span> </span><br><span class="line">          p1.movie_name = p2.movie_name <span class="keyword">and</span> </span><br><span class="line">          baconnr.nr &lt; <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> count </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line"> 35893</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 5718.960 ms (00:05.719)</span><br></pre></td></tr></tbody></table></figure><h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-ä¸€æ¬¡å°è¯•"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-ä¸€æ¬¡å°è¯•" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - ä¸€æ¬¡å°è¯•"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - ä¸€æ¬¡å°è¯•</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (<span class="keyword">id</span>, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> p2.actor_name, baconnr.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> baconnr, playedin_text p1, playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> baconnr.id = p1.actor_name <span class="keyword">and</span> </span><br><span class="line">          p1.movie_name = p2.movie_name <span class="keyword">and</span> </span><br><span class="line">          baconnr.nr &lt; <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><p>å¾ˆå¯æƒœè¿™æ¡SQLåœ¨æˆ‘çš„ç”µè„‘ä¸Šååˆ†é’Ÿå†…æ— æ³•ç»ˆæ­¢ã€‚æœ¬è´¨ä¸Šè¿™å±äºä¸€ä¸ªå¹¿åº¦æœç´¢ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡å¤æ¥è§¦åˆ°å¾ˆå¤šäººï¼Œè¿™ä½¿è¿™æ¡SQLåœ¨çŸ­æ—¶é—´å†…ä¸èƒ½ç»ˆæ­¢ã€‚</p><h3 id="cardinality"><a href="#cardinality" class="headerlink" title="cardinality"></a>cardinality</h3><p>å³Bacon Numberç­‰äº1ï¼Œä½†æ˜¯å­˜åœ¨é‡å¤</p><p>the size of intermediate results</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(p2.actor_name)</span><br><span class="line"><span class="keyword">from</span> playedin_text p1, playedin_text p2</span><br><span class="line"><span class="keyword">where</span> p1.actor_name = <span class="string">'Bacon, Kevin'</span> <span class="keyword">and</span> p1.movie_name = p2.movie_name;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  count  </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line"> 1391638</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 11896.991 ms (00:11.897)</span><br></pre></td></tr></tbody></table></figure><h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-é™¤å»é‡å¤"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-é™¤å»é‡å¤" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - é™¤å»é‡å¤"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - é™¤å»é‡å¤</h2><p>ä½¿ç”¨<code>union all</code>å’Œ<code>select distinct</code>:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (actor_name, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> p2.actor_name, movies.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> p1.movie_name, baconnr.nr</span><br><span class="line">          <span class="keyword">from</span> baconnr, playedin_text p1</span><br><span class="line">          <span class="keyword">where</span> baconnr.actor_name = p1.actor_name</span><br><span class="line">         ) movies,</span><br><span class="line">         playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> movies.movie_name = p2.movie_name <span class="keyword">and</span> movies.nr &lt; <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> actor_name)</span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  count  </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line"> 1046450</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 27453.873 ms (00:27.454)</span><br></pre></td></tr></tbody></table></figure><h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-é™¤å»é‡å¤-1"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-é™¤å»é‡å¤-1" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - é™¤å»é‡å¤"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - é™¤å»é‡å¤</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (actor_name, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> p2.actor_name, movies.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> p1.movie_name, baconnr.nr</span><br><span class="line">          <span class="keyword">from</span> baconnr, playedin_text p1</span><br><span class="line">          <span class="keyword">where</span> baconnr.actor_name = p1.actor_name</span><br><span class="line">         ) movies,</span><br><span class="line">         playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> movies.movie_name = p2.movie_name <span class="keyword">and</span> movies.nr &lt; <span class="number">3</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> actor_name)</span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><p><br><br><br><br><br></p><h2 id="string-to-int"><a href="#string-to-int" class="headerlink" title="string to int"></a>string to int</h2><p>å¯¹stringçš„æ“ä½œæ˜¯ç›¸å¯¹æ˜‚è´µçš„ï¼Œä½†æ˜¯å¯¹intçš„æ“ä½œæ˜¯ç›¸å¯¹å»‰ä»·çš„ã€‚æˆ‘ä»¬æ–°å»ºå¯¹åº”çš„å‡ ä¸ªæ–°çš„è¡¨æ ¼ï¼Œä½¿ç”¨int, è¿™æ ·ä¹Ÿå¯ä»¥é™ä½è¡¨æ ¼çš„å¤§å°ã€‚</p><ul><li>table actors (id::integer, name::text)</li><li>table movies (id::integer, name::text)</li><li>table playedin (actor::integer, movies::integer)</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> movies (<span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>, <span class="keyword">name</span> <span class="built_in">text</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> actors (<span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>, <span class="keyword">name</span> <span class="built_in">text</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> playedin (</span><br><span class="line">    movie <span class="built_in">integer</span> <span class="keyword">references</span> movies (<span class="keyword">id</span>),</span><br><span class="line">    actor <span class="built_in">integer</span> <span class="keyword">references</span> actors (<span class="keyword">id</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actors (<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">distinct</span> actor_name <span class="keyword">from</span> playedin_text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> movies (<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">distinct</span> movie_name <span class="keyword">from</span> playedin_text;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- read from all</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> playedin (actor, movie)</span><br><span class="line"><span class="keyword">select</span> actors.id, movies.id</span><br><span class="line"><span class="keyword">from</span> actors, movies, playedin_text p</span><br><span class="line"><span class="keyword">where</span> p.actor_name = actors.name <span class="keyword">and</span> p.movie_name = movies.name;</span><br></pre></td></tr></tbody></table></figure><h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (<span class="keyword">id</span>, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span> , <span class="number">0</span></span><br><span class="line">    <span class="keyword">from</span> actors</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'Bacon, Kevin'</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> p2.actor, movies.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    ( <span class="keyword">select</span> <span class="keyword">distinct</span> p1.movie, baconnr.nr</span><br><span class="line">    <span class="keyword">from</span> baconnr, playedin p1</span><br><span class="line">    <span class="keyword">where</span> baconnr.id = p1.actor) movies,</span><br><span class="line">    playedin p2</span><br><span class="line">    <span class="keyword">where</span> movies.movie = p2.movie <span class="keyword">and</span> movies.nr &lt; <span class="number">5</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span> (<span class="keyword">distinct</span> <span class="keyword">id</span>)</span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  count  </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line"> 1821293</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 175282.570 ms (02:55.283)</span><br></pre></td></tr></tbody></table></figure><h1 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h1><p>æ•°æ®é›†(ä»¥åŠç°å®ä¸–ç•Œ)ä¸­ç”šè‡³æœ‰Bacon Numberä¸º7çš„æ¼”å‘˜ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å†ç»§ç»­äº†ã€‚å¤§å®¶å¦‚æœèƒ½å®éªŒä¸€ä¸‹ï¼Œäº†è§£ä¸»æ—¨å°±å¾ˆå¥½ã€‚</p><p><br><br><br><br><br></p><h1 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h1><h2 id="Optional-æ‰¾åˆ°Bacon-Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡-Query-Plan"><a href="#Optional-æ‰¾åˆ°Bacon-Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡-Query-Plan" class="headerlink" title="Optional: æ‰¾åˆ°Bacon Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡ - Query Plan"></a>Optional: æ‰¾åˆ°Bacon Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡ - Query Plan</h2><p>è¿™éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œè€Œä¸æ˜¯å¿…é¡»çš„ã€‚è¿™éƒ¨åˆ†æˆ‘é™„ä¸Šäº†ä¸Šä¸€ä¸ªSQLå¯¹åº”çš„Query Planã€‚</p><ul><li>æˆ‘æ‰“å¼€äº†å¤šçº¿ç¨‹é€‰é¡¹: <code>testdb=# set max_parallel_workers_per_gather = 4;</code>, å¯¹åº”ä¸‹é¢çš„Query Planä¸­çš„Workersã€‚</li><li>æˆ‘ä½¿ç”¨äº†ç»å¯¹å¤§çš„buffer poolå»å®¹çº³æ‰€æœ‰çš„page, å› æ­¤ä¸‹é¢Query Planåªæœ‰<code>shared hit</code>ï¼Œ è€Œæ²¡æœ‰<code>shared read</code></li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">imdb=# explain (analyze, buffers) with recursive baconnr (id, nr) as (</span><br><span class="line">    select id , <span class="number">0</span></span><br><span class="line">    from actors</span><br><span class="line">    where name = 'Bacon, Kevin'</span><br><span class="line">    <span class="keyword">union</span> all</span><br><span class="line">    select distinct p2.actor, movies.nr + <span class="number">1</span></span><br><span class="line">    from</span><br><span class="line">    ( select distinct p1.movie, baconnr.nr</span><br><span class="line">    from baconnr, playedin p1</span><br><span class="line">    where baconnr.id = p1.actor) movies,</span><br><span class="line">    playedin p2</span><br><span class="line">    where movies.movie = p2.movie <span class="keyword">and</span> movies.nr &lt; <span class="number">5</span></span><br><span class="line">)</span><br><span class="line">select count (distinct id)</span><br><span class="line">from baconnr;</span><br><span class="line">                                                                                QUERY PLAN                                                                                </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">3243681.47</span>.<span class="number">.3243681</span><span class="number">.48</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">181539.730</span>.<span class="number">.181539</span><span class="number">.730</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">72933155</span></span><br><span class="line">   CTE baconnr</span><br><span class="line">     -&gt;  Recursive Union  (cost=<span class="number">1000.00</span>.<span class="number">.3196845</span><span class="number">.00</span> rows=<span class="number">2081621</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">1.375</span>.<span class="number">.178161</span><span class="number">.180</span> rows=<span class="number">6480755</span> loops=<span class="number">1</span>)</span><br><span class="line">           Buffers: shared hit=<span class="number">72933155</span></span><br><span class="line">           -&gt;  Gather  (cost=<span class="number">1000.00</span>.<span class="number">.23770</span><span class="number">.35</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">1.366</span>.<span class="number">.65</span><span class="number">.451</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">                 Workers Planned: <span class="number">2</span></span><br><span class="line">                 Workers Launched: <span class="number">2</span></span><br><span class="line">                 Buffers: shared hit=<span class="number">12501</span></span><br><span class="line">                 -&gt;  Parallel Seq Scan on actors  (cost=<span class="number">0.00</span>.<span class="number">.22770</span><span class="number">.25</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">40.406</span>.<span class="number">.61</span><span class="number">.732</span> rows=<span class="number">0</span> loops=<span class="number">3</span>)</span><br><span class="line">                       Filter: (name = 'Bacon, Kevin'::text)</span><br><span class="line">                       Rows Removed by Filter: <span class="number">657232</span></span><br><span class="line">                       Buffers: shared hit=<span class="number">12501</span></span><br><span class="line">           -&gt;  HashAggregate  (cost=<span class="number">310542.20</span>.<span class="number">.313144</span><span class="number">.22</span> rows=<span class="number">208162</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">29230.371</span>.<span class="number">.29512</span><span class="number">.804</span> rows=<span class="number">1080126</span> loops=<span class="number">6</span>)</span><br><span class="line">                 Group Key: p2.actor, (baconnr_1.nr + <span class="number">1</span>)</span><br><span class="line">                 Buffers: shared hit=<span class="number">72920654</span></span><br><span class="line">                 -&gt;  Nested Loop  (cost=<span class="number">2384.03</span>.<span class="number">.309501</span><span class="number">.39</span> rows=<span class="number">208162</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">13040.311</span>.<span class="number">.25542</span><span class="number">.265</span> rows=<span class="number">10389484</span> loops=<span class="number">6</span>)</span><br><span class="line">                       Buffers: shared hit=<span class="number">72920654</span></span><br><span class="line">                       -&gt;  HashAggregate  (cost=<span class="number">2376.97</span>.<span class="number">.2383</span><span class="number">.06</span> rows=<span class="number">609</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">13039.878</span>.<span class="number">.13290</span><span class="number">.218</span> rows=<span class="number">570802</span> loops=<span class="number">6</span>)</span><br><span class="line">                             Group Key: p1.movie, baconnr_1.nr</span><br><span class="line">                             Buffers: shared hit=<span class="number">30919755</span></span><br><span class="line">                             -&gt;  Nested Loop  (cost=<span class="number">6.01</span>.<span class="number">.2373</span><span class="number">.92</span> rows=<span class="number">609</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">16.277</span>.<span class="number">.9987</span><span class="number">.675</span> rows=<span class="number">8778940</span> loops=<span class="number">6</span>)</span><br><span class="line">                                   Buffers: shared hit=<span class="number">30919755</span></span><br><span class="line">                                   -&gt;  WorkTable Scan on baconnr baconnr_1  (cost=<span class="number">0.00</span>.<span class="number">.0</span><span class="number">.22</span> rows=<span class="number">3</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">16.246</span>.<span class="number">.173</span><span class="number">.118</span> rows=<span class="number">776577</span> loops=<span class="number">6</span>)</span><br><span class="line">                                         Filter: (nr &lt; <span class="number">5</span>)</span><br><span class="line">                                         Rows Removed by Filter: <span class="number">303549</span></span><br><span class="line">                                   -&gt;  Bitmap Heap Scan on playedin p1  (cost=<span class="number">6.01</span>.<span class="number">.789</span><span class="number">.20</span> rows=<span class="number">203</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.006</span>.<span class="number">.0</span><span class="number">.010</span> rows=<span class="number">11</span> loops=<span class="number">4659462</span>)</span><br><span class="line">                                         Recheck Cond: (actor = baconnr_1.id)</span><br><span class="line">                                         Heap Blocks: exact=<span class="number">16784601</span></span><br><span class="line">                                         Buffers: shared hit=<span class="number">30919755</span></span><br><span class="line">                                         -&gt;  Bitmap Index Scan on playedin_actor_idx  (cost=<span class="number">0.00</span>.<span class="number">.5</span><span class="number">.96</span> rows=<span class="number">203</span> <span class="built_in">width</span>=<span class="number">0</span>) (actual time=<span class="number">0.004</span>.<span class="number">.0</span><span class="number">.004</span> rows=<span class="number">11</span> loops=<span class="number">4659462</span>)</span><br><span class="line">                                               Index Cond: (actor = baconnr_1.id)</span><br><span class="line">                                               Buffers: shared hit=<span class="number">14135154</span></span><br><span class="line">                       -&gt;  Bitmap Heap Scan on playedin p2  (cost=<span class="number">7.07</span>.<span class="number">.500</span><span class="number">.01</span> rows=<span class="number">342</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.007</span>.<span class="number">.0</span><span class="number">.018</span> rows=<span class="number">18</span> loops=<span class="number">3424813</span>)</span><br><span class="line">                             Recheck Cond: (movie = p1.movie)</span><br><span class="line">                             Heap Blocks: exact=<span class="number">31546852</span></span><br><span class="line">                             Buffers: shared hit=<span class="number">42000899</span></span><br><span class="line">                             -&gt;  Bitmap Index Scan on playedin_movie_idx  (cost=<span class="number">0.00</span>.<span class="number">.6</span><span class="number">.98</span> rows=<span class="number">342</span> <span class="built_in">width</span>=<span class="number">0</span>) (actual time=<span class="number">0.005</span>.<span class="number">.0</span><span class="number">.005</span> rows=<span class="number">18</span> loops=<span class="number">3424813</span>)</span><br><span class="line">                                   Index Cond: (movie = p1.movie)</span><br><span class="line">                                   Buffers: shared hit=<span class="number">10454047</span></span><br><span class="line">   -&gt;  CTE Scan on baconnr  (cost=<span class="number">0.00</span>.<span class="number">.41632</span><span class="number">.42</span> rows=<span class="number">2081621</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1.379</span>.<span class="number">.179511</span><span class="number">.482</span> rows=<span class="number">6480755</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">72933155</span></span><br><span class="line"> Planning time: <span class="number">0.260</span> ms</span><br><span class="line"> Execution time: <span class="number">181676.112</span> ms</span><br><span class="line">(<span class="number">44</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">181676.868</span> ms (<span class="number">03</span>:<span class="number">01.677</span>)</span><br></pre></td></tr></tbody></table></figure><h2 id="Optional-Buffer-Poolé¢„åŠ è½½"><a href="#Optional-Buffer-Poolé¢„åŠ è½½" class="headerlink" title="Optional: Buffer Poolé¢„åŠ è½½"></a>Optional: Buffer Poolé¢„åŠ è½½</h2><p>è¿™éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œè€Œä¸æ˜¯å¿…é¡»çš„ã€‚è¿™éƒ¨åˆ†çš„å…·ä½“è§£é‡Šè§æˆ‘çš„å¦ä¸€ä¸ªå®éªŒ <a href="https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/">[DBMS][PostgreSQL] ç¼“å­˜åŒºç®¡ç† BufferPool</a></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼ï¼Œåœ¨æ‰§è¡Œæˆ‘ä»¬çš„SQLä¹‹å‰ï¼Œå°†éœ€è¦çš„pageé¢„åŠ è½½è¿›buffer pool:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">imdb=# CREATE EXTENSION pg_prewarm;</span><br><span class="line">CREATE EXTENSION</span><br><span class="line"></span><br><span class="line">imdb=# select * from pg_prewarm('actors');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">      <span class="number">12501</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">71.137</span> ms</span><br><span class="line">imdb=# select * from pg_prewarm('movies');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">       <span class="number">8396</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">88.954</span> ms</span><br><span class="line">imdb=# select * from pg_prewarm('playedin');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">      <span class="number">76623</span></span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Six-Degrees-of-Kevin-Bacon&quot;&gt;&lt;a href=&quot;#Six-Degrees-of-Kevin-Bacon&quot; class=&quot;headerlink&quot; title=&quot;Six Degrees of Kevin Bacon&quot;&gt;&lt;/a&gt;Six Degrees of Kevin Bacon&lt;/h1&gt;&lt;p&gt;å…·ä½“æè¿°è§: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2l4X0RlZ3JlZXNfb2ZfS2V2aW5fQmFjb24=&quot; title=&quot;https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon&quot;&gt;https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Six Degrees of Kevin Baconæˆ–â€Baconâ€™s Lawâ€æ˜¯åŸºäºâ€six degrees of separationå…­åº¦åˆ†ç¦»â€ï¼Œå®ƒå‡å®šåœ°çƒä¸Šä»»ä½•ä¸¤ä¸ªäººç›¸è·å…­ä¸ªæˆ–æ›´å°‘çš„ç†Ÿäººé“¾æ¥ã€‚ æ¯”å¦‚å¯»æ‰¾ä»»æ„æ¼”å‘˜å’Œå¤šäº§æ¼”å‘˜Kevin Baconä¹‹é—´çš„æœ€çŸ­è·¯å¾„ã€‚ å®ƒåŸºäºä¸€ä¸ªå‡è®¾ï¼Œå³å¥½è±åç”µå½±ç•Œçš„ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡å…¶ç”µå½±è§’è‰²åœ¨å…­ä¸ªæ­¥éª¤ä¸­å°†å…¶ä¸Kevin Baconè”ç³»èµ·æ¥ã€‚è¿™ä¸ªæ¦‚å¿µä¹Ÿç±»ä¼¼Fackbookæå‡ºçš„æ¦‚å¿µã€‚å½“ç„¶åœ¨è®¡ç®—æœºæˆ–è€…ç®—æ³•è§’åº¦ï¼Œè¿™æ˜¯ä¸€ä¸ªBFSå¹¿åº¦ä¼˜å…ˆçš„å›¾é—®é¢˜ã€‚é€šè¿‡é—´æ¥çš„6æ­¥å¯èƒ½ä¼šæ¥è§¦éå¸¸å¤šäººï¼Œäº§ç”Ÿéå¸¸å¤§çš„æ•°æ®ã€‚å…·ä½“æˆ‘ä»¬ä¼šåœ¨ä¸‹é¢çš„ç»ƒä¹ ä¸­ä½“éªŒåˆ°ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œå†é™„ä¸ŠKevin Baconçš„ä¸€äº›é“¾æ¥:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸ªäººç½‘ç«™(ä»–ç›´æ¥ç”¨äº†six degreeè¿™ä¸ªæ¦‚å¿µ): &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly93d3cuc2l4ZGVncmVlcy5vcmc=&quot; title=&quot;https://www.sixdegrees.org&quot;&gt;https://www.sixdegrees.org&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;è±†ç“£ä¸»é¡µ: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9tb3ZpZS5kb3ViYW4uY29tL2NlbGVicml0eS8xMDA5MjYwLw==&quot; title=&quot;https://movie.douban.com/celebrity/1009260/&quot;&gt;https://movie.douban.com/celebrity/1009260/&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="DBMS" scheme="https://cakebytheoceanluo.github.io/categories/DBMS/"/>
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/categories/PostgreSQL/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/tags/PostgreSQL/"/>
    
      <category term="Recursion" scheme="https://cakebytheoceanluo.github.io/tags/Recursion/"/>
    
      <category term="Six Degrees of Kevin Bacon" scheme="https://cakebytheoceanluo.github.io/tags/Six-Degrees-of-Kevin-Bacon/"/>
    
      <category term="BFS" scheme="https://cakebytheoceanluo.github.io/tags/BFS/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(5)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/30/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-5/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/30/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-5/</id>
    <published>2020-03-30T11:11:08.000Z</published>
    <updated>2020-04-01T15:02:12.478Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å›¾è®º"><a href="#å›¾è®º" class="headerlink" title="å›¾è®º"></a>å›¾è®º</h1><p>åœ¨è¿™ç¯‡æ–‡ç« é«˜çº§ SQL ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢å›¾è®ºçš„é¢˜ç›®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†(å›¾)éƒ½åœ¨æ–‡ç« ä¸­çš„SQLä¸­ã€‚</p><a id="more"></a><h2 id="æ— ç¯å›¾-æ ‘"><a href="#æ— ç¯å›¾-æ ‘" class="headerlink" title="æ— ç¯å›¾ / æ ‘"></a>æ— ç¯å›¾ / æ ‘</h2><p><img data-src="/images/FDE/chap3/21.jpg" alt="21.jpg"></p><h3 id="æ‰¾çˆ¶èŠ‚ç‚¹"><a href="#æ‰¾çˆ¶èŠ‚ç‚¹" class="headerlink" title="æ‰¾çˆ¶èŠ‚ç‚¹"></a>æ‰¾çˆ¶èŠ‚ç‚¹</h3><ul><li>æœç´¢<code>turtle</code>çš„çˆ¶èŠ‚ç‚¹(æ‰€æœ‰ç›´æ¥å’Œé—´æ¥çˆ¶äº²)ï¼š</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span></span><br><span class="line">     animals (<span class="keyword">id</span>, <span class="keyword">name</span>, <span class="keyword">parent</span>) <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'animal'</span>, <span class="literal">null</span>), (<span class="number">2</span>, <span class="string">'mammal'</span>, <span class="number">1</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="string">'giraffe'</span>, <span class="number">2</span>), (<span class="number">4</span>, <span class="string">'tiger'</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="string">'reptile'</span>, <span class="number">1</span>), (<span class="number">6</span>, <span class="string">'snake'</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">7</span>, <span class="string">'turtle'</span>, <span class="number">5</span>), (<span class="number">8</span>, <span class="string">'grean sea turtle'</span>, <span class="number">7</span>)),</span><br><span class="line">     r <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> * </span><br><span class="line">         <span class="keyword">from</span> animals </span><br><span class="line">         <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'turtle'</span></span><br><span class="line">         <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">         <span class="keyword">select</span> animals.*</span><br><span class="line">         <span class="keyword">from</span> r, animals</span><br><span class="line">         <span class="keyword">where</span> animals.id = r.parent)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> id |  name   | parent </span><br><span class="line">----+---------+--------</span><br><span class="line">  7 | turtle  |      5</span><br><span class="line">  5 | reptile |      1</span><br><span class="line">  1 | animal  |       </span><br><span class="line">(3 rows)</span><br></pre></td></tr></tbody></table></figure><p>&lt;/br&gt;</p><h3 id="æ‰¾å­èŠ‚ç‚¹"><a href="#æ‰¾å­èŠ‚ç‚¹" class="headerlink" title="æ‰¾å­èŠ‚ç‚¹"></a>æ‰¾å­èŠ‚ç‚¹</h3><ul><li>æœç´¢<code>reptile</code>çš„å­èŠ‚ç‚¹(æ‰€æœ‰ç›´æ¥å’Œé—´æ¥å­©å­)ï¼š</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span></span><br><span class="line">     animals (<span class="keyword">id</span>, <span class="keyword">name</span>, <span class="keyword">parent</span>) <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'animal'</span>, <span class="literal">null</span>), (<span class="number">2</span>, <span class="string">'mammal'</span>, <span class="number">1</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="string">'giraffe'</span>, <span class="number">2</span>), (<span class="number">4</span>, <span class="string">'tiger'</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="string">'reptile'</span>, <span class="number">1</span>), (<span class="number">6</span>, <span class="string">'snake'</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">7</span>, <span class="string">'turtle'</span>, <span class="number">5</span>), (<span class="number">8</span>, <span class="string">'grean sea turtle'</span>, <span class="number">7</span>)),</span><br><span class="line">     r <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> *</span><br><span class="line">         <span class="keyword">from</span> animals</span><br><span class="line">         <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'reptile'</span></span><br><span class="line">         <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">         <span class="keyword">select</span> animals.* <span class="comment">-- get the descendants</span></span><br><span class="line">         <span class="keyword">from</span> r, animals</span><br><span class="line">         <span class="keyword">where</span> animals.parent = r.id <span class="comment">-- r is the parent of the new founded animal</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> id |       name       | parent </span><br><span class="line"><span class="comment">----+------------------+--------</span></span><br><span class="line">  5 | reptile          |      1</span><br><span class="line">  7 | turtle           |      5</span><br><span class="line">  6 | snake            |      5</span><br><span class="line">  8 | grean sea turtle |      7</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="å¸¦ç¯å›¾"><a href="#å¸¦ç¯å›¾" class="headerlink" title="å¸¦ç¯å›¾"></a>å¸¦ç¯å›¾</h2><p><img data-src="/images/FDE/chap3/24.jpg" alt="24.jpg"></p><ul><li>æœç´¢<code>Alice</code>çš„æ‰€æœ‰æœ‹å‹(å³ä»<code>Alice</code>èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹):</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span></span><br><span class="line">     friends (a, b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'Alice'</span>, <span class="string">'Bob'</span>), (<span class="string">'Alice'</span>, <span class="string">'Carol'</span>),</span><br><span class="line">           (<span class="string">'Carol'</span>, <span class="string">'Grace'</span>), (<span class="string">'Carol'</span>, <span class="string">'Chuck'</span>),</span><br><span class="line">           (<span class="string">'Chuck'</span>, <span class="string">'Grace'</span>), (<span class="string">'Chuck'</span>,<span class="string">'Anne'</span>),</span><br><span class="line">           (<span class="string">'Bob'</span>,<span class="string">'Dan'</span>),(<span class="string">'Dan'</span>,<span class="string">'Anne'</span>),(<span class="string">'Eve'</span>,<span class="string">'Adam'</span>)</span><br><span class="line">           ),</span><br><span class="line">     friendship (<span class="keyword">name</span>, friend) <span class="keyword">as</span> <span class="comment">-- friendship is symmetric, bi-directional graph</span></span><br><span class="line">    (<span class="keyword">select</span> a, b</span><br><span class="line">    <span class="keyword">from</span> friends</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> b, a</span><br><span class="line">    <span class="keyword">from</span> friends),</span><br><span class="line">     r <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Alice'</span> <span class="keyword">as</span> <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> friendship.name</span><br><span class="line">    <span class="keyword">from</span> r, friendship</span><br><span class="line">    <span class="keyword">where</span> r.name = friendship.friend)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> name  </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line"> Alice</span><br><span class="line"> Bob</span><br><span class="line"> Carol</span><br><span class="line"> Grace</span><br><span class="line"> Chuck</span><br><span class="line"> Dan</span><br><span class="line"> Anne</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ æˆ‘ä»¬åœ¨é«˜çº§SQL-é€’å½’éƒ¨åˆ†å¯¹å°è§„æ¨¡çš„æ ‘å’Œå›¾è¿›è¡Œäº†éå†ã€‚æˆ‘ä»¬ä¸»è¦ç ”ç©¶èŠ‚ç‚¹çš„çˆ¶å­å…³ç³»å’ŒèŠ‚ç‚¹é—´çš„å¯åˆ°è¾¾æ€§é—®é¢˜ã€‚ä½¿ç”¨<code>with recursive</code>å­å¥ï¼Œæ­é…å¯¹åº”çš„<code>union all</code>æˆ–<code>union</code>è®©é€’å½’é—®é¢˜ä¸€é€šç™¾é€šã€‚</p><p>ä¸‹ä¸€æ¬¡æˆ‘ä»¬ä¼šç ”ç©¶ä¸€ä¸ªçœŸå®æ•°æ®é›†ä¸­çš„é—®é¢˜ï¼Œä¾æ—§æ˜¯<em>æœ‹å‹</em>çš„å›¾å…³ç³»ï¼Œä½†æ˜¯æ•°æ®é›†å¾ˆå¤§ï¼ŒåŒæ—¶è®¡ç®—é‡ä¹Ÿéå¸¸å·¨å¤§ã€‚</p><p>å¼•ç”¨: </p><p>è¯¾ä»¶: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å›¾è®º&quot;&gt;&lt;a href=&quot;#å›¾è®º&quot; class=&quot;headerlink&quot; title=&quot;å›¾è®º&quot;&gt;&lt;/a&gt;å›¾è®º&lt;/h1&gt;&lt;p&gt;åœ¨è¿™ç¯‡æ–‡ç« é«˜çº§ SQL ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢å›¾è®ºçš„é¢˜ç›®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†(å›¾)éƒ½åœ¨æ–‡ç« ä¸­çš„SQLä¸­ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/categories/Graph/"/>
    
      <category term="TUM-IN2326" scheme="https://cakebytheoceanluo.github.io/categories/TUM-IN2326/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Recursion" scheme="https://cakebytheoceanluo.github.io/tags/Recursion/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/tags/Graph/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(4)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/27/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-4/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/27/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-4/</id>
    <published>2020-03-27T17:57:47.000Z</published>
    <updated>2020-03-27T17:59:07.661Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å›¾è®º"><a href="#å›¾è®º" class="headerlink" title="å›¾è®º"></a>å›¾è®º</h1><p>åœ¨è¿™ç¯‡æ–‡ç« é«˜çº§ SQL ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢å›¾è®ºçš„é¢˜ç›®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†(å›¾)éƒ½åœ¨æ–‡ç« ä¸­çš„SQLä¸­ã€‚</p><a id="more"></a><h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p><img data-src="/images/SQL/graph1.png" alt="graph1.png"></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> singleDirection;</span><br></pre></td></tr></tbody></table></figure><h3 id="å¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity"><a href="#å¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity" class="headerlink" title="å¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):"></a>å¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">    ), undirectedGraph <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> b, a</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">    ), transitive_closure (a, b) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph</span><br><span class="line">        <span class="keyword">union</span></span><br><span class="line">        <span class="keyword">select</span> a.a, b.b</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph b, transitive_closure a</span><br><span class="line">        <span class="keyword">where</span> a.b = b.a</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> transitive_closure</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a, b;</span><br></pre></td></tr></tbody></table></figure><h3 id="6å’Œ1æ˜¯è”é€š-connected-reachable-çš„å—"><a href="#6å’Œ1æ˜¯è”é€š-connected-reachable-çš„å—" class="headerlink" title="6å’Œ1æ˜¯è”é€š(connected, reachable)çš„å—?"></a>6å’Œ1æ˜¯è”é€š(connected, reachable)çš„å—?</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">    ), undirectedGraph <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> b, a</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">    ), transitive_closure (a, b) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph</span><br><span class="line">        <span class="keyword">union</span></span><br><span class="line">        <span class="keyword">select</span> a.a, b.b</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph b, transitive_closure a</span><br><span class="line">        <span class="keyword">where</span> a.b = b.a</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> transitive_closure </span><br><span class="line"><span class="keyword">where</span> a = <span class="number">6</span> <span class="keyword">and</span> b = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><h3 id="æ±‚6å’Œ1çš„æœ€çŸ­è·ç¦»"><a href="#æ±‚6å’Œ1çš„æœ€çŸ­è·ç¦»" class="headerlink" title="æ±‚6å’Œ1çš„æœ€çŸ­è·ç¦»?"></a>æ±‚6å’Œ1çš„æœ€çŸ­è·ç¦»?</h3><p>è¿™é‡Œæˆ‘ä»¬åœ¨<code>transitive_closure</code>ä¸­ä½¿ç”¨äº†<code>union all</code>ï¼Œä¸ºäº†é¿å…å¯¹åº”å‡ºç°çš„ä¸ç»ˆæ­¢çš„é€’å½’ï¼Œæˆ‘ä»¬å¿…é¡»åŠ ä¸Šå¯¹åº”çš„æ¡ä»¶<code>dist &lt;= 4</code>ã€‚å¦å¤–è¿™ä¸ª4æ˜¯æˆ‘ä»¬ç›®æµ‹å‡ºæ¥çš„ä¸€ä¸ªå‚æ•°ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ›´å¤§æ›´æ™®éçš„æ•°å­—ï¼Œæ¯”å¦‚å›¾ä¸­è¾¹çš„æ€»æ•°ï¼Œè¿™æ ·ä¹Ÿèƒ½è¯•é€’å½’ç»ˆæ­¢ã€‚</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">    ), undirectedGraph <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> b, a</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">    ), transitive_closure (a, b, dist) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> a, b, <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> undirectedGraph</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> a.a, b.b, dist + <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> undirectedGraph b, transitive_closure a</span><br><span class="line">        <span class="keyword">where</span> a.b = b.a <span class="keyword">and</span> dist &lt;= <span class="number">4</span> <span class="comment">-- æˆ–è€…ã€€dist &lt;= 9ï¼Œå› ä¸ºè¿™ä¸ªå›¾é‡Œé¢ä¸€å…±9æ¡è¾¹</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">min</span>(dist)</span><br><span class="line"><span class="keyword">from</span> transitive_closure</span><br><span class="line"><span class="keyword">where</span> a = <span class="number">6</span> <span class="keyword">and</span> b = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p><br><br><br><br><br></p><h3 id="ä¾‹å­3"><a href="#ä¾‹å­3" class="headerlink" title="ä¾‹å­3"></a>ä¾‹å­3</h3><p>SQL Standardä¸­æ˜¯è¿™æ ·å®šä¹‰æ¥<code>union all</code>çš„é€’å½’è¯­å¥çš„:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">workingTable = evaluateNonRecursive()</span><br><span class="line">output workingTable</span><br><span class="line"><span class="keyword">while</span> workingTable <span class="keyword">is</span> <span class="keyword">not</span> empty:</span><br><span class="line">  workingTable = evaluateRecursive(workingTable)</span><br><span class="line">  output workingTable</span><br></pre></td></tr></tbody></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªè¡¨æ ¼ï¼Œä»£è¡¨ä¸€ä¸ªå›¾:</p><div class="table-container"><table><thead><tr><th>From</th><th>To</th></tr></thead><tbody><tr><td>a</td><td>b</td></tr><tr><td>b</td><td>c</td></tr><tr><td>b</td><td>d</td></tr><tr><td>c</td><td>e</td></tr><tr><td>d</td><td>e</td></tr></tbody></table></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> edges (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">   <span class="keyword">values</span></span><br><span class="line">          (<span class="string">'a'</span>, <span class="string">'b'</span>), (<span class="string">'b'</span>, <span class="string">'c'</span>), (<span class="string">'b'</span>, <span class="string">'d'</span>),</span><br><span class="line">          (<span class="string">'c'</span>, <span class="string">'e'</span>), (<span class="string">'d'</span>, <span class="string">'e'</span>)</span><br><span class="line">), discovered (node) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> edges.to_</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    edges, discovered</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">    discovered.node = edges.from_)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> discovered;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> node </span><br><span class="line"><span class="comment">------</span></span><br><span class="line"> a</span><br><span class="line"> b</span><br><span class="line"> d</span><br><span class="line"> c</span><br><span class="line"> e</span><br><span class="line"> e</span><br><span class="line">(6 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h4 id="æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹"><a href="#æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹" class="headerlink" title="æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹"></a>æ±‚ä»<code>a</code>å¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹</h4><p>åº”ç”¨SQL Standardä¸­çš„Working Tableè¡¨è¾¾:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> edges (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">   <span class="keyword">values</span></span><br><span class="line">          (<span class="string">'a'</span>, <span class="string">'b'</span>), (<span class="string">'b'</span>, <span class="string">'c'</span>), (<span class="string">'b'</span>, <span class="string">'d'</span>),</span><br><span class="line">          (<span class="string">'c'</span>, <span class="string">'e'</span>), (<span class="string">'d'</span>, <span class="string">'e'</span>)</span><br><span class="line">), discovered (node, step) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="string">'a'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> edges.to_, discovered.step + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    edges, discovered</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">    discovered.node = edges.from_)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> discovered;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> node | step </span><br><span class="line"><span class="comment">------+------</span></span><br><span class="line"> a    |    0</span><br><span class="line"> b    |    1</span><br><span class="line"> d    |    2</span><br><span class="line"> c    |    2</span><br><span class="line"> e    |    3</span><br><span class="line"> e    |    3</span><br><span class="line">(6 rows)</span><br></pre></td></tr></tbody></table></figure><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">step | WorkingTable</span><br><span class="line">init | {a}</span><br><span class="line">1    | {b}</span><br><span class="line">2    | {c, d}</span><br><span class="line">3    | {e, e}</span><br><span class="line">4    | {}</span><br></pre></td></tr></tbody></table></figure><p><br></p><h4 id="å›¾è¢«æ›´æ”¹-å†æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹"><a href="#å›¾è¢«æ›´æ”¹-å†æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹" class="headerlink" title="å›¾è¢«æ›´æ”¹, å†æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹"></a>å›¾è¢«æ›´æ”¹, å†æ±‚ä»<code>a</code>å¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹</h4><p>å›¾ä¸­æˆ‘ä»¬å¤šåŠ äº†ä¸€ä¸ª<code>('c', 'b')</code>çš„è¾¹ã€‚åº”ç”¨SQL Standardä¸­çš„<code>WorkingTable</code>è¡¨è¾¾:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> edges (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">   <span class="keyword">values</span></span><br><span class="line">          (<span class="string">'a'</span>, <span class="string">'b'</span>), (<span class="string">'b'</span>, <span class="string">'c'</span>), (<span class="string">'b'</span>, <span class="string">'d'</span>),</span><br><span class="line">          (<span class="string">'c'</span>, <span class="string">'e'</span>), (<span class="string">'d'</span>, <span class="string">'e'</span>), (<span class="string">'c'</span>, <span class="string">'b'</span>)</span><br><span class="line">), discovered (node, step) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="string">'a'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> edges.to_, discovered.step + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> edges, discovered</span><br><span class="line">    <span class="keyword">where</span> discovered.node = edges.from_ <span class="keyword">and</span> step &lt; <span class="number">6</span></span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> discovered;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> node | step </span><br><span class="line"><span class="comment">------+------</span></span><br><span class="line"> a    |    0</span><br><span class="line"> b    |    1</span><br><span class="line"> c    |    2</span><br><span class="line"> d    |    2</span><br><span class="line"> e    |    3</span><br><span class="line"> e    |    3</span><br><span class="line"> b    |    3</span><br><span class="line"> c    |    4</span><br><span class="line"> d    |    4</span><br><span class="line"> e    |    5</span><br><span class="line"> e    |    5</span><br><span class="line"> b    |    5</span><br><span class="line"> c    |    6</span><br><span class="line"> d    |    6</span><br><span class="line">(14 rows)</span><br></pre></td></tr></tbody></table></figure><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">step | WorkingTable</span><br><span class="line">init | {a}</span><br><span class="line">1    | {b}</span><br><span class="line">2    | {c, d}</span><br><span class="line">3    | {e, e, b}</span><br><span class="line">4    | {c, d}</span><br><span class="line">5    | {e, e, b}</span><br><span class="line">6    | {c, d}</span><br></pre></td></tr></tbody></table></figure><p>ç”±äºè¿™æ¡å¤šåŠ çš„è¾¹ï¼Œè®©<code>union all</code>å¯¹åº”çš„å¾ªç¯ä¸€ç›´ä¸ç»ˆæ­¢ï¼Œå³<code>WorkingTable</code>ä¸€ç›´ä¸ä¸ºç©ºã€‚æ‰€æœ‰æˆ‘åœ¨ä¸Šé¢å¤šåŠ äº†<code>step &lt; 6</code>è¿™ä¸ªæ¡ä»¶ï¼Œå¼ºåˆ¶ï¼–æ­¥ä»¥åç»ˆæ­¢ã€‚å½“ç„¶å¦‚æœæ¢ç”¨<code>union</code>å¯ä»¥è®©å®ƒç»ˆæ­¢ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å›¾è®º&quot;&gt;&lt;a href=&quot;#å›¾è®º&quot; class=&quot;headerlink&quot; title=&quot;å›¾è®º&quot;&gt;&lt;/a&gt;å›¾è®º&lt;/h1&gt;&lt;p&gt;åœ¨è¿™ç¯‡æ–‡ç« é«˜çº§ SQL ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢å›¾è®ºçš„é¢˜ç›®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†(å›¾)éƒ½åœ¨æ–‡ç« ä¸­çš„SQLä¸­ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/categories/Graph/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Recursion" scheme="https://cakebytheoceanluo.github.io/tags/Recursion/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/tags/Graph/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(3)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/26/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-3/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/26/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-3/</id>
    <published>2020-03-26T13:49:58.000Z</published>
    <updated>2020-03-26T13:54:36.347Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å›¾è®º"><a href="#å›¾è®º" class="headerlink" title="å›¾è®º"></a>å›¾è®º</h1><p>åœ¨è¿™ç¯‡æ–‡ç« é«˜çº§ SQL ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢å›¾è®ºçš„é¢˜ç›®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†(å›¾)éƒ½åœ¨æ–‡ç« ä¸­çš„SQLä¸­ã€‚</p><a id="more"></a><h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p>ä¸€ä¸ªå›¾è®ºçš„ä¾‹å­ï¼š</p><p><img data-src="/images/SQL/dag.png" alt="dag.png"></p><p><strong>å¦‚æœæˆ‘ä»¬æ— è§†å›¾ä¸­çš„ç®­å¤´</strong>ï¼Œé‚£ä¹ˆè¿™ä¸ªå›¾æ˜¯ä¸€ä¸ª<strong>æœ‰å‘æ— ç¯å›¾(DAG, directed acyclic graph)</strong>ã€‚</p><p><br></p><h3 id="è§†ä½œæœ‰å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity"><a href="#è§†ä½œæœ‰å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity" class="headerlink" title="è§†ä½œæœ‰å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):"></a>è§†ä½œæœ‰å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), transitive_closure (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> transitive_closure c, graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> transitive_closure</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure><p>è¾“å‡º:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | b</span><br><span class="line"> a     | c</span><br><span class="line"> a     | d</span><br><span class="line"> a     | e</span><br><span class="line"> b     | c</span><br><span class="line"> b     | d</span><br><span class="line"> b     | e</span><br><span class="line"> c     | d</span><br><span class="line"> f     | c</span><br><span class="line"> f     | d</span><br><span class="line"> x     | y</span><br><span class="line">(11 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h3 id="è¡¨è¾¾æˆæ— å‘å›¾ï¼š"><a href="#è¡¨è¾¾æˆæ— å‘å›¾ï¼š" class="headerlink" title="è¡¨è¾¾æˆæ— å‘å›¾ï¼š"></a>è¡¨è¾¾æˆæ— å‘å›¾ï¼š</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- æ— å‘å›¾</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> un_dir_graph</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure><p>è¾“å‡º:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | b</span><br><span class="line"> b     | a</span><br><span class="line"> b     | c</span><br><span class="line"> b     | e</span><br><span class="line"> c     | b</span><br><span class="line"> c     | d</span><br><span class="line"> c     | f</span><br><span class="line"> d     | c</span><br><span class="line"> e     | b</span><br><span class="line"> f     | c</span><br><span class="line"> x     | y</span><br><span class="line"> y     | x</span><br><span class="line">(12 rows)</span><br></pre></td></tr></tbody></table></figure><p>å¾ˆå®¹æ˜“å‘ç°<code>un_dir_graph</code>æ˜¯ä¸€ä¸ªå¯¹ç§°çš„å…³ç³»(symmetric relation): </p><script type="math/tex; mode=display">\exists (a , b) \in R \Rightarrow (b, a) \in R</script><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>un_dir_graph</code>é€’å½’çš„æ—¶å€™ï¼Œã€€ç”¨<code>UNION ALL</code>æ˜¯è‚¯å®šä¸ä¼šç»ˆæ­¢çš„ï¼Œå› ä¸º<code>UNION ALL</code>é‡‡ç”¨åŒ…è¯­ä¹‰(Bag Semantics)ï¼Œå®ƒä¸ä¼šæ¶ˆé™¤é‡å¤(duplicates)ã€‚<br>è€Œ<code>UNION</code>é‡‡ç”¨é›†åˆè¯­ä¹‰(Set Semantics)ï¼Œå®ƒä¼šæ¶ˆé™¤é‡å¤ã€‚</p><p><br></p><h3 id="è§†ä½œæ— å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity"><a href="#è§†ä½œæ— å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity" class="headerlink" title="è§†ä½œæ— å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):"></a>è§†ä½œæ— å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- æ— å‘å›¾</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">), clo (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> un_dir_graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> clo c, un_dir_graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> clo</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure><p>è¾“å‡º:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | a</span><br><span class="line"> a     | b</span><br><span class="line"> a     | c</span><br><span class="line"> a     | d</span><br><span class="line"> a     | e</span><br><span class="line"> a     | f</span><br><span class="line"> b     | a</span><br><span class="line"> b     | b</span><br><span class="line"> b     | c</span><br><span class="line"> b     | d</span><br><span class="line"> b     | e</span><br><span class="line"> b     | f</span><br><span class="line"> c     | a</span><br><span class="line"> c     | b</span><br><span class="line"> c     | c</span><br><span class="line"> c     | d</span><br><span class="line"> c     | e</span><br><span class="line"> c     | f</span><br><span class="line"> d     | a</span><br><span class="line"> d     | b</span><br><span class="line"> d     | c</span><br><span class="line"> d     | d</span><br><span class="line"> d     | e</span><br><span class="line"> d     | f</span><br><span class="line"> e     | a</span><br><span class="line"> e     | b</span><br><span class="line"> e     | c</span><br><span class="line"> e     | d</span><br><span class="line"> e     | e</span><br><span class="line"> e     | f</span><br><span class="line"> f     | a</span><br><span class="line"> f     | b</span><br><span class="line"> f     | c</span><br><span class="line"> f     | d</span><br><span class="line"> f     | e</span><br><span class="line"> f     | f</span><br><span class="line"> x     | x</span><br><span class="line"> x     | y</span><br><span class="line"> y     | x</span><br><span class="line"> y     | y</span><br><span class="line">(40 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>å¦ä¸€ç§è§£æ³•:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- æ— å‘å›¾</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">), closure (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> un_dir_graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> closure c, graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">), connected_graph (from_ ,to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> to_ , from_</span><br><span class="line">    <span class="keyword">from</span> closure)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_ , cg.to_</span><br><span class="line">    <span class="keyword">from</span> closure c, connected_graph cg</span><br><span class="line">    <span class="keyword">where</span> c.to_ = cg.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> connected_graph</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>è¿™é‡Œå¿…é¡»è§£é‡Šä¸€ä¸‹<code>closure</code>æ‰€å½¢æˆçš„è¡¨æ ¼ï¼Œå®ƒå³ä¸æ˜¯å¯¹åº”æœ‰å‘å›¾çš„ä¼ é€’é—­åŒ…(transitive_closure)ï¼Œä¹Ÿä¸æ˜¯å¯¹åº”æ— å‘å›¾çš„ä¼ é€’é—­åŒ…(transitive_closure)ã€‚å®ƒæ˜¯æˆ‘ä»¬æ±‚æ— å‘å›¾ä¼ é€’é—­åŒ…çš„ä¸€ä¸ªä¸­é—´æ­¥éª¤, å®ƒä»£è¡¨çš„è·¯å¾„æ˜¯:</p><ul><li>ç¬¬ä¸€æ­¥æ¥è‡ªäºæ— å‘å›¾</li><li>å¦‚æœæœ‰åç»­çš„æ­¥éª¤ï¼Œé‚£ä¹ˆåç»­çš„æ­¥éª¤æ¥è‡ªäºæœ‰å‘å›¾ã€‚</li></ul><p>ä¸‹é¢æ˜¯å®ƒçš„å†…å®¹ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | b</span><br><span class="line"> a     | c</span><br><span class="line"> a     | d</span><br><span class="line"> a     | e</span><br><span class="line"> b     | a</span><br><span class="line"> b     | b</span><br><span class="line"> b     | c</span><br><span class="line"> b     | d</span><br><span class="line"> b     | e</span><br><span class="line"> c     | b</span><br><span class="line"> c     | c</span><br><span class="line"> c     | d</span><br><span class="line"> c     | e</span><br><span class="line"> c     | f</span><br><span class="line"> d     | c</span><br><span class="line"> d     | d</span><br><span class="line"> e     | b</span><br><span class="line"> e     | c</span><br><span class="line"> e     | d</span><br><span class="line"> e     | e</span><br><span class="line"> f     | c</span><br><span class="line"> f     | d</span><br><span class="line"> x     | y</span><br><span class="line"> y     | x</span><br><span class="line"> y     | y</span><br><span class="line">(25 rows)</span><br></pre></td></tr></tbody></table></figure><ul><li><code>(b, b)</code>åœ¨é‡Œé¢ï¼Œå› ä¸ºç¬¬ä¸€æ­¥<code>(b, a)</code>å±äºæ— å‘å›¾ï¼Œç¬¬äºŒæ­¥<code>(a, b)</code>å±äºæœ‰å‘å›¾ã€‚</li><li><code>(c, a)</code>ä¸åœ¨é‡Œé¢ï¼Œå› ä¸ºå³ä½¿ç¬¬ä¸€æ­¥<code>(c, b)</code>å±äºæ— å‘å›¾ï¼Œä½†æ˜¯ç¬¬äºŒæ­¥<code>(b, a)</code>ä¸å±äºæœ‰å‘å›¾ã€‚</li></ul><p><br></p><h3 id="æ±‚ä»bä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š"><a href="#æ±‚ä»bä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š" class="headerlink" title="æ±‚ä»bä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š"></a>æ±‚ä»<code>b</code>ä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- æ— å‘å›¾</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">), clo (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> un_dir_graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> clo c, un_dir_graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> clo</span><br><span class="line"><span class="keyword">where</span> from_ = <span class="string">'b'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> to_;</span><br></pre></td></tr></tbody></table></figure><p>å½“ç„¶çœ‹å›¾çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°<code>b</code>å¯ä»¥åˆ°è¾¾ä¸Šé¢é‚£ä¸ªè¿é€šå›¾ä¸­æ‰€æœ‰çš„6ä¸ªèŠ‚ç‚¹ã€‚</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å›¾è®º&quot;&gt;&lt;a href=&quot;#å›¾è®º&quot; class=&quot;headerlink&quot; title=&quot;å›¾è®º&quot;&gt;&lt;/a&gt;å›¾è®º&lt;/h1&gt;&lt;p&gt;åœ¨è¿™ç¯‡æ–‡ç« é«˜çº§ SQL ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢å›¾è®ºçš„é¢˜ç›®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†(å›¾)éƒ½åœ¨æ–‡ç« ä¸­çš„SQLä¸­ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/categories/Graph/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Recursion" scheme="https://cakebytheoceanluo.github.io/tags/Recursion/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/tags/Graph/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-å»å…³è”(2)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/25/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-2/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/25/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-2/</id>
    <published>2020-03-25T11:09:41.000Z</published>
    <updated>2020-03-25T11:10:34.069Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« ç»§<a href="https://cakebytheoceanluo.github.io/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/">[SQL]é«˜çº§SQL-å»å…³è”(1)</a>åï¼Œç»§ç»­å¯¹å»å…³è”è¿™ä¸ªä¸»é¢˜è¿›è¡Œç»ƒä¹ ã€‚</p><a id="more"></a><h1 id="TPC-Hä¾‹å­ä¸€"><a href="#TPC-Hä¾‹å­ä¸€" class="headerlink" title="TPC-Hä¾‹å­ä¸€"></a>TPC-Hä¾‹å­ä¸€</h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">l_extendedprice &gt; (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(l2.l_extendedprice)</span><br><span class="line">    <span class="keyword">from</span> lineitem l2</span><br><span class="line">    <span class="keyword">where</span> l2.l_orderkey = l1.l_orderkey</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p><code>l1.l_orderkey</code>æ˜¯è¿™ä¸ªå­æŸ¥è¯¢(Sub-Query)ä¸­æ¥è‡ªå¤–æŸ¥è¯¢çš„å­—æ®µï¼Œä¹Ÿå°±æ˜¯å®ƒé€ æˆäº†è¿™ä¸ªä¾èµ–(dependency)ã€‚</p><p>å¾ˆå®¹æ˜“å¯ä»¥å‘ç°ï¼š</p><ul><li>å¯¹æ¯ä¸€ä¸ªå­æŸ¥è¯¢çš„<code>lineitem l2</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>l2.l_orderkey</code>å­—æ®µå€¼ä¾èµ–äºå¤–ç•Œ<code>lineitem l1</code>çš„å¯¹åº”<code>l1.l_orderkey</code>å­—æ®µå€¼ã€‚</li><li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>l2.l_orderkey = l1.l_orderkey</code></li><li>$D$æ˜¯<code>l1.l_orderkey</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚<strong>è¿™é‡Œè¿™ä¸ªå¤–ä¾èµ–æ¡ä»¶æ²¡æœ‰æ„ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨<code>lineitem</code>è¡¨æ ¼ä¸­è®¡ç®—å¹³å‡å€¼, è€Œçœå»regular joinè·å¾—é«˜æ€§èƒ½ã€‚</strong></p><h2 id="å»é™¤joinçš„ç»“æœ"><a href="#å»é™¤joinçš„ç»“æœ" class="headerlink" title="å»é™¤joinçš„ç»“æœ"></a>å»é™¤joinçš„ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l,</span><br><span class="line">     (<span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice) <span class="keyword">as</span> avgPrice, </span><br><span class="line">             l_orderkey</span><br><span class="line">      <span class="keyword">from</span> lineitem</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> l_orderkey) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_extendedprice &gt; precomputed.avgPrice <span class="keyword">and</span> </span><br><span class="line">    l.l_orderkey = precomputed.l_orderkey;</span><br></pre></td></tr></tbody></table></figure><p>æˆ–</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice) <span class="keyword">as</span> avgPrice, </span><br><span class="line">           l_orderkey</span><br><span class="line">    <span class="keyword">from</span> lineitem</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> l_orderkey)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l,</span><br><span class="line">     precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_extendedprice &gt; precomputed.avgPrice</span><br><span class="line">    <span class="keyword">and</span> l.l_orderkey = precomputed.l_orderkey;</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="TPC-Hä¾‹å­äºŒ"><a href="#TPC-Hä¾‹å­äºŒ" class="headerlink" title="TPC-Hä¾‹å­äºŒ"></a>TPC-Hä¾‹å­äºŒ</h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        orders o1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        o_totalprice &lt; (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">                <span class="keyword">avg</span>(o_totalprice)</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">                orders o2</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">                o2.o_shippriority = o1.o_shippriority <span class="keyword">or</span></span><br><span class="line">                o2.o_orderstatus = o1.o_orderstatus)</span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å¾ˆå®¹æ˜“å¯ä»¥å‘ç°ï¼š</p><ul><li>å¯¹æ¯ä¸€ä¸ª<code>orders o2</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>o2.o_shippriority</code>å’Œ<code>o2.o_orderstatus</code>å­—æ®µå€¼ä¾èµ–å¤–ç•Œ<code>order o1</code>çš„å¯¹åº”å­—æ®µå€¼ã€‚</li><li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>o2.o_shippriority = o1.o_shippriority or o2.o_orderstatus = o1.o_orderstatus</code></li><li>$D$æ˜¯<code>o1.o_shippriority, o1.o_orderstatus</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚</p><h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        orders o1,</span><br><span class="line">        (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">                <span class="keyword">avg</span>(o2.o_totalprice), d.o_shippriority, d.o_orderstatus</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">                orders o2, </span><br><span class="line">                (<span class="keyword">select</span> <span class="keyword">distinct</span> o_shippriority , o_orderstatus <span class="keyword">from</span> orders) d</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">                o2.o_shippriority = d.o_shippriority <span class="keyword">or</span></span><br><span class="line">                o2.o_orderstatus = d.o_orderstatus</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> d.o_shippriority, d.o_orderstatus</span><br><span class="line">        ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        o_totalprice &lt; precomputed.avg <span class="keyword">and</span></span><br><span class="line">        precomputed.o_shippriority = o1.o_shippriority <span class="keyword">and</span></span><br><span class="line">        precomputed.o_orderstatus = o1.o_orderstatus</span><br></pre></td></tr></tbody></table></figure><p>æˆ–</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">            <span class="keyword">avg</span>(o2.o_totalprice), d.o_shippriority, d.o_orderstatus</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">            orders o2, </span><br><span class="line">            (<span class="keyword">select</span> <span class="keyword">distinct</span> o_shippriority , o_orderstatus <span class="keyword">from</span> orders) d</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">            o2.o_shippriority = d.o_shippriority <span class="keyword">or</span></span><br><span class="line">            o2.o_orderstatus = d.o_orderstatus</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> d.o_shippriority, d.o_orderstatus</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        orders o1, precomputed</span><br><span class="line">        </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        o_totalprice &lt; precomputed.avg <span class="keyword">and</span></span><br><span class="line">        precomputed.o_shippriority = o1.o_shippriority <span class="keyword">and</span></span><br><span class="line">        precomputed.o_orderstatus = o1.o_orderstatus</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="TPC-Hä¾‹å­ä¸‰"><a href="#TPC-Hä¾‹å­ä¸‰" class="headerlink" title="TPC-Hä¾‹å­ä¸‰"></a>TPC-Hä¾‹å­ä¸‰</h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span> </span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span><span class="keyword">and</span> </span><br><span class="line">    <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            *</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            lineitem</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            l_orderkey = o_orderkey <span class="keyword">and</span> </span><br><span class="line">            l_commitdate &lt; l_receiptdate</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å¾ˆå®¹æ˜“å¯ä»¥å‘ç°ï¼š</p><ul><li>å¯¹æ¯ä¸€ä¸ª<code>lineitem</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>l_orderkey</code>å­—æ®µå€¼ä¾èµ–å¤–ç•Œ<code>order</code>çš„å¯¹åº”å­—æ®µå€¼ã€‚</li><li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>l_orderkey = o_orderkey</code></li><li>$D$æ˜¯<code>order.o_orderkey</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚</p><h2 id="ç»“æœ-1"><a href="#ç»“æœ-1" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders,(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem,</span><br><span class="line">        (<span class="keyword">select</span> <span class="keyword">distinct</span> o_orderkey <span class="keyword">from</span> orders) <span class="keyword">as</span> o</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_orderkey = o_orderkey <span class="keyword">and</span> </span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        o_orderkey</span><br><span class="line">    ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.o_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><p>æˆ–</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem,</span><br><span class="line">        (<span class="keyword">select</span> <span class="keyword">distinct</span> o_orderkey <span class="keyword">from</span> orders) <span class="keyword">as</span> o</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_orderkey = o_orderkey <span class="keyword">and</span> </span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        o_orderkey</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders,</span><br><span class="line">    precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.o_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><h2 id="å»é™¤joinçš„ç»“æœ-1"><a href="#å»é™¤joinçš„ç»“æœ-1" class="headerlink" title="ã€€å»é™¤joinçš„ç»“æœ"></a>ã€€å»é™¤joinçš„ç»“æœ</h2><p><strong>è¿™é‡Œè¿™ä¸ªå¤–ä¾èµ–æ¡ä»¶æ²¡æœ‰æ„ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨<code>lineitem</code>è¡¨æ ¼ä¸­è·å¾—<code>l_orderkey</code>(å®ƒæ˜¯<code>o_orderkey</code>çš„å¤–é”®), è€Œçœå»regular joinè·å¾—é«˜æ€§èƒ½ã€‚</strong></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders,(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        l_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        l_orderkey</span><br><span class="line">    ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.l_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><p>æˆ–</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        l_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        l_orderkey</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders, precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.l_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="è®ºæ–‡ä¸­çš„Q2"><a href="#è®ºæ–‡ä¸­çš„Q2" class="headerlink" title="è®ºæ–‡ä¸­çš„Q2"></a>è®ºæ–‡ä¸­çš„Q2</h1><p>è¿™ä¸ªQ2ä¸å¯¹åº”ä»»ä½•æˆ‘å·²çŸ¥çš„æ•°æ®é›†ï¼Œåªæ˜¯åœ¨è®ºæ–‡ä¸­é€»è¾‘æ€§åœ°è¢«æå‡ºã€‚</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name , e.course</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    students s,</span><br><span class="line">    exams e</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    s.id = e.sid <span class="keyword">and</span></span><br><span class="line">    (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>)</span><br><span class="line"><span class="keyword">and</span> e.grade &gt;= (</span><br><span class="line">    <span class="comment">-- one grade worse</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        <span class="keyword">avg</span> (e2.grade) + <span class="number">1</span></span><br><span class="line">    <span class="comment">-- than the average grade</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        exams e2</span><br><span class="line">    <span class="comment">-- of exams taken by</span></span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        s.id = e2.sid <span class="keyword">or</span></span><br><span class="line">        <span class="comment">-- him / her or taken by elder peers</span></span><br><span class="line">        (e2.curriculum = s.major <span class="keyword">and</span> s.year &gt; e2.date))</span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å¾ˆå®¹æ˜“å¯ä»¥å‘ç°ï¼š</p><ul><li>å¯¹æ¯ä¸€ä¸ª<code>exams e2</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>e2.sid, e2.curriculum, e2.data</code>å­—æ®µå€¼ä¾èµ–å¤–ç•Œ<code>student s</code>çš„å¯¹åº”å­—æ®µå€¼ã€‚</li><li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>s.id = e2.sid or (e2.curriculum = s.major and s.year &gt; e2.date))</code></li><li>$D$æ˜¯<code>s.id, s.major, s.year</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚</p><h2 id="ç»“æœ-2"><a href="#ç»“æœ-2" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    students s,</span><br><span class="line">    exams e, (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> students s, exams e</span><br><span class="line">        <span class="keyword">where</span> s.id = e.sid <span class="keyword">and</span> (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>)</span><br><span class="line">     ) <span class="keyword">as</span> l, (</span><br><span class="line">         <span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">year</span>, major </span><br><span class="line">         <span class="keyword">from</span> l</span><br><span class="line">     ) <span class="keyword">as</span> d, (</span><br><span class="line">         <span class="keyword">select</span> d.id, d.year, d.major, <span class="keyword">avg</span>(e2.grade) <span class="keyword">as</span> m</span><br><span class="line">         <span class="keyword">from</span> d, exam e2</span><br><span class="line">         <span class="keyword">where</span> d.id = e2.sid <span class="keyword">or</span> (d.year &gt; e2.year <span class="keyword">and</span> e2.curriculum = d.major)</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> d.id, d.year, d.major</span><br><span class="line">     ) <span class="keyword">as</span> d_</span><br><span class="line"><span class="keyword">where</span> e.grade &gt; m + <span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">      d_.id = s.id <span class="keyword">and</span> </span><br><span class="line">      d_.year = e.date <span class="keyword">and</span> </span><br><span class="line">      e.curriculum = d_.major;</span><br></pre></td></tr></tbody></table></figure><p>æˆ–</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> l <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> students s, exams e</span><br><span class="line">        <span class="keyword">where</span> s.id = e.sid <span class="keyword">and</span> (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>)</span><br><span class="line">),</span><br><span class="line">d <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">year</span>, major</span><br><span class="line">         <span class="keyword">from</span> l</span><br><span class="line">     ),</span><br><span class="line">d_ <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> d.id, d.year, d.major, <span class="keyword">avg</span>(e2.grade) <span class="keyword">as</span> m</span><br><span class="line">         <span class="keyword">from</span> d, exam e2</span><br><span class="line">         <span class="keyword">where</span> d.id = e2.sid <span class="keyword">or</span> (d.year &gt; e2.year <span class="keyword">and</span> e2.curriculum = d.major)</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> d.id, d.year, d.major</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span> l, d_</span><br><span class="line"><span class="keyword">where</span> e.grade &gt; m + <span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">         d_.id = l.id <span class="keyword">and</span></span><br><span class="line">         d_.year = l.year <span class="keyword">and</span></span><br><span class="line">         d_.major = l.curriculum;</span><br></pre></td></tr></tbody></table></figure><p>æˆ–</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    students s,</span><br><span class="line">    exams e, (</span><br><span class="line">         <span class="keyword">select</span> s2.id, s2.year, s2.major, <span class="keyword">avg</span>(e2.grade) <span class="keyword">as</span> m</span><br><span class="line">         <span class="keyword">from</span> exam e2,</span><br><span class="line">              (<span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">year</span>, major <span class="keyword">from</span> students) <span class="keyword">as</span> s2</span><br><span class="line">         <span class="keyword">where</span></span><br><span class="line">               s2.id = e2.sid</span><br><span class="line">               <span class="keyword">or</span> (s2.year &gt; e2.year <span class="keyword">and</span> e2.curriculum = s2.major)</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> s2.id, s2.year, s2.major</span><br><span class="line">     ) <span class="keyword">as</span> preagg</span><br><span class="line"><span class="keyword">where</span> s.id = e.sid <span class="keyword">and</span></span><br><span class="line">      (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>) <span class="keyword">and</span></span><br><span class="line">      s.id = preagg.id <span class="keyword">and</span> </span><br><span class="line">      s.major = preagg.major <span class="keyword">and</span></span><br><span class="line">      s.year = preagg.year <span class="keyword">and</span></span><br><span class="line">      e.grade &gt; m + <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p>å¼•ç”¨: </p><p>1: TUM Foundation of Data Engineering Chap3.Advanced SQL: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><p>2.<span class="exturl" data-url="aHR0cHM6Ly9kbC5naS5kZS9iaXRzdHJlYW0vaGFuZGxlLzIwLjUwMC4xMjExNi8yNDE4LzM4My5wZGY/c2VxdWVuY2U9MQ==" title="https://dl.gi.de/bitstream/handle/20.500.12116/2418/383.pdf?sequence=1">Unnesting Arbitrary Queries - Thomas Neumann and Alfons Kemper - (BTW 2015)<i class="fa fa-external-link"></i></span></p><p>3.<a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡æ–‡ç« ç»§&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/&quot;&gt;[SQL]é«˜çº§SQL-å»å…³è”(1)&lt;/a&gt;åï¼Œç»§ç»­å¯¹å»å…³è”è¿™ä¸ªä¸»é¢˜è¿›è¡Œç»ƒä¹ ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Query Optimizer" scheme="https://cakebytheoceanluo.github.io/categories/Query-Optimizer/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Query Optimizer" scheme="https://cakebytheoceanluo.github.io/tags/Query-Optimizer/"/>
    
      <category term="Subquery Optimization" scheme="https://cakebytheoceanluo.github.io/tags/Subquery-Optimization/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]é«˜çº§SQL-å»å…³è”(1)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/</id>
    <published>2020-03-24T17:16:36.000Z</published>
    <updated>2020-03-25T09:52:28.169Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨ä¸€ç¯‡è®ºæ–‡è§£è¯»æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">[Paper]BTW 2015 | Unnesting Arbitrary Queries</a>ä¸­æåˆ°äº†å»å…³è”, åœ¨è¿™ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å¯¹è¿™ä¸ªä¸»é¢˜è¿›è¡Œ<strong>ç»ƒä¹ </strong>ã€‚</p><p>è¿™ä¸ªä¸»é¢˜å…¶å®è¿œæ¯”å¤§å®¶æƒ³è±¡ä¸­çš„è¦å®ç”¨: å¯¹äº1GiBå¤§å°å·¦å³çš„æ•°æ®é›†ï¼ŒSQLæŸ¥è¯¢å¦‚æœæ‹¥æœ‰$O(n^2)$çš„æ—¶é—´å¤æ‚åº¦ï¼ŒåŸºæœ¬å¯ä»¥åˆ¤æ–­å¾ˆæ…¢ï¼Œæˆ–è€…æ…¢åˆ°æ— å®é™…æ„ä¹‰ã€‚å¾€å¾€æˆ‘ä»¬ä½¿ç”¨çš„å„ç§å¤§åé¼é¼çš„å¼€æºæ•°æ®åº“å’Œå•†ç”¨æ•°æ®åº“ä¸ä¸€å®šæ”¯æŒUnnestingè¿™ä¸ªfeature(å…·ä½“çš„æ”¯æŒåœ¨å„ä¸ªæ•°æ®åº“çš„Documentä¸­æè¿°ï¼Œåœ¨å¯¹åº”çš„è®ºæ–‡ä¸­çš„Motivationéƒ¨åˆ†ä¹Ÿæœ‰ç®€å•æåˆ°)ã€‚è¿™å°±æ„å‘³ç€, æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æˆä¸ºQuery Optimizerå»ä¼˜åŒ–æˆ‘ä»¬SQLçš„æ—¶é—´å¤æ‚åº¦ã€‚ </p><a id="more"></a><h1 id="Correlated-Sub-Query-vs-Uncorrelated-Sub-Query"><a href="#Correlated-Sub-Query-vs-Uncorrelated-Sub-Query" class="headerlink" title="Correlated Sub-Query vs. Uncorrelated Sub-Query"></a>Correlated Sub-Query vs. Uncorrelated Sub-Query</h1><p>ä¸€èˆ¬æ¥è¯´ï¼Œcorrelated sub-query(å…³è”å­query)çš„æ—¶é—´å¤æ‚åº¦ä¼šæ¯”uncorrelated sub-query(æ— å…³è”å­query)å¤§ã€‚</p><p>å½“ç„¶è¿™éƒ¨åˆ†çš„å‰ææ˜¯ï¼šquery optimizer(ä¼˜åŒ–å™¨)ä¸å¯¹SQLçš„logical planè¿›è¡Œä¼˜åŒ–ã€‚<br>è€Œä¸€äº›ä¼˜ç§€çš„æ•°æ®åº“<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbmRleC5odG1sIw==" title="https://hyper-db.de/index.html#">HyPer<i class="fa fa-external-link"></i></span>å·²ç»æŠŠè¿™ä¸ªé—®é¢˜ç”¨query optimizerè§£å†³äº†ï¼Œå®ƒä¼šä¸»åŠ¨å»ä¼˜åŒ–ï¼Œæ¯”å¦‚å¯ä»¥<strong>å»å…³è”</strong>ã€‚</p><p>æ›´å¤šçš„å¯ä»¥çœ‹è¿™ä¸€ç¯‡è®ºæ–‡<span class="exturl" data-url="aHR0cDovL3d3dy5idHctMjAxNS5kZS9yZXMvcHJvY2VlZGluZ3MvSGF1cHRiYW5kL1dpc3MvTmV1bWFubi1Vbm5lc3RpbmdfQXJiaXRyYXJ5X1F1ZXJpZS5wZGY=" title="http://www.btw-2015.de/res/proceedings/Hauptband/Wiss/Neumann-Unnesting_Arbitrary_Querie.pdf">Unnesting Arbitrary Queries, Thomas Neumann and Alfons Kemper, Technische Universitat MÃ¼nchen<i class="fa fa-external-link"></i></span></p><h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä¼šä½¿ç”¨å¦‚ä¸‹çš„æ•°æ®é›†:</p><ul><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#TUM-Uni%E6%95%B0%E6%8D%AE%E9%9B%86">TUM Uni æ•°æ®é›†</a></li><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#TPC-H">TPC-H æ•°æ®é›†</a></li></ul><p>å…·ä½“çš„æ•°æ®é›†å®‰è£…è§ä¸Šé¢çš„å¯¹åº”çš„é“¾æ¥ã€‚å¦å¤–æœ‰ä¸€äº›SQLå¹¶ä¸å¯¹åº”ä»»ä½•æ•°æ®é›†, åªæ˜¯åœ¨è®ºæ–‡ä¸­é€»è¾‘æ€§åœ°è¢«æå‡ºå’Œä½¿ç”¨ï¼Œè¿™æ ·çš„SQLæˆ‘ä¼šç‰¹åˆ«æ³¨æ˜: <strong>ä¸å¯¹åº”æ•°æ®é›†</strong>ã€‚</p><hr><h1 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h1><h2 id="ä½¿ç”¨maxä»£æ›¿exists-æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”æ‰€æœ‰æ•™æˆæ—©çš„å­¦ç”Ÿ"><a href="#ä½¿ç”¨maxä»£æ›¿exists-æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”æ‰€æœ‰æ•™æˆæ—©çš„å­¦ç”Ÿ" class="headerlink" title="ä½¿ç”¨maxä»£æ›¿exists: æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”æ‰€æœ‰æ•™æˆæ—©çš„å­¦ç”Ÿ"></a>ä½¿ç”¨<code>max</code>ä»£æ›¿<code>exists</code>: æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”æ‰€æœ‰æ•™æˆæ—©çš„å­¦ç”Ÿ</h2><p>è¿™ä¸ªQueryéœ€è¦çš„å±æ€§å€¼(gebdatumã€€å‡ºç”Ÿæ—¥æœŸ)æ²¡æœ‰è¢«å†™å…¥æ•°æ®é›†ã€‚<br>æ‰€ä»¥ä¸èƒ½è¿è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹ç€ç†è§£æ„æ€ã€‚</p><ul><li>correlated sub-query</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> p.*</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">    <span class="keyword">where</span> p.gebdatum &gt; s.gebdatumm</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure><p>å¯¹æ¯ä¸€ä¸ªstudenten séƒ½éœ€è¦çœ‹æ•´ä¸ªprofessorenè¡¨æ ¼ã€‚<br>è¿™ä¸ªæƒ…å†µå¾ˆç±»ä¼¼cross product(é›†åˆçš„å‰ä¹˜)ã€‚è¿™ä¸ªsubqueryéœ€è¦è¢«æ‰§è¡Œ<code>|studenten|</code>æ¬¡ã€‚</p><p>å¦‚æœquery optimizer(ä¼˜åŒ–å™¨)ä¸å¯¹è¿™ä¸ªSQLçš„logical planè¿›è¡Œä¼˜åŒ–çš„è¯ï¼Œé‚£å®ƒçš„runtime complexity(æ—¶é—´å¤æ‚åº¦)æ˜¯<code>O(|studenten| * |professoren|)</code>ï¼Œç±»æ¨åˆ°<code>O(n^2)</code>ã€‚</p><p><br></p><ul><li>uncorrelated Sub-query</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> s.gebdatum &lt; (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">max</span>(gebdatum)</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·è¿™ä¸ªsubqueryåªéœ€ä¸€æ¬¡è¢«materialized(materializationï¼Œç‰©è´¨åŒ–ï¼Œå®ä¾‹åŒ–)ï¼Œä¹Ÿå°±æ˜¯åªéœ€è¦è¢«æ‰§è¡Œä¸€æ¬¡å¾—åˆ°è¿™ä¸ª<code>max</code>ã€‚ç„¶ååœ¨å»çœ‹<code>studenten</code>ä¸­çš„æ¯ä¸€ä¸ªäººå»å’Œè¿™ä¸ª<code>max</code>æ¯”è¾ƒã€‚è¿™æ ·è‚¯å®šä¼šæ›´åŠ æœ‰æ•ˆç‡ã€‚å®ƒçš„runtime complexityæ˜¯$O(|\mathrm{studenten}| ï¼‹ |\mathrm{professoren}|)$ï¼Œç±»æ¨åˆ° $O(n)$ã€‚</p><p><br></p><h2 id="ä½¿ç”¨joinä»£æ›¿subquery-æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”å¯¹åº”æ•™æˆæ—©çš„åŠ©æ‰‹-åŠ©æ‰‹éœ€è¦åœ¨å¯¹åº”æ•™æˆæ‰‹ä¸‹å·¥ä½œ"><a href="#ä½¿ç”¨joinä»£æ›¿subquery-æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”å¯¹åº”æ•™æˆæ—©çš„åŠ©æ‰‹-åŠ©æ‰‹éœ€è¦åœ¨å¯¹åº”æ•™æˆæ‰‹ä¸‹å·¥ä½œ" class="headerlink" title="ä½¿ç”¨joinä»£æ›¿subquery: æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”å¯¹åº”æ•™æˆæ—©çš„åŠ©æ‰‹(åŠ©æ‰‹éœ€è¦åœ¨å¯¹åº”æ•™æˆæ‰‹ä¸‹å·¥ä½œ)"></a>ä½¿ç”¨joinä»£æ›¿subquery: æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”å¯¹åº”æ•™æˆæ—©çš„åŠ©æ‰‹(åŠ©æ‰‹éœ€è¦åœ¨å¯¹åº”æ•™æˆæ‰‹ä¸‹å·¥ä½œ)</h2><ul><li>correlated sub-query:</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.*</span><br><span class="line"><span class="keyword">from</span> assistenten a</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> p.*</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">    <span class="keyword">where</span> a.boss = p.persnr <span class="keyword">and</span> p.gebdatum &gt; a.gebdatum</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure><ul><li>unnested query(å»åµŒå¥—):</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.*</span><br><span class="line"><span class="keyword">from</span> assistenten a, professoren p</span><br><span class="line"><span class="keyword">where</span> a.boss = p.persnr <span class="keyword">and</span> p.gebdatum &gt; a.gebdatum</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ—¶å€™æˆ‘ä»¬ç›´æ¥ç”¨<code>join</code>æ¥å¯¹åŸcorrelated sub-queryå»åµŒå¥—ã€‚é‡‡ç”¨<code>join</code>åŸå› ä¹‹ä¸€æ˜¯ï¼šè¿™æ—¶å€™ä¸éœ€è¦å’Œæ‰€æœ‰professorenè¿›è¡Œæ¯”è¾ƒï¼Œåªéœ€è¦å’Œå¯¹åº”çš„ä¸€ä¸ªprofessoræ¯”è¾ƒã€‚</p><p><br></p><hr><h1 id="æ™®éä½œæ³•"><a href="#æ™®éä½œæ³•" class="headerlink" title="æ™®éä½œæ³•"></a>æ™®éä½œæ³•</h1><p>æˆ‘ä»¬è¿™é‡Œç»™å‡ºä¸€ä¸ªæ™®éçš„ä½œæ³•ï¼Œä½†æ˜¯ä¸ç™¾åˆ†ä¹‹ç™¾å’ŒåŸè®ºæ–‡çš„æƒ³æ³•å¥‘åˆã€‚å…·ä½“ä½œæ³•æœ€å¥½å‚è€ƒåŸè®ºæ–‡ï¼š</p><p>ä¸‹é¢è¿™ä¸ªå¾ˆæ˜æ˜¾æ˜¯ä¸€ä¸ªå…³è”çš„æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢ä¸­éœ€è¦å¤–ç•Œ<code>r1</code>çš„<code>attr1</code>, <code>attr2</code>ã€‚</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ...</span><br><span class="line"><span class="keyword">from</span> r1, </span><br><span class="line"><span class="keyword">where</span> ... </span><br><span class="line">(</span><br><span class="line">        <span class="keyword">select</span> ...</span><br><span class="line">        <span class="keyword">from</span> r2</span><br><span class="line">        <span class="keyword">where</span> r1.attr1 = ... <span class="keyword">and</span> r1.attr2 = ...</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å°±å°†è¿™ä¸ªå­æŸ¥è¯¢ç»™æŠ½ç¦»å‡ºæ¥åˆ°<code>from</code>ä¸‹é¢æˆ–è€…<code>with</code>é‡Œé¢ï¼Œæå‰ç”¨ä¸å…³è”çš„æ–¹å¼ç‰©ç†åŒ–å®ƒçš„ç»“æœï¼Œè€Œä¸æ˜¯ä¹‹åè¿›è¡Œä½æ•ˆçš„ç¬›å¡å°”ç§¯ã€‚<br>å¦‚æœæˆ‘ä»¬æƒ³ç”¨ä¸å…³è”çš„æ–¹å¼ç‰©ç†åŒ–å­æŸ¥è¯¢çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥éœ€è¦<code>r1</code>è¿™ä¸ªè¡¨æ ¼çš„å¦å¤–ä¸€ä»½å¤åˆ¶å“ï¼Œä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦<code>r1</code>ä¸­å’Œjoinç›¸å…³çš„å­—æ®µå€¼ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ...</span><br><span class="line"><span class="keyword">from</span> r1, </span><br><span class="line">       (</span><br><span class="line">        <span class="keyword">select</span> d.attr1, d.attr2 <span class="comment">-- æœ‰å¯èƒ½è¿˜æœ‰å…¶ä»–èšåˆå‡½æ•°</span></span><br><span class="line">        <span class="keyword">from</span> r2,</span><br><span class="line">             (<span class="keyword">select</span> <span class="keyword">distinct</span> r1.attr1, r1.attr2 <span class="keyword">from</span> r1) <span class="keyword">as</span> d</span><br><span class="line">        <span class="keyword">where</span> d.attr1 = ... <span class="keyword">and</span> d.attr2 = ...</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> d.attr1, d.attr2</span><br><span class="line">        ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span> ... </span><br><span class="line">        precomputed.attr1 = r1.attr1 <span class="keyword">and</span></span><br><span class="line">        precomputed.attr2 = r1.attr1</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="TPC-Hä¾‹å­ä¸€-1"><a href="#TPC-Hä¾‹å­ä¸€-1" class="headerlink" title="TPC-Hä¾‹å­ä¸€ 1"></a>TPC-Hä¾‹å­ä¸€ <sup><a href="#fn1">1</a></sup></h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l1</span><br><span class="line"><span class="keyword">where</span> l_extendedprice =</span><br><span class="line">   (<span class="keyword">select</span> <span class="keyword">min</span>(l_extendedprice)</span><br><span class="line">    <span class="keyword">from</span> lineitem l2</span><br><span class="line">    <span class="keyword">where</span> l1.l_orderkey = l2.l_orderkey);</span><br></pre></td></tr></tbody></table></figure><h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l1,</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">min</span>(l_extendedprice) m, l_orderkey</span><br><span class="line">    <span class="keyword">from</span> lineitem</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> l_orderkey) l2</span><br><span class="line"><span class="keyword">where</span> l1.l_orderkey = l2.l_orderkey</span><br><span class="line"><span class="keyword">and</span> l_extendedprice = l2.m;</span><br></pre></td></tr></tbody></table></figure><ul><li>è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å¯¹<code>l2</code>è¿›è¡Œä¸€æ¬¡æ±‚å€¼ã€‚</li></ul><p><br></p><h1 id="TPC-Hä¾‹å­äºŒ-1"><a href="#TPC-Hä¾‹å­äºŒ-1" class="headerlink" title="TPC-Hä¾‹å­äºŒ 1"></a>TPC-Hä¾‹å­äºŒ <sup><a href="#fn1">1</a></sup></h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c1.c_name</span><br><span class="line"><span class="keyword">from</span> customer c1</span><br><span class="line"><span class="keyword">where</span> c1.c_mktsegment = <span class="string">'AUTOMOBILE'</span> </span><br><span class="line">      <span class="keyword">or</span> c1.c_acctbal &gt;</span><br><span class="line">                        (<span class="keyword">select</span> <span class="keyword">avg</span>(c2.c_acctbal)</span><br><span class="line">                        <span class="keyword">from</span> customer c2</span><br><span class="line">                        <span class="keyword">where</span> c2.c_mktsegment = c1.c_mktsegment);</span><br></pre></td></tr></tbody></table></figure><h2 id="ç»“æœ-1"><a href="#ç»“æœ-1" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c1.c_name</span><br><span class="line"><span class="keyword">from</span> customer c1, (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(c.c_acctbal) <span class="keyword">as</span> <span class="keyword">avg</span>, c_mktsegment</span><br><span class="line">    <span class="keyword">from</span> customer c</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_mktsegment</span><br><span class="line">    ) <span class="keyword">as</span> c2</span><br><span class="line"><span class="keyword">where</span> (c1.c_mktsegment = <span class="string">'AUTOMOBILE'</span></span><br><span class="line">      <span class="keyword">or</span> c1.c_acctbal &gt; c2.avg)</span><br><span class="line">      <span class="keyword">and</span> c1.c_mktsegment = c2.c_mktsegment</span><br></pre></td></tr></tbody></table></figure><p>æˆ–</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> c2 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(c.c_acctbal) <span class="keyword">as</span> <span class="keyword">avg</span>, c_mktsegment</span><br><span class="line">    <span class="keyword">from</span> customer c</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_mktsegment</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> c1.c_name</span><br><span class="line"><span class="keyword">from</span> customer c1, c2</span><br><span class="line"><span class="keyword">where</span> (c1.c_mktsegment = <span class="string">'AUTOMOBILE'</span></span><br><span class="line">      <span class="keyword">or</span> c1.c_acctbal &gt; c2.avg)</span><br><span class="line">      <span class="keyword">and</span> c1.c_mktsegment = c2.c_mktsegment</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="TPC-H-Q17-ä¾‹å­"><a href="#TPC-H-Q17-ä¾‹å­" class="headerlink" title="TPC-H Q17 ä¾‹å­"></a>TPC-H Q17 ä¾‹å­</h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- TPC-H Query 17</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">        <span class="keyword">sum</span>(l_extendedprice) / <span class="number">7.0</span> <span class="keyword">as</span> avg_yearly</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        lineitem,</span><br><span class="line">        part</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        p_partkey = l_partkey</span><br><span class="line">        <span class="keyword">and</span> p_brand = <span class="string">'Brand#23'</span></span><br><span class="line">        <span class="keyword">and</span> p_container = <span class="string">'MED BOX'</span></span><br><span class="line">        <span class="keyword">and</span> l_quantity &lt; (</span><br><span class="line">                <span class="keyword">select</span></span><br><span class="line">                        <span class="number">0.2</span> * <span class="keyword">avg</span>(l_quantity)</span><br><span class="line">                <span class="keyword">from</span></span><br><span class="line">                        lineitem</span><br><span class="line">                <span class="keyword">where</span></span><br><span class="line">                        l_partkey = p_partkey</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å¾ˆæ¸…æ™°ï¼Œå…³è”(nested, correlated)çš„éƒ¨åˆ†å¦‚ä¸‹ï¼š<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">from</span><br><span class="line">        lineitem,</span><br><span class="line">        part</span><br><span class="line">...</span><br><span class="line">        and l_quantity &lt; (</span><br><span class="line">                <span class="keyword">select</span></span><br><span class="line">                        <span class="number">0.2</span> * <span class="keyword">avg</span>(l_quantity)</span><br><span class="line">                <span class="keyword">from</span></span><br><span class="line">                        lineitem</span><br><span class="line">                <span class="keyword">where</span></span><br><span class="line">                        l_partkey = p_partkey</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>p_partkey</code>æ˜¯è¿™ä¸ªå­æŸ¥è¯¢(Sub-Query)ä¸­æ¥è‡ªå¤–æŸ¥è¯¢çš„å­—æ®µï¼Œä¹Ÿå°±æ˜¯å®ƒé€ æˆäº†è¿™ä¸ªä¾èµ–(dependency)ã€‚</p><p>æˆ‘ä»¬ç”¨æ–‡å­—å»æè¿°ä¸€ä¸‹è¿™ä¸ªå…³è”éƒ¨åˆ†:  </p><ul><li>å¯¹æ¯ä¸€ä¸ªå­æŸ¥è¯¢çš„<code>lineitem</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>l_partkey</code>å­—æ®µå€¼ä¾èµ–äºå¤–ç•Œ<code>part</code>çš„å¯¹åº”<code>p_partkey</code>å­—æ®µå€¼ã€‚</li><li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>l_partkey = p_partkey</code></li><li>$D$æ˜¯<code>part.p_partkey</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚</p><h2 id="ç»“æœ-2"><a href="#ç»“æœ-2" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        <span class="keyword">sum</span> (l_extendedprice) / <span class="number">7.0</span> <span class="keyword">as</span> avg_yearly</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        lineitem l,</span><br><span class="line">        part,</span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span></span><br><span class="line">                    <span class="number">0.2</span> * <span class="keyword">avg</span> (l_quantity) <span class="keyword">avg</span>, l_partkey</span><br><span class="line">            <span class="keyword">from</span></span><br><span class="line">                    lineitem</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                    l_partkey</span><br><span class="line">        ) quaprecomputednt</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        p_partkey = l. l_partkey</span><br><span class="line">        <span class="keyword">and</span> p_brand = <span class="string">'Brand #23'</span></span><br><span class="line">        <span class="keyword">and</span> p_container = <span class="string">'MED BOX'</span></span><br><span class="line">        <span class="keyword">and</span> precomputed.l_partkey = p_partkey  <span class="comment">-- ä½¿ç”¨å¤–ä¾èµ–æ¡ä»¶çš„regular join</span></span><br><span class="line">        <span class="keyword">and</span> l_quantity &lt; precomputed.avg       <span class="comment">-- å»é™¤åŸä¾èµ–</span></span><br></pre></td></tr></tbody></table></figure><p>æˆ–</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">            <span class="number">0.2</span> * <span class="keyword">avg</span> (l_quantity) <span class="keyword">avg</span> , l_partkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">            lineitem</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            l_partkey</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">        <span class="keyword">sum</span> (l_extendedprice) / <span class="number">7.0</span> <span class="keyword">as</span> avg_yearly</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        lineitem l,</span><br><span class="line">        part,</span><br><span class="line">        precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        p_partkey = l. l_partkey</span><br><span class="line">        <span class="keyword">and</span> p_brand = <span class="string">'Brand #23'</span></span><br><span class="line">        <span class="keyword">and</span> p_container = <span class="string">'MED BOX'</span></span><br><span class="line">        <span class="keyword">and</span> precomputed.l_partkey = p_partkey  <span class="comment">-- ä½¿ç”¨å¤–ä¾èµ–æ¡ä»¶çš„regular join</span></span><br><span class="line">        <span class="keyword">and</span> l_quantity &lt; precomputed.avg       <span class="comment">-- å»é™¤åŸä¾èµ–</span></span><br></pre></td></tr></tbody></table></figure><p>å¼•ç”¨: </p><p><a name="fn1">1</a>: TUM Foundation of Data Engineering Chap3.Advanced SQL: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><p>2.<span class="exturl" data-url="aHR0cHM6Ly9kbC5naS5kZS9iaXRzdHJlYW0vaGFuZGxlLzIwLjUwMC4xMjExNi8yNDE4LzM4My5wZGY/c2VxdWVuY2U9MQ==" title="https://dl.gi.de/bitstream/handle/20.500.12116/2418/383.pdf?sequence=1">Unnesting Arbitrary Queries - Thomas Neumann and Alfons Kemper - (BTW 2015)<i class="fa fa-external-link"></i></span></p><p>3.<a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æˆ‘ä»¬åœ¨ä¸€ç¯‡è®ºæ–‡è§£è¯»æ–‡ç« &lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/&quot;&gt;[Paper]BTW 2015 | Unnesting Arbitrary Queries&lt;/a&gt;ä¸­æåˆ°äº†å»å…³è”, åœ¨è¿™ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å¯¹è¿™ä¸ªä¸»é¢˜è¿›è¡Œ&lt;strong&gt;ç»ƒä¹ &lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªä¸»é¢˜å…¶å®è¿œæ¯”å¤§å®¶æƒ³è±¡ä¸­çš„è¦å®ç”¨: å¯¹äº1GiBå¤§å°å·¦å³çš„æ•°æ®é›†ï¼ŒSQLæŸ¥è¯¢å¦‚æœæ‹¥æœ‰$O(n^2)$çš„æ—¶é—´å¤æ‚åº¦ï¼ŒåŸºæœ¬å¯ä»¥åˆ¤æ–­å¾ˆæ…¢ï¼Œæˆ–è€…æ…¢åˆ°æ— å®é™…æ„ä¹‰ã€‚å¾€å¾€æˆ‘ä»¬ä½¿ç”¨çš„å„ç§å¤§åé¼é¼çš„å¼€æºæ•°æ®åº“å’Œå•†ç”¨æ•°æ®åº“ä¸ä¸€å®šæ”¯æŒUnnestingè¿™ä¸ªfeature(å…·ä½“çš„æ”¯æŒåœ¨å„ä¸ªæ•°æ®åº“çš„Documentä¸­æè¿°ï¼Œåœ¨å¯¹åº”çš„è®ºæ–‡ä¸­çš„Motivationéƒ¨åˆ†ä¹Ÿæœ‰ç®€å•æåˆ°)ã€‚è¿™å°±æ„å‘³ç€, æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æˆä¸ºQuery Optimizerå»ä¼˜åŒ–æˆ‘ä»¬SQLçš„æ—¶é—´å¤æ‚åº¦ã€‚ &lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Query Optimizer" scheme="https://cakebytheoceanluo.github.io/categories/Query-Optimizer/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Query Optimizer" scheme="https://cakebytheoceanluo.github.io/tags/Query-Optimizer/"/>
    
      <category term="Subquery Optimization" scheme="https://cakebytheoceanluo.github.io/tags/Subquery-Optimization/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]ä¸­çº§SQL(5)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/22/SQL-%E4%B8%AD%E7%BA%A7SQL-5/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/22/SQL-%E4%B8%AD%E7%BA%A7SQL-5/</id>
    <published>2020-03-22T13:13:22.000Z</published>
    <updated>2020-03-22T13:15:03.293Z</updated>
    
    <content type="html"><![CDATA[<h1 id="TPC-H-æ•°æ®é›†"><a href="#TPC-H-æ•°æ®é›†" class="headerlink" title="TPC-H æ•°æ®é›†"></a>TPC-H æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br><code>TPC-H</code>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p><p><strong>æœ¬åœ°è½½å…¥æ”¹æ•°æ®é›†</strong>çš„æ–¹æ³•è§æˆ‘çš„åšå®¢ä¸¤ç¯‡æ–‡ç« :</p><ul><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥ TPC-H æ•°æ®é›†</a></li><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†</a></li></ul><a id="more"></a><h1 id="ä¸­çº§SQL"><a href="#ä¸­çº§SQL" class="headerlink" title="ä¸­çº§SQL"></a>ä¸­çº§SQL</h1><p>è¿™ä¸€ç¯‡æ–‡ç« å…¶å®ç›®çš„æ˜¯ç”¨ç®€å•çš„SQLå»ç†Ÿæ‚‰TPC-Hè¿™ä¸ªæ•°æ®é›†ï¼Œå› ä¸ºè¿™ä¸ªæ•°æ®é›†ä¼šåœ¨<strong>é«˜çº§SQL</strong>éƒ¨åˆ†ä¸€ç›´è¢«ä½¿ç”¨ã€‚</p><ul><li>æœ‰å¤šå°‘customeræ‹¥æœ‰orderï¼Œè€Œè¿™ä¸ªorderçš„commentå«æœ‰â€packagesâ€è¿™ä¸ªå•è¯ï¼Ÿ</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> c_custkey)</span><br><span class="line"><span class="keyword">from</span> customer, orders</span><br><span class="line"><span class="keyword">where</span> c_custkey = o_custkey <span class="keyword">and</span> o_comment <span class="keyword">like</span> <span class="string">'%packages%'</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> o_custkey)</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">where</span> o_comment <span class="keyword">like</span> <span class="string">'%packages%'</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>æ±‚<code>l_orderkey</code>çš„æ•°å­—æ•°é‡çš„å¹³å‡å€¼(<code>char_length()</code>å‡½æ•°)ï¼š<ul><li><code>l_orderkey::text</code>å’Œ<code>l_orderkey || ''</code>éƒ½å¯ä»¥ä½¿intå˜æˆstring<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(<span class="keyword">char_length</span>(l_orderkey || <span class="string">''</span>))</span><br><span class="line"><span class="keyword">from</span> lineitem;</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span> (<span class="keyword">char_length</span>(l_orderkey::<span class="built_in">text</span>))</span><br><span class="line"><span class="keyword">from</span> lineitem ;</span><br></pre></td></tr></tbody></table></figure><ul><li><p>æ±‚æ‰€æœ‰<code>customer</code>å’Œæ‰€æœ‰<code>supplier</code>çš„åå­—ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_name</span><br><span class="line"><span class="keyword">from</span> customer</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> s_name</span><br><span class="line"><span class="keyword">from</span> supplier</span><br></pre></td></tr></tbody></table></figure></li><li><p>è¯»å–10ä¸ªcustomerså¯¹åº”çš„nationï¼Œç”¨JSONçš„å½¢å¼å»è¡¨è¾¾<code>custkey, name, nation</code>ï¼š</p></li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'{" custkey ": '</span> || c_custkey || <span class="string">', " name ":" '</span> || c_name || <span class="string">'", " nation ":{" nationkey ": '</span> || n_nationkey || <span class="string">', " name ":" '</span> || n_name || <span class="string">' "}} '</span> <span class="keyword">as</span> custjson</span><br><span class="line"><span class="keyword">from</span> customer , nation</span><br><span class="line"><span class="keyword">where</span> c_nationkey = n_nationkey <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></tbody></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">                                                  custjson                                                  </span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> {" custkey ": 86, " name ":" Customer#000000086", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 80, " name ":" Customer#000000080", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 76, " name ":" Customer#000000076", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 73, " name ":" Customer#000000073", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 48, " name ":" Customer#000000048", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 29, " name ":" Customer#000000029", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 144, " name ":" Customer#000000144", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line"> {" custkey ": 141, " name ":" Customer#000000141", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line"> {" custkey ": 106, " name ":" Customer#000000106", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line"> {" custkey ": 59, " name ":" Customer#000000059", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line">(10 rows)</span><br></pre></td></tr></tbody></table></figure><ul><li>German Supplieråœ¨1995å¹´å‘äº†å¤šå°‘lineitem?</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(lineitem)</span><br><span class="line"><span class="keyword">from</span> supplier, nation, lineitem</span><br><span class="line"><span class="keyword">where</span> n_name = <span class="string">'GERMANY'</span> <span class="keyword">and</span> n_nationkey = s_nationkey <span class="keyword">and</span> s_suppkey = l_suppkey <span class="keyword">and</span> <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> l_shipdate) = <span class="number">1995</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(lineitem)</span><br><span class="line"><span class="keyword">from</span> supplier, nation, lineitem</span><br><span class="line"><span class="keyword">where</span> n_name = <span class="string">'GERMANY'</span> <span class="keyword">and</span> n_nationkey = s_nationkey <span class="keyword">and</span> s_suppkey = l_suppkey <span class="keyword">and</span> l_shipdate <span class="keyword">between</span> <span class="string">'1995-01-01'</span> <span class="keyword">and</span> <span class="string">'1995-12-31'</span></span><br></pre></td></tr></tbody></table></figure><ul><li>æœç´¢EUROPEåœ¨FURNITUREã€€market segmentä¸­æœ€é«˜account balanceçš„åä¸ªcustomers:</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_name, c_acctbal</span><br><span class="line"><span class="keyword">from</span> customer, nation, region</span><br><span class="line"><span class="keyword">where</span> r_name = <span class="string">'EUROPE'</span> <span class="keyword">and</span> r_regionkey = n_regionkey <span class="keyword">and</span> n_nationkey = c_nationkey <span class="keyword">and</span> c_mktsegment = <span class="string">'FURNITURE'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c_acctbal <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span></span><br></pre></td></tr></tbody></table></figure><ul><li>How many orders do customer have?</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(o_orderkey) <span class="keyword">as</span> o_count</span><br><span class="line"><span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders <span class="keyword">on</span> c_custkey = o_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_custkey</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_count <span class="keyword">desc</span>, c_custkey <span class="keyword">asc</span></span><br></pre></td></tr></tbody></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ul><li><code>sum(l_extendedprice * (1 - l_discount))</code>: revenue</li><li>å¾—åˆ°å¹´ä»½çš„ä¾‹å­ï¼š<code>extract(year from l_shipdate) = 1995</code></li><li><code>c_mktsegment</code>: market segment</li><li><code>c_acctbal</code>: account balance</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;TPC-H-æ•°æ®é›†&quot;&gt;&lt;a href=&quot;#TPC-H-æ•°æ®é›†&quot; class=&quot;headerlink&quot; title=&quot;TPC-H æ•°æ®é›†&quot;&gt;&lt;/a&gt;TPC-H æ•°æ®é›†&lt;/h1&gt;&lt;p&gt;æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨&lt;code&gt;select...from...where&lt;/code&gt;è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚&lt;br&gt;&lt;code&gt;TPC-H&lt;/code&gt;æ•°æ®é›†åœ¨ã€€&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==&quot; title=&quot;https://hyper-db.de/interface.html&quot;&gt;https://hyper-db.de/interface.html&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:&lt;code&gt;insert&lt;/code&gt;, &lt;code&gt;update&lt;/code&gt;, &lt;code&gt;delete&lt;/code&gt;ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶&lt;code&gt;create table&lt;/code&gt;å’Œ&lt;code&gt;drop table&lt;/code&gt;ä¹Ÿä¸è¢«å…è®¸ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬åœ°è½½å…¥æ”¹æ•°æ®é›†&lt;/strong&gt;çš„æ–¹æ³•è§æˆ‘çš„åšå®¢ä¸¤ç¯‡æ–‡ç« :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/&quot;&gt;[DBMS] PostgreSQL å¯¼å…¥ TPC-H æ•°æ®é›†&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/&quot;&gt;[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="TPC-H" scheme="https://cakebytheoceanluo.github.io/tags/TPC-H/"/>
    
  </entry>
  
  <entry>
    <title>[CMU-15445]Lec07 Tree Indexes Part I - æ ‘ç´¢å¼• I</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/19/CMU-15445-Lec07/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/19/CMU-15445-Lec07/</id>
    <published>2020-03-19T18:09:58.000Z</published>
    <updated>2020-03-19T18:15:31.659Z</updated>
    
    <content type="html"><![CDATA[<p>Tree Indexes Part I - æ ‘ç´¢å¼• I</p><p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA3LXRyZWVzMS5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDctdHJlZXMxLnBkZg==" title="https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf<i class="fa fa-external-link"></i></span><br>Readings:  Chapter 11.1-11.4</p><p>Database Tree Indexes åœ¨CMUåˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œåœ¨ä¸¤èŠ‚è¯¾ä¸­è®²ã€‚è¿™æ˜¯ç¬¬ä¸€éƒ¨åˆ†ã€‚</p><p>è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“çš„ä¸­ä½¿ç”¨çš„B+æ ‘ï¼Œå®ƒæ•°æ®åº“æœ€é‡è¦çš„æ•°æ®ç»“æ„ã€‚å‡ åå¹´æ¥ï¼Œæ•°æ®åº“çš„å½¢å¼å’ŒæŠ€æœ¯å˜åŒ–å¾ˆå¤§ï¼Œä½†æ˜¯å§‹ç»ˆåšæŒåœ¨ä½¿ç”¨B+æ ‘ä»¥åŠå®ƒçš„å˜å½¢ã€‚</p><a id="more"></a><p><img data-src="/images/CMU1544564/Lec07/1.jpg" alt="1.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/3.jpg" alt="3.jpg"></p><ul><li>ä¸Šå›¾æˆ‘ä»¬åœ¨å‰ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Data-Structure-in-DBMS">[CMU-15445] Lec06 Hash Tables - å“ˆå¸Œè¡¨ - Data Structure in DBMS</a>ä¸­å·²ç»è®¨è®ºè¿‡ã€‚æˆ‘ä»¬ç°åœ¨ä»£å…¥hash tableå’Œtreeå†çœ‹çœ‹è¿™ä¸€é¡µã€‚</li><li>å‰ä¸‰ç‚¹ä¸­hash tableå¯ä»¥è¢«åº”ç”¨ï¼ŒåŒæ—¶æ•ˆæœä¸é”™ã€‚ä½†æ˜¯åœ¨<strong>table indexes</strong>ä¸­treeæ›´å¥½ï¼Œä»¥è‡³äºå„ä¸ªDBMSé»˜è®¤çš„table indexéƒ½æ˜¯treeã€‚å…·ä½“treeå“ªé‡Œå¥½ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™å‡ èŠ‚è¯¾ä¸­å…·ä½“è®¨è®ºã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec07/4.jpg" alt="4.jpg"></p><ul><li>ä»ä¸Šå›¾ä¸­:</li><li>indexç´¢å¼•ä¸¥æ ¼ä¸Šè¯´ä¸æ˜¯å¿…é¡»ï¼Œå®ƒçš„æ˜¯ä¸€ä¸ªèµ·åˆ°æé€Ÿæœç´¢çš„æ•°æ®ç»“æ„ã€‚å¦‚æœæ²¡æœ‰å®ƒï¼Œé‚£å°±linear sequential scanå»æ‰¾æƒ³è¦çš„tupleï¼Œ $O(n)$</li><li>indexç´¢å¼•å…¶å®å°†åŸè¡¨æ ¼å†…å®¹å­˜å‚¨åœ¨æ•°æ®ç»“æ„ä¸­ï¼Œå› æ­¤å®ƒä¹Ÿé‡å¤(replica)äº†ä¸€éƒ¨åˆ†åŸè¡¨æ ¼çš„å†…å®¹ã€‚å¦‚æœæˆ‘ä»¬å¯¹åŸè¡¨æ ¼è¿›è¡Œæ›´æ–°(å†™æ“ä½œ)ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦å¯¹indexè¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œ<strong>è®©åŸè¡¨æ ¼å’ŒindexåŒæ­¥</strong>ã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec07/5.jpg" alt="5.jpg"></p><ul><li>ä»ä¸Šå›¾ä¸­:</li><li>indexçš„å­˜åœ¨ä¼šå¸¦æ¥:</li><li>Storage Overhead: indexé‡å¤äº†ä¸€éƒ¨åˆ†åŸè¡¨æ ¼å†…å®¹ï¼Œindexè¿™ä¸ªæ•°æ®ç»“æ„è¦å ä¸€å—å­˜å‚¨ã€‚å¸¸å¸¸éœ€è¦å¤šä¸ªpageï¼Œä¸èƒ½ä¿è¯å…¨éƒ¨åœ¨å†…å­˜ä¸Šã€‚</li><li>Maintenance Overhead: å¦‚æœæˆ‘ä»¬å¯¹åŸè¡¨æ ¼è¿›è¡Œæ›´æ–°(å†™æ“ä½œ)ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦å¯¹indexè¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œ<strong>è®©åŸè¡¨æ ¼å’ŒindexåŒæ­¥</strong>ã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec07/6.jpg" alt="6.jpg"></p><h1 id="B-Tree-Family"><a href="#B-Tree-Family" class="headerlink" title="B-Tree Family"></a>B-Tree Family</h1><p><img data-src="/images/CMU1544564/Lec07/7.jpg" alt="7.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/8.jpg" alt="8.jpg"></p><ul><li>Efficient locking for concurrent operations on B-trees: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzMxOTYyOC4zMTk2NjM=" title="https://dl.acm.org/doi/10.1145/319628.319663">https://dl.acm.org/doi/10.1145/319628.319663<i class="fa fa-external-link"></i></span></li></ul><h1 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B+ Tree"></a>B+ Tree</h1><p><img data-src="/images/CMU1544564/Lec07/9.jpg" alt="9.jpg"></p><ul><li>Ubiquitous B-Tree: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzM1Njc3MC4zNTY3NzY=" title="https://dl.acm.org/doi/10.1145/356770.356776">https://dl.acm.org/doi/10.1145/356770.356776<i class="fa fa-external-link"></i></span></li></ul><p><img data-src="/images/CMU1544564/Lec07/10.jpg" alt="10.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/11.jpg" alt="11.jpg"></p><ul><li>ä»ä¸Šå›¾ä¸­:</li><li>leaf node: æŒ‡æœ€ä¸‹é¢ä¸€å±‚çš„èŠ‚ç‚¹</li><li>inner node: æŒ‡éleaf nodeçš„èŠ‚ç‚¹</li><li>sibling pointer: æŒ‡æ‹¥æœ‰åŒä¸€ä¸ªçˆ¶äº²çš„leaf node</li></ul><p><img data-src="/images/CMU1544564/Lec07/12.jpg" alt="12.jpg"></p><ul><li>ä»ä¸Šå›¾ä¸­:</li><li>inner node: ç”±<code>node*</code>å’Œ<code>key</code>ç»„æˆ</li><li>leaf node: ç”±<code>value</code>å’Œ<code>key</code>ç»„æˆ</li></ul><h2 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h2><p><img data-src="/images/CMU1544564/Lec07/13.jpg" alt="13.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/15.jpg" alt="15.jpg"></p><ul><li>ä»ä¸Šå›¾ä¸­:</li><li><code>prev</code>å’Œ<code>next</code>æ˜¯ä¸¤ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘sibling node</li></ul><p><img data-src="/images/CMU1544564/Lec07/16.jpg" alt="16.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/18.jpg" alt="18.jpg"></p><ul><li>ä»ä¸Šå›¾æ˜¯å®é™…å®ç°ä¸­ï¼ŒB+ Treeçš„æ ·å­</li><li><code>sortd keys</code>æ’åˆ—åœ¨ä¸€å—å„¿ã€‚å› ä¸ºscançš„æ—¶å€™ï¼Œåªæ˜¯æ£€æŸ¥<code>key</code>ã€‚å¦å¤–<code>key</code>çš„æ•°æ®ç±»å‹å¤§å°ä¸€è‡´,ã€€<code>values</code>å¤§å°å¾ˆå¯èƒ½ä¸ä¸€è‡´ï¼Œå¦‚å­—ç¬¦ä¸²ã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec07/19.jpg" alt="19.jpg"></p><h2 id="B-Tree-vs-B-Tree"><a href="#B-Tree-vs-B-Tree" class="headerlink" title="B Tree vs. B+ Tree"></a>B Tree vs. B+ Tree</h2><p><img data-src="/images/CMU1544564/Lec07/20.jpg" alt="20.jpg"></p><ul><li>ä»ä¸Šå›¾ä¸­:</li><li>B Treeä¸­æ˜¯æ²¡æœ‰é‡å¤çš„ï¼Œ<code>key</code>è¢«å­˜å‚¨åœ¨inner nodeå’Œleaf nodeä¹‹é—´</li><li>B+ Treeä¸­æ˜¯æœ‰é‡å¤çš„ï¼Œ<code>key</code>åªè¢«å­˜å‚¨åœ¨leaf nodeä¸­</li><li><code>key</code>çš„å­˜å‚¨åœ°ç‚¹ä¸æ­¢å½±å“æ ‘çš„æ ·å­ï¼Œæ›´å½±å“å¤šçº¿ç¨‹æ›´æ”¹æ ‘ä¿¡æ¯çš„æ€§èƒ½ã€‚B+ Treeçš„<code>key</code>ä¿¡æ¯åªåœ¨leaf nodeä¸­ï¼Œæ›´æ”¹ä¿¡æ¯ä»¥ååªéœ€è¦å‘ä¸Šèµ°ï¼Œå› æ­¤åªéœ€è¦latchä¸€ä¸ªå‘ä¸Šçš„æ–¹å‘ã€‚ä½†æ˜¯B Treeéœ€è¦latchä¸¤ä¸ªæ–¹å‘ï¼Œå³å‘ä¸Šå’Œå‘ä¸‹ã€‚è¿™ä¸ªæˆ‘ä»¬ä¼šåœ¨åä¸¤æ¬¡è¯¾ä¸­ä»”ç»†è®¨è®ºã€‚<!-- TODO:åä¸¤æ¬¡è¯¾ã€‚ --><!-- TODO: B Tree ä»‹ç» --></li></ul><h2 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h2><p><img data-src="/images/CMU1544564/Lec07/21.jpg" alt="21.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/22.jpg" alt="22.jpg"></p><ul><li>ä¸Šå›¾ä¸­çš„é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY3MudXNmY2EuZWR1L35nYWxsZXMvdmlzdWFsaXphdGlvbi9CUGx1c1RyZWUuaHRtbA==" title="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html<i class="fa fa-external-link"></i></span></li></ul><p>æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸‹ä½œä¸ºDemo:<br><code>insert 4; insert 2; insert 6; insert 1; insert 5;</code><br>å¾—åˆ°å¦‚ä¸‹çš„æ ‘:</p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec07/b+tree_insert.png" alt="B+Tree-Insert"></p><h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h2><p><img data-src="/images/CMU1544564/Lec07/23.jpg" alt="23.jpg"></p><ul><li>ä¸Šå›¾ä¸­çš„é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMzQ2LzIwMTUvbm90ZXMvQmxpbmsucHB0eA==" title="https://web.stanford.edu/class/cs346/2015/notes/Blink.pptx">https://web.stanford.edu/class/cs346/2015/notes/Blink.pptx<i class="fa fa-external-link"></i></span></li></ul><p>æˆ‘ä»¬å†ç»§ç»­åˆšåˆšçš„Demo:</p><p><code>delete 5; delete 4;</code><br>å¾—åˆ°å¦‚ä¸‹çš„æ ‘:</p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec07/b+tree_delete.png" alt="B+Tree-Delete"></p><h2 id="B-Tree-In-Practice"><a href="#B-Tree-In-Practice" class="headerlink" title="B+ Tree In Practice"></a>B+ Tree In Practice</h2><p><img data-src="/images/CMU1544564/Lec07/24.jpg" alt="24.jpg"></p><ul><li>ä»ä¸Šå›¾ä¸­:</li><li>Fill-Factoræ˜¯æŒ‡<code>leaf nodeçš„ä¸ªæ•° / æ‰€æœ‰ nodeçš„ä¸ªæ•°</code>æ¯”å€¼</li><li>å®é™…ä¸ŠB+æ ‘ä¸éœ€è¦ï¼•å±‚ä»¥ä¸Šã€‚</li></ul><h2 id="Clustered-Indexes"><a href="#Clustered-Indexes" class="headerlink" title="Clustered Indexes"></a>Clustered Indexes</h2><p><img data-src="/images/CMU1544564/Lec07/25.jpg" alt="25.jpg"></p><p>æŒ‡é¡µé¢åœ¨ç¡¬ç›˜å­˜å‚¨çš„é¡ºåºå’Œç´¢å¼•ä¸­æ’åºçš„é¡ºåºä¸€è‡´ï¼Œå³ä¹Ÿè¢«æ’åºï¼Œè€Œå¹¶éä»»æ„é¡ºåºã€‚è¿™ç§Clustered Indexesåœ¨å¯¹äºrange queryå¾ˆæœ‰å¸®åŠ©ã€‚range queryçš„ä¸€ä¸ªä¾‹å­æ˜¯è¦<code>primary key</code>åœ¨0åˆ°100çš„æ‰€æœ‰tupleã€‚å¯¹è¿™ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦5ä¸ªpageã€‚é‚£è¿™5ä¸ªpageåœ¨clustered indexä»¥åçš„ç¡¬ç›˜ä¸Šæ˜¯è¿ç»­çš„ï¼Œä¸€æ¬¡sequential I/Oå°±å¯ä»¥è§£å†³ã€‚å¦‚æœä¸ä½¿ç”¨clustered indexes, é‚£å°±å¯èƒ½å‡ºç°5æ¬¡random I/Oï¼Œå¯¹åº”çš„æ€§èƒ½å°±å¾ˆåƒåœ¾äº†ã€‚</p><!-- TODO:å®éªŒ --><h2 id="Selection-Conditions"><a href="#Selection-Conditions" class="headerlink" title="Selection Conditions"></a>Selection Conditions</h2><p>Selection Conditionsæ˜¯B+ treeçš„ä¼˜åŠ¿ï¼ŒæŒ‡æˆ‘ä»¬å¯ä»¥æœç´¢indexå¯¹åº”çš„search keyçš„prefixå‰ç¼€, suffixåç¼€, æˆ–è€…å…¶ä¸­çš„éƒ¨åˆ†ã€‚</p><p>è¿™æ˜¯hash tableæ— æ³•åšåˆ°çš„ï¼Œå®ƒåªèƒ½æœç´¢å®Œæ•´äº†search keyã€‚</p><p><img data-src="/images/CMU1544564/Lec07/26.jpg" alt="26.jpg"></p><h3 id="å‰ç¼€ä¾‹å­"><a href="#å‰ç¼€ä¾‹å­" class="headerlink" title="å‰ç¼€ä¾‹å­"></a>å‰ç¼€ä¾‹å­</h3><p>é€šè¿‡å‰ç¼€æˆ‘ä»¬å¯ä»¥çŸ¥é“æˆ‘ä»¬æƒ³è¦æ‰¾çš„tupleå‡ºç°åœ¨indexä¸­çš„åŒºé—´ï¼Œå³ä»å°äºæˆ‘ä»¬å‰ç¼€çš„ä½ç½®ï¼Œæ‰«æåˆ°å¤§äºæˆ‘ä»¬å‰ç¼€çš„ä½ç½®ã€‚ä¸‹é¢æ˜¯ä¸¤ä¸ªå‰ç¼€çš„ä¾‹å­:</p><p><img data-src="/images/CMU1544564/Lec07/27.jpg" alt="27.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/28.jpg" alt="28.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/29.jpg" alt="29.jpg"></p><h3 id="åç¼€ä¾‹å­"><a href="#åç¼€ä¾‹å­" class="headerlink" title="åç¼€ä¾‹å­"></a>åç¼€ä¾‹å­</h3><p>æˆ‘ä»¬ç¼ºå¤±ä¸€ä¸ªå‰ç¼€ï¼Œé‚£å°±å°†æ‰€æœ‰çš„å¯èƒ½éƒ½å¡«å…¥å‰ç¼€ã€‚è¿™æ ·ä¼šäº§ç”Ÿå¥½å‡ ä¸ªéœ€è¦æ‰«æçš„åŒºé—´ï¼Œè¿™äº›åŒºé—´çš„ä¸ªæ•°ç­‰äºæ‰€æœ‰å‰ç¼€å¯èƒ½çš„ä¸ªæ•°ã€‚å¦‚ä¸‹å›¾<code>*</code>å¯ä»¥æ˜¯A, B, Cã€€(ä¾‹å­ä¸­åˆå¹¶äº†åé¢ä¸¤ä¸ªåŒºé—´åˆ°ä¸€èµ·)ï¼š</p><p><img data-src="/images/CMU1544564/Lec07/30.jpg" alt="30.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/31.jpg" alt="31.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/32.jpg" alt="32.jpg"></p><p><br></p><h2 id="B-Tree-Design-Choices"><a href="#B-Tree-Design-Choices" class="headerlink" title="B+ Tree Design Choices"></a>B+ Tree Design Choices</h2><p><img data-src="/images/CMU1544564/Lec07/33.jpg" alt="33.jpg"></p><ul><li>ä¸Šå›¾ä¸­çš„é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xNTYxLzE5MDAwMDAwMjg=" title="https://dl.acm.org/doi/10.1561/1900000028">https://dl.acm.org/doi/10.1561/1900000028<i class="fa fa-external-link"></i></span></li><li>è¿™éƒ¨åˆ†éƒ½æ˜¯å®ç°çš„ç»éªŒä¹‹è°ˆ</li></ul><h3 id="Node-size"><a href="#Node-size" class="headerlink" title="Node size"></a>Node size</h3><p><img data-src="/images/CMU1544564/Lec07/34.jpg" alt="34.jpg"></p><ul><li>å¦‚ä¸Šå›¾ä¸­:</li><li>Nodeå¯ä»¥æ˜¯ä¸€ä¸ªpageï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªpage</li><li>åœ¨é€Ÿåº¦æ…¢çš„ç¡¬ä»¶ä¸Šçš„nodeçš„å®¹é‡å»ºè®®ä¼šæ›´å¤§ï¼Œè¿™æ ·å¯ä»¥å‡å°‘I/Oçš„æ¬¡æ•°</li><li>leaf node scan: æ¶‰åŠæ•°é‡å¾ˆå¤šçš„node, æ˜¯sequential I/O</li><li>root-to-leaf traversal: æ¶‰åŠæ•°é‡å¾ˆå°‘çš„node, ä½†æ˜¯æ˜¯random I/O, å› ä¸ºè¿™äº›pageå¾ˆå¤§æ¦‚ç‡ä¸å­˜å‚¨åœ¨ä¸€èµ·</li></ul><p><br></p><ul><li>å¦å¤–indexå’ŒåŸè¡¨æ ¼å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªbuffer pool:</li><li>index buffer page: 1 MiB</li><li>table data buffer page: 8 KiB</li></ul><h3 id="Merge-Threshold"><a href="#Merge-Threshold" class="headerlink" title="Merge Threshold"></a>Merge Threshold</h3><p><img data-src="/images/CMU1544564/Lec07/35.jpg" alt="35.jpg"></p><ul><li>å¦‚ä¸Šå›¾:</li><li>å¦‚æœä¸€ä¸ªnodeä¸­å…ƒç´ å°‘äº<code>M/2 - 1</code>ï¼Œå³æ²¡æœ‰half-full, å‘ç”Ÿunderflowã€‚æˆ‘ä»¬å¯ä»¥è®©è¿™ä¸ªnodeä¿å­˜å­˜åœ¨ï¼Œè€Œä¸å»mergeå®ƒã€‚ç„¶åæ¯ä¸€æ®µæ—¶é—´ï¼Œæ‰¹é‡å¤„ç†B+ treeä¸­æ‰€æœ‰è¿™ç±»çš„nodeã€‚</li></ul><h3 id="Variable-Length-Keys"><a href="#Variable-Length-Keys" class="headerlink" title="Variable Length Keys"></a>Variable Length Keys</h3><p><img data-src="/images/CMU1544564/Lec07/36.jpg" alt="36.jpg"></p><ul><li>å¦‚ä¸Šå›¾:</li><li>Approach 1: Pointersã€€å¤ªæ…¢</li><li>Approach 2: Variable Length Nodesä¸é€‚åˆfix size page</li><li>Approach 3: Padding å¤ªæµªè´¹ç©ºé—´</li><li>Approach 4: Key Map / Indirection æ€§èƒ½è¾ƒå¥½</li></ul><h4 id="Key-Map-Indirection"><a href="#Key-Map-Indirection" class="headerlink" title="Key Map / Indirection"></a>Key Map / Indirection</h4><p>è¿™ä¸ªå°±å’Œslotted pageç±»ä¼¼ï¼Œå°†vaiable lenght keyå­˜åœ¨åŒä¸€ä¸ªpageã€‚</p><p><img data-src="/images/CMU1544564/Lec07/38.jpg" alt="38.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/39.jpg" alt="39.jpg"></p><ul><li>å¦‚ä¸Šå›¾:</li><li>å¯ä»¥åœ¨<code>sorted key map</code>è¿™ä¸ªåŒºåŸŸå­˜ä¸€ä¸ª<strong>é¦–å­—æ¯</strong>ï¼Œè¿™æ ·å¯ä»¥å‡å°‘è·³åˆ°<code>key+values</code>åŒºåŸŸçš„æ¬¡æ•°ã€‚ä¸å¿…æ¯ä¸€ä¸ª<code>key</code>éƒ½å»çœ‹å®ƒçš„å…¨éƒ¨å†…å®¹ã€‚</li></ul><h3 id="Non-Unique-Indexes"><a href="#Non-Unique-Indexes" class="headerlink" title="Non-Unique Indexes"></a>Non-Unique Indexes</h3><p><img data-src="/images/CMU1544564/Lec07/40.jpg" alt="40.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/41.jpg" alt="41.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/42.jpg" alt="42.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/43.jpg" alt="43.jpg"></p><h3 id="Intra-Node-Search"><a href="#Intra-Node-Search" class="headerlink" title="Intra-Node Search"></a>Intra-Node Search</h3><p>Intra-Node SearchæŒ‡åœ¨nodeä¸­æœç´¢ï¼Œå¯ä»¥æƒ³è±¡æˆåœ¨pageä¸­é‚£äº›å·²ç»æ’åºå®Œçš„æ•°æ®ä¸­æœç´¢ï¼š</p><h4 id="Linear"><a href="#Linear" class="headerlink" title="Linear"></a>Linear</h4><p><img data-src="/images/CMU1544564/Lec07/44.jpg" alt="44.jpg"></p><h4 id="Binary-Search"><a href="#Binary-Search" class="headerlink" title="Binary Search"></a>Binary Search</h4><p><img data-src="/images/CMU1544564/Lec07/46.jpg" alt="46.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/47.jpg" alt="47.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/48.jpg" alt="48.jpg"></p><h4 id="Interpolation"><a href="#Interpolation" class="headerlink" title="Interpolation"></a>Interpolation</h4><p>InterpolationæŒ‡æ•°å­—çš„åˆ†å¸ƒå¦‚æœå·²çŸ¥ï¼Œå¯ä»¥ç›´æ¥çŒœåˆ°æƒ³æœçš„<code>key</code>çš„ä½ç½®ã€‚è¿™ä¸ªå±äºç‰¹ä¾‹ï¼Œè€Œä¸”ä¸é€‚ç”¨äºå­—ç¬¦ä¸²ã€‚</p><p><img data-src="/images/CMU1544564/Lec07/49.jpg" alt="49.jpg"></p><p><br><br><br></p><h2 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h2><p><img data-src="/images/CMU1544564/Lec07/50.jpg" alt="50.jpg"></p><h3 id="Prefix-Compression"><a href="#Prefix-Compression" class="headerlink" title="Prefix Compression"></a>Prefix Compression</h3><p>Prefix Compressionå³å­—ç¬¦ä¸²å…±æœ‰çš„å‰ç¼€åªéœ€è¦å­˜å‚¨ä¸€æ¬¡ï¼Œèƒ½é«˜æ•ˆèŠ‚çœå‡ºå­˜å‚¨çš„ç©ºé—´ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é™ä½B+ Treeçš„é«˜åº¦ï¼ŒåŠ å¿«æœç´¢é€Ÿåº¦ã€‚</p><p><img data-src="/images/CMU1544564/Lec07/51.jpg" alt="51.jpg"></p><h3 id="Suffix-Truncation"><a href="#Suffix-Truncation" class="headerlink" title="Suffix Truncation"></a>Suffix Truncation</h3><p>æˆ‘ä»¬åœ¨æœ€å¼€å§‹è¯´è¿‡leaf nodeèµ·åˆ°å­˜å‚¨ä¿¡æ¯çš„ä½œç”¨ï¼Œinner nodeèµ·åˆ°lookupä¸­å¯¼èˆªçš„ä½œç”¨ã€‚å¯¹äºå­—ç¬¦ä¸²ï¼Œinner nodeä¸­æ²¡æœ‰å¿…è¦ä¿å­˜å…¨éƒ¨ï¼Œåªéœ€è¦ä¿å­˜è¶³å¤Ÿçš„å‰ç¼€ï¼Œ<strong>ä¿è¯å¤§äºå°äºçš„å…³ç³»å’Œå¯¼èˆªçš„ä½œç”¨</strong>ã€‚è§ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå®é™…ä¸Š<code>a</code>å’Œ<code>l</code>ä¹Ÿå·²ç»è¶³å¤Ÿ:</p><p><img data-src="/images/CMU1544564/Lec07/52.jpg" alt="52.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/53.jpg" alt="53.jpg"></p><h3 id="Bulk-Insert"><a href="#Bulk-Insert" class="headerlink" title="Bulk Insert"></a>Bulk Insert</h3><p>ä¸€æ¬¡æ¬¡insertæ¥è·å¾—ä¸€ä¸ªB+ Treeå¾ˆæ…¢ã€‚Bulk Insertæ˜¯å°†keyså…ˆæ’åºï¼Œå†å®Œæˆleaf node, å†æ ¹æ®leaf nodeå»å®Œæˆinner nodeã€‚Bulk Insertè®©æˆ‘ä»¬èƒ½æ›´å¿«å»è·å¾—ä¸€ä¸ªB+ Tree:</p><p><img data-src="/images/CMU1544564/Lec07/54.jpg" alt="54.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/55.jpg" alt="55.jpg"></p><h3 id="Pointer-Swizzling"><a href="#Pointer-Swizzling" class="headerlink" title="Pointer Swizzling"></a>Pointer Swizzling</h3><p>æˆ‘ä»¬æ¯ä¸€æ¬¡ä»B+ Treeä¸­éœ€è¦ä¸€ä¸ªpageï¼Œéƒ½éœ€è¦è°ƒç”¨buffer poolä¸­çš„å‡½æ•°ï¼Œç”¨<code>pageid</code>è·å¾—å¯¹åº”pageçš„æŒ‡é’ˆã€‚è¿™ç§é—´æ¥indirectionï¼Œå¸¦æ¥å›ºå®šçš„å¼€é”€ã€‚è€Œæˆ‘ä»¬å¯ä»¥èŠ‚çœè¿™ä¸€éƒ¨åˆ†ï¼Œç‰¹åˆ«åœ¨B+ Treeçš„ä¸Šé¢å‡ å±‚ã€‚å› ä¸ºæ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦ä¸Šé¢å‡ å±‚çš„pageï¼Œå®ƒä»¬å±äºhot pageï¼Œå³å®ƒä»¬ç»å¸¸éœ€è¦æœ‰è¢«è®¿é—®ï¼Œæ¯ä¸€æ¬¡éƒ½æ‰¾buffer poolæ˜¾å¾—èŠ±é”€æ›´å¤§äº†ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠè¿™äº›pageä¸€ç›´ç•™ç€å†…å­˜é‡Œï¼Œç„¶ååœ¨B+_Treeä¸­ç›´æ¥å¸¦ä¸Šå®ƒä»¬å†…å®¹çš„æŒ‡é’ˆï¼Œè¿™æ ·è®¿é—®å®ƒä»¬ä¸éœ€è¦ç»è¿‡buffer poolã€‚è€Œè¿™äº›hot pageçš„æ•°é‡ä¸æ˜¯å¾ˆå¤šï¼Œå®Œå…¨å¯ä»¥é•¿ä¹…ç•™ç€å†…å­˜ä¸­ã€‚(è§<a href="#b+-tree-in-practice">B+ Tree In Practice</a>ä¸­ï¼Œä¸¤å±‚nodeå¤§æ¦‚åœ¨134ä¸ªpage, å 1MiBã€‚)</p><p><img data-src="/images/CMU1544564/Lec07/57.jpg" alt="57.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/58.jpg" alt="58.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/59.jpg" alt="59.jpg"></p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><img data-src="/images/CMU1544564/Lec07/60.jpg" alt="60.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/61.jpg" alt="61.jpg"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Tree Indexes Part I - æ ‘ç´¢å¼• I&lt;/p&gt;
&lt;p&gt;Slide: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA3LXRyZWVzMS5wZGY=&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Note: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDctdHJlZXMxLnBkZg==&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Readings:  Chapter 11.1-11.4&lt;/p&gt;
&lt;p&gt;Database Tree Indexes åœ¨CMUåˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œåœ¨ä¸¤èŠ‚è¯¾ä¸­è®²ã€‚è¿™æ˜¯ç¬¬ä¸€éƒ¨åˆ†ã€‚&lt;/p&gt;
&lt;p&gt;è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“çš„ä¸­ä½¿ç”¨çš„B+æ ‘ï¼Œå®ƒæ•°æ®åº“æœ€é‡è¦çš„æ•°æ®ç»“æ„ã€‚å‡ åå¹´æ¥ï¼Œæ•°æ®åº“çš„å½¢å¼å’ŒæŠ€æœ¯å˜åŒ–å¾ˆå¤§ï¼Œä½†æ˜¯å§‹ç»ˆåšæŒåœ¨ä½¿ç”¨B+æ ‘ä»¥åŠå®ƒçš„å˜å½¢ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Access Methods" scheme="https://cakebytheoceanluo.github.io/categories/Access-Methods/"/>
    
      <category term="B Tree" scheme="https://cakebytheoceanluo.github.io/categories/B-Tree/"/>
    
      <category term="Indexing" scheme="https://cakebytheoceanluo.github.io/categories/Indexing/"/>
    
    
      <category term="Indexing" scheme="https://cakebytheoceanluo.github.io/tags/Indexing/"/>
    
      <category term="B Tree" scheme="https://cakebytheoceanluo.github.io/tags/B-Tree/"/>
    
      <category term="Clustered Index" scheme="https://cakebytheoceanluo.github.io/tags/Clustered-Index/"/>
    
      <category term="Variable Length Key" scheme="https://cakebytheoceanluo.github.io/tags/Variable-Length-Key/"/>
    
      <category term="Prefix Compression" scheme="https://cakebytheoceanluo.github.io/tags/Prefix-Compression/"/>
    
      <category term="Suffix Truncation" scheme="https://cakebytheoceanluo.github.io/tags/Suffix-Truncation/"/>
    
      <category term="Bulk Load (Bulk Insert)" scheme="https://cakebytheoceanluo.github.io/tags/Bulk-Load-Bulk-Insert/"/>
    
      <category term="Pointer Swizzling" scheme="https://cakebytheoceanluo.github.io/tags/Pointer-Swizzling/"/>
    
  </entry>
  
  <entry>
    <title>[CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/</id>
    <published>2020-03-18T18:34:10.000Z</published>
    <updated>2020-03-19T19:51:14.994Z</updated>
    
    <content type="html"><![CDATA[<p>Hash Tables - å“ˆå¸Œè¡¨</p><p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA2LWhhc2h0YWJsZXMucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDYtaGFzaHRhYmxlcy5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf<i class="fa fa-external-link"></i></span><br>Readings: Chapter 11.6-11.7<!-- TODO:link here --></p><p>è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“çš„ä¸­ä½¿ç”¨çš„å“ˆå¸Œè¡¨hash tableï¼Œå®é™…ä¸Šæˆ‘ä»¬æ¶‰åŠçº¯ç®—æ³•è¯¾ä¸­çš„ç†è®ºï¼Œä½†æ›´é‡è¦çš„æ˜¯å·¥ç¨‹å®ç°çš„è§’åº¦ã€‚æ•°æ®åº“ä¸­ä½¿ç”¨çš„hash tableéœ€è¦æœ‰é«˜æ€§èƒ½ï¼Œå¤šçº¿ç¨‹è¯»å†™ï¼Œå†…å­˜è®¿é—®å‹å¥½ã€‚</p><a id="more"></a><p><img data-src="/images/CMU1544564/Lec06/1.jpg" alt="1.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/3.jpg" alt="3.jpg"></p><h1 id="Data-Structure-in-DBMS"><a href="#Data-Structure-in-DBMS" class="headerlink" title="Data Structure in DBMS"></a>Data Structure in DBMS</h1><p><img data-src="/images/CMU1544564/Lec06/4.jpg" alt="4.jpg"></p><ul><li>Internal Metadata: ç”¨äºç®¡ç†æ•°æ®åº“å†…éƒ¨åŸæ•°æ®çš„æ•°æ®ç»“æ„ï¼Œå¦‚ page table, page directory</li><li>Core Data Storage: å­˜å‚¨tuple/è¡¨æ ¼çš„æ•°æ®ç»“æ„, å¦‚ï¼šMemacacheæ•°æ®åº“ç”¨hash table,ã€€MySQLä½¿ç”¨B+æ ‘</li><li>Temporary Data Structures:å¯¹SQL Queryæš‚æ—¶çš„æ•°æ®ç»“æ„ï¼Œå¦‚ä¸€ä¸ªä½¿ç”¨hash joinçš„SQL Queryéœ€è¦æ–°å»ºä¸€ä¸ªhash table,ç„¶åå¯¹å®ƒæŸ¥è¯¢ï¼Œè¿™ä¸ªhash tableæ˜¯æš‚æ—¶çš„ï¼Œå³Queryç»“æŸå°±æ¸…é™¤é‡Šæ”¾</li><li>Table Indexes: è¾…åŠ©å‹ç´¢å¼•æ•°æ®ç»“æ„, ä½¿å¾—æŸ¥è¯¢æ›´å¿«ï¼Œä¸éœ€éå†æ‰€æœ‰tuple</li></ul><p><img data-src="/images/CMU1544564/Lec06/5.jpg" alt="5.jpg"></p><h1 id="Hash-Table-Overview"><a href="#Hash-Table-Overview" class="headerlink" title="Hash Table Overview"></a>Hash Table Overview</h1><p><img data-src="/images/CMU1544564/Lec06/6.jpg" alt="6.jpg"></p><ul><li>ä¸Šå›¾ä¸­ï¼š</li><li>ç©ºé—´å¤æ‚åº¦æ˜¯$O(n)$, hash tableå¹¶ä¸æ˜¯ä¸€ä¸ªèƒ½èŠ‚çœå­˜å‚¨ç©ºé—´çš„æ•°æ®ç»“æ„ã€‚</li><li>æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦:<ul><li>average case: $O(1)$. ä»ç®—æ³•ç†è®ºä¸Šï¼Œå®ƒçš„å¤æ‚åº¦æ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚ä½†åœ¨å·¥ä¸šä¸­ï¼Œä¸€ä¸ªå¸¸æ•°ä¹Ÿæœ‰<strong>å¤§å°</strong>ä¹‹åˆ†ã€‚æ¯”å¦‚<strong>å°çš„å¸¸æ•°æ—¶é—´å¤æ‚åº¦</strong>ä»£è¡¨CPUæŒ‡ä»¤æ•°è¾ƒå°‘ï¼Œè€Œ<strong>å¤§çš„å¸¸æ•°æ—¶é—´å¤æ‚åº¦</strong>ä»£è¡¨CPUæŒ‡ä»¤æ•°è¾ƒå¤šï¼Œå³ä½¿å®ƒä»¬å¯¹åº”çš„CPUæŒ‡ä»¤æ•°éƒ½æ˜¯å¸¸æ•°ï¼Œä½†æ˜¯è¿è¡Œæ—¶é—´è¿˜æ˜¯æœ‰åŒºåˆ«ã€‚</li><li>worst case: $O(n)$ã€‚æ¯”å¦‚hash functionæ•ˆæœå¾ˆä¸å¹³å‡ï¼Œå°†æ‰€æœ‰æŒ‡hashåˆ°äº†ä¸€ä¸ªä½ç½®ï¼Œåè€Œå½¢æˆäº†ä¸€ä¸ªlistã€‚è¿™ç§ä¸å¹³å‡çš„hash functionæ¯”å¦‚æ˜¯ï¼šã€€$f(x) = 1$, å³å¸¸æ•°å‡½æ•°ã€‚</li></ul></li></ul><p><img data-src="/images/CMU1544564/Lec06/7.jpg" alt="7.jpg"></p><ul><li>ä¸Šå›¾ä¸­ï¼š</li><li>f(abc)=0, f(def)=2, f(xyz)=n</li></ul><p><img data-src="/images/CMU1544564/Lec06/8.jpg" alt="8.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/9.jpg" alt="9.jpg"></p><ul><li>ä¸Šå›¾ä¸­çš„ä¸€äº›å‡è®¾æ¥è‡ªäºç®—æ³•ä¸­ç†è®ºéƒ¨åˆ†ï¼Œä½†æ˜¯å®é™…ä¸Šï¼š</li><li>æ²¡æœ‰å†²çªcollisionçš„perfect hash functionåœ¨å¤§æ•°æ®å‰æä¸‹æ˜¯ä¸å­˜åœ¨çš„ã€‚hash collisionæ˜¯ä¸€å®šå‘ç”Ÿçš„ã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec06/10.jpg" alt="10.jpg"></p><ul><li>ä»ä¸Šå›¾ä¸­, hash tableåˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œå®ƒä»¬äº’ç›¸ä¸ä¾èµ–ï¼š</li><li>hash function: å³æˆ‘ä»¬ä¹‹å‰æåˆ°çš„$f$å‡½æ•°, $f (\mathrm{key}) \rightarrow \mathrm{int} \in D$, $D$æ˜¯ä¸€ä¸ªintçš„é›†åˆã€‚æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªhash functionå¾ˆå¿«ï¼Œå¹¶ä¸”å†²çªæ¦‚ç‡å¾ˆä½ï¼š<ul><li>æˆ‘ä»¬ç­¾åæåˆ°çš„$f(x) = 1$å¸¸æ•°å‡½æ•°å¾ˆå¿«ï¼Œä½†æ˜¯å®ƒæŠŠä»»ä½•ä¸€ä¸ªkeyéƒ½åŒ¹é…åˆ°1è¿™ä¸ªä½ç½®ï¼Œå³å®ƒçš„å†²çªæ¦‚ç‡æ˜¯100%,è¿™ä¸ªéå¸¸ä¸å¥½ï¼Œä½¿æˆ‘ä»¬çš„hash tableå˜æˆäº†list,æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å˜æˆäº†$O(n)$çš„average case</li></ul></li><li>hash scheme:ã€€å³å¦‚ä½•å»å¤„ç†ä¸€å®šä¼šå‘ç”Ÿçš„å†²çªã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec06/11.jpg" alt="11.jpg"></p><p><br></p><h1 id="Hash-Function"><a href="#Hash-Function" class="headerlink" title="Hash Function"></a>Hash Function</h1><p><img data-src="/images/CMU1544564/Lec06/12.jpg" alt="12.jpg"></p><ul><li>ä¸Šå›¾ä¸­:</li><li>æˆ‘ä»¬ä¸è€ƒè™‘å¯†ç å­¦cryptographicçš„hash function,ã€€å› ä¸ºæˆ‘ä»¬åªæ˜¯åœ¨æ•°æ®åº“å†…éƒ¨ä½¿ç”¨hash tableï¼Œæ¥<a href="#data-structure-in-dbms">åŠ é€Ÿå¤„ç†æ•°æ®åº“çš„å…ƒæ•°æ®, å­˜å‚¨, join, ç´¢å¼•</a>ã€‚è€Œä¸æ˜¯ç”¨æ¥åŠ å¯†è§£å¯†ä¿¡æ¯ã€‚<strong>æ•°æ®åº“å¸Œæœ›hash functionå¾ˆå¿«ï¼Œå¹¶ä¸”å†²çªæ¦‚ç‡å¾ˆä½ã€‚</strong></li></ul><p><img data-src="/images/CMU1544564/Lec06/13.jpg" alt="13.jpg"></p><ul><li>CRC-64: <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGUuc3RlcGhhbi1icnVtbWUuY29tL2NyYzMyLw==" title="https://create.stephan-brumme.com/crc32/">https://create.stephan-brumme.com/crc32/<i class="fa fa-external-link"></i></span></li><li>MurmurHash: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FhcHBsZWJ5L3NtaGFzaGVy" title="https://github.com/aappleby/smhasher">https://github.com/aappleby/smhasher<i class="fa fa-external-link"></i></span></li><li>Google CityHash: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9jaXR5aGFzaA==" title="https://github.com/google/cityhash">https://github.com/google/cityhash<i class="fa fa-external-link"></i></span></li><li>Facebook XXHash: <span class="exturl" data-url="aHR0cHM6Ly9jeWFuNDk3My5naXRodWIuaW8veHhIYXNoLw==" title="https://cyan4973.github.io/xxHash/">https://cyan4973.github.io/xxHash/<i class="fa fa-external-link"></i></span></li><li>Google FarmHash: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9mYXJtaGFzaA==" title="https://github.com/google/farmhash">https://github.com/google/farmhash<i class="fa fa-external-link"></i></span></li></ul><!-- TODO --><p><img data-src="/images/CMU1544564/Lec06/14.jpg" alt="14.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/15.jpg" alt="15.jpg"></p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FwYXZsby9oYXNoLWZ1bmN0aW9uLWJlbmNobWFyaw==" title="https://github.com/apavlo/hash-function-benchmark">https://github.com/apavlo/hash-function-benchmark<i class="fa fa-external-link"></i></span></li></ul><p><br></p><p>å¦å¤–è¿˜æœ‰ä¸€ç§Fibonacci Hashing, æ¨èé˜…è¯»: <span class="exturl" data-url="aHR0cHM6Ly9wcm9iYWJseWRhbmNlLmNvbS8yMDE4LzA2LzE2L2ZpYm9uYWNjaS1oYXNoaW5nLXRoZS1vcHRpbWl6YXRpb24tdGhhdC10aGUtd29ybGQtZm9yZ290LW9yLWEtYmV0dGVyLWFsdGVybmF0aXZlLXRvLWludGVnZXItbW9kdWxvLw==" title="https://probablydance.com/2018/06/16/fibonacci-hashing-the-optimization-that-the-world-forgot-or-a-better-alternative-to-integer-modulo/">https://probablydance.com/2018/06/16/fibonacci-hashing-the-optimization-that-the-world-forgot-or-a-better-alternative-to-integer-modulo/<i class="fa fa-external-link"></i></span></p><p><br></p><h1 id="Static-Hashing-Schemes"><a href="#Static-Hashing-Schemes" class="headerlink" title="Static Hashing Schemes"></a>Static Hashing Schemes</h1><p>Static Hashing Schemesæ­£å¦‚staicæ‰€è¯´ï¼Œè¿™ç§schemeä¸‹çš„hash tableçš„å®¹é‡æ˜¯å›ºå®šçš„ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨hashçš„åŒæ—¶ï¼Œå‘ç°å®¹é‡ä¸å¤Ÿï¼Œåªèƒ½resizeåˆ°æ›´å¤§çš„å®¹é‡ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰çš„keyå†é‡æ–°hashè¿›æ‰©å¤§å®¹é‡çš„hash tableã€‚è¿™ç§resizeåœ¨static hashing schemeæ„å‘³è€…rehashingï¼Œè¿™ä¸ªæ“ä½œå¯¹æ€§èƒ½æ¥è¯´æ˜¯ç¾éš¾çº§åˆ«çš„ã€‚å¾ˆæ˜¾ç„¶å¦‚æœæˆ‘ä»¬èƒ½ä¸€å¼€å§‹å°±çŸ¥é“<strong>åˆé€‚çš„å®¹é‡</strong>,ã€€å°±èƒ½ç›´æ¥é¿å…è¿™éƒ¨åˆ†çš„æµªè´¹æ—¶é—´ã€‚å¦‚ä½•å¯»æ‰¾åˆé€‚çš„å®¹é‡ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œcardinality estimationåŸºæ•°ä¼°è®¡ã€‚è¿™ä¸ªéƒ¨åˆ†åé¢ä¼šæåˆ°ã€‚<!-- TODO: --></p><blockquote><p>A static hashing scheme is one where the size of the hash table is fixed. This means that if the DBMS runs out of storage space in the hash table, then it has to rebuild it from scratch with a larger table. Typically the new hash table is twice the size of the original hash table.</p></blockquote><p><img data-src="/images/CMU1544564/Lec06/16.jpg" alt="16.jpg"></p><h2 id="Linear-Probe-Hashing"><a href="#Linear-Probe-Hashing" class="headerlink" title="Linear Probe Hashing"></a>Linear Probe Hashing</h2><p>Linear Probe Hashingæ˜¯open address hashingçš„ä¸€ç§ã€‚</p><p>Linear Probingæ–¹å¼è™½ç„¶ç®€å•ï¼Œä½†å¹¶ä¸æ˜¯è§£å†³å†²çªçš„æœ€å¥½çš„ç­–ç•¥ï¼Œå› ä¸ºå®ƒä¼šå¯¼è‡´<strong>åŒç±»å“ˆå¸Œçš„èšé›†(Primary Clustering)</strong>ã€‚è¿™å¯¼è‡´æœç´¢å“ˆå¸Œè¡¨æ—¶ï¼Œå†²çªä¾ç„¶å­˜åœ¨ã€‚å¦‚æœæˆ‘ä»¬è¦è®¿é—® Edward çš„ä¿¡æ¯ï¼Œå› ä¸º Edward çš„ç¤¾ä¿å· 111-00-1235 å“ˆå¸Œä¸º 1235ï¼Œç„¶è€Œæˆ‘ä»¬åœ¨ 1235 ä½ç½®æ‰¾åˆ°çš„æ˜¯ Bobï¼Œæ‰€ä»¥å†æœç´¢ 1236ï¼Œæ‰¾åˆ°çš„å´æ˜¯ Dannyï¼Œä»¥æ­¤ç±»æ¨ç›´åˆ°æ‰¾åˆ° Edwardã€‚<sup><a href="#fn2">2</a></sup></p><p><img data-src="/images/CMU1544564/Lec06/17.jpg" alt="17.jpg"></p><blockquote><ul><li>To see if value is present, go to slot using hash, and scan for the key. The scan stops if you find the desired key or you encounter an empty slot.</li></ul></blockquote><h3 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h3><p>hash tableå­˜å‚¨ä¸ä»…ä»…æ˜¯<code>value</code>ï¼Œè€Œæ˜¯<code>(key, value)</code>è¿™ä¸€å¯¹ã€‚è¿™æ˜¯å› ä¸ºLinear Probe Hashingä¼šé‡åˆ°å†²çªï¼Œåœ¨æŸ¥è¯¢æ—¶éœ€è¦æ¯”è¾ƒkeyæ¥ç¡®å®šæ˜¯å¦æ‰¾åˆ°(keyç›¸ç­‰)æˆ–è€…åªæ˜¯ä¸€æ¬¡å†²çª(keyä¸ç›¸ç­‰)ã€‚</p><p><img data-src="/images/CMU1544564/Lec06/18.jpg" alt="18.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/19.jpg" alt="19.jpg"></p><p>ä¸‹å›¾ä¸­Cå’ŒAçš„hashä½ç½®ç›¸åŒ(å†²çª), æˆ‘ä»¬å°†Cå†™åœ¨Açš„åé¢ï¼Œå¹¶Aè¿æ¥Cï¼š<br><img data-src="/images/CMU1544564/Lec06/20.jpg" alt="20.jpg"></p><p>ä¸‹å›¾ä¸­Då’ŒCçš„hashä½ç½®ç›¸åŒ(å†²çª), æˆ‘ä»¬å°†Då†™åœ¨Cçš„åé¢ï¼Œå¹¶Cè¿æ¥Dï¼š<br><img data-src="/images/CMU1544564/Lec06/21.jpg" alt="21.jpg"></p><p>ä¸‹å›¾ä¸­Eå’ŒA/Cçš„hashä½ç½®ç›¸åŒ(å†²çª), æˆ‘ä»¬å°†Eå†™åœ¨Cçš„åé¢ï¼Œ<strong>ä½†æ˜¯Cåé¢è¢«Då æœ‰äº†</strong>ï¼Œæ‰€æœ‰å°†Eå†™åœ¨Dåé¢,å¹¶Dè¿æ¥Eï¼š<br><img data-src="/images/CMU1544564/Lec06/22.jpg" alt="22.jpg"></p><p>ä¸‹å›¾ä¸­Få’ŒEçš„hashä½ç½®ç›¸åŒ(å†²çª), æˆ‘ä»¬å°†Få†™åœ¨Eçš„åé¢ï¼Œå¹¶Eè¿æ¥Fï¼š<br><img data-src="/images/CMU1544564/Lec06/23.jpg" alt="23.jpg"></p><h3 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h3><h4 id="Delete-C"><a href="#Delete-C" class="headerlink" title="Delete C"></a>Delete C</h4><p>ä¸‹å›¾ä¸­æˆ‘ä»¬æƒ³åˆ é™¤C, æˆ‘ä»¬å·²ç»è§åˆ°Cå’ŒAå†²çªã€‚æˆ‘ä»¬çœ‹ç¬¬ä¸€ä¸ªä½ç½®æ˜¯keyæ˜¯A, è€ŒA!=C, ç„¶åå¾€ä¸‹çœ‹ï¼š<br><img data-src="/images/CMU1544564/Lec06/24.jpg" alt="24.jpg"></p><p>ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬å‘ç°åœ¨ç¬¬äºŒä¸ªä½ç½®, hash tableæ¡ç›®ä¸­çš„keyæ˜¯Cï¼Œè€Œæˆ‘ä»¬å°±åƒåˆ å»C, C==Cã€‚è¿™ä¸ªæ¡ç›®è¢«åˆ é™¤ï¼š<br><img data-src="/images/CMU1544564/Lec06/25.jpg" alt="25.jpg"></p><h4 id="Find-D-after-deletion-of-C"><a href="#Find-D-after-deletion-of-C" class="headerlink" title="Find D after deletion of C"></a>Find D after deletion of C</h4><p>ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬æƒ³å¯»æ‰¾Dã€‚ç”±äºä¹‹å‰Då’ŒCçš„hashä½ç½®ç›¸åŒ(å†²çª)ï¼Œè€ŒCå·²ç»è¢«åˆ é™¤ï¼ŒDå¤±å»äº†å’ŒCçš„è”ç³»ã€‚å¯¼è‡´æˆ‘ä»¬ä¸èƒ½æ‰¾åˆ°Dï¼š<br><img data-src="/images/CMU1544564/Lec06/26.jpg" alt="26.jpg"></p><h5 id="Approach1-Tombstone"><a href="#Approach1-Tombstone" class="headerlink" title="Approach1: Tombstone"></a>Approach1: Tombstone</h5><p>è§£å†³ä¸Šè¿°é—®é¢˜çš„ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª<em>å¢“ç¢‘</em>:ã€€åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ é™¤äº†Cï¼Œä½†æ˜¯ç•™ä¸‹äº†ä¸€ä¸ªCçš„å¢“ç¢‘ï¼Œå¢“ç¢‘ä¾ç„¶ä¿ç•™ç€åˆ°Dçš„è”ç³»é“¾æ¥ã€‚é€šè¿‡è¿™ä¸ªå¢“ç¢‘çš„é“¾æ¥æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°D:<br><img data-src="/images/CMU1544564/Lec06/27.jpg" alt="27.jpg"></p><p>è¿™ç§ä½œæ³•çš„ç¼ºç‚¹æ˜¯ï¼šä¿å­˜å¢“ç¢‘ä¼šå æœ‰ç©ºé—´ã€‚</p><h5 id="Approach2-Movement"><a href="#Approach2-Movement" class="headerlink" title="Approach2: Movement"></a>Approach2: Movement</h5><p>è§£å†³ä¸Šè¿°é—®é¢˜çš„ç¬¬äºŒç§æ–¹æ³•æ˜¯<em>ç§»åŠ¨</em>ï¼šå³åˆ é™¤ä¸€ä¸ªæ¡ç›®ä¹‹åï¼Œå¯¹hash tableä¸­å’Œå·²è¢«åˆ é™¤æ¡ç›®æœ‰è”ç³»çš„æ¡ç›®è¿›è¡Œç§»åŠ¨ï¼Œç§»åŠ¨è‡³æ­£ç¡®çš„åœ°æ–¹ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œåªèƒ½ç§»åŠ¨å’Œå·²è¢«åˆ é™¤<strong>æœ‰è”ç³»çš„æ¡ç›®</strong> (Bå’ŒFå¹¶ä¸æ›¾ç¢°æ’å†²çªï¼Œä½†æ˜¯Båœ¨å¦‚ä¸‹ä¾‹å­ä¸åº”è¯¥è¢«ç§»åŠ¨):</p><p><img data-src="/images/CMU1544564/Lec06/28.jpg" alt="28.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/29.jpg" alt="29.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/30.jpg" alt="30.jpg"></p><p>ä¸‹å›¾ä¸­æ£€æŸ¥Bæ˜¯å¦å’Œè¢«åˆ é™¤çš„æ¡ç›®Cå­˜åœ¨è”ç³»ï¼Œå‘ç°Bå°±åœ¨å®ƒè‡ªå·±åº”è¯¥åœ¨çš„åœ°æ–¹ï¼Œè€Œå’Œå…¶ä»–æ¡ç›®æ— ä»»ä½•è”ç³»ï¼Œå› æ¬¡ä¸ç§»åŠ¨Bã€‚<strong>æ— è§†é‚£ä¸ªä»ä¸Šåˆ°ä¸‹çš„ç®­å¤´</strong>:<br><img data-src="/images/CMU1544564/Lec06/31.jpg" alt="31.jpg"></p><p>è¿™ç§ä½œæ³•çš„ç¼ºç‚¹æ˜¯:åˆ é™¤ä¼šå˜å¾—éå¸¸éº»çƒ¦ã€‚</p><p><br></p><p>è¿™é‡Œæä¸€ä¸‹ï¼Œåœ¨hash joinä¸­ï¼Œæˆ‘ä»¬åªç”¨insertå’Œfindè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œè€Œä¸ç”¨deleteã€‚å¯¹äºhash joinè¿™ä¸­æ“ä½œå¯ä»¥æ— è§†åˆ é™¤ä¼šå¯¼è‡´çš„ç¼ºç‚¹ã€‚</p><p>ä½†æ˜¯åœ¨indexç´¢å¼•ä¸­ï¼Œinsert, find, deleteè¿™äº›æ“ä½œéƒ½è¢«éœ€è¦ã€‚</p><h3 id="Non-Unique-Keys"><a href="#Non-Unique-Keys" class="headerlink" title="Non-Unique Keys"></a>Non-Unique Keys</h3><p>æœ‰ä¸¤ç§å¤„ç†<strong>é‡å¤key</strong>çš„æ–¹å¼:</p><ul><li>value listå­˜å‚¨é‡å¤keyæ‰€æ‹¥æœ‰çš„value</li><li>å­˜å‚¨keyå’Œvalueï¼Œè¿™æ ·å³ä½¿keyé‡å¤,valueå€¼ä¹Ÿä¸ä¸€æ ·ã€‚<strong>è¿™ç§æ–¹å¼æ›´åŠ å¸¸è§ã€‚</strong><br><img data-src="/images/CMU1544564/Lec06/32.jpg" alt="32.jpg"></li></ul><p><br></p><h2 id="Robin-Hood-Hashing"><a href="#Robin-Hood-Hashing" class="headerlink" title="Robin Hood Hashing"></a>Robin Hood Hashing</h2><p>Robin Hood Hashingå’ŒLinear Probe Hashingç›¸æ¯”ï¼Œæ›´å¯ä»¥å»å¹³è¡¡å†²çªï¼Œè®©å†²çªçš„keyç¦»å®ƒåº”è¯¥æ‹¥æœ‰çš„ä½ç½®(optimal position)è¿‘ä¸€äº›ã€‚æ­£å¦‚å®ƒçš„åå­—ä¸€æ ·ï¼Œç½—å®¾æ±‰ï¼ŒåŠ«å¯Œæµè´«ï¼Œè§£å†³badcaseã€‚</p><p><img data-src="/images/CMU1544564/Lec06/33.jpg" alt="33.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/34.jpg" alt="34.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/35.jpg" alt="35.jpg"></p><p>ä¸‹å›¾ä¸­, Cä¸Aå†²çªäºçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„ä½ç½®ã€‚</p><ul><li>è¿™æ—¶Aç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0, Cç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0ã€‚ä¸¤å€¼ç›¸ç­‰ï¼ŒCä¸èƒ½è·å¾—Açš„ä½ç½®ã€‚</li><li>Cè·å¾—Aåé¢ç©ºçš„ä½ç½®ï¼ŒCç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ï¼š<br><img data-src="/images/CMU1544564/Lec06/36.jpg" alt="36.jpg"></li></ul><p><br></p><p>ä¸‹å›¾ä¸­, Dä¸Cå†²çªäºçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„ä½ç½®ã€‚</p><ul><li>è¿™æ—¶Cç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1, Dç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0ã€‚Dçš„è·ç¦»å€¼å°äºCçš„è·ç¦»å€¼ï¼ŒDä¸èƒ½è·å¾—Cçš„ä½ç½®ã€‚</li><li>Dè·å¾—Cåé¢ç©ºçš„ä½ç½®ï¼ŒDç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ï¼š<br><img data-src="/images/CMU1544564/Lec06/37.jpg" alt="37.jpg"></li></ul><p><br></p><p><strong>ä¸‹ä¸¤å¼ å›¾ä¸­</strong>, Eä¸Aå†²çªäºçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„ä½ç½®ã€‚</p><ul><li>è¿™æ—¶Aç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0, Eç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0ã€‚ä¸¤å€¼ç›¸ç­‰ï¼ŒEä¸èƒ½è·å¾—Açš„ä½ç½®ã€‚</li><li>Eè·å¾—Aåé¢ç©ºçš„ä½ç½®ï¼Œç„¶åEä¸Cå†²çªã€‚</li><li>è¿™æ—¶Cç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1, Eç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ã€‚ä¸¤å€¼ç›¸ç­‰ï¼ŒEä¸èƒ½è·å¾—Cçš„ä½ç½®ã€‚</li><li>Eè·å¾—Cåé¢ç©ºçš„ä½ç½®ï¼Œç„¶åEä¸Då†²çªã€‚è¿™æ—¶Dç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1, Eç¦»å®ƒçš„optimal postionè·ç¦»ä¸º2ã€‚<strong>Eçš„è·ç¦»å€¼å¤§äºDçš„è·ç¦»å€¼ï¼ŒEè·å¾—Dçš„ä½ç½®ã€‚</strong></li><li>Dåªèƒ½å‘åç§»åŠ¨ï¼ŒåŒæ—¶ä¹Ÿæ›´æ–°è‡ªå·±ç¦»è‡ªå·±optimal positionçš„è·ç¦»:<br><img data-src="/images/CMU1544564/Lec06/38.jpg" alt="38.jpg"></li></ul><p><img data-src="/images/CMU1544564/Lec06/39.jpg" alt="39.jpg"></p><p><br></p><p>ä¸‹å›¾ä¸­, Fä¸Då†²çªäºçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„ä½ç½®ã€‚</p><ul><li>è¿™æ—¶Dç¦»å®ƒçš„optimal postionè·ç¦»ä¸º2, Fç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ã€‚Fçš„è·ç¦»å€¼å°äºDçš„è·ç¦»å€¼ï¼ŒFä¸èƒ½è·å¾—Dçš„ä½ç½®ã€‚</li><li>Fè·å¾—Dåé¢ç©ºçš„ä½ç½®ï¼ŒFç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ï¼š<br><img data-src="/images/CMU1544564/Lec06/40.jpg" alt="40.jpg"></li></ul><p><br></p><p>æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ç»“æœï¼š</p><ul><li>Linear Probe Hashing: Dåœ¨Eçš„ä¸Šé¢ã€‚Dç¦»è‡ªå·±optimal positionè·ç¦»ä¸º1,Eç¦»è‡ªå·±optimal positionè·ç¦»ä¸º3ã€‚</li><li>Robin Hood Hashing:ã€€Eåœ¨Dçš„ä¸Šé¢ã€‚Dç¦»è‡ªå·±optimal positionè·ç¦»ä¸º2,Eç¦»è‡ªå·±optimal positionè·ç¦»ä¸º2ã€‚</li></ul><p>Robin Hood Hashingå¹³å‡äº†ä¸€ä¸‹å„ä¸ªkeyç¦»è‡ªå·±optimal positionçš„è·ç¦»ã€‚ä½†æ˜¯å®ƒåœ¨insertçš„æ—¶å€™ï¼Œæœ‰å¯èƒ½ä¼šè°ƒæ•´å…¶ä»–æ¡ç›®çš„ä½ç½®, åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œåœ¨insert Eçš„æ—¶å€™è°ƒæ•´äº†Dçš„ä½ç½®ã€‚è¯´æ˜å®ƒä¼šéœ€è¦æ›´å¤šwrite operationçš„æ¬¡æ•°ï¼Œå¦å¤–åœ¨insertçš„æ—¶å€™å®ƒä¹Ÿæœ‰æ›´å¤šæ¡ä»¶éœ€è¦æ£€æŸ¥ï¼Œè¿™ä¼šé€ æˆæ›´å¤šçš„branch miss predictionã€‚</p><p>å®é™…å®ç°ä¸ŠLinear Probe Hashingæ›´ä¸ºå¸¸è§ã€‚</p><p><br></p><h2 id="Cuckoo-Hashing"><a href="#Cuckoo-Hashing" class="headerlink" title="Cuckoo Hashing"></a>Cuckoo Hashing</h2><p>Cuckoo Hashingä½¿ç”¨å¤šä¸ªhash table, æ¯ä¸ªhash tableæ‹¥æœ‰è‡ªå·±çš„hash function (hash function seed)ã€‚æˆ‘ä»¬ä¸‹é¢çš„ä¾‹å­æ˜¯ç”¨ä¸¤ä¸ªè¡¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨ä¸‰ä¸ªæ¥å®ç°Cuckoo Hashingã€‚</p><blockquote><p>The hash functions are the same algorithm (e.g., XXHash, CityHash); they generate different hashes for the same key by using different seed values.</p></blockquote><p>insert: </p><ul><li>æ€»å‘æœ‰ç©ºä½ç½®(optimal position)çš„hash tableæ’å…¥ã€‚å¦‚æœå¤šä¸ªhash tableéƒ½æœ‰ç©ºä½ç½®å¯ä»¥æ’å…¥ï¼Œéšæ„é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªå³å¯ã€‚</li><li>å¦‚æœæ‰€æœ‰çš„hash tableéƒ½æ²¡æœ‰ç©ºä½ç½®å¯ä»¥æ’å…¥ã€‚éšæœºé€‰æ‹©ä¸€ä¸ªhash tableä¸­å¯¹åº”çš„ä½ç½®æ’å…¥,ã€€å¹¶å–å‡ºåŸæ¥åœ¨è¿™ä½ç½®ä¸Šçš„key, å°†å®ƒinsertåˆ°å…¶ä»–çš„hash tableã€‚</li></ul><p>ä¼˜ç‚¹æ˜¯æŸ¥è¯¢å¿«ï¼Œè·¯å¾„çŸ­ï¼Œæœ€å¤šä¸¤æ¬¡å°±èƒ½æŸ¥è¯¢åˆ°ã€‚</p><p>ç¼ºç‚¹æ˜¯æ’å…¥æ€§èƒ½å·®ï¼Œåœ¨å®¹é‡å°çš„æƒ…å†µä¸‹å¾ˆå®¹æ˜“å†²çªã€‚è¿é”çš„å†²çªä¼šé™·å…¥æ­»å¾ªç¯, è§£å†³åªèƒ½å¢åŠ å®¹é‡å¹¶ä¸”rehashã€‚</p><p><img data-src="/images/CMU1544564/Lec06/41.jpg" alt="41.jpg"></p><p>ä¸‹å›¾ä¸­ï¼ŒAå¯¹åº”çš„ä½ç½®éƒ½æ˜¯ç©ºçš„ï¼ŒAå¯ä»¥è¢«æ’å…¥è‡³ä»»ä½•ä¸€ä¸ªhash tableï¼Œä¾‹å­ä¸­é€‰æ‹©äº†#1:<br><img data-src="/images/CMU1544564/Lec06/42.jpg" alt="42.jpg"></p><p><br></p><p>ä¸‹å›¾ä¸­ï¼ŒBå¯¹åº”çš„ä½ç½®åªæœ‰åœ¨#2æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆæ’å…¥è‡³#2:<br><img data-src="/images/CMU1544564/Lec06/43.jpg" alt="43.jpg"></p><p><br></p><p>ä¸‹é¢å‡ å¼ å›¾ä¸­ï¼Œ</p><ul><li>Cå¯¹åº”çš„ä½ç½®<strong>éƒ½ä¸æ˜¯ç©ºçš„</strong>ï¼ŒCå¯ä»¥é€‰æ‹©ä»»ä½•ä¸€ä¸ªhash tableï¼Œä»£æ›¿å æœ‰ä½ç½®çš„keyï¼Œä¾‹å­ä¸­é€‰æ‹©äº†#2, å³ä»£æ›¿äº†B</li><li>Bè¢«rehashåˆ°#1ï¼Œåœ¨#1ä¸­Bå¯¹åº”çš„ä½ç½®ä¹Ÿä¸æ˜¯ç©ºçš„ï¼ŒBä»£æ›¿å æœ‰ä½ç½®çš„key A</li><li>Aè¢«rehashåˆ°#2, åœ¨#2ä¸­å¯¹åº”çš„ä½ç½®æ˜¯ç©ºçš„ï¼š<br><img data-src="/images/CMU1544564/Lec06/44.jpg" alt="44.jpg"></li></ul><p><img data-src="/images/CMU1544564/Lec06/45.jpg" alt="45.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/46.jpg" alt="46.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/47.jpg" alt="47.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/48.jpg" alt="48.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/49.jpg" alt="49.jpg"></p><p><br></p><p>åœ¨Cuckoo Hashingä¸­<strong>æœ‰å¯èƒ½ä¸ç»ˆæ­¢</strong>ï¼Œå³è¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæ°¸è¿œæ‰¾ä¸åˆ°èƒ½æ’å…¥çš„åœ°æ–¹ã€‚è¿™æ—¶å€™è¯´æ˜hash tableå®¹é‡å¤ªå°ï¼Œéœ€è¦<code>resize</code>åˆ°æ›´å¤§çš„å®¹é‡ã€‚</p><blockquote><p> If we find a cycle, then we can rebuild all of the hash tables with new hash function seeds (less common) or rebuild the hash tables using larger tables (more common).</p></blockquote><h1 id="Dynamic-Hashing-Schemes"><a href="#Dynamic-Hashing-Schemes" class="headerlink" title="Dynamic Hashing Schemes"></a>Dynamic Hashing Schemes</h1><p>Dynamic Hashing Schemesçš„ç‰¹å¾å°±æ˜¯åœ¨èƒ½æŒç»­å®¹é‡å¢é•¿ï¼Œè€Œä¸éœ€è¦é¢å¤–rehashã€‚å³resizeçš„æ“ä½œèŠ±é”€ä¸å¤§ã€‚</p><p><img data-src="/images/CMU1544564/Lec06/50.jpg" alt="50.jpg"></p><h2 id="Chained-Hashing"><a href="#Chained-Hashing" class="headerlink" title="Chained Hashing"></a>Chained Hashing</h2><p>Chained Hashingåˆç§°Hashing with Chainingã€‚ç‰¹å¾æ˜¯æ¯ä¸€ä¸ªhash tableä¸­çš„æ¡ç›®éƒ½æ˜¯ä¸€ä¸ªlinked list of bucketã€‚å¦‚æœbucketæ»¡äº†ï¼Œé‚£å°±å†æŒ‡å‘ä¸€ä¸ªæ–°çš„bucketã€‚</p><p><strong>è¿™é‡Œçš„bucketå¯ä»¥å…·è±¡æˆä¸€ä¸ªpageã€‚</strong></p><p>ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œä¸éœ€è¦resizeã€‚</p><p>ç¼ºç‚¹æ˜¯æ¯ä¸€ä¸ªlinked listå¦‚æœå¾ˆé•¿, å°±å˜æˆ$O(n)$ã€‚</p><p><img data-src="/images/CMU1544564/Lec06/51.jpg" alt="51.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/52.jpg" alt="52.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/53.jpg" alt="53.jpg"></p><h2 id="Extendible-Hashing"><a href="#Extendible-Hashing" class="headerlink" title="Extendible Hashing"></a>Extendible Hashing</h2><ul><li>global <code>n bit</code>: æŒ‡keyä¸­å‰nä¸ªbitæ˜¯å¯¹å·¦ä¾§directoryæœ‰æ•ˆã€‚</li><li>local <code>m bit</code>: æŒ‡globalä¸­<code>n bit</code>ä¸­çš„å‰<code>m</code>ä¸ªbit<strong>åœ¨è¿™ä¸€ä¸ªbucket</strong>æœ‰æ•ˆã€‚</li><li>$n \geq m$æ’æˆç«‹</li><li>å¦‚æœlocal bucketæ»¡äº†(overflow)ï¼Œé‚£å°±å¢åŠ ä¸€ä¸ªlocal bitå»å®¹çº³æ›´å¤šã€‚å¦‚æœ$n=m$ï¼Œé‚£å°±å…ˆå¢åŠ ä¸€ä¸ªglobal bitï¼Œå†å¢åŠ local bitã€‚ä½¿$n \geq m$æ¡ä»¶ä¾ç„¶æˆç«‹</li></ul><p><img data-src="/images/CMU1544564/Lec06/54.jpg" alt="54.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/55.jpg" alt="55.jpg"></p><h3 id="Find-A"><a href="#Find-A" class="headerlink" title="Find A"></a>Find A</h3><p><img data-src="/images/CMU1544564/Lec06/56.jpg" alt="56.jpg"></p><h3 id="Insert-B-No-Overflow"><a href="#Insert-B-No-Overflow" class="headerlink" title="Insert B - No Overflow"></a>Insert B - No Overflow</h3><p><img data-src="/images/CMU1544564/Lec06/57.jpg" alt="57.jpg"></p><h3 id="Insert-C-Overflow"><a href="#Insert-C-Overflow" class="headerlink" title="Insert C - Overflow"></a>Insert C - Overflow</h3><p>Cå¯¹åº”çš„local bucketå·²ç»æ»¡äº†ï¼Œå¦å¤–local bit = global bit = 2</p><p>æˆ‘ä»¬æ­£å¦‚å‰é¢ä»‹ç»çš„ï¼Œå…ˆå¢åŠ global bitåˆ°3, å†å°†local bitå¢åŠ åˆ°3, æœ€åinsert Cã€‚</p><p><img data-src="/images/CMU1544564/Lec06/58.jpg" alt="58.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/59.jpg" alt="59.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/60.jpg" alt="60.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/61.jpg" alt="61.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/62.jpg" alt="62.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/63.jpg" alt="63.jpg"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªä¸Šè¯¾é—®é¢˜å¼•å‘çš„è®¨è®ºã€‚ç»“æœæ˜¯extendible hash tableçš„<code>resize</code>æ“ä½œæ˜¯å¾ˆç®€å•å»‰ä»·çš„ã€‚å·¦ä¾§çš„directoryæ˜¯ä¸€ä¸ªarray of pointeræˆ–è€…array of page idã€‚ç”¨latchä¿æŠ¤è¿™ä¸ªarray,ã€€ç„¶åæ‰©å¤§å®ƒçš„å®¹é‡ï¼Œå¤åˆ¶åŸæ¥çš„å†…å®¹è¿›å…¥ä»¥åï¼Œå°±å¯ä»¥è§£å¼€latchäº†ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸æ¶‰åŠrehashå’Œå¤§é‡çš„æ•°æ®å¤åˆ¶ï¼Œå› æ­¤å¾ˆå¿«é€Ÿã€‚</p><!-- TODO: TUM GDB é¢˜ç›® --><h2 id="Linear-Hashing"><a href="#Linear-Hashing" class="headerlink" title="Linear Hashing"></a>Linear Hashing</h2><p>Linear Hashingçš„ç›®çš„æ˜¯ä¸åœ¨<code>resize</code>çš„æ—¶å€™ç”¨ä¸€ä¸ªglobal latchï¼Œæ¥æé«˜æ€§èƒ½ã€‚æˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢ä¾‹å­ä¸­çœ‹å‡ºï¼Œåœ¨Linear Hashingä¸­åªéœ€è¦å»latchä¸€ä¸ªä½ç½®, å³<code>split pointer</code>æ‰€æŒ‡çš„åœ°æ–¹ã€‚</p><p>ä½œæ³•æ˜¯æŒ‰ç…§<em>é¡ºåº</em>å»åˆ†è£‚bucketï¼Œè€Œä¸æ˜¯åˆ†è£‚ç‰¹å®šæ»¡çš„bucketã€‚é¡ºåºå®é™…ä¸Šåªæ˜¯bucket idé¡ºåºï¼Œæœ‰ä¸€ä¸ª<code>split pointer</code>å»è·Ÿè¸ªä¸‹ä¸€ä¸ªéœ€è¦åˆ†è£‚çš„bucketã€‚è€Œä¸”Linear Hashingä½¿ç”¨å¤šä¸ªhash functionã€‚</p><blockquote><p>Instead of immediately splitting a bucket when it overflows, this scheme maintains a split pointer that keeps track of the next bucket to split. No matter whether this pointer is pointing to the bucket that overflowed, the DBMS always splits. The overflow criterion is left up to the implementation</p></blockquote><p>å…·ä½“æè¿°å’Œå’ŒJavaå®ç°ï¼Œè§ä¸€ç¯‡åˆ«äººçš„åšå®¢: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYmYyNDAwNzg2ZjY=" title="https://www.jianshu.com/p/0bf2400786f6">https://www.jianshu.com/p/0bf2400786f6<i class="fa fa-external-link"></i></span></p><p><img data-src="/images/CMU1544564/Lec06/64.jpg" alt="64.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/65.jpg" alt="65.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/66.jpg" alt="66.jpg"></p><h3 id="Find-6"><a href="#Find-6" class="headerlink" title="Find 6"></a>Find 6</h3><p><img data-src="/images/CMU1544564/Lec06/67.jpg" alt="67.jpg"></p><p><br></p><h3 id="Insert-17-Overflow"><a href="#Insert-17-Overflow" class="headerlink" title="Insert 17 - Overflow"></a>Insert 17 - Overflow</h3><ul><li>Overflowçš„bucketåé¢ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„bucketã€‚</li><li><code>split pointer</code>æ‰€æŒ‡çš„bucketä¼šè¿›è¡Œåˆ†è£‚ï¼Œåˆ†è£‚æˆä¸¤ä¸ªbucketï¼ŒåŸå†…å®¹é‡æ–°ç”¨æ–°çš„hash functionï¼Œå†åˆ†é…åŸå†…å®¹åˆ°æ–°æ—§ä¸¤ä¸ªbucketã€‚ä¸‹é¢ä¾‹å­ä¸­:<ul><li>$\mathrm{hash_2}(8) = 8 \% 8 = 0 \; \rightarrow \mathrm{bucket_0}$</li><li>$\mathrm{hash_2}(20) = 20 \% 8 = 4 \; \rightarrow \mathrm{bucket_4}$</li></ul></li><li>åˆ†è£‚å®Œä»¥åï¼Œ<code>split pointer</code>æŒ‡å‘ä¸‹ä¸€ä¸ªbucket(bucket id)ã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec06/68.jpg" alt="68.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/69.jpg" alt="69.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/70.jpg" alt="70.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/71.jpg" alt="71.jpg"></p><p><br></p><h3 id="Find-20"><a href="#Find-20" class="headerlink" title="Find 20"></a>Find 20</h3><ul><li>å…ˆåº”ç”¨$\mathrm{hash_1}$</li><li>$\mathrm{hash_1}$çš„ç»“æœæ˜¯0, 0è¿™ä¸ªä½ç½®<strong>é«˜äº</strong><code>split pointer</code>, è¯´æ˜0è¿™ä¸ªä½ç½®å·²ç»åˆ†è£‚è¿‡äº†ã€‚éœ€è¦å†åº”ç”¨$\mathrm{hash_2}$</li></ul><p><img data-src="/images/CMU1544564/Lec06/72.jpg" alt="72.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/73.jpg" alt="73.jpg"></p><p><br></p><h3 id="Find-9"><a href="#Find-9" class="headerlink" title="Find 9"></a>Find 9</h3><ul><li>å…ˆåº”ç”¨$\mathrm{hash_1}$</li><li>$\mathrm{hash_1}$çš„ç»“æœæ˜¯1, 1è¿™ä¸ªä½ç½®<strong>æ²¡æœ‰é«˜äº</strong><code>split pointer</code>, è¯´æ˜1è¿™ä¸ªä½ç½®æ²¡æœ‰åˆ†è£‚è¿‡äº†ã€‚ä¸éœ€è¦å†åº”ç”¨$\mathrm{hash_2}$</li></ul><p><img data-src="/images/CMU1544564/Lec06/74.jpg" alt="74.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/75.jpg" alt="75.jpg"></p><p><br></p><h3 id="Delete-20"><a href="#Delete-20" class="headerlink" title="Delete 20"></a>Delete 20</h3><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œåˆ†è£‚å‡ºçš„bucketå› ä¸ºåˆ é™¤çš„åŸå› å˜æˆäº†ç©ºbucketã€‚è¿™æ—¶å€™å¯ä»¥å›æ”¶è¿™ä¸ªbucketï¼ŒåŒæ—¶æ˜¯é€†æ“ä½œä¹‹å‰çš„åˆ†è£‚æ­¥éª¤ï¼Œéœ€è¦å°†<code>split pointer</code>å‘ä¸Šç§»åŠ¨ã€‚</p><p><img data-src="/images/CMU1544564/Lec06/76.jpg" alt="76.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/77.jpg" alt="77.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/78.jpg" alt="78.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/79.jpg" alt="79.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/80.jpg" alt="80.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/81.jpg" alt="81.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/82.jpg" alt="82.jpg"></p><h3 id="Insert-21"><a href="#Insert-21" class="headerlink" title="Insert 21"></a>Insert 21</h3><p>è¿™é‡Œä¹Ÿè§†ä½œä¸€ä¸ªoverflowã€‚</p><p><img data-src="/images/CMU1544564/Lec06/83.jpg" alt="83.jpg"></p><p><br></p><p>å½“<code>split point</code>æŒ‡å‘4çš„æ—¶å€™ï¼Œå³åˆ†è£‚å®Œä¸€è½®äº†ï¼Œå½“å‰ # bucket=8ã€‚æŠŠ<code>split point</code>é‡ç½®æˆ0ï¼Œ<strong>å¼€å§‹ä¸‹ä¸€è½®</strong>ï¼Œæ¯è½®çš„bucketæ•°ç¿»å€ï¼Œæ‰€ä»¥hashå‡½æ•°ä¸­çš„å–ä½™çš„æ•°ä¹Ÿè¦ç¿»å€ã€‚è¿™æ ·å°±å®ç°äº†åŠ¨æ€æ‰©å±•ã€‚<sup><a href="#fn1">1</a></sup></p><blockquote><p>When pointer reaches last slot, delete original hash function and replace it with new hash function.</p></blockquote><p><br></p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><img data-src="/images/CMU1544564/Lec06/84.jpg" alt="84.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/85.jpg" alt="85.jpg"></p><p>å¼•ç”¨:</p><p><a name="fn1">1</a>: CMU Database Systems - Indexes - fxjwind: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9wLzEwODM0ODQ0Lmh0bWw=" title="https://www.cnblogs.com/fxjwind/p/10834844.html">https://www.cnblogs.com/fxjwind/p/10834844.html<i class="fa fa-external-link"></i></span></p><p><a name="fn1">2</a>: CMU 15445 5. hash è¡¨ - è¥¿éƒ¨å°ç¬¼åŒ…: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYmYyNDAwNzg2ZjY=" title="https://www.jianshu.com/p/0bf2400786f6">https://www.jianshu.com/p/0bf2400786f6<i class="fa fa-external-link"></i></span></p><p>æ¨èé˜…è¯»:</p><p>Lec 13 Cuckoo Hashing - CS166 Stanford: <span class="exturl" data-url="aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMTY2L2xlY3R1cmVzLzEzL1NtYWxsMTMucGRm" title="https://web.stanford.edu/class/cs166/lectures/13/Small13.pdf">https://web.stanford.edu/class/cs166/lectures/13/Small13.pdf<i class="fa fa-external-link"></i></span></p><p>Extendible Hashing Example: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY29zYy5icm9ja3UuY2EvfmVmb3h3ZWxsLzJQMDMvc2xpZGVzL1dlZWsxMlNsaWRlcy5wZGY=" title="https://www.cosc.brocku.ca/~efoxwell/2P03/slides/Week12Slides.pdf">https://www.cosc.brocku.ca/~efoxwell/2P03/slides/Week12Slides.pdf<i class="fa fa-external-link"></i></span></p><p>LINEAR HASHING - QuePer: <span class="exturl" data-url="aHR0cDovL3F1ZXBlci5pbi9kcnVwYWwvYmxvZ3MvZGJzeXMvbGluZWFyX2hhc2hpbmc=" title="http://queper.in/drupal/blogs/dbsys/linear_hashing">http://queper.in/drupal/blogs/dbsys/linear_hashing<i class="fa fa-external-link"></i></span></p><!-- TODO: --><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Hash Tables - å“ˆå¸Œè¡¨&lt;/p&gt;
&lt;p&gt;Slide: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA2LWhhc2h0YWJsZXMucGRm&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Note: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDYtaGFzaHRhYmxlcy5wZGY=&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Readings: Chapter 11.6-11.7&lt;!-- TODO:link here --&gt;&lt;/p&gt;
&lt;p&gt;è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“çš„ä¸­ä½¿ç”¨çš„å“ˆå¸Œè¡¨hash tableï¼Œå®é™…ä¸Šæˆ‘ä»¬æ¶‰åŠçº¯ç®—æ³•è¯¾ä¸­çš„ç†è®ºï¼Œä½†æ›´é‡è¦çš„æ˜¯å·¥ç¨‹å®ç°çš„è§’åº¦ã€‚æ•°æ®åº“ä¸­ä½¿ç”¨çš„hash tableéœ€è¦æœ‰é«˜æ€§èƒ½ï¼Œå¤šçº¿ç¨‹è¯»å†™ï¼Œå†…å­˜è®¿é—®å‹å¥½ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Access Methods" scheme="https://cakebytheoceanluo.github.io/categories/Access-Methods/"/>
    
      <category term="Hash Table" scheme="https://cakebytheoceanluo.github.io/categories/Hash-Table/"/>
    
      <category term="Indexing" scheme="https://cakebytheoceanluo.github.io/categories/Indexing/"/>
    
    
      <category term="Indexing" scheme="https://cakebytheoceanluo.github.io/tags/Indexing/"/>
    
      <category term="Hash Function" scheme="https://cakebytheoceanluo.github.io/tags/Hash-Function/"/>
    
      <category term="Hash Scheme" scheme="https://cakebytheoceanluo.github.io/tags/Hash-Scheme/"/>
    
      <category term="Static Hashing Scheme" scheme="https://cakebytheoceanluo.github.io/tags/Static-Hashing-Scheme/"/>
    
      <category term="Linear Probe Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Linear-Probe-Hashing/"/>
    
      <category term="Robin Hood Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Robin-Hood-Hashing/"/>
    
      <category term="Cuckoo Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Cuckoo-Hashing/"/>
    
      <category term="Dynamic Hashing Scheme" scheme="https://cakebytheoceanluo.github.io/tags/Dynamic-Hashing-Scheme/"/>
    
      <category term="Chained Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Chained-Hashing/"/>
    
      <category term="Extendible Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Extendible-Hashing/"/>
    
      <category term="Linear Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Linear-Hashing/"/>
    
  </entry>
  
  <entry>
    <title>[CMU-15445]Lec05 Buffer Pools - æ•°æ®åº“ç¼“å­˜åŒº</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/</id>
    <published>2020-03-17T18:50:19.000Z</published>
    <updated>2020-03-22T20:02:06.031Z</updated>
    
    <content type="html"><![CDATA[<p>Buffer Pools - æ•°æ®åº“ç¼“å­˜åŒº</p><p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA1LWJ1ZmZlcnBvb2wucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDUtYnVmZmVycG9vbC5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf<i class="fa fa-external-link"></i></span><br>Readings: Chapter 10.5-10.8</p><p>è¿™èŠ‚ä¸¤è¯¾ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“çš„ç¼“å­˜åŒºç®¡ç†ï¼Œè¿™éƒ¨åˆ†åŸºäºå‰é¢ä¸¤èŠ‚è¯¾(Storage Iå’ŒStorage II)ã€‚</p><p>ç¼“å­˜åŒºbuffer poolå°±æ˜¯åœ¨å†…å­˜ä¸­å¯¹pageçš„ç¼“å­˜(cache)ã€‚</p><a id="more"></a><p><img data-src="/images/CMU1544564/Lec05/1.jpg" alt="1.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/6.jpg" alt="6.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/7.jpg" alt="7.jpg"><br>ä¸Šå›¾ä¸­</p><ul><li>spatial control ç©ºé—´æ§åˆ¶: ç‰©ç†(physically)ä¸Šæˆ‘ä»¬éœ€è¦æŠŠæœ‰äº’ç›¸ä¾èµ–çš„pageå†™åœ¨ç¡¬ç›˜ä¸­å¾ˆè¿‘çš„ä½ç½®ã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨è¿™äº›pageçš„æ—¶å€™ï¼Œå¯ä»¥å¾ˆå¿«å®Œæˆç¡¬ç›˜çš„å¯»å€ï¼Œsequantial I/Oè·å¾—è¿™äº›pageã€‚</li><li>temporal contral æ—¶é—´æ§åˆ¶: æˆ‘ä»¬éœ€è¦æœ€å¤§åŒ–æ¯ä¸€ä¸ªpageçš„å·¦å³ï¼Œæœ€å°åŒ–èŠ±åœ¨I/Oæ“ä½œä¸Šçš„æ—¶é—´ã€‚</li></ul><p><br></p><p><img data-src="/images/CMU1544564/Lec05/8.jpg" alt="8.jpg"></p><ul><li>ä¸Šå›¾æˆ‘ä»¬å·²ç»åœ¨<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/#Demo">Lec03 - System Design Goals (in Disk-oriented databases) - Demo</a>è§è¿‡</li></ul><p><br></p><p><img data-src="/images/CMU1544564/Lec05/9.jpg" alt="9.jpg"></p><h1 id="Buffer-Pool-Manager"><a href="#Buffer-Pool-Manager" class="headerlink" title="Buffer Pool Manager"></a>Buffer Pool Manager</h1><h2 id="Buffer-Pool-Organization-Demo"><a href="#Buffer-Pool-Organization-Demo" class="headerlink" title="Buffer Pool Organization - Demo"></a>Buffer Pool Organization - Demo</h2><p>å’Œæ“ä½œç³»ç»Ÿä¸­çš„æ¦‚å¿µä¸€æ ·ï¼Œæˆ‘ä»¬å°†ç¡¬ç›˜ä¸Šçš„blockæˆä¸ºpage, å°†å†…å­˜(buffer pool)ä¸­çš„blockç§°ä¸ºframeï¼Œframeå¯ä»¥å®¹çº³pageã€‚</p><p><code>pin(int pageid)</code>è¿™ä¸ªå‡½æ•°å°±ä»£è¡¨äº†ä¹‹å‰çš„<code>get page</code>è¿™ä¸ªæ“ä½œã€‚è¿™ä¸ªå‡½æ•°ä¹‹åæˆ‘ä»¬å¯ä»¥è·å¾—ä¸€ä¸ªæŒ‡å‘è¿™ä¸ªpageæ•°æ®çš„æŒ‡é’ˆã€‚æˆ‘ä»¬ä½¿ç”¨å®Œè¿™ä¸ªpageä¹‹åï¼Œéœ€è¦<code>unpin(int pageid)</code>ã€‚</p><p>åœ¨ä¸‹é¢3å¼ å›¾ä¸­ï¼š</p><ul><li>ä¸€å¼€å§‹buffer poolæ˜¯ç©ºçš„</li><li>ç„¶åæˆ‘ä»¬<code>pin(pageid 1)</code>, page1è¢«åŠ è½½è¿›å…¥buffer pool</li><li>ç„¶åæˆ‘ä»¬<code>pin(pageid 3)</code>, page3è¢«åŠ è½½è¿›å…¥buffer pool</li><li>æˆ‘ä»¬ä¼šåœ¨åé¢çœ‹åˆ°ä¸€ä¸ªpage tableï¼Œä»–è´Ÿè´£å‘Šè¯‰æˆ‘ä»¬pageå’Œframeçš„å¯¹åº”ï¼Œä¾‹å¦‚ï¼špage1åœ¨frame1, page3åœ¨frame2</li></ul><p><img data-src="/images/CMU1544564/Lec05/10.jpg" alt="10.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/11.jpg" alt="11.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/12.jpg" alt="12.jpg"></p><p><br></p><h2 id="Buffer-Pool-Metadata-Demo"><a href="#Buffer-Pool-Metadata-Demo" class="headerlink" title="Buffer Pool Metadata - Demo"></a>Buffer Pool Metadata - Demo</h2><p>è¿™ä¸ªDemoåŸºäºä¸Šä¸€ä¸ªDemoã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œè®¨è®ºç¼“å­˜åŒºçš„metadata, å®ƒä»¬æ˜¯ç®¡ç†åŒºçš„ç®¡ç†ä¿¡æ¯ã€‚</p><ul><li>page table (ä¹Ÿå’Œæ“ä½œç³»ç»Ÿä¸­æ¦‚å¿µç±»ä¼¼ï¼Œåªæ˜¯ä¸éœ€è¦MMU, TLB)æ˜¯ä¸€ä¸ªin-memory hashtable, è´Ÿè´£ <code>page id -&gt; frame id</code>çš„æ˜ å°„ï¼Œä¾‹å¦‚ï¼špage1åœ¨frame1, page3åœ¨frame2ã€‚</li><li>dirty flage: å‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ªbuffer poolä¸­çš„frameæ˜¯å¦è¢«æ”¹å†™ã€‚å¦‚æœè¢«æ”¹å†™ï¼Œå³pageä¸Šå‡ºç°æ–°æ•°æ®ï¼Œéœ€è¦è¢«å†™å›è‡³ç¡¬ç›˜ã€‚</li><li>pin / reference counter: å¯¹ä¸€ä¸ªpageå½“å‰ä½¿ç”¨çš„threadæ•°è¿›è¡Œè®¡æ•°ã€‚æˆ‘ä»¬åªå…è®¸å°†æ­¤æ•°å­—ä¸º0çš„pageå†™å›ç¡¬ç›˜ï¼Œå³å½“å‰æ²¡æœ‰ä»»ä½•threadåœ¨ä½¿ç”¨æ­¤pageã€‚</li></ul><p>è¿™ä¸ªDemoä¸­å¾ˆç”ŸåŠ¨åœ°è¡¨è¾¾äº†ï¼Œå¦‚ä½•åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå‘buffer poolä¸­åŠ è½½ä¸€ä¸ªæ–°çš„page:</p><ul><li>é¦–å…ˆæˆ‘ä»¬<code>pin(pageid 2)</code>ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨page tableä¸­æ‰¾ä¸åˆ°å¯¹åº”ï¼Œè¿™æ—¶æ˜¯ä¸€ä¸ªpage fault, è¯´æ˜æˆ‘ä»¬éœ€è¦ä»ç¡¬ç›˜ä¸­åŠ è½½è¿™ä¸ªpage2</li><li>è¿™æ—¶æˆ‘ä»¬ç»™page tableä¸Šä¸€ä¸ªglobal latchï¼Œç¡®ä¿æˆ‘ä»¬åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¼šæ”¹å˜è¿™ä¸ªpage table(æ¯”å¦‚åŠ è½½page, ç§»é™¤page)</li><li>ç¡®è®¤è·å¾—global latchä¹‹åï¼Œæˆ‘ä»¬å‘buffer poolåŠ è½½è¿™ä¸ªpage2, åŒæ—¶ä¹Ÿæ›´æ–°page tableç­‰metadata</li><li>æ•´ä¸ªè¿‡ç¨‹ç»“æŸåï¼Œæˆ‘ä»¬æ¾å¼€global latchã€‚è¿™æ ·æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªæœ‰æˆ‘ä»¬è¿™ä¸ªå½“å‰çº¿ç¨‹æ›´æ”¹äº†page tableã€‚</li><li>å…¶ä»–metadataæ˜¯å¦ä¹Ÿéœ€è¦çº¿ç¨‹å®‰å…¨ï¼Œå–å†³äºå…·ä½“å®ç°ã€‚</li></ul><p><br></p><ul><li>ä¸Šè¿°ä¸­å¯ä»¥ä¸ç”¨global latchã€‚è€Œåªæ˜¯ç»™å¯¹åº”çš„slotæ¥ä¸€ä¸ªlatchã€‚ä¿è¯åœ¨è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å…¶ä»–äººä¼šè¯»æˆ–è€…å†™è¿™ä¸ªslotã€‚è¿™æ ·ä¾æ—§æ˜¯ä¸€ç§çº¿ç¨‹å®‰å…¨çš„å®ç°ã€‚å¦å¤–ç›¸å¯¹æ€§èƒ½æ›´å¥½ã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec05/13.jpg" alt="13.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/14.jpg" alt="14.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/15.jpg" alt="15.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/16.jpg" alt="16.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/17.jpg" alt="17.jpg"></p><p><br></p><h2 id="Locks-vs-Latches-2"><a href="#Locks-vs-Latches-2" class="headerlink" title="Locks vs. Latches 2"></a>Locks vs. Latches <sup><a href="#fn2">2</a></sup></h2><ul><li>locksæ˜¯ä¸€ä¸ªhigh level å¾ˆæŠ½è±¡çš„æ¦‚å¿µ, å®ƒç›´æ¥å’Œtransactionäº‹åŠ¡ç›¸å…³ï¼Œåº”ç”¨äºäº‹åŠ¡çš„lock protocolä¸­ã€‚æ˜¯åº”ç”¨å±‚é¢çš„ã€‚æ˜¯é€»è¾‘å†…å®¹çš„äº’æ–¥ï¼Œæ¯”å¦‚è¡Œï¼Œè¡¨ï¼Œäº‹åŠ¡ã€‚</li><li>latchåŸºæœ¬ä¸Šå’Œlow levelå®ç°ç›¸å…³ï¼ŒæŒ‡<code>std::mutex</code>è¿™ç±»å’Œä»£ç ç›¸å…³çš„ç±»(class)ï¼Œæ¥ä¿æŠ¤ä»£ç ä¸­çš„critical sectionã€‚æ˜¯åº”ç”¨ä¸å¯è§çš„ï¼Œå†…éƒ¨æ•°æ®çš„äº’æ–¥ã€‚</li><li>(è¿™éƒ¨åˆ†æˆ‘ä»¬ä»¥åè¿˜ä¼šæåˆ°)<!-- TODO: --></li></ul><p><img data-src="/images/CMU1544564/Lec05/18.jpg" alt="18.jpg"></p><h2 id="Page-Table-vs-Page-Directory"><a href="#Page-Table-vs-Page-Directory" class="headerlink" title="Page Table vs. Page Directory"></a>Page Table vs. Page Directory</h2><ul><li>åœ¨<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/#Page-Directory">[CMU-15445]Lec03 - Database Storage - Database Heap - Page Directory</a>æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»æåˆ°äº† page directory, å®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„page, è®°å½•äº†pageå¯¹åº”æ–‡ä»¶çš„ä½ç½®ï¼Œå› æ­¤è¿™ä¸ªpage directoryä¹Ÿä¼šä»¥pageçš„æ–¹å¼ä»ç¡¬ç›˜è¯»å–åˆ°å†…å­˜ï¼Œæœ€åä»å†…å­˜å†™å›è‡³ç¡¬ç›˜ã€‚å³å®ƒæ˜¯æŒä¹…åŒ–çš„(persistent, durable)ã€‚</li><li>page table åªæ˜¯ä¸€ä¸ª<code>page id -&gt; frame id</code>çš„æ˜ å°„, å…·ä½“æ˜¯ä¸€ä¸ª<code>page id -&gt; frame pointer</code>çš„hash tableï¼ŒæŒ‡é’ˆçš„ä½ç½®åªæ˜¯åœ¨æœ¬æ¬¡å¯åŠ¨æœ‰æ•ˆï¼Œå› ä¸ºå…³æœºé‡å¯åï¼Œæˆ‘ä»¬ä¼šallocateå¦ä¸€å—å†…å­˜åŒºåŸŸç»™æ•°æ®åº“buffer poolã€‚è¿™ç±»å®Œå…¨ä¾èµ–å†…å­˜çš„æ•°æ®ç»“æ„(in-memory data structure)æ²¡æœ‰æ„ä¹‰å»å­˜åˆ°ç¡¬ç›˜ä¸Šã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec05/19.jpg" alt="19.jpg"></p><h2 id="Allocation-Policies"><a href="#Allocation-Policies" class="headerlink" title="Allocation Policies"></a>Allocation Policies</h2><ul><li>global policies: æŒ‡æ‰€æœ‰query, transactionä½¿ç”¨åŒä¸€ä¸ªbuffer poolçš„replacement policy</li><li>local policies: æŒ‡æ¯ä¸€ä¸ªquery, transactionå¯ä»¥æœ‰ä¸€ä¸ªè‡ªå·±çš„buffer poolï¼Œ å’Œè‡ªå·±çš„replacement policyã€‚åŒæ—¶å¯ä»¥åœ¨ä¸€ä¸ªå…±æœ‰çš„buffer poolå»share pages</li><li>å®é™…ä¸Šä¼šæ··åˆè¿™ä¸¤ç§ä¸»æ„ï¼Œ æ¯”å¦‚æ•°æ®tableæ‹¥æœ‰ä¸€ä¸ªbuffer pool, index(ç´¢å¼•æ•°æ®ç»“æ„)æ‹¥æœ‰å¦ä¸€ä¸ªbuffer poolã€‚è¿™ä¸ªæˆ‘ä»¬ä¼šåœ¨indexçš„è¯¾ä¸Šæåˆ°ã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec05/20.jpg" alt="20.jpg"></p><p><br><br><br></p><h1 id="Buffer-Pool-Optimizations"><a href="#Buffer-Pool-Optimizations" class="headerlink" title="Buffer Pool Optimizations"></a>Buffer Pool Optimizations</h1><p><img data-src="/images/CMU1544564/Lec05/21.jpg" alt="21.jpg"></p><h2 id="Multiple-Buffer-Pools"><a href="#Multiple-Buffer-Pools" class="headerlink" title="Multiple Buffer Pools"></a>Multiple Buffer Pools</h2><p>è§<a href="#allocation-policies">Allocation Policies</a>ä¸­æåˆ°äº†éƒ¨åˆ†Local Policiesã€‚</p><p><img data-src="/images/CMU1544564/Lec05/22.jpg" alt="22.jpg"></p><p>å¦å¤–è¿™éƒ¨åˆ†ä¸çŸ¥é“ä¸ºä½•æ²¡æœ‰è¯¾ä»¶ï¼Œ æˆ‘æˆªå›¾äº†è§†é¢‘æ¥ä½œä¸ºç¼ºå¤±çš„è¯¾ä»¶ã€‚</p><ul><li>Approach2 Hashing: ç”¨ä¸€ä¸ªhash function: <code>RID -&gt; buffer pool id</code>, æŠŠæœ‰ç›¸åŒhash valueçš„tupleåˆ†é…åˆ°åŒä¸€ä¸ªbuffer poolï¼Œæé«˜buffer poolä¸­çš„spatial locality(ç©ºé—´å±€éƒ¨æ€§)ã€‚(ç±»ä¼¼hash join)</li></ul><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/missing_1.png" alt="Lec5_missing_1.jpg"></p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/missing_2.png" alt="Lec5_missing_2.jpg"></p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/missing_3.png" alt="Lec5_missing_3.jpg"></p><h2 id="Pre-Fetching"><a href="#Pre-Fetching" class="headerlink" title="Pre-Fetching"></a>Pre-Fetching</h2><p>æˆ‘ä»¬å¯ä»¥é¢„åŠ è½½ä¸€äº›page, ä¸€ä¸ªthreadåœ¨å¯¹page Aè¿›è¡Œæ‰«æè®¡ç®—çš„åŒæ—¶ï¼Œå¦å¤–ä¸€ä¸ªthreadå¯ä»¥å°†ä¸‹ä¸€ä¸ªpage BåŠ è½½åˆ°buffer poolä¸­ã€‚è¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯ç”¨çŒœæµ‹æˆ–è€…é¢„å…ˆçš„åªæ˜¯ï¼Œå»åŠ è½½æœªæ¥å¯èƒ½ç”¨å¾—åˆ°çš„page, æœ€ç»ˆç›®çš„å‡å°‘ä»ç¡¬ç›˜åŠ è½½çš„æ—¶é—´ã€‚å…·ä½“æœ‰ä¸¤ç§æƒ…å†µï¼Œæ ¹æ®è¿™ä¸ª<strong>ä¸‹ä¸€ä¸ªpage</strong>æ˜¯å“ªä¸€ä¸ª:</p><ul><li>Sequential Scans: å³ç‰©ç†ä¸Šè¿ç»­å­˜å‚¨çš„ä¸‹ä¸€ä¸ªpage</li><li>Index Scans: </li></ul><h3 id="Sequential-Scans"><a href="#Sequential-Scans" class="headerlink" title="Sequential Scans"></a>Sequential Scans</h3><p><img data-src="/images/CMU1544564/Lec05/23.jpg" alt="23.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/24.jpg" alt="24.jpg"></p><p>Q1åœ¨æ‰«æpage1çš„æ—¶å€™ï¼Œbuffer pool managerå‘ç°è¿™æ˜¯ä¸€ä¸ªsequenial scanï¼Œå†³å®špre fetchåé¢çš„pageï¼Œæ‰€ä»¥åœ¨åŒæ—¶å°†page2,3åŠ è½½è¿›buffer poolã€‚ç†æƒ³çš„è¯ï¼Œç­‰Q1ç»“æŸå¯¹page1çš„æ‰«æï¼Œpage2,3å°±å·²ç»åœ¨buffer poolï¼Œç›¸å½“äºæ²¡æœ‰æ”¶åˆ°page faultçš„å½±å“ï¼Œæ²¡æœ‰æµªè´¹æ—¶é—´ç­‰å¾…ã€‚</p><p><img data-src="/images/CMU1544564/Lec05/25.jpg" alt="25.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/26.jpg" alt="26.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/27.jpg" alt="27.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/28.jpg" alt="28.jpg"></p><h3 id="Index-Scans"><a href="#Index-Scans" class="headerlink" title="Index Scans"></a>Index Scans</h3><p>è¿™é‡Œçš„indexæ˜¯ä¸€ä¸ªB+ Treeï¼Œ å…·ä½“ä½œæ³•æ˜¯ä»æ ¹èŠ‚ç‚¹æŸ¥æ‰¾è‡³å¶å­èŠ‚ç‚¹ï¼Œå†æ°´å¹³éå†æœ‰å…³çš„å¶å­èŠ‚ç‚¹ã€‚è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦çš„pageä¸ä¸€å®šæ˜¯ç‰©ç†ä¸Šè¿ç»­å­˜å‚¨çš„ï¼š</p><p><img data-src="/images/CMU1544564/Lec05/29.jpg" alt="29.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/30.jpg" alt="30.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/31.jpg" alt="31.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/32.jpg" alt="32.jpg"></p><p><br></p><p>ä¸‹å›¾ä¸­å¾ˆæ˜æ˜¾è¡¨è¾¾ï¼Œæˆ‘ä»¬æ¥ä¸‹é¢éœ€è¦çš„æ˜¯page3å’Œpage5, å®ƒä»¬ä¸æ˜¯è¿ç»­çš„ï¼Œä¹Ÿä¸ç´§è·Ÿåœ¨page1(å½“å‰page)ä¹‹åã€‚ ä½†æ˜¯indexè¿™ä¸ªæ•°æ®ç»“æ„å‘Šè¯‰æˆ‘ä»¬ï¼Œä¸‹ä¸€æ­¥æ˜¯page3å’Œpage5è¢«éœ€è¦ï¼Œå› æ­¤å»pre fetchå®ƒä»¬ä¿©ã€‚è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ä¾‹å­ï¼Œæ“ä½œç³»ç»Ÿåœ¨è¿™ä¸€ç‚¹å¸®ä¸äº†æˆ‘ä»¬ï¼Œæ“ä½œç³»ç»Ÿæœ€å¤šèƒ½å¸®æˆ‘ä»¬pre fetchè¿ç»­çš„pageï¼Œä½†æ˜¯å®ƒä¸çŸ¥é“indexçš„å­˜åœ¨ï¼Œæ²¡æœ‰åŠæ³•å¸®åŠ©æˆ‘ä»¬å‡†ç¡®å»å¾—åˆ°page3å’Œpage5ï¼š<br><img data-src="/images/CMU1544564/Lec05/33.jpg" alt="33.jpg"></p><h2 id="Scan-Sharing"><a href="#Scan-Sharing" class="headerlink" title="Scan Sharing"></a>Scan Sharing</h2><ul><li>Scan Sharing: reuse data retrieved from storage or operator computationsï¼Œ å³ä½¿ç”¨å…¶ä»–æ­£åœ¨è¿è¡Œçš„queryçš„ä¸­é—´è¿‡ç¨‹å€¼</li><li>result caching: åªæ˜¯ç¼“å­˜æœ€ç»ˆç»“æœå€¼ï¼Œè€Œä¸æ˜¯ä¸­é—´è¿‡ç¨‹å€¼</li></ul><p>å…·ä½“æµç¨‹ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªQueryå·²ç»åœ¨è¿è¡Œï¼Œæœ‰ä¸€äº›ä¸­é—´è¿‡ç¨‹å€¼</li><li>ç¬¬äºŒä¸ªQueryå¼€å§‹è¿è¡Œï¼ŒDBMSå‘ç°è¿™ç¬¬äºŒä¸ªQueryå¯ä»¥å…¬ç”¨ç¬¬ä¸€ä¸ªQueryçš„å€¼ï¼Œè€Œä¸”å®ƒä»¬ä¿©éœ€è¦æ‰«æçš„èŒƒå›´ä¸€æ ·ã€‚</li><li>DBMSå°†ç¬¬äºŒä¸ªQuery attchè¿›ç¬¬ä¸€ä¸ªQuery, è®°å½•ä¸‹ç¬¬äºŒä¸ªQueryè¢«attachçš„åœ°æ–¹, è®©å®ƒä»¬ä¿©ä¸€èµ·æ‰«æã€‚</li><li>ç­‰å®ƒä»¬ä¿©å…±åŒæ‰«æç»“æŸåï¼Œå†æ‰«æä¸€å¼€å§‹ç¬¬äºŒä¸ªQueryè·³è¿‡çš„åœ°æ–¹ã€‚</li></ul><p><img data-src="/images/CMU1544564/Lec05/34.jpg" alt="34.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/35.jpg" alt="35.jpg"></p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>Q1éœ€è¦æ‰«ææ‰€æœ‰çš„page, å°†valä¸æ–­ç´¯åŠ ã€‚</p><p><img data-src="/images/CMU1544564/Lec05/36.jpg" alt="36.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/37.jpg" alt="37.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/38.jpg" alt="38.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/39.jpg" alt="39.jpg"></p><p><br><br><br></p><p>åœ¨Q1æ‰«æè‡³page3çš„æ—¶å€™ï¼ŒQ2åŠ å…¥ã€‚å¾ˆå·§ï¼ŒQ2ä¹Ÿéœ€è¦æ‰«ææ‰€æœ‰çš„page, å°†valä¸æ–­ç´¯åŠ ã€‚è¿™è¯´æ˜Q2å·²åŠ å…¥å°±å¯ä»¥ä½¿ç”¨Q1çš„ä¸­é—´ç»“æœï¼Œå¹¶ä¸”å¯ä»¥å’ŒQ1ç»“åˆåœ¨ä¸€èµ·æ‰«æå‰©ä¸‹çš„pageï¼š<br><img data-src="/images/CMU1544564/Lec05/40.jpg" alt="40.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/41.jpg" alt="41.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/42.jpg" alt="42.jpg"></p><p><br><br><br></p><p>Q1ç»“æŸåï¼Œ è¿™ä¸ªä¾‹å­ä¸­ï¼ŒQ2è¿˜éœ€è¦æ‰«æå®ƒæ²¡æœ‰æ‰«æè¿‡çš„pageï¼Œ å› ä¸ºQ2è®¡ç®—å¹³å‡å€¼ï¼Œ éœ€è¦çŸ¥é“æ¯ä¸€ä¸ªpageä¸Štupleçš„ä¸ªæ•°ã€‚</p><p><img data-src="/images/CMU1544564/Lec05/43.jpg" alt="43.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/44.jpg" alt="44.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/45.jpg" alt="45.jpg"></p><p>æˆ‘ä»¬ä¹Ÿæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰scan sharingè¿™ä¸ªfeatureï¼Œ Q1å’ŒQ2ç›¸äº’ç«äº‰buffer poolä¼šå¯¼è‡´è¿™ä¸¤ä¸ªQueryæ€§èƒ½éƒ½å¾ˆå·®ã€‚</p><h2 id="Buffer-Pool-Bypass"><a href="#Buffer-Pool-Bypass" class="headerlink" title="Buffer Pool Bypass"></a>Buffer Pool Bypass</h2><p>sequantial scanä¼šå°†å¤§éƒ¨åˆ†pageåŠ è½½è¿›buffer pool, è€Œè¿™äº›pageåˆå¹¶ä¸ä¸€å®šåœ¨æœªæ¥ä¼šè¢«é‡å¤åˆ©ç”¨ã€‚å¯¹è¿™ç§sequantial scançš„Queryï¼Œæˆ‘ä»¬å¯ä»¥å•ç‹¬ç»™allocateä¸€å—å†…å­˜åŒºåŸŸï¼Œè€Œç‹¬ç«‹äºä¸”ä¸å½±å“buffer poolã€‚è¿™ä¸€å—ä¸“å±çš„å†…å­˜åŒºåŸŸä¾ç„¶èƒ½ä¿è¯å¯¹å½“å‰Queryçš„æ€§èƒ½ï¼Œè€Œä¸”å› ä¸ºä¸ä¼š<em>æ‰“ä¹±æ±¡æŸ“</em>buffer poolè€Œå½±å“å…¶ä»–Queryçš„æ€§èƒ½ã€‚è¿™å—å†…å­˜åŒºåŸŸä¼šåœ¨è¯¥sequantial scan Queryç»“æŸåè¢«é‡Šæ”¾ã€‚</p><p><img data-src="/images/CMU1544564/Lec05/46.jpg" alt="46.jpg"></p><ul><li>Light Scans: <span class="exturl" data-url="aHR0cHM6Ly93d3cuaWJtLmNvbS9zdXBwb3J0L2tub3dsZWRnZWNlbnRlci9lbi9TU0dVOEdfMTIuMS4wL2NvbS5pYm0ucGVyZi5kb2MvaWRzX3ByZl8yMzcuaHRt" title="https://www.ibm.com/support/knowledgecenter/en/SSGU8G_12.1.0/com.ibm.perf.doc/ids_prf_237.htm">https://www.ibm.com/support/knowledgecenter/en/SSGU8G_12.1.0/com.ibm.perf.doc/ids_prf_237.htm<i class="fa fa-external-link"></i></span></li></ul><p><br></p><h2 id="OS-Page-Cache"><a href="#OS-Page-Cache" class="headerlink" title="OS Page Cache"></a>OS Page Cache</h2><p><img data-src="/images/CMU1544564/Lec05/47.jpg" alt="47.jpg"></p><ul><li>O_DIRECT: <span class="exturl" data-url="aHR0cHM6Ly9saW51eC5kaWUubmV0L21hbi8yL29wZW4=" title="https://linux.die.net/man/2/open">https://linux.die.net/man/2/open<i class="fa fa-external-link"></i></span></li><li>å¤§éƒ¨åˆ†DBMS<strong>ä½¿ç”¨direct I/O</strong>ï¼Œçœå»æ–‡ä»¶è¢«åŠ è½½å…¥æ“ä½œç³»ç»Ÿæ–‡ä»¶ç¼“å­˜åŒºã€‚direct I/Oå¯ä»¥ç›´æ¥è®²æ–‡ä»¶è¯»å–åˆ°æ•°æ®åº“ç¼“å­˜åŒºçš„address spaceã€‚çœå»äº†ä»æ“ä½œç³»ç»Ÿç¼“å­˜åŒºå¤åˆ¶è¿›æ•°æ®åº“ç¼“å­˜åŒºçš„address spaceï¼Œè¿™æ ·æ€§èƒ½ä¹Ÿæ›´å¥½ã€‚æ›´å¤šè§<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/#mmap">[CMU-15445]Lec03 - Why not use the OS? - mmap</a></li><li>ä¹Ÿæœ‰å…¶ä»–çš„DBMS<strong>ä¸ä½¿ç”¨direct I/O</strong>ï¼Œ æ¯”å¦‚PostgreSQLã€‚å®ƒä»¬ä»å·¥ç¨‹çš„è§’åº¦è§‰å¾—ä¸ä½¿ç”¨direct I/Oæ›´å¥½ï¼šæ•°æ®åº“buffer poolå‡ºç°page faultçš„æ—¶å€™ï¼Œå¦‚æœå¯¹åº”çš„pageåœ¨æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç¼“å­˜åŒºä¸­ï¼Œé‚£è¿™æ—¶å€™åªéœ€è¦ä¸€æ¬¡å†…å­˜ä¸­çš„å¤åˆ¶(ä»æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç¼“å­˜åŒºå¤åˆ¶åˆ°æ•°æ®åº“buffer pool)ï¼Œè€Œä¸æ˜¯å»ç¡¬ç›˜åšæ¼«é•¿çš„I/Oã€‚æ¯”å¦‚PostgreSQLé‡å¯åbuffer poolæ˜¯ç©ºçš„ï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿçš„page cacheä»¥åŠè¿˜æ˜¯æœ‰å¯¹åº”æ–‡ä»¶ï¼Œè¿™æ—¶å€™å¯ä»¥ä»page cacheä¸­å¤åˆ¶ï¼Œé¿å…å†·å¯åŠ¨ã€‚</li></ul><p>è¯¾ä¸Šçš„PostgreSQLå®éªŒ, è§<a href="https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/">[DBMS][PostgreSQL] ç¼“å­˜åŒºç®¡ç† BufferPool</a></p><p><br></p><h2 id="Buffer-Replacement-Policies"><a href="#Buffer-Replacement-Policies" class="headerlink" title="Buffer Replacement Policies"></a>Buffer Replacement Policies</h2><p>è¿™éƒ¨åˆ†ä¸­çš„ç†è®ºå’Œæ“ä½œç³»ç»Ÿä¸­çš„é¡µæ›¿æ¢æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><p><img data-src="/images/CMU1544564/Lec05/48.jpg" alt="48.jpg"></p><h3 id="Lest-Recently-Used-LRU"><a href="#Lest-Recently-Used-LRU" class="headerlink" title="Lest Recently Used (LRU)"></a>Lest Recently Used (LRU)</h3><p><img data-src="/images/CMU1544564/Lec05/49.jpg" alt="49.jpg"></p><h3 id="Clock"><a href="#Clock" class="headerlink" title="Clock"></a>Clock</h3><p>LRUéœ€è¦è·å–çœŸçš„timestampï¼Œã€€è€Œæ— è®ºè·å–software timeræˆ–è€…hardware timeréƒ½æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œéœ€è¦å¾ˆå¤šCPUå‘¨æœŸã€‚æ‰€æœ‰æˆ‘ä»¬é€‰ç”¨Clock, å®ƒæ˜¯LRUçš„ä¸€ä¸ªè¿‘ä¼¼(approximation), å®ƒå°±å»é™¤äº†æ¯ä¸€ä¸ªpageçš„timestampå±æ€§ã€‚è€ŒClockä½¿ç”¨ä¸€ä¸ªä¸å‡†ç¡®çš„æ—¶é—´åŒºé—´, å³referenceè‡³é¡ºæ—¶é’ˆè¢«é€‰æ‹©ã€‚å…·ä½“æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹é¢çš„Demo:</p><p>ä¸‹å›¾æˆ‘ä»¬è®¿é—®page1, å®ƒåœ¨æˆ‘ä»¬buffer poolä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°è¿™ä¸ªpage, ä¹Ÿè®©å®ƒçš„refï¼1:<br><img data-src="/images/CMU1544564/Lec05/50.jpg" alt="50.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/51.jpg" alt="51.jpg"></p><p><br><br><br></p><p>ç„¶åæˆ‘ä»¬éœ€è¦åŠ è½½ä¸€ä¸ªæ–°çš„page5,ã€€è¦å»é™¤ä¸€ä¸ªbuffer poolä¸­çš„pageã€‚æŒ‡é’ˆæŒ‡å‘çš„page1çš„ref=1, å®ƒå¯ä»¥ç•™åœ¨buffer pool, å¹¶ä¸”ref=0, æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªpage:</p><p><img data-src="/images/CMU1544564/Lec05/52.jpg" alt="52.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/53.jpg" alt="53.jpg"></p><p><br><br><br></p><p>æŒ‡é’ˆæŒ‡å‘çš„page2çš„ref=0, å®ƒä¸å¯ä»¥ç•™åœ¨buffer poolï¼š</p><p><img data-src="/images/CMU1544564/Lec05/54.jpg" alt="54.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/55.jpg" alt="55.jpg"></p><p><br><br><br></p><h3 id="Problem-Sequential-Flooding-é¡ºåºæ³›æ´ª"><a href="#Problem-Sequential-Flooding-é¡ºåºæ³›æ´ª" class="headerlink" title="Problem - Sequential Flooding é¡ºåºæ³›æ´ª"></a>Problem - Sequential Flooding é¡ºåºæ³›æ´ª</h3><p>LRUå’ŒClockå®¹æ˜“æ”¶åˆ°Sequential Floodingçš„å½±å“ã€‚Sequential Floodingæˆ‘ä»¬ä¹‹å‰ä¹Ÿé—´æ¥çš„æåˆ°è¿‡ï¼Œä¸€ä¸ªQueryå¦‚æœéœ€è¦æ‰«ææ‰€æœ‰çš„page, buffer poolä¼šå› ä¸ºå®ƒçš„å˜å¾—å¾ˆä¹±ï¼Œè€Œæœ€åç•™åœ¨buffer poolä¸­çš„pageä¹Ÿä¸ä¸€å®šå¯¹æœªæ¥çš„Queryæœ‰å¸®åŠ©ã€‚è¿™é‡Œæˆ‘ä»¬æ›´ä¸¥è°¨å®šä¹‰è¿™ä¸ªè¡Œä¸ºå«Sequential Floodingï¼Œæœ€åç•™åœ¨buffer poolä¸­çš„pageæ˜¯æœ€è¿‘è¢«ä½¿ç”¨è¿‡çš„(least recently used)ï¼Œã€€ä½†æ˜¯å®ƒä»¬å®é™…ä¸Šæ˜¯æœ€ä¸éœ€è¦çš„(most unneeded)ã€‚(è¿™äº›pageå¾€å¾€æ˜¯ç¡¬ç›˜ä¸Šæœ€åå‡ ä¸ªpage)</p><p><img data-src="/images/CMU1544564/Lec05/58.jpg" alt="58.jpg"></p><p><br></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªDemoã€‚ä¸‹é¢è¿™ä¸ªDemoä¸­çš„é—®é¢˜å¯ä»¥æ¢ä¸€ä¸ªæ€è·¯è§£å†³ï¼šæ¯æ¬¡æŠŠQ2å¸¦è¿›æ¥çš„pageä¸­page idæœ€å¤§çš„èˆå¼ƒã€‚</p><p><img data-src="/images/CMU1544564/Lec05/59.jpg" alt="59.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/60.jpg" alt="60.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/61.jpg" alt="61.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/62.jpg" alt="62.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/63.jpg" alt="63.jpg"></p><h3 id="LRU-K-1"><a href="#LRU-K-1" class="headerlink" title="LRU-K 1"></a>LRU-K <sup><a href="#fn1">1</a></sup></h3><p>LRU-Kä¸­çš„<code>K</code>ä»£è¡¨<strong>æœ€è¿‘ä½¿ç”¨çš„æ¬¡æ•°</strong>ï¼Œå› æ­¤LRUå¯ä»¥è®¤ä¸ºæ˜¯LRU-1ã€‚LRU-Kçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³LRUç®—æ³•â€ç¼“å­˜æ±¡æŸ“â€çš„é—®é¢˜ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†â€œæœ€è¿‘ä½¿ç”¨è¿‡1æ¬¡â€çš„åˆ¤æ–­æ ‡å‡†<strong>æ‰©å±•ä¸ºâ€œæœ€è¿‘ä½¿ç”¨è¿‡Kæ¬¡â€</strong>ã€‚</p><p>ç›¸æ¯”LRUï¼ŒLRU-Kéœ€è¦å¤šç»´æŠ¤<strong>ä¸€ä¸ªé˜Ÿåˆ—: ç¼“å­˜é˜Ÿåˆ—ã€‚å®ƒç”¨äºè®°å½•æ‰€æœ‰ç¼“å­˜æ•°æ®è¢«è®¿é—®çš„å†å²ã€‚åªæœ‰å½“æ•°æ®çš„è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡çš„æ—¶å€™ï¼Œæ‰å°†æ•°æ®æ”¾å…¥ç¼“å­˜é˜Ÿåˆ—</strong>ã€‚å½“éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼ŒLRU-Kä¼šæ·˜æ±°ç¬¬Kæ¬¡è®¿é—®æ—¶é—´è·å½“å‰æ—¶é—´æœ€å¤§çš„æ•°æ®ã€‚è¯¦ç»†å®ç°å¦‚ä¸‹ï¼š</p><ol><li>æ•°æ®ç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼ŒåŠ å…¥åˆ°è®¿é—®<strong>å†å²é˜Ÿåˆ—</strong></li><li>å¦‚æœæ•°æ®åœ¨è®¿é—®<strong>å†å²é˜Ÿåˆ—</strong>é‡Œåæ²¡æœ‰è¾¾åˆ°Kæ¬¡è®¿é—®ï¼Œåˆ™æŒ‰ç…§ä¸€å®šè§„åˆ™(FIFOï¼ŒLRU)æ·˜æ±°</li><li>å½“è®¿é—®<strong>å†å²é˜Ÿåˆ—</strong>ä¸­çš„æ•°æ®è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡åï¼Œå°†æ•°æ®ç´¢å¼•ä»<strong>å†å²é˜Ÿåˆ—</strong>åˆ é™¤ï¼Œå°†æ•°æ®ç§»åˆ°<strong>ç¼“å­˜é˜Ÿåˆ—</strong>ä¸­ï¼Œå¹¶ç¼“å­˜æ­¤æ•°æ®ï¼Œ<strong>ç¼“å­˜é˜Ÿåˆ—</strong>é‡æ–°æŒ‰ç…§æ—¶é—´æ’åº</li><li><strong>ç¼“å­˜é˜Ÿåˆ—</strong>ä¸­è¢«å†æ¬¡è®¿é—®åï¼Œé‡æ–°æ’åº</li><li>éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œæ·˜æ±°<strong>ç¼“å­˜é˜Ÿåˆ—</strong>ä¸­æ’åœ¨æœ«å°¾çš„æ•°æ®ï¼Œå³æ·˜æ±°â€å€’æ•°ç¬¬Kæ¬¡è®¿é—®ç¦»ç°åœ¨æœ€ä¹…â€çš„æ•°æ®</li></ol><p>LRU-Kå…·æœ‰LRUçš„ä¼˜ç‚¹ï¼ŒåŒæ—¶èƒ½å¤Ÿé¿å…LRUçš„ç¼ºç‚¹ï¼Œå®é™…åº”ç”¨ä¸­LRU-2æ˜¯ç»¼åˆå„ç§å› ç´ åæœ€ä¼˜çš„é€‰æ‹©ï¼ŒLRU-3æˆ–è€…æ›´å¤§çš„Kå€¼å‘½ä¸­ç‡ä¼šé«˜ï¼Œä½†é€‚åº”æ€§å·®ï¼Œéœ€è¦å¤§é‡çš„æ•°æ®è®¿é—®æ‰èƒ½å°†å†å²è®¿é—®è®°å½•æ¸…é™¤æ‰ã€‚</p><p>å¦å¤–LRU-Kå¯¹sequential scan<strong>ä¸æ•æ„Ÿ</strong>ï¼Œå› ä¸ºsequential scanåªä½¿ç”¨æ¯ä¸ªpageä¸€æ¬¡ã€‚è€Œä½¿ç”¨ä¸€æ¬¡çš„pageåœ¨LRU-Kéå¸¸å®¹æ˜“è¢«evictã€‚</p><!-- TODO: TUM ModernDBS --><p><img data-src="/images/CMU1544564/Lec05/64.jpg" alt="64.jpg"></p><h3 id="Localization"><a href="#Localization" class="headerlink" title="Localization"></a>Localization</h3><p>è¿™éƒ¨åˆ†å·²ç»åœ¨è¿™è¯¾ä¸­çš„å®éªŒä¸­ä½“ç°äº†ï¼šPostgreSQLç»™æ¯ä¸€ä¸ªQueryä¸€ä¸ªç‹¬ç«‹çš„buffer poolï¼Œ åŒæ—¶æ‰€æœ‰Queryå…¬ç”¨ä¸€ä¸ªshared buffer poolã€‚è¿™æœ€å¤§é™åº¦åœ°å‡å°‘äº†æ¯ä¸ªqueryå¯¹buffer poolçš„æ±¡æŸ“ã€‚</p><p><img data-src="/images/CMU1544564/Lec05/65.jpg" alt="65.jpg"></p><h3 id="Priority-Hints"><a href="#Priority-Hints" class="headerlink" title="Priority Hints"></a>Priority Hints</h3><p>DBMSçŸ¥é“å“ªäº›pageæ¯”è¾ƒé‡è¦ï¼Œç»å¸¸è®¿é—®ï¼Œæ‰“ä¸Šæ ‡ç­¾ã€‚<sup><a href="#fn2">2</a></sup></p><p><img data-src="/images/CMU1544564/Lec05/67.jpg" alt="67.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/68.jpg" alt="68.jpg"></p><h2 id="Dirty-Pages"><a href="#Dirty-Pages" class="headerlink" title="Dirty Pages"></a>Dirty Pages</h2><p>åªæœ‰è¢«æ›´æ”¹è¿‡çš„pageæ‰æœ‰å¿…è¦å†™å›ç¡¬ç›˜ï¼ŒæŒä¹…åŒ–ã€‚</p><p>DBMSå¯ä»¥å®šæœŸéå†page tableå¹¶å°†è„é¡µå†™å›ç¡¬ç›˜ã€‚å› ä¸ºå¦‚æœæ¯æ¬¡ç­‰evictionçš„æ—¶å€™å†å»flushè„é¡µï¼Œä¼šè®©evictionçš„è¿‡ç¨‹éå¸¸çš„æ…¢ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šæœ‰ä¸ªåå°è¿›ç¨‹å®šæœŸæ‰¹é‡çš„å»å†™å›è„é¡µã€‚<sup><a href="#fn2">2</a></sup>å½“å®‰å…¨åœ°å†™ä¼šè„é¡µä¹‹åï¼ŒDBMSå¯ä»¥evicté¡µé¢æˆ–è€…åªæ˜¯å–æ¶ˆè®¾ç½®dirty bit, å› ä¸ºè¿™ä¸ªé¡µé¢å·²ç»<strong>ä¸å†è„äº†</strong>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å†™æ—¥å¿—è®°å½•ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸ä¼šå»å†™è„é¡µã€‚<sup><a href="#fn1">1</a></sup></p><p><img data-src="/images/CMU1544564/Lec05/69.jpg" alt="69.jpg"></p><h2 id="Background-Writing"><a href="#Background-Writing" class="headerlink" title="Background Writing"></a>Background Writing</h2><p>æˆ‘ä»¬éœ€è¦æ§åˆ¶pageè¢«å†™å›ç¡¬ç›˜çš„æ—¶é—´ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>mmap</code>,å°±å¾ˆéš¾æ§åˆ¶æ¯ä¸€ä¸ªpageå†™å›çš„æ—¶é—´ç‚¹ã€‚</p><p><img data-src="/images/CMU1544564/Lec05/70.jpg" alt="70.jpg"></p><h2 id="Other-Memory-Pool"><a href="#Other-Memory-Pool" class="headerlink" title="Other Memory Pool"></a>Other Memory Pool</h2><p><img data-src="/images/CMU1544564/Lec05/71.jpg" alt="71.jpg"></p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><img data-src="/images/CMU1544564/Lec05/72.jpg" alt="72.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/80.jpg" alt="80.jpg"></p><p>å¼•ç”¨:</p><p><a name="fn1">1</a>: CMU 15445 4. ç¼“å­˜å±‚ - è¥¿éƒ¨å°ç¬¼åŒ…: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wODUxNDIxZjRjYjg=" title="https://www.jianshu.com/p/0851421f4cb8">https://www.jianshu.com/p/0851421f4cb8<i class="fa fa-external-link"></i></span></p><p><a name="fn2">2</a>: Database Storage - fxjwind: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9wLzEwODE4ODE0Lmh0bWw=" title="https://www.cnblogs.com/fxjwind/p/10818814.html">https://www.cnblogs.com/fxjwind/p/10818814.html<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Buffer Pools - æ•°æ®åº“ç¼“å­˜åŒº&lt;/p&gt;
&lt;p&gt;Slide: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA1LWJ1ZmZlcnBvb2wucGRm&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Note: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDUtYnVmZmVycG9vbC5wZGY=&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Readings: Chapter 10.5-10.8&lt;/p&gt;
&lt;p&gt;è¿™èŠ‚ä¸¤è¯¾ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“çš„ç¼“å­˜åŒºç®¡ç†ï¼Œè¿™éƒ¨åˆ†åŸºäºå‰é¢ä¸¤èŠ‚è¯¾(Storage Iå’ŒStorage II)ã€‚&lt;/p&gt;
&lt;p&gt;ç¼“å­˜åŒºbuffer poolå°±æ˜¯åœ¨å†…å­˜ä¸­å¯¹pageçš„ç¼“å­˜(cache)ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Storage" scheme="https://cakebytheoceanluo.github.io/categories/Storage/"/>
    
      <category term="Buffer Management" scheme="https://cakebytheoceanluo.github.io/categories/Buffer-Management/"/>
    
    
      <category term="Page" scheme="https://cakebytheoceanluo.github.io/tags/Page/"/>
    
      <category term="Buffer Pool" scheme="https://cakebytheoceanluo.github.io/tags/Buffer-Pool/"/>
    
      <category term="LRU" scheme="https://cakebytheoceanluo.github.io/tags/LRU/"/>
    
      <category term="Clock" scheme="https://cakebytheoceanluo.github.io/tags/Clock/"/>
    
  </entry>
  
  <entry>
    <title>[DBMS][PostgreSQL]ç¼“å­˜åŒºç®¡ç†BufferPool</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/</id>
    <published>2020-03-17T18:46:09.000Z</published>
    <updated>2020-03-17T19:15:05.645Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« æœåŠ¡äº<a href="https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/">[CMU-15445]Lec05</a></p><p>æˆ‘ä»¬æ²¿ç”¨ä¸Šä¸€ä¸ªå®éªŒçš„æ•°æ®é›†å’Œæ•°æ®åº“:</p><ul><li>ä¸Šä¸€ä¸ªå®éªŒï¼Œè§<a href="https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/">[DBMS]Postgresæµ®ç‚¹æ•°ï¼Œå®šç‚¹æ•°ç²¾åº¦é—®é¢˜ precision_numbers</a></li><li>å…·ä½“æ•°æ®é›†ï¼Œè§<a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#CMU-15445-%E5%88%86%E6%95%B0%E6%95%B0%E6%8D%AE%E9%9B%86-Mock">[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†: CMU-15445 åˆ†æ•°æ•°æ®é›† (Mock)</a></li></ul><p>è¿™ä¸ªå®éªŒçš„ç›®çš„æ˜¯è§‚å¯ŸPostgreSQL: </p><ul><li>buffer poolå¯¹Queryæ€§èƒ½çš„å½±å“,</li><li>æ“ä½œç³»ç»Ÿæ–‡ä»¶ç¼“å­˜åŒºå¯¹Queryåœ¨page faultçš„å½±å“ï¼Œå› ä¸ºPostgreSQLä¸ä½¿ç”¨direct I/O</li></ul><a id="more"></a><hr><h1 id="æ¸…ç©ºæ“ä½œç³»ç»Ÿ-pagecache-dentries-and-inodes"><a href="#æ¸…ç©ºæ“ä½œç³»ç»Ÿ-pagecache-dentries-and-inodes" class="headerlink" title="æ¸…ç©ºæ“ä½œç³»ç»Ÿ pagecache, dentries and inodes"></a>æ¸…ç©ºæ“ä½œç³»ç»Ÿ pagecache, dentries and inodes</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            15G        9.8G        2.3G        1.9G        3.2G        3.3G</span><br><span class="line">Swap:          2.0G        1.4G        643M</span><br><span class="line">$ sync; <span class="built_in">echo</span> 3 | sudo tee /proc/sys/vm/drop_caches</span><br><span class="line">3</span><br><span class="line">$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            15G        9.9G        3.0G        1.8G        2.5G        3.3G</span><br><span class="line">Swap:          2.0G        1.4G        579M</span><br></pre></td></tr></tbody></table></figure><ul><li><code>free -h</code> å¯ä»¥æ˜¾ç¤ºç³»ç»Ÿç©ºé—²ä»¥åŠå ç”¨çš„å†…å­˜å®¹é‡<blockquote><pre><code>   free - Display amount of free and used memory in the system</code></pre></blockquote></li><li><code>sync</code> å¯ä»¥å°†ç¼“å­˜çš„é¡µå†™å…¥ç¡¬ç›˜<blockquote><pre><code>   sync - Synchronize cached writes to persistent storage</code></pre></blockquote></li><li><code>echo 3 | sudo tee /proc/sys/vm/drop_caches</code> é‡Šæ”¾ pagecache, dentries and inodes</li><li>æˆ–è€…åœ¨<code>su</code>çš„æƒé™ä¸‹<code>echo 3 &gt; /proc/sys/vm/drop_caches</code></li></ul><p>ä»ä¸Šé¢çš„è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<code>buff/cache</code>åœ¨è¿è¡ŒæŒ‡ä»¤åå‡å°‘äº†å¾ˆå¤šï¼Œè¯´æ˜è¿™å—è¢«é‡Šæ”¾äº†ä¸€éƒ¨åˆ†ã€‚</p><p><br></p><p>æœ‰å…³é˜…è¯»ï¼š</p><ul><li>How do you empty the buffers and cache on a Linux system? - Stackoverflow: <span class="exturl" data-url="aHR0cHM6Ly91bml4LnN0YWNrZXhjaGFuZ2UuY29tL3F1ZXN0aW9ucy84NzkwOC9ob3ctZG8teW91LWVtcHR5LXRoZS1idWZmZXJzLWFuZC1jYWNoZS1vbi1hLWxpbnV4LXN5c3RlbQ==" title="https://unix.stackexchange.com/questions/87908/how-do-you-empty-the-buffers-and-cache-on-a-linux-system">https://unix.stackexchange.com/questions/87908/how-do-you-empty-the-buffers-and-cache-on-a-linux-system<i class="fa fa-external-link"></i></span></li><li>How to Clear RAM Memory Cache, Buffer and Swap Space on Linux - TecMint: <span class="exturl" data-url="aHR0cHM6Ly93d3cudGVjbWludC5jb20vY2xlYXItcmFtLW1lbW9yeS1jYWNoZS1idWZmZXItYW5kLXN3YXAtc3BhY2Utb24tbGludXgv" title="https://www.tecmint.com/clear-ram-memory-cache-buffer-and-swap-space-on-linux/">https://www.tecmint.com/clear-ram-memory-cache-buffer-and-swap-space-on-linux/<i class="fa fa-external-link"></i></span></li></ul><h1 id="æ¸…ç©ºpsql-buffer-pool-é‡å¯psql"><a href="#æ¸…ç©ºpsql-buffer-pool-é‡å¯psql" class="headerlink" title="æ¸…ç©ºpsql buffer pool - é‡å¯psql"></a>æ¸…ç©ºpsql buffer pool - é‡å¯psql</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></tbody></table></figure><p>åœ¨é‡å¯PostgreSQLæœåŠ¡åï¼Œbuffer poolä¼šè¢«æ¸…ç©ºã€‚</p><h1 id="å®éªŒ-æŸ¥çœ‹-page-hit-page-fault"><a href="#å®éªŒ-æŸ¥çœ‹-page-hit-page-fault" class="headerlink" title="å®éªŒ - æŸ¥çœ‹ page hit, page fault"></a>å®éªŒ - æŸ¥çœ‹ page hit, page fault</h1><p>åœ¨è¿™æ—¶å€™æˆ‘ä»¬å·²ç»åšè¿‡äº†å‰é¢ä¸¤æ­¥ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿæ²¡æœ‰æˆ‘ä»¬éœ€è¦çš„çš„page cache</li><li>PostgreSQLçš„buffer poolæ˜¯ç©ºçš„</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">testdb=# \timing</span><br><span class="line">Timing is on.</span><br><span class="line">testdb=# <span class="built_in">set</span> max_parallel_workers_per_gather = <span class="number">0</span>;</span><br><span class="line">SET</span><br><span class="line">Time: <span class="number">7.740</span> ms</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1817.296</span>.<span class="number">.1817</span><span class="number">.296</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared <span class="built_in">read</span>=<span class="number">44248</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.401</span>.<span class="number">.814</span><span class="number">.209</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared <span class="built_in">read</span>=<span class="number">44248</span></span><br><span class="line"> Planning time: <span class="number">0.225</span> ms</span><br><span class="line"> Execution time: <span class="number">1817.316</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1824.317</span> ms (<span class="number">00</span>:<span class="number">01.824</span>)</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1772.469</span>.<span class="number">.1772</span><span class="number">.469</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">32</span> <span class="built_in">read</span>=<span class="number">44216</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.032</span>.<span class="number">.765</span><span class="number">.356</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">32</span> <span class="built_in">read</span>=<span class="number">44216</span></span><br><span class="line"> Planning time: <span class="number">0.025</span> ms</span><br><span class="line"> Execution time: <span class="number">1772.488</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1772.799</span> ms (<span class="number">00</span>:<span class="number">01.773</span>)</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1673.223</span>.<span class="number">.1673</span><span class="number">.223</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">64</span> <span class="built_in">read</span>=<span class="number">44184</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.030</span>.<span class="number">.719</span><span class="number">.406</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">64</span> <span class="built_in">read</span>=<span class="number">44184</span></span><br><span class="line"> Planning time: <span class="number">0.025</span> ms</span><br><span class="line"> Execution time: <span class="number">1673.243</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1673.562</span> ms (<span class="number">00</span>:<span class="number">01.674</span>)</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1657.359</span>.<span class="number">.1657</span><span class="number">.359</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">96</span> <span class="built_in">read</span>=<span class="number">44152</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.034</span>.<span class="number">.711</span><span class="number">.246</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">96</span> <span class="built_in">read</span>=<span class="number">44152</span></span><br><span class="line"> Planning time: <span class="number">0.025</span> ms</span><br><span class="line"> Execution time: <span class="number">1657.378</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1657.683</span> ms (<span class="number">00</span>:<span class="number">01.658</span>)</span><br></pre></td></tr></tbody></table></figure><ul><li><code>explain (analyze, buffers) select sum(a + b) from testreals;</code>ä¸­<ul><li><code>explain</code>: ç»™å‡ºquery plan</li><li><code>analyze</code>: æ‰§è¡Œquery</li><li><code>buffers</code>: ç»™å‡ºbuffer poolä¿¡æ¯</li></ul></li><li>ç„¶åæˆ‘å‰åæ‰§è¡Œ4æ¬¡åŒä¸€ä¸ªquery:<ul><li>PostgreSQLæœ‰ä¸€ä¸ªå…±ç”¨çš„share buffer pool, ç„¶åæ¯ä¸€ä¸ªqueryä¹Ÿæœ‰ä¸€ä¸ªè‡ªå·±çš„buffer poolã€‚queryçš„ä¸“å±buffer poolçš„å¤§å°ï¼Œä¼šéšç€æ‰§è¡Œæ¬¡æ•°è€Œå¢åŠ ï¼Œé»˜è®¤æ˜¯æ¯æ¬¡å¢åŠ 32ä¸ªä½ç½®ã€‚</li><li>ç¬¬ä¸€æ¬¡: <code>Buffers: shared read=44248</code> å› ä¸ºbuffer poolæ˜¯ç©ºçš„ï¼Œæ¯ä¸€æ¬¡éƒ½æ˜¯page faultã€‚åŒæ—¶æ“ä½œç³»ç»Ÿfile page cacheä¹Ÿæ˜¯ç©ºçš„ï¼Œæ‰€æœ‰pageéƒ½éœ€è¦ä»ç¡¬ç›˜å…ˆåŠ è½½åˆ°æ“ä½œç³»ç»Ÿfile page cache, åœ¨ä»è¿™é‡Œå¤åˆ¶è¿›æ•°æ®åº“buffer poolã€‚<code>shared read</code>æŒ‡çš„å°±æ˜¯page fault, æ˜¯é‚£äº›ä¸åœ¨buffer poolä¸­ï¼Œéœ€è¦ä»ç¡¬ç›˜æˆ–ä»æ“ä½œç³»ç»Ÿfile cacheä¸­è¯»å–çš„pageã€‚</li><li><strong>æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°è¿™ä¸ªè¡¨æ ¼ä¸€å…±å¯¹åº”<code>44248</code>ä¸ªpageã€‚</strong></li><li>ç¬¬äºŒæ¬¡: <code>Buffers: shared hit=32 read=44216</code> Queryçš„buffer poolæ˜¯å¤§å°æ˜¯32ï¼Œ å·²å¢åŠ 32ä¸ªä½ç½®ã€‚</li><li>ç¬¬ä¸‰æ¬¡: <code>Buffers: shared hit=64 read=44184</code> Queryçš„buffer poolæ˜¯å¤§å°æ˜¯64ï¼Œ å·²å¢åŠ 32ä¸ªä½ç½®ã€‚</li><li>ç¬¬å››æ¬¡: <code>Buffers: shared hit=96 read=44152</code> Queryçš„buffer poolæ˜¯å¤§å°æ˜¯94ï¼Œ å·²å¢åŠ 32ä¸ªä½ç½®ã€‚</li></ul></li></ul><h1 id="å®éªŒ-æ‰©å¤§buffer-pool-size"><a href="#å®éªŒ-æ‰©å¤§buffer-pool-size" class="headerlink" title="å®éªŒ - æ‰©å¤§buffer pool size"></a>å®éªŒ - æ‰©å¤§buffer pool size</h1><p>ä¸‹é¢æˆ‘ä»¬å‘ç°æœ€å¤§çš„buffer pool sizeæ˜¯<code>128MB</code>ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# show shared_buffers;</span><br><span class="line"> shared_buffers </span><br><span class="line">----------------</span><br><span class="line"> <span class="number">128</span>MB</span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">0.196</span> ms</span><br></pre></td></tr></tbody></table></figure><p>ä½†æ˜¯æˆ‘ä»¬å¯¹åº”çš„è¡¨æ ¼çš„æ‰€æœ‰pageå¤§æ¦‚æ˜¯<code>345MB</code>, æ¯ä¸€ä¸ªpageæ˜¯<code>8KiB</code>:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select (<span class="number">44248</span> * <span class="number">8</span>) / <span class="number">1024</span>;</span><br><span class="line"> ?column? </span><br><span class="line">----------</span><br><span class="line">      <span class="number">345</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">0.381</span> ms</span><br></pre></td></tr></tbody></table></figure><p>å› æ­¤è¿™ä¸ªé»˜è®¤çš„buffer pool sizeä¸è¶³ä»¥å®¹çº³æˆ‘ä»¬è¿™ä¸ªè¡¨æ ¼ã€‚æ­£å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬çš„queryéœ€è¦çš„pageæ•°æ€»å¤§äºbuffer sizeä¸€æ¬¡æ€§æ‰€èƒ½å®¹çº³çš„æ•°é‡ï¼Œä¸€å®šä¼šå‡ºç°page faultã€‚</p><h2 id="æ›´æ”¹PostgresSQLé…ç½®æ–‡ä»¶ä¸­çš„shared-buffers"><a href="#æ›´æ”¹PostgresSQLé…ç½®æ–‡ä»¶ä¸­çš„shared-buffers" class="headerlink" title="æ›´æ”¹PostgresSQLé…ç½®æ–‡ä»¶ä¸­çš„shared_buffers"></a>æ›´æ”¹PostgresSQLé…ç½®æ–‡ä»¶ä¸­çš„<code>shared_buffers</code></h2><p>æˆ‘ä»¬ç”¨è‡ªå·±å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨å»æ‰“å¼€<code>/etc/postgresql/10/main/postgresql.conf</code>æ–‡ä»¶:</p><ul><li>æ³¨æ„æˆ‘postgresqlçš„ç‰ˆæœ¬æ˜¯<code>10</code></li><li>å…·ä½“çš„é…ç½®æ–‡ä»¶ä½ç½®å’Œpostgresqlå®‰è£…ä½ç½®å’Œå®‰è£…ç‰ˆæœ¬æœ‰å…³</li></ul><p>æ‰¾åˆ°ä¸‹é¢å¯¹åº”çš„<code>shared_buffers</code>, æ›´æ”¹æ•°å€¼ä¸º<code>360MB</code>:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------                                                                                          </span></span><br><span class="line"><span class="comment"># RESOURCE USAGE (except WAL)                                                                                                                                            </span></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------                                                                                          </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Memory -                                                                                                                                                             </span></span><br><span class="line"></span><br><span class="line">shared_buffers = 128MB                  <span class="comment"># min 128kB  </span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>ä¿å­˜å®Œä»¥åæˆ‘ä»¬æ‰“å¼€<code>psql</code>çœ‹çœ‹æ˜¯å¦æ›´æ”¹æˆåŠŸã€‚å¦‚æœåƒä¸‹é¢ä¾‹å­ä¸­ï¼Œçœ‹è§<code>360MB</code>ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„<code>128MB</code>,å³æ›´æ”¹æˆåŠŸï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">testdb=# show shared_buffers;</span><br><span class="line"> shared_buffers </span><br><span class="line">----------------</span><br><span class="line"> <span class="number">360</span>MB</span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure><h2 id="é‡æ–°ä¹‹å‰å®éªŒ-å†·å¯åŠ¨"><a href="#é‡æ–°ä¹‹å‰å®éªŒ-å†·å¯åŠ¨" class="headerlink" title="é‡æ–°ä¹‹å‰å®éªŒ - å†·å¯åŠ¨"></a>é‡æ–°ä¹‹å‰å®éªŒ - å†·å¯åŠ¨</h2><p>æˆ‘ä»¬ä¾ç„¶æ‰§è¡Œä¸‹é¢ä¸¤ä¸ªå‘½ä»¤ï¼Œ å»æ¸…ç©ºæ“ä½œç³»ç»Ÿfile page cacheå’Œæ•°æ®åº“çš„buffer pool:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sync; <span class="built_in">echo</span> 3 | sudo tee /proc/sys/vm/drop_caches</span><br><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·æ“ä½œä»¥åæˆ‘ä»¬çš„æ•°æ®åº“buffer poolè¢«æ¸…ç©ºï¼Œæ“ä½œç³»ç»Ÿpage cacheé‡Œé¢ä¹Ÿæ²¡ä¹Ÿå¯¹åº”çš„page, æ‰€ä»¥æˆ‘ä»¬ç§°ä¹‹ä¸º<strong>å†·å¯åŠ¨</strong>ã€‚</p><p><br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">testdb=# \timing</span><br><span class="line">Timing is on.</span><br><span class="line"></span><br><span class="line">testdb=# <span class="built_in">set</span> max_parallel_workers_per_gather = <span class="number">0</span>;</span><br><span class="line">SET</span><br><span class="line">Time: <span class="number">9.680</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# CREATE EXTENSION pg_prewarm;</span><br><span class="line">CREATE EXTENSION</span><br><span class="line">Time: <span class="number">12.151</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# select * from pg_prewarm('testreals');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">      <span class="number">44248</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">473.944</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1628.475</span>.<span class="number">.1628</span><span class="number">.475</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">44248</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.008</span>.<span class="number">.664</span><span class="number">.942</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">44248</span></span><br><span class="line"> Planning time: <span class="number">6.139</span> ms</span><br><span class="line"> Execution time: <span class="number">1628.495</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br></pre></td></tr></tbody></table></figure><ul><li><code>select * from pg_prewarm('testreals');</code>æˆ–<code>select pg_prewarm('testreals');</code>æ˜¯å°†è¿™ä¸ªè¡¨æ ¼çš„æ‰€æœ‰pageéƒ½é¢„åŠ è½½è¿›buffer poolã€‚å› ä¸ºæˆ‘ä»¬è°ƒæ•´è¿‡shared buffer pool size, ç°åœ¨æˆ‘ä»¬çš„shared buffer poolè¶³å¤Ÿå®¹çº³è¿™ä¸ªè¡¨æ ¼å¯¹åº”çš„æ‰€æœ‰pageäº†ã€‚<strong>æ³¨æ„è¿™ä¸ªæ‰§è¡Œçš„è¿”å›å€¼<code>44248</code>, å®ƒå°±æ˜¯è¿™ä¸ªè¡¨æ ¼æ‰€æœ‰å¯¹åº”pageçš„æ•°å€¼ã€‚</strong></li><li><code>CREATE EXTENSION pg_prewarm;</code>è¿™ä¸ªæŒ‡ä»¤æ˜¯è¿è¡Œä¸Šä¸€æ¡æŒ‡ä»¤çš„å‰æã€‚</li><li>ç„¶åæˆ‘ä»¬åˆè§åˆ°è¿™ä¸ªqueryï¼š <code>explain (analyze, buffers) select sum(a + b) from testreals;</code><ul><li><code>Buffers: shared hit=44248</code> <strong>æˆ‘ä»¬åˆå‘ç°<code>44248</code>è¿™ä¸ªæ•°å€¼ï¼Œè¯´æ˜æ‰€æœ‰çš„pageéƒ½æ˜¯page hitï¼Œè€Œä¸æ˜¯page faultã€‚</strong></li></ul></li></ul><p><br></p><p>çƒ­å¯åŠ¨å¥½åƒæ— æ³•åœ¨psqlä¸­ç›´æ¥å±•ç¤ºï¼Œè¿™é‡Œç•¥è¿‡ã€‚ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">ğŸ˜‚</span></p><p><br></p><p>æ¨èçš„é˜…è¯»ï¼š</p><p>PREWARMING POSTGRESQL I/O CACHES - Hans-JÃ¼rgen SchÃ¶nigï¼š <span class="exturl" data-url="aHR0cHM6Ly93d3cuY3liZXJ0ZWMtcG9zdGdyZXNxbC5jb20vZW4vcHJld2FybWluZy1wb3N0Z3Jlc3FsLWktby1jYWNoZXMv" title="https://www.cybertec-postgresql.com/en/prewarming-postgresql-i-o-caches/">https://www.cybertec-postgresql.com/en/prewarming-postgresql-i-o-caches/<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡æ–‡ç« æœåŠ¡äº&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/&quot;&gt;[CMU-15445]Lec05&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬æ²¿ç”¨ä¸Šä¸€ä¸ªå®éªŒçš„æ•°æ®é›†å’Œæ•°æ®åº“:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸Šä¸€ä¸ªå®éªŒï¼Œè§&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/&quot;&gt;[DBMS]Postgresæµ®ç‚¹æ•°ï¼Œå®šç‚¹æ•°ç²¾åº¦é—®é¢˜ precision_numbers&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;å…·ä½“æ•°æ®é›†ï¼Œè§&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#CMU-15445-%E5%88%86%E6%95%B0%E6%95%B0%E6%8D%AE%E9%9B%86-Mock&quot;&gt;[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†: CMU-15445 åˆ†æ•°æ•°æ®é›† (Mock)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™ä¸ªå®éªŒçš„ç›®çš„æ˜¯è§‚å¯ŸPostgreSQL: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;buffer poolå¯¹Queryæ€§èƒ½çš„å½±å“,&lt;/li&gt;
&lt;li&gt;æ“ä½œç³»ç»Ÿæ–‡ä»¶ç¼“å­˜åŒºå¯¹Queryåœ¨page faultçš„å½±å“ï¼Œå› ä¸ºPostgreSQLä¸ä½¿ç”¨direct I/O&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Storage" scheme="https://cakebytheoceanluo.github.io/categories/Storage/"/>
    
      <category term="DBMS" scheme="https://cakebytheoceanluo.github.io/categories/DBMS/"/>
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/categories/PostgreSQL/"/>
    
      <category term="Buffer Management" scheme="https://cakebytheoceanluo.github.io/categories/Buffer-Management/"/>
    
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
</feed>
