<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>关于数据库的一切</title>
  <icon>https://www.gravatar.com/avatar/60437615b712b01d1a7c334c61fc1a4f</icon>
  <subtitle>罗济高的博客</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://cakebytheoceanluo.github.io/"/>
  <updated>2020-04-06T13:17:11.073Z</updated>
  <id>https://cakebytheoceanluo.github.io/</id>
  
  <author>
    <name>罗济高</name>
    <email>luojigao@outlook.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>[SQL]高级SQL-窗口函数(5)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/06/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-5/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/06/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-5/</id>
    <published>2020-04-06T13:16:29.000Z</published>
    <updated>2020-04-06T13:17:11.073Z</updated>
    
    <content type="html"><![CDATA[<p>我们继续练习窗口函数，这次我们使用TPC-H数据集来练习。TPC-H是一个商业决策反向的数据集，因此里面有很多金额/销售额/年度销售额/国家销售额等等OLAP的数目可以被计算。</p><a id="more"></a><h1 id="TPC-H-数据集"><a href="#TPC-H-数据集" class="headerlink" title="TPC-H 数据集"></a>TPC-H 数据集</h1><p>我们这一篇文章采用PostgreSQL的SQL语法。重点我们关注<code>select...from...where</code>这种读操作，分析query　(analytical query)。<br><code>TPC-H</code>数据集在　<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>　可以直接使用。另外在这个网页不允许进行写操作:<code>insert</code>, <code>update</code>, <code>delete</code>之类的transactional query。当然<code>create table</code>和<code>drop table</code>也不被允许。</p><p><strong>本地载入改数据集</strong>的方法见我的博客两篇文章:</p><ul><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL 导入 TPC-H 数据集</a></li><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL 导入数据集</a></li></ul><h2 id="统计每一个customer的总o-totalprice"><a href="#统计每一个customer的总o-totalprice" class="headerlink" title="统计每一个customer的总o_totalprice"></a>统计每一个customer的总o_totalprice</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o_custkey, o_orderdate,</span><br><span class="line">       <span class="keyword">sum</span>(o_totalprice) <span class="keyword">over</span> <span class="comment">-- window function</span></span><br><span class="line">    (<span class="keyword">partition</span> <span class="keyword">by</span> o_custkey <span class="comment">-- partitioning clause</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> o_orderdate <span class="comment">-- ordering clause</span></span><br><span class="line">    <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">    ) <span class="comment">-- framing clause</span></span><br><span class="line">    <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders;</span><br></pre></td></tr></tbody></table></figure><p>课件上面的版本其实不能充分显示出window function的作用，我们可以用下面的版本，同时看一下对应的输出：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o_custkey, o_orderdate, o_totalprice,</span><br><span class="line">       <span class="keyword">sum</span>(o_totalprice) <span class="keyword">over</span> <span class="comment">-- window function</span></span><br><span class="line">    (<span class="keyword">partition</span> <span class="keyword">by</span> o_custkey <span class="comment">-- partitioning clause</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> o_orderdate <span class="comment">-- ordering clause</span></span><br><span class="line">    <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">    ) <span class="comment">-- framing clause</span></span><br><span class="line">    <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_custkey, o_orderdate;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> o_custkey | o_orderdate | o_totalprice | o_totalprice_sum </span><br><span class="line"><span class="comment">-----------+-------------+--------------+------------------</span></span><br><span class="line">         1 | 1992-10-21  |    202660.52 |        202660.52</span><br><span class="line">         1 | 1993-08-05  |      4225.26 |        206885.78</span><br><span class="line">         1 | 1997-05-09  |    113954.89 |        320840.67</span><br><span class="line">         1 | 1997-11-21  |     39835.54 |        360676.21</span><br><span class="line">         1 | 1998-05-31  |    159171.69 |        519847.90</span><br><span class="line">         2 | 1992-07-08  |     44777.63 |         44777.63</span><br><span class="line">         2 | 1992-08-28  |     89399.40 |        134177.03</span><br><span class="line">         2 | 1993-03-09  |    169847.63 |        304024.66</span><br><span class="line">         2 | 1993-07-31  |     29305.47 |        333330.13</span><br><span class="line">         2 | 1993-12-31  |    179984.42 |        513314.55</span><br><span class="line">         2 | 1994-04-20  |     41433.48 |        554748.03</span><br><span class="line">         2 | 1996-08-16  |     63873.14 |        618621.17</span><br><span class="line">         2 | 1997-06-09  |     24362.39 |        642983.56</span><br><span class="line">         2 | 1998-05-28  |    140363.70 |        783347.26</span><br><span class="line">         .................................................</span><br></pre></td></tr></tbody></table></figure><p>我们可以关注<code>o_totalprice_sum</code>这个字段，它对每一个独立的<code>o_custkey</code>的不同<code>o_orderdate</code>的<code>o_totalprice</code>进行累加。</p><ul><li><code>o_custkey</code>: partition</li><li><code>o_orderdate</code>: order by 进行排序</li><li><code>range between unbounded preceding and current row</code>： 从这个<code>o_custkey</code>第一个<code>o_orderdate</code>到当前<code>o_orderdate</code></li></ul><p><br></p><p>针对这第一个例子，我们来用<strong>不带window function的版本</strong>去完成同样这个任务，<strong>统计每一个customer的总o_totalprice</strong>:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o1.o_custkey, o1.o_orderdate, o1.o_totalprice, <span class="keyword">sum</span>(o2.o_totalprice) <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders o1, orders o2</span><br><span class="line"><span class="keyword">where</span> o1.o_custkey = o2.o_custkey <span class="keyword">and</span> o1.o_orderdate &gt;= o2.o_orderdate</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o1.o_custkey, o1.o_orderdate, o1.o_totalprice</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o1.o_custkey, o1.o_orderdate;</span><br></pre></td></tr></tbody></table></figure><p>这里还需要提一下，上面这个不带window function的版本运行很慢，而带window function会快很多。(我在PostgreSQL和HyPer均比较过。)</p><p><br></p><h2 id="累计每一个o-orderdate-customer的o-totalprice，按照o-custkey来顺序累加"><a href="#累计每一个o-orderdate-customer的o-totalprice，按照o-custkey来顺序累加" class="headerlink" title="累计每一个o_orderdate customer的o_totalprice，按照o_custkey来顺序累加"></a>累计每一个o_orderdate customer的o_totalprice，按照o_custkey来顺序累加</h2><p>累计每一个o_orderdate(每一天)customer的o_totalprice，按照o_custkey来顺序累加</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o_orderdate, o_custkey, o_totalprice, <span class="keyword">sum</span>(o_totalprice) <span class="keyword">over</span></span><br><span class="line">    (<span class="keyword">partition</span> <span class="keyword">by</span> o_orderdate</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> o_custkey</span><br><span class="line">    <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">    ) <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderdate, o_custkey;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> o_orderdate | o_custkey | o_totalprice | o_totalprice_sum </span><br><span class="line"><span class="comment">-------------+-----------+--------------+------------------</span></span><br><span class="line"> 1992-01-01  |        34 |     86534.05 |         86534.05</span><br><span class="line"> 1992-01-01  |        92 |     24660.06 |        111194.11</span><br><span class="line"> 1992-01-02  |        17 |     40975.96 |         40975.96</span><br><span class="line"> 1992-01-02  |        49 |    210713.88 |        251689.84</span><br><span class="line"> 1992-01-02  |        64 |    127527.05 |        379216.89</span><br><span class="line"> 1992-01-04  |        70 |     84053.93 |         84053.93</span><br><span class="line"> 1992-01-06  |        11 |    118570.79 |        118570.79</span><br><span class="line"> 1992-01-06  |        37 |     91795.13 |        210365.92</span><br><span class="line"> 1992-01-07  |        62 |     58168.07 |         58168.07</span><br><span class="line"> 1992-01-09  |        13 |    145040.38 |        145040.38</span><br><span class="line"> 1992-01-09  |        25 |    145906.24 |        290946.62</span><br><span class="line"> .........................................................</span><br></pre></td></tr></tbody></table></figure><p>不带window function的版本：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o1.o_orderdate, o1.o_custkey, o1.o_totalprice, <span class="keyword">sum</span>(o2.o_totalprice) <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders o1, orders o2</span><br><span class="line"><span class="keyword">where</span> o1.o_orderdate = o2.o_orderdate <span class="keyword">and</span> o1.o_custkey &gt;= o2.o_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o1.o_orderdate, o1.o_custkey, o1.o_totalprice</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderdate, o_custkey;</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="计算每一个GERMANY的customer每一年的running-sum-o-totalprice"><a href="#计算每一个GERMANY的customer每一年的running-sum-o-totalprice" class="headerlink" title="计算每一个GERMANY的customer每一年的running sum(o_totalprice)"></a>计算每一个GERMANY的customer每一年的running sum(o_totalprice)</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> base_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> c_custkey, <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> o_orderdate) <span class="keyword">as</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> yr_revernue</span><br><span class="line">    <span class="keyword">from</span> nation, customer, orders</span><br><span class="line">    <span class="keyword">where</span> n_name = <span class="string">'GERMANY'</span> <span class="keyword">and</span> n_nationkey = c_nationkey <span class="keyword">and</span> c_custkey = o_custkey</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_custkey, <span class="keyword">year</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> c_custkey, <span class="keyword">year</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *,</span><br><span class="line">       <span class="keyword">sum</span>(yr_revernue) <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> c_custkey</span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span></span><br><span class="line">           <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">0</span> <span class="keyword">following</span></span><br><span class="line">           ) <span class="keyword">as</span> running_sum</span><br><span class="line"><span class="keyword">from</span> base_table;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">c_custkey | year | yr_revernue | running_sum </span><br><span class="line"><span class="comment">-----------+------+-------------+-------------</span></span><br><span class="line">        62 | 1992 |   169991.32 |   169991.32</span><br><span class="line">        62 | 1993 |   174385.47 |   344376.79</span><br><span class="line">        62 | 1994 |    89262.19 |   433638.98</span><br><span class="line">        62 | 1995 |   526408.33 |   960047.31</span><br><span class="line">        62 | 1996 |   412013.97 |  1372061.28</span><br><span class="line">        62 | 1997 |   286185.97 |  1658247.25</span><br><span class="line">        62 | 1998 |   397422.69 |  2055669.94</span><br><span class="line">        71 | 1992 |   403017.41 |   403017.41</span><br><span class="line">        71 | 1993 |   348239.45 |   751256.86</span><br><span class="line">        71 | 1994 |   270189.86 |  1021446.72</span><br><span class="line">        71 | 1995 |   239565.38 |  1261012.10</span><br><span class="line">        71 | 1997 |   203579.58 |  1464591.68</span><br><span class="line">        71 | 1998 |   174001.98 |  1638593.66</span><br><span class="line">        .....................................</span><br></pre></td></tr></tbody></table></figure><p>&lt;/br&gt;</p><h3 id="对不同国家的order数量进行排序，选出前几名"><a href="#对不同国家的order数量进行排序，选出前几名" class="headerlink" title="对不同国家的order数量进行排序，选出前几名"></a>对不同国家的order数量进行排序，选出前几名</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/28.jpg" alt="28.jpg"></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *, </span><br><span class="line">        <span class="keyword">case</span> (<span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>)) </span><br><span class="line">              <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">              <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">              <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c</span><br><span class="line">    <span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line">    <span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_custkey) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c,</span><br><span class="line">       <span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">rank</span>,</span><br><span class="line">       <span class="keyword">case</span> (<span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>))  </span><br><span class="line">             <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">else</span> <span class="string">' '</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line"><span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_custkey</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> c_custkey | c  | case </span><br><span class="line"><span class="comment">-----------+----+------</span></span><br><span class="line">      3451 | 41 | gold</span><br><span class="line">    102022 | 41 | gold</span><br><span class="line">    102004 | 41 | gold</span><br><span class="line">    122623 | 40 | </span><br><span class="line">     79300 | 40 | </span><br><span class="line">    117082 | 40 | </span><br><span class="line">     69682 | 39 | </span><br><span class="line">    143500 | 39 | </span><br><span class="line">    129637 | 38 | </span><br><span class="line">    124048 | 38 |</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *, </span><br><span class="line">       <span class="keyword">case</span> (<span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>)) </span><br><span class="line">             <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c</span><br><span class="line">    <span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line">    <span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_custkey) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c,</span><br><span class="line">       <span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">rank</span>,</span><br><span class="line">       <span class="keyword">case</span> (<span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>))  </span><br><span class="line">             <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">else</span> <span class="string">' '</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line"><span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_custkey</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> c_custkey | c  |  case  </span><br><span class="line"><span class="comment">-----------+----+--------</span></span><br><span class="line">      3451 | 41 | gold</span><br><span class="line">    102022 | 41 | gold</span><br><span class="line">    102004 | 41 | gold</span><br><span class="line">    122623 | 40 | silver</span><br><span class="line">     79300 | 40 | silver</span><br><span class="line">    117082 | 40 | silver</span><br><span class="line">     69682 | 39 | bronze</span><br><span class="line">    143500 | 39 | bronze</span><br><span class="line">    129637 | 38 | </span><br><span class="line">    124048 | 38 |</span><br></pre></td></tr></tbody></table></figure><p>给出了两种不同方法，取决于我们怎么定义奖牌(怎么定义排名)。</p><p><br><br><br>s</p><h3 id="求每一年的revenue的百分比比前一年的变化："><a href="#求每一年的revenue的百分比比前一年的变化：" class="headerlink" title="求每一年的revenue的百分比比前一年的变化："></a>求每一年的revenue的百分比比前一年的变化：</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/29.jpg" alt="29.jpg"></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> orders_with_years <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> * , <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> o_orderdate) <span class="keyword">as</span> <span class="keyword">year</span></span><br><span class="line">    <span class="keyword">from</span> orders</span><br><span class="line">    ), tmp_re <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> revenue</span><br><span class="line">    <span class="keyword">from</span> orders_with_years</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">year</span></span><br><span class="line">    ), tmp_re_comp <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *, lag(revenue, <span class="number">1</span>, <span class="literal">null</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span>) <span class="keyword">as</span> prev</span><br><span class="line">    <span class="keyword">from</span> tmp_re</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *, <span class="keyword">round</span>(<span class="number">100</span> * ((revenue - prev) / prev), <span class="number">2</span>) <span class="keyword">as</span> differ_percentage</span><br><span class="line"><span class="keyword">from</span> tmp_re_comp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> year |    revenue     |      prev      | differ_percentage </span><br><span class="line"><span class="comment">------+----------------+----------------+-------------------</span></span><br><span class="line"> 1992 | 34330674052.43 |                |                  </span><br><span class="line"> 1993 | 34340410079.03 | 34330674052.43 |              0.03</span><br><span class="line"> 1994 | 34416369052.97 | 34340410079.03 |              0.22</span><br><span class="line"> 1995 | 34546133183.60 | 34416369052.97 |              0.38</span><br><span class="line"> 1996 | 34609364760.86 | 34546133183.60 |              0.18</span><br><span class="line"> 1997 | 34373633413.04 | 34609364760.86 |             -0.68</span><br><span class="line"> 1998 | 20212721905.53 | 34373633413.04 |            -41.20</span><br></pre></td></tr></tbody></table></figure><hr><p>引用: </p><p>课件: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;我们继续练习窗口函数，这次我们使用TPC-H数据集来练习。TPC-H是一个商业决策反向的数据集，因此里面有很多金额/销售额/年度销售额/国家销售额等等OLAP的数目可以被计算。&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="TUM-IN2326" scheme="https://cakebytheoceanluo.github.io/categories/TUM-IN2326/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-窗口函数(4)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/05/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-4/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/05/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-4/</id>
    <published>2020-04-05T18:08:57.000Z</published>
    <updated>2020-04-05T18:09:42.250Z</updated>
    
    <content type="html"><![CDATA[<p>在前三篇文章中我们基本上认识了window function。这次我们有具体的数据集去进行大量练习(绝大部分是排名)。</p><a id="more"></a><h1 id="数据集"><a href="#数据集" class="headerlink" title="数据集"></a>数据集</h1><p>我们这一篇文章采用PostgreSQL的SQL语法。重点我们关注<code>select...from...where</code>这种读操作，分析query　(analytical query)。<br>数据集在　<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>　可以直接使用。另外在这个网页不允许进行写操作:<code>insert</code>, <code>update</code>, <code>delete</code>之类的transactional query。当然<code>create table</code>和<code>drop table</code>也不被允许。</p><p>架构 Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p><p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p><p>下载:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p><p>Schma和大部分SQL语句来自<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>的课件和书。</p><p>课件：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li></ul><p>书：　<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p><p><br><br><br></p><h1 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h1><h2 id="教授例子"><a href="#教授例子" class="headerlink" title="教授例子"></a>教授例子</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> Professors;</span><br><span class="line"></span><br><span class="line"> persnr |    name     | paygrade | room | salary | taxclass </span><br><span class="line"><span class="comment">--------+-------------+----------+------+--------+----------</span></span><br><span class="line">   2125 | Sokrates    | C4       |  226 |  85000 |        1</span><br><span class="line">   2126 | Russel      | C4       |  232 |  80000 |        3</span><br><span class="line">   2127 | Kopernikus  | C3       |  310 |  65000 |        5</span><br><span class="line">   2128 | Aristoteles | C4       |  250 |  85000 |        1</span><br><span class="line">   2133 | Popper      | C3       |   52 |  68000 |        1</span><br><span class="line">   2134 | Augustinus  | C3       |  309 |  55000 |        5</span><br><span class="line">   2136 | Curie       | C4       |   36 |  95000 |        3</span><br><span class="line">   2137 | Kant        | C4       |    7 |  98000 |        1</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="根据salary排名"><a href="#根据salary排名" class="headerlink" title="根据salary排名:"></a>根据salary排名:</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary,</span><br><span class="line">       <span class="keyword">rank</span>() <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span></span><br><span class="line">       ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">rank</span> <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary | rank </span><br><span class="line"><span class="comment">--------+-------------+--------+------</span></span><br><span class="line">   2137 | Kant        |  98000 |    1</span><br><span class="line">   2136 | Curie       |  95000 |    2</span><br><span class="line">   2125 | Sokrates    |  85000 |    3</span><br><span class="line">   2128 | Aristoteles |  85000 |    3</span><br><span class="line">   2126 | Russel      |  80000 |    5</span><br><span class="line">   2133 | Popper      |  68000 |    6</span><br><span class="line">   2127 | Kopernikus  |  65000 |    7</span><br><span class="line">   2134 | Augustinus  |  55000 |    8</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="在同一个pay-grade组中，根据salary排名"><a href="#在同一个pay-grade组中，根据salary排名" class="headerlink" title="在同一个pay grade组中，根据salary排名:"></a>在同一个pay grade组中，根据salary排名:</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary, paygrade,</span><br><span class="line">       <span class="keyword">rank</span>() <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> paygrade</span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span></span><br><span class="line">       ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> paygrade <span class="keyword">asc</span>, <span class="keyword">rank</span> <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary | paygrade | rank </span><br><span class="line">--------+-------------+--------+----------+------</span><br><span class="line">   2133 | Popper      |  68000 | C3       |    1</span><br><span class="line">   2127 | Kopernikus  |  65000 | C3       |    2</span><br><span class="line">   2134 | Augustinus  |  55000 | C3       |    3</span><br><span class="line">   2137 | Kant        |  98000 | C4       |    1</span><br><span class="line">   2136 | Curie       |  95000 | C4       |    2</span><br><span class="line">   2128 | Aristoteles |  85000 | C4       |    3</span><br><span class="line">   2125 | Sokrates    |  85000 | C4       |    3</span><br><span class="line">   2126 | Russel      |  80000 | C4       |    5</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="在同一个pay-grade组中，计算salary-running-sum"><a href="#在同一个pay-grade组中，计算salary-running-sum" class="headerlink" title="在同一个pay grade组中，计算salary running sum:"></a>在同一个pay grade组中，计算salary running sum:</h3><p>在同一个pay grade组中，计算每一个professor的salary running sum(即salary小于该professor的其他professor的salary总和)</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">sum</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">        )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure><p>或者加上一行<code>range</code>:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">sum</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">           <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="keyword">UNBOUNDED</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span> <span class="comment">-- 这行是默认值</span></span><br><span class="line">        )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | paygrade | salary |  sum   </span><br><span class="line"><span class="comment">--------+-------------+----------+--------+--------</span></span><br><span class="line">   2134 | Augustinus  | C3       |  55000 |  55000</span><br><span class="line">   2127 | Kopernikus  | C3       |  65000 | 120000</span><br><span class="line">   2133 | Popper      | C3       |  68000 | 188000</span><br><span class="line">   2126 | Russel      | C4       |  80000 |  80000</span><br><span class="line">   2125 | Sokrates    | C4       |  85000 | 250000</span><br><span class="line">   2128 | Aristoteles | C4       |  85000 | 250000</span><br><span class="line">   2136 | Curie       | C4       |  95000 | 345000</span><br><span class="line">   2137 | Kant        | C4       |  98000 | 443000</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="在同一个pay-grade组中，计算salary-running-average"><a href="#在同一个pay-grade组中，计算salary-running-average" class="headerlink" title="在同一个pay grade组中，计算salary running average:"></a>在同一个pay grade组中，计算salary running average:</h3><ul><li>在同一个pay grade组中，计算每一个professor的salary running average(即考虑两个上方的professor，再考虑两个下方的professor)</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">avg</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">           <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="number">2</span> <span class="keyword">FOLLOWING</span></span><br><span class="line">           )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | paygrade | salary |        avg         </span><br><span class="line"><span class="comment">--------+-------------+----------+--------+--------------------</span></span><br><span class="line">   2134 | Augustinus  | C3       |  55000 | 62666.666666666667</span><br><span class="line">   2127 | Kopernikus  | C3       |  65000 | 62666.666666666667</span><br><span class="line">   2133 | Popper      | C3       |  68000 | 62666.666666666667</span><br><span class="line">   2126 | Russel      | C4       |  80000 | 83333.333333333333</span><br><span class="line">   2125 | Sokrates    | C4       |  85000 | 86250.000000000000</span><br><span class="line">   2128 | Aristoteles | C4       |  85000 | 88600.000000000000</span><br><span class="line">   2136 | Curie       | C4       |  95000 | 90750.000000000000</span><br><span class="line">   2137 | Kant        | C4       |  98000 | 92666.666666666667</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><ul><li>在pay grade组中，计算每一个professor的salary running average(即考虑比该professor的salary低5000,高5000区间中professor的salary的平均值)：</li></ul><p>PostgreSQL无法执行这一条，需使用HyPer网页接口：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">avg</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">           <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="number">5000</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="number">5000</span> <span class="keyword">FOLLOWING</span></span><br><span class="line">           )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | paygrade | salary |        avg         </span><br><span class="line"><span class="comment">--------+-------------+----------+--------+--------------------</span></span><br><span class="line">   2134 | Augustinus  | C3       |  55000 | 55000.0000</span><br><span class="line">   2127 | Kopernikus  | C3       |  65000 | 66500.0000</span><br><span class="line">   2133 | Popper      | C3       |  68000 | 66500.0000</span><br><span class="line">   2126 | Russel      | C4       |  80000 | 83333.3333</span><br><span class="line">   2125 | Sokrates    | C4       |  85000 | 83333.3333</span><br><span class="line">   2128 | Aristoteles | C4       |  85000 | 83333.3333</span><br><span class="line">   2136 | Curie       | C4       |  95000 | 96500.0000</span><br><span class="line">   2137 | Kant        | C4       |  98000 | 96500.0000</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="根据salary排名，给出前一名和后一名："><a href="#根据salary排名，给出前一名和后一名：" class="headerlink" title="根据salary排名，给出前一名和后一名："></a>根据salary排名，给出前一名和后一名：</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary,</span><br><span class="line">       lag(<span class="keyword">name</span>) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">           ),</span><br><span class="line">       <span class="keyword">lead</span>(<span class="keyword">name</span>) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">           )</span><br><span class="line"><span class="keyword">FROM</span> Professors;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary |     lag     |    lead     </span><br><span class="line"><span class="comment">--------+-------------+--------+-------------+-------------</span></span><br><span class="line">   2137 | Kant        |  98000 |             | Curie</span><br><span class="line">   2136 | Curie       |  95000 | Kant        | Sokrates</span><br><span class="line">   2125 | Sokrates    |  85000 | Curie       | Aristoteles</span><br><span class="line">   2128 | Aristoteles |  85000 | Sokrates    | Russel</span><br><span class="line">   2126 | Russel      |  80000 | Aristoteles | Popper</span><br><span class="line">   2133 | Popper      |  68000 | Russel      | Kopernikus</span><br><span class="line">   2127 | Kopernikus  |  65000 | Popper      | Augustinus</span><br><span class="line">   2134 | Augustinus  |  55000 | Kopernikus  | </span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><ul><li>计算出salary的前三名：</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary, <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> *,</span><br><span class="line">           <span class="keyword">rank</span>() <span class="keyword">OVER</span> (</span><br><span class="line">               <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">desc</span></span><br><span class="line">               ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line">    <span class="keyword">FROM</span> Professors</span><br><span class="line">) <span class="keyword">as</span> temp</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">rank</span> &lt; <span class="number">4</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">), temp <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> *,</span><br><span class="line">           <span class="keyword">rank</span>() <span class="keyword">OVER</span> (</span><br><span class="line">               <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">desc</span></span><br><span class="line">               ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line">    <span class="keyword">FROM</span> Professors</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary, <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> temp</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">rank</span> &lt; <span class="number">4</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary | rank </span><br><span class="line"><span class="comment">--------+-------------+--------+------</span></span><br><span class="line">   2137 | Kant        |  98000 |    1</span><br><span class="line">   2136 | Curie       |  95000 |    2</span><br><span class="line">   2125 | Sokrates    |  85000 |    3</span><br><span class="line">   2128 | Aristoteles |  85000 |    3</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure><p>不使用窗口函数的版本：<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary</span><br><span class="line"><span class="keyword">FROM</span> Professors p</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">3</span> &gt; (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">FROM</span> Professors c</span><br><span class="line">    <span class="keyword">WHERE</span> p.salary &lt; c.salary</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary </span><br><span class="line"><span class="comment">--------+-------------+--------</span></span><br><span class="line">   2125 | Sokrates    |  85000</span><br><span class="line">   2128 | Aristoteles |  85000</span><br><span class="line">   2136 | Curie       |  95000</span><br><span class="line">   2137 | Kant        |  98000</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>这里要提一下，下面这个版本不对，它无法照顾到并列的名次:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">values</span> (<span class="number">2125</span>,<span class="string">'Sokrates'</span>,<span class="string">'C4'</span>,<span class="number">226</span>,<span class="number">85000</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2126</span>,<span class="string">'Russel'</span>,<span class="string">'C4'</span>,<span class="number">232</span>,<span class="number">80000</span>,<span class="number">3</span>),</span><br><span class="line">(<span class="number">2127</span>,<span class="string">'Kopernikus'</span>,<span class="string">'C3'</span>,<span class="number">310</span>,<span class="number">65000</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">2128</span>,<span class="string">'Aristoteles'</span>,<span class="string">'C4'</span>,<span class="number">250</span>,<span class="number">85000</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2133</span>,<span class="string">'Popper'</span>,<span class="string">'C3'</span>,<span class="number">52</span>,<span class="number">68000</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2134</span>,<span class="string">'Augustinus'</span>,<span class="string">'C3'</span>,<span class="number">309</span>,<span class="number">55000</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">2136</span>,<span class="string">'Curie'</span>,<span class="string">'C4'</span>,<span class="number">36</span>,<span class="number">95000</span>,<span class="number">3</span>),</span><br><span class="line">(<span class="number">2137</span>,<span class="string">'Kant'</span>,<span class="string">'C4'</span>,<span class="number">7</span>,<span class="number">98000</span>,<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> persnr, <span class="keyword">name</span>, salary</span><br><span class="line"><span class="keyword">from</span> Professors</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> persnr |    name     | salary </span><br><span class="line"><span class="comment">--------+-------------+--------</span></span><br><span class="line">   2137 | Kant        |  98000</span><br><span class="line">   2136 | Curie       |  95000</span><br><span class="line">   2128 | Aristoteles |  85000</span><br><span class="line">(3 rows)</span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在前三篇文章中我们基本上认识了window function。这次我们有具体的数据集去进行大量练习(绝大部分是排名)。&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-窗口函数(3)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/04/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-3/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/04/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-3/</id>
    <published>2020-04-04T15:12:47.000Z</published>
    <updated>2020-04-04T15:13:47.357Z</updated>
    
    <content type="html"><![CDATA[<p>在前两篇文章中我们基本上认识了window function。这次我们有具体的数据集去进行大量练习(绝大部分是排名)。</p><a id="more"></a><h1 id="数据集"><a href="#数据集" class="headerlink" title="数据集"></a>数据集</h1><p>我们这一篇文章采用PostgreSQL的SQL语法。重点我们关注<code>select...from...where</code>这种读操作，分析query　(analytical query)。<br>数据集在　<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>　可以直接使用。另外在这个网页不允许进行写操作:<code>insert</code>, <code>update</code>, <code>delete</code>之类的transactional query。当然<code>create table</code>和<code>drop table</code>也不被允许。</p><p>架构 Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p><p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p><p>下载:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p><p>Schma和大部分SQL语句来自<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>的课件和书。</p><p>课件：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li></ul><p>书：　<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p><p><br><br><br></p><h1 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h1><h2 id="成绩例子"><a href="#成绩例子" class="headerlink" title="成绩例子"></a>成绩例子</h2><p>我们采用一个更大的表格，基于原数据集表格<code>pruefen</code>：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> examination;</span><br><span class="line"></span><br><span class="line"> matrnr | coursenr | persnr | grade </span><br><span class="line"><span class="comment">--------+----------+--------+-------</span></span><br><span class="line">  28106 |     5001 |   2126 |   1.0</span><br><span class="line">  27550 |     4630 |   2137 |   2.0</span><br><span class="line">  29555 |        0 |      0 |   1.3</span><br><span class="line">  29120 |        0 |      0 |   3.0</span><br><span class="line">  25403 |     5041 |   2125 |   2.0</span><br><span class="line">  29555 |        0 |      0 |   2.0</span><br><span class="line">  29555 |        0 |      0 |   1.0</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="基于学生的平均成绩-确定同年级中的排名"><a href="#基于学生的平均成绩-确定同年级中的排名" class="headerlink" title="基于学生的平均成绩 确定同年级中的排名:"></a>基于学生的平均成绩 确定同年级中的排名:</h3><p>基于学生的平均成绩 确定同年级中的排名(和同一个学期的同学比较)</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- 计算平均成绩</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * , </span><br><span class="line">       <span class="keyword">rank</span> () <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> Semester <span class="comment">-- 和同一学期的同学比较</span></span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> Grade <span class="keyword">asc</span>    <span class="comment">-- 数字小是高分　排名也靠前</span></span><br><span class="line">           ) <span class="keyword">as</span> Rang</span><br><span class="line"><span class="keyword">from</span> grades</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>不使用窗口函数的版本：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- 计算平均成绩</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * ,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">count</span>(*) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> Grades x</span><br><span class="line">        <span class="keyword">where</span> x.Semester = n.Semester <span class="keyword">and</span> x.Grade &lt; n.Grade) <span class="keyword">as</span> Rang</span><br><span class="line"><span class="keyword">from</span> grades n</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> matrnr | semester |         grade          | rang </span><br><span class="line"><span class="comment">--------+----------+------------------------+------</span></span><br><span class="line">  29555 |        2 |     1.4333333333333333 |    1</span><br><span class="line">  29120 |        2 |     3.0000000000000000 |    2</span><br><span class="line">  28106 |        3 | 1.00000000000000000000 |    1</span><br><span class="line">  27550 |        6 |     2.0000000000000000 |    1</span><br><span class="line">  25403 |       12 |     2.0000000000000000 |    1</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h3 id="在上一步的基础上，增加离平均成绩的差距"><a href="#在上一步的基础上，增加离平均成绩的差距" class="headerlink" title="在上一步的基础上，增加离平均成绩的差距:"></a>在上一步的基础上，增加离平均成绩的差距:</h3><p>在上一步的基础上，增加每个同学离平均成绩的差距，和同年级平均成绩的差距(和同一个学期的同学比较)</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- 计算平均成绩</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * ,</span><br><span class="line">       <span class="keyword">rank</span> () <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> Semester <span class="comment">-- 和同一学期的同学比较</span></span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> Grade <span class="keyword">asc</span>    <span class="comment">-- 数字小是高分　排名也靠前</span></span><br><span class="line">           ) <span class="keyword">as</span> Rang,</span><br><span class="line">       <span class="keyword">avg</span> (Grade) <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> Semester  <span class="comment">-- 和同一学期的同学比较</span></span><br><span class="line">       ) <span class="keyword">as</span> GPA ,                 <span class="comment">-- 同年级的平均成绩</span></span><br><span class="line">       <span class="keyword">avg</span> (Grade) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> Semester) - Grade <span class="keyword">as</span> <span class="keyword">difference</span></span><br><span class="line"><span class="keyword">from</span> grades</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>不使用窗口函数的版本：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- 计算平均成绩</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * ,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">count</span>(*) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> Grades x</span><br><span class="line">        <span class="keyword">where</span> x.Semester = n.Semester <span class="keyword">and</span> x.Grade &lt; n.Grade) <span class="keyword">as</span> Rang,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">avg</span>(x.Grade)</span><br><span class="line">       <span class="keyword">from</span> Grades x</span><br><span class="line">       <span class="keyword">where</span> x.Semester = n.Semester) <span class="keyword">as</span> GPA,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">avg</span>(x.Grade)</span><br><span class="line">       <span class="keyword">from</span> Grades x</span><br><span class="line">       <span class="keyword">where</span> x.Semester = n.Semester) - Grade <span class="keyword">as</span> <span class="keyword">difference</span></span><br><span class="line"><span class="keyword">from</span> grades n</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> matrnr | semester |         grade          | rang |          gpa           |       difference       </span><br><span class="line"><span class="comment">--------+----------+------------------------+------+------------------------+------------------------</span></span><br><span class="line">  29555 |        2 |     1.4333333333333333 |    1 |     2.2166666666666667 |     0.7833333333333334</span><br><span class="line">  29120 |        2 |     3.0000000000000000 |    2 |     2.2166666666666667 |    -0.7833333333333333</span><br><span class="line">  28106 |        3 | 1.00000000000000000000 |    1 | 1.00000000000000000000 | 0.00000000000000000000</span><br><span class="line">  27550 |        6 |     2.0000000000000000 |    1 |     2.0000000000000000 |     0.0000000000000000</span><br><span class="line">  25403 |       12 |     2.0000000000000000 |    1 |     2.0000000000000000 |     0.0000000000000000</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在前两篇文章中我们基本上认识了window function。这次我们有具体的数据集去进行大量练习(绝大部分是排名)。&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-窗口函数(2)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/02/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-2/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/02/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-2/</id>
    <published>2020-04-02T13:04:31.000Z</published>
    <updated>2020-04-02T13:06:21.074Z</updated>
    
    <content type="html"><![CDATA[<p>我们在<a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/">[CMU-15445]Lec02_part2 Advanced SQL - 高级 SQL</a>中非常初步了了解了window function窗口函数。它是在OLAP中非常高效的一种函数，在工业业务中非常常见。另外我在Leetcode中的SQL部分也发现很多题目可以适用window function。CMU课实际上有一些简略。我会使用TUM的<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en">Foundations in Data Engineering<i class="fa fa-external-link"></i></span>课件来重点学习练习这块内容。</p><p>我们这次练习 使用frame的window function</p><a id="more"></a><h1 id="使用frame的window-functions"><a href="#使用frame的window-functions" class="headerlink" title="使用frame的window functions"></a>使用frame的window functions</h1><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/30.jpg" alt="30.jpg"></p><h2 id="rows"><a href="#rows" class="headerlink" title="rows"></a><code>rows</code></h2><h3 id="上一行～下一行"><a href="#上一行～下一行" class="headerlink" title="上一行～下一行"></a>上一行～下一行</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |  20</span><br><span class="line"> 10 |  34</span><br><span class="line"> 14 |  41</span><br><span class="line"> 17 |  48</span><br><span class="line"> 17 |  52</span><br><span class="line"> 18 |  55</span><br><span class="line"> 20 |  38</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="上一行～最后一行"><a href="#上一行～最后一行" class="headerlink" title="上一行～最后一行"></a>上一行～最后一行</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">unbounded</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 106</span><br><span class="line"> 10 | 106</span><br><span class="line"> 14 |  96</span><br><span class="line"> 17 |  86</span><br><span class="line"> 17 |  72</span><br><span class="line"> 18 |  55</span><br><span class="line"> 20 |  38</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h2 id="range"><a href="#range" class="headerlink" title="range"></a><code>range</code></h2><p>PostgreSQL不能处理下面的SQL，但是HyPer可以。</p><h3 id="forall-x-x-x-1"><a href="#forall-x-x-x-1" class="headerlink" title="$\forall x: [x, x+1]$"></a>$\forall x: [x, x+1]$</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 20</span><br><span class="line"> 10 | 20</span><br><span class="line"> 14 | 14</span><br><span class="line"> 17 | 52</span><br><span class="line"> 17 | 52</span><br><span class="line"> 18 | 18</span><br><span class="line"> 20 | 20</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="forall-x-x-x-2"><a href="#forall-x-x-x-2" class="headerlink" title="$\forall x: [x, x+2]$"></a>$\forall x: [x, x+2]$</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">2</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 20</span><br><span class="line"> 10 | 20</span><br><span class="line"> 14 | 14</span><br><span class="line"> 17 | 52</span><br><span class="line"> 17 | 52</span><br><span class="line"> 18 | 38</span><br><span class="line"> 20 | 20</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p>相比较上面两个例子， 结果中从<code>18 | 18</code>变成<code>18 | 38</code>，因为<code>18</code>这个tupel可以涉及的值域范围从$[18, 19]$变成$[18, 20]$</p><h3 id="forall-x-mathrm-unbounded-x"><a href="#forall-x-mathrm-unbounded-x" class="headerlink" title="$\forall x: [\mathrm{unbounded}, x]$"></a>$\forall x: [\mathrm{unbounded}, x]$</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">0</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |  20</span><br><span class="line"> 10 |  20</span><br><span class="line"> 14 |  34</span><br><span class="line"> 17 |  68</span><br><span class="line"> 17 |  68</span><br><span class="line"> 18 |  86</span><br><span class="line"> 20 | 106</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="forall-x-y-1-y-1"><a href="#forall-x-y-1-y-1" class="headerlink" title="$\forall x: [y-1, y+1]$"></a>$\forall x: [y-1, y+1]$</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                       (<span class="number">10</span>, <span class="number">1</span>),</span><br><span class="line">                       (<span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">                       (<span class="number">14</span>, <span class="number">2</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">3</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">4</span>),</span><br><span class="line">                       (<span class="number">18</span>, <span class="number">15</span>),</span><br><span class="line">                       (<span class="number">20</span>, <span class="number">6</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> y <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> y;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 10</span><br><span class="line"> 14 | 24</span><br><span class="line"> 17 | 41</span><br><span class="line"> 17 | 58</span><br><span class="line"> 20 | 78</span><br><span class="line"> 10 | 88</span><br><span class="line"> 18 | 106</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                       (<span class="number">10</span>, <span class="number">1</span>),</span><br><span class="line">                       (<span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">                       (<span class="number">14</span>, <span class="number">2</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">3</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">4</span>),</span><br><span class="line">                       (<span class="number">18</span>, <span class="number">15</span>),</span><br><span class="line">                       (<span class="number">20</span>, <span class="number">6</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> y)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> y;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |  10</span><br><span class="line"> 14 |  24</span><br><span class="line"> 17 |  41</span><br><span class="line"> 17 |  58</span><br><span class="line"> 20 |  78</span><br><span class="line"> 10 |  88</span><br><span class="line"> 18 | 106</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><hr><p>引用: </p><p>课件: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;我们在&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/&quot;&gt;[CMU-15445]Lec02_part2 Advanced SQL - 高级 SQL&lt;/a&gt;中非常初步了了解了window function窗口函数。它是在OLAP中非常高效的一种函数，在工业业务中非常常见。另外我在Leetcode中的SQL部分也发现很多题目可以适用window function。CMU课实际上有一些简略。我会使用TUM的&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=&quot; title=&quot;https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en&quot;&gt;Foundations in Data Engineering&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;课件来重点学习练习这块内容。&lt;/p&gt;
&lt;p&gt;我们这次练习 使用frame的window function&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="TUM-IN2326" scheme="https://cakebytheoceanluo.github.io/categories/TUM-IN2326/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-窗口函数(1)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/04/01/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-1/"/>
    <id>https://cakebytheoceanluo.github.io/2020/04/01/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-1/</id>
    <published>2020-04-01T14:55:49.000Z</published>
    <updated>2020-04-02T13:05:39.306Z</updated>
    
    <content type="html"><![CDATA[<p>我们在<a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/">[CMU-15445]Lec02_part2 Advanced SQL - 高级 SQL</a>中非常初步了了解了window function窗口函数。它是在OLAP中非常高效的一种函数，在工业业务中非常常见。另外我在Leetcode中的SQL部分也发现很多题目可以适用window function。CMU课实际上有一些简略。我会使用TUM的<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en">Foundations in Data Engineering<i class="fa fa-external-link"></i></span>课件来重点学习练习这块内容。</p><p>我们这次练习 不使用frame的window function</p><a id="more"></a><h1 id="不使用frame的window-functions"><a href="#不使用frame的window-functions" class="headerlink" title="不使用frame的window functions"></a>不使用frame的window functions</h1><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/27.jpg" alt="27.jpg"></p><h2 id="ranking-排序"><a href="#ranking-排序" class="headerlink" title="ranking 排序"></a>ranking 排序</h2><h3 id="rank"><a href="#rank" class="headerlink" title="rank()"></a>rank()</h3><p>并列会占用后面的排名数字。</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | rank </span><br><span class="line"><span class="comment">----+------</span></span><br><span class="line"> 10 |    1</span><br><span class="line"> 10 |    1</span><br><span class="line"> 14 |    3</span><br><span class="line"> 17 |    4</span><br><span class="line"> 17 |    4</span><br><span class="line"> 18 |    6</span><br><span class="line"> 20 |    7</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="dense-rank"><a href="#dense-rank" class="headerlink" title="dense_rank()"></a>dense_rank()</h3><p>并列不会占用后面的排名数字。</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | dense_rank </span><br><span class="line"><span class="comment">----+------------</span></span><br><span class="line"> 10 |          1</span><br><span class="line"> 10 |          1</span><br><span class="line"> 14 |          2</span><br><span class="line"> 17 |          3</span><br><span class="line"> 17 |          3</span><br><span class="line"> 18 |          4</span><br><span class="line"> 20 |          5</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="row-number"><a href="#row-number" class="headerlink" title="row_number()"></a>row_number()</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, row_number() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | row_number </span><br><span class="line"><span class="comment">----+------------</span></span><br><span class="line"> 10 |          1</span><br><span class="line"> 10 |          2</span><br><span class="line"> 14 |          3</span><br><span class="line"> 17 |          4</span><br><span class="line"> 17 |          5</span><br><span class="line"> 18 |          6</span><br><span class="line"> 20 |          7</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="ntile-INT"><a href="#ntile-INT" class="headerlink" title="ntile(INT)"></a>ntile(INT)</h3><p>把表格均分为<code>INT</code>份</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, ntile(<span class="number">2</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | ntile </span><br><span class="line"><span class="comment">----+-------</span></span><br><span class="line"> 10 |     1</span><br><span class="line"> 10 |     1</span><br><span class="line"> 14 |     1</span><br><span class="line"> 17 |     1</span><br><span class="line"> 17 |     2</span><br><span class="line"> 18 |     2</span><br><span class="line"> 20 |     2</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, ntile(<span class="number">3</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | ntile </span><br><span class="line"><span class="comment">----+-------</span></span><br><span class="line"> 10 |     1</span><br><span class="line"> 10 |     1</span><br><span class="line"> 14 |     1</span><br><span class="line"> 17 |     2</span><br><span class="line"> 17 |     2</span><br><span class="line"> 18 |     3</span><br><span class="line"> 20 |     3</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h2 id="distribution-分布"><a href="#distribution-分布" class="headerlink" title="distribution 分布"></a>distribution 分布</h2><h3 id="percent-rank"><a href="#percent-rank" class="headerlink" title="percent_rank()"></a>percent_rank()</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">percent_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  |   percent_rank    </span><br><span class="line"><span class="comment">----+-------------------</span></span><br><span class="line"> 10 |                 0</span><br><span class="line"> 10 |                 0</span><br><span class="line"> 14 | 0.333333333333333</span><br><span class="line"> 17 |               0.5</span><br><span class="line"> 17 |               0.5</span><br><span class="line"> 18 | 0.833333333333333</span><br><span class="line"> 20 |                 1</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="cume-dist"><a href="#cume-dist" class="headerlink" title="cume_dist()"></a>cume_dist()</h3><p>cumulative distribution function(cdf): 概率累加函数</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">cume_dist</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  |     cume_dist     </span><br><span class="line"><span class="comment">----+-------------------</span></span><br><span class="line"> 10 | 0.285714285714286</span><br><span class="line"> 10 | 0.285714285714286</span><br><span class="line"> 14 | 0.428571428571429</span><br><span class="line"> 17 | 0.714285714285714</span><br><span class="line"> 17 | 0.714285714285714</span><br><span class="line"> 18 | 0.857142857142857</span><br><span class="line"> 20 |                 1</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h2 id="navigation-in-partition-在同一个分组中进行定位"><a href="#navigation-in-partition-在同一个分组中进行定位" class="headerlink" title="navigation in partition 在同一个分组中进行定位"></a>navigation in partition 在同一个分组中进行定位</h2><h3 id="lag-expr-offset-default"><a href="#lag-expr-offset-default" class="headerlink" title="lag(expr, offset, default)"></a>lag(expr, offset, default)</h3><p>可以得到同组前<code>offset</code>的tupel的数值：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, lag(x, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | lag </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |    </span><br><span class="line"> 10 |  10</span><br><span class="line"> 14 |  10</span><br><span class="line"> 17 |  14</span><br><span class="line"> 17 |  17</span><br><span class="line"> 18 |  17</span><br><span class="line"> 20 |  18</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p>其中空着的那一格是<code>NULL</code>，是我们设置的default默认值。</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, lag(<span class="number">2</span> * x, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | lag </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |    </span><br><span class="line"> 10 |  20</span><br><span class="line"> 14 |  20</span><br><span class="line"> 17 |  28</span><br><span class="line"> 17 |  34</span><br><span class="line"> 18 |  34</span><br><span class="line"> 20 |  36</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><h3 id="lead-expr-offset-default"><a href="#lead-expr-offset-default" class="headerlink" title="lead(expr, offset, default)"></a>lead(expr, offset, default)</h3><p>可以得到同组前<code>offset</code>的tupel的数值：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">lead</span>(<span class="number">2</span> * x, <span class="number">2</span>, <span class="number">-1</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> x  | lead </span><br><span class="line"><span class="comment">----+------</span></span><br><span class="line"> 10 |   28</span><br><span class="line"> 10 |   34</span><br><span class="line"> 14 |   34</span><br><span class="line"> 17 |   36</span><br><span class="line"> 17 |   40</span><br><span class="line"> 18 |   -1</span><br><span class="line"> 20 |   -1</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><hr><p>引用: </p><p>课件: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;我们在&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/&quot;&gt;[CMU-15445]Lec02_part2 Advanced SQL - 高级 SQL&lt;/a&gt;中非常初步了了解了window function窗口函数。它是在OLAP中非常高效的一种函数，在工业业务中非常常见。另外我在Leetcode中的SQL部分也发现很多题目可以适用window function。CMU课实际上有一些简略。我会使用TUM的&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=&quot; title=&quot;https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en&quot;&gt;Foundations in Data Engineering&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;课件来重点学习练习这块内容。&lt;/p&gt;
&lt;p&gt;我们这次练习 不使用frame的window function&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="TUM-IN2326" scheme="https://cakebytheoceanluo.github.io/categories/TUM-IN2326/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Window Function" scheme="https://cakebytheoceanluo.github.io/tags/Window-Function/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-递归(6)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/31/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-6/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/31/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-6/</id>
    <published>2020-03-31T20:57:49.000Z</published>
    <updated>2020-03-31T21:02:41.291Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Six-Degrees-of-Kevin-Bacon"><a href="#Six-Degrees-of-Kevin-Bacon" class="headerlink" title="Six Degrees of Kevin Bacon"></a>Six Degrees of Kevin Bacon</h1><p>具体描述见: <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2l4X0RlZ3JlZXNfb2ZfS2V2aW5fQmFjb24=" title="https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon">https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon<i class="fa fa-external-link"></i></span></p><p>Six Degrees of Kevin Bacon或”Bacon’s Law”是基于”six degrees of separation六度分离”，它假定地球上任何两个人相距六个或更少的熟人链接。 比如寻找任意演员和多产演员Kevin Bacon之间的最短路径。 它基于一个假设，即好莱坞电影界的任何人都可以通过其电影角色在六个步骤中将其与Kevin Bacon联系起来。这个概念也类似Fackbook提出的概念。当然在计算机或者算法角度，这是一个BFS广度优先的图问题。通过间接的6步可能会接触非常多人，产生非常大的数据。具体我们会在下面的练习中体验到。</p><p>这里再附上Kevin Bacon的一些链接:</p><ul><li>个人网站(他直接用了six degree这个概念): <span class="exturl" data-url="aHR0cHM6Ly93d3cuc2l4ZGVncmVlcy5vcmc=" title="https://www.sixdegrees.org">https://www.sixdegrees.org<i class="fa fa-external-link"></i></span></li><li>豆瓣主页: <span class="exturl" data-url="aHR0cHM6Ly9tb3ZpZS5kb3ViYW4uY29tL2NlbGVicml0eS8xMDA5MjYwLw==" title="https://movie.douban.com/celebrity/1009260/">https://movie.douban.com/celebrity/1009260/<i class="fa fa-external-link"></i></span></li></ul><a id="more"></a><h2 id="IMDb数据集"><a href="#IMDb数据集" class="headerlink" title="IMDb数据集"></a>IMDb数据集</h2><p>我们这次使用IMDb数据集，本地载入数据集的方式见我以前的一篇文章: <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#IMDb-%E6%95%B0%E6%8D%AE%E9%9B%86">[DBMS]PostgreSQL导入数据集 - IMDb 数据集</a></p><p><br></p><p>我们打开psql的计时器:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">imdb=# \timing</span><br><span class="line">Timing is on.</span><br></pre></td></tr></tbody></table></figure><h2 id="调整buffer-pool和cache大小"><a href="#调整buffer-pool和cache大小" class="headerlink" title="调整buffer pool和cache大小"></a>调整buffer pool和cache大小</h2><p>我们用自己喜欢的文本编辑器去打开<code>/etc/postgresql/10/main/postgresql.conf</code>文件:</p><ul><li>注意我<code>postgresql</code>的版本是<code>10</code></li><li>具体的配置文件位置和<code>postgresql</code>安装位置和安装版本有关</li></ul><p>找到下面对应的<code>shared_buffers</code>建议更改数值为1024MB， <code>work_mem</code>建议更改为1024MB (我都改成比建议值大，这里大家按照自己机器的硬件配置来估计):</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># RESOURCE USAGE (except WAL)</span></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Memory -</span></span><br><span class="line"></span><br><span class="line">shared_buffers = 2048MB                 <span class="comment"># min 128kB</span></span><br><span class="line">                                        <span class="comment"># (change requires restart)</span></span><br><span class="line"><span class="comment">#huge_pages = try                       # on, off, or try</span></span><br><span class="line">                                        <span class="comment"># (change requires restart)</span></span><br><span class="line"><span class="comment">#temp_buffers = 8MB                     # min 800kB </span></span><br><span class="line"><span class="comment">#max_prepared_transactions = 0          # zero disables the feature</span></span><br><span class="line">                                        <span class="comment"># (change requires restart)</span></span><br><span class="line"><span class="comment"># Caution: it is not advisable to set max_prepared_transactions nonzero unless</span></span><br><span class="line"><span class="comment"># you actively intend to use prepared transactions.</span></span><br><span class="line">work_mem = 8196MB                               <span class="comment"># min 64kB  </span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>更改好后保存，执行下面的指令，让psql重启来使配置生效:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="求Bacon-Kevin演过的电影数量"><a href="#求Bacon-Kevin演过的电影数量" class="headerlink" title="求Bacon, Kevin演过的电影数量"></a>求<code>Bacon, Kevin</code>演过的电影数量</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> movie_name)</span><br><span class="line"><span class="keyword">from</span> playedin_text</span><br><span class="line"><span class="keyword">where</span> actor_name = <span class="string">'Bacon, Kevin'</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> count </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line">   322</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 838.464 ms</span><br></pre></td></tr></tbody></table></figure><h2 id="找到Bacon-Number小于等于1的演员数量"><a href="#找到Bacon-Number小于等于1的演员数量" class="headerlink" title="找到Bacon Number小于等于1的演员数量"></a>找到Bacon Number小于等于1的演员数量</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (<span class="keyword">id</span>, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> p2.actor_name, baconnr.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> baconnr, playedin_text p1, playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> baconnr.id = p1.actor_name <span class="keyword">and</span> </span><br><span class="line">          p1.movie_name = p2.movie_name <span class="keyword">and</span> </span><br><span class="line">          baconnr.nr &lt; <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> count </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line"> 35893</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 5718.960 ms (00:05.719)</span><br></pre></td></tr></tbody></table></figure><h2 id="找到Bacon-Number小于等于2的演员数量-一次尝试"><a href="#找到Bacon-Number小于等于2的演员数量-一次尝试" class="headerlink" title="找到Bacon Number小于等于2的演员数量 - 一次尝试"></a>找到Bacon Number小于等于2的演员数量 - 一次尝试</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (<span class="keyword">id</span>, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> p2.actor_name, baconnr.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> baconnr, playedin_text p1, playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> baconnr.id = p1.actor_name <span class="keyword">and</span> </span><br><span class="line">          p1.movie_name = p2.movie_name <span class="keyword">and</span> </span><br><span class="line">          baconnr.nr &lt; <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><p>很可惜这条SQL在我的电脑上十分钟内无法终止。本质上这属于一个广度搜索，我们可能会重复接触到很多人，这使这条SQL在短时间内不能终止。</p><h3 id="cardinality"><a href="#cardinality" class="headerlink" title="cardinality"></a>cardinality</h3><p>即Bacon Number等于1，但是存在重复</p><p>the size of intermediate results</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(p2.actor_name)</span><br><span class="line"><span class="keyword">from</span> playedin_text p1, playedin_text p2</span><br><span class="line"><span class="keyword">where</span> p1.actor_name = <span class="string">'Bacon, Kevin'</span> <span class="keyword">and</span> p1.movie_name = p2.movie_name;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  count  </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line"> 1391638</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 11896.991 ms (00:11.897)</span><br></pre></td></tr></tbody></table></figure><h2 id="找到Bacon-Number小于等于2的演员数量-除去重复"><a href="#找到Bacon-Number小于等于2的演员数量-除去重复" class="headerlink" title="找到Bacon Number小于等于2的演员数量 - 除去重复"></a>找到Bacon Number小于等于2的演员数量 - 除去重复</h2><p>使用<code>union all</code>和<code>select distinct</code>:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (actor_name, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> p2.actor_name, movies.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> p1.movie_name, baconnr.nr</span><br><span class="line">          <span class="keyword">from</span> baconnr, playedin_text p1</span><br><span class="line">          <span class="keyword">where</span> baconnr.actor_name = p1.actor_name</span><br><span class="line">         ) movies,</span><br><span class="line">         playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> movies.movie_name = p2.movie_name <span class="keyword">and</span> movies.nr &lt; <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> actor_name)</span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  count  </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line"> 1046450</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 27453.873 ms (00:27.454)</span><br></pre></td></tr></tbody></table></figure><h2 id="找到Bacon-Number小于等于2的演员数量-除去重复-1"><a href="#找到Bacon-Number小于等于2的演员数量-除去重复-1" class="headerlink" title="找到Bacon Number小于等于2的演员数量 - 除去重复"></a>找到Bacon Number小于等于2的演员数量 - 除去重复</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (actor_name, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> p2.actor_name, movies.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> p1.movie_name, baconnr.nr</span><br><span class="line">          <span class="keyword">from</span> baconnr, playedin_text p1</span><br><span class="line">          <span class="keyword">where</span> baconnr.actor_name = p1.actor_name</span><br><span class="line">         ) movies,</span><br><span class="line">         playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> movies.movie_name = p2.movie_name <span class="keyword">and</span> movies.nr &lt; <span class="number">3</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> actor_name)</span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><p><br><br><br><br><br></p><h2 id="string-to-int"><a href="#string-to-int" class="headerlink" title="string to int"></a>string to int</h2><p>对string的操作是相对昂贵的，但是对int的操作是相对廉价的。我们新建对应的几个新的表格，使用int, 这样也可以降低表格的大小。</p><ul><li>table actors (id::integer, name::text)</li><li>table movies (id::integer, name::text)</li><li>table playedin (actor::integer, movies::integer)</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> movies (<span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>, <span class="keyword">name</span> <span class="built_in">text</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> actors (<span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>, <span class="keyword">name</span> <span class="built_in">text</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> playedin (</span><br><span class="line">    movie <span class="built_in">integer</span> <span class="keyword">references</span> movies (<span class="keyword">id</span>),</span><br><span class="line">    actor <span class="built_in">integer</span> <span class="keyword">references</span> actors (<span class="keyword">id</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actors (<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">distinct</span> actor_name <span class="keyword">from</span> playedin_text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> movies (<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">distinct</span> movie_name <span class="keyword">from</span> playedin_text;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- read from all</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> playedin (actor, movie)</span><br><span class="line"><span class="keyword">select</span> actors.id, movies.id</span><br><span class="line"><span class="keyword">from</span> actors, movies, playedin_text p</span><br><span class="line"><span class="keyword">where</span> p.actor_name = actors.name <span class="keyword">and</span> p.movie_name = movies.name;</span><br></pre></td></tr></tbody></table></figure><h2 id="找到Bacon-Number小于等于6的演员数量"><a href="#找到Bacon-Number小于等于6的演员数量" class="headerlink" title="找到Bacon Number小于等于6的演员数量"></a>找到Bacon Number小于等于6的演员数量</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (<span class="keyword">id</span>, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span> , <span class="number">0</span></span><br><span class="line">    <span class="keyword">from</span> actors</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'Bacon, Kevin'</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> p2.actor, movies.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    ( <span class="keyword">select</span> <span class="keyword">distinct</span> p1.movie, baconnr.nr</span><br><span class="line">    <span class="keyword">from</span> baconnr, playedin p1</span><br><span class="line">    <span class="keyword">where</span> baconnr.id = p1.actor) movies,</span><br><span class="line">    playedin p2</span><br><span class="line">    <span class="keyword">where</span> movies.movie = p2.movie <span class="keyword">and</span> movies.nr &lt; <span class="number">5</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span> (<span class="keyword">distinct</span> <span class="keyword">id</span>)</span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  count  </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line"> 1821293</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 175282.570 ms (02:55.283)</span><br></pre></td></tr></tbody></table></figure><h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>数据集(以及现实世界)中甚至有Bacon Number为7的演员，这里我们就不再继续了。大家如果能实验一下，了解主旨就很好。</p><p><br><br><br><br><br></p><h1 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h1><h2 id="Optional-找到Bacon-Number小于等于6的演员数量-Query-Plan"><a href="#Optional-找到Bacon-Number小于等于6的演员数量-Query-Plan" class="headerlink" title="Optional: 找到Bacon Number小于等于6的演员数量 - Query Plan"></a>Optional: 找到Bacon Number小于等于6的演员数量 - Query Plan</h2><p>这部分是可选的，而不是必须的。这部分我附上了上一个SQL对应的Query Plan。</p><ul><li>我打开了多线程选项: <code>testdb=# set max_parallel_workers_per_gather = 4;</code>, 对应下面的Query Plan中的Workers。</li><li>我使用了绝对大的buffer pool去容纳所有的page, 因此下面Query Plan只有<code>shared hit</code>， 而没有<code>shared read</code></li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">imdb=# explain (analyze, buffers) with recursive baconnr (id, nr) as (</span><br><span class="line">    select id , <span class="number">0</span></span><br><span class="line">    from actors</span><br><span class="line">    where name = 'Bacon, Kevin'</span><br><span class="line">    <span class="keyword">union</span> all</span><br><span class="line">    select distinct p2.actor, movies.nr + <span class="number">1</span></span><br><span class="line">    from</span><br><span class="line">    ( select distinct p1.movie, baconnr.nr</span><br><span class="line">    from baconnr, playedin p1</span><br><span class="line">    where baconnr.id = p1.actor) movies,</span><br><span class="line">    playedin p2</span><br><span class="line">    where movies.movie = p2.movie <span class="keyword">and</span> movies.nr &lt; <span class="number">5</span></span><br><span class="line">)</span><br><span class="line">select count (distinct id)</span><br><span class="line">from baconnr;</span><br><span class="line">                                                                                QUERY PLAN                                                                                </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">3243681.47</span>.<span class="number">.3243681</span><span class="number">.48</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">181539.730</span>.<span class="number">.181539</span><span class="number">.730</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">72933155</span></span><br><span class="line">   CTE baconnr</span><br><span class="line">     -&gt;  Recursive Union  (cost=<span class="number">1000.00</span>.<span class="number">.3196845</span><span class="number">.00</span> rows=<span class="number">2081621</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">1.375</span>.<span class="number">.178161</span><span class="number">.180</span> rows=<span class="number">6480755</span> loops=<span class="number">1</span>)</span><br><span class="line">           Buffers: shared hit=<span class="number">72933155</span></span><br><span class="line">           -&gt;  Gather  (cost=<span class="number">1000.00</span>.<span class="number">.23770</span><span class="number">.35</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">1.366</span>.<span class="number">.65</span><span class="number">.451</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">                 Workers Planned: <span class="number">2</span></span><br><span class="line">                 Workers Launched: <span class="number">2</span></span><br><span class="line">                 Buffers: shared hit=<span class="number">12501</span></span><br><span class="line">                 -&gt;  Parallel Seq Scan on actors  (cost=<span class="number">0.00</span>.<span class="number">.22770</span><span class="number">.25</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">40.406</span>.<span class="number">.61</span><span class="number">.732</span> rows=<span class="number">0</span> loops=<span class="number">3</span>)</span><br><span class="line">                       Filter: (name = 'Bacon, Kevin'::text)</span><br><span class="line">                       Rows Removed by Filter: <span class="number">657232</span></span><br><span class="line">                       Buffers: shared hit=<span class="number">12501</span></span><br><span class="line">           -&gt;  HashAggregate  (cost=<span class="number">310542.20</span>.<span class="number">.313144</span><span class="number">.22</span> rows=<span class="number">208162</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">29230.371</span>.<span class="number">.29512</span><span class="number">.804</span> rows=<span class="number">1080126</span> loops=<span class="number">6</span>)</span><br><span class="line">                 Group Key: p2.actor, (baconnr_1.nr + <span class="number">1</span>)</span><br><span class="line">                 Buffers: shared hit=<span class="number">72920654</span></span><br><span class="line">                 -&gt;  Nested Loop  (cost=<span class="number">2384.03</span>.<span class="number">.309501</span><span class="number">.39</span> rows=<span class="number">208162</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">13040.311</span>.<span class="number">.25542</span><span class="number">.265</span> rows=<span class="number">10389484</span> loops=<span class="number">6</span>)</span><br><span class="line">                       Buffers: shared hit=<span class="number">72920654</span></span><br><span class="line">                       -&gt;  HashAggregate  (cost=<span class="number">2376.97</span>.<span class="number">.2383</span><span class="number">.06</span> rows=<span class="number">609</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">13039.878</span>.<span class="number">.13290</span><span class="number">.218</span> rows=<span class="number">570802</span> loops=<span class="number">6</span>)</span><br><span class="line">                             Group Key: p1.movie, baconnr_1.nr</span><br><span class="line">                             Buffers: shared hit=<span class="number">30919755</span></span><br><span class="line">                             -&gt;  Nested Loop  (cost=<span class="number">6.01</span>.<span class="number">.2373</span><span class="number">.92</span> rows=<span class="number">609</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">16.277</span>.<span class="number">.9987</span><span class="number">.675</span> rows=<span class="number">8778940</span> loops=<span class="number">6</span>)</span><br><span class="line">                                   Buffers: shared hit=<span class="number">30919755</span></span><br><span class="line">                                   -&gt;  WorkTable Scan on baconnr baconnr_1  (cost=<span class="number">0.00</span>.<span class="number">.0</span><span class="number">.22</span> rows=<span class="number">3</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">16.246</span>.<span class="number">.173</span><span class="number">.118</span> rows=<span class="number">776577</span> loops=<span class="number">6</span>)</span><br><span class="line">                                         Filter: (nr &lt; <span class="number">5</span>)</span><br><span class="line">                                         Rows Removed by Filter: <span class="number">303549</span></span><br><span class="line">                                   -&gt;  Bitmap Heap Scan on playedin p1  (cost=<span class="number">6.01</span>.<span class="number">.789</span><span class="number">.20</span> rows=<span class="number">203</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.006</span>.<span class="number">.0</span><span class="number">.010</span> rows=<span class="number">11</span> loops=<span class="number">4659462</span>)</span><br><span class="line">                                         Recheck Cond: (actor = baconnr_1.id)</span><br><span class="line">                                         Heap Blocks: exact=<span class="number">16784601</span></span><br><span class="line">                                         Buffers: shared hit=<span class="number">30919755</span></span><br><span class="line">                                         -&gt;  Bitmap Index Scan on playedin_actor_idx  (cost=<span class="number">0.00</span>.<span class="number">.5</span><span class="number">.96</span> rows=<span class="number">203</span> <span class="built_in">width</span>=<span class="number">0</span>) (actual time=<span class="number">0.004</span>.<span class="number">.0</span><span class="number">.004</span> rows=<span class="number">11</span> loops=<span class="number">4659462</span>)</span><br><span class="line">                                               Index Cond: (actor = baconnr_1.id)</span><br><span class="line">                                               Buffers: shared hit=<span class="number">14135154</span></span><br><span class="line">                       -&gt;  Bitmap Heap Scan on playedin p2  (cost=<span class="number">7.07</span>.<span class="number">.500</span><span class="number">.01</span> rows=<span class="number">342</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.007</span>.<span class="number">.0</span><span class="number">.018</span> rows=<span class="number">18</span> loops=<span class="number">3424813</span>)</span><br><span class="line">                             Recheck Cond: (movie = p1.movie)</span><br><span class="line">                             Heap Blocks: exact=<span class="number">31546852</span></span><br><span class="line">                             Buffers: shared hit=<span class="number">42000899</span></span><br><span class="line">                             -&gt;  Bitmap Index Scan on playedin_movie_idx  (cost=<span class="number">0.00</span>.<span class="number">.6</span><span class="number">.98</span> rows=<span class="number">342</span> <span class="built_in">width</span>=<span class="number">0</span>) (actual time=<span class="number">0.005</span>.<span class="number">.0</span><span class="number">.005</span> rows=<span class="number">18</span> loops=<span class="number">3424813</span>)</span><br><span class="line">                                   Index Cond: (movie = p1.movie)</span><br><span class="line">                                   Buffers: shared hit=<span class="number">10454047</span></span><br><span class="line">   -&gt;  CTE Scan on baconnr  (cost=<span class="number">0.00</span>.<span class="number">.41632</span><span class="number">.42</span> rows=<span class="number">2081621</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1.379</span>.<span class="number">.179511</span><span class="number">.482</span> rows=<span class="number">6480755</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">72933155</span></span><br><span class="line"> Planning time: <span class="number">0.260</span> ms</span><br><span class="line"> Execution time: <span class="number">181676.112</span> ms</span><br><span class="line">(<span class="number">44</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">181676.868</span> ms (<span class="number">03</span>:<span class="number">01.677</span>)</span><br></pre></td></tr></tbody></table></figure><h2 id="Optional-Buffer-Pool预加载"><a href="#Optional-Buffer-Pool预加载" class="headerlink" title="Optional: Buffer Pool预加载"></a>Optional: Buffer Pool预加载</h2><p>这部分是可选的，而不是必须的。这部分的具体解释见我的另一个实验 <a href="https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/">[DBMS][PostgreSQL] 缓存区管理 BufferPool</a></p><p>我们可以通过如下的方式，在执行我们的SQL之前，将需要的page预加载进buffer pool:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">imdb=# CREATE EXTENSION pg_prewarm;</span><br><span class="line">CREATE EXTENSION</span><br><span class="line"></span><br><span class="line">imdb=# select * from pg_prewarm('actors');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">      <span class="number">12501</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">71.137</span> ms</span><br><span class="line">imdb=# select * from pg_prewarm('movies');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">       <span class="number">8396</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">88.954</span> ms</span><br><span class="line">imdb=# select * from pg_prewarm('playedin');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">      <span class="number">76623</span></span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Six-Degrees-of-Kevin-Bacon&quot;&gt;&lt;a href=&quot;#Six-Degrees-of-Kevin-Bacon&quot; class=&quot;headerlink&quot; title=&quot;Six Degrees of Kevin Bacon&quot;&gt;&lt;/a&gt;Six Degrees of Kevin Bacon&lt;/h1&gt;&lt;p&gt;具体描述见: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2l4X0RlZ3JlZXNfb2ZfS2V2aW5fQmFjb24=&quot; title=&quot;https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon&quot;&gt;https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Six Degrees of Kevin Bacon或”Bacon’s Law”是基于”six degrees of separation六度分离”，它假定地球上任何两个人相距六个或更少的熟人链接。 比如寻找任意演员和多产演员Kevin Bacon之间的最短路径。 它基于一个假设，即好莱坞电影界的任何人都可以通过其电影角色在六个步骤中将其与Kevin Bacon联系起来。这个概念也类似Fackbook提出的概念。当然在计算机或者算法角度，这是一个BFS广度优先的图问题。通过间接的6步可能会接触非常多人，产生非常大的数据。具体我们会在下面的练习中体验到。&lt;/p&gt;
&lt;p&gt;这里再附上Kevin Bacon的一些链接:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;个人网站(他直接用了six degree这个概念): &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly93d3cuc2l4ZGVncmVlcy5vcmc=&quot; title=&quot;https://www.sixdegrees.org&quot;&gt;https://www.sixdegrees.org&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;豆瓣主页: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9tb3ZpZS5kb3ViYW4uY29tL2NlbGVicml0eS8xMDA5MjYwLw==&quot; title=&quot;https://movie.douban.com/celebrity/1009260/&quot;&gt;https://movie.douban.com/celebrity/1009260/&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="DBMS" scheme="https://cakebytheoceanluo.github.io/categories/DBMS/"/>
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/categories/PostgreSQL/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/tags/PostgreSQL/"/>
    
      <category term="Recursion" scheme="https://cakebytheoceanluo.github.io/tags/Recursion/"/>
    
      <category term="Six Degrees of Kevin Bacon" scheme="https://cakebytheoceanluo.github.io/tags/Six-Degrees-of-Kevin-Bacon/"/>
    
      <category term="BFS" scheme="https://cakebytheoceanluo.github.io/tags/BFS/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-递归(5)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/30/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-5/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/30/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-5/</id>
    <published>2020-03-30T11:11:08.000Z</published>
    <updated>2020-04-01T15:02:12.478Z</updated>
    
    <content type="html"><![CDATA[<h1 id="图论"><a href="#图论" class="headerlink" title="图论"></a>图论</h1><p>在这篇文章高级 SQL 中我们会遇到递归查询图论的题目。我们使用的数据集(图)都在文章中的SQL中。</p><a id="more"></a><h2 id="无环图-树"><a href="#无环图-树" class="headerlink" title="无环图 / 树"></a>无环图 / 树</h2><p><img data-src="/images/FDE/chap3/21.jpg" alt="21.jpg"></p><h3 id="找父节点"><a href="#找父节点" class="headerlink" title="找父节点"></a>找父节点</h3><ul><li>搜索<code>turtle</code>的父节点(所有直接和间接父亲)：</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span></span><br><span class="line">     animals (<span class="keyword">id</span>, <span class="keyword">name</span>, <span class="keyword">parent</span>) <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'animal'</span>, <span class="literal">null</span>), (<span class="number">2</span>, <span class="string">'mammal'</span>, <span class="number">1</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="string">'giraffe'</span>, <span class="number">2</span>), (<span class="number">4</span>, <span class="string">'tiger'</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="string">'reptile'</span>, <span class="number">1</span>), (<span class="number">6</span>, <span class="string">'snake'</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">7</span>, <span class="string">'turtle'</span>, <span class="number">5</span>), (<span class="number">8</span>, <span class="string">'grean sea turtle'</span>, <span class="number">7</span>)),</span><br><span class="line">     r <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> * </span><br><span class="line">         <span class="keyword">from</span> animals </span><br><span class="line">         <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'turtle'</span></span><br><span class="line">         <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">         <span class="keyword">select</span> animals.*</span><br><span class="line">         <span class="keyword">from</span> r, animals</span><br><span class="line">         <span class="keyword">where</span> animals.id = r.parent)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> id |  name   | parent </span><br><span class="line">----+---------+--------</span><br><span class="line">  7 | turtle  |      5</span><br><span class="line">  5 | reptile |      1</span><br><span class="line">  1 | animal  |       </span><br><span class="line">(3 rows)</span><br></pre></td></tr></tbody></table></figure><p>&lt;/br&gt;</p><h3 id="找子节点"><a href="#找子节点" class="headerlink" title="找子节点"></a>找子节点</h3><ul><li>搜索<code>reptile</code>的子节点(所有直接和间接孩子)：</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span></span><br><span class="line">     animals (<span class="keyword">id</span>, <span class="keyword">name</span>, <span class="keyword">parent</span>) <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'animal'</span>, <span class="literal">null</span>), (<span class="number">2</span>, <span class="string">'mammal'</span>, <span class="number">1</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="string">'giraffe'</span>, <span class="number">2</span>), (<span class="number">4</span>, <span class="string">'tiger'</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="string">'reptile'</span>, <span class="number">1</span>), (<span class="number">6</span>, <span class="string">'snake'</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">7</span>, <span class="string">'turtle'</span>, <span class="number">5</span>), (<span class="number">8</span>, <span class="string">'grean sea turtle'</span>, <span class="number">7</span>)),</span><br><span class="line">     r <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> *</span><br><span class="line">         <span class="keyword">from</span> animals</span><br><span class="line">         <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'reptile'</span></span><br><span class="line">         <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">         <span class="keyword">select</span> animals.* <span class="comment">-- get the descendants</span></span><br><span class="line">         <span class="keyword">from</span> r, animals</span><br><span class="line">         <span class="keyword">where</span> animals.parent = r.id <span class="comment">-- r is the parent of the new founded animal</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> id |       name       | parent </span><br><span class="line"><span class="comment">----+------------------+--------</span></span><br><span class="line">  5 | reptile          |      1</span><br><span class="line">  7 | turtle           |      5</span><br><span class="line">  6 | snake            |      5</span><br><span class="line">  8 | grean sea turtle |      7</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="带环图"><a href="#带环图" class="headerlink" title="带环图"></a>带环图</h2><p><img data-src="/images/FDE/chap3/24.jpg" alt="24.jpg"></p><ul><li>搜索<code>Alice</code>的所有朋友(即从<code>Alice</code>能到达的节点):</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span></span><br><span class="line">     friends (a, b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'Alice'</span>, <span class="string">'Bob'</span>), (<span class="string">'Alice'</span>, <span class="string">'Carol'</span>),</span><br><span class="line">           (<span class="string">'Carol'</span>, <span class="string">'Grace'</span>), (<span class="string">'Carol'</span>, <span class="string">'Chuck'</span>),</span><br><span class="line">           (<span class="string">'Chuck'</span>, <span class="string">'Grace'</span>), (<span class="string">'Chuck'</span>,<span class="string">'Anne'</span>),</span><br><span class="line">           (<span class="string">'Bob'</span>,<span class="string">'Dan'</span>),(<span class="string">'Dan'</span>,<span class="string">'Anne'</span>),(<span class="string">'Eve'</span>,<span class="string">'Adam'</span>)</span><br><span class="line">           ),</span><br><span class="line">     friendship (<span class="keyword">name</span>, friend) <span class="keyword">as</span> <span class="comment">-- friendship is symmetric, bi-directional graph</span></span><br><span class="line">    (<span class="keyword">select</span> a, b</span><br><span class="line">    <span class="keyword">from</span> friends</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> b, a</span><br><span class="line">    <span class="keyword">from</span> friends),</span><br><span class="line">     r <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Alice'</span> <span class="keyword">as</span> <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> friendship.name</span><br><span class="line">    <span class="keyword">from</span> r, friendship</span><br><span class="line">    <span class="keyword">where</span> r.name = friendship.friend)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> name  </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line"> Alice</span><br><span class="line"> Bob</span><br><span class="line"> Carol</span><br><span class="line"> Grace</span><br><span class="line"> Chuck</span><br><span class="line"> Dan</span><br><span class="line"> Anne</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure><p>到目前为止， 我们在高级SQL-递归部分对小规模的树和图进行了遍历。我们主要研究节点的父子关系和节点间的可到达性问题。使用<code>with recursive</code>子句，搭配对应的<code>union all</code>或<code>union</code>让递归问题一通百通。</p><p>下一次我们会研究一个真实数据集中的问题，依旧是<em>朋友</em>的图关系，但是数据集很大，同时计算量也非常巨大。</p><p>引用: </p><p>课件: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;图论&quot;&gt;&lt;a href=&quot;#图论&quot; class=&quot;headerlink&quot; title=&quot;图论&quot;&gt;&lt;/a&gt;图论&lt;/h1&gt;&lt;p&gt;在这篇文章高级 SQL 中我们会遇到递归查询图论的题目。我们使用的数据集(图)都在文章中的SQL中。&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/categories/Graph/"/>
    
      <category term="TUM-IN2326" scheme="https://cakebytheoceanluo.github.io/categories/TUM-IN2326/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Recursion" scheme="https://cakebytheoceanluo.github.io/tags/Recursion/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/tags/Graph/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-递归(4)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/27/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-4/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/27/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-4/</id>
    <published>2020-03-27T17:57:47.000Z</published>
    <updated>2020-03-27T17:59:07.661Z</updated>
    
    <content type="html"><![CDATA[<h1 id="图论"><a href="#图论" class="headerlink" title="图论"></a>图论</h1><p>在这篇文章高级 SQL 中我们会遇到递归查询图论的题目。我们使用的数据集(图)都在文章中的SQL中。</p><a id="more"></a><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p><img data-src="/images/SQL/graph1.png" alt="graph1.png"></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> singleDirection;</span><br></pre></td></tr></tbody></table></figure><h3 id="寻找传递闭包-Transitive-closure-，即这个图中节点的联通节点-Connectivity"><a href="#寻找传递闭包-Transitive-closure-，即这个图中节点的联通节点-Connectivity" class="headerlink" title="寻找传递闭包(Transitive closure)，即这个图中节点的联通节点(Connectivity):"></a>寻找传递闭包(Transitive closure)，即这个图中节点的联通节点(Connectivity):</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">    ), undirectedGraph <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> b, a</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">    ), transitive_closure (a, b) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph</span><br><span class="line">        <span class="keyword">union</span></span><br><span class="line">        <span class="keyword">select</span> a.a, b.b</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph b, transitive_closure a</span><br><span class="line">        <span class="keyword">where</span> a.b = b.a</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> transitive_closure</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a, b;</span><br></pre></td></tr></tbody></table></figure><h3 id="6和1是联通-connected-reachable-的吗"><a href="#6和1是联通-connected-reachable-的吗" class="headerlink" title="6和1是联通(connected, reachable)的吗?"></a>6和1是联通(connected, reachable)的吗?</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">    ), undirectedGraph <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> b, a</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">    ), transitive_closure (a, b) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph</span><br><span class="line">        <span class="keyword">union</span></span><br><span class="line">        <span class="keyword">select</span> a.a, b.b</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph b, transitive_closure a</span><br><span class="line">        <span class="keyword">where</span> a.b = b.a</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> transitive_closure </span><br><span class="line"><span class="keyword">where</span> a = <span class="number">6</span> <span class="keyword">and</span> b = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><h3 id="求6和1的最短距离"><a href="#求6和1的最短距离" class="headerlink" title="求6和1的最短距离?"></a>求6和1的最短距离?</h3><p>这里我们在<code>transitive_closure</code>中使用了<code>union all</code>，为了避免对应出现的不终止的递归，我们必须加上对应的条件<code>dist &lt;= 4</code>。另外这个4是我们目测出来的一个参数，当然我们可以用一个更大更普遍的数字，比如图中边的总数，这样也能试递归终止。</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">    ), undirectedGraph <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> b, a</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">    ), transitive_closure (a, b, dist) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> a, b, <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> undirectedGraph</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> a.a, b.b, dist + <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> undirectedGraph b, transitive_closure a</span><br><span class="line">        <span class="keyword">where</span> a.b = b.a <span class="keyword">and</span> dist &lt;= <span class="number">4</span> <span class="comment">-- 或者　dist &lt;= 9，因为这个图里面一共9条边</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">min</span>(dist)</span><br><span class="line"><span class="keyword">from</span> transitive_closure</span><br><span class="line"><span class="keyword">where</span> a = <span class="number">6</span> <span class="keyword">and</span> b = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p><br><br><br><br><br></p><h3 id="例子3"><a href="#例子3" class="headerlink" title="例子3"></a>例子3</h3><p>SQL Standard中是这样定义来<code>union all</code>的递归语句的:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">workingTable = evaluateNonRecursive()</span><br><span class="line">output workingTable</span><br><span class="line"><span class="keyword">while</span> workingTable <span class="keyword">is</span> <span class="keyword">not</span> empty:</span><br><span class="line">  workingTable = evaluateRecursive(workingTable)</span><br><span class="line">  output workingTable</span><br></pre></td></tr></tbody></table></figure><p>下面是一个表格，代表一个图:</p><div class="table-container"><table><thead><tr><th>From</th><th>To</th></tr></thead><tbody><tr><td>a</td><td>b</td></tr><tr><td>b</td><td>c</td></tr><tr><td>b</td><td>d</td></tr><tr><td>c</td><td>e</td></tr><tr><td>d</td><td>e</td></tr></tbody></table></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> edges (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">   <span class="keyword">values</span></span><br><span class="line">          (<span class="string">'a'</span>, <span class="string">'b'</span>), (<span class="string">'b'</span>, <span class="string">'c'</span>), (<span class="string">'b'</span>, <span class="string">'d'</span>),</span><br><span class="line">          (<span class="string">'c'</span>, <span class="string">'e'</span>), (<span class="string">'d'</span>, <span class="string">'e'</span>)</span><br><span class="line">), discovered (node) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> edges.to_</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    edges, discovered</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">    discovered.node = edges.from_)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> discovered;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> node </span><br><span class="line"><span class="comment">------</span></span><br><span class="line"> a</span><br><span class="line"> b</span><br><span class="line"> d</span><br><span class="line"> c</span><br><span class="line"> e</span><br><span class="line"> e</span><br><span class="line">(6 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h4 id="求从a开始每一步能到达的节点"><a href="#求从a开始每一步能到达的节点" class="headerlink" title="求从a开始每一步能到达的节点"></a>求从<code>a</code>开始每一步能到达的节点</h4><p>应用SQL Standard中的Working Table表达:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> edges (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">   <span class="keyword">values</span></span><br><span class="line">          (<span class="string">'a'</span>, <span class="string">'b'</span>), (<span class="string">'b'</span>, <span class="string">'c'</span>), (<span class="string">'b'</span>, <span class="string">'d'</span>),</span><br><span class="line">          (<span class="string">'c'</span>, <span class="string">'e'</span>), (<span class="string">'d'</span>, <span class="string">'e'</span>)</span><br><span class="line">), discovered (node, step) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="string">'a'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> edges.to_, discovered.step + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    edges, discovered</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">    discovered.node = edges.from_)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> discovered;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> node | step </span><br><span class="line"><span class="comment">------+------</span></span><br><span class="line"> a    |    0</span><br><span class="line"> b    |    1</span><br><span class="line"> d    |    2</span><br><span class="line"> c    |    2</span><br><span class="line"> e    |    3</span><br><span class="line"> e    |    3</span><br><span class="line">(6 rows)</span><br></pre></td></tr></tbody></table></figure><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">step | WorkingTable</span><br><span class="line">init | {a}</span><br><span class="line">1    | {b}</span><br><span class="line">2    | {c, d}</span><br><span class="line">3    | {e, e}</span><br><span class="line">4    | {}</span><br></pre></td></tr></tbody></table></figure><p><br></p><h4 id="图被更改-再求从a开始每一步能到达的节点"><a href="#图被更改-再求从a开始每一步能到达的节点" class="headerlink" title="图被更改, 再求从a开始每一步能到达的节点"></a>图被更改, 再求从<code>a</code>开始每一步能到达的节点</h4><p>图中我们多加了一个<code>('c', 'b')</code>的边。应用SQL Standard中的<code>WorkingTable</code>表达:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> edges (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">   <span class="keyword">values</span></span><br><span class="line">          (<span class="string">'a'</span>, <span class="string">'b'</span>), (<span class="string">'b'</span>, <span class="string">'c'</span>), (<span class="string">'b'</span>, <span class="string">'d'</span>),</span><br><span class="line">          (<span class="string">'c'</span>, <span class="string">'e'</span>), (<span class="string">'d'</span>, <span class="string">'e'</span>), (<span class="string">'c'</span>, <span class="string">'b'</span>)</span><br><span class="line">), discovered (node, step) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="string">'a'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> edges.to_, discovered.step + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> edges, discovered</span><br><span class="line">    <span class="keyword">where</span> discovered.node = edges.from_ <span class="keyword">and</span> step &lt; <span class="number">6</span></span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> discovered;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> node | step </span><br><span class="line"><span class="comment">------+------</span></span><br><span class="line"> a    |    0</span><br><span class="line"> b    |    1</span><br><span class="line"> c    |    2</span><br><span class="line"> d    |    2</span><br><span class="line"> e    |    3</span><br><span class="line"> e    |    3</span><br><span class="line"> b    |    3</span><br><span class="line"> c    |    4</span><br><span class="line"> d    |    4</span><br><span class="line"> e    |    5</span><br><span class="line"> e    |    5</span><br><span class="line"> b    |    5</span><br><span class="line"> c    |    6</span><br><span class="line"> d    |    6</span><br><span class="line">(14 rows)</span><br></pre></td></tr></tbody></table></figure><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">step | WorkingTable</span><br><span class="line">init | {a}</span><br><span class="line">1    | {b}</span><br><span class="line">2    | {c, d}</span><br><span class="line">3    | {e, e, b}</span><br><span class="line">4    | {c, d}</span><br><span class="line">5    | {e, e, b}</span><br><span class="line">6    | {c, d}</span><br></pre></td></tr></tbody></table></figure><p>由于这条多加的边，让<code>union all</code>对应的循环一直不终止，即<code>WorkingTable</code>一直不为空。所有我在上面多加了<code>step &lt; 6</code>这个条件，强制６步以后终止。当然如果换用<code>union</code>可以让它终止。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;图论&quot;&gt;&lt;a href=&quot;#图论&quot; class=&quot;headerlink&quot; title=&quot;图论&quot;&gt;&lt;/a&gt;图论&lt;/h1&gt;&lt;p&gt;在这篇文章高级 SQL 中我们会遇到递归查询图论的题目。我们使用的数据集(图)都在文章中的SQL中。&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/categories/Graph/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Recursion" scheme="https://cakebytheoceanluo.github.io/tags/Recursion/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/tags/Graph/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-递归(3)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/26/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-3/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/26/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-3/</id>
    <published>2020-03-26T13:49:58.000Z</published>
    <updated>2020-03-26T13:54:36.347Z</updated>
    
    <content type="html"><![CDATA[<h1 id="图论"><a href="#图论" class="headerlink" title="图论"></a>图论</h1><p>在这篇文章高级 SQL 中我们会遇到递归查询图论的题目。我们使用的数据集(图)都在文章中的SQL中。</p><a id="more"></a><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>一个图论的例子：</p><p><img data-src="/images/SQL/dag.png" alt="dag.png"></p><p><strong>如果我们无视图中的箭头</strong>，那么这个图是一个<strong>有向无环图(DAG, directed acyclic graph)</strong>。</p><p><br></p><h3 id="视作有向图，寻找传递闭包-Transitive-closure-，即这个图中节点的联通节点-Connectivity"><a href="#视作有向图，寻找传递闭包-Transitive-closure-，即这个图中节点的联通节点-Connectivity" class="headerlink" title="视作有向图，寻找传递闭包(Transitive closure)，即这个图中节点的联通节点(Connectivity):"></a>视作有向图，寻找传递闭包(Transitive closure)，即这个图中节点的联通节点(Connectivity):</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- 第二个联通部分</span></span><br><span class="line">), transitive_closure (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(集合)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> transitive_closure c, graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> transitive_closure</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure><p>输出:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | b</span><br><span class="line"> a     | c</span><br><span class="line"> a     | d</span><br><span class="line"> a     | e</span><br><span class="line"> b     | c</span><br><span class="line"> b     | d</span><br><span class="line"> b     | e</span><br><span class="line"> c     | d</span><br><span class="line"> f     | c</span><br><span class="line"> f     | d</span><br><span class="line"> x     | y</span><br><span class="line">(11 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><h3 id="表达成无向图："><a href="#表达成无向图：" class="headerlink" title="表达成无向图："></a>表达成无向图：</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- 第二个联通部分</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- 无向图</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> un_dir_graph</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure><p>输出:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | b</span><br><span class="line"> b     | a</span><br><span class="line"> b     | c</span><br><span class="line"> b     | e</span><br><span class="line"> c     | b</span><br><span class="line"> c     | d</span><br><span class="line"> c     | f</span><br><span class="line"> d     | c</span><br><span class="line"> e     | b</span><br><span class="line"> f     | c</span><br><span class="line"> x     | y</span><br><span class="line"> y     | x</span><br><span class="line">(12 rows)</span><br></pre></td></tr></tbody></table></figure><p>很容易发现<code>un_dir_graph</code>是一个对称的关系(symmetric relation): </p><script type="math/tex; mode=display">\exists (a , b) \in R \Rightarrow (b, a) \in R</script><p>当我们使用<code>un_dir_graph</code>递归的时候，　用<code>UNION ALL</code>是肯定不会终止的，因为<code>UNION ALL</code>采用包语义(Bag Semantics)，它不会消除重复(duplicates)。<br>而<code>UNION</code>采用集合语义(Set Semantics)，它会消除重复。</p><p><br></p><h3 id="视作无向图，寻找传递闭包-Transitive-closure-，即这个图中节点的联通节点-Connectivity"><a href="#视作无向图，寻找传递闭包-Transitive-closure-，即这个图中节点的联通节点-Connectivity" class="headerlink" title="视作无向图，寻找传递闭包(Transitive closure)，即这个图中节点的联通节点(Connectivity):"></a>视作无向图，寻找传递闭包(Transitive closure)，即这个图中节点的联通节点(Connectivity):</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- 第二个联通部分</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- 无向图</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">), clo (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> un_dir_graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(集合)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> clo c, un_dir_graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> clo</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure><p>输出:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | a</span><br><span class="line"> a     | b</span><br><span class="line"> a     | c</span><br><span class="line"> a     | d</span><br><span class="line"> a     | e</span><br><span class="line"> a     | f</span><br><span class="line"> b     | a</span><br><span class="line"> b     | b</span><br><span class="line"> b     | c</span><br><span class="line"> b     | d</span><br><span class="line"> b     | e</span><br><span class="line"> b     | f</span><br><span class="line"> c     | a</span><br><span class="line"> c     | b</span><br><span class="line"> c     | c</span><br><span class="line"> c     | d</span><br><span class="line"> c     | e</span><br><span class="line"> c     | f</span><br><span class="line"> d     | a</span><br><span class="line"> d     | b</span><br><span class="line"> d     | c</span><br><span class="line"> d     | d</span><br><span class="line"> d     | e</span><br><span class="line"> d     | f</span><br><span class="line"> e     | a</span><br><span class="line"> e     | b</span><br><span class="line"> e     | c</span><br><span class="line"> e     | d</span><br><span class="line"> e     | e</span><br><span class="line"> e     | f</span><br><span class="line"> f     | a</span><br><span class="line"> f     | b</span><br><span class="line"> f     | c</span><br><span class="line"> f     | d</span><br><span class="line"> f     | e</span><br><span class="line"> f     | f</span><br><span class="line"> x     | x</span><br><span class="line"> x     | y</span><br><span class="line"> y     | x</span><br><span class="line"> y     | y</span><br><span class="line">(40 rows)</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>另一种解法:</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- 第二个联通部分</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- 无向图</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">), closure (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> un_dir_graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(集合)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> closure c, graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">), connected_graph (from_ ,to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> to_ , from_</span><br><span class="line">    <span class="keyword">from</span> closure)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(集合)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_ , cg.to_</span><br><span class="line">    <span class="keyword">from</span> closure c, connected_graph cg</span><br><span class="line">    <span class="keyword">where</span> c.to_ = cg.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> connected_graph</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>这里必须解释一下<code>closure</code>所形成的表格，它即不是对应有向图的传递闭包(transitive_closure)，也不是对应无向图的传递闭包(transitive_closure)。它是我们求无向图传递闭包的一个中间步骤, 它代表的路径是:</p><ul><li>第一步来自于无向图</li><li>如果有后续的步骤，那么后续的步骤来自于有向图。</li></ul><p>下面是它的内容：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | b</span><br><span class="line"> a     | c</span><br><span class="line"> a     | d</span><br><span class="line"> a     | e</span><br><span class="line"> b     | a</span><br><span class="line"> b     | b</span><br><span class="line"> b     | c</span><br><span class="line"> b     | d</span><br><span class="line"> b     | e</span><br><span class="line"> c     | b</span><br><span class="line"> c     | c</span><br><span class="line"> c     | d</span><br><span class="line"> c     | e</span><br><span class="line"> c     | f</span><br><span class="line"> d     | c</span><br><span class="line"> d     | d</span><br><span class="line"> e     | b</span><br><span class="line"> e     | c</span><br><span class="line"> e     | d</span><br><span class="line"> e     | e</span><br><span class="line"> f     | c</span><br><span class="line"> f     | d</span><br><span class="line"> x     | y</span><br><span class="line"> y     | x</span><br><span class="line"> y     | y</span><br><span class="line">(25 rows)</span><br></pre></td></tr></tbody></table></figure><ul><li><code>(b, b)</code>在里面，因为第一步<code>(b, a)</code>属于无向图，第二步<code>(a, b)</code>属于有向图。</li><li><code>(c, a)</code>不在里面，因为即使第一步<code>(c, b)</code>属于无向图，但是第二步<code>(b, a)</code>不属于有向图。</li></ul><p><br></p><h3 id="求从b从两个方向能到达的所有地方："><a href="#求从b从两个方向能到达的所有地方：" class="headerlink" title="求从b从两个方向能到达的所有地方："></a>求从<code>b</code>从两个方向能到达的所有地方：</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- 第二个联通部分</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- 无向图</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">), clo (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> un_dir_graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(集合)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> clo c, un_dir_graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> clo</span><br><span class="line"><span class="keyword">where</span> from_ = <span class="string">'b'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> to_;</span><br></pre></td></tr></tbody></table></figure><p>当然看图的话，我们可以发现<code>b</code>可以到达上面那个连通图中所有的6个节点。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;图论&quot;&gt;&lt;a href=&quot;#图论&quot; class=&quot;headerlink&quot; title=&quot;图论&quot;&gt;&lt;/a&gt;图论&lt;/h1&gt;&lt;p&gt;在这篇文章高级 SQL 中我们会遇到递归查询图论的题目。我们使用的数据集(图)都在文章中的SQL中。&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/categories/Graph/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Recursion" scheme="https://cakebytheoceanluo.github.io/tags/Recursion/"/>
    
      <category term="Graph" scheme="https://cakebytheoceanluo.github.io/tags/Graph/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-去关联(2)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/25/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-2/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/25/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-2/</id>
    <published>2020-03-25T11:09:41.000Z</published>
    <updated>2020-03-25T11:10:34.069Z</updated>
    
    <content type="html"><![CDATA[<p>这篇文章继<a href="https://cakebytheoceanluo.github.io/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/">[SQL]高级SQL-去关联(1)</a>后，继续对去关联这个主题进行练习。</p><a id="more"></a><h1 id="TPC-H例子一"><a href="#TPC-H例子一" class="headerlink" title="TPC-H例子一"></a>TPC-H例子一</h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">l_extendedprice &gt; (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(l2.l_extendedprice)</span><br><span class="line">    <span class="keyword">from</span> lineitem l2</span><br><span class="line">    <span class="keyword">where</span> l2.l_orderkey = l1.l_orderkey</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><code>l1.l_orderkey</code>是这个子查询(Sub-Query)中来自外查询的字段，也就是它造成了这个依赖(dependency)。</p><p>很容易可以发现：</p><ul><li>对每一个子查询的<code>lineitem l2</code>的元组，需要它的<code>l2.l_orderkey</code>字段值依赖于外界<code>lineitem l1</code>的对应<code>l1.l_orderkey</code>字段值。</li><li>外依赖条件指：<code>l2.l_orderkey = l1.l_orderkey</code></li><li>$D$是<code>l1.l_orderkey</code>对应字段值的集合。</li></ul><p>我们可以完全抽离这个关联部分到另外一个暂时的表格，再用<strong>外依赖条件</strong>和它regular join。<strong>这里这个外依赖条件没有意义，我们可以直接在<code>lineitem</code>表格中计算平均值, 而省去regular join获得高性能。</strong></p><h2 id="去除join的结果"><a href="#去除join的结果" class="headerlink" title="去除join的结果"></a>去除join的结果</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l,</span><br><span class="line">     (<span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice) <span class="keyword">as</span> avgPrice, </span><br><span class="line">             l_orderkey</span><br><span class="line">      <span class="keyword">from</span> lineitem</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> l_orderkey) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_extendedprice &gt; precomputed.avgPrice <span class="keyword">and</span> </span><br><span class="line">    l.l_orderkey = precomputed.l_orderkey;</span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice) <span class="keyword">as</span> avgPrice, </span><br><span class="line">           l_orderkey</span><br><span class="line">    <span class="keyword">from</span> lineitem</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> l_orderkey)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l,</span><br><span class="line">     precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_extendedprice &gt; precomputed.avgPrice</span><br><span class="line">    <span class="keyword">and</span> l.l_orderkey = precomputed.l_orderkey;</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="TPC-H例子二"><a href="#TPC-H例子二" class="headerlink" title="TPC-H例子二"></a>TPC-H例子二</h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        orders o1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        o_totalprice &lt; (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">                <span class="keyword">avg</span>(o_totalprice)</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">                orders o2</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">                o2.o_shippriority = o1.o_shippriority <span class="keyword">or</span></span><br><span class="line">                o2.o_orderstatus = o1.o_orderstatus)</span><br></pre></td></tr></tbody></table></figure><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><p>很容易可以发现：</p><ul><li>对每一个<code>orders o2</code>的元组，需要它的<code>o2.o_shippriority</code>和<code>o2.o_orderstatus</code>字段值依赖外界<code>order o1</code>的对应字段值。</li><li>外依赖条件指：<code>o2.o_shippriority = o1.o_shippriority or o2.o_orderstatus = o1.o_orderstatus</code></li><li>$D$是<code>o1.o_shippriority, o1.o_orderstatus</code>对应字段值的集合。</li></ul><p>我们可以完全抽离这个关联部分到另外一个暂时的表格，再用<strong>外依赖条件</strong>和它regular join。</p><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        orders o1,</span><br><span class="line">        (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">                <span class="keyword">avg</span>(o2.o_totalprice), d.o_shippriority, d.o_orderstatus</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">                orders o2, </span><br><span class="line">                (<span class="keyword">select</span> <span class="keyword">distinct</span> o_shippriority , o_orderstatus <span class="keyword">from</span> orders) d</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">                o2.o_shippriority = d.o_shippriority <span class="keyword">or</span></span><br><span class="line">                o2.o_orderstatus = d.o_orderstatus</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> d.o_shippriority, d.o_orderstatus</span><br><span class="line">        ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        o_totalprice &lt; precomputed.avg <span class="keyword">and</span></span><br><span class="line">        precomputed.o_shippriority = o1.o_shippriority <span class="keyword">and</span></span><br><span class="line">        precomputed.o_orderstatus = o1.o_orderstatus</span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">            <span class="keyword">avg</span>(o2.o_totalprice), d.o_shippriority, d.o_orderstatus</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">            orders o2, </span><br><span class="line">            (<span class="keyword">select</span> <span class="keyword">distinct</span> o_shippriority , o_orderstatus <span class="keyword">from</span> orders) d</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">            o2.o_shippriority = d.o_shippriority <span class="keyword">or</span></span><br><span class="line">            o2.o_orderstatus = d.o_orderstatus</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> d.o_shippriority, d.o_orderstatus</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        orders o1, precomputed</span><br><span class="line">        </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        o_totalprice &lt; precomputed.avg <span class="keyword">and</span></span><br><span class="line">        precomputed.o_shippriority = o1.o_shippriority <span class="keyword">and</span></span><br><span class="line">        precomputed.o_orderstatus = o1.o_orderstatus</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="TPC-H例子三"><a href="#TPC-H例子三" class="headerlink" title="TPC-H例子三"></a>TPC-H例子三</h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span> </span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span><span class="keyword">and</span> </span><br><span class="line">    <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            *</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            lineitem</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            l_orderkey = o_orderkey <span class="keyword">and</span> </span><br><span class="line">            l_commitdate &lt; l_receiptdate</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><p>很容易可以发现：</p><ul><li>对每一个<code>lineitem</code>的元组，需要它的<code>l_orderkey</code>字段值依赖外界<code>order</code>的对应字段值。</li><li>外依赖条件指：<code>l_orderkey = o_orderkey</code></li><li>$D$是<code>order.o_orderkey</code>对应字段值的集合。</li></ul><p>我们可以完全抽离这个关联部分到另外一个暂时的表格，再用<strong>外依赖条件</strong>和它regular join。</p><h2 id="结果-1"><a href="#结果-1" class="headerlink" title="结果"></a>结果</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders,(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem,</span><br><span class="line">        (<span class="keyword">select</span> <span class="keyword">distinct</span> o_orderkey <span class="keyword">from</span> orders) <span class="keyword">as</span> o</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_orderkey = o_orderkey <span class="keyword">and</span> </span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        o_orderkey</span><br><span class="line">    ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.o_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem,</span><br><span class="line">        (<span class="keyword">select</span> <span class="keyword">distinct</span> o_orderkey <span class="keyword">from</span> orders) <span class="keyword">as</span> o</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_orderkey = o_orderkey <span class="keyword">and</span> </span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        o_orderkey</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders,</span><br><span class="line">    precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.o_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><h2 id="去除join的结果-1"><a href="#去除join的结果-1" class="headerlink" title="　去除join的结果"></a>　去除join的结果</h2><p><strong>这里这个外依赖条件没有意义，我们可以直接在<code>lineitem</code>表格中获得<code>l_orderkey</code>(它是<code>o_orderkey</code>的外键), 而省去regular join获得高性能。</strong></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders,(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        l_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        l_orderkey</span><br><span class="line">    ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.l_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        l_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        l_orderkey</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders, precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.l_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="论文中的Q2"><a href="#论文中的Q2" class="headerlink" title="论文中的Q2"></a>论文中的Q2</h1><p>这个Q2不对应任何我已知的数据集，只是在论文中逻辑性地被提出。</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name , e.course</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    students s,</span><br><span class="line">    exams e</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    s.id = e.sid <span class="keyword">and</span></span><br><span class="line">    (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>)</span><br><span class="line"><span class="keyword">and</span> e.grade &gt;= (</span><br><span class="line">    <span class="comment">-- one grade worse</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        <span class="keyword">avg</span> (e2.grade) + <span class="number">1</span></span><br><span class="line">    <span class="comment">-- than the average grade</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        exams e2</span><br><span class="line">    <span class="comment">-- of exams taken by</span></span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        s.id = e2.sid <span class="keyword">or</span></span><br><span class="line">        <span class="comment">-- him / her or taken by elder peers</span></span><br><span class="line">        (e2.curriculum = s.major <span class="keyword">and</span> s.year &gt; e2.date))</span><br></pre></td></tr></tbody></table></figure><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><p>很容易可以发现：</p><ul><li>对每一个<code>exams e2</code>的元组，需要它的<code>e2.sid, e2.curriculum, e2.data</code>字段值依赖外界<code>student s</code>的对应字段值。</li><li>外依赖条件指：<code>s.id = e2.sid or (e2.curriculum = s.major and s.year &gt; e2.date))</code></li><li>$D$是<code>s.id, s.major, s.year</code>对应字段值的集合。</li></ul><p>我们可以完全抽离这个关联部分到另外一个暂时的表格，再用<strong>外依赖条件</strong>和它regular join。</p><h2 id="结果-2"><a href="#结果-2" class="headerlink" title="结果"></a>结果</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    students s,</span><br><span class="line">    exams e, (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> students s, exams e</span><br><span class="line">        <span class="keyword">where</span> s.id = e.sid <span class="keyword">and</span> (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>)</span><br><span class="line">     ) <span class="keyword">as</span> l, (</span><br><span class="line">         <span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">year</span>, major </span><br><span class="line">         <span class="keyword">from</span> l</span><br><span class="line">     ) <span class="keyword">as</span> d, (</span><br><span class="line">         <span class="keyword">select</span> d.id, d.year, d.major, <span class="keyword">avg</span>(e2.grade) <span class="keyword">as</span> m</span><br><span class="line">         <span class="keyword">from</span> d, exam e2</span><br><span class="line">         <span class="keyword">where</span> d.id = e2.sid <span class="keyword">or</span> (d.year &gt; e2.year <span class="keyword">and</span> e2.curriculum = d.major)</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> d.id, d.year, d.major</span><br><span class="line">     ) <span class="keyword">as</span> d_</span><br><span class="line"><span class="keyword">where</span> e.grade &gt; m + <span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">      d_.id = s.id <span class="keyword">and</span> </span><br><span class="line">      d_.year = e.date <span class="keyword">and</span> </span><br><span class="line">      e.curriculum = d_.major;</span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> l <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> students s, exams e</span><br><span class="line">        <span class="keyword">where</span> s.id = e.sid <span class="keyword">and</span> (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>)</span><br><span class="line">),</span><br><span class="line">d <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">year</span>, major</span><br><span class="line">         <span class="keyword">from</span> l</span><br><span class="line">     ),</span><br><span class="line">d_ <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> d.id, d.year, d.major, <span class="keyword">avg</span>(e2.grade) <span class="keyword">as</span> m</span><br><span class="line">         <span class="keyword">from</span> d, exam e2</span><br><span class="line">         <span class="keyword">where</span> d.id = e2.sid <span class="keyword">or</span> (d.year &gt; e2.year <span class="keyword">and</span> e2.curriculum = d.major)</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> d.id, d.year, d.major</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span> l, d_</span><br><span class="line"><span class="keyword">where</span> e.grade &gt; m + <span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">         d_.id = l.id <span class="keyword">and</span></span><br><span class="line">         d_.year = l.year <span class="keyword">and</span></span><br><span class="line">         d_.major = l.curriculum;</span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    students s,</span><br><span class="line">    exams e, (</span><br><span class="line">         <span class="keyword">select</span> s2.id, s2.year, s2.major, <span class="keyword">avg</span>(e2.grade) <span class="keyword">as</span> m</span><br><span class="line">         <span class="keyword">from</span> exam e2,</span><br><span class="line">              (<span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">year</span>, major <span class="keyword">from</span> students) <span class="keyword">as</span> s2</span><br><span class="line">         <span class="keyword">where</span></span><br><span class="line">               s2.id = e2.sid</span><br><span class="line">               <span class="keyword">or</span> (s2.year &gt; e2.year <span class="keyword">and</span> e2.curriculum = s2.major)</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> s2.id, s2.year, s2.major</span><br><span class="line">     ) <span class="keyword">as</span> preagg</span><br><span class="line"><span class="keyword">where</span> s.id = e.sid <span class="keyword">and</span></span><br><span class="line">      (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>) <span class="keyword">and</span></span><br><span class="line">      s.id = preagg.id <span class="keyword">and</span> </span><br><span class="line">      s.major = preagg.major <span class="keyword">and</span></span><br><span class="line">      s.year = preagg.year <span class="keyword">and</span></span><br><span class="line">      e.grade &gt; m + <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p>引用: </p><p>1: TUM Foundation of Data Engineering Chap3.Advanced SQL: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><p>2.<span class="exturl" data-url="aHR0cHM6Ly9kbC5naS5kZS9iaXRzdHJlYW0vaGFuZGxlLzIwLjUwMC4xMjExNi8yNDE4LzM4My5wZGY/c2VxdWVuY2U9MQ==" title="https://dl.gi.de/bitstream/handle/20.500.12116/2418/383.pdf?sequence=1">Unnesting Arbitrary Queries - Thomas Neumann and Alfons Kemper - (BTW 2015)<i class="fa fa-external-link"></i></span></p><p>3.<a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这篇文章继&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/&quot;&gt;[SQL]高级SQL-去关联(1)&lt;/a&gt;后，继续对去关联这个主题进行练习。&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Query Optimizer" scheme="https://cakebytheoceanluo.github.io/categories/Query-Optimizer/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Query Optimizer" scheme="https://cakebytheoceanluo.github.io/tags/Query-Optimizer/"/>
    
      <category term="Subquery Optimization" scheme="https://cakebytheoceanluo.github.io/tags/Subquery-Optimization/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]高级SQL-去关联(1)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/</id>
    <published>2020-03-24T17:16:36.000Z</published>
    <updated>2020-03-25T09:52:28.169Z</updated>
    
    <content type="html"><![CDATA[<p>我们在一篇论文解读文章<a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">[Paper]BTW 2015 | Unnesting Arbitrary Queries</a>中提到了去关联, 在这一篇文章中我们对这个主题进行<strong>练习</strong>。</p><p>这个主题其实远比大家想象中的要实用: 对于1GiB大小左右的数据集，SQL查询如果拥有$O(n^2)$的时间复杂度，基本可以判断很慢，或者慢到无实际意义。往往我们使用的各种大名鼎鼎的开源数据库和商用数据库不一定支持Unnesting这个feature(具体的支持在各个数据库的Document中描述，在对应的论文中的Motivation部分也有简单提到)。这就意味着, 我们需要手动成为Query Optimizer去优化我们SQL的时间复杂度。 </p><a id="more"></a><h1 id="Correlated-Sub-Query-vs-Uncorrelated-Sub-Query"><a href="#Correlated-Sub-Query-vs-Uncorrelated-Sub-Query" class="headerlink" title="Correlated Sub-Query vs. Uncorrelated Sub-Query"></a>Correlated Sub-Query vs. Uncorrelated Sub-Query</h1><p>一般来说，correlated sub-query(关联子query)的时间复杂度会比uncorrelated sub-query(无关联子query)大。</p><p>当然这部分的前提是：query optimizer(优化器)不对SQL的logical plan进行优化。<br>而一些优秀的数据库<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbmRleC5odG1sIw==" title="https://hyper-db.de/index.html#">HyPer<i class="fa fa-external-link"></i></span>已经把这个问题用query optimizer解决了，它会主动去优化，比如可以<strong>去关联</strong>。</p><p>更多的可以看这一篇论文<span class="exturl" data-url="aHR0cDovL3d3dy5idHctMjAxNS5kZS9yZXMvcHJvY2VlZGluZ3MvSGF1cHRiYW5kL1dpc3MvTmV1bWFubi1Vbm5lc3RpbmdfQXJiaXRyYXJ5X1F1ZXJpZS5wZGY=" title="http://www.btw-2015.de/res/proceedings/Hauptband/Wiss/Neumann-Unnesting_Arbitrary_Querie.pdf">Unnesting Arbitrary Queries, Thomas Neumann and Alfons Kemper, Technische Universitat München<i class="fa fa-external-link"></i></span></p><h1 id="数据集"><a href="#数据集" class="headerlink" title="数据集"></a>数据集</h1><p>这篇文章中我们会使用如下的数据集:</p><ul><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#TUM-Uni%E6%95%B0%E6%8D%AE%E9%9B%86">TUM Uni 数据集</a></li><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#TPC-H">TPC-H 数据集</a></li></ul><p>具体的数据集安装见上面的对应的链接。另外有一些SQL并不对应任何数据集, 只是在论文中逻辑性地被提出和使用，这样的SQL我会特别注明: <strong>不对应数据集</strong>。</p><hr><h1 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h1><h2 id="使用max代替exists-搜索出生日期比所有教授早的学生"><a href="#使用max代替exists-搜索出生日期比所有教授早的学生" class="headerlink" title="使用max代替exists: 搜索出生日期比所有教授早的学生"></a>使用<code>max</code>代替<code>exists</code>: 搜索出生日期比所有教授早的学生</h2><p>这个Query需要的属性值(gebdatum　出生日期)没有被写入数据集。<br>所以不能运行，但是我们可以看着理解意思。</p><ul><li>correlated sub-query</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> p.*</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">    <span class="keyword">where</span> p.gebdatum &gt; s.gebdatumm</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure><p>对每一个studenten s都需要看整个professoren表格。<br>这个情况很类似cross product(集合的叉乘)。这个subquery需要被执行<code>|studenten|</code>次。</p><p>如果query optimizer(优化器)不对这个SQL的logical plan进行优化的话，那它的runtime complexity(时间复杂度)是<code>O(|studenten| * |professoren|)</code>，类推到<code>O(n^2)</code>。</p><p><br></p><ul><li>uncorrelated Sub-query</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> s.gebdatum &lt; (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">max</span>(gebdatum)</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure><p>这样这个subquery只需一次被materialized(materialization，物质化，实例化)，也就是只需要被执行一次得到这个<code>max</code>。然后在去看<code>studenten</code>中的每一个人去和这个<code>max</code>比较。这样肯定会更加有效率。它的runtime complexity是$O(|\mathrm{studenten}| ＋ |\mathrm{professoren}|)$，类推到 $O(n)$。</p><p><br></p><h2 id="使用join代替subquery-搜索出生日期比对应教授早的助手-助手需要在对应教授手下工作"><a href="#使用join代替subquery-搜索出生日期比对应教授早的助手-助手需要在对应教授手下工作" class="headerlink" title="使用join代替subquery: 搜索出生日期比对应教授早的助手(助手需要在对应教授手下工作)"></a>使用join代替subquery: 搜索出生日期比对应教授早的助手(助手需要在对应教授手下工作)</h2><ul><li>correlated sub-query:</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.*</span><br><span class="line"><span class="keyword">from</span> assistenten a</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> p.*</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">    <span class="keyword">where</span> a.boss = p.persnr <span class="keyword">and</span> p.gebdatum &gt; a.gebdatum</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure><ul><li>unnested query(去嵌套):</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.*</span><br><span class="line"><span class="keyword">from</span> assistenten a, professoren p</span><br><span class="line"><span class="keyword">where</span> a.boss = p.persnr <span class="keyword">and</span> p.gebdatum &gt; a.gebdatum</span><br></pre></td></tr></tbody></table></figure><p>这时候我们直接用<code>join</code>来对原correlated sub-query去嵌套。采用<code>join</code>原因之一是：这时候不需要和所有professoren进行比较，只需要和对应的一个professor比较。</p><p><br></p><hr><h1 id="普遍作法"><a href="#普遍作法" class="headerlink" title="普遍作法"></a>普遍作法</h1><p>我们这里给出一个普遍的作法，但是不百分之百和原论文的想法契合。具体作法最好参考原论文：</p><p>下面这个很明显是一个关联的查询，子查询中需要外界<code>r1</code>的<code>attr1</code>, <code>attr2</code>。</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ...</span><br><span class="line"><span class="keyword">from</span> r1, </span><br><span class="line"><span class="keyword">where</span> ... </span><br><span class="line">(</span><br><span class="line">        <span class="keyword">select</span> ...</span><br><span class="line">        <span class="keyword">from</span> r2</span><br><span class="line">        <span class="keyword">where</span> r1.attr1 = ... <span class="keyword">and</span> r1.attr2 = ...</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p>那么我们就将这个子查询给抽离出来到<code>from</code>下面或者<code>with</code>里面，提前用不关联的方式物理化它的结果，而不是之后进行低效的笛卡尔积。<br>如果我们想用不关联的方式物理化子查询的结果，我们可以需要<code>r1</code>这个表格的另外一份复制品，但是实际上我们只需要<code>r1</code>中和join相关的字段值：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ...</span><br><span class="line"><span class="keyword">from</span> r1, </span><br><span class="line">       (</span><br><span class="line">        <span class="keyword">select</span> d.attr1, d.attr2 <span class="comment">-- 有可能还有其他聚合函数</span></span><br><span class="line">        <span class="keyword">from</span> r2,</span><br><span class="line">             (<span class="keyword">select</span> <span class="keyword">distinct</span> r1.attr1, r1.attr2 <span class="keyword">from</span> r1) <span class="keyword">as</span> d</span><br><span class="line">        <span class="keyword">where</span> d.attr1 = ... <span class="keyword">and</span> d.attr2 = ...</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> d.attr1, d.attr2</span><br><span class="line">        ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span> ... </span><br><span class="line">        precomputed.attr1 = r1.attr1 <span class="keyword">and</span></span><br><span class="line">        precomputed.attr2 = r1.attr1</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="TPC-H例子一-1"><a href="#TPC-H例子一-1" class="headerlink" title="TPC-H例子一 1"></a>TPC-H例子一 <sup><a href="#fn1">1</a></sup></h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l1</span><br><span class="line"><span class="keyword">where</span> l_extendedprice =</span><br><span class="line">   (<span class="keyword">select</span> <span class="keyword">min</span>(l_extendedprice)</span><br><span class="line">    <span class="keyword">from</span> lineitem l2</span><br><span class="line">    <span class="keyword">where</span> l1.l_orderkey = l2.l_orderkey);</span><br></pre></td></tr></tbody></table></figure><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l1,</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">min</span>(l_extendedprice) m, l_orderkey</span><br><span class="line">    <span class="keyword">from</span> lineitem</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> l_orderkey) l2</span><br><span class="line"><span class="keyword">where</span> l1.l_orderkey = l2.l_orderkey</span><br><span class="line"><span class="keyword">and</span> l_extendedprice = l2.m;</span><br></pre></td></tr></tbody></table></figure><ul><li>这里我们只需要对<code>l2</code>进行一次求值。</li></ul><p><br></p><h1 id="TPC-H例子二-1"><a href="#TPC-H例子二-1" class="headerlink" title="TPC-H例子二 1"></a>TPC-H例子二 <sup><a href="#fn1">1</a></sup></h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c1.c_name</span><br><span class="line"><span class="keyword">from</span> customer c1</span><br><span class="line"><span class="keyword">where</span> c1.c_mktsegment = <span class="string">'AUTOMOBILE'</span> </span><br><span class="line">      <span class="keyword">or</span> c1.c_acctbal &gt;</span><br><span class="line">                        (<span class="keyword">select</span> <span class="keyword">avg</span>(c2.c_acctbal)</span><br><span class="line">                        <span class="keyword">from</span> customer c2</span><br><span class="line">                        <span class="keyword">where</span> c2.c_mktsegment = c1.c_mktsegment);</span><br></pre></td></tr></tbody></table></figure><h2 id="结果-1"><a href="#结果-1" class="headerlink" title="结果"></a>结果</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c1.c_name</span><br><span class="line"><span class="keyword">from</span> customer c1, (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(c.c_acctbal) <span class="keyword">as</span> <span class="keyword">avg</span>, c_mktsegment</span><br><span class="line">    <span class="keyword">from</span> customer c</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_mktsegment</span><br><span class="line">    ) <span class="keyword">as</span> c2</span><br><span class="line"><span class="keyword">where</span> (c1.c_mktsegment = <span class="string">'AUTOMOBILE'</span></span><br><span class="line">      <span class="keyword">or</span> c1.c_acctbal &gt; c2.avg)</span><br><span class="line">      <span class="keyword">and</span> c1.c_mktsegment = c2.c_mktsegment</span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> c2 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(c.c_acctbal) <span class="keyword">as</span> <span class="keyword">avg</span>, c_mktsegment</span><br><span class="line">    <span class="keyword">from</span> customer c</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_mktsegment</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> c1.c_name</span><br><span class="line"><span class="keyword">from</span> customer c1, c2</span><br><span class="line"><span class="keyword">where</span> (c1.c_mktsegment = <span class="string">'AUTOMOBILE'</span></span><br><span class="line">      <span class="keyword">or</span> c1.c_acctbal &gt; c2.avg)</span><br><span class="line">      <span class="keyword">and</span> c1.c_mktsegment = c2.c_mktsegment</span><br></pre></td></tr></tbody></table></figure><p><br></p><h1 id="TPC-H-Q17-例子"><a href="#TPC-H-Q17-例子" class="headerlink" title="TPC-H Q17 例子"></a>TPC-H Q17 例子</h1><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- TPC-H Query 17</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">        <span class="keyword">sum</span>(l_extendedprice) / <span class="number">7.0</span> <span class="keyword">as</span> avg_yearly</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        lineitem,</span><br><span class="line">        part</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        p_partkey = l_partkey</span><br><span class="line">        <span class="keyword">and</span> p_brand = <span class="string">'Brand#23'</span></span><br><span class="line">        <span class="keyword">and</span> p_container = <span class="string">'MED BOX'</span></span><br><span class="line">        <span class="keyword">and</span> l_quantity &lt; (</span><br><span class="line">                <span class="keyword">select</span></span><br><span class="line">                        <span class="number">0.2</span> * <span class="keyword">avg</span>(l_quantity)</span><br><span class="line">                <span class="keyword">from</span></span><br><span class="line">                        lineitem</span><br><span class="line">                <span class="keyword">where</span></span><br><span class="line">                        l_partkey = p_partkey</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>很清晰，关联(nested, correlated)的部分如下：<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">from</span><br><span class="line">        lineitem,</span><br><span class="line">        part</span><br><span class="line">...</span><br><span class="line">        and l_quantity &lt; (</span><br><span class="line">                <span class="keyword">select</span></span><br><span class="line">                        <span class="number">0.2</span> * <span class="keyword">avg</span>(l_quantity)</span><br><span class="line">                <span class="keyword">from</span></span><br><span class="line">                        lineitem</span><br><span class="line">                <span class="keyword">where</span></span><br><span class="line">                        l_partkey = p_partkey</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>p_partkey</code>是这个子查询(Sub-Query)中来自外查询的字段，也就是它造成了这个依赖(dependency)。</p><p>我们用文字去描述一下这个关联部分:  </p><ul><li>对每一个子查询的<code>lineitem</code>的元组，需要它的<code>l_partkey</code>字段值依赖于外界<code>part</code>的对应<code>p_partkey</code>字段值。</li><li>外依赖条件指：<code>l_partkey = p_partkey</code></li><li>$D$是<code>part.p_partkey</code>对应字段值的集合。</li></ul><p>我们可以完全抽离这个关联部分到另外一个暂时的表格，再用<strong>外依赖条件</strong>和它regular join。</p><h2 id="结果-2"><a href="#结果-2" class="headerlink" title="结果"></a>结果</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        <span class="keyword">sum</span> (l_extendedprice) / <span class="number">7.0</span> <span class="keyword">as</span> avg_yearly</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        lineitem l,</span><br><span class="line">        part,</span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span></span><br><span class="line">                    <span class="number">0.2</span> * <span class="keyword">avg</span> (l_quantity) <span class="keyword">avg</span>, l_partkey</span><br><span class="line">            <span class="keyword">from</span></span><br><span class="line">                    lineitem</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                    l_partkey</span><br><span class="line">        ) quaprecomputednt</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        p_partkey = l. l_partkey</span><br><span class="line">        <span class="keyword">and</span> p_brand = <span class="string">'Brand #23'</span></span><br><span class="line">        <span class="keyword">and</span> p_container = <span class="string">'MED BOX'</span></span><br><span class="line">        <span class="keyword">and</span> precomputed.l_partkey = p_partkey  <span class="comment">-- 使用外依赖条件的regular join</span></span><br><span class="line">        <span class="keyword">and</span> l_quantity &lt; precomputed.avg       <span class="comment">-- 去除原依赖</span></span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">            <span class="number">0.2</span> * <span class="keyword">avg</span> (l_quantity) <span class="keyword">avg</span> , l_partkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">            lineitem</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            l_partkey</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">        <span class="keyword">sum</span> (l_extendedprice) / <span class="number">7.0</span> <span class="keyword">as</span> avg_yearly</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        lineitem l,</span><br><span class="line">        part,</span><br><span class="line">        precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        p_partkey = l. l_partkey</span><br><span class="line">        <span class="keyword">and</span> p_brand = <span class="string">'Brand #23'</span></span><br><span class="line">        <span class="keyword">and</span> p_container = <span class="string">'MED BOX'</span></span><br><span class="line">        <span class="keyword">and</span> precomputed.l_partkey = p_partkey  <span class="comment">-- 使用外依赖条件的regular join</span></span><br><span class="line">        <span class="keyword">and</span> l_quantity &lt; precomputed.avg       <span class="comment">-- 去除原依赖</span></span><br></pre></td></tr></tbody></table></figure><p>引用: </p><p><a name="fn1">1</a>: TUM Foundation of Data Engineering Chap3.Advanced SQL: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p><p>2.<span class="exturl" data-url="aHR0cHM6Ly9kbC5naS5kZS9iaXRzdHJlYW0vaGFuZGxlLzIwLjUwMC4xMjExNi8yNDE4LzM4My5wZGY/c2VxdWVuY2U9MQ==" title="https://dl.gi.de/bitstream/handle/20.500.12116/2418/383.pdf?sequence=1">Unnesting Arbitrary Queries - Thomas Neumann and Alfons Kemper - (BTW 2015)<i class="fa fa-external-link"></i></span></p><p>3.<a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;我们在一篇论文解读文章&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/&quot;&gt;[Paper]BTW 2015 | Unnesting Arbitrary Queries&lt;/a&gt;中提到了去关联, 在这一篇文章中我们对这个主题进行&lt;strong&gt;练习&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;这个主题其实远比大家想象中的要实用: 对于1GiB大小左右的数据集，SQL查询如果拥有$O(n^2)$的时间复杂度，基本可以判断很慢，或者慢到无实际意义。往往我们使用的各种大名鼎鼎的开源数据库和商用数据库不一定支持Unnesting这个feature(具体的支持在各个数据库的Document中描述，在对应的论文中的Motivation部分也有简单提到)。这就意味着, 我们需要手动成为Query Optimizer去优化我们SQL的时间复杂度。 &lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
      <category term="Query Optimizer" scheme="https://cakebytheoceanluo.github.io/categories/Query-Optimizer/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="Query Optimizer" scheme="https://cakebytheoceanluo.github.io/tags/Query-Optimizer/"/>
    
      <category term="Subquery Optimization" scheme="https://cakebytheoceanluo.github.io/tags/Subquery-Optimization/"/>
    
  </entry>
  
  <entry>
    <title>[SQL]中级SQL(5)</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/22/SQL-%E4%B8%AD%E7%BA%A7SQL-5/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/22/SQL-%E4%B8%AD%E7%BA%A7SQL-5/</id>
    <published>2020-03-22T13:13:22.000Z</published>
    <updated>2020-03-22T13:15:03.293Z</updated>
    
    <content type="html"><![CDATA[<h1 id="TPC-H-数据集"><a href="#TPC-H-数据集" class="headerlink" title="TPC-H 数据集"></a>TPC-H 数据集</h1><p>我们这一篇文章采用PostgreSQL的SQL语法。重点我们关注<code>select...from...where</code>这种读操作，分析query　(analytical query)。<br><code>TPC-H</code>数据集在　<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>　可以直接使用。另外在这个网页不允许进行写操作:<code>insert</code>, <code>update</code>, <code>delete</code>之类的transactional query。当然<code>create table</code>和<code>drop table</code>也不被允许。</p><p><strong>本地载入改数据集</strong>的方法见我的博客两篇文章:</p><ul><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL 导入 TPC-H 数据集</a></li><li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL 导入数据集</a></li></ul><a id="more"></a><h1 id="中级SQL"><a href="#中级SQL" class="headerlink" title="中级SQL"></a>中级SQL</h1><p>这一篇文章其实目的是用简单的SQL去熟悉TPC-H这个数据集，因为这个数据集会在<strong>高级SQL</strong>部分一直被使用。</p><ul><li>有多少customer拥有order，而这个order的comment含有”packages”这个单词？</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> c_custkey)</span><br><span class="line"><span class="keyword">from</span> customer, orders</span><br><span class="line"><span class="keyword">where</span> c_custkey = o_custkey <span class="keyword">and</span> o_comment <span class="keyword">like</span> <span class="string">'%packages%'</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> o_custkey)</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">where</span> o_comment <span class="keyword">like</span> <span class="string">'%packages%'</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>求<code>l_orderkey</code>的数字数量的平均值(<code>char_length()</code>函数)：<ul><li><code>l_orderkey::text</code>和<code>l_orderkey || ''</code>都可以使int变成string<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(<span class="keyword">char_length</span>(l_orderkey || <span class="string">''</span>))</span><br><span class="line"><span class="keyword">from</span> lineitem;</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span> (<span class="keyword">char_length</span>(l_orderkey::<span class="built_in">text</span>))</span><br><span class="line"><span class="keyword">from</span> lineitem ;</span><br></pre></td></tr></tbody></table></figure><ul><li><p>求所有<code>customer</code>和所有<code>supplier</code>的名字：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_name</span><br><span class="line"><span class="keyword">from</span> customer</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> s_name</span><br><span class="line"><span class="keyword">from</span> supplier</span><br></pre></td></tr></tbody></table></figure></li><li><p>读取10个customers对应的nation，用JSON的形式去表达<code>custkey, name, nation</code>：</p></li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'{" custkey ": '</span> || c_custkey || <span class="string">', " name ":" '</span> || c_name || <span class="string">'", " nation ":{" nationkey ": '</span> || n_nationkey || <span class="string">', " name ":" '</span> || n_name || <span class="string">' "}} '</span> <span class="keyword">as</span> custjson</span><br><span class="line"><span class="keyword">from</span> customer , nation</span><br><span class="line"><span class="keyword">where</span> c_nationkey = n_nationkey <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></tbody></table></figure><p>输出：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">                                                  custjson                                                  </span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> {" custkey ": 86, " name ":" Customer#000000086", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 80, " name ":" Customer#000000080", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 76, " name ":" Customer#000000076", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 73, " name ":" Customer#000000073", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 48, " name ":" Customer#000000048", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 29, " name ":" Customer#000000029", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 144, " name ":" Customer#000000144", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line"> {" custkey ": 141, " name ":" Customer#000000141", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line"> {" custkey ": 106, " name ":" Customer#000000106", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line"> {" custkey ": 59, " name ":" Customer#000000059", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line">(10 rows)</span><br></pre></td></tr></tbody></table></figure><ul><li>German Supplier在1995年发了多少lineitem?</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(lineitem)</span><br><span class="line"><span class="keyword">from</span> supplier, nation, lineitem</span><br><span class="line"><span class="keyword">where</span> n_name = <span class="string">'GERMANY'</span> <span class="keyword">and</span> n_nationkey = s_nationkey <span class="keyword">and</span> s_suppkey = l_suppkey <span class="keyword">and</span> <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> l_shipdate) = <span class="number">1995</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(lineitem)</span><br><span class="line"><span class="keyword">from</span> supplier, nation, lineitem</span><br><span class="line"><span class="keyword">where</span> n_name = <span class="string">'GERMANY'</span> <span class="keyword">and</span> n_nationkey = s_nationkey <span class="keyword">and</span> s_suppkey = l_suppkey <span class="keyword">and</span> l_shipdate <span class="keyword">between</span> <span class="string">'1995-01-01'</span> <span class="keyword">and</span> <span class="string">'1995-12-31'</span></span><br></pre></td></tr></tbody></table></figure><ul><li>搜索EUROPE在FURNITURE　market segment中最高account balance的十个customers:</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_name, c_acctbal</span><br><span class="line"><span class="keyword">from</span> customer, nation, region</span><br><span class="line"><span class="keyword">where</span> r_name = <span class="string">'EUROPE'</span> <span class="keyword">and</span> r_regionkey = n_regionkey <span class="keyword">and</span> n_nationkey = c_nationkey <span class="keyword">and</span> c_mktsegment = <span class="string">'FURNITURE'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c_acctbal <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span></span><br></pre></td></tr></tbody></table></figure><ul><li>How many orders do customer have?</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(o_orderkey) <span class="keyword">as</span> o_count</span><br><span class="line"><span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders <span class="keyword">on</span> c_custkey = o_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_custkey</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_count <span class="keyword">desc</span>, c_custkey <span class="keyword">asc</span></span><br></pre></td></tr></tbody></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul><li><code>sum(l_extendedprice * (1 - l_discount))</code>: revenue</li><li>得到年份的例子：<code>extract(year from l_shipdate) = 1995</code></li><li><code>c_mktsegment</code>: market segment</li><li><code>c_acctbal</code>: account balance</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;TPC-H-数据集&quot;&gt;&lt;a href=&quot;#TPC-H-数据集&quot; class=&quot;headerlink&quot; title=&quot;TPC-H 数据集&quot;&gt;&lt;/a&gt;TPC-H 数据集&lt;/h1&gt;&lt;p&gt;我们这一篇文章采用PostgreSQL的SQL语法。重点我们关注&lt;code&gt;select...from...where&lt;/code&gt;这种读操作，分析query　(analytical query)。&lt;br&gt;&lt;code&gt;TPC-H&lt;/code&gt;数据集在　&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==&quot; title=&quot;https://hyper-db.de/interface.html&quot;&gt;https://hyper-db.de/interface.html&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;　可以直接使用。另外在这个网页不允许进行写操作:&lt;code&gt;insert&lt;/code&gt;, &lt;code&gt;update&lt;/code&gt;, &lt;code&gt;delete&lt;/code&gt;之类的transactional query。当然&lt;code&gt;create table&lt;/code&gt;和&lt;code&gt;drop table&lt;/code&gt;也不被允许。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;本地载入改数据集&lt;/strong&gt;的方法见我的博客两篇文章:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/&quot;&gt;[DBMS] PostgreSQL 导入 TPC-H 数据集&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/&quot;&gt;[DBMS] PostgreSQL 导入数据集&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/categories/SQL/"/>
    
    
      <category term="SQL" scheme="https://cakebytheoceanluo.github.io/tags/SQL/"/>
    
      <category term="TPC-H" scheme="https://cakebytheoceanluo.github.io/tags/TPC-H/"/>
    
  </entry>
  
  <entry>
    <title>[CMU-15445]Lec07 Tree Indexes Part I - 树索引 I</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/19/CMU-15445-Lec07/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/19/CMU-15445-Lec07/</id>
    <published>2020-03-19T18:09:58.000Z</published>
    <updated>2020-03-19T18:15:31.659Z</updated>
    
    <content type="html"><![CDATA[<p>Tree Indexes Part I - 树索引 I</p><p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA3LXRyZWVzMS5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDctdHJlZXMxLnBkZg==" title="https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf<i class="fa fa-external-link"></i></span><br>Readings:  Chapter 11.1-11.4</p><p>Database Tree Indexes 在CMU分成了两部分，在两节课中讲。这是第一部分。</p><p>这节课中，我们会学习数据库的中使用的B+树，它数据库最重要的数据结构。几十年来，数据库的形式和技术变化很大，但是始终坚持在使用B+树以及它的变形。</p><a id="more"></a><p><img data-src="/images/CMU1544564/Lec07/1.jpg" alt="1.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/3.jpg" alt="3.jpg"></p><ul><li>上图我们在前一篇文章<a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Data-Structure-in-DBMS">[CMU-15445] Lec06 Hash Tables - 哈希表 - Data Structure in DBMS</a>中已经讨论过。我们现在代入hash table和tree再看看这一页。</li><li>前三点中hash table可以被应用，同时效果不错。但是在<strong>table indexes</strong>中tree更好，以至于各个DBMS默认的table index都是tree。具体tree哪里好，我们会在这几节课中具体讨论。</li></ul><p><img data-src="/images/CMU1544564/Lec07/4.jpg" alt="4.jpg"></p><ul><li>从上图中:</li><li>index索引严格上说不是必须，它的是一个起到提速搜索的数据结构。如果没有它，那就linear sequential scan去找想要的tuple， $O(n)$</li><li>index索引其实将原表格内容存储在数据结构中，因此它也重复(replica)了一部分原表格的内容。如果我们对原表格进行更新(写操作)，那么也需要对index进行同样的操作，<strong>让原表格和index同步</strong>。</li></ul><p><img data-src="/images/CMU1544564/Lec07/5.jpg" alt="5.jpg"></p><ul><li>从上图中:</li><li>index的存在会带来:</li><li>Storage Overhead: index重复了一部分原表格内容，index这个数据结构要占一块存储。常常需要多个page，不能保证全部在内存上。</li><li>Maintenance Overhead: 如果我们对原表格进行更新(写操作)，那么也需要对index进行同样的操作，<strong>让原表格和index同步</strong>。</li></ul><p><img data-src="/images/CMU1544564/Lec07/6.jpg" alt="6.jpg"></p><h1 id="B-Tree-Family"><a href="#B-Tree-Family" class="headerlink" title="B-Tree Family"></a>B-Tree Family</h1><p><img data-src="/images/CMU1544564/Lec07/7.jpg" alt="7.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/8.jpg" alt="8.jpg"></p><ul><li>Efficient locking for concurrent operations on B-trees: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzMxOTYyOC4zMTk2NjM=" title="https://dl.acm.org/doi/10.1145/319628.319663">https://dl.acm.org/doi/10.1145/319628.319663<i class="fa fa-external-link"></i></span></li></ul><h1 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B+ Tree"></a>B+ Tree</h1><p><img data-src="/images/CMU1544564/Lec07/9.jpg" alt="9.jpg"></p><ul><li>Ubiquitous B-Tree: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzM1Njc3MC4zNTY3NzY=" title="https://dl.acm.org/doi/10.1145/356770.356776">https://dl.acm.org/doi/10.1145/356770.356776<i class="fa fa-external-link"></i></span></li></ul><p><img data-src="/images/CMU1544564/Lec07/10.jpg" alt="10.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/11.jpg" alt="11.jpg"></p><ul><li>从上图中:</li><li>leaf node: 指最下面一层的节点</li><li>inner node: 指非leaf node的节点</li><li>sibling pointer: 指拥有同一个父亲的leaf node</li></ul><p><img data-src="/images/CMU1544564/Lec07/12.jpg" alt="12.jpg"></p><ul><li>从上图中:</li><li>inner node: 由<code>node*</code>和<code>key</code>组成</li><li>leaf node: 由<code>value</code>和<code>key</code>组成</li></ul><h2 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h2><p><img data-src="/images/CMU1544564/Lec07/13.jpg" alt="13.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/15.jpg" alt="15.jpg"></p><ul><li>从上图中:</li><li><code>prev</code>和<code>next</code>是两个指针，指向sibling node</li></ul><p><img data-src="/images/CMU1544564/Lec07/16.jpg" alt="16.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/18.jpg" alt="18.jpg"></p><ul><li>从上图是实际实现中，B+ Tree的样子</li><li><code>sortd keys</code>排列在一块儿。因为scan的时候，只是检查<code>key</code>。另外<code>key</code>的数据类型大小一致,　<code>values</code>大小很可能不一致，如字符串。</li></ul><p><img data-src="/images/CMU1544564/Lec07/19.jpg" alt="19.jpg"></p><h2 id="B-Tree-vs-B-Tree"><a href="#B-Tree-vs-B-Tree" class="headerlink" title="B Tree vs. B+ Tree"></a>B Tree vs. B+ Tree</h2><p><img data-src="/images/CMU1544564/Lec07/20.jpg" alt="20.jpg"></p><ul><li>从上图中:</li><li>B Tree中是没有重复的，<code>key</code>被存储在inner node和leaf node之间</li><li>B+ Tree中是有重复的，<code>key</code>只被存储在leaf node中</li><li><code>key</code>的存储地点不止影响树的样子，更影响多线程更改树信息的性能。B+ Tree的<code>key</code>信息只在leaf node中，更改信息以后只需要向上走，因此只需要latch一个向上的方向。但是B Tree需要latch两个方向，即向上和向下。这个我们会在后两次课中仔细讨论。<!-- TODO:后两次课。 --><!-- TODO: B Tree 介绍 --></li></ul><h2 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h2><p><img data-src="/images/CMU1544564/Lec07/21.jpg" alt="21.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/22.jpg" alt="22.jpg"></p><ul><li>上图中的链接: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY3MudXNmY2EuZWR1L35nYWxsZXMvdmlzdWFsaXphdGlvbi9CUGx1c1RyZWUuaHRtbA==" title="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html<i class="fa fa-external-link"></i></span></li></ul><p>我们使用一下作为Demo:<br><code>insert 4; insert 2; insert 6; insert 1; insert 5;</code><br>得到如下的树:</p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec07/b+tree_insert.png" alt="B+Tree-Insert"></p><h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h2><p><img data-src="/images/CMU1544564/Lec07/23.jpg" alt="23.jpg"></p><ul><li>上图中的链接: <span class="exturl" data-url="aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMzQ2LzIwMTUvbm90ZXMvQmxpbmsucHB0eA==" title="https://web.stanford.edu/class/cs346/2015/notes/Blink.pptx">https://web.stanford.edu/class/cs346/2015/notes/Blink.pptx<i class="fa fa-external-link"></i></span></li></ul><p>我们再继续刚刚的Demo:</p><p><code>delete 5; delete 4;</code><br>得到如下的树:</p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec07/b+tree_delete.png" alt="B+Tree-Delete"></p><h2 id="B-Tree-In-Practice"><a href="#B-Tree-In-Practice" class="headerlink" title="B+ Tree In Practice"></a>B+ Tree In Practice</h2><p><img data-src="/images/CMU1544564/Lec07/24.jpg" alt="24.jpg"></p><ul><li>从上图中:</li><li>Fill-Factor是指<code>leaf node的个数 / 所有 node的个数</code>比值</li><li>实际上B+树不需要５层以上。</li></ul><h2 id="Clustered-Indexes"><a href="#Clustered-Indexes" class="headerlink" title="Clustered Indexes"></a>Clustered Indexes</h2><p><img data-src="/images/CMU1544564/Lec07/25.jpg" alt="25.jpg"></p><p>指页面在硬盘存储的顺序和索引中排序的顺序一致，即也被排序，而并非任意顺序。这种Clustered Indexes在对于range query很有帮助。range query的一个例子是要<code>primary key</code>在0到100的所有tuple。对这个例子，如果我们需要5个page。那这5个page在clustered index以后的硬盘上是连续的，一次sequential I/O就可以解决。如果不使用clustered indexes, 那就可能出现5次random I/O，对应的性能就很垃圾了。</p><!-- TODO:实验 --><h2 id="Selection-Conditions"><a href="#Selection-Conditions" class="headerlink" title="Selection Conditions"></a>Selection Conditions</h2><p>Selection Conditions是B+ tree的优势，指我们可以搜索index对应的search key的prefix前缀, suffix后缀, 或者其中的部分。</p><p>这是hash table无法做到的，它只能搜索完整了search key。</p><p><img data-src="/images/CMU1544564/Lec07/26.jpg" alt="26.jpg"></p><h3 id="前缀例子"><a href="#前缀例子" class="headerlink" title="前缀例子"></a>前缀例子</h3><p>通过前缀我们可以知道我们想要找的tuple出现在index中的区间，即从小于我们前缀的位置，扫描到大于我们前缀的位置。下面是两个前缀的例子:</p><p><img data-src="/images/CMU1544564/Lec07/27.jpg" alt="27.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/28.jpg" alt="28.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/29.jpg" alt="29.jpg"></p><h3 id="后缀例子"><a href="#后缀例子" class="headerlink" title="后缀例子"></a>后缀例子</h3><p>我们缺失一个前缀，那就将所有的可能都填入前缀。这样会产生好几个需要扫描的区间，这些区间的个数等于所有前缀可能的个数。如下图<code>*</code>可以是A, B, C　(例子中合并了后面两个区间到一起)：</p><p><img data-src="/images/CMU1544564/Lec07/30.jpg" alt="30.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/31.jpg" alt="31.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/32.jpg" alt="32.jpg"></p><p><br></p><h2 id="B-Tree-Design-Choices"><a href="#B-Tree-Design-Choices" class="headerlink" title="B+ Tree Design Choices"></a>B+ Tree Design Choices</h2><p><img data-src="/images/CMU1544564/Lec07/33.jpg" alt="33.jpg"></p><ul><li>上图中的链接: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xNTYxLzE5MDAwMDAwMjg=" title="https://dl.acm.org/doi/10.1561/1900000028">https://dl.acm.org/doi/10.1561/1900000028<i class="fa fa-external-link"></i></span></li><li>这部分都是实现的经验之谈</li></ul><h3 id="Node-size"><a href="#Node-size" class="headerlink" title="Node size"></a>Node size</h3><p><img data-src="/images/CMU1544564/Lec07/34.jpg" alt="34.jpg"></p><ul><li>如上图中:</li><li>Node可以是一个page，也可以是多个page</li><li>在速度慢的硬件上的node的容量建议会更大，这样可以减少I/O的次数</li><li>leaf node scan: 涉及数量很多的node, 是sequential I/O</li><li>root-to-leaf traversal: 涉及数量很少的node, 但是是random I/O, 因为这些page很大概率不存储在一起</li></ul><p><br></p><ul><li>另外index和原表格可以使用两个buffer pool:</li><li>index buffer page: 1 MiB</li><li>table data buffer page: 8 KiB</li></ul><h3 id="Merge-Threshold"><a href="#Merge-Threshold" class="headerlink" title="Merge Threshold"></a>Merge Threshold</h3><p><img data-src="/images/CMU1544564/Lec07/35.jpg" alt="35.jpg"></p><ul><li>如上图:</li><li>如果一个node中元素少于<code>M/2 - 1</code>，即没有half-full, 发生underflow。我们可以让这个node保存存在，而不去merge它。然后每一段时间，批量处理B+ tree中所有这类的node。</li></ul><h3 id="Variable-Length-Keys"><a href="#Variable-Length-Keys" class="headerlink" title="Variable Length Keys"></a>Variable Length Keys</h3><p><img data-src="/images/CMU1544564/Lec07/36.jpg" alt="36.jpg"></p><ul><li>如上图:</li><li>Approach 1: Pointers　太慢</li><li>Approach 2: Variable Length Nodes不适合fix size page</li><li>Approach 3: Padding 太浪费空间</li><li>Approach 4: Key Map / Indirection 性能较好</li></ul><h4 id="Key-Map-Indirection"><a href="#Key-Map-Indirection" class="headerlink" title="Key Map / Indirection"></a>Key Map / Indirection</h4><p>这个就和slotted page类似，将vaiable lenght key存在同一个page。</p><p><img data-src="/images/CMU1544564/Lec07/38.jpg" alt="38.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/39.jpg" alt="39.jpg"></p><ul><li>如上图:</li><li>可以在<code>sorted key map</code>这个区域存一个<strong>首字母</strong>，这样可以减少跳到<code>key+values</code>区域的次数。不必每一个<code>key</code>都去看它的全部内容。</li></ul><h3 id="Non-Unique-Indexes"><a href="#Non-Unique-Indexes" class="headerlink" title="Non-Unique Indexes"></a>Non-Unique Indexes</h3><p><img data-src="/images/CMU1544564/Lec07/40.jpg" alt="40.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/41.jpg" alt="41.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/42.jpg" alt="42.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/43.jpg" alt="43.jpg"></p><h3 id="Intra-Node-Search"><a href="#Intra-Node-Search" class="headerlink" title="Intra-Node Search"></a>Intra-Node Search</h3><p>Intra-Node Search指在node中搜索，可以想象成在page中那些已经排序完的数据中搜索：</p><h4 id="Linear"><a href="#Linear" class="headerlink" title="Linear"></a>Linear</h4><p><img data-src="/images/CMU1544564/Lec07/44.jpg" alt="44.jpg"></p><h4 id="Binary-Search"><a href="#Binary-Search" class="headerlink" title="Binary Search"></a>Binary Search</h4><p><img data-src="/images/CMU1544564/Lec07/46.jpg" alt="46.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/47.jpg" alt="47.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/48.jpg" alt="48.jpg"></p><h4 id="Interpolation"><a href="#Interpolation" class="headerlink" title="Interpolation"></a>Interpolation</h4><p>Interpolation指数字的分布如果已知，可以直接猜到想搜的<code>key</code>的位置。这个属于特例，而且不适用于字符串。</p><p><img data-src="/images/CMU1544564/Lec07/49.jpg" alt="49.jpg"></p><p><br><br><br></p><h2 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h2><p><img data-src="/images/CMU1544564/Lec07/50.jpg" alt="50.jpg"></p><h3 id="Prefix-Compression"><a href="#Prefix-Compression" class="headerlink" title="Prefix Compression"></a>Prefix Compression</h3><p>Prefix Compression即字符串共有的前缀只需要存储一次，能高效节省出存储的空间，同时也可以降低B+ Tree的高度，加快搜索速度。</p><p><img data-src="/images/CMU1544564/Lec07/51.jpg" alt="51.jpg"></p><h3 id="Suffix-Truncation"><a href="#Suffix-Truncation" class="headerlink" title="Suffix Truncation"></a>Suffix Truncation</h3><p>我们在最开始说过leaf node起到存储信息的作用，inner node起到lookup中导航的作用。对于字符串，inner node中没有必要保存全部，只需要保存足够的前缀，<strong>保证大于小于的关系和导航的作用</strong>。见下面的例子中，实际上<code>a</code>和<code>l</code>也已经足够:</p><p><img data-src="/images/CMU1544564/Lec07/52.jpg" alt="52.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/53.jpg" alt="53.jpg"></p><h3 id="Bulk-Insert"><a href="#Bulk-Insert" class="headerlink" title="Bulk Insert"></a>Bulk Insert</h3><p>一次次insert来获得一个B+ Tree很慢。Bulk Insert是将keys先排序，再完成leaf node, 再根据leaf node去完成inner node。Bulk Insert让我们能更快去获得一个B+ Tree:</p><p><img data-src="/images/CMU1544564/Lec07/54.jpg" alt="54.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/55.jpg" alt="55.jpg"></p><h3 id="Pointer-Swizzling"><a href="#Pointer-Swizzling" class="headerlink" title="Pointer Swizzling"></a>Pointer Swizzling</h3><p>我们每一次从B+ Tree中需要一个page，都需要调用buffer pool中的函数，用<code>pageid</code>获得对应page的指针。这种间接indirection，带来固定的开销。而我们可以节省这一部分，特别在B+ Tree的上面几层。因为每次查询都需要上面几层的page，它们属于hot page，即它们经常需要有被访问，每一次都找buffer pool显得花销更大了。我们完全可以把这些page一直留着内存里，然后在B+_Tree中直接带上它们内容的指针，这样访问它们不需要经过buffer pool。而这些hot page的数量不是很多，完全可以长久留着内存中。(见<a href="#b+-tree-in-practice">B+ Tree In Practice</a>中，两层node大概在134个page, 占1MiB。)</p><p><img data-src="/images/CMU1544564/Lec07/57.jpg" alt="57.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/58.jpg" alt="58.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/59.jpg" alt="59.jpg"></p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><img data-src="/images/CMU1544564/Lec07/60.jpg" alt="60.jpg"></p><p><img data-src="/images/CMU1544564/Lec07/61.jpg" alt="61.jpg"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Tree Indexes Part I - 树索引 I&lt;/p&gt;
&lt;p&gt;Slide: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA3LXRyZWVzMS5wZGY=&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Note: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDctdHJlZXMxLnBkZg==&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Readings:  Chapter 11.1-11.4&lt;/p&gt;
&lt;p&gt;Database Tree Indexes 在CMU分成了两部分，在两节课中讲。这是第一部分。&lt;/p&gt;
&lt;p&gt;这节课中，我们会学习数据库的中使用的B+树，它数据库最重要的数据结构。几十年来，数据库的形式和技术变化很大，但是始终坚持在使用B+树以及它的变形。&lt;/p&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Access Methods" scheme="https://cakebytheoceanluo.github.io/categories/Access-Methods/"/>
    
      <category term="B Tree" scheme="https://cakebytheoceanluo.github.io/categories/B-Tree/"/>
    
      <category term="Indexing" scheme="https://cakebytheoceanluo.github.io/categories/Indexing/"/>
    
    
      <category term="Indexing" scheme="https://cakebytheoceanluo.github.io/tags/Indexing/"/>
    
      <category term="B Tree" scheme="https://cakebytheoceanluo.github.io/tags/B-Tree/"/>
    
      <category term="Clustered Index" scheme="https://cakebytheoceanluo.github.io/tags/Clustered-Index/"/>
    
      <category term="Variable Length Key" scheme="https://cakebytheoceanluo.github.io/tags/Variable-Length-Key/"/>
    
      <category term="Prefix Compression" scheme="https://cakebytheoceanluo.github.io/tags/Prefix-Compression/"/>
    
      <category term="Suffix Truncation" scheme="https://cakebytheoceanluo.github.io/tags/Suffix-Truncation/"/>
    
      <category term="Bulk Load (Bulk Insert)" scheme="https://cakebytheoceanluo.github.io/tags/Bulk-Load-Bulk-Insert/"/>
    
      <category term="Pointer Swizzling" scheme="https://cakebytheoceanluo.github.io/tags/Pointer-Swizzling/"/>
    
  </entry>
  
  <entry>
    <title>[CMU-15445]Lec06 Hash Tables - 哈希表</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/</id>
    <published>2020-03-18T18:34:10.000Z</published>
    <updated>2020-03-19T19:51:14.994Z</updated>
    
    <content type="html"><![CDATA[<p>Hash Tables - 哈希表</p><p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA2LWhhc2h0YWJsZXMucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDYtaGFzaHRhYmxlcy5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf<i class="fa fa-external-link"></i></span><br>Readings: Chapter 11.6-11.7<!-- TODO:link here --></p><p>这节课中，我们会学习数据库的中使用的哈希表hash table，实际上我们涉及纯算法课中的理论，但更重要的是工程实现的角度。数据库中使用的hash table需要有高性能，多线程读写，内存访问友好。</p><a id="more"></a><p><img data-src="/images/CMU1544564/Lec06/1.jpg" alt="1.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/3.jpg" alt="3.jpg"></p><h1 id="Data-Structure-in-DBMS"><a href="#Data-Structure-in-DBMS" class="headerlink" title="Data Structure in DBMS"></a>Data Structure in DBMS</h1><p><img data-src="/images/CMU1544564/Lec06/4.jpg" alt="4.jpg"></p><ul><li>Internal Metadata: 用于管理数据库内部原数据的数据结构，如 page table, page directory</li><li>Core Data Storage: 存储tuple/表格的数据结构, 如：Memacache数据库用hash table,　MySQL使用B+树</li><li>Temporary Data Structures:对SQL Query暂时的数据结构，如一个使用hash join的SQL Query需要新建一个hash table,然后对它查询，这个hash table是暂时的，即Query结束就清除释放</li><li>Table Indexes: 辅助型索引数据结构, 使得查询更快，不需遍历所有tuple</li></ul><p><img data-src="/images/CMU1544564/Lec06/5.jpg" alt="5.jpg"></p><h1 id="Hash-Table-Overview"><a href="#Hash-Table-Overview" class="headerlink" title="Hash Table Overview"></a>Hash Table Overview</h1><p><img data-src="/images/CMU1544564/Lec06/6.jpg" alt="6.jpg"></p><ul><li>上图中：</li><li>空间复杂度是$O(n)$, hash table并不是一个能节省存储空间的数据结构。</li><li>查询时间复杂度:<ul><li>average case: $O(1)$. 从算法理论上，它的复杂度是一个常数。但在工业中，一个常数也有<strong>大小</strong>之分。比如<strong>小的常数时间复杂度</strong>代表CPU指令数较少，而<strong>大的常数时间复杂度</strong>代表CPU指令数较多，即使它们对应的CPU指令数都是常数，但是运行时间还是有区别。</li><li>worst case: $O(n)$。比如hash function效果很不平均，将所有指hash到了一个位置，反而形成了一个list。这种不平均的hash function比如是：　$f(x) = 1$, 即常数函数。</li></ul></li></ul><p><img data-src="/images/CMU1544564/Lec06/7.jpg" alt="7.jpg"></p><ul><li>上图中：</li><li>f(abc)=0, f(def)=2, f(xyz)=n</li></ul><p><img data-src="/images/CMU1544564/Lec06/8.jpg" alt="8.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/9.jpg" alt="9.jpg"></p><ul><li>上图中的一些假设来自于算法中理论部分，但是实际上：</li><li>没有冲突collision的perfect hash function在大数据前提下是不存在的。hash collision是一定发生的。</li></ul><p><img data-src="/images/CMU1544564/Lec06/10.jpg" alt="10.jpg"></p><ul><li>从上图中, hash table分成两个独立的部分，它们互相不依赖：</li><li>hash function: 即我们之前提到的$f$函数, $f (\mathrm{key}) \rightarrow \mathrm{int} \in D$, $D$是一个int的集合。我们希望这个hash function很快，并且冲突概率很低：<ul><li>我们签名提到的$f(x) = 1$常数函数很快，但是它把任何一个key都匹配到1这个位置，即它的冲突概率是100%,这个非常不好，使我们的hash table变成了list,查询的时间复杂度变成了$O(n)$的average case</li></ul></li><li>hash scheme:　即如何去处理一定会发生的冲突。</li></ul><p><img data-src="/images/CMU1544564/Lec06/11.jpg" alt="11.jpg"></p><p><br></p><h1 id="Hash-Function"><a href="#Hash-Function" class="headerlink" title="Hash Function"></a>Hash Function</h1><p><img data-src="/images/CMU1544564/Lec06/12.jpg" alt="12.jpg"></p><ul><li>上图中:</li><li>我们不考虑密码学cryptographic的hash function,　因为我们只是在数据库内部使用hash table，来<a href="#data-structure-in-dbms">加速处理数据库的元数据, 存储, join, 索引</a>。而不是用来加密解密信息。<strong>数据库希望hash function很快，并且冲突概率很低。</strong></li></ul><p><img data-src="/images/CMU1544564/Lec06/13.jpg" alt="13.jpg"></p><ul><li>CRC-64: <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGUuc3RlcGhhbi1icnVtbWUuY29tL2NyYzMyLw==" title="https://create.stephan-brumme.com/crc32/">https://create.stephan-brumme.com/crc32/<i class="fa fa-external-link"></i></span></li><li>MurmurHash: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FhcHBsZWJ5L3NtaGFzaGVy" title="https://github.com/aappleby/smhasher">https://github.com/aappleby/smhasher<i class="fa fa-external-link"></i></span></li><li>Google CityHash: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9jaXR5aGFzaA==" title="https://github.com/google/cityhash">https://github.com/google/cityhash<i class="fa fa-external-link"></i></span></li><li>Facebook XXHash: <span class="exturl" data-url="aHR0cHM6Ly9jeWFuNDk3My5naXRodWIuaW8veHhIYXNoLw==" title="https://cyan4973.github.io/xxHash/">https://cyan4973.github.io/xxHash/<i class="fa fa-external-link"></i></span></li><li>Google FarmHash: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9mYXJtaGFzaA==" title="https://github.com/google/farmhash">https://github.com/google/farmhash<i class="fa fa-external-link"></i></span></li></ul><!-- TODO --><p><img data-src="/images/CMU1544564/Lec06/14.jpg" alt="14.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/15.jpg" alt="15.jpg"></p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FwYXZsby9oYXNoLWZ1bmN0aW9uLWJlbmNobWFyaw==" title="https://github.com/apavlo/hash-function-benchmark">https://github.com/apavlo/hash-function-benchmark<i class="fa fa-external-link"></i></span></li></ul><p><br></p><p>另外还有一种Fibonacci Hashing, 推荐阅读: <span class="exturl" data-url="aHR0cHM6Ly9wcm9iYWJseWRhbmNlLmNvbS8yMDE4LzA2LzE2L2ZpYm9uYWNjaS1oYXNoaW5nLXRoZS1vcHRpbWl6YXRpb24tdGhhdC10aGUtd29ybGQtZm9yZ290LW9yLWEtYmV0dGVyLWFsdGVybmF0aXZlLXRvLWludGVnZXItbW9kdWxvLw==" title="https://probablydance.com/2018/06/16/fibonacci-hashing-the-optimization-that-the-world-forgot-or-a-better-alternative-to-integer-modulo/">https://probablydance.com/2018/06/16/fibonacci-hashing-the-optimization-that-the-world-forgot-or-a-better-alternative-to-integer-modulo/<i class="fa fa-external-link"></i></span></p><p><br></p><h1 id="Static-Hashing-Schemes"><a href="#Static-Hashing-Schemes" class="headerlink" title="Static Hashing Schemes"></a>Static Hashing Schemes</h1><p>Static Hashing Schemes正如staic所说，这种scheme下的hash table的容量是固定的。如果我们需要在hash的同时，发现容量不够，只能resize到更大的容量，这是我们需要将所有的key再重新hash进扩大容量的hash table。这种resize在static hashing scheme意味者rehashing，这个操作对性能来说是灾难级别的。很显然如果我们能一开始就知道<strong>合适的容量</strong>,　就能直接避免这部分的浪费时间。如何寻找合适的容量，我们可以进行cardinality estimation基数估计。这个部分后面会提到。<!-- TODO: --></p><blockquote><p>A static hashing scheme is one where the size of the hash table is fixed. This means that if the DBMS runs out of storage space in the hash table, then it has to rebuild it from scratch with a larger table. Typically the new hash table is twice the size of the original hash table.</p></blockquote><p><img data-src="/images/CMU1544564/Lec06/16.jpg" alt="16.jpg"></p><h2 id="Linear-Probe-Hashing"><a href="#Linear-Probe-Hashing" class="headerlink" title="Linear Probe Hashing"></a>Linear Probe Hashing</h2><p>Linear Probe Hashing是open address hashing的一种。</p><p>Linear Probing方式虽然简单，但并不是解决冲突的最好的策略，因为它会导致<strong>同类哈希的聚集(Primary Clustering)</strong>。这导致搜索哈希表时，冲突依然存在。如果我们要访问 Edward 的信息，因为 Edward 的社保号 111-00-1235 哈希为 1235，然而我们在 1235 位置找到的是 Bob，所以再搜索 1236，找到的却是 Danny，以此类推直到找到 Edward。<sup><a href="#fn2">2</a></sup></p><p><img data-src="/images/CMU1544564/Lec06/17.jpg" alt="17.jpg"></p><blockquote><ul><li>To see if value is present, go to slot using hash, and scan for the key. The scan stops if you find the desired key or you encounter an empty slot.</li></ul></blockquote><h3 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h3><p>hash table存储不仅仅是<code>value</code>，而是<code>(key, value)</code>这一对。这是因为Linear Probe Hashing会遇到冲突，在查询时需要比较key来确定是否找到(key相等)或者只是一次冲突(key不相等)。</p><p><img data-src="/images/CMU1544564/Lec06/18.jpg" alt="18.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/19.jpg" alt="19.jpg"></p><p>下图中C和A的hash位置相同(冲突), 我们将C写在A的后面，并A连接C：<br><img data-src="/images/CMU1544564/Lec06/20.jpg" alt="20.jpg"></p><p>下图中D和C的hash位置相同(冲突), 我们将D写在C的后面，并C连接D：<br><img data-src="/images/CMU1544564/Lec06/21.jpg" alt="21.jpg"></p><p>下图中E和A/C的hash位置相同(冲突), 我们将E写在C的后面，<strong>但是C后面被D占有了</strong>，所有将E写在D后面,并D连接E：<br><img data-src="/images/CMU1544564/Lec06/22.jpg" alt="22.jpg"></p><p>下图中F和E的hash位置相同(冲突), 我们将F写在E的后面，并E连接F：<br><img data-src="/images/CMU1544564/Lec06/23.jpg" alt="23.jpg"></p><h3 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h3><h4 id="Delete-C"><a href="#Delete-C" class="headerlink" title="Delete C"></a>Delete C</h4><p>下图中我们想删除C, 我们已经见到C和A冲突。我们看第一个位置是key是A, 而A!=C, 然后往下看：<br><img data-src="/images/CMU1544564/Lec06/24.jpg" alt="24.jpg"></p><p>下图中，我们发现在第二个位置, hash table条目中的key是C，而我们就像删去C, C==C。这个条目被删除：<br><img data-src="/images/CMU1544564/Lec06/25.jpg" alt="25.jpg"></p><h4 id="Find-D-after-deletion-of-C"><a href="#Find-D-after-deletion-of-C" class="headerlink" title="Find D after deletion of C"></a>Find D after deletion of C</h4><p>下图中，我们想寻找D。由于之前D和C的hash位置相同(冲突)，而C已经被删除，D失去了和C的联系。导致我们不能找到D：<br><img data-src="/images/CMU1544564/Lec06/26.jpg" alt="26.jpg"></p><h5 id="Approach1-Tombstone"><a href="#Approach1-Tombstone" class="headerlink" title="Approach1: Tombstone"></a>Approach1: Tombstone</h5><p>解决上述问题的第一种方法是使用一个<em>墓碑</em>:　在上面的例子中，我们删除了C，但是留下了一个C的墓碑，墓碑依然保留着到D的联系链接。通过这个墓碑的链接我们可以找到D:<br><img data-src="/images/CMU1544564/Lec06/27.jpg" alt="27.jpg"></p><p>这种作法的缺点是：保存墓碑会占有空间。</p><h5 id="Approach2-Movement"><a href="#Approach2-Movement" class="headerlink" title="Approach2: Movement"></a>Approach2: Movement</h5><p>解决上述问题的第二种方法是<em>移动</em>：即删除一个条目之后，对hash table中和已被删除条目有联系的条目进行移动，移动至正确的地方。</p><p>下面的例子中，只能移动和已被删除<strong>有联系的条目</strong> (B和F并不曾碰撞冲突，但是B在如下例子不应该被移动):</p><p><img data-src="/images/CMU1544564/Lec06/28.jpg" alt="28.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/29.jpg" alt="29.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/30.jpg" alt="30.jpg"></p><p>下图中检查B是否和被删除的条目C存在联系，发现B就在它自己应该在的地方，而和其他条目无任何联系，因次不移动B。<strong>无视那个从上到下的箭头</strong>:<br><img data-src="/images/CMU1544564/Lec06/31.jpg" alt="31.jpg"></p><p>这种作法的缺点是:删除会变得非常麻烦。</p><p><br></p><p>这里提一下，在hash join中，我们只用insert和find这两个函数，而不用delete。对于hash join这中操作可以无视删除会导致的缺点。</p><p>但是在index索引中，insert, find, delete这些操作都被需要。</p><h3 id="Non-Unique-Keys"><a href="#Non-Unique-Keys" class="headerlink" title="Non-Unique Keys"></a>Non-Unique Keys</h3><p>有两种处理<strong>重复key</strong>的方式:</p><ul><li>value list存储重复key所拥有的value</li><li>存储key和value，这样即使key重复,value值也不一样。<strong>这种方式更加常见。</strong><br><img data-src="/images/CMU1544564/Lec06/32.jpg" alt="32.jpg"></li></ul><p><br></p><h2 id="Robin-Hood-Hashing"><a href="#Robin-Hood-Hashing" class="headerlink" title="Robin Hood Hashing"></a>Robin Hood Hashing</h2><p>Robin Hood Hashing和Linear Probe Hashing相比，更可以去平衡冲突，让冲突的key离它应该拥有的位置(optimal position)近一些。正如它的名字一样，罗宾汉，劫富济贫，解决badcase。</p><p><img data-src="/images/CMU1544564/Lec06/33.jpg" alt="33.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/34.jpg" alt="34.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/35.jpg" alt="35.jpg"></p><p>下图中, C与A冲突于红色箭头所指的位置。</p><ul><li>这时A离它的optimal postion距离为0, C离它的optimal postion距离为0。两值相等，C不能获得A的位置。</li><li>C获得A后面空的位置，C离它的optimal postion距离为1：<br><img data-src="/images/CMU1544564/Lec06/36.jpg" alt="36.jpg"></li></ul><p><br></p><p>下图中, D与C冲突于红色箭头所指的位置。</p><ul><li>这时C离它的optimal postion距离为1, D离它的optimal postion距离为0。D的距离值小于C的距离值，D不能获得C的位置。</li><li>D获得C后面空的位置，D离它的optimal postion距离为1：<br><img data-src="/images/CMU1544564/Lec06/37.jpg" alt="37.jpg"></li></ul><p><br></p><p><strong>下两张图中</strong>, E与A冲突于红色箭头所指的位置。</p><ul><li>这时A离它的optimal postion距离为0, E离它的optimal postion距离为0。两值相等，E不能获得A的位置。</li><li>E获得A后面空的位置，然后E与C冲突。</li><li>这时C离它的optimal postion距离为1, E离它的optimal postion距离为1。两值相等，E不能获得C的位置。</li><li>E获得C后面空的位置，然后E与D冲突。这时D离它的optimal postion距离为1, E离它的optimal postion距离为2。<strong>E的距离值大于D的距离值，E获得D的位置。</strong></li><li>D只能向后移动，同时也更新自己离自己optimal position的距离:<br><img data-src="/images/CMU1544564/Lec06/38.jpg" alt="38.jpg"></li></ul><p><img data-src="/images/CMU1544564/Lec06/39.jpg" alt="39.jpg"></p><p><br></p><p>下图中, F与D冲突于红色箭头所指的位置。</p><ul><li>这时D离它的optimal postion距离为2, F离它的optimal postion距离为1。F的距离值小于D的距离值，F不能获得D的位置。</li><li>F获得D后面空的位置，F离它的optimal postion距离为1：<br><img data-src="/images/CMU1544564/Lec06/40.jpg" alt="40.jpg"></li></ul><p><br></p><p>我们比较一下结果：</p><ul><li>Linear Probe Hashing: D在E的上面。D离自己optimal position距离为1,E离自己optimal position距离为3。</li><li>Robin Hood Hashing:　E在D的上面。D离自己optimal position距离为2,E离自己optimal position距离为2。</li></ul><p>Robin Hood Hashing平均了一下各个key离自己optimal position的距离。但是它在insert的时候，有可能会调整其他条目的位置, 在我们的例子中，在insert E的时候调整了D的位置。说明它会需要更多write operation的次数，另外在insert的时候它也有更多条件需要检查，这会造成更多的branch miss prediction。</p><p>实际实现上Linear Probe Hashing更为常见。</p><p><br></p><h2 id="Cuckoo-Hashing"><a href="#Cuckoo-Hashing" class="headerlink" title="Cuckoo Hashing"></a>Cuckoo Hashing</h2><p>Cuckoo Hashing使用多个hash table, 每个hash table拥有自己的hash function (hash function seed)。我们下面的例子是用两个表，当然也可以用三个来实现Cuckoo Hashing。</p><blockquote><p>The hash functions are the same algorithm (e.g., XXHash, CityHash); they generate different hashes for the same key by using different seed values.</p></blockquote><p>insert: </p><ul><li>总向有空位置(optimal position)的hash table插入。如果多个hash table都有空位置可以插入，随意选择其中的一个即可。</li><li>如果所有的hash table都没有空位置可以插入。随机选择一个hash table中对应的位置插入,　并取出原来在这位置上的key, 将它insert到其他的hash table。</li></ul><p>优点是查询快，路径短，最多两次就能查询到。</p><p>缺点是插入性能差，在容量小的情况下很容易冲突。连锁的冲突会陷入死循环, 解决只能增加容量并且rehash。</p><p><img data-src="/images/CMU1544564/Lec06/41.jpg" alt="41.jpg"></p><p>下图中，A对应的位置都是空的，A可以被插入至任何一个hash table，例子中选择了#1:<br><img data-src="/images/CMU1544564/Lec06/42.jpg" alt="42.jpg"></p><p><br></p><p>下图中，B对应的位置只有在#2是空的，那么插入至#2:<br><img data-src="/images/CMU1544564/Lec06/43.jpg" alt="43.jpg"></p><p><br></p><p>下面几张图中，</p><ul><li>C对应的位置<strong>都不是空的</strong>，C可以选择任何一个hash table，代替占有位置的key，例子中选择了#2, 即代替了B</li><li>B被rehash到#1，在#1中B对应的位置也不是空的，B代替占有位置的key A</li><li>A被rehash到#2, 在#2中对应的位置是空的：<br><img data-src="/images/CMU1544564/Lec06/44.jpg" alt="44.jpg"></li></ul><p><img data-src="/images/CMU1544564/Lec06/45.jpg" alt="45.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/46.jpg" alt="46.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/47.jpg" alt="47.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/48.jpg" alt="48.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/49.jpg" alt="49.jpg"></p><p><br></p><p>在Cuckoo Hashing中<strong>有可能不终止</strong>，即进入一个死循环，永远找不到能插入的地方。这时候说明hash table容量太小，需要<code>resize</code>到更大的容量。</p><blockquote><p> If we find a cycle, then we can rebuild all of the hash tables with new hash function seeds (less common) or rebuild the hash tables using larger tables (more common).</p></blockquote><h1 id="Dynamic-Hashing-Schemes"><a href="#Dynamic-Hashing-Schemes" class="headerlink" title="Dynamic Hashing Schemes"></a>Dynamic Hashing Schemes</h1><p>Dynamic Hashing Schemes的特征就是在能持续容量增长，而不需要额外rehash。即resize的操作花销不大。</p><p><img data-src="/images/CMU1544564/Lec06/50.jpg" alt="50.jpg"></p><h2 id="Chained-Hashing"><a href="#Chained-Hashing" class="headerlink" title="Chained Hashing"></a>Chained Hashing</h2><p>Chained Hashing又称Hashing with Chaining。特征是每一个hash table中的条目都是一个linked list of bucket。如果bucket满了，那就再指向一个新的bucket。</p><p><strong>这里的bucket可以具象成一个page。</strong></p><p>优点是实现简单，不需要resize。</p><p>缺点是每一个linked list如果很长, 就变成$O(n)$。</p><p><img data-src="/images/CMU1544564/Lec06/51.jpg" alt="51.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/52.jpg" alt="52.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/53.jpg" alt="53.jpg"></p><h2 id="Extendible-Hashing"><a href="#Extendible-Hashing" class="headerlink" title="Extendible Hashing"></a>Extendible Hashing</h2><ul><li>global <code>n bit</code>: 指key中前n个bit是对左侧directory有效。</li><li>local <code>m bit</code>: 指global中<code>n bit</code>中的前<code>m</code>个bit<strong>在这一个bucket</strong>有效。</li><li>$n \geq m$恒成立</li><li>如果local bucket满了(overflow)，那就增加一个local bit去容纳更多。如果$n=m$，那就先增加一个global bit，再增加local bit。使$n \geq m$条件依然成立</li></ul><p><img data-src="/images/CMU1544564/Lec06/54.jpg" alt="54.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/55.jpg" alt="55.jpg"></p><h3 id="Find-A"><a href="#Find-A" class="headerlink" title="Find A"></a>Find A</h3><p><img data-src="/images/CMU1544564/Lec06/56.jpg" alt="56.jpg"></p><h3 id="Insert-B-No-Overflow"><a href="#Insert-B-No-Overflow" class="headerlink" title="Insert B - No Overflow"></a>Insert B - No Overflow</h3><p><img data-src="/images/CMU1544564/Lec06/57.jpg" alt="57.jpg"></p><h3 id="Insert-C-Overflow"><a href="#Insert-C-Overflow" class="headerlink" title="Insert C - Overflow"></a>Insert C - Overflow</h3><p>C对应的local bucket已经满了，另外local bit = global bit = 2</p><p>我们正如前面介绍的，先增加global bit到3, 再将local bit增加到3, 最后insert C。</p><p><img data-src="/images/CMU1544564/Lec06/58.jpg" alt="58.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/59.jpg" alt="59.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/60.jpg" alt="60.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/61.jpg" alt="61.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/62.jpg" alt="62.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/63.jpg" alt="63.jpg"></p><p>这里有一个上课问题引发的讨论。结果是extendible hash table的<code>resize</code>操作是很简单廉价的。左侧的directory是一个array of pointer或者array of page id。用latch保护这个array,　然后扩大它的容量，复制原来的内容进入以后，就可以解开latch了。这个过程不涉及rehash和大量的数据复制，因此很快速。</p><!-- TODO: TUM GDB 题目 --><h2 id="Linear-Hashing"><a href="#Linear-Hashing" class="headerlink" title="Linear Hashing"></a>Linear Hashing</h2><p>Linear Hashing的目的是不在<code>resize</code>的时候用一个global latch，来提高性能。我们可以从下面例子中看出，在Linear Hashing中只需要去latch一个位置, 即<code>split pointer</code>所指的地方。</p><p>作法是按照<em>顺序</em>去分裂bucket，而不是分裂特定满的bucket。顺序实际上只是bucket id顺序，有一个<code>split pointer</code>去跟踪下一个需要分裂的bucket。而且Linear Hashing使用多个hash function。</p><blockquote><p>Instead of immediately splitting a bucket when it overflows, this scheme maintains a split pointer that keeps track of the next bucket to split. No matter whether this pointer is pointing to the bucket that overflowed, the DBMS always splits. The overflow criterion is left up to the implementation</p></blockquote><p>具体描述和和Java实现，见一篇别人的博客: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYmYyNDAwNzg2ZjY=" title="https://www.jianshu.com/p/0bf2400786f6">https://www.jianshu.com/p/0bf2400786f6<i class="fa fa-external-link"></i></span></p><p><img data-src="/images/CMU1544564/Lec06/64.jpg" alt="64.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/65.jpg" alt="65.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/66.jpg" alt="66.jpg"></p><h3 id="Find-6"><a href="#Find-6" class="headerlink" title="Find 6"></a>Find 6</h3><p><img data-src="/images/CMU1544564/Lec06/67.jpg" alt="67.jpg"></p><p><br></p><h3 id="Insert-17-Overflow"><a href="#Insert-17-Overflow" class="headerlink" title="Insert 17 - Overflow"></a>Insert 17 - Overflow</h3><ul><li>Overflow的bucket后面会生成一个新的bucket。</li><li><code>split pointer</code>所指的bucket会进行分裂，分裂成两个bucket，原内容重新用新的hash function，再分配原内容到新旧两个bucket。下面例子中:<ul><li>$\mathrm{hash_2}(8) = 8 \% 8 = 0 \; \rightarrow \mathrm{bucket_0}$</li><li>$\mathrm{hash_2}(20) = 20 \% 8 = 4 \; \rightarrow \mathrm{bucket_4}$</li></ul></li><li>分裂完以后，<code>split pointer</code>指向下一个bucket(bucket id)。</li></ul><p><img data-src="/images/CMU1544564/Lec06/68.jpg" alt="68.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/69.jpg" alt="69.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/70.jpg" alt="70.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/71.jpg" alt="71.jpg"></p><p><br></p><h3 id="Find-20"><a href="#Find-20" class="headerlink" title="Find 20"></a>Find 20</h3><ul><li>先应用$\mathrm{hash_1}$</li><li>$\mathrm{hash_1}$的结果是0, 0这个位置<strong>高于</strong><code>split pointer</code>, 说明0这个位置已经分裂过了。需要再应用$\mathrm{hash_2}$</li></ul><p><img data-src="/images/CMU1544564/Lec06/72.jpg" alt="72.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/73.jpg" alt="73.jpg"></p><p><br></p><h3 id="Find-9"><a href="#Find-9" class="headerlink" title="Find 9"></a>Find 9</h3><ul><li>先应用$\mathrm{hash_1}$</li><li>$\mathrm{hash_1}$的结果是1, 1这个位置<strong>没有高于</strong><code>split pointer</code>, 说明1这个位置没有分裂过了。不需要再应用$\mathrm{hash_2}$</li></ul><p><img data-src="/images/CMU1544564/Lec06/74.jpg" alt="74.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/75.jpg" alt="75.jpg"></p><p><br></p><h3 id="Delete-20"><a href="#Delete-20" class="headerlink" title="Delete 20"></a>Delete 20</h3><p>这个例子中，分裂出的bucket因为删除的原因变成了空bucket。这时候可以回收这个bucket，同时是逆操作之前的分裂步骤，需要将<code>split pointer</code>向上移动。</p><p><img data-src="/images/CMU1544564/Lec06/76.jpg" alt="76.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/77.jpg" alt="77.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/78.jpg" alt="78.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/79.jpg" alt="79.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/80.jpg" alt="80.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/81.jpg" alt="81.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/82.jpg" alt="82.jpg"></p><h3 id="Insert-21"><a href="#Insert-21" class="headerlink" title="Insert 21"></a>Insert 21</h3><p>这里也视作一个overflow。</p><p><img data-src="/images/CMU1544564/Lec06/83.jpg" alt="83.jpg"></p><p><br></p><p>当<code>split point</code>指向4的时候，即分裂完一轮了，当前 # bucket=8。把<code>split point</code>重置成0，<strong>开始下一轮</strong>，每轮的bucket数翻倍，所以hash函数中的取余的数也要翻倍。这样就实现了动态扩展。<sup><a href="#fn1">1</a></sup></p><blockquote><p>When pointer reaches last slot, delete original hash function and replace it with new hash function.</p></blockquote><p><br></p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><img data-src="/images/CMU1544564/Lec06/84.jpg" alt="84.jpg"></p><p><img data-src="/images/CMU1544564/Lec06/85.jpg" alt="85.jpg"></p><p>引用:</p><p><a name="fn1">1</a>: CMU Database Systems - Indexes - fxjwind: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9wLzEwODM0ODQ0Lmh0bWw=" title="https://www.cnblogs.com/fxjwind/p/10834844.html">https://www.cnblogs.com/fxjwind/p/10834844.html<i class="fa fa-external-link"></i></span></p><p><a name="fn1">2</a>: CMU 15445 5. hash 表 - 西部小笼包: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYmYyNDAwNzg2ZjY=" title="https://www.jianshu.com/p/0bf2400786f6">https://www.jianshu.com/p/0bf2400786f6<i class="fa fa-external-link"></i></span></p><p>推荐阅读:</p><p>Lec 13 Cuckoo Hashing - CS166 Stanford: <span class="exturl" data-url="aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMTY2L2xlY3R1cmVzLzEzL1NtYWxsMTMucGRm" title="https://web.stanford.edu/class/cs166/lectures/13/Small13.pdf">https://web.stanford.edu/class/cs166/lectures/13/Small13.pdf<i class="fa fa-external-link"></i></span></p><p>Extendible Hashing Example: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY29zYy5icm9ja3UuY2EvfmVmb3h3ZWxsLzJQMDMvc2xpZGVzL1dlZWsxMlNsaWRlcy5wZGY=" title="https://www.cosc.brocku.ca/~efoxwell/2P03/slides/Week12Slides.pdf">https://www.cosc.brocku.ca/~efoxwell/2P03/slides/Week12Slides.pdf<i class="fa fa-external-link"></i></span></p><p>LINEAR HASHING - QuePer: <span class="exturl" data-url="aHR0cDovL3F1ZXBlci5pbi9kcnVwYWwvYmxvZ3MvZGJzeXMvbGluZWFyX2hhc2hpbmc=" title="http://queper.in/drupal/blogs/dbsys/linear_hashing">http://queper.in/drupal/blogs/dbsys/linear_hashing<i class="fa fa-external-link"></i></span></p><!-- TODO: --><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Hash Tables - 哈希表&lt;/p&gt;
&lt;p&gt;Slide: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA2LWhhc2h0YWJsZXMucGRm&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Note: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDYtaGFzaHRhYmxlcy5wZGY=&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Readings: Chapter 11.6-11.7&lt;!-- TODO:link here --&gt;&lt;/p&gt;
&lt;p&gt;这节课中，我们会学习数据库的中使用的哈希表hash table，实际上我们涉及纯算法课中的理论，但更重要的是工程实现的角度。数据库中使用的hash table需要有高性能，多线程读写，内存访问友好。&lt;/p&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Access Methods" scheme="https://cakebytheoceanluo.github.io/categories/Access-Methods/"/>
    
      <category term="Hash Table" scheme="https://cakebytheoceanluo.github.io/categories/Hash-Table/"/>
    
      <category term="Indexing" scheme="https://cakebytheoceanluo.github.io/categories/Indexing/"/>
    
    
      <category term="Indexing" scheme="https://cakebytheoceanluo.github.io/tags/Indexing/"/>
    
      <category term="Hash Function" scheme="https://cakebytheoceanluo.github.io/tags/Hash-Function/"/>
    
      <category term="Hash Scheme" scheme="https://cakebytheoceanluo.github.io/tags/Hash-Scheme/"/>
    
      <category term="Static Hashing Scheme" scheme="https://cakebytheoceanluo.github.io/tags/Static-Hashing-Scheme/"/>
    
      <category term="Linear Probe Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Linear-Probe-Hashing/"/>
    
      <category term="Robin Hood Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Robin-Hood-Hashing/"/>
    
      <category term="Cuckoo Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Cuckoo-Hashing/"/>
    
      <category term="Dynamic Hashing Scheme" scheme="https://cakebytheoceanluo.github.io/tags/Dynamic-Hashing-Scheme/"/>
    
      <category term="Chained Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Chained-Hashing/"/>
    
      <category term="Extendible Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Extendible-Hashing/"/>
    
      <category term="Linear Hashing" scheme="https://cakebytheoceanluo.github.io/tags/Linear-Hashing/"/>
    
  </entry>
  
  <entry>
    <title>[CMU-15445]Lec05 Buffer Pools - 数据库缓存区</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/</id>
    <published>2020-03-17T18:50:19.000Z</published>
    <updated>2020-03-22T20:02:06.031Z</updated>
    
    <content type="html"><![CDATA[<p>Buffer Pools - 数据库缓存区</p><p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA1LWJ1ZmZlcnBvb2wucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDUtYnVmZmVycG9vbC5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf<i class="fa fa-external-link"></i></span><br>Readings: Chapter 10.5-10.8</p><p>这节两课，我们会学习数据库的缓存区管理，这部分基于前面两节课(Storage I和Storage II)。</p><p>缓存区buffer pool就是在内存中对page的缓存(cache)。</p><a id="more"></a><p><img data-src="/images/CMU1544564/Lec05/1.jpg" alt="1.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/6.jpg" alt="6.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/7.jpg" alt="7.jpg"><br>上图中</p><ul><li>spatial control 空间控制: 物理(physically)上我们需要把有互相依赖的page写在硬盘中很近的位置。在我们使用这些page的时候，可以很快完成硬盘的寻址，sequantial I/O获得这些page。</li><li>temporal contral 时间控制: 我们需要最大化每一个page的左右，最小化花在I/O操作上的时间。</li></ul><p><br></p><p><img data-src="/images/CMU1544564/Lec05/8.jpg" alt="8.jpg"></p><ul><li>上图我们已经在<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/#Demo">Lec03 - System Design Goals (in Disk-oriented databases) - Demo</a>见过</li></ul><p><br></p><p><img data-src="/images/CMU1544564/Lec05/9.jpg" alt="9.jpg"></p><h1 id="Buffer-Pool-Manager"><a href="#Buffer-Pool-Manager" class="headerlink" title="Buffer Pool Manager"></a>Buffer Pool Manager</h1><h2 id="Buffer-Pool-Organization-Demo"><a href="#Buffer-Pool-Organization-Demo" class="headerlink" title="Buffer Pool Organization - Demo"></a>Buffer Pool Organization - Demo</h2><p>和操作系统中的概念一样，我们将硬盘上的block成为page, 将内存(buffer pool)中的block称为frame，frame可以容纳page。</p><p><code>pin(int pageid)</code>这个函数就代表了之前的<code>get page</code>这个操作。这个函数之后我们可以获得一个指向这个page数据的指针。我们使用完这个page之后，需要<code>unpin(int pageid)</code>。</p><p>在下面3张图中：</p><ul><li>一开始buffer pool是空的</li><li>然后我们<code>pin(pageid 1)</code>, page1被加载进入buffer pool</li><li>然后我们<code>pin(pageid 3)</code>, page3被加载进入buffer pool</li><li>我们会在后面看到一个page table，他负责告诉我们page和frame的对应，例如：page1在frame1, page3在frame2</li></ul><p><img data-src="/images/CMU1544564/Lec05/10.jpg" alt="10.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/11.jpg" alt="11.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/12.jpg" alt="12.jpg"></p><p><br></p><h2 id="Buffer-Pool-Metadata-Demo"><a href="#Buffer-Pool-Metadata-Demo" class="headerlink" title="Buffer Pool Metadata - Demo"></a>Buffer Pool Metadata - Demo</h2><p>这个Demo基于上一个Demo。 我们在这里讨论缓存区的metadata, 它们是管理区的管理信息。</p><ul><li>page table (也和操作系统中概念类似，只是不需要MMU, TLB)是一个in-memory hashtable, 负责 <code>page id -&gt; frame id</code>的映射，例如：page1在frame1, page3在frame2。</li><li>dirty flage: 告诉我们一个buffer pool中的frame是否被改写。如果被改写，即page上出现新数据，需要被写回至硬盘。</li><li>pin / reference counter: 对一个page当前使用的thread数进行计数。我们只允许将此数字为0的page写回硬盘，即当前没有任何thread在使用此page。</li></ul><p>这个Demo中很生动地表达了，如何在多线程的情况下，向buffer pool中加载一个新的page:</p><ul><li>首先我们<code>pin(pageid 2)</code>，但是我们在page table中找不到对应，这时是一个page fault, 说明我们需要从硬盘中加载这个page2</li><li>这时我们给page table上一个global latch，确保我们在整个过程中，没有其他线程会改变这个page table(比如加载page, 移除page)</li><li>确认获得global latch之后，我们向buffer pool加载这个page2, 同时也更新page table等metadata</li><li>整个过程结束后，我们松开global latch。这样整个过程中，只有我们这个当前线程更改了page table。</li><li>其他metadata是否也需要线程安全，取决于具体实现。</li></ul><p><br></p><ul><li>上述中可以不用global latch。而只是给对应的slot来一个latch。保证在过程中，没有其他人会读或者写这个slot。这样依旧是一种线程安全的实现。另外相对性能更好。</li></ul><p><img data-src="/images/CMU1544564/Lec05/13.jpg" alt="13.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/14.jpg" alt="14.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/15.jpg" alt="15.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/16.jpg" alt="16.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/17.jpg" alt="17.jpg"></p><p><br></p><h2 id="Locks-vs-Latches-2"><a href="#Locks-vs-Latches-2" class="headerlink" title="Locks vs. Latches 2"></a>Locks vs. Latches <sup><a href="#fn2">2</a></sup></h2><ul><li>locks是一个high level 很抽象的概念, 它直接和transaction事务相关，应用于事务的lock protocol中。是应用层面的。是逻辑内容的互斥，比如行，表，事务。</li><li>latch基本上和low level实现相关，指<code>std::mutex</code>这类和代码相关的类(class)，来保护代码中的critical section。是应用不可见的，内部数据的互斥。</li><li>(这部分我们以后还会提到)<!-- TODO: --></li></ul><p><img data-src="/images/CMU1544564/Lec05/18.jpg" alt="18.jpg"></p><h2 id="Page-Table-vs-Page-Directory"><a href="#Page-Table-vs-Page-Directory" class="headerlink" title="Page Table vs. Page Directory"></a>Page Table vs. Page Directory</h2><ul><li>在<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/#Page-Directory">[CMU-15445]Lec03 - Database Storage - Database Heap - Page Directory</a>文章中我们已经提到了 page directory, 它是一个特殊的page, 记录了page对应文件的位置，因此这个page directory也会以page的方式从硬盘读取到内存，最后从内存写回至硬盘。即它是持久化的(persistent, durable)。</li><li>page table 只是一个<code>page id -&gt; frame id</code>的映射, 具体是一个<code>page id -&gt; frame pointer</code>的hash table，指针的位置只是在本次启动有效，因为关机重启后，我们会allocate另一块内存区域给数据库buffer pool。这类完全依赖内存的数据结构(in-memory data structure)没有意义去存到硬盘上。</li></ul><p><img data-src="/images/CMU1544564/Lec05/19.jpg" alt="19.jpg"></p><h2 id="Allocation-Policies"><a href="#Allocation-Policies" class="headerlink" title="Allocation Policies"></a>Allocation Policies</h2><ul><li>global policies: 指所有query, transaction使用同一个buffer pool的replacement policy</li><li>local policies: 指每一个query, transaction可以有一个自己的buffer pool， 和自己的replacement policy。同时可以在一个共有的buffer pool去share pages</li><li>实际上会混合这两种主意， 比如数据table拥有一个buffer pool, index(索引数据结构)拥有另一个buffer pool。这个我们会在index的课上提到。</li></ul><p><img data-src="/images/CMU1544564/Lec05/20.jpg" alt="20.jpg"></p><p><br><br><br></p><h1 id="Buffer-Pool-Optimizations"><a href="#Buffer-Pool-Optimizations" class="headerlink" title="Buffer Pool Optimizations"></a>Buffer Pool Optimizations</h1><p><img data-src="/images/CMU1544564/Lec05/21.jpg" alt="21.jpg"></p><h2 id="Multiple-Buffer-Pools"><a href="#Multiple-Buffer-Pools" class="headerlink" title="Multiple Buffer Pools"></a>Multiple Buffer Pools</h2><p>见<a href="#allocation-policies">Allocation Policies</a>中提到了部分Local Policies。</p><p><img data-src="/images/CMU1544564/Lec05/22.jpg" alt="22.jpg"></p><p>另外这部分不知道为何没有课件， 我截图了视频来作为缺失的课件。</p><ul><li>Approach2 Hashing: 用一个hash function: <code>RID -&gt; buffer pool id</code>, 把有相同hash value的tuple分配到同一个buffer pool，提高buffer pool中的spatial locality(空间局部性)。(类似hash join)</li></ul><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/missing_1.png" alt="Lec5_missing_1.jpg"></p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/missing_2.png" alt="Lec5_missing_2.jpg"></p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/missing_3.png" alt="Lec5_missing_3.jpg"></p><h2 id="Pre-Fetching"><a href="#Pre-Fetching" class="headerlink" title="Pre-Fetching"></a>Pre-Fetching</h2><p>我们可以预加载一些page, 一个thread在对page A进行扫描计算的同时，另外一个thread可以将下一个page B加载到buffer pool中。这个方法，是用猜测或者预先的只是，去加载未来可能用得到的page, 最终目的减少从硬盘加载的时间。具体有两种情况，根据这个<strong>下一个page</strong>是哪一个:</p><ul><li>Sequential Scans: 即物理上连续存储的下一个page</li><li>Index Scans: </li></ul><h3 id="Sequential-Scans"><a href="#Sequential-Scans" class="headerlink" title="Sequential Scans"></a>Sequential Scans</h3><p><img data-src="/images/CMU1544564/Lec05/23.jpg" alt="23.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/24.jpg" alt="24.jpg"></p><p>Q1在扫描page1的时候，buffer pool manager发现这是一个sequenial scan，决定pre fetch后面的page，所以在同时将page2,3加载进buffer pool。理想的话，等Q1结束对page1的扫描，page2,3就已经在buffer pool，相当于没有收到page fault的影响，没有浪费时间等待。</p><p><img data-src="/images/CMU1544564/Lec05/25.jpg" alt="25.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/26.jpg" alt="26.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/27.jpg" alt="27.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/28.jpg" alt="28.jpg"></p><h3 id="Index-Scans"><a href="#Index-Scans" class="headerlink" title="Index Scans"></a>Index Scans</h3><p>这里的index是一个B+ Tree， 具体作法是从根节点查找至叶子节点，再水平遍历有关的叶子节点。这时候我们需要的page不一定是物理上连续存储的：</p><p><img data-src="/images/CMU1544564/Lec05/29.jpg" alt="29.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/30.jpg" alt="30.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/31.jpg" alt="31.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/32.jpg" alt="32.jpg"></p><p><br></p><p>下图中很明显表达，我们接下面需要的是page3和page5, 它们不是连续的，也不紧跟在page1(当前page)之后。 但是index这个数据结构告诉我们，下一步是page3和page5被需要，因此去pre fetch它们俩。这里也是一个很明显的例子，操作系统在这一点帮不了我们，操作系统最多能帮我们pre fetch连续的page，但是它不知道index的存在，没有办法帮助我们准确去得到page3和page5：<br><img data-src="/images/CMU1544564/Lec05/33.jpg" alt="33.jpg"></p><h2 id="Scan-Sharing"><a href="#Scan-Sharing" class="headerlink" title="Scan Sharing"></a>Scan Sharing</h2><ul><li>Scan Sharing: reuse data retrieved from storage or operator computations， 即使用其他正在运行的query的中间过程值</li><li>result caching: 只是缓存最终结果值，而不是中间过程值</li></ul><p>具体流程：</p><ul><li>第一个Query已经在运行，有一些中间过程值</li><li>第二个Query开始运行，DBMS发现这第二个Query可以公用第一个Query的值，而且它们俩需要扫描的范围一样。</li><li>DBMS将第二个Query attch进第一个Query, 记录下第二个Query被attach的地方, 让它们俩一起扫描。</li><li>等它们俩共同扫描结束后，再扫描一开始第二个Query跳过的地方。</li></ul><p><img data-src="/images/CMU1544564/Lec05/34.jpg" alt="34.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/35.jpg" alt="35.jpg"></p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>Q1需要扫描所有的page, 将val不断累加。</p><p><img data-src="/images/CMU1544564/Lec05/36.jpg" alt="36.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/37.jpg" alt="37.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/38.jpg" alt="38.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/39.jpg" alt="39.jpg"></p><p><br><br><br></p><p>在Q1扫描至page3的时候，Q2加入。很巧，Q2也需要扫描所有的page, 将val不断累加。这说明Q2已加入就可以使用Q1的中间结果，并且可以和Q1结合在一起扫描剩下的page：<br><img data-src="/images/CMU1544564/Lec05/40.jpg" alt="40.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/41.jpg" alt="41.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/42.jpg" alt="42.jpg"></p><p><br><br><br></p><p>Q1结束后， 这个例子中，Q2还需要扫描它没有扫描过的page， 因为Q2计算平均值， 需要知道每一个page上tuple的个数。</p><p><img data-src="/images/CMU1544564/Lec05/43.jpg" alt="43.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/44.jpg" alt="44.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/45.jpg" alt="45.jpg"></p><p>我们也想象一下，如果没有scan sharing这个feature， Q1和Q2相互竞争buffer pool会导致这两个Query性能都很差。</p><h2 id="Buffer-Pool-Bypass"><a href="#Buffer-Pool-Bypass" class="headerlink" title="Buffer Pool Bypass"></a>Buffer Pool Bypass</h2><p>sequantial scan会将大部分page加载进buffer pool, 而这些page又并不一定在未来会被重复利用。对这种sequantial scan的Query，我们可以单独给allocate一块内存区域，而独立于且不影响buffer pool。这一块专属的内存区域依然能保证对当前Query的性能，而且因为不会<em>打乱污染</em>buffer pool而影响其他Query的性能。这块内存区域会在该sequantial scan Query结束后被释放。</p><p><img data-src="/images/CMU1544564/Lec05/46.jpg" alt="46.jpg"></p><ul><li>Light Scans: <span class="exturl" data-url="aHR0cHM6Ly93d3cuaWJtLmNvbS9zdXBwb3J0L2tub3dsZWRnZWNlbnRlci9lbi9TU0dVOEdfMTIuMS4wL2NvbS5pYm0ucGVyZi5kb2MvaWRzX3ByZl8yMzcuaHRt" title="https://www.ibm.com/support/knowledgecenter/en/SSGU8G_12.1.0/com.ibm.perf.doc/ids_prf_237.htm">https://www.ibm.com/support/knowledgecenter/en/SSGU8G_12.1.0/com.ibm.perf.doc/ids_prf_237.htm<i class="fa fa-external-link"></i></span></li></ul><p><br></p><h2 id="OS-Page-Cache"><a href="#OS-Page-Cache" class="headerlink" title="OS Page Cache"></a>OS Page Cache</h2><p><img data-src="/images/CMU1544564/Lec05/47.jpg" alt="47.jpg"></p><ul><li>O_DIRECT: <span class="exturl" data-url="aHR0cHM6Ly9saW51eC5kaWUubmV0L21hbi8yL29wZW4=" title="https://linux.die.net/man/2/open">https://linux.die.net/man/2/open<i class="fa fa-external-link"></i></span></li><li>大部分DBMS<strong>使用direct I/O</strong>，省去文件被加载入操作系统文件缓存区。direct I/O可以直接讲文件读取到数据库缓存区的address space。省去了从操作系统缓存区复制进数据库缓存区的address space，这样性能也更好。更多见<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/#mmap">[CMU-15445]Lec03 - Why not use the OS? - mmap</a></li><li>也有其他的DBMS<strong>不使用direct I/O</strong>， 比如PostgreSQL。它们从工程的角度觉得不使用direct I/O更好：数据库buffer pool出现page fault的时候，如果对应的page在操作系统的文件缓存区中，那这时候只需要一次内存中的复制(从操作系统的文件缓存区复制到数据库buffer pool)，而不是去硬盘做漫长的I/O。比如PostgreSQL重启后buffer pool是空的，但是操作系统的page cache以及还是有对应文件，这时候可以从page cache中复制，避免冷启动。</li></ul><p>课上的PostgreSQL实验, 见<a href="https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/">[DBMS][PostgreSQL] 缓存区管理 BufferPool</a></p><p><br></p><h2 id="Buffer-Replacement-Policies"><a href="#Buffer-Replacement-Policies" class="headerlink" title="Buffer Replacement Policies"></a>Buffer Replacement Policies</h2><p>这部分中的理论和操作系统中的页替换没有太大区别。</p><p><img data-src="/images/CMU1544564/Lec05/48.jpg" alt="48.jpg"></p><h3 id="Lest-Recently-Used-LRU"><a href="#Lest-Recently-Used-LRU" class="headerlink" title="Lest Recently Used (LRU)"></a>Lest Recently Used (LRU)</h3><p><img data-src="/images/CMU1544564/Lec05/49.jpg" alt="49.jpg"></p><h3 id="Clock"><a href="#Clock" class="headerlink" title="Clock"></a>Clock</h3><p>LRU需要获取真的timestamp，　而无论获取software timer或者hardware timer都是非常昂贵的，需要很多CPU周期。所有我们选用Clock, 它是LRU的一个近似(approximation), 它就去除了每一个page的timestamp属性。而Clock使用一个不准确的时间区间, 即reference至顺时针被选择。具体我们可以看下面的Demo:</p><p>下图我们访问page1, 它在我们buffer pool中，我们得到这个page, 也让它的ref＝1:<br><img data-src="/images/CMU1544564/Lec05/50.jpg" alt="50.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/51.jpg" alt="51.jpg"></p><p><br><br><br></p><p>然后我们需要加载一个新的page5,　要去除一个buffer pool中的page。指针指向的page1的ref=1, 它可以留在buffer pool, 并且ref=0, 指针指向下一个page:</p><p><img data-src="/images/CMU1544564/Lec05/52.jpg" alt="52.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/53.jpg" alt="53.jpg"></p><p><br><br><br></p><p>指针指向的page2的ref=0, 它不可以留在buffer pool：</p><p><img data-src="/images/CMU1544564/Lec05/54.jpg" alt="54.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/55.jpg" alt="55.jpg"></p><p><br><br><br></p><h3 id="Problem-Sequential-Flooding-顺序泛洪"><a href="#Problem-Sequential-Flooding-顺序泛洪" class="headerlink" title="Problem - Sequential Flooding 顺序泛洪"></a>Problem - Sequential Flooding 顺序泛洪</h3><p>LRU和Clock容易收到Sequential Flooding的影响。Sequential Flooding我们之前也间接的提到过，一个Query如果需要扫描所有的page, buffer pool会因为它的变得很乱，而最后留在buffer pool中的page也不一定对未来的Query有帮助。这里我们更严谨定义这个行为叫Sequential Flooding，最后留在buffer pool中的page是最近被使用过的(least recently used)，　但是它们实际上是最不需要的(most unneeded)。(这些page往往是硬盘上最后几个page)</p><p><img data-src="/images/CMU1544564/Lec05/58.jpg" alt="58.jpg"></p><p><br></p><p>下面是一个Demo。下面这个Demo中的问题可以换一个思路解决：每次把Q2带进来的page中page id最大的舍弃。</p><p><img data-src="/images/CMU1544564/Lec05/59.jpg" alt="59.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/60.jpg" alt="60.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/61.jpg" alt="61.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/62.jpg" alt="62.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/63.jpg" alt="63.jpg"></p><h3 id="LRU-K-1"><a href="#LRU-K-1" class="headerlink" title="LRU-K 1"></a>LRU-K <sup><a href="#fn1">1</a></sup></h3><p>LRU-K中的<code>K</code>代表<strong>最近使用的次数</strong>，因此LRU可以认为是LRU-1。LRU-K的主要目的是为了解决LRU算法”缓存污染”的问题，其核心思想是将“最近使用过1次”的判断标准<strong>扩展为“最近使用过K次”</strong>。</p><p>相比LRU，LRU-K需要多维护<strong>一个队列: 缓存队列。它用于记录所有缓存数据被访问的历史。只有当数据的访问次数达到K次的时候，才将数据放入缓存队列</strong>。当需要淘汰数据时，LRU-K会淘汰第K次访问时间距当前时间最大的数据。详细实现如下：</p><ol><li>数据第一次被访问，加入到访问<strong>历史队列</strong></li><li>如果数据在访问<strong>历史队列</strong>里后没有达到K次访问，则按照一定规则(FIFO，LRU)淘汰</li><li>当访问<strong>历史队列</strong>中的数据访问次数达到K次后，将数据索引从<strong>历史队列</strong>删除，将数据移到<strong>缓存队列</strong>中，并缓存此数据，<strong>缓存队列</strong>重新按照时间排序</li><li><strong>缓存队列</strong>中被再次访问后，重新排序</li><li>需要淘汰数据时，淘汰<strong>缓存队列</strong>中排在末尾的数据，即淘汰”倒数第K次访问离现在最久”的数据</li></ol><p>LRU-K具有LRU的优点，同时能够避免LRU的缺点，实际应用中LRU-2是综合各种因素后最优的选择，LRU-3或者更大的K值命中率会高，但适应性差，需要大量的数据访问才能将历史访问记录清除掉。</p><p>另外LRU-K对sequential scan<strong>不敏感</strong>，因为sequential scan只使用每个page一次。而使用一次的page在LRU-K非常容易被evict。</p><!-- TODO: TUM ModernDBS --><p><img data-src="/images/CMU1544564/Lec05/64.jpg" alt="64.jpg"></p><h3 id="Localization"><a href="#Localization" class="headerlink" title="Localization"></a>Localization</h3><p>这部分已经在这课中的实验中体现了：PostgreSQL给每一个Query一个独立的buffer pool， 同时所有Query公用一个shared buffer pool。这最大限度地减少了每个query对buffer pool的污染。</p><p><img data-src="/images/CMU1544564/Lec05/65.jpg" alt="65.jpg"></p><h3 id="Priority-Hints"><a href="#Priority-Hints" class="headerlink" title="Priority Hints"></a>Priority Hints</h3><p>DBMS知道哪些page比较重要，经常访问，打上标签。<sup><a href="#fn2">2</a></sup></p><p><img data-src="/images/CMU1544564/Lec05/67.jpg" alt="67.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/68.jpg" alt="68.jpg"></p><h2 id="Dirty-Pages"><a href="#Dirty-Pages" class="headerlink" title="Dirty Pages"></a>Dirty Pages</h2><p>只有被更改过的page才有必要写回硬盘，持久化。</p><p>DBMS可以定期遍历page table并将脏页写回硬盘。因为如果每次等eviction的时候再去flush脏页，会让eviction的过程非常的慢，所以一般会有个后台进程定期批量的去写回脏页。<sup><a href="#fn2">2</a></sup>当安全地写会脏页之后，DBMS可以evict页面或者只是取消设置dirty bit, 因为这个页面已经<strong>不再脏了</strong>。需要注意的是，在写日志记录之前，我们不会去写脏页。<sup><a href="#fn1">1</a></sup></p><p><img data-src="/images/CMU1544564/Lec05/69.jpg" alt="69.jpg"></p><h2 id="Background-Writing"><a href="#Background-Writing" class="headerlink" title="Background Writing"></a>Background Writing</h2><p>我们需要控制page被写回硬盘的时间，但是如果我们使用<code>mmap</code>,就很难控制每一个page写回的时间点。</p><p><img data-src="/images/CMU1544564/Lec05/70.jpg" alt="70.jpg"></p><h2 id="Other-Memory-Pool"><a href="#Other-Memory-Pool" class="headerlink" title="Other Memory Pool"></a>Other Memory Pool</h2><p><img data-src="/images/CMU1544564/Lec05/71.jpg" alt="71.jpg"></p><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><img data-src="/images/CMU1544564/Lec05/72.jpg" alt="72.jpg"></p><p><img data-src="/images/CMU1544564/Lec05/80.jpg" alt="80.jpg"></p><p>引用:</p><p><a name="fn1">1</a>: CMU 15445 4. 缓存层 - 西部小笼包: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wODUxNDIxZjRjYjg=" title="https://www.jianshu.com/p/0851421f4cb8">https://www.jianshu.com/p/0851421f4cb8<i class="fa fa-external-link"></i></span></p><p><a name="fn2">2</a>: Database Storage - fxjwind: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9wLzEwODE4ODE0Lmh0bWw=" title="https://www.cnblogs.com/fxjwind/p/10818814.html">https://www.cnblogs.com/fxjwind/p/10818814.html<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Buffer Pools - 数据库缓存区&lt;/p&gt;
&lt;p&gt;Slide: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA1LWJ1ZmZlcnBvb2wucGRm&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Note: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDUtYnVmZmVycG9vbC5wZGY=&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Readings: Chapter 10.5-10.8&lt;/p&gt;
&lt;p&gt;这节两课，我们会学习数据库的缓存区管理，这部分基于前面两节课(Storage I和Storage II)。&lt;/p&gt;
&lt;p&gt;缓存区buffer pool就是在内存中对page的缓存(cache)。&lt;/p&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Storage" scheme="https://cakebytheoceanluo.github.io/categories/Storage/"/>
    
      <category term="Buffer Management" scheme="https://cakebytheoceanluo.github.io/categories/Buffer-Management/"/>
    
    
      <category term="Page" scheme="https://cakebytheoceanluo.github.io/tags/Page/"/>
    
      <category term="Buffer Pool" scheme="https://cakebytheoceanluo.github.io/tags/Buffer-Pool/"/>
    
      <category term="LRU" scheme="https://cakebytheoceanluo.github.io/tags/LRU/"/>
    
      <category term="Clock" scheme="https://cakebytheoceanluo.github.io/tags/Clock/"/>
    
  </entry>
  
  <entry>
    <title>[DBMS][PostgreSQL]缓存区管理BufferPool</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/</id>
    <published>2020-03-17T18:46:09.000Z</published>
    <updated>2020-03-17T19:15:05.645Z</updated>
    
    <content type="html"><![CDATA[<p>这篇文章服务于<a href="https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/">[CMU-15445]Lec05</a></p><p>我们沿用上一个实验的数据集和数据库:</p><ul><li>上一个实验，见<a href="https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/">[DBMS]Postgres浮点数，定点数精度问题 precision_numbers</a></li><li>具体数据集，见<a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#CMU-15445-%E5%88%86%E6%95%B0%E6%95%B0%E6%8D%AE%E9%9B%86-Mock">[DBMS] PostgreSQL 导入数据集: CMU-15445 分数数据集 (Mock)</a></li></ul><p>这个实验的目的是观察PostgreSQL: </p><ul><li>buffer pool对Query性能的影响,</li><li>操作系统文件缓存区对Query在page fault的影响，因为PostgreSQL不使用direct I/O</li></ul><a id="more"></a><hr><h1 id="清空操作系统-pagecache-dentries-and-inodes"><a href="#清空操作系统-pagecache-dentries-and-inodes" class="headerlink" title="清空操作系统 pagecache, dentries and inodes"></a>清空操作系统 pagecache, dentries and inodes</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            15G        9.8G        2.3G        1.9G        3.2G        3.3G</span><br><span class="line">Swap:          2.0G        1.4G        643M</span><br><span class="line">$ sync; <span class="built_in">echo</span> 3 | sudo tee /proc/sys/vm/drop_caches</span><br><span class="line">3</span><br><span class="line">$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            15G        9.9G        3.0G        1.8G        2.5G        3.3G</span><br><span class="line">Swap:          2.0G        1.4G        579M</span><br></pre></td></tr></tbody></table></figure><ul><li><code>free -h</code> 可以显示系统空闲以及占用的内存容量<blockquote><pre><code>   free - Display amount of free and used memory in the system</code></pre></blockquote></li><li><code>sync</code> 可以将缓存的页写入硬盘<blockquote><pre><code>   sync - Synchronize cached writes to persistent storage</code></pre></blockquote></li><li><code>echo 3 | sudo tee /proc/sys/vm/drop_caches</code> 释放 pagecache, dentries and inodes</li><li>或者在<code>su</code>的权限下<code>echo 3 &gt; /proc/sys/vm/drop_caches</code></li></ul><p>从上面的输出中，我们可以发现，<code>buff/cache</code>在运行指令后减少了很多，说明这块被释放了一部分。</p><p><br></p><p>有关阅读：</p><ul><li>How do you empty the buffers and cache on a Linux system? - Stackoverflow: <span class="exturl" data-url="aHR0cHM6Ly91bml4LnN0YWNrZXhjaGFuZ2UuY29tL3F1ZXN0aW9ucy84NzkwOC9ob3ctZG8teW91LWVtcHR5LXRoZS1idWZmZXJzLWFuZC1jYWNoZS1vbi1hLWxpbnV4LXN5c3RlbQ==" title="https://unix.stackexchange.com/questions/87908/how-do-you-empty-the-buffers-and-cache-on-a-linux-system">https://unix.stackexchange.com/questions/87908/how-do-you-empty-the-buffers-and-cache-on-a-linux-system<i class="fa fa-external-link"></i></span></li><li>How to Clear RAM Memory Cache, Buffer and Swap Space on Linux - TecMint: <span class="exturl" data-url="aHR0cHM6Ly93d3cudGVjbWludC5jb20vY2xlYXItcmFtLW1lbW9yeS1jYWNoZS1idWZmZXItYW5kLXN3YXAtc3BhY2Utb24tbGludXgv" title="https://www.tecmint.com/clear-ram-memory-cache-buffer-and-swap-space-on-linux/">https://www.tecmint.com/clear-ram-memory-cache-buffer-and-swap-space-on-linux/<i class="fa fa-external-link"></i></span></li></ul><h1 id="清空psql-buffer-pool-重启psql"><a href="#清空psql-buffer-pool-重启psql" class="headerlink" title="清空psql buffer pool - 重启psql"></a>清空psql buffer pool - 重启psql</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></tbody></table></figure><p>在重启PostgreSQL服务后，buffer pool会被清空。</p><h1 id="实验-查看-page-hit-page-fault"><a href="#实验-查看-page-hit-page-fault" class="headerlink" title="实验 - 查看 page hit, page fault"></a>实验 - 查看 page hit, page fault</h1><p>在这时候我们已经做过了前面两步：</p><ul><li>操作系统没有我们需要的的page cache</li><li>PostgreSQL的buffer pool是空的</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">testdb=# \timing</span><br><span class="line">Timing is on.</span><br><span class="line">testdb=# <span class="built_in">set</span> max_parallel_workers_per_gather = <span class="number">0</span>;</span><br><span class="line">SET</span><br><span class="line">Time: <span class="number">7.740</span> ms</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1817.296</span>.<span class="number">.1817</span><span class="number">.296</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared <span class="built_in">read</span>=<span class="number">44248</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.401</span>.<span class="number">.814</span><span class="number">.209</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared <span class="built_in">read</span>=<span class="number">44248</span></span><br><span class="line"> Planning time: <span class="number">0.225</span> ms</span><br><span class="line"> Execution time: <span class="number">1817.316</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1824.317</span> ms (<span class="number">00</span>:<span class="number">01.824</span>)</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1772.469</span>.<span class="number">.1772</span><span class="number">.469</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">32</span> <span class="built_in">read</span>=<span class="number">44216</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.032</span>.<span class="number">.765</span><span class="number">.356</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">32</span> <span class="built_in">read</span>=<span class="number">44216</span></span><br><span class="line"> Planning time: <span class="number">0.025</span> ms</span><br><span class="line"> Execution time: <span class="number">1772.488</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1772.799</span> ms (<span class="number">00</span>:<span class="number">01.773</span>)</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1673.223</span>.<span class="number">.1673</span><span class="number">.223</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">64</span> <span class="built_in">read</span>=<span class="number">44184</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.030</span>.<span class="number">.719</span><span class="number">.406</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">64</span> <span class="built_in">read</span>=<span class="number">44184</span></span><br><span class="line"> Planning time: <span class="number">0.025</span> ms</span><br><span class="line"> Execution time: <span class="number">1673.243</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1673.562</span> ms (<span class="number">00</span>:<span class="number">01.674</span>)</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1657.359</span>.<span class="number">.1657</span><span class="number">.359</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">96</span> <span class="built_in">read</span>=<span class="number">44152</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.034</span>.<span class="number">.711</span><span class="number">.246</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">96</span> <span class="built_in">read</span>=<span class="number">44152</span></span><br><span class="line"> Planning time: <span class="number">0.025</span> ms</span><br><span class="line"> Execution time: <span class="number">1657.378</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1657.683</span> ms (<span class="number">00</span>:<span class="number">01.658</span>)</span><br></pre></td></tr></tbody></table></figure><ul><li><code>explain (analyze, buffers) select sum(a + b) from testreals;</code>中<ul><li><code>explain</code>: 给出query plan</li><li><code>analyze</code>: 执行query</li><li><code>buffers</code>: 给出buffer pool信息</li></ul></li><li>然后我前后执行4次同一个query:<ul><li>PostgreSQL有一个共用的share buffer pool, 然后每一个query也有一个自己的buffer pool。query的专属buffer pool的大小，会随着执行次数而增加，默认是每次增加32个位置。</li><li>第一次: <code>Buffers: shared read=44248</code> 因为buffer pool是空的，每一次都是page fault。同时操作系统file page cache也是空的，所有page都需要从硬盘先加载到操作系统file page cache, 在从这里复制进数据库buffer pool。<code>shared read</code>指的就是page fault, 是那些不在buffer pool中，需要从硬盘或从操作系统file cache中读取的page。</li><li><strong>我们也可以发现这个表格一共对应<code>44248</code>个page。</strong></li><li>第二次: <code>Buffers: shared hit=32 read=44216</code> Query的buffer pool是大小是32， 已增加32个位置。</li><li>第三次: <code>Buffers: shared hit=64 read=44184</code> Query的buffer pool是大小是64， 已增加32个位置。</li><li>第四次: <code>Buffers: shared hit=96 read=44152</code> Query的buffer pool是大小是94， 已增加32个位置。</li></ul></li></ul><h1 id="实验-扩大buffer-pool-size"><a href="#实验-扩大buffer-pool-size" class="headerlink" title="实验 - 扩大buffer pool size"></a>实验 - 扩大buffer pool size</h1><p>下面我们发现最大的buffer pool size是<code>128MB</code>：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# show shared_buffers;</span><br><span class="line"> shared_buffers </span><br><span class="line">----------------</span><br><span class="line"> <span class="number">128</span>MB</span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">0.196</span> ms</span><br></pre></td></tr></tbody></table></figure><p>但是我们对应的表格的所有page大概是<code>345MB</code>, 每一个page是<code>8KiB</code>:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select (<span class="number">44248</span> * <span class="number">8</span>) / <span class="number">1024</span>;</span><br><span class="line"> ?column? </span><br><span class="line">----------</span><br><span class="line">      <span class="number">345</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">0.381</span> ms</span><br></pre></td></tr></tbody></table></figure><p>因此这个默认的buffer pool size不足以容纳我们这个表格。正因为这个原因，我们的query需要的page数总大于buffer size一次性所能容纳的数量，一定会出现page fault。</p><h2 id="更改PostgresSQL配置文件中的shared-buffers"><a href="#更改PostgresSQL配置文件中的shared-buffers" class="headerlink" title="更改PostgresSQL配置文件中的shared_buffers"></a>更改PostgresSQL配置文件中的<code>shared_buffers</code></h2><p>我们用自己喜欢的文本编辑器去打开<code>/etc/postgresql/10/main/postgresql.conf</code>文件:</p><ul><li>注意我postgresql的版本是<code>10</code></li><li>具体的配置文件位置和postgresql安装位置和安装版本有关</li></ul><p>找到下面对应的<code>shared_buffers</code>, 更改数值为<code>360MB</code>:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------                                                                                          </span></span><br><span class="line"><span class="comment"># RESOURCE USAGE (except WAL)                                                                                                                                            </span></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------                                                                                          </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Memory -                                                                                                                                                             </span></span><br><span class="line"></span><br><span class="line">shared_buffers = 128MB                  <span class="comment"># min 128kB  </span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p><br></p><p>保存完以后我们打开<code>psql</code>看看是否更改成功。如果像下面例子中，看见<code>360MB</code>，而不是之前的<code>128MB</code>,即更改成功：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">testdb=# show shared_buffers;</span><br><span class="line"> shared_buffers </span><br><span class="line">----------------</span><br><span class="line"> <span class="number">360</span>MB</span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure><h2 id="重新之前实验-冷启动"><a href="#重新之前实验-冷启动" class="headerlink" title="重新之前实验 - 冷启动"></a>重新之前实验 - 冷启动</h2><p>我们依然执行下面两个命令， 去清空操作系统file page cache和数据库的buffer pool:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sync; <span class="built_in">echo</span> 3 | sudo tee /proc/sys/vm/drop_caches</span><br><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></tbody></table></figure><p>这样操作以后我们的数据库buffer pool被清空，操作系统page cache里面也没也对应的page, 所以我们称之为<strong>冷启动</strong>。</p><p><br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">testdb=# \timing</span><br><span class="line">Timing is on.</span><br><span class="line"></span><br><span class="line">testdb=# <span class="built_in">set</span> max_parallel_workers_per_gather = <span class="number">0</span>;</span><br><span class="line">SET</span><br><span class="line">Time: <span class="number">9.680</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# CREATE EXTENSION pg_prewarm;</span><br><span class="line">CREATE EXTENSION</span><br><span class="line">Time: <span class="number">12.151</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# select * from pg_prewarm('testreals');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">      <span class="number">44248</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">473.944</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1628.475</span>.<span class="number">.1628</span><span class="number">.475</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">44248</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.008</span>.<span class="number">.664</span><span class="number">.942</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">44248</span></span><br><span class="line"> Planning time: <span class="number">6.139</span> ms</span><br><span class="line"> Execution time: <span class="number">1628.495</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br></pre></td></tr></tbody></table></figure><ul><li><code>select * from pg_prewarm('testreals');</code>或<code>select pg_prewarm('testreals');</code>是将这个表格的所有page都预加载进buffer pool。因为我们调整过shared buffer pool size, 现在我们的shared buffer pool足够容纳这个表格对应的所有page了。<strong>注意这个执行的返回值<code>44248</code>, 它就是这个表格所有对应page的数值。</strong></li><li><code>CREATE EXTENSION pg_prewarm;</code>这个指令是运行上一条指令的前提。</li><li>然后我们又见到这个query： <code>explain (analyze, buffers) select sum(a + b) from testreals;</code><ul><li><code>Buffers: shared hit=44248</code> <strong>我们又发现<code>44248</code>这个数值，说明所有的page都是page hit，而不是page fault。</strong></li></ul></li></ul><p><br></p><p>热启动好像无法在psql中直接展示，这里略过。 <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">😂</span></p><p><br></p><p>推荐的阅读：</p><p>PREWARMING POSTGRESQL I/O CACHES - Hans-Jürgen Schönig： <span class="exturl" data-url="aHR0cHM6Ly93d3cuY3liZXJ0ZWMtcG9zdGdyZXNxbC5jb20vZW4vcHJld2FybWluZy1wb3N0Z3Jlc3FsLWktby1jYWNoZXMv" title="https://www.cybertec-postgresql.com/en/prewarming-postgresql-i-o-caches/">https://www.cybertec-postgresql.com/en/prewarming-postgresql-i-o-caches/<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这篇文章服务于&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/&quot;&gt;[CMU-15445]Lec05&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;我们沿用上一个实验的数据集和数据库:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;上一个实验，见&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/&quot;&gt;[DBMS]Postgres浮点数，定点数精度问题 precision_numbers&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;具体数据集，见&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#CMU-15445-%E5%88%86%E6%95%B0%E6%95%B0%E6%8D%AE%E9%9B%86-Mock&quot;&gt;[DBMS] PostgreSQL 导入数据集: CMU-15445 分数数据集 (Mock)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个实验的目的是观察PostgreSQL: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;buffer pool对Query性能的影响,&lt;/li&gt;
&lt;li&gt;操作系统文件缓存区对Query在page fault的影响，因为PostgreSQL不使用direct I/O&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Storage" scheme="https://cakebytheoceanluo.github.io/categories/Storage/"/>
    
      <category term="DBMS" scheme="https://cakebytheoceanluo.github.io/categories/DBMS/"/>
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/categories/PostgreSQL/"/>
    
      <category term="Buffer Management" scheme="https://cakebytheoceanluo.github.io/categories/Buffer-Management/"/>
    
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>[CMU-15445]Lec04 Database Storage Part II - 数据库存储  II</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/16/CMU-15445-Lec04/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/16/CMU-15445-Lec04/</id>
    <published>2020-03-16T13:08:44.000Z</published>
    <updated>2020-03-18T18:43:32.190Z</updated>
    
    <content type="html"><![CDATA[<p>Database Storage Part II - 数据库存储  II</p><p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA0LXN0b3JhZ2UyLnBkZg==" title="https://15445.courses.cs.cmu.edu/fall2019/slides/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/04-storage2.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDQtc3RvcmFnZTIucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf<i class="fa fa-external-link"></i></span></p><p>这节两课，我们会学习数据库内部的存储。</p><p>Database Storage 在CMU分成了两部分，在两节课中讲。这是第二部分。</p><p>这部分设涉及基础数据类型的表示, OLAP, OLTP, HTAP, row-store (NSM), column store(DSM) 等等。</p><a id="more"></a><p><img data-src="/images/CMU1544564/Lec04/1.jpg" alt="1.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/12.jpg" alt="12.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/13.jpg" alt="13.jpg"></p><p>a sequence of bytes = byte array</p><h1 id="Data-Representation"><a href="#Data-Representation" class="headerlink" title="Data Representation"></a>Data Representation</h1><p><img data-src="/images/CMU1544564/Lec04/14.jpg" alt="14.jpg"></p><ul><li>我们在<a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part1/#DATE-TIME-OPERATIONS">[CMU-15445]Lec02_part1</a>, 在不同的数据库中已经见过Date Time Operations也不一样，没有唯一的标准。</li></ul><!-- TODO: unix epoch --><h2 id="Variable-Precision-Numbers-浮点数"><a href="#Variable-Precision-Numbers-浮点数" class="headerlink" title="Variable Precision Numbers 浮点数"></a>Variable Precision Numbers 浮点数</h2><p><img data-src="/images/CMU1544564/Lec04/15.jpg" alt="15.jpg"></p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSUVFRV83NTQ=" title="https://en.wikipedia.org/wiki/IEEE_754">https://en.wikipedia.org/wiki/IEEE_754<i class="fa fa-external-link"></i></span>  <!-- TODO --></li><li>对<code>FLOAT</code>, <code>REAL/DOUBLE</code>的操作会比较快，因为CPU有直接对应的指令(instruction)可以使用，但是因为精度有限的原因，使用这几个依然会失去精度。(和编程语言中一样)。因为计算机对数字存储是离散的，有限的，必然会失去一定精度，结果是近似的。</li></ul><h3 id="Demo-失去精度"><a href="#Demo-失去精度" class="headerlink" title="Demo - 失去精度"></a>Demo - 失去精度</h3><p><img data-src="/images/CMU1544564/Lec04/16.jpg" alt="16.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/17.jpg" alt="17.jpg"></p><h2 id="Fixed-Precision-Numbers-定点数"><a href="#Fixed-Precision-Numbers-定点数" class="headerlink" title="Fixed Precision Numbers 定点数"></a>Fixed Precision Numbers 定点数</h2><p>定点数就是小数点是固定的，所以我们用int分别存储小数点前后的数字就可以实现，定点数是可以做到精确计算的。但是局限也很明显，只能表示固定精度。<sup><a href="#fn1">1</a></sup></p><p><img data-src="/images/CMU1544564/Lec04/18.jpg" alt="18.jpg"></p><p>更多关于这个Demo实验，见这个文章<a href="https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/">[DBMS]Postgres浮点数，定点数精度问题 precision_numbers</a></p><p><img data-src="/images/CMU1544564/Lec04/19.jpg" alt="19.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/20.jpg" alt="20.jpg"></p><ul><li>PostgreSQL Source Code: <span class="exturl" data-url="aHR0cHM6Ly9kb3h5Z2VuLnBvc3RncmVzcWwub3JnL2ludGVyZmFjZXNfMmVjcGdfMnBndHlwZXNsaWJfMm51bWVyaWNfOGNfc291cmNlLmh0bWwjbDAwNzIy" title="https://doxygen.postgresql.org/interfaces_2ecpg_2pgtypeslib_2numeric_8c_source.html#l00722">https://doxygen.postgresql.org/interfaces_2ecpg_2pgtypeslib_2numeric_8c_source.html#l00722<i class="fa fa-external-link"></i></span></li><li>从源代码中可以看出固定精度的数字的操作很复杂，有很多branch，所以会比较慢。</li></ul><h2 id="Large-Values"><a href="#Large-Values" class="headerlink" title="Large Values"></a>Large Values</h2><p><img data-src="/images/CMU1544564/Lec04/21.jpg" alt="21.jpg"></p><ul><li>如果<code>c</code>很大，甚至超过了一个page的大小。比如<code>c</code>是一个tuple中一个很长的<code>VARCHAR</code>字段。String总是数据库中最麻烦的。对于这个超过一个page大小的<code>c</code>，我们可以把它额外存储在一个<em>overflow page</em>上，这时上图中的<code>c</code>实际上是一个指向overflow page的一个指针。</li><li>当然overflow page可以是多个。假如一个overflow page依然不够大，我们可以使用几个overflow page，它们之间继续用<em>指针</em>相连。</li><li>整体上overflow page只是一种实现存储large value的方式。它对使用数据库的应用是<strong>透明的(transparent)</strong>, 使用数据库的应用只获得那个很长的<code>c</code>字符串，而不必知道它是如何被存储，存储在哪儿。</li></ul><h2 id="External-Value-Storage"><a href="#External-Value-Storage" class="headerlink" title="External Value Storage"></a>External Value Storage</h2><p><img data-src="/images/CMU1544564/Lec04/22.jpg" alt="22.jpg"></p><ul><li>External Value Storage是指那些特别大的文件，超过我们前面提到的large value。它比如说是GiB大小的视频。</li><li>BLOB: Binary Large Object data</li><li>这种文件，我们没有必要把它存储在数据库内部，这样会浪费数据库空间。</li><li>我们直接在<code>c</code>的地方存储，该文件在操作系统文件系统中硬盘的位置。这样做不会浪费数据库内部空间。</li><li>如果我们使用的High End的设备去运行高性能数据库，那么该服务器中磁盘容量是很宝贵的，不应该被浪费的。在<code>c</code>存储一个硬盘位置，能降低数据库的成本，特别是这个硬盘可以是HTFS或者network storage。</li><li>这里注意对于存放到外部文件的数据，是不保证transaction等语义的。<sup><a href="#fn1">1</a></sup></li></ul><p><img data-src="/images/CMU1544564/Lec04/23.jpg" alt="23.jpg"></p><p>To BLOB or Not To BLOB: Large Object Storage in a Database or a Filesystem: <span class="exturl" data-url="aHR0cHM6Ly93d3cubWljcm9zb2Z0LmNvbS9lbi11cy9yZXNlYXJjaC9wdWJsaWNhdGlvbi90by1ibG9iLW9yLW5vdC10by1ibG9iLWxhcmdlLW9iamVjdC1zdG9yYWdlLWluLWEtZGF0YWJhc2Utb3ItYS1maWxlc3lzdGVtLw==" title="https://www.microsoft.com/en-us/research/publication/to-blob-or-not-to-blob-large-object-storage-in-a-database-or-a-filesystem/">https://www.microsoft.com/en-us/research/publication/to-blob-or-not-to-blob-large-object-storage-in-a-database-or-a-filesystem/<i class="fa fa-external-link"></i></span></p><p><br></p><h1 id="System-Catalogs-metadata"><a href="#System-Catalogs-metadata" class="headerlink" title="System Catalogs = metadata"></a>System Catalogs = metadata</h1><p><img data-src="/images/CMU1544564/Lec04/24.jpg" alt="24.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/25.jpg" alt="25.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/26.jpg" alt="26.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/27.jpg" alt="27.jpg"></p><!-- TODO: MySQL, SQLIte --><p>PostgreSQL的查看Schema操作，具体见另外一篇博客，里面有很多例子：<a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#%E6%95%B0%E6%8D%AE%E9%9B%86">[DBMS] PostgreSQL 导入数据集 - 数据集</a></p><p><br><br><br></p><h1 id="Storage-Levels"><a href="#Storage-Levels" class="headerlink" title="Storage Levels"></a>Storage Levels</h1><p><img data-src="/images/CMU1544564/Lec04/28.jpg" alt="28.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/29.jpg" alt="29.jpg"></p><h2 id="OLTP"><a href="#OLTP" class="headerlink" title="OLTP"></a>OLTP</h2><p>OLTP := On-line Transaction Processing 通常是对很小一部分tuple的写操作</p><p>OLTP: On-line Transaction Processing</p><ul><li>Fast, short running operations</li><li>Queries operate on single entity at a time</li><li>More writes than reads</li><li>Repetitive operations</li><li>Usually the kind of application that people build first</li><li>Example: User invocations of Amazon. They can add things to their cart, they can make purchases,<br>but the actions only affect their account.<br>— 引用自: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDQtc3RvcmFnZTIucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf<i class="fa fa-external-link"></i></span></li></ul><p><img data-src="/images/CMU1544564/Lec04/30.jpg" alt="30.jpg"></p><h2 id="OLAP"><a href="#OLAP" class="headerlink" title="OLAP"></a>OLAP</h2><p>OLAP := On-line Analytical Processing 通常是对很大一部分是tuple做读操作, 同复杂的分析聚合　(decision-support, big data)</p><p>OLTP: On-line Transaction Processing</p><ul><li>Fast, short running operations</li><li>Queries operate on single entity at a time</li><li>More writes than reads</li><li>Repetitive operations</li><li>Usually the kind of application that people build first</li><li>Example: User invocations of Amazon. They can add things to their cart, they can make purchases,<br>but the actions only affect their account.<br>— 引用自: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDQtc3RvcmFnZTIucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf<i class="fa fa-external-link"></i></span></li></ul><p><img data-src="/images/CMU1544564/Lec04/31.jpg" alt="31.jpg"></p><h2 id="HTAP"><a href="#HTAP" class="headerlink" title="HTAP"></a>HTAP</h2><p><img data-src="/images/CMU1544564/Lec04/32.jpg" alt="32.jpg"></p><p>SOURCE: <span class="exturl" data-url="aHR0cHM6Ly9jYWNtLmFjbS5vcmcvbWFnYXppbmVzLzIwMTEvNi8xMDg2NTEtMTAtcnVsZXMtZm9yLXNjYWxhYmxlLXBlcmZvcm1hbmNlLWluLXNpbXBsZS1vcGVyYXRpb24tZGF0YXN0b3Jlcy9mdWxsdGV4dA==" title="https://cacm.acm.org/magazines/2011/6/108651-10-rules-for-scalable-performance-in-simple-operation-datastores/fulltext">https://cacm.acm.org/magazines/2011/6/108651-10-rules-for-scalable-performance-in-simple-operation-datastores/fulltext<i class="fa fa-external-link"></i></span></p><p><br></p><h1 id="Storage-Models"><a href="#Storage-Models" class="headerlink" title="Storage Models"></a>Storage Models</h1><p><img data-src="/images/CMU1544564/Lec04/33.jpg" alt="33.jpg"></p><h2 id="N-ary-Storage-Model-NSM-row-store"><a href="#N-ary-Storage-Model-NSM-row-store" class="headerlink" title="N-ary Storage Model (NSM): row store"></a>N-ary Storage Model (NSM): row store</h2><p><img data-src="/images/CMU1544564/Lec04/34.jpg" alt="34.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/35.jpg" alt="35.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/36.jpg" alt="36.jpg"></p><h3 id="OLTP-1"><a href="#OLTP-1" class="headerlink" title="OLTP"></a>OLTP</h3><p>OLTP往往有一个index(索引)，它可以快速找到OLTP需要的那一个tuple。</p><p><img data-src="/images/CMU1544564/Lec04/37.jpg" alt="37.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/38.jpg" alt="38.jpg"></p><h3 id="OLAP-1"><a href="#OLAP-1" class="headerlink" title="OLAP"></a>OLAP</h3><p>而OLAP往往需要扫描很大一部分的表格，这种情况index的帮助不会很大。<strong>扫描</strong>具体就是从每一个tuple头到尾，我们之前提过tuple就是一个byte array。即使我们下图中，只需要检查深蓝色和浅蓝色两个字段，但是整个tuple还是需要从内存加载到CPU cache。而且一个page上的大部分数据也都和当前query无关，这实际上很不高效。所以下图红圈中的都是useless data。</p><p><img data-src="/images/CMU1544564/Lec04/43.jpg" alt="43.jpg"></p><h3 id="NSM-Pros-amp-Cons"><a href="#NSM-Pros-amp-Cons" class="headerlink" title="NSM Pros&amp;Cons"></a>NSM Pros&amp;Cons</h3><p><img data-src="/images/CMU1544564/Lec04/44.jpg" alt="44.jpg"></p><ul><li>NSM适合OLTP, 因为对单个tuple的操作很简单。但是不适合OLAP，如果OLAP不需要所有字段的话。</li></ul><p>There are two different ways to organize a NSM database:</p><ul><li><strong>Heap-Organized Tables</strong>: Tuples are stored in blocks called a heap, and the heap does not necessarily<br>define an order.</li><li><strong>Index-Organized Tables</strong>: Tuples are stored in the primary key index itself, but different from a<br>clustered index.</li></ul><p>— 引用自: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDQtc3RvcmFnZTIucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf<i class="fa fa-external-link"></i></span></p><p><br></p><h2 id="Decomposition-Storage-Model-DSM-column-store"><a href="#Decomposition-Storage-Model-DSM-column-store" class="headerlink" title="Decomposition Storage Model (DSM): column store"></a>Decomposition Storage Model (DSM): column store</h2><p>在DSM中，每一个字段(或每一列)都有拥有自己的page, 上面都是当前列的数据。</p><p><img data-src="/images/CMU1544564/Lec04/45.jpg" alt="45.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/46.jpg" alt="46.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/47.jpg" alt="47.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/49.jpg" alt="49.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/50.jpg" alt="50.jpg"></p><ul><li>上图中　Choice1是更好的主意，也更常见。适合每个字段的数据类型是<strong>等长的</strong>。</li></ul><p><img data-src="/images/CMU1544564/Lec04/51.jpg" alt="51.jpg"></p><ul><li>DSM将同一列中的数据存在一起，这些数据自然也属于同一个数据类型。这样处理起来对CPU cache更高效, 同时也带来了很多comrpession(压缩), materialized aggregate(small index for a page), SIMD指令的优化。</li></ul><p><img data-src="/images/CMU1544564/Lec04/52.jpg" alt="52.jpg"></p><ul><li>DSM Proposal - A Query Processing Strategy for the Decomposed Storage Model: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC41NTU1LzY0NTQ3Mi42NTU1NTU=" title="https://dl.acm.org/doi/10.5555/645472.655555">https://dl.acm.org/doi/10.5555/645472.655555<i class="fa fa-external-link"></i></span></li><li>大部分分析型的数据库都是用column store，它们采用的往往是DSM的现代变种</li><li>一个DSM的变种: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvZG93bmxvYWRzL3B1YmxpY2F0aW9ucy9kYXRhYmxvY2tzLnBkZg==" title="https://db.in.tum.de/downloads/publications/datablocks.pdf">Data Blocks: Hybrid OLTP and OLAP on Compressed Storage using both Vectorization and Compilation<i class="fa fa-external-link"></i></span></li></ul><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Row stores are usually better for OLTP, while column stores ar better for OLAP.</p><p>大部分现代数据库:</p><ul><li>Frontend: OLTP in client, 处理用户的事务</li><li>Backend: OLAP in Server, data warehouse　大数据分析所有用户的资料(比如订单)</li></ul><p>下面三页是来自<span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA1LWJ1ZmZlcnBvb2wucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf">Lec05<i class="fa fa-external-link"></i></span>, 在这节课最开始的时候，重新讲了这部分，我将这三页课件移动到这里。</p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/3.jpg" alt="Lec5_3.jpg"></p><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/4.jpg" alt="Lec5_4.jpg"></p><ul><li>上图的客户端为传统的OLTP Data Silos，将数据发到Server - Data Warehouse(数据仓库)。Server端运行OLAP, 分析这些用户的信息。</li><li>ETL(Extract-Transform-Load)，将数据从来源端经过抽取extract、转换transform、加载load至目的端的过程。是一个常用在数据仓库的技术。Server短得到这些ETL后的数据，就可以运行OLAP Query或者数据挖掘等机器学习算法。</li></ul><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/5.jpg" alt="Lec5_5.jpg"></p><ul><li>上图的客户端有HTAP， 即客户端中运行TP和AP，再将在客户端中处理过的数据ETL至Server - Data Warehouse。</li></ul><p><br></p><p><img data-src="/images/CMU1544564/Lec04/53.jpg" alt="53.jpg"></p><p><img data-src="/images/CMU1544564/Lec04/54.jpg" alt="54.jpg"> </p><p>引用:</p><p><a name="fn1">1</a>: Database Storage - fxjwind: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9wLzEwODE4ODE0Lmh0bWw=" title="https://www.cnblogs.com/fxjwind/p/10818814.html">https://www.cnblogs.com/fxjwind/p/10818814.html<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Database Storage Part II - 数据库存储  II&lt;/p&gt;
&lt;p&gt;Slide: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA0LXN0b3JhZ2UyLnBkZg==&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/slides/04-storage2.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/slides/04-storage2.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;Note: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDQtc3RvcmFnZTIucGRm&quot; title=&quot;https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf&quot;&gt;https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;这节两课，我们会学习数据库内部的存储。&lt;/p&gt;
&lt;p&gt;Database Storage 在CMU分成了两部分，在两节课中讲。这是第二部分。&lt;/p&gt;
&lt;p&gt;这部分设涉及基础数据类型的表示, OLAP, OLTP, HTAP, row-store (NSM), column store(DSM) 等等。&lt;/p&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Storage" scheme="https://cakebytheoceanluo.github.io/categories/Storage/"/>
    
      <category term="Disk Management" scheme="https://cakebytheoceanluo.github.io/categories/Disk-Management/"/>
    
    
      <category term="N-ary Storage Model" scheme="https://cakebytheoceanluo.github.io/tags/N-ary-Storage-Model/"/>
    
      <category term="Decomposition Storage Model" scheme="https://cakebytheoceanluo.github.io/tags/Decomposition-Storage-Model/"/>
    
      <category term="OLAP" scheme="https://cakebytheoceanluo.github.io/tags/OLAP/"/>
    
      <category term="OLTP" scheme="https://cakebytheoceanluo.github.io/tags/OLTP/"/>
    
      <category term="HTAP" scheme="https://cakebytheoceanluo.github.io/tags/HTAP/"/>
    
      <category term="Variable Precision Numbers" scheme="https://cakebytheoceanluo.github.io/tags/Variable-Precision-Numbers/"/>
    
      <category term="Fixed Precision Numbers" scheme="https://cakebytheoceanluo.github.io/tags/Fixed-Precision-Numbers/"/>
    
  </entry>
  
  <entry>
    <title>[DBMS]Postgres 浮点数，定点数 精度问题precision_numbers</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/</id>
    <published>2020-03-16T13:06:32.000Z</published>
    <updated>2020-03-17T18:48:20.178Z</updated>
    
    <content type="html"><![CDATA[<p>这篇文章服务于<a href="https://cakebytheoceanluo.github.io/2020/03/16/CMU-15445-Lec04/">[CMU-15445]Lec04</a></p><p>数据库中给小数(分数)有两种类型</p><ul><li>Variable Precision Numbers: 可变精度数字，可能有会rounding error</li><li>Fixed Precision Numbers: 定精度数字，在给定的精度下没有误差</li></ul><p>我们今天来看一看PostgreSQL中的这两种类型和它们可能产生的误差。</p><p>PostgreSQL中具体对应的数据类型是:</p><ul><li>Variable Precision Numbers: <code>REAL</code></li><li>Fixed Precision Numbers: <code>DECIMAL(precision, scale), NUMERIC(precision, scale)</code></li></ul><hr><p><code>DECIMAL(precision, scale)</code>:</p><ul><li><code>precision</code>: The <code>precision</code> must be positive. The <code>precision</code> of a <em>numeric</em> is the total count of significant digits in the whole number, that is, the number of digits to both sides of the decimal point.</li><li><code>scale</code>: The <code>scale</code> must be zero or positive.   The <code>scale</code> of a <em>numeric</em> is the count of decimal digits in the fractional part, to the right of the decimal point</li></ul><p>So the number 23.5141 has a precision of 6 and a scale of 4. Integers can be considered to have a scale of zero.</p><p>以上引用自: <span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjEvZGF0YXR5cGUtbnVtZXJpYy5odG1s" title="https://www.postgresql.org/docs/9.1/datatype-numeric.html">https://www.postgresql.org/docs/9.1/datatype-numeric.html<i class="fa fa-external-link"></i></span></p><a id="more"></a><hr><h1 id="数据集"><a href="#数据集" class="headerlink" title="数据集"></a>数据集</h1><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec04/data_csv.png" alt="num_range"></p><p>上图为CMU-15445-Lec04课上的截图，内容是<code>data.csv</code>。实际上这只是一个随机生成的文件:</p><ul><li>一共10000000行</li><li>每行有两个数字，由<code>,</code>分隔开，每个数字是100以内的小数，并有6位小数部分</li></ul><h2 id="数据集faker"><a href="#数据集faker" class="headerlink" title="数据集faker"></a>数据集faker</h2><p>我用python写了一个类似的数据集faker:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">    print(<span class="string">f'<span class="subst">{float(Decimal(random.randrange(<span class="number">0</span>, <span class="number">100000000</span>) / <span class="number">1000000</span>))}</span>,<span class="subst">{float(Decimal(random.randrange(<span class="number">0</span>, <span class="number">100000000</span>) / <span class="number">1000000</span>))}</span>'</span>)</span><br></pre></td></tr></tbody></table></figure><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>下载: <a href="https://cakebytheoceanluo.github.io/download/CMU15445/lec04_float_faker.py">lec04_float_faker.py</a></p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>使用:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./lec04_float_faker.py &gt; data.csv</span><br></pre></td></tr></tbody></table></figure><p>到现在我们获得了<code>data.csv</code>这个文件:</p><h2 id="数据集文件"><a href="#数据集文件" class="headerlink" title="数据集文件"></a>数据集文件</h2><p>我展示一些数据集文件信息：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ file data.csv </span><br><span class="line">data.csv: ASCII text</span><br><span class="line"></span><br><span class="line">$ ll data.csv</span><br><span class="line">-rw-rw-r-- 1 jigao jigao 195777640 Mar 11 19:17 data.csv</span><br><span class="line"></span><br><span class="line">$ shuf -n 5 data.csv </span><br><span class="line">66.798295,30.742821</span><br><span class="line">51.166558,51.72633</span><br><span class="line">87.780032,67.175637</span><br><span class="line">25.172411,70.619547</span><br><span class="line">12.432782,9.736797</span><br><span class="line"></span><br><span class="line">$ shuf -n 5 data.csv </span><br><span class="line">23.496402,68.946932</span><br><span class="line">6.035276,55.565444</span><br><span class="line">80.652459,83.420552</span><br><span class="line">69.633828,75.871921</span><br><span class="line">3.157022,43.588741</span><br></pre></td></tr></tbody></table></figure><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">testdb=# drop table <span class="keyword">if</span> <span class="built_in">exists</span> testreals;</span><br><span class="line">DROP TABLE</span><br><span class="line"></span><br><span class="line">testdb=# drop table <span class="keyword">if</span> <span class="built_in">exists</span> testdecimals;</span><br><span class="line">DROP TABLE</span><br><span class="line"></span><br><span class="line">testdb=# create table testreals (a REAL <span class="keyword">not</span> null, b REAL <span class="keyword">not</span> null);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">testdb=# create table testdecimals (a DECIMAL(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> null, b DECIMAL(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> null);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">testdb=# copy testreals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">COPY <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line">testdb=# copy testdecimals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">COPY <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line">testdb=# \timing</span><br><span class="line">Timing is on.</span><br><span class="line"></span><br><span class="line">testdb=# <span class="built_in">set</span> max_parallel_workers_per_gather = <span class="number">0</span>;</span><br><span class="line">SET</span><br></pre></td></tr></tbody></table></figure><ul><li><code>testreals</code>: Variable Precision Numbers, <code>REAL</code></li><li><code>testdecimals</code>: Fixed Precision Numbers, <code>DECIMAL(10, 6)</code></li><li><code>\timing</code>: 打开计时器</li><li><code>set max_parallel_workers_per_gather = 0;</code>: <span class="exturl" data-url="aHR0cHM6Ly9kYmEuc3RhY2tleGNoYW5nZS5jb20vcXVlc3Rpb25zLzIyNjY1NC9ob3ctY2FuLWktZGlzYWJsZS1wYXJhbGxlbC1xdWVyaWVzLWluLXBvc3RncmVzcWw=" title="https://dba.stackexchange.com/questions/226654/how-can-i-disable-parallel-queries-in-postgresql">取消并行的query执行<i class="fa fa-external-link"></i></span>, 因为我们想看single CPU performance</li></ul><h1 id="REAL表格"><a href="#REAL表格" class="headerlink" title="REAL表格"></a><code>REAL</code>表格</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select sum(a+b) from testreals;</span><br><span class="line">     sum     </span><br><span class="line">-------------</span><br><span class="line"> <span class="number">1.00012e+09</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">384.460</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# select sum(a+b) from testreals;</span><br><span class="line">     sum     </span><br><span class="line">-------------</span><br><span class="line"> <span class="number">1.00013e+09</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">386.714</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# select cast(sum(a+b) as decimal) from testreals;</span><br><span class="line">    sum     </span><br><span class="line">------------</span><br><span class="line"> <span class="number">1000120000</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">535.749</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# select cast(sum(a+b) as decimal) from testreals;</span><br><span class="line">    sum     </span><br><span class="line">------------</span><br><span class="line"> <span class="number">1000110000</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">943.324</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# explain select sum(a+b) from testreals;</span><br><span class="line">                                QUERY PLAN                                </span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>)</span><br><span class="line">   -&gt;  <span class="function">Seq Scan on <span class="title">testreals</span>  <span class="params">(cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">(<span class="number">2</span> rows)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">Time: 2.369 ms</span><br><span class="line"></span><br><span class="line">testdb=# explain analyze select sum(a+b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1598.636</span>.<span class="number">.1598</span><span class="number">.636</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   -&gt;  <span class="function">Seq Scan on <span class="title">testreals</span>  <span class="params">(cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>)</span> <span class="params">(actual time=<span class="number">0.036</span>.<span class="number">.705</span><span class="number">.511</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span></span></span><br><span class="line"> Planning time: 0.025 ms</span><br><span class="line"> Execution time: <span class="number">1598.656</span> ms</span><br><span class="line">(<span class="number">4</span> rows)</span><br></pre></td></tr></tbody></table></figure><ul><li>我们多次执行同一条指令<code>select sum(a+b) from testreals;</code>，前后有几率出现不一样的数值。这原因就是因为rounding error。同样的情况也出现在<code>select cast(sum(a+b) as decimal) from testreals;</code></li><li><code>explain &lt;sql&gt;</code>: 给出对应的query plan</li><li><code>explain analyze &lt;sql&gt;</code>: : 给出对应的query plan + 执行sql</li></ul><h1 id="DECIMAL表格"><a href="#DECIMAL表格" class="headerlink" title="DECIMAL表格"></a><code>DECIMAL</code>表格</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select sum(a+b) from testdecimals;</span><br><span class="line">        sum        </span><br><span class="line">-------------------</span><br><span class="line"> <span class="number">1000169047.417319</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1175.335</span> ms (<span class="number">00</span>:<span class="number">01.175</span>)</span><br><span class="line"></span><br><span class="line">testdb=# explain select sum(a+b) from testdecimals;</span><br><span class="line">                                            QUERY PLAN                                             </span><br><span class="line">---------------------------------------------------------------------------------------------------</span><br><span class="line"> <span class="function">Finalize <span class="title">Aggregate</span>  <span class="params">(cost=<span class="number">126949.30</span>.<span class="number">.126949</span><span class="number">.31</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">32</span>)</span></span></span><br><span class="line">   -&gt;  Gather  (cost=126949.08..126949.29 rows=2 width=32)</span><br><span class="line">         Workers Planned: <span class="number">2</span></span><br><span class="line">         -&gt;  <span class="function">Partial <span class="title">Aggregate</span>  <span class="params">(cost=<span class="number">125949.08</span>.<span class="number">.125949</span><span class="number">.09</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">32</span>)</span></span></span><br><span class="line">               -&gt;  Parallel Seq Scan on testdecimals  (cost=0.00..105116.05 rows=4166605 width=16)</span><br><span class="line">(<span class="number">5</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">0.295</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# explain analyze select sum(a+b) from testdecimals;</span><br><span class="line">                                                                     QUERY PLAN                                                                      </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> <span class="function">Finalize <span class="title">Aggregate</span>  <span class="params">(cost=<span class="number">126949.30</span>.<span class="number">.126949</span><span class="number">.31</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">32</span>)</span> <span class="params">(actual time=<span class="number">1382.202</span>.<span class="number">.1382</span><span class="number">.202</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span></span></span><br><span class="line">   -&gt;  Gather  (cost=126949.08..126949.29 rows=2 width=32) (actual time=1382.191..1384.527 rows=3 loops=1)</span><br><span class="line">         Workers Planned: <span class="number">2</span></span><br><span class="line">         Workers Launched: <span class="number">2</span></span><br><span class="line">         -&gt;  <span class="function">Partial <span class="title">Aggregate</span>  <span class="params">(cost=<span class="number">125949.08</span>.<span class="number">.125949</span><span class="number">.09</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">32</span>)</span> <span class="params">(actual time=<span class="number">1380.379</span>.<span class="number">.1380</span><span class="number">.379</span> rows=<span class="number">1</span> loops=<span class="number">3</span>)</span></span></span><br><span class="line">               -&gt;  Parallel Seq Scan on testdecimals  (cost=0.00..105116.05 rows=4166605 width=16) (actual time=0.023..310.259 rows=3333333 loops=3)</span><br><span class="line"> Planning time: <span class="number">0.034</span> ms</span><br><span class="line"> Execution time: <span class="number">1384.563</span> ms</span><br><span class="line">(<span class="number">8</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1384.835</span> ms (<span class="number">00</span>:<span class="number">01.385</span>)</span><br></pre></td></tr></tbody></table></figure><ul><li><code>select sum(a+b) from testdecimals;</code>无论我们执行多少次，出现的结果都是一样的。</li></ul><p>推荐阅读：</p><p>8.1. Numeric Types - Documentation of PostgreSQL 9.1: <span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjEvZGF0YXR5cGUtbnVtZXJpYy5odG1s" title="https://www.postgresql.org/docs/9.1/datatype-numeric.html">https://www.postgresql.org/docs/9.1/datatype-numeric.html<i class="fa fa-external-link"></i></span></p><p>How can I disable parallel queries in PostgreSQL? - Stackoverflow: <span class="exturl" data-url="aHR0cHM6Ly9kYmEuc3RhY2tleGNoYW5nZS5jb20vcXVlc3Rpb25zLzIyNjY1NC9ob3ctY2FuLWktZGlzYWJsZS1wYXJhbGxlbC1xdWVyaWVzLWluLXBvc3RncmVzcWw=" title="https://dba.stackexchange.com/questions/226654/how-can-i-disable-parallel-queries-in-postgresql">https://dba.stackexchange.com/questions/226654/how-can-i-disable-parallel-queries-in-postgresql<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这篇文章服务于&lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/16/CMU-15445-Lec04/&quot;&gt;[CMU-15445]Lec04&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;数据库中给小数(分数)有两种类型&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Variable Precision Numbers: 可变精度数字，可能有会rounding error&lt;/li&gt;
&lt;li&gt;Fixed Precision Numbers: 定精度数字，在给定的精度下没有误差&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们今天来看一看PostgreSQL中的这两种类型和它们可能产生的误差。&lt;/p&gt;
&lt;p&gt;PostgreSQL中具体对应的数据类型是:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Variable Precision Numbers: &lt;code&gt;REAL&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Fixed Precision Numbers: &lt;code&gt;DECIMAL(precision, scale), NUMERIC(precision, scale)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;p&gt;&lt;code&gt;DECIMAL(precision, scale)&lt;/code&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;precision&lt;/code&gt;: The &lt;code&gt;precision&lt;/code&gt; must be positive. The &lt;code&gt;precision&lt;/code&gt; of a &lt;em&gt;numeric&lt;/em&gt; is the total count of significant digits in the whole number, that is, the number of digits to both sides of the decimal point.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;scale&lt;/code&gt;: The &lt;code&gt;scale&lt;/code&gt; must be zero or positive.   The &lt;code&gt;scale&lt;/code&gt; of a &lt;em&gt;numeric&lt;/em&gt; is the count of decimal digits in the fractional part, to the right of the decimal point&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So the number 23.5141 has a precision of 6 and a scale of 4. Integers can be considered to have a scale of zero.&lt;/p&gt;
&lt;p&gt;以上引用自: &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjEvZGF0YXR5cGUtbnVtZXJpYy5odG1s&quot; title=&quot;https://www.postgresql.org/docs/9.1/datatype-numeric.html&quot;&gt;https://www.postgresql.org/docs/9.1/datatype-numeric.html&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="CMU-15445" scheme="https://cakebytheoceanluo.github.io/categories/CMU-15445/"/>
    
      <category term="Storage" scheme="https://cakebytheoceanluo.github.io/categories/Storage/"/>
    
      <category term="DBMS" scheme="https://cakebytheoceanluo.github.io/categories/DBMS/"/>
    
      <category term="Disk Management" scheme="https://cakebytheoceanluo.github.io/categories/Disk-Management/"/>
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>[DBMS]PostgreSQL导入数据集</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/</id>
    <published>2020-03-15T19:28:22.000Z</published>
    <updated>2020-03-31T17:49:03.952Z</updated>
    
    <content type="html"><![CDATA[<p>本文介绍了几种数据集，以及导入它们到PostgreSQL的方法，另外也提了一下如何查看数据集信息的命令。这些数据集都会在我的博客中<a href="https://cakebytheoceanluo.github.io/categories/SQL/">SQL 初级/中级/高级部分</a>出现。</p><h1 id="查看数据集信息的命令"><a href="#查看数据集信息的命令" class="headerlink" title="查看数据集信息的命令"></a>查看数据集信息的命令</h1><p>我们可以在psql环境中输入：</p><ul><li><code>\d;</code>, <code>\d+;</code> 可以查看当前数据库中的表格</li><li><code>\d &lt;table_name&gt;;</code>, <code>\d+ &lt;table_name&gt;;</code>: 可以查看对应表格的schema</li></ul><p><br></p><p>另外我们也可以在<strong>命令行</strong>中输入：</p><ul><li><code>psql -d testdb -c '\d'</code></li><li><code>psql -d testdb -c '\d+'</code></li><li><code>psql -d testdb -c '\d &lt;table_name&gt;'</code></li><li><code>psql -d testdb -c '\d+ &lt;table_name&gt;'</code></li></ul><p>另外有关PostgreSQL的安装和配置见我的另外一篇文章: <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">[DBMS] PostgreSQL 安装与配置</a></p><a id="more"></a><h1 id="数据集"><a href="#数据集" class="headerlink" title="数据集"></a>数据集</h1><h2 id="TUM-Uni数据集"><a href="#TUM-Uni数据集" class="headerlink" title="TUM Uni数据集"></a>TUM Uni数据集</h2><p><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p><p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p><p>Schma来自<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>的课件和书。是一个很小的数据集， 关于学生教授大学课程考试等等表格。这个数据集很适合用来学习，练习SQL。我对这个数据集写了很多文章，提供SQL的练习，大家可以去<span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAyMTYxODQ2MQ==" title="https://segmentfault.com/a/1190000021618461">我的专栏目录<i class="fa fa-external-link"></i></span>去寻找。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql</span><br><span class="line">$ psql testdb &lt; uni_mysql.sql</span><br><span class="line">$ psql testdb <span class="comment"># 然后我们就进入这个testdb，可以对这些表格进行操作了。</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                        List of relations</span><br><span class="line"> Schema |     Name     | Type  | Owner |    Size    | Description </span><br><span class="line">--------+--------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | assistenten  | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | hoeren       | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | professoren  | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | pruefen      | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | studenten    | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | voraussetzen | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | vorlesungen  | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line">(<span class="number">7</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ studenten;</span><br><span class="line">                                         Table <span class="string">"public.studenten"</span></span><br><span class="line">  Column  |         Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">----------+-----------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> matrnr   | integer               |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> name     | character varying(30) |           | not null |         | extended |              | </span><br><span class="line"> semester | integer               |           |          |         | plain    |              | </span><br><span class="line">Indexes:</span><br><span class="line">    <span class="string">"studenten_pkey"</span> PRIMARY KEY, btree (matrnr)</span><br><span class="line">Referenced by:</span><br><span class="line">    TABLE <span class="string">"hoeren"</span> CONSTRAINT <span class="string">"hoeren_matrnr_fkey"</span> <span class="function">FOREIGN <span class="title">KEY</span> <span class="params">(matrnr)</span> REFERENCES <span class="title">studenten</span><span class="params">(matrnr)</span> ON DELETE CASCADE</span></span><br><span class="line">    TABLE "pruefen" CONSTRAINT "pruefen_matrnr_fkey" FOREIGN KEY (matrnr) REFERENCES studenten(matrnr) ON DELETE CASCADE</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="TUM-十项全能比赛数据集"><a href="#TUM-十项全能比赛数据集" class="headerlink" title="TUM 十项全能比赛数据集"></a>TUM 十项全能比赛数据集</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vc3FsX3plaG5rYW1wZl9kaXN6aXBsaW4uc3FsP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/grundlagen/sql_zehnkampf_disziplin.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/sql_zehnkampf_disziplin.sql?lang=de<i class="fa fa-external-link"></i></span></p><p>这里我把schema改写成英文：<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> ZehnkampfD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ZehnkampfD (</span><br><span class="line">    <span class="keyword">Name</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    Discipline <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    points <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ZehnkampfD <span class="keyword">values</span></span><br><span class="line">    (<span class="string">'Bolt'</span>,        <span class="string">'100m'</span>,         <span class="number">50</span>),</span><br><span class="line">    (<span class="string">'Bolt'</span>,        <span class="string">'Weitsprung'</span>,   <span class="number">50</span>),</span><br><span class="line">    (<span class="string">'Eaton'</span>,       <span class="string">'100m'</span>,         <span class="number">40</span>),</span><br><span class="line">    (<span class="string">'Eaton'</span>,       <span class="string">'Weitsprung'</span>,   <span class="number">60</span>),</span><br><span class="line">    (<span class="string">'Suarez'</span>,      <span class="string">'100m'</span>,         <span class="number">60</span>),</span><br><span class="line">    (<span class="string">'Suarez'</span>,      <span class="string">'Weitsprung'</span>,   <span class="number">60</span>),</span><br><span class="line">    (<span class="string">'Behrenbruch'</span>, <span class="string">'100m'</span>,         <span class="number">30</span>),</span><br><span class="line">    (<span class="string">'Behrenbruch'</span>, <span class="string">'Weitsprung'</span>,   <span class="number">50</span>)</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure><p></p><p>再把这几行写入文件<code>ZehnkampfD.sql</code>，载入数据库<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里testdb应该是另外一个新建的 没有载入数据的数据库</span></span><br><span class="line">$ psql testdb &lt; ZehnkampfD.sql</span><br><span class="line">$ psql testdb <span class="comment"># 然后我们就进入这个testdb，可以对这些表格进行操作了。</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                       List of relations</span><br><span class="line"> Schema |    Name    | Type  | Owner |    Size    | Description </span><br><span class="line">--------+------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | zehnkampfd | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ zehnkampfd;</span><br><span class="line">                                          Table <span class="string">"public.zehnkampfd"</span></span><br><span class="line">  Column   |          Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">-----------+------------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> name      | character varying(100) |           | not null |         | extended |              | </span><br><span class="line"> disziplin | character varying(100) |           | not null |         | extended |              | </span><br><span class="line"> punkte    | integer                |           | <span class="keyword">not</span> null |         | plain    |              |</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="TUM-公共交通数据集"><a href="#TUM-公共交通数据集" class="headerlink" title="TUM 公共交通数据集"></a>TUM 公共交通数据集</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vc3FsX2ZhaHJwbGFuLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/sql_fahrplan.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/sql_fahrplan.sql?lang=de<i class="fa fa-external-link"></i></span></p><p>这里我把schema改写成英文：<br></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> Fahrplan;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Fahrplan (</span><br><span class="line">    From_ <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    To_ <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    Line_ <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    depart <span class="built_in">TIME</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    arrival <span class="built_in">TIME</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Fahrplan <span class="keyword">values</span></span><br><span class="line">    (<span class="string">'Garching, Forschungszentrum'</span>,     <span class="string">'Garching'</span>,                     <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:06:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:09:00'</span>),</span><br><span class="line">    (<span class="string">'Garching'</span>,                        <span class="string">'Garching-Hochbrück'</span>,           <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:09:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:11:00'</span>),</span><br><span class="line">    (<span class="string">'Garching-Hochbrück'</span>,              <span class="string">'Fröttmaning'</span>,                  <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:11:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:15:00'</span>),</span><br><span class="line">    (<span class="string">'Garching'</span>,                        <span class="string">'Garching, Forschungszentrum'</span>,  <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:06:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:09:00'</span>),</span><br><span class="line">    (<span class="string">'Garching-Hochbrück'</span>,              <span class="string">'Garching'</span>,                     <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:04:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:06:00'</span>),</span><br><span class="line">    (<span class="string">'Fröttmaning'</span>,                     <span class="string">'Garching-Hochbrück'</span>,           <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:00:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:04:00'</span>),</span><br><span class="line">    (<span class="string">'Garching, Forschungszentrum'</span>,     <span class="string">'Technische Universität'</span>,       <span class="string">'690'</span>, <span class="built_in">TIME</span> <span class="string">'17:56:00'</span>, <span class="built_in">TIME</span> <span class="string">'17:57:00'</span>)</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure><p></p><p>再把这几行写入文件<code>Fahrplan.sql</code>，载入数据库<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里testdb应该是另外一个新建的 没有载入数据的数据库</span></span><br><span class="line">$ psql testdb &lt; Fahrplan.sql</span><br><span class="line">$ psql testdb <span class="comment"># 然后我们就进入这个testdb，可以对这些表格进行操作了。</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">testdb=# \d+;</span><br><span class="line">                      List of relations</span><br><span class="line"> Schema |   Name   | Type  | Owner |    Size    | Description </span><br><span class="line">--------+----------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | fahrplan | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ fahrplan;</span><br><span class="line">                                          Table <span class="string">"public.fahrplan"</span></span><br><span class="line"> Column  |          Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">---------+------------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> von     | character varying(100) |           | not null |         | extended |              | </span><br><span class="line"> nach    | character varying(100) |           | not null |         | extended |              | </span><br><span class="line"> linie   | character varying(10)  |           | not null |         | extended |              | </span><br><span class="line"> abfahrt | time without time zone |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> ankunft | time without time zone |           | <span class="keyword">not</span> null |         | plain    |              |</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="TPC-H"><a href="#TPC-H" class="headerlink" title="TPC-H"></a>TPC-H</h2><p>我单独写了一篇文章，见我的博客: <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS]PostgreSQL导入TPC-H数据集</a></p><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                        List of relations</span><br><span class="line"> Schema |     Name     | Type  | Owner |    Size    | Description </span><br><span class="line">--------+--------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | customer     | table | jigao | <span class="number">28</span> MB      | </span><br><span class="line"> <span class="keyword">public</span> | lineitem     | table | jigao | <span class="number">879</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | nation       | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | orders       | table | jigao | <span class="number">204</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | part         | table | jigao | <span class="number">32</span> MB      | </span><br><span class="line"> <span class="keyword">public</span> | partsupp     | table | jigao | <span class="number">136</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | region       | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | supplier     | table | jigao | <span class="number">1800</span> kB    | </span><br><span class="line">(<span class="number">8</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ customer;</span><br><span class="line">                                            Table <span class="string">"public.customer"</span></span><br><span class="line">    Column    |          Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">--------------+------------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> c_custkey    | integer                |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> c_name       | character varying(25)  |           | not null |         | extended |              | </span><br><span class="line"> c_address    | character varying(40)  |           | not null |         | extended |              | </span><br><span class="line"> c_nationkey  | integer                |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> c_phone      | character(<span class="number">15</span>)          |           | <span class="keyword">not</span> null |         | extended |              | </span><br><span class="line"> c_acctbal    | numeric(<span class="number">15</span>,<span class="number">2</span>)          |           | <span class="keyword">not</span> null |         | main     |              | </span><br><span class="line"> c_mktsegment | character(<span class="number">10</span>)          |           | <span class="keyword">not</span> null |         | extended |              | </span><br><span class="line"> c_comment    | character varying(117) |           | not null |         | extended |              |</span><br></pre></td></tr></tbody></table></figure><h2 id="IMDb-数据集"><a href="#IMDb-数据集" class="headerlink" title="IMDb 数据集"></a>IMDb 数据集</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxNzE4L2ZvdW5kYXRpb25zZGUvYWN0b3JzLmxpc3QueHo=" title="https://db.in.tum.de/teaching/ws1718/foundationsde/actors.list.xz">https://db.in.tum.de/teaching/ws1718/foundationsde/actors.list.xz<i class="fa fa-external-link"></i></span></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://db.in.tum.de/teaching/ws1718/foundationsde/actors.list.xz</span><br></pre></td></tr></tbody></table></figure><h3 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ unxz actors.list.xz </span><br><span class="line">$ awk <span class="string">'NR &gt;= 241 &amp;&amp; NR &lt;= 20494548'</span> actors.list &gt; actorsTrimmed.list</span><br><span class="line">$ iconv -f latin1 -t utf-8 actorsTrimmed.list &gt; actorsUtf8.list</span><br><span class="line">$ sed -r -e <span class="string">'s/\t+/|/g'</span> -e <span class="string">'s/((\s*)|(\{.*\})|(\[.*\])|(&lt;.*&gt;)|\(.*[a-zA-Z].*\))*$//g'</span> actorsUtf8.list | awk -F <span class="string">'|'</span>  <span class="string">'{if($1 != "") { actor = $1 }; if ($2) print actor "|" $2 }'</span> &gt; actors.csv</span><br></pre></td></tr></tbody></table></figure><h3 id="导入psql并建立索引"><a href="#导入psql并建立索引" class="headerlink" title="导入psql并建立索引"></a>导入psql并建立索引</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 这里testdb应该是另外一个新建的 没有载入数据的数据库</span><br><span class="line">$ psql testdb # 然后我们就进入这个testdb，可以对这些表格进行操作了。</span><br><span class="line"></span><br><span class="line">testdb=# create table playedin_text (actor_name <span class="built_in">text</span> <span class="keyword">not</span> null, movie_name <span class="built_in">text</span> <span class="keyword">not</span> null);</span><br><span class="line"></span><br><span class="line">testdb=# \copy playedin_text from actors.csv delimiter <span class="string">'|'</span>;</span><br><span class="line"></span><br><span class="line">testdb=# create table movies (id serial primary key , name <span class="built_in">text</span> <span class="keyword">not</span> null );</span><br><span class="line"></span><br><span class="line">testdb=# insert into movies ( name ) select distinct movie_name from playedin_text ;</span><br><span class="line"></span><br><span class="line">testdb=# create table actors (id serial primary key , name <span class="built_in">text</span> <span class="keyword">not</span> null );</span><br><span class="line"></span><br><span class="line">testdb=# insert into actors ( name ) select distinct actor_name from playedin_text ;</span><br><span class="line"></span><br><span class="line">testdb=# create table playedin ( movie integer references movies (id), actor integer references actors (id));</span><br><span class="line"></span><br><span class="line">testdb=# insert into playedin (actor , movie ) select actors.id , movies.id from actors, movies, playedin_text p where p.actor_name = actors.name <span class="keyword">and</span> p.movie_name = movies.name;</span><br><span class="line"></span><br><span class="line">testdb=# create index on playedin ( actor ); <span class="function">create index on <span class="title">playedin</span> <span class="params">( movie )</span></span>;</span><br><span class="line"></span><br><span class="line">testdb=# create index on playedin (actor); </span><br><span class="line"></span><br><span class="line">testdb=# create index on playedin (movie);</span><br></pre></td></tr></tbody></table></figure><h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                          List of relations</span><br><span class="line"> Schema |     Name      |   Type   | Owner |    Size    | Description </span><br><span class="line">--------+---------------+----------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | actors        | table    | jigao | <span class="number">98</span> MB      | </span><br><span class="line"> <span class="keyword">public</span> | actors_id_seq | sequence | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | movies        | table    | jigao | <span class="number">66</span> MB      | </span><br><span class="line"> <span class="keyword">public</span> | movies_id_seq | sequence | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | playedin      | table    | jigao | <span class="number">599</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | playedin_text | table    | jigao | <span class="number">1183</span> MB    | </span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d actors</span><br><span class="line">                            Table <span class="string">"public.actors"</span></span><br><span class="line"> Column |  Type   | Collation | Nullable |              Default               </span><br><span class="line">--------+---------+-----------+----------+------------------------------------</span><br><span class="line"> id     | integer |           | not null | nextval('actors_id_seq'::regclass)</span><br><span class="line"> name   | <span class="built_in">text</span>    |           | <span class="keyword">not</span> null | </span><br><span class="line">Indexes:</span><br><span class="line">    <span class="string">"actors_pkey"</span> PRIMARY KEY, btree (id)</span><br><span class="line">Referenced by:</span><br><span class="line">    TABLE <span class="string">"playedin"</span> CONSTRAINT <span class="string">"playedin_actor_fkey"</span> <span class="function">FOREIGN <span class="title">KEY</span> <span class="params">(actor)</span> REFERENCES <span class="title">actors</span><span class="params">(id)</span></span></span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="CMU-15445-歌手数据集"><a href="#CMU-15445-歌手数据集" class="headerlink" title="CMU-15445 歌手数据集"></a>CMU-15445 歌手数据集</h2><p>这个数据集在CMU-15445 Lec2 Advanced SQL中使用，见我的两篇博客笔记:</p><ul><li><a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part1/">[CMU-15445]Lec02_part1</a></li><li><a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/">[CMU-15445]Lec02_part2</a></li></ul><p><img data-src="/images/CMU1544564/Lec02/7.jpg" alt="7.jpg"></p><p>对应的SQL语句　<a href="https://cakebytheoceanluo.github.io/download/CMU15445/lec02_schema.sql">下载</a>：</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> student <span class="keyword">CASCADE</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> course <span class="keyword">CASCADE</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> enrolled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student </span><br><span class="line">   (<span class="keyword">sid</span> <span class="built_in">int</span> primary <span class="keyword">key</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">16</span>), </span><br><span class="line">    login <span class="built_in">varchar</span>(<span class="number">32</span>), </span><br><span class="line">    age <span class="built_in">smallint</span>, </span><br><span class="line">    gpa <span class="built_in">numeric</span>(<span class="number">2</span>, <span class="number">1</span>) <span class="keyword">check</span> (gpa <span class="keyword">between</span> <span class="number">0.0</span> <span class="keyword">and</span> <span class="number">4.0</span>)</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> course </span><br><span class="line">   (cid <span class="built_in">varchar</span>(<span class="number">32</span>) primary <span class="keyword">key</span>, </span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> enrolled </span><br><span class="line">   (<span class="keyword">sid</span> <span class="built_in">int</span> <span class="keyword">references</span> student (<span class="keyword">sid</span>) <span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">cascade</span>, </span><br><span class="line">    cid <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">references</span> course (cid) <span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">cascade</span>, </span><br><span class="line">    grade <span class="built_in">char</span>(<span class="number">1</span>) <span class="keyword">check</span> (grade <span class="keyword">in</span> (<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>)),</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">sid</span>, cid)</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (<span class="keyword">sid</span>, <span class="keyword">name</span>, login, age, gpa) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'Kanye'</span>, <span class="string">'kanye@cs'</span>, <span class="number">39</span>, <span class="number">4.0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (<span class="keyword">sid</span>, <span class="keyword">name</span>, login, age, gpa) <span class="keyword">values</span> (<span class="number">53688</span>, <span class="string">'Bieber'</span>, <span class="string">'jbieber@cs'</span>, <span class="number">22</span>, <span class="number">3.9</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (<span class="keyword">sid</span>, <span class="keyword">name</span>, login, age, gpa) <span class="keyword">values</span> (<span class="number">53655</span>, <span class="string">'Tupac'</span>, <span class="string">'shakur@cs'</span>, <span class="number">26</span>, <span class="number">3.5</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-445'</span>, <span class="string">'Database Systems'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-721'</span>, <span class="string">'Advanced Database Systems'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-826'</span>, <span class="string">'Data Mining'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-823'</span>, <span class="string">'Advanced Topics in Databases'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'15-445'</span>, <span class="string">'C'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53688</span>, <span class="string">'15-721'</span>, <span class="string">'A'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'15-826'</span>, <span class="string">'B'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53655</span>, <span class="string">'15-445'</span>, <span class="string">'B'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'15-721'</span>, <span class="string">'C'</span>);</span><br></pre></td></tr></tbody></table></figure><ul><li>可以在PostgreSQL, MySQL, SQLite中使用</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://cakebytheoceanluo.github.io/download/CMU15445/lec02_schema.sql</span><br><span class="line">$ psql testdb &lt; uni_mysql.sql</span><br><span class="line">$ psql testdb <span class="comment"># 然后我们就进入这个testdb，可以对这些表格进行操作了。</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                        List of relations</span><br><span class="line"> Schema |     Name     | Type  | Owner |    Size    | Description </span><br><span class="line">--------+--------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | course       | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | enrolled     | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | student      | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line">(<span class="number">3</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ enrolled</span><br><span class="line">                                         Table <span class="string">"public.enrolled"</span></span><br><span class="line"> Column |         Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">--------+-----------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> sid    | integer               |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> cid    | character varying(<span class="number">32</span>) |           | <span class="keyword">not</span> null |         | extended |              | </span><br><span class="line"> grade  | character(<span class="number">1</span>)          |           |          |         | extended |              | </span><br><span class="line">Indexes:</span><br><span class="line">    <span class="string">"enrolled_pkey"</span> PRIMARY KEY, btree (sid, cid)</span><br><span class="line">Check constraints:</span><br><span class="line">    <span class="string">"enrolled_grade_check"</span> CHECK (grade = ANY (ARRAY[<span class="string">'A'</span>::bpchar, <span class="string">'B'</span>::bpchar, <span class="string">'C'</span>::bpchar]))</span><br><span class="line">Foreign-key constraints:</span><br><span class="line">    <span class="string">"enrolled_cid_fkey"</span> FOREIGN KEY (cid) REFERENCES course(cid) ON DELETE CASCADE</span><br><span class="line">    <span class="string">"enrolled_sid_fkey"</span> FOREIGN KEY (sid) REFERENCES student(sid) ON DELETE CASCADE</span><br></pre></td></tr></tbody></table></figure><p><br></p><h2 id="CMU-15445-分数数据集-Mock"><a href="#CMU-15445-分数数据集-Mock" class="headerlink" title="CMU-15445 分数数据集 (Mock)"></a>CMU-15445 分数数据集 (Mock)</h2><p>更多关于这个数据集，见这个实验<a href="https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/">[DBMS] Postgres 精度问题 precision_numbers</a></p><p>这个实验服务于<a href="https://cakebytheoceanluo.github.io/2020/03/16/CMU-15445-Lec04/">[CMU-15445]Lec04</a></p><h3 id="数据集faker"><a href="#数据集faker" class="headerlink" title="数据集faker"></a>数据集faker</h3><p>我用python写了一个类似的数据集faker:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">    print(<span class="string">f'<span class="subst">{float(Decimal(random.randrange(<span class="number">0</span>, <span class="number">100000000</span>) / <span class="number">1000000</span>))}</span>,<span class="subst">{float(Decimal(random.randrange(<span class="number">0</span>, <span class="number">100000000</span>) / <span class="number">1000000</span>))}</span>'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h4><p>下载: <a href="https://cakebytheoceanluo.github.io/download/CMU15445/lec04_float_faker.py">lec04_float_faker.py</a></p><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>使用:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./lec04_float_faker.py &gt; data.csv</span><br></pre></td></tr></tbody></table></figure><p>到现在我们获得了<code>data.csv</code>这个文件:</p><h3 id="导入数据集"><a href="#导入数据集" class="headerlink" title="导入数据集"></a>导入数据集</h3><h4 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h4><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> testreals;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> testdecimals;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> testreals (a <span class="built_in">REAL</span> <span class="keyword">not</span> <span class="literal">null</span>, b <span class="built_in">REAL</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> testdecimals (a <span class="built_in">DECIMAL</span>(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> <span class="literal">null</span>, b <span class="built_in">DECIMAL</span>(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line">copy testreals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">copy testdecimals from '/tmp/data.csv' delimiter ',' csv;</span><br></pre></td></tr></tbody></table></figure><h4 id="输出例子"><a href="#输出例子" class="headerlink" title="输出例子"></a>输出例子</h4><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">testdb=# drop table <span class="keyword">if</span> <span class="built_in">exists</span> testreals;</span><br><span class="line">DROP TABLE</span><br><span class="line"></span><br><span class="line">testdb=# drop table <span class="keyword">if</span> <span class="built_in">exists</span> testdecimals;</span><br><span class="line">DROP TABLE</span><br><span class="line"></span><br><span class="line">testdb=# create table testreals (a REAL <span class="keyword">not</span> null, b REAL <span class="keyword">not</span> null);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">testdb=# create table testdecimals (a DECIMAL(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> null, b DECIMAL(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> null);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">testdb=# copy testreals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">COPY <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line">testdb=# copy testdecimals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">COPY <span class="number">10000000</span></span><br></pre></td></tr></tbody></table></figure><p><br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                        List of relations</span><br><span class="line"> Schema |     Name     | Type  | Owner |    Size    | Description </span><br><span class="line">--------+--------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | testdecimals | table | jigao | <span class="number">496</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | testreals    | table | jigao | <span class="number">346</span> MB     | </span><br><span class="line">(<span class="number">2</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ testreals </span><br><span class="line">                               Table <span class="string">"public.testreals"</span></span><br><span class="line"> Column | Type | Collation | Nullable | Default | Storage | Stats target | Description </span><br><span class="line">--------+------+-----------+----------+---------+---------+--------------+-------------</span><br><span class="line"> a      | real |           | <span class="keyword">not</span> null |         | plain   |              | </span><br><span class="line"> b      | real |           | <span class="keyword">not</span> null |         | plain   |              | </span><br><span class="line"></span><br><span class="line">testdb=# \d+ testdecimals </span><br><span class="line">                                  Table <span class="string">"public.testdecimals"</span></span><br><span class="line"> Column |     Type      | Collation | Nullable | Default | Storage | Stats target | Description </span><br><span class="line">--------+---------------+-----------+----------+---------+---------+--------------+-------------</span><br><span class="line"> a      | numeric(<span class="number">10</span>,<span class="number">6</span>) |           | <span class="keyword">not</span> null |         | main    |              | </span><br><span class="line"> b      | numeric(<span class="number">10</span>,<span class="number">6</span>) |           | <span class="keyword">not</span> null |         | main    |              |</span><br></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文介绍了几种数据集，以及导入它们到PostgreSQL的方法，另外也提了一下如何查看数据集信息的命令。这些数据集都会在我的博客中&lt;a href=&quot;https://cakebytheoceanluo.github.io/categories/SQL/&quot;&gt;SQL 初级/中级/高级部分&lt;/a&gt;出现。&lt;/p&gt;
&lt;h1 id=&quot;查看数据集信息的命令&quot;&gt;&lt;a href=&quot;#查看数据集信息的命令&quot; class=&quot;headerlink&quot; title=&quot;查看数据集信息的命令&quot;&gt;&lt;/a&gt;查看数据集信息的命令&lt;/h1&gt;&lt;p&gt;我们可以在psql环境中输入：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;\d;&lt;/code&gt;, &lt;code&gt;\d+;&lt;/code&gt; 可以查看当前数据库中的表格&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\d &amp;lt;table_name&amp;gt;;&lt;/code&gt;, &lt;code&gt;\d+ &amp;lt;table_name&amp;gt;;&lt;/code&gt;: 可以查看对应表格的schema&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;另外我们也可以在&lt;strong&gt;命令行&lt;/strong&gt;中输入：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;psql -d testdb -c &#39;\d&#39;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;psql -d testdb -c &#39;\d+&#39;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;psql -d testdb -c &#39;\d &amp;lt;table_name&amp;gt;&#39;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;psql -d testdb -c &#39;\d+ &amp;lt;table_name&amp;gt;&#39;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另外有关PostgreSQL的安装和配置见我的另外一篇文章: &lt;a href=&quot;https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/&quot;&gt;[DBMS] PostgreSQL 安装与配置&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="DBMS" scheme="https://cakebytheoceanluo.github.io/categories/DBMS/"/>
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>[DBMS]PostgreSQL导入TPC-H数据集</title>
    <link href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/"/>
    <id>https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/</id>
    <published>2020-03-15T17:51:21.000Z</published>
    <updated>2020-03-15T19:36:38.354Z</updated>
    
    <content type="html"><![CDATA[<p>本文关注如何将TPC-H数据集导入至PostgreSQL, 同时简单提一下如何生成TPC-H数据。</p><h1 id="TPC-H介绍"><a href="#TPC-H介绍" class="headerlink" title="TPC-H介绍"></a>TPC-H介绍</h1><blockquote><p>TPC-H is a Decision Support Benchmark. The TPC Benchmark™H (TPC-H) is a decision support benchmark. It consists of a suite of business oriented ad-hoc queries and concurrent data modifications. <sup><a href="#fn1">1</a></sup></p></blockquote><p>TPC-H是TPC协会提供的一个benchmark，用来模拟一个现实中的商业应用，且自带22个SQL Query。这22个Query均关注于OLAP分析型查询。<br>这些Query可以在如下的地方找到:</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLzJuZFF1YWRyYW50L3BnLXRwY2gvdHJlZS9tYXN0ZXIvcXVlcmllcw==" title="https://github.com/2ndQuadrant/pg-tpch/tree/master/queries">https://github.com/2ndQuadrant/pg-tpch/tree/master/queries<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbCM=" title="https://hyper-db.de/interface.html#">https://hyper-db.de/interface.html#<i class="fa fa-external-link"></i></span> 点击右下角Insert TPC-H Query</li><li><span class="exturl" data-url="aHR0cHM6Ly91bWJyYS5kYi5pbi50dW0uZGUvaW50ZXJmYWNlLw==" title="https://umbra.db.in.tum.de/interface/">https://umbra.db.in.tum.de/interface/<i class="fa fa-external-link"></i></span>　点击Load Query</li></ul><p>有一篇论文具体讲每一个TPC-H的Query，实际上和本文无关，我链接在这里：　<span class="exturl" data-url="aHR0cHM6Ly9ob21lcGFnZXMuY3dpLm5sL35ib25jei9zbmItY2hhbGxlbmdlL2Nob2tlcG9pbnRzLXRwY3RjLnBkZg==" title="https://homepages.cwi.nl/~boncz/snb-challenge/chokepoints-tpctc.pdf">TPC-H Analyzed: Hidden Messages and Lessons Learned from an Influential Benchmark<i class="fa fa-external-link"></i></span></p><a id="more"></a><h1 id="TPC-H数据集"><a href="#TPC-H数据集" class="headerlink" title="TPC-H数据集"></a>TPC-H数据集</h1><p>我们可以手动生成TPC-H是数据集，常常成为<strong>synthetic dataset</strong>, 人工生成的数据集。</p><p>我们使用这个工具：　<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VsZWN0cnVtL3RwY2gtZGJnZW4=" title="https://github.com/electrum/tpch-dbgen">https://github.com/electrum/tpch-dbgen<i class="fa fa-external-link"></i></span></p><p>使用方法是：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git@github.com:electrum/tpch-dbgen.git</span><br><span class="line">Cloning into <span class="string">'tpch-dbgen'</span>...</span><br><span class="line">remote: Enumerating objects: 149, <span class="keyword">done</span>.</span><br><span class="line">remote: Total 149 (delta 0), reused 0 (delta 0), pack-reused 149</span><br><span class="line">Receiving objects: 100% (149/149), 214.31 KiB | 637.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Resolving deltas: 100% (34/34), <span class="keyword">done</span>.</span><br><span class="line">$ <span class="built_in">cd</span> tpch-dbgen/</span><br><span class="line">$ make</span><br><span class="line"><span class="comment">## make 的输出我全部删去了</span></span><br><span class="line">$ ./dbgen</span><br><span class="line">TPC-H Population Generator (Version 2.14.0)</span><br><span class="line">Copyright Transaction Processing Performance Council 1994 - 2010</span><br><span class="line">$ ls | grep <span class="string">'.*.tbl'</span></span><br><span class="line">customer.tbl</span><br><span class="line">lineitem.tbl</span><br><span class="line">nation.tbl</span><br><span class="line">orders.tbl</span><br><span class="line">partsupp.tbl</span><br><span class="line">part.tbl</span><br><span class="line">region.tbl</span><br><span class="line">supplier.tbl</span><br></pre></td></tr></tbody></table></figure><p>我们看到最后生成了8个<code>.tbl</code>文件，它们就是TPC-H的8个表格(a.k.a关系)。另外我这里生成的是TPC-H scale factor=1的数据集，即它的伸缩系数是１，生成的数据大概是1GiB左右。我们还可以在生成数据的时候调整这这scale factor(sf)，比如当它为10的时候，生成的数据大概是10GiB左右。另外我们也可以在生成的时候去特定生成一张表格。这些情况都可以在，　<code>dbgen</code>这个程序中通过参数确定，这里也不再详细说了。</p><h2 id="dbgen的各种参数-可略读浏览"><a href="#dbgen的各种参数-可略读浏览" class="headerlink" title="dbgen的各种参数 (可略读浏览)"></a><code>dbgen</code>的各种参数 (可略读浏览)</h2><p>详见：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ ./dbgen --<span class="built_in">help</span></span><br><span class="line">./dbgen: invalid option -- <span class="string">'-'</span></span><br><span class="line">ERROR: option <span class="string">'-'</span> unknown.</span><br><span class="line">TPC-H Population Generator (Version 2.14.0 build 0)</span><br><span class="line">Copyright Transaction Processing Performance Council 1994 - 2010</span><br><span class="line">USAGE:</span><br><span class="line">dbgen [-{vf}][-T {pcsoPSOL}]</span><br><span class="line">[-s &lt;scale&gt;][-C &lt;procs&gt;][-S &lt;step&gt;]</span><br><span class="line">dbgen [-v] [-O m] [-s &lt;scale&gt;] [-U &lt;updates&gt;]</span><br><span class="line"></span><br><span class="line">Basic Options</span><br><span class="line">===========================</span><br><span class="line">-C &lt;n&gt; -- separate data <span class="built_in">set</span> into &lt;n&gt; chunks (requires -S, default: 1)</span><br><span class="line">-f     -- force. Overwrite existing files</span><br><span class="line">-h     -- display this message</span><br><span class="line">-q     -- <span class="built_in">enable</span> QUIET mode</span><br><span class="line">-s &lt;n&gt; -- <span class="built_in">set</span> Scale Factor (SF) to  &lt;n&gt; (default: 1) </span><br><span class="line">-S &lt;n&gt; -- build the &lt;n&gt;th step of the data/update <span class="built_in">set</span> (used with -C or -U)</span><br><span class="line">-U &lt;n&gt; -- generate &lt;n&gt; update sets</span><br><span class="line">-v     -- <span class="built_in">enable</span> VERBOSE mode</span><br><span class="line"></span><br><span class="line">Advanced Options</span><br><span class="line">===========================</span><br><span class="line">-b &lt;s&gt; -- load distributions <span class="keyword">for</span> &lt;s&gt; (default: dists.dss)</span><br><span class="line">-d &lt;n&gt; -- split deletes between &lt;n&gt; files (requires -U)</span><br><span class="line">-i &lt;n&gt; -- split inserts between &lt;n&gt; files (requires -U)</span><br><span class="line">-T c   -- generate cutomers ONLY</span><br><span class="line">-T l   -- generate nation/region ONLY</span><br><span class="line">-T L   -- generate lineitem ONLY</span><br><span class="line">-T n   -- generate nation ONLY</span><br><span class="line">-T o   -- generate orders/lineitem ONLY</span><br><span class="line">-T O   -- generate orders ONLY</span><br><span class="line">-T p   -- generate parts/partsupp ONLY</span><br><span class="line">-T P   -- generate parts ONLY</span><br><span class="line">-T r   -- generate region ONLY</span><br><span class="line">-T s   -- generate suppliers ONLY</span><br><span class="line">-T S   -- generate partsupp ONLY</span><br><span class="line"></span><br><span class="line">To generate the SF=1 (1GB), validation database population, use:</span><br><span class="line">dbgen -vf -s 1</span><br><span class="line"></span><br><span class="line">To generate updates <span class="keyword">for</span> a SF=1 (1GB), use:</span><br><span class="line">dbgen -v -U 1 -s 1</span><br></pre></td></tr></tbody></table></figure><h2 id="另外可替代生成的工具"><a href="#另外可替代生成的工具" class="headerlink" title="另外可替代生成的工具"></a>另外可替代生成的工具</h2><p>当然也有其他工具可以生成这个数据集，　比如: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dyZWdyYWhuL3RwY2gta2l0" title="https://github.com/gregrahn/tpch-kit">https://github.com/gregrahn/tpch-kit<i class="fa fa-external-link"></i></span>　。但是我们不在这篇文章中赘述。</p><p><br><br><br></p><h1 id="PostgreSQL准备"><a href="#PostgreSQL准备" class="headerlink" title="PostgreSQL准备"></a>PostgreSQL准备</h1><h2 id="新建数据库"><a href="#新建数据库" class="headerlink" title="新建数据库"></a>新建数据库</h2><p>PostgreSQL具体操作详见我的另一篇文章: <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E5%BA%93">[DBMS] PostgreSQL 安装与配置 - 新建一个用户数据库</a></p><p>这里我就展示我的命令和输出例子，在你的环境也大同小异。</p><h3 id="新建数据库命令"><a href="#新建数据库命令" class="headerlink" title="新建数据库命令"></a>新建数据库命令</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres psql</span><br><span class="line">postgres=# CREATE DATABASE tpch;</span><br><span class="line">postgres=# GRANT ALL ON DATABASE tpch to &lt;我们之前创建的用户名 不带尖角括号&gt;;</span><br></pre></td></tr></tbody></table></figure><h3 id="输出例子"><a href="#输出例子" class="headerlink" title="输出例子"></a>输出例子</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres psql</span><br><span class="line">[sudo] password <span class="keyword">for</span> jigao: </span><br><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">postgres=# CREATE DATABASE tpch_sf1;</span><br><span class="line">CREATE DATABASE</span><br><span class="line">postgres=#  GRANT ALL ON DATABASE tpch_sf1 to jigao;</span><br><span class="line">GRANT</span><br><span class="line">postgres=# \q</span><br></pre></td></tr></tbody></table></figure><h2 id="新建表格"><a href="#新建表格" class="headerlink" title="新建表格"></a>新建表格</h2><p>这里需要用到<code>tpch-dbgen/dss.ddl</code>这个文件，它就在和我们刚刚<code>dbgen</code>程序同一个文件，也可以在repo中找到：　<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VsZWN0cnVtL3RwY2gtZGJnZW4vYmxvYi9tYXN0ZXIvZHNzLmRkbA==" title="https://github.com/electrum/tpch-dbgen/blob/master/dss.ddl">https://github.com/electrum/tpch-dbgen/blob/master/dss.ddl<i class="fa fa-external-link"></i></span></p><h3 id="新建表格命令"><a href="#新建表格命令" class="headerlink" title="新建表格命令"></a>新建表格命令</h3><p><code>$ psql -d tpch_sf1 &lt; dss.ddl</code></p><h3 id="输出例子-1"><a href="#输出例子-1" class="headerlink" title="输出例子"></a>输出例子</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ file dss.ddl</span><br><span class="line">dss.ddl: ASCII text</span><br><span class="line">$ psql tpch_sf1 &lt; dss.ddl </span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br></pre></td></tr></tbody></table></figure><h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d tpch_sf1 -c <span class="string">'\dt+'</span></span><br><span class="line">                      List of relations</span><br><span class="line"> Schema |   Name   | Type  | Owner |  Size   | Description </span><br><span class="line">--------+----------+-------+-------+---------+-------------</span><br><span class="line"> public | customer | table | jigao | 0 bytes | </span><br><span class="line"> public | lineitem | table | jigao | 0 bytes | </span><br><span class="line"> public | nation   | table | jigao | 0 bytes | </span><br><span class="line"> public | orders   | table | jigao | 0 bytes | </span><br><span class="line"> public | part     | table | jigao | 0 bytes | </span><br><span class="line"> public | partsupp | table | jigao | 0 bytes | </span><br><span class="line"> public | region   | table | jigao | 0 bytes | </span><br><span class="line"> public | supplier | table | jigao | 0 bytes | </span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><ul><li>如果能看到上面的输出，那么这些表格已经被新建了。</li></ul><p><br></p><p><code>$man psql</code>:</p><blockquote><pre><code>   -d dbname   -c command</code></pre></blockquote><h2 id="TPC-H-Schema"><a href="#TPC-H-Schema" class="headerlink" title="TPC-H Schema"></a>TPC-H Schema</h2><p>ddl即Data Definition Language 数据定义语言, 也是就是TPC-H中表格的架构和相互关系。</p><p><img data-src="https://hyper-db.de/tpch.png" alt="TPC-H Schema, Source: https://hyper-db.de/tpch.png"></p><p><br><br><br></p><h1 id="导入PostgreSQL-2"><a href="#导入PostgreSQL-2" class="headerlink" title="导入PostgreSQL 2"></a>导入PostgreSQL <sup><a href="#fn2">2</a></sup></h1><h2 id="导入命令"><a href="#导入命令" class="headerlink" title="导入命令"></a>导入命令</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ </span><br><span class="line">for i in `ls *.tbl`; do</span><br><span class="line">    echo $i;</span><br><span class="line">    sed -i 's/|$//' *.tbl;</span><br><span class="line">    name=`echo $i| cut -d'.' -f1`;</span><br><span class="line">    psql -d tpch_sf1 -c "COPY $name FROM '`pwd`/$i' DELIMITER '|' ENCODING 'LATIN1';";</span><br><span class="line">done</span><br></pre></td></tr></tbody></table></figure><ul><li><code>sed -i 's/|$//' *.tbl;</code>: 对于每一个<code>.tbl</code>文件，将每一行最后的<code>|</code>去掉</li><li>因为psql会认为分隔符<code>|</code>后面还依然有数据。</li></ul><h2 id="输出例子-2"><a href="#输出例子-2" class="headerlink" title="输出例子"></a>输出例子</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> `ls *.tbl`; <span class="keyword">do</span></span><br><span class="line">&gt;     <span class="built_in">echo</span> <span class="variable">$i</span>;</span><br><span class="line">&gt;     sed -i <span class="string">'s/|$//'</span> *.tbl;</span><br><span class="line">&gt;     name=`<span class="built_in">echo</span> <span class="variable">$i</span>| cut -d<span class="string">'.'</span> -f1`;</span><br><span class="line">&gt;     psql -d tpch_sf1 -c <span class="string">"COPY <span class="variable">$name</span> FROM '`pwd`/<span class="variable">$i</span>' DELIMITER '|' ENCODING 'LATIN1';"</span>;</span><br><span class="line">&gt; <span class="keyword">done</span></span><br><span class="line">customer.tbl</span><br><span class="line">COPY 150000</span><br><span class="line">lineitem.tbl</span><br><span class="line">COPY 6001215</span><br><span class="line">nation.tbl</span><br><span class="line">COPY 25</span><br><span class="line">orders.tbl</span><br><span class="line">COPY 1500000</span><br><span class="line">partsupp.tbl</span><br><span class="line">COPY 800000</span><br><span class="line">part.tbl</span><br><span class="line">COPY 200000</span><br><span class="line">region.tbl</span><br><span class="line">COPY 5</span><br><span class="line">supplier.tbl</span><br><span class="line">COPY 1000</span><br></pre></td></tr></tbody></table></figure><h2 id="检查-1"><a href="#检查-1" class="headerlink" title="检查"></a>检查</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d tpch_sf1 -c <span class="string">'\dt+'</span></span><br><span class="line">                      List of relations</span><br><span class="line"> Schema |   Name   | Type  | Owner |    Size    | Description </span><br><span class="line">--------+----------+-------+-------+------------+-------------</span><br><span class="line"> public | customer | table | jigao | 28 MB      | </span><br><span class="line"> public | lineitem | table | jigao | 879 MB     | </span><br><span class="line"> public | nation   | table | jigao | 8192 bytes | </span><br><span class="line"> public | orders   | table | jigao | 204 MB     | </span><br><span class="line"> public | part     | table | jigao | 32 MB      | </span><br><span class="line"> public | partsupp | table | jigao | 136 MB     | </span><br><span class="line"> public | region   | table | jigao | 8192 bytes | </span><br><span class="line"> public | supplier | table | jigao | 1800 kB    | </span><br><span class="line">(8 rows)</span><br><span class="line"></span><br><span class="line">$ psql -d tpch_sf1  -c <span class="string">"select count(*) from lineitem"</span>;</span><br><span class="line">  count  </span><br><span class="line">---------</span><br><span class="line"> 6001215</span><br><span class="line">(1 row)r | table | jigao | 1800 kB    | </span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure><ul><li>如果能看到上面的输出，那么这些表格已经被载入了。</li></ul><h2 id="替代方式-Bash-Script"><a href="#替代方式-Bash-Script" class="headerlink" title="替代方式: Bash Script"></a>替代方式: Bash Script</h2><p>我将<a href="#导入命令">上面的导入数据命令</a>写成了一个bash script脚本: <a href="https://cakebytheoceanluo.github.io/download/dbms/psql_tpch_import.sh">下载</a></p><p><strong>注意我更改了带psql那行，这个脚本需要一个变量，即数据库的名字，在本文例子中是<code>tpch_sf1</code>，你当然可以在新建数据库的时候自行选择。</strong></p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ chmod +x psql_tpch_import.sh </span><br><span class="line">$ ./psql_tpch_import.sh tpch_sf1</span><br></pre></td></tr></tbody></table></figure><p><br><br><br></p><p>引用：</p><p><a name="fn1">1</a>: <span class="exturl" data-url="aHR0cDovL3d3dy50cGMub3JnL3RwY2gv" title="http://www.tpc.org/tpch/">http://www.tpc.org/tpch/<i class="fa fa-external-link"></i></span></p><p><a name="fn2">2</a>: TPCH on PostgreSQL - Xi Liang: <span class="exturl" data-url="aHR0cDovL3h0ci5haS9ibG9nLzIwMTktMDMtMTItdHBjaC8=" title="http://xtr.ai/blog/2019-03-12-tpch/">http://xtr.ai/blog/2019-03-12-tpch/<i class="fa fa-external-link"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VsZWN0cnVtL3RwY2gtZGJnZW4=" title="https://github.com/electrum/tpch-dbgen">https://github.com/electrum/tpch-dbgen<i class="fa fa-external-link"></i></span></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文关注如何将TPC-H数据集导入至PostgreSQL, 同时简单提一下如何生成TPC-H数据。&lt;/p&gt;
&lt;h1 id=&quot;TPC-H介绍&quot;&gt;&lt;a href=&quot;#TPC-H介绍&quot; class=&quot;headerlink&quot; title=&quot;TPC-H介绍&quot;&gt;&lt;/a&gt;TPC-H介绍&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;TPC-H is a Decision Support Benchmark. The TPC Benchmark™H (TPC-H) is a decision support benchmark. It consists of a suite of business oriented ad-hoc queries and concurrent data modifications. &lt;sup&gt;&lt;a href=&quot;#fn1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;TPC-H是TPC协会提供的一个benchmark，用来模拟一个现实中的商业应用，且自带22个SQL Query。这22个Query均关注于OLAP分析型查询。&lt;br&gt;这些Query可以在如下的地方找到:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9naXRodWIuY29tLzJuZFF1YWRyYW50L3BnLXRwY2gvdHJlZS9tYXN0ZXIvcXVlcmllcw==&quot; title=&quot;https://github.com/2ndQuadrant/pg-tpch/tree/master/queries&quot;&gt;https://github.com/2ndQuadrant/pg-tpch/tree/master/queries&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbCM=&quot; title=&quot;https://hyper-db.de/interface.html#&quot;&gt;https://hyper-db.de/interface.html#&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt; 点击右下角Insert TPC-H Query&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly91bWJyYS5kYi5pbi50dW0uZGUvaW50ZXJmYWNlLw==&quot; title=&quot;https://umbra.db.in.tum.de/interface/&quot;&gt;https://umbra.db.in.tum.de/interface/&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;　点击Load Query&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有一篇论文具体讲每一个TPC-H的Query，实际上和本文无关，我链接在这里：　&lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cHM6Ly9ob21lcGFnZXMuY3dpLm5sL35ib25jei9zbmItY2hhbGxlbmdlL2Nob2tlcG9pbnRzLXRwY3RjLnBkZg==&quot; title=&quot;https://homepages.cwi.nl/~boncz/snb-challenge/chokepoints-tpctc.pdf&quot;&gt;TPC-H Analyzed: Hidden Messages and Lessons Learned from an Influential Benchmark&lt;i class=&quot;fa fa-external-link&quot;&gt;&lt;/i&gt;&lt;/span&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="DBMS" scheme="https://cakebytheoceanluo.github.io/categories/DBMS/"/>
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://cakebytheoceanluo.github.io/tags/PostgreSQL/"/>
    
      <category term="TPC-H" scheme="https://cakebytheoceanluo.github.io/tags/TPC-H/"/>
    
  </entry>
  
</feed>
