<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="google-site-verification" content="ttc5vA8Af6vd2hXb70GjZI6v_4fuOJtjeIekoyhEbhw" />
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.svg">
  <link rel="mask-icon" href="/images/favicon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cakebytheoceanluo.github.io","root":"/","scheme":"Pisces","version":"7.7.2","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="题目我摘抄题目的重点:  Your table needs to automatically grow in size as needed but you do not need shrink it. That is, you do not need to implement support for shrinking or compacting the hash table.  Check ou">
<meta property="og:type" content="article">
<meta property="og:title" content="[CMU-15445]17_18_Project1_1">
<meta property="og:url" content="https://cakebytheoceanluo.github.io/2020/04/17/CMU-15445-17-18-Project1-1/index.html">
<meta property="og:site_name" content="关于数据库的一切">
<meta property="og:description" content="题目我摘抄题目的重点:  Your table needs to automatically grow in size as needed but you do not need shrink it. That is, you do not need to implement support for shrinking or compacting the hash table.  Check ou">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_1.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_2.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_3.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_4.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_5.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_1.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_6.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_7.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_8.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_9.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_10.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_11.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_12.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_13.png">
<meta property="og:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec07/18.jpg">
<meta property="article:published_time" content="2020-04-17T14:11:06.000Z">
<meta property="article:modified_time" content="2020-08-17T12:40:59.844Z">
<meta property="article:author" content="罗济高">
<meta property="article:tag" content="Dynamic Hashing Scheme">
<meta property="article:tag" content="Extendible Hashing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_1.png">

<link rel="canonical" href="https://cakebytheoceanluo.github.io/2020/04/17/CMU-15445-17-18-Project1-1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>[CMU-15445]17_18_Project1_1 | 关于数据库的一切</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?bff369b4d0627249d230e2ae930016fc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="关于数据库的一切" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">关于数据库的一切</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">罗济高的博客</h1>
      
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-fw fa-heartbeat"></i>公益 404</a>

  </li>
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">61</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">25</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">87</span></a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nha2VieXRoZW9jZWFuTHVv" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cakebytheoceanluo.github.io/2020/04/17/CMU-15445-17-18-Project1-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
      <meta itemprop="name" content="罗济高">
      <meta itemprop="description" content="In theory, there is no difference between theory and practice. But, in practice, there is.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关于数据库的一切">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          [CMU-15445]17_18_Project1_1
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-17 16:11:06" itemprop="dateCreated datePublished" datetime="2020-04-17T16:11:06+02:00">2020-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-17 14:40:59" itemprop="dateModified" datetime="2020-08-17T14:40:59+02:00">2020-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CMU-15445/" itemprop="url" rel="index"><span itemprop="name">CMU-15445</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Structure/" itemprop="url" rel="index"><span itemprop="name">Data Structure</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Access-Methods/" itemprop="url" rel="index"><span itemprop="name">Access Methods</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hash-Table/" itemprop="url" rel="index"><span itemprop="name">Hash Table</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Indexing/" itemprop="url" rel="index"><span itemprop="name">Indexing</span></a>
                </span>
            </span>

          
            <span id="/2020/04/17/CMU-15445-17-18-Project1-1/" class="post-meta-item leancloud_visitors" data-flag-title="[CMU-15445]17_18_Project1_1" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><p>我摘抄题目的重点:</p>
<ul>
<li>Your table needs to automatically grow in size as needed but you do not need shrink it. That is, you do not need to implement support for shrinking or compacting the hash table. </li>
<li>Check out chapters 11.5-11.7 in the textbook for more information on how to implement this table. </li>
<li>见<a href="https://cakebytheoceanluo.github.io/2020/04/11/DSC-11-6-11-7-Hashing/">Database System Concepts 精读 [11.6-11.7] Hashing</a></li>
</ul>
<p><br></p>
<ul>
<li>我对比过这部分的Fall2017的源代码和Fall2018没有区别</li>
</ul>
<a id="more"></a>
<h1 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h1><p>我们通过和算法原理和test来理解整个hash table的运作。我们先只观察insert, 它也是这次作业中最难的部分。</p>
<h2 id="SampleTest"><a href="#SampleTest" class="headerlink" title="SampleTest"></a>SampleTest</h2><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">TEST(ExtendibleHashTest, SampleTest) {</span><br><span class="line">  <span class="comment">// set leaf size as 2</span></span><br><span class="line">  ExtendibleHash&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; *test =</span><br><span class="line">      <span class="keyword">new</span> ExtendibleHash&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt;(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// insert several key/value pairs</span></span><br><span class="line">  test-&gt;Insert(<span class="number">1</span>, <span class="string">"a"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">2</span>, <span class="string">"b"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">3</span>, <span class="string">"c"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">4</span>, <span class="string">"d"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">5</span>, <span class="string">"e"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">6</span>, <span class="string">"f"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">7</span>, <span class="string">"g"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">8</span>, <span class="string">"h"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">9</span>, <span class="string">"i"</span>);</span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">0</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">3</span>, test-&gt;GetLocalDepth(<span class="number">1</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">2</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">3</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">3</span>, test-&gt;GetLocalDepth(<span class="number">5</span>));  <span class="comment">// Added by Jigao Luo</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// find test</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> result;</span><br><span class="line">  test-&gt;Find(<span class="number">9</span>, result);</span><br><span class="line">  EXPECT_EQ(<span class="string">"i"</span>, result);</span><br><span class="line">  test-&gt;Find(<span class="number">8</span>, result);</span><br><span class="line">  EXPECT_EQ(<span class="string">"h"</span>, result);</span><br><span class="line">  test-&gt;Find(<span class="number">2</span>, result);</span><br><span class="line">  EXPECT_EQ(<span class="string">"b"</span>, result);</span><br><span class="line">  EXPECT_EQ(<span class="number">0</span>, test-&gt;Find(<span class="number">10</span>, result));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// delete test</span></span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, test-&gt;Remove(<span class="number">8</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">0</span>, test-&gt;Find(<span class="number">8</span>, result));  <span class="comment">// Added by Jigao Luo</span></span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, test-&gt;Remove(<span class="number">4</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">0</span>, test-&gt;Find(<span class="number">4</span>, result));  <span class="comment">// Added by Jigao Luo</span></span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, test-&gt;Remove(<span class="number">1</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">0</span>, test-&gt;Find(<span class="number">1</span>, result));  <span class="comment">// Added by Jigao Luo</span></span><br><span class="line">  EXPECT_EQ(<span class="number">0</span>, test-&gt;Remove(<span class="number">20</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> test;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Init:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_1.png" alt="Init"></li>
</ul>
<p><br></p>
<ul>
<li><code>test-&gt;Insert(1, "a"); test-&gt;Insert(2, "b");</code>之后:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_2.png" alt="insert 1, 2"></li>
</ul>
<p><br></p>
<ul>
<li><code>test-&gt;Insert(3, "c"); test-&gt;Insert(4, "d");</code>之后:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_3.png" alt="insert 3, 4"></li>
</ul>
<p><br></p>
<ul>
<li><code>test-&gt;Insert(5, "e"); test-&gt;Insert(6, "f"); test-&gt;Insert(7, "g"); test-&gt;Insert(8, "h");</code>之后:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_4.png" alt="insert 5, 6, 7, 8"></li>
</ul>
<p><br></p>
<ul>
<li><code>test-&gt;Insert(9, "i");</code>之后:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_5.png" alt="insert 9"></li>
</ul>
<p><br></p>
<p>insert结束后，每个元素所在和它二进制表达相符所指向的的bucket。如3和7在<code>011</code>和<code>111</code>所指向的bucket, <code>3 = 0b11</code>, <code>7 = 0b111</code></p>
<p><br><br><br><br><br></p>
<h2 id="BasicDepthTest"><a href="#BasicDepthTest" class="headerlink" title="BasicDepthTest"></a>BasicDepthTest</h2><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">TEST(ExtendibleHashTest, BasicDepthTest) {</span><br><span class="line">  <span class="comment">// set leaf size as 2</span></span><br><span class="line">  ExtendibleHash&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; *test =</span><br><span class="line">      <span class="keyword">new</span> ExtendibleHash&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt;(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// insert several key/value pairs</span></span><br><span class="line">  test-&gt;Insert(<span class="number">6</span>, <span class="string">"a"</span>);   <span class="comment">// b'0110</span></span><br><span class="line">  test-&gt;Insert(<span class="number">10</span>, <span class="string">"b"</span>);  <span class="comment">// b'1010</span></span><br><span class="line">  test-&gt;Insert(<span class="number">14</span>, <span class="string">"c"</span>);  <span class="comment">// b'1110</span></span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">3</span>, test-&gt;GetGlobalDepth());</span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">3</span>, test-&gt;GetLocalDepth(<span class="number">2</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">3</span>, test-&gt;GetLocalDepth(<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">0</span>));  <span class="comment">// Modified by Jigao Luo</span></span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">4</span>));  <span class="comment">// Modified by Jigao Luo</span></span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, test-&gt;GetLocalDepth(<span class="number">1</span>));  <span class="comment">// Modified by Jigao Luo</span></span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, test-&gt;GetLocalDepth(<span class="number">3</span>));  <span class="comment">// Modified by Jigao Luo</span></span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, test-&gt;GetLocalDepth(<span class="number">5</span>));  <span class="comment">// Modified by Jigao Luo</span></span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, test-&gt;GetLocalDepth(<span class="number">7</span>));  <span class="comment">// Modified by Jigao Luo</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// four buckets in use</span></span><br><span class="line">  EXPECT_EQ(<span class="number">4</span>, test-&gt;GetNumBuckets());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// insert more key/value pairs</span></span><br><span class="line">  test-&gt;Insert(<span class="number">1</span>, <span class="string">"d"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">3</span>, <span class="string">"e"</span>);</span><br><span class="line">  test-&gt;Insert(<span class="number">5</span>, <span class="string">"f"</span>);</span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">5</span>, test-&gt;GetNumBuckets());</span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">3</span>, test-&gt;GetGlobalDepth());  <span class="comment">// Added by Jigao Luo</span></span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">0</span>));  <span class="comment">// Added by Jigao Luo</span></span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">1</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">3</span>, test-&gt;GetLocalDepth(<span class="number">2</span>));  <span class="comment">// Added by Jigao Luo</span></span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">3</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, test-&gt;GetLocalDepth(<span class="number">7</span>));  <span class="comment">// Added by Jigao Luo</span></span><br><span class="line"></span><br><span class="line">  EXPECT_EQ(<span class="number">3</span>, test-&gt;GetLocalDepth(<span class="number">6</span>));  <span class="comment">// Added by Jigao Luo</span></span><br><span class="line">  <span class="keyword">delete</span> test;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Init:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_1.png" alt="Init"></li>
</ul>
<p><br></p>
<ul>
<li><code>test-&gt;Insert(6, "a"); test-&gt;Insert(10, "b");</code>之后:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_6.png" alt="insert 6, 10"></li>
</ul>
<p><br></p>
<ul>
<li><code>test-&gt;Insert(14, "c");</code>之后:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_7.png" alt="global depth = 1"><br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_8.png" alt="global depth = 2"><br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_9.png" alt="global depth = 3"></li>
</ul>
<p><code>6 = 0b110</code>, <code>10 = 0b1010</code>, <code>14 = 0b1110</code></p>
<ul>
<li>global depth = 1的时候, 6和10的最后一个bit都是<code>0</code>, 所以在同一个bucket</li>
<li>global depth = 2的时候, 6和10的最后两个bit都是<code>10</code>, 所以在同一个bucket</li>
<li>global depth = 3的时候, 6和10的最后的三个bit不同，它们俩分开，14才有空间插入</li>
</ul>
<p><br></p>
<ul>
<li><code>test-&gt;Insert(1, "d"); test-&gt;Insert(3, "e");</code>之后:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_10.png" alt="insert 1, 3"></li>
</ul>
<p><br></p>
<ul>
<li><code>test-&gt;Insert(t, "f");</code>之后:<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_11.png" alt="insert 5"></li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="split-bucket前后"><a href="#split-bucket前后" class="headerlink" title="split bucket前后"></a>split bucket前后</h2><p>我们假定global depth是5， bucket_j的local depth是2。在这种情况下有 $8 = 2^{5-2} = 2^3$个bucket address table条目/指针指向bucket_j。</p>
<h3 id="split-bucket前"><a href="#split-bucket前" class="headerlink" title="split bucket前"></a>split bucket前</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_12.png" alt="split bucket前"></p>
<h3 id="split-bucket后"><a href="#split-bucket后" class="headerlink" title="split bucket后"></a>split bucket后</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Project1718/P1_T1_13.png" alt="split bucket后"></p>
<p>split bucket后：</p>
<ul>
<li>bucket j的local depth是3, 分裂出来的新bucket z的local depth也是3</li>
<li>有 $4 = 2^{5-3} = 2^2$个bucket address table条目/指针指向bucket j，同样的情况也发生在bucket z身上</li>
<li>新到达的local depth是3， 因此从右边数第3个bit是0的条目指向bucket j, 是1的条目指向bucket z。前者我用红色的连线，后者我用绿色的连线。即指向bucket z的条目后三位bit都是<code>110</code>, 我称之为<em>下半区</em>。</li>
<li>我们考虑怎么去实现上一点。我们已知bucket z对应的条目模式pattern是<code>XX110</code>(<code>X</code>代表0或1)。<ul>
<li>我这里将数字值最小的一个条目<code>00110</code>称为base point基准点。<ul>
<li>获得base point的普遍方式是: 将从左第local depth设置成1，左侧剩下的(local depth - 1)个bits使用原bucket j的(local depth - 1)个bits。</li>
</ul>
</li>
<li>我们从base point开始做iteration迭代, 次数是4，即绿连线的个数，称之为iterations。<ul>
<li>获得iterations的普遍方式是: $2^{\;(\mathrm{global\;depth} - \mathrm{local\;depth})}$</li>
</ul>
</li>
<li>每一次迭代我们都在base point上加一个递增量，获得下一个属于bucket z的条目。这个递增量在这图中是<code>1000</code>, 我们称之为iter_incr。<ul>
<li>获得iter_incr的普遍方式是: $1 &lt;&lt; \mathrm{local\;depth}$</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><br><br><br></p>
<p>到目前为止上面的图片都很重要，需要被全面理解，才能开始写代码。如果不太理解，可以去书中仔细看看。下面两个链接也能帮助你:</p>
<ul>
<li><a href="https://cakebytheoceanluo.github.io/2020/04/11/DSC-11-6-11-7-Hashing/">Database System Concepts 精读 [11.6-11.7] Hashing</a></li>
<li><a href="https://cakebytheoceanluo.github.io/2020/04/12/Extendable-Hashing-Exercise/">Extendable Hashing 练习</a></li>
</ul>
<p>另外图中bucket id(比如图中bucket下面的<code>bucket0</code>, <code>bucket1</code>等等)不重要，因为我们不根据它们的名字去确定它们，我们根据bucket address table对应位置的bucket指针去寻找对应的bucket。这句话我会在实现部分重复一次。</p>
<p><br></p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="Bit-Operation-位操作"><a href="#Bit-Operation-位操作" class="headerlink" title="Bit Operation 位操作"></a>Bit Operation 位操作</h2><p>我用了两个pre-computed table去完成两个位操作的函数。我想法和目的是使这两个函数足够快。毕竟整个Extendible Hash Table的核心基于位操作。</p>
<h3 id="GET-LAST-N-BITS"><a href="#GET-LAST-N-BITS" class="headerlink" title="GET_LAST_N_BITS"></a><code>GET_LAST_N_BITS</code></h3><p><code>GET_LAST_N_BITS</code>这个函数可以获得参数的后n个bits</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pre-computed mask array to get the last n bits of an int</span></span><br><span class="line"><span class="comment">// Usage Example: value &amp; LAST_N_BIT_MASK[2] ==&gt; value &amp; 0x3 ==&gt; value &amp; 0b11 =&gt; get the last two bits of value</span></span><br><span class="line"><span class="comment">// This array should/must fit into L1 cache, so we can "get the last bits of an int" in SINGLE bit operator (&amp;)</span></span><br><span class="line"><span class="comment">// Alternative we can use calculation like: value &amp; ((1 &lt;&lt; n) - 1) to get the same job done.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">size_t</span>, 32&gt; LAST_N_BITS_MASK { <span class="number">0</span>,</span><br><span class="line">                                                           <span class="number">0x1</span>,        <span class="number">0x3</span>,        <span class="number">0x7</span>,       <span class="number">0xF</span>,</span><br><span class="line">                                                           <span class="number">0x1F</span>,       <span class="number">0x3F</span>,       <span class="number">0x7F</span>,      <span class="number">0xFF</span>,</span><br><span class="line">                                                           <span class="number">0x1FF</span>,      <span class="number">0x3FF</span>,      <span class="number">0x7FF</span>,     <span class="number">0xFFF</span>,</span><br><span class="line">                                                           <span class="number">0x1FFF</span>,     <span class="number">0x3FFF</span>,     <span class="number">0x7FFF</span>,    <span class="number">0xFFFF</span>,</span><br><span class="line">                                                           <span class="number">0x1FFFF</span>,    <span class="number">0x3FFFF</span>,    <span class="number">0x7FFFF</span>,   <span class="number">0xFFFFF</span>,</span><br><span class="line">                                                           <span class="number">0x1FFFFF</span>,   <span class="number">0x3FFFFF</span>,   <span class="number">0x7FFFFF</span>,  <span class="number">0xFFFFFF</span>,</span><br><span class="line">                                                           <span class="number">0x1FFFFFF</span>,  <span class="number">0x3FFFFFF</span>,  <span class="number">0x7FFFFFF</span>, <span class="number">0xFFFFFFF</span>,</span><br><span class="line">                                                           <span class="number">0x1FFFFFFF</span>, <span class="number">0x3FFFFFFF</span>, <span class="number">0x7FFFFFFF</span> };</span><br><span class="line"></span><br><span class="line"><span class="function">__always_inline <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">GET_LAST_N_BITS</span><span class="params">(<span class="keyword">size_t</span> value, <span class="keyword">int</span> n)</span> </span>{ <span class="keyword">return</span> value &amp; LAST_N_BITS_MASK[n]; }</span><br></pre></td></tr></tbody></table></figure>
<h3 id="GET-LAST-N-TH-BIT"><a href="#GET-LAST-N-TH-BIT" class="headerlink" title="GET_LAST_N_TH_BIT"></a><code>GET_LAST_N_TH_BIT</code></h3><p><code>GET_LAST_N_TH_BIT</code>这个函数可以获得参数的后第n个bit</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pre-computed mask array to get the last n-th bit of an int</span></span><br><span class="line"><span class="comment">// Usage Example: value &amp; LAST_N_BIT_MASK[2] ==&gt; value &amp; 0x2 ==&gt; value &amp; 0b10 =&gt; get the last 2rd bit of value</span></span><br><span class="line"><span class="comment">// This array should/must fit into L1 cache, so we can "get the last bits of an int" in SINGLE bit operator (&amp;)</span></span><br><span class="line"><span class="comment">// Alternative we can use calculation like: value &amp; ((1 &lt;&lt; (n - 1))) to get the same job done.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">size_t</span>, 32&gt; LAST_N_TH_BIT_MASK { <span class="number">0</span>,</span><br><span class="line">                                                             <span class="number">0x1</span>,        <span class="number">0x2</span>,        <span class="number">0x4</span>,       <span class="number">0x8</span>,</span><br><span class="line">                                                             <span class="number">0x10</span>,       <span class="number">0x20</span>,       <span class="number">0x40</span>,      <span class="number">0x80</span>,</span><br><span class="line">                                                             <span class="number">0x100</span>,      <span class="number">0x200</span>,      <span class="number">0x400</span>,     <span class="number">0x800</span>,</span><br><span class="line">                                                             <span class="number">0x1000</span>,     <span class="number">0x2000</span>,     <span class="number">0x4000</span>,    <span class="number">0x8000</span>,</span><br><span class="line">                                                             <span class="number">0x10000</span>,    <span class="number">0x20000</span>,    <span class="number">0x40000</span>,   <span class="number">0x80000</span>,</span><br><span class="line">                                                             <span class="number">0x100000</span>,   <span class="number">0x200000</span>,   <span class="number">0x400000</span>,  <span class="number">0x800000</span>,</span><br><span class="line">                                                             <span class="number">0x1000000</span>,  <span class="number">0x2000000</span>,  <span class="number">0x4000000</span>, <span class="number">0x8000000</span>,</span><br><span class="line">                                                             <span class="number">0x10000000</span>, <span class="number">0x20000000</span>, <span class="number">0x40000000</span> };</span><br><span class="line"></span><br><span class="line"><span class="function">__always_inline <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">GET_LAST_N_TH_BIT</span><span class="params">(<span class="keyword">size_t</span> value, <span class="keyword">int</span> n)</span> </span>{ <span class="keyword">return</span> value &amp; LAST_N_TH_BIT_MASK[n]; }</span><br></pre></td></tr></tbody></table></figure>
<hr>
<h2 id="struct-Bucket"><a href="#struct-Bucket" class="headerlink" title="struct Bucket"></a><code>struct Bucket</code></h2><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Bucket</span> {</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;K&gt; keys;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;V&gt; values;</span><br><span class="line">  <span class="keyword">int</span> localDepth = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::shared_mutex bucket_latch;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// constructor</span></span><br><span class="line">  Bucket() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  Bucket(<span class="keyword">int</span> localDepth) : localDepth(localDepth) {};</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">Find</span><span class="params">(<span class="keyword">const</span> K &amp;key, V &amp;value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">Exist</span><span class="params">(<span class="keyword">const</span> K &amp;key, <span class="keyword">const</span> V &amp;value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">Remove</span><span class="params">(<span class="keyword">const</span> K &amp;key)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">const</span> K &amp;key, <span class="keyword">const</span> V &amp;value)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>Bucket需要存储keys, values和这个bucket自己的local depth。</p>
<p>我看了很多其他人的代码，很多人用<code>std::map</code>或者<code>std::unordered_map</code>去存储key, value。这样当然没错，只是我自己觉得很不舒服 — 用一个hash table去实现另一个hash table。 </p>
<p>我使用的方法类似下图中表达的意思: 分开存储key和value，它们的位置一对一对应：<br><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec07/18.jpg" alt="18.jpg"></p>
<ul>
<li>因为这题中我的实现key是不被排序的。这里提一下我如何去删除一个key, value对。举例我们要删除K3， 我们让<code>keys[3] = keys[n]; keys.pop_back();</code>， 然后对value也做同样的操作即可。这样删除的操作是常数时间复杂度，另外key的顺序对我们无关。</li>
<li>另外我的bucket也有一个<code>std::shared_mutex bucket_latch;</code>, 我在尽量细化程序锁的粒度。</li>
<li>其他我用了Find, Exist, Remove, Insert的函数对应hash table的同名函数，也是为了帮助这四个同名函数。它们实现都是正常思路，这里不再赘述。</li>
</ul>
<hr>
<h2 id="class-ExtendibleHash-attributes"><a href="#class-ExtendibleHash-attributes" class="headerlink" title="class ExtendibleHash attributes"></a><code>class ExtendibleHash</code> attributes</h2><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// the element number limitation in a single bucket</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> bucketSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// global depth</span></span><br><span class="line"><span class="keyword">int</span> globalDepth = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// number of buckets</span></span><br><span class="line"><span class="keyword">int</span> numBuckets = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// number of keys</span></span><br><span class="line"><span class="keyword">size_t</span> <span class="built_in">size</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bucket Address Table a.k.a Directory</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Bucket&gt;&gt; bucketAddressTable = {};</span><br><span class="line"></span><br><span class="line"><span class="keyword">mutable</span> <span class="built_in">std</span>::shared_mutex global_latch;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>const size_t bucketSize = 0;</code>因为是<code>const</code>, 所以只能在Initializer list中被初始化。见<span class="exturl" data-url="aHR0cHM6Ly93d3cuZ2Vla3Nmb3JnZWVrcy5vcmcvd2hlbi1kby13ZS11c2UtaW5pdGlhbGl6ZXItbGlzdC1pbi1jLw==" title="https://www.geeksforgeeks.org/when-do-we-use-initializer-list-in-c/">When do we use Initializer List in C++?<i class="fa fa-external-link"></i></span><!-- TODO:学这个链接的页面 --></li>
<li><code>std::shared_ptr&lt;Bucket&gt;</code>当然可以被替换成<code>Bucket*</code></li>
<li><code>size_t size = 0;</code>是我个人喜好，去记录hash table中存储的数量。不是必需的成员。</li>
<li><code>mutable std::shared_mutex global_latch;</code>这个相当于是全局的锁，可以锁住<code>class ExtendibleHash</code>的所有成员，自然包括了它的所有的bucket。</li>
</ul>
<hr>
<h2 id="class-ExtendibleHash-number-function-public-private"><a href="#class-ExtendibleHash-number-function-public-private" class="headerlink" title="class ExtendibleHash number function (public, private)"></a><code>class ExtendibleHash</code> number function (public, private)</h2><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// get the size of hash table, added by Jigao</span></span><br><span class="line">  <span class="function">__always_inline <span class="keyword">size_t</span> <span class="title">GetSize</span><span class="params">()</span> <span class="keyword">override</span> </span>{ </span><br><span class="line">    <span class="function"><span class="built_in">std</span>::shared_lock&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">shared_lock</span><span class="params">(global_latch)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">size</span>; </span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * helper function to return pointer to bucket of the key</span></span><br><span class="line"><span class="comment">   * NOT THREAD SAFE, MUST PROTECTED BY LATCH</span></span><br><span class="line"><span class="comment">   * @return a shared point of the bucket, where the key lands</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Bucket&gt; <span class="title">GetBucket</span><span class="params">(<span class="keyword">const</span> K &amp;key)</span> <span class="keyword">const</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> bucketAddressTable[GET_LAST_N_BITS(HashKey(key), globalDepth)];</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * check the existence of a key and update the value, if the key exists</span></span><br><span class="line"><span class="comment">   * NOT THREAD SAFE, MUST PROTECTED BY LATCH</span></span><br><span class="line"><span class="comment">   * @return true for the key exists, otherwise false</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">Exists</span><span class="params">(<span class="keyword">const</span> K &amp;key, <span class="keyword">const</span> V &amp;value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * double the size of bucket address table</span></span><br><span class="line"><span class="comment">   * NOT THREAD SAFE, MUST PROTECTED BY LATCH</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">Grow</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> it = <span class="number">0</span>, old_size = bucketAddressTable.<span class="built_in">size</span>(); it != old_size; it++) {</span><br><span class="line">      bucketAddressTable.emplace_back(bucketAddressTable[it]);</span><br><span class="line">    }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>GetSize()</code>和之前的<code>size</code>关联。不是必需的成员。(我在<code>hash_table.h</code>中加入了这个函数: <code>virtual size_t GetSize() = 0;</code> 当然这也只是我自己的喜好)</li>
<li><code>GetBucket</code>是insert, find, remove中必需的函数: 根据一个key，找到它对应的bucket。</li>
<li><code>bool Exists(const K &amp;key, const V &amp;value);</code>检查一个key是否存在，如果它存在的话，更新它的value。这个也是insert, find, remove时候重要的函数。<ul>
<li>对比: <code>bool Find(const K &amp;key, V &amp;value) override;</code>是通过key，找到对应的value</li>
</ul>
</li>
<li><code>Grow()</code> 即global depth增加的时候被使用，bucket address table翻倍。(从很多例子中可以找到)</li>
<li>其他题目要求的方法在有这部分被省略，我们在下一个部分仔细讲。</li>
</ul>
<p><br><br><br></p>
<p>我看了很多其他人的代码， 下面是一些我注意到的：</p>
<ul>
<li>有些同学的<code>bucketAddressTable</code>的条目有时候会是一个<code>nullptr</code>，　这个至少和我们的练习中都不一样。练习中每一个<code>bucketAddressTable</code>的条目<strong>都是bucket pointer</strong>，<strong>会出现多个条目指向同一个bucket的情况(即global depth &gt; local depth)</strong></li>
<li>有些同学的local depth可能是-1， 但是练习中<strong>每一个bucket的local depth都是正值</strong></li>
<li>指针数组能增长，它的长度总是2的幂，因此数组每增长一次，桶的数目就<strong>翻倍</strong>。有些同学的实现中<code>bucketAddressTable</code>的大小不都是2的倍数。</li>
<li>我的实现中，每次bucket已满之后，<strong>只新建一个新的bucket</strong> <!-- https://github.com/gatsbyd/cmu_15445_2018/blob/master/src/hash/extendible_hash.cpp#L114 --></li>
<li>有些同学用<code>while</code>循环，我选择了<code>goto</code>，因为我是在insert过程中判断是否需要继续，而不是过程一开始</li>
</ul>
<h3 id="Find"><a href="#Find" class="headerlink" title="Find"></a><code>Find</code></h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * lookup function to find value associate with input key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line"><span class="keyword">bool</span> ExtendibleHash&lt;K, V&gt;::Find(<span class="keyword">const</span> K &amp;key, V &amp;value) {</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::shared_lock&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">global_lock</span><span class="params">(global_latch)</span></span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> bucket = GetBucket(key);</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::shared_lock&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">bucket_lock_guard</span><span class="params">(bucket-&gt;bucket_latch)</span></span>;</span><br><span class="line">  global_lock.unlock();</span><br><span class="line">  <span class="keyword">return</span> bucket-&gt;Find(key, value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>根据这个<code>Find</code>函数，我可以猜测，这个hash tbale是<strong>不考虑重复的键值(duplicate key value)</strong>。不然<code>Find</code>函数的设计不会是上面这样。因此我们在插入(<code>Insert</code>)的时候需要考虑，该key是否已经出现过:<ul>
<li>如果已经出现过, update value</li>
<li>如果没出现过，简单插入即可</li>
</ul>
</li>
<li>Find属于一个读操作，所以我们只需要获得<code>global_latch</code>和对应<code>bucket-&gt;bucket_latch</code>的<code>std::shared_lock&lt;std::shared_mutex&gt;</code>即可。</li>
</ul>
<h3 id="Remove"><a href="#Remove" class="headerlink" title="Remove"></a><code>Remove</code></h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * delete &lt;key,value&gt; entry in hash table</span></span><br><span class="line"><span class="comment"> * Shrink &amp; Combination is not required for this project</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line"><span class="keyword">bool</span> ExtendibleHash&lt;K, V&gt;::Remove(<span class="keyword">const</span> K &amp;key) {</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::shared_lock&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">global_lock</span><span class="params">(global_latch)</span></span>;</span><br><span class="line">  <span class="built_in">size</span>--;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> bucket = GetBucket(key);</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">bucket_lock_guard</span><span class="params">(bucket-&gt;bucket_latch)</span></span>;</span><br><span class="line">  global_lock.unlock();</span><br><span class="line">  <span class="keyword">return</span> bucket-&gt;Remove(key);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a><code>Insert</code></h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * insert &lt;key,value&gt; entry in hash table</span></span><br><span class="line"><span class="comment"> * Split &amp; Redistribute bucket when there is overflow and if necessary increase</span></span><br><span class="line"><span class="comment"> * global depth</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line"><span class="keyword">void</span> ExtendibleHash&lt;K, V&gt;::Insert(<span class="keyword">const</span> K &amp;key, <span class="keyword">const</span> V &amp;value) {</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">global_lock</span><span class="params">(global_latch)</span></span>;</span><br><span class="line">  <span class="comment">// 0. Check the existence and update the value</span></span><br><span class="line">  <span class="keyword">if</span> (Exists(key, value)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. Look up the correspond bucket</span></span><br><span class="line">  check:</span><br><span class="line">  <span class="keyword">auto</span> bucket_j = GetBucket(key);</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">bucket_lock_guard</span><span class="params">(bucket_j-&gt;bucket_latch)</span></span>;</span><br><span class="line">  <span class="keyword">auto</span>&amp; keys_j = bucket_j-&gt;keys;</span><br><span class="line">  <span class="keyword">auto</span>&amp; values_j = bucket_j-&gt;values;</span><br><span class="line">  assert(keys_j.<span class="built_in">size</span>() == values_j.<span class="built_in">size</span>());</span><br><span class="line">  assert(keys_j.<span class="built_in">size</span>() &lt;= bucketSize);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. Check the bucket, if is full</span></span><br><span class="line">  <span class="keyword">if</span> (keys_j.<span class="built_in">size</span>() == bucketSize) {</span><br><span class="line">    <span class="comment">// 2.1 Bucket full</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> last_n_bits_global = GET_LAST_N_BITS(HashKey(key), globalDepth);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> last_n_bits_local = GET_LAST_N_BITS(last_n_bits_global, bucket_j-&gt;localDepth);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> old_localDepth = bucket_j-&gt;localDepth;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1.1 Compare the global depth (i) and local depth (i_j)</span></span><br><span class="line">    <span class="keyword">if</span> (globalDepth == old_localDepth) {</span><br><span class="line">      <span class="comment">// 2.1.1.1 i == i_j, only one entry in the bucket address table points to bucket j</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 2.1.1.1.1 increase the size of the bucket address table.</span></span><br><span class="line">      <span class="comment">//           It replaces each entry by two entries, both of which contain the same pointer as the original entry.</span></span><br><span class="line">      globalDepth++;</span><br><span class="line">      Grow();</span><br><span class="line">      assert((<span class="keyword">decltype</span>(bucketAddressTable.<span class="built_in">size</span>()))(<span class="number">1</span> &lt;&lt; globalDepth) == bucketAddressTable.<span class="built_in">size</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1.1.2 i &gt; i_j, more than one entry in the bucket address table points to bucket j.</span></span><br><span class="line">    <span class="comment">//                  The system can split bucket $j$ without increasing the size of the bucket address table</span></span><br><span class="line">    <span class="comment">//                  Do Nothing For This Case</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1.2 The system allocates a new bucket z,</span></span><br><span class="line">    <span class="comment">//         and sets i_j and i_z to the value that results from adding 1 to the original i_j value.</span></span><br><span class="line">    bucket_j-&gt;localDepth++;</span><br><span class="line">    <span class="keyword">auto</span> bucket_z = <span class="built_in">std</span>::make_shared&lt;Bucket&gt;(bucket_j-&gt;localDepth);</span><br><span class="line">    numBuckets++;</span><br><span class="line">    <span class="keyword">auto</span>&amp; keys_z = bucket_z-&gt;keys;</span><br><span class="line">    <span class="keyword">auto</span>&amp; values_z = bucket_z-&gt;values;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1.3 Next, to adjust the entries in the bucket address table that previously pointed to bucket j</span></span><br><span class="line">    <span class="keyword">int</span> base_point = (<span class="number">1</span> &lt;&lt; old_localDepth) + last_n_bits_local;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> iter_incr = <span class="number">1</span> &lt;&lt; (bucket_j-&gt;localDepth);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> iterations = <span class="built_in">std</span>::<span class="built_in">max</span>(((globalDepth - bucket_j-&gt;localDepth) &lt;&lt; <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> it = <span class="number">0</span>; it != iterations; it++, base_point += iter_incr) {</span><br><span class="line">      bucketAddressTable[base_point] = bucket_z;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1.4 rehash each record in bucket j, and allocates it either to bucket j or bucket z</span></span><br><span class="line">    <span class="comment">// 2.1.4.1 Find all match index in keys of bucket j</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">size_t</span>&gt; matches;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> it = keys_j.<span class="built_in">size</span>() - <span class="number">1</span>; ; --it) {</span><br><span class="line">      <span class="keyword">if</span> (GET_LAST_N_TH_BIT(HashKey(keys_j[it]), bucket_j-&gt;localDepth) != <span class="number">0</span>) {</span><br><span class="line">        matches.push_back(it);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">if</span> (it == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1.4.2 Insert matches to bucket z, and remove matches from bucket j</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; it : matches) {</span><br><span class="line">      keys_z.emplace_back(keys_j[it]);</span><br><span class="line">      values_z.emplace_back(values_j[it]);</span><br><span class="line"></span><br><span class="line">      keys_j[it] = keys_j.back();</span><br><span class="line">      keys_j.pop_back();</span><br><span class="line">      values_j[it] = values_j.back();</span><br><span class="line">      values_j.pop_back();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1.5 Check if there is place to insert after rehashing</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> to_bucket_z = GET_LAST_N_TH_BIT(HashKey(key), bucket_j-&gt;localDepth);</span><br><span class="line">    <span class="keyword">if</span>((matches.empty() &amp;&amp; !to_bucket_z) || matches.<span class="built_in">size</span>() + to_bucket_z &gt; bucketSize) {</span><br><span class="line">      <span class="comment">// 2.1.5.1 No place, so repeat again</span></span><br><span class="line">      <span class="keyword">goto</span> check;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1.5.2 Exists space, insert key and value</span></span><br><span class="line">    <span class="keyword">if</span> (to_bucket_z) {</span><br><span class="line">      bucket_z-&gt;Insert(key, value);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      bucket_j-&gt;Insert(key, value);</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// 2.2 Bucket not full, just simple insert</span></span><br><span class="line">    bucket_j-&gt;Insert(key, value);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// Insert Done</span></span><br><span class="line">  <span class="built_in">size</span>++;</span><br><span class="line">  assert(keys_j.<span class="built_in">size</span>() == values_j.<span class="built_in">size</span>());</span><br><span class="line">  assert(keys_j.<span class="built_in">size</span>() &lt;= bucketSize);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Insert我严格<strong>按照DSC书中的描述</strong></li>
</ul>
<ol>
<li><code>if (Exists(key, value)) return;</code>: Exists方法看这个key是否已经出现过，如果已经出现过，更新对应的value。</li>
<li><code>auto bucket_j = GetBucket(key);</code>: 得到对应的bucket， 称之为<strong>bucket_j</strong></li>
<li><code>if (keys_j.size() == bucketSize)</code>: 看这个bucket是否已满<ul>
<li>2.1. bucket已满<ul>
<li>2.1.1. <code>if (globalDepth == old_localDepth)</code> 比较global depth $i$ 和 local depth $i_j$ <ul>
<li>2.1.1.1.  $i = i_j$ 相等: <code>globalDepth++; Grow();</code> 增长global depth, 对bucket address table进行翻倍操作</li>
<li>2.1.1.2.  $i \neq i_j$ 不相等: 只可能是$i &gt; i_j$</li>
</ul>
</li>
<li>2.1.2.  <code>bucket_j-&gt;localDepth++; auto bucket_z = std::make_shared&lt;Bucket&gt;(bucket_j-&gt;localDepth); numBuckets++;</code> 增长bucket_j的local depth。 新建一个<strong>bucket_z</strong>， 使它有同样的local depth</li>
<li>2.1.3. <code>for (size_t it = 0; it != iterations; it++, base_point += iter_incr) bucketAddressTable[base_point] = bucket_z;</code> 调整bucket address table中的条目，使部分指向原bucket_j的条目指向bucket_z。这部分具体见<a href="#split-bucket前后">split bucket前后</a></li>
<li>2.1.4. <strong>rehash</strong>, 将bucket_j中从左第local depth个bit是1的元素移动到bucket_z。即我的<a href="#split-bucket前后">split bucket前后</a>提到的<em>下半区</em>的概念。</li>
<li>2.1.5. <code>const bool to_bucket_z = GET_LAST_N_TH_BIT(HashKey(key), bucket_j-&gt;localDepth); if((matches.empty() &amp;&amp; !to_bucket_z) || matches.size() + to_bucket_z &gt; bucketSize) goto check;</code> 我们查看我们这一次插入的key是属于bucket_j还是bucket_z。再看对应bucket是否还是满的:<ul>
<li>2.1.5.1 如果对应bucket还是满的: <code>goto check;</code>， 这里 <code>check</code>即我们的第一步<code>1.</code></li>
<li>2.1.5.1 如果对应bucket未满: <code>Insert(key, value);</code></li>
</ul>
</li>
</ul>
</li>
<li>2.2. bucket未满</li>
<li><code>Insert(key, value);</code>即可</li>
</ul>
</li>
</ol>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li><code>hash_table.h</code>: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nha2VieXRoZW9jZWFuTHVvL0NNVTE1LTQ0NS0yMDE3L2Jsb2IvbWFzdGVyL3NyYy9pbmNsdWRlL2hhc2gvaGFzaF90YWJsZS5o" title="https://github.com/cakebytheoceanLuo/CMU15-445-2017/blob/master/src/include/hash/hash_table.h">https://github.com/cakebytheoceanLuo/CMU15-445-2017/blob/master/src/include/hash/hash_table.h<i class="fa fa-external-link"></i></span></li>
<li><code>extendible_hash.h</code>: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nha2VieXRoZW9jZWFuTHVvL0NNVTE1LTQ0NS0yMDE3L2Jsb2IvbWFzdGVyL3NyYy9pbmNsdWRlL2hhc2gvZXh0ZW5kaWJsZV9oYXNoLmg=" title="https://github.com/cakebytheoceanLuo/CMU15-445-2017/blob/master/src/include/hash/extendible_hash.h">https://github.com/cakebytheoceanLuo/CMU15-445-2017/blob/master/src/include/hash/extendible_hash.h<i class="fa fa-external-link"></i></span></li>
<li><code>extendible_hash.cpp</code>: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nha2VieXRoZW9jZWFuTHVvL0NNVTE1LTQ0NS0yMDE3L2Jsb2IvbWFzdGVyL3NyYy9oYXNoL2V4dGVuZGlibGVfaGFzaC5jcHA=" title="https://github.com/cakebytheoceanLuo/CMU15-445-2017/blob/master/src/hash/extendible_hash.cpp">https://github.com/cakebytheoceanLuo/CMU15-445-2017/blob/master/src/hash/extendible_hash.cpp<i class="fa fa-external-link"></i></span></li>
</ul>
<p><br></p>
<h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nha2VieXRoZW9jZWFuTHVvL0NNVTE1LTQ0NS0yMDE3L2Jsb2IvbWFzdGVyL3Rlc3QvaGFzaC9leHRlbmRpYmxlX2hhc2hfdGVzdC5jcHA=" title="https://github.com/cakebytheoceanLuo/CMU15-445-2017/blob/master/test/hash/extendible_hash_test.cpp">https://github.com/cakebytheoceanLuo/CMU15-445-2017/blob/master/test/hash/extendible_hash_test.cpp<i class="fa fa-external-link"></i></span></p>
<p>代码链接以后会附上</p>
<p>我准备了非常丰富的多线程的test，它们能检查线程是否安全，同时也是对锁粒度和性能的考验(如果性能太差会需要很长时间):</p>
<ul>
<li><code>EnormeConcurrentInsertTest</code></li>
<li><code>EnormeRandomConcurrentInsertTest</code></li>
<li><code>EnormeConcurrentRemoveTest</code></li>
<li><code>EnormeRandomConcurrentRemoveTest</code></li>
<li><code>EnormeConcurrentTest</code></li>
<li><code>EnormeRandomConcurrentTest</code></li>
<li><code>EnormeRandomConcurrentTest2</code></li>
</ul>
<h1 id="MY-TODO"><a href="#MY-TODO" class="headerlink" title="MY-TODO"></a>MY-TODO</h1><p>写这次的过程中还是发现一些问题:</p>
<ul>
<li>Insert时锁的粒度或许可以更小， 考虑是否有必要，是否能带来性能的提升<ul>
<li>见 stronaut0131: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FzdHJvbmF1dDAxMzEvY211MTUtNDQ1LTIwMTc=" title="https://github.com/astronaut0131/cmu15-445-2017">https://github.com/astronaut0131/cmu15-445-2017<i class="fa fa-external-link"></i></span></li>
<li>见 Junoth: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0p1bm90aC9DTVUtMTUtNDQ1" title="https://github.com/Junoth/CMU-15-445">https://github.com/Junoth/CMU-15-445<i class="fa fa-external-link"></i></span></li>
<li>RWLock 见lancecopper: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xhbmNlY29wcGVyL2NtdTE1NDQ1X2ZhbGwyMDE3L2Jsb2IvbWFzdGVyL3NxbGl0ZS1mYWxsMjAxNy9zcmMvaGFzaC9leHRlbmRpYmxlX2hhc2guY3Bw" title="https://github.com/lancecopper/cmu15445_fall2017/blob/master/sqlite-fall2017/src/hash/extendible_hash.cpp">https://github.com/lancecopper/cmu15445_fall2017/blob/master/sqlite-fall2017/src/hash/extendible_hash.cpp<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
</ul>
<hr>
<p>引用:</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTgvcHJvamVjdDEv" title="https://15445.courses.cs.cmu.edu/fall2018/project1/">https://15445.courses.cs.cmu.edu/fall2018/project1/<i class="fa fa-external-link"></i></span></li>
</ul>
<p>推荐的阅读:</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdS1qaWFuaGFvL0NNVS0xNS00NDUvdHJlZS9tYXN0ZXIvTGFiMS1CdWZmZXItUG9vbCMlRTUlOEYlQUYlRTYlODklQTklRTUlQjElOTUlRTclOUElODQlRTUlOTMlODglRTUlQjglOEMlRTglQTElQTg=" title="https://github.com/liu-jianhao/CMU-15-445/tree/master/Lab1-Buffer-Pool#%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E5%93%88%E5%B8%8C%E8%A1%A8">https://github.com/liu-jianhao/CMU-15-445/tree/master/Lab1-Buffer-Pool#%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E5%93%88%E5%B8%8C%E8%A1%A8<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZ2F0c2J5MTIzL3AvMTA2MTMxNjAuaHRtbA==" title="https://www.cnblogs.com/gatsby123/p/10613160.html">https://www.cnblogs.com/gatsby123/p/10613160.html<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9lZGUwODlkM2Q4YWQ=" title="https://www.jianshu.com/p/ede089d3d8ad">https://www.jianshu.com/p/ede089d3d8ad<i class="fa fa-external-link"></i></span></li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>罗济高
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://cakebytheoceanluo.github.io/2020/04/17/CMU-15445-17-18-Project1-1/" title="[CMU-15445]17_18_Project1_1">https://cakebytheoceanluo.github.io/2020/04/17/CMU-15445-17-18-Project1-1/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLzQuMC8="><i class="fa fa-fw fa-creative-commons"></i>BY-NC</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

            <div class="social-item">
              <a target="_blank" class="social-link" href="/atom.xml">
                <span class="icon">
                  <i class="fa fa-rss"></i>
                </span>

                <span class="label">RSS</span>
              </a>
            </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Dynamic-Hashing-Scheme/" rel="tag"><i class="fa fa-tag"></i> Dynamic Hashing Scheme</a>
              <a href="/tags/Extendible-Hashing/" rel="tag"><i class="fa fa-tag"></i> Extendible Hashing</a>
          </div>

        
  <div class="post-widgets">
    <div class="wp_rating">
      <div id="wpac-rating"></div>
    </div>
  </div>


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/16/CMU-15445-17-18-Project0/" rel="prev" title="[CMU-15445]17_18_Project0">
      <i class="fa fa-chevron-left"></i> [CMU-15445]17_18_Project0
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/19/std-list-splice/" rel="next" title="std::list::splice详解">
      std::list::splice详解 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="cakebytheoceanLuo/cakebytheoceanLuo.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#题目"><span class="nav-number">1.</span> <span class="nav-text">题目</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#引入"><span class="nav-number">2.</span> <span class="nav-text">引入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SampleTest"><span class="nav-number">2.1.</span> <span class="nav-text">SampleTest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BasicDepthTest"><span class="nav-number">2.2.</span> <span class="nav-text">BasicDepthTest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#split-bucket前后"><span class="nav-number">2.3.</span> <span class="nav-text">split bucket前后</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#split-bucket前"><span class="nav-number">2.3.1.</span> <span class="nav-text">split bucket前</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#split-bucket后"><span class="nav-number">2.3.2.</span> <span class="nav-text">split bucket后</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实现"><span class="nav-number">3.</span> <span class="nav-text">实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Bit-Operation-位操作"><span class="nav-number">3.1.</span> <span class="nav-text">Bit Operation 位操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GET-LAST-N-BITS"><span class="nav-number">3.1.1.</span> <span class="nav-text">GET_LAST_N_BITS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GET-LAST-N-TH-BIT"><span class="nav-number">3.1.2.</span> <span class="nav-text">GET_LAST_N_TH_BIT</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-Bucket"><span class="nav-number">3.2.</span> <span class="nav-text">struct Bucket</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#class-ExtendibleHash-attributes"><span class="nav-number">3.3.</span> <span class="nav-text">class ExtendibleHash attributes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#class-ExtendibleHash-number-function-public-private"><span class="nav-number">3.4.</span> <span class="nav-text">class ExtendibleHash number function (public, private)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Find"><span class="nav-number">3.4.1.</span> <span class="nav-text">Find</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Remove"><span class="nav-number">3.4.2.</span> <span class="nav-text">Remove</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Insert"><span class="nav-number">3.4.3.</span> <span class="nav-text">Insert</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他"><span class="nav-number">3.4.4.</span> <span class="nav-text">其他</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Test"><span class="nav-number">4.</span> <span class="nav-text">Test</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MY-TODO"><span class="nav-number">5.</span> <span class="nav-text">MY-TODO</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="罗济高"
      src="/uploads/avatar.jpeg">
  <p class="site-author-name" itemprop="name">罗济高</p>
  <div class="site-description" itemprop="description">In theory, there is no difference between theory and practice. But, in practice, there is.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">87</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nha2VieXRoZW9jZWFuTHVv" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cakebytheoceanLuo"><i class="fa fa-fw fa-github"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmx1b2ppZ2FvQG91dGxvb2suY29t" title="E-Mail → mailto:luojigao@outlook.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9sdW8tamktZ2Fv" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;luo-ji-gao"><i class="fa fa-fw fa-zhihu"></i>知乎</span>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLzQuMC8="><img src="/images/cc-by-nc.svg" alt="Creative Commons"></span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      其他信息
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="/download/pgp/pgp_key_id.pgp" title="&#x2F;download&#x2F;pgp&#x2F;pgp_key_id.pgp">GPG Key Id： F98069D551217BFD</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="/download/pgp/pgp_fingerprint.pgp" title="&#x2F;download&#x2F;pgp&#x2F;pgp_fingerprint.pgp">GPG Fingerprint：704A 7537 4771 2348 81B1 0559 F980 69D5 5121 7BFD</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="/download/pgp/luojigao@outlook.com.pgp" title="&#x2F;download&#x2F;pgp&#x2F;luojigao@outlook.com.pgp">Download Public Key</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">罗济高</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">432k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">6:33</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>






  <script>
  function leancloudSelector(url) {
    url = encodeURI(url);
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.getAttribute('id'));
      var title = visitors.dataset.flagTitle;

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
              leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .catch(error => {
                console.error('Failed to save visitor count', error);
              })
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.getAttribute('id'));
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (let item of results) {
            let { url, time } = item;
            leancloudSelector(url).innerText = time;
          }
          for (let url of entries) {
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=1vUzCKF76LM44asSN39XkjB8-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : '1vUzCKF76LM44asSN39XkjB8-gzGzoHsz',
            'X-LC-Key'    : 'qWNwcOO6BFrAxr7vtI65ycAA',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  



  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id    : a0693510cb3f0ffe9af58a8252b84fe53b3d16221c333b1f262546c4489047e8,
      el    : 'wpac-rating',
      color : 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>

  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri == 'https://cakebytheoceanluo.github.io/2020/04/17/CMU-15445-17-18-Project1-1/',]
      });
      });
  </script>

</body>
</html>
