<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Database System Concepts ç²¾è¯» [11.6-11.7] Hashing</title>
    <url>/2020/04/11/DSC-11-6-11-7-Hashing/</url>
    <content><![CDATA[<p>[11.6-11.7] Hashing</p>
<a id="more"></a>
<h1 id="11-6-Static-Hashing"><a href="#11-6-Static-Hashing" class="headerlink" title="11.6 Static Hashing"></a>11.6 Static Hashing</h1><ul>
<li>One disadvantage of <strong>sequential file organization</strong> is that we must access an index structure to locate data, or must use binary search, and that results in more I/O operations. æ€»ä¹‹å¾ˆæ…¢ </li>
<li>File organizations based on the technique of hashing allow us to avoid accessing an index structure. Hashing also provides a way of constructing indices.</li>
</ul>
<p><br></p>
<p><strong>Bucket</strong> := a unit of storage that can store one or more records. <strong>A bucket is typically a disk block, but could be chosen to be smaller or larger than a disk block.</strong> Bucketä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé¡µ(page)</p>
<p>$K$ := the set of all search-key values</p>
<p>$B$ := the set of all bucket addresses. </p>
<p>A hash function $h: K \rightarrow B$</p>
<p>$n_b$ := number of buckets</p>
<p><br></p>
<p><strong>Insert</strong> a record with search key $K_i$ at bucket with address $h(K_i)$. Assume for now that there is space in the bucket to store the record. Then, the record is stored in that bucket</p>
<p><strong>Look up</strong>: <em>check the search-key value</em> of every record in bucket with address $h(K_i)$</p>
<p><strong>Delete</strong>: Loop up + delete the found record</p>
<p><strong>Two different purposes of Hasing:</strong></p>
<ul>
<li>In a <strong>hash file organization</strong>, we obtain the address of the disk block containing a desired record directly byã€€computing a function on the search-key value of the record. </li>
<li>In a <strong>hash index organization</strong> we organize the search keys, with their associated pointers, into a hash file structure. ã€€ã€€è§11.6.3</li>
</ul>
<p>å…¶å®å“ˆå¸Œè¡¨åœ¨æ•°æ®åº“ä¸­æœ‰æ›´å¤šç”¨é€”ï¼Œè§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Data-Structure-in-DBMS">[CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨ Data Structure in DBMS</a></p>
<h2 id="11-6-1-Hash-Function"><a href="#11-6-1-Hash-Function" class="headerlink" title="11.6.1 Hash Function"></a>11.6.1 Hash Function</h2><p>Typical hash functions perform computation on the internal binary machine representation of characters in the search key. A simple hash function of this type first computes the sum of the binary representations of the characters of a key, then returns the sum modulo the number of buckets. åŸºäºäºŒè¿›åˆ¶å½¢å¼ï¼Œåšä¸€äº›ä½æ“ä½œ(bit operation)</p>
<p>Hash functions require careful design. A bad hash function may result in lookup taking time proportional to the number of search keys in the file. A well-designed function gives an average-case lookup time that is a (small) constant, independent of the number of search keys in the file.</p>
<h3 id="Two-Qualities"><a href="#Two-Qualities" class="headerlink" title="Two Qualities"></a>Two Qualities</h3><p>An ideal hash function distributes the stored keys uniformly across all the buckets, so that every bucket has the same number of records. We want to choose a hash function that assigns search-key values to buckets in such a way that the distribution has <em>two</em> qualities:</p>
<ul>
<li><strong>The distribution is uniform</strong>: the hash function <strong>assigns each bucket the same number of search-key values</strong> from the set of all possible search-key values.</li>
<li><strong>The distribution is random</strong>: in the average case, each bucket will have nearly the same number of values assigned to it, <strong>regardless of the actual distribution of search-key values</strong>. More precisely, <strong>the hash value will not be correlated to any externally visible ordering on the search-key values</strong>, such as alphabetic ordering or ordering by the length of the search keys; the hash function will appear to be </li>
<li>ç¬¬ä¸€ç‚¹æŒ‡çš„æ˜¯<strong>distribution of search-key values is uniform</strong>, è¿™ä¸ªåˆ†å¸ƒå’Œå®é™…çš„æ•°æ®é›†(record)æ— å…³ã€‚åªæ˜¯è€ƒè™‘æ¯ä¸€ä¸ªbucketç†è®ºæ¥æ”¶çš„search keyçš„æ•°é‡ã€‚</li>
<li>ç¬¬äºŒç‚¹æŒ‡çš„æ˜¯<strong>distribution of search-key values is random</strong>, èƒ½è·å¾—<strong>distribution of records is uniform</strong>, å³æ•°æ®é›†(record)ç›¸å…³ã€‚å®ƒå¯ä»¥å»æ‰ç›¸å…³è”(ä¸ç›¸ç­‰)çš„search-keyä¸­çš„å…³è”, ä½¿è¿™äº›å…³è”çš„search-keyçš„å“ˆå¸Œå€¼éšæœºåŒ–, ä¹Ÿå¤±å»åŸæœ‰çš„å…³è”ã€‚</li>
</ul>
<h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>1.<em>People Name</em>â€˜s Hash Function: mapping names beginning with the ith letter of the alphabet to the ith bucket and having 26 buckets.</p>
<ul>
<li>simple</li>
<li>no uniform distribution: <strong>more</strong> names to begin with such letters as B and R than Q and X, for example.</li>
</ul>
<p>2.Salaryâ€™s Hash Function: the minimum salary is $30,000 and the maximum salary is $130,000, and we use a hash function that <strong>divides the values into 10 ranges</strong>, $30,000-$40,000, $40,001-$50,000 and so on.</p>
<ul>
<li><strong>uniform</strong> distribution of search-key values (since each bucket has the same number of different salary values)</li>
<li>no random distribution. Records with salaries between $60,001 and $70,000 are <strong>far more common than</strong> are<br>records with salaries between $30,001 and $40,000. As a result, <strong><em>the distribution of records</em></strong> is not uniform - some buckets receive more records than others do. <strong>If the function has a random distribution, even if there are such correlations in the search keys, the randomness of the distribution will make it very likely that all buckets will have roughly the same number of records, as long as each search key occurs in only a small fraction of the records.</strong> (If a single search key occurs in a large fraction of the records, the bucket containing it is likely to have more records than other buckets, regardless of the hash function used.)</li>
</ul>
<p>3.Let $s$ be a string of length $n$, and let $s[i]$ denote the $i$th byte of the string. </p>
<ul>
<li>The hash function is defined as: $h(s) = s[0] âˆ— 31(nâˆ’1) + s[1] âˆ— 31(nâˆ’2) + Â·Â·Â· + s[n âˆ’ 1] \; \% \; n_b$</li>
</ul>
<p><br></p>
<h2 id="11-6-2-Handling-of-Bucket-Overflows"><a href="#11-6-2-Handling-of-Bucket-Overflows" class="headerlink" title="11.6.2 Handling of Bucket Overflows"></a>11.6.2 Handling of Bucket Overflows</h2><p>Bucket overflow can occur for several reasons:</p>
<ul>
<li><strong>Insufficient buckets</strong>:<br>The number of buckets $n_b$ must be chosen such that $n_b &gt; n_r / f_r$, where $n_r$ denotes the total number of records that will be stored and $f_r$ denotes the number of records that will fit in a bucket. <strong>This designation assumes that the total number of records is known when the hash function is chosen.</strong> The probability of bucket overflow is reduced, the number of buckets<br>is chosen to be $(n_r / f_r) âˆ— (1 + d)$, where d is a fudge factor, typically around 0.2. Some space is wasted: About 20 percent of the space in the buckets will be empty.</li>
<li><strong>Skew</strong>:<br>Some buckets are <strong>assigned more records than are others</strong>, so a bucket may overflow even when other buckets still have space. This situation is called bucket <em>skew</em>. Skew can occur for two reasons:<ol>
<li>Multiple records may have <strong>the same search key</strong>.ã€€(è§åé¢<a href="#insertion">Dynamic Hashing - Insertion</a>ä¸­çš„å¯¹é‡å¤çš„æè¿° å’Œ <a href="#ä¾‹å­">ä¾‹å­ä¸­ç¬¬äº”æ­¥</a>)</li>
<li>The chosen hash function may result in non-uniform distribution of search keys (å·²ç»åœ¨<a href="#two-qualities">Two Qualities</a>ä¸­è®¨è®ºè¿‡)</li>
</ol>
</li>
</ul>
<h3 id="Overflow-Buckets"><a href="#Overflow-Buckets" class="headerlink" title="Overflow Buckets"></a>Overflow Buckets</h3><p>We handle bucket overflow by using <strong>overflow buckets</strong>. If a record must be inserted into a bucket b, and b is already full, the system provides an overflow bucket for $b$, and inserts the record into the overflow bucket. If the overflow bucket is also full, the system provides another overflow bucket, and so on. </p>
<p>All the overflow buckets of a given bucket are chained together in a linked list, as in <em>Figure 11.24</em>. Overflow handling using such a linked list is called <strong>overflow chaining</strong>. ä¹Ÿå«hashing with chainingæˆ–chained hashing, è§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Chained-Hashing">[CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨- Chained Hashing</a></p>
<p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.24.png" alt="Figure 11.24 Overflow chaining in a hash structure."></p>
<h4 id="Lookup-Algorithm"><a href="#Lookup-Algorithm" class="headerlink" title="Lookup Algorithm"></a>Lookup Algorithm</h4><p>The system uses the hash function on the search key to identify a bucket $b$. The system must examine all the records in bucket $b$ to see whether they match the search key, as before. In addition, if bucket $b$ has overflow buckets, the system must examine the records in all the overflow buckets also.</p>
<h4 id="Closed-Addressing-Hashing-amp-Open-Addressing-Hashing"><a href="#Closed-Addressing-Hashing-amp-Open-Addressing-Hashing" class="headerlink" title="Closed Addressing Hashing &amp; Open Addressing Hashing"></a>Closed Addressing Hashing &amp; Open Addressing Hashing</h4><p>The form of hash structure with <strong>overflow buckets</strong> referred to as <strong>closed addressing hashing</strong>. An important drawback of closed addressing hashing is that we must choose the hash function when we implement the system, and itã€€cannot be changed easily thereafter if the file being indexed grows or shrinks. Since the function $h$ maps search-key values to a fixed set $B$ of bucket addresses, we waste space if $B$ is made large to handle future growth of the file. If $B$ is too small, the buckets contain records of many different search-key values, and bucket overflows can occur. <strong>As the file grows, performance suffers</strong>. </p>
<p>An alternative approach <strong>open addressing hashing</strong>: </p>
<ul>
<li>the set of buckets is fixed, and there are no overflow chains. </li>
<li>Instead, if a bucket is full, the system inserts records in some other bucket in the initial set of buckets $B$.<ul>
<li>One policy <strong>linear probing</strong> is to use the next bucket (in cyclic order) that has space</li>
<li>Other policies, such as computing further hash functions, are also used. </li>
</ul>
</li>
</ul>
<p>Open addressing hashing has been used to construct symbol tables for compilers and assemblers, but closed addressing hashing is preferable for database systems. The reason is that <strong>deletion under open addressing hashing</strong> is troublesome. Usually, compilers and assemblers perform only lookup and insertion operations on their symbol tables. However, in a database system, it is important to be able to handle deletion as<br>well as insertion. Thus, open addressing hashing is of only minor importance in database implementation.</p>
<p>å®é™…ä¸Šopen addressing hashingåœ¨æ•°æ®åº“ä¾ç„¶å¾ˆå¸¸è§è¢«åº”ç”¨çš„ï¼Œç‰¹åˆ«æ˜¯hash joinä¸­æˆ‘ä»¬åªä½¿ç”¨hash tableçš„lookupå’Œinsert, æ ¹æœ¬ä¸deleteã€‚æ›´å¤šç”¨é€”è§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Data-Structure-in-DBMS">[CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨ Data Structure in DBMS</a></p>
<h2 id="11-6-3-Hash-Indices"><a href="#11-6-3-Hash-Indices" class="headerlink" title="11.6.3 Hash Indices"></a>11.6.3 Hash Indices</h2><p>Hashing can be used not only for file organization, but also for <strong>index-structure creation</strong>. </p>
<p><strong>A hash index organizes the search keys, with their associated pointers, into a hash file structure</strong>. We construct a hash index as follows. We apply a hash function on a search key to identify a bucket, and store the key and its associated pointers in the bucket (or in overflow buckets). <em>Figure 11.25</em> shows a secondary hash index on the instructor file, for the search key ID. The hash function in the figure computes the sum of the digits of the ID modulo 8. The hash index has eight buckets, each of size 2 (realistic indices would, of course, have much larger bucket sizes). One of the buckets has three keys mapped to it, so it has an overflow bucket. In this example, ID is a primary key for instructor, so each search key has only one associated pointer. In general, multiple pointers can be associated with each key.</p>
<p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.25.png" alt="Figure 11.25 Hash index on search key *ID* of instructor file."></p>
<ul>
<li>å›¾ä¸­<code>33456</code>æ˜¯ä¸€ä¸ª<strong>åˆ°å¦ä¸€ä¸ªbucketçš„æŒ‡é’ˆ</strong>ï¼Œå…¶ä½™çš„æŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘æ–‡ä»¶ä½ç½®ã€‚åœ¨è¿™è¿™é‡Œæˆ‘ä»¬æ··æ·†æˆ–è€…æ™®éåŒ–<em>æŒ‡é’ˆ</em>è¿™ä¸ªè¯ï¼Œå®ƒåœ¨è¿™é‡ŒæŒ‡å†…å­˜ä¸Šçš„åœ°å€å’Œç¡¬ç›˜ä¸Šçš„åœ°å€ã€‚</li>
</ul>
<p>We use the term hash index to denote hash file structures as well as secondary hash indices. Strictly speaking, hash indices are only secondary index structures. A hash index is never needed as a clustering index structure, since, if a file itself is organized by hashing, there is no need for a separate hash index structure on it. However, since hash file organization provides the same direct access to records that indexing provides, we pretend that a file organized by hashing also has a clustering hash index on it.</p>
<h1 id="11-7-Dynamic-Hashing"><a href="#11-7-Dynamic-Hashing" class="headerlink" title="11.7 Dynamic Hashing"></a>11.7 Dynamic Hashing</h1><p>Extendable hashing is one form of dynamic hashing techniques, which allow the hash function to be <strong>modified dynamically to accommodate the growth or shrinkage of the database</strong>. </p>
<h2 id="11-7-1-Data-Structure"><a href="#11-7-1-Data-Structure" class="headerlink" title="11.7.1 Data Structure"></a>11.7.1 Data Structure</h2><ul>
<li>Space Efficiency: Extendable hashing copes with changes in database size by splitting and coalescing buckets as the database grows and shrinks. </li>
<li>Low Performance Overhead: the reorganization is performed on only one bucket at a time</li>
</ul>
<p>Hash Function: $h$ generates values over a relatively large range ($b$-bit binary integers). A typical value for $b$ is 32.</p>
<p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.26.png" alt="Figure 11.26 General extendable hash structure"></p>
<ul>
<li>We do not create a bucket for each hash value. Indeed, $2^{32}$ is over 4 billion, and that many buckets is unreasonable for all but the largest databases. </li>
<li>Instead, we <strong>create buckets on demand</strong>, as records are inserted into the file. We do not use the entire b bits of the hash value initially. </li>
<li>At any point, we use <strong>$i$ bits indicating that $i$ bits of the hash value $h(K)$ are required to determine the correct bucket for $K$</strong>, where $0 \leq i \leq b$. These $i$ bits are used as an offset into an additional table of bucket addresses. The value of $i$ grows and shrinks with the size of the database.</li>
<li>All such entries will have <strong>a common hash prefix</strong>, but the length of this prefix may be <strong>less than $i$</strong>. Therefore, we associate with each bucket an integer giving the length of the common hash prefix. In <em>Figure 11.26</em> the integer associated with bucket $j$ is shown as $i_j$. The number of bucket-address-tableentries that point to bucket $j$ is $2^{(i-i_j)}$</li>
<li>å›¾ä¸­å·¦ä¾§<code>bucket address table</code>ä¹Ÿç§°ä¸º<code>global directory</code></li>
<li>å›¾ä¸­å³ä¾§<code>bucket</code>ä¹Ÿç§°ä¸º<code>local bucket</code></li>
</ul>
<h2 id="11-7-2-Queries-and-Updates"><a href="#11-7-2-Queries-and-Updates" class="headerlink" title="11.7.2 Queries and Updates"></a>11.7.2 Queries and Updates</h2><p>search-key value $K_l$</p>
<h3 id="Lookup"><a href="#Lookup" class="headerlink" title="Lookup"></a>Lookup</h3><ol>
<li>take the first $i$ high-order bits of $h(K_l)$</li>
<li>look at the corresponding <strong>bucket address table entry</strong> for this bit string</li>
<li>follow the <strong>bucket pointer</strong> in the table entry.</li>
</ol>
<h3 id="Insertion"><a href="#Insertion" class="headerlink" title="Insertion"></a>Insertion</h3><ol>
<li>å…ˆæŒ‰ç…§Lookup æ‰¾åˆ°å¯¹åº”çš„bucket (è§<a href="#-loopup">Loopupæ­¥éª¤</a>)</li>
<li>bucketæ˜¯å¦æ»¡äº†: <ul>
<li>æ²¡æœ‰æ»¡: ç®€å•æ’å…¥å³å¯</li>
<li>æ»¡: If the bucket is full, it <strong>must split the bucket</strong> and <strong>redistribute the current records</strong>, plus the new one. To split the bucket, the system <strong>must first determine from the hash value whether it needs to increase the number of bits that it uses</strong>.<ul>
<li>If $i = i_j$, only one entry in the bucket address table points to bucket $j$: <ul>
<li>The system needs to <strong>increase the size of the bucket address table</strong> so that it can include pointers to the two buckets that result from splitting bucket $j$. It does so by considering an additional bit of the hash value. It increments the value of $i$ by 1, thus doubling the size of the bucket address table. <strong>It replaces each entry by two entries, both of which contain the same pointer as the original entry. Now two entries in <em>the bucket address table</em> point to bucket $j$</strong>. </li>
<li>The system allocates a new bucket (bucket $z$), and sets the second entry to point to the new bucket. It sets $i_j$ and $i_z$ equal to $i$. </li>
<li>Next, it rehashes each record in bucket $j$ and, depending on the first $i$ bits (remember the system has added 1 to $i$), either keeps it in bucket $j$ or allocates it to the newly created bucket $z$.</li>
<li>The system now reattempts the insertion of the new record. <ul>
<li>Usually, the attempt will succeed. </li>
<li>However, if all the records in bucket $j$, as well as the new  record, have the same hash-value prefix, it will be necessary to split a bucket again, since all the records in bucket $j$ and the new record are assigned to the same bucket. If the hash function has been chosen carefully, it is unlikely that a single insertion will require that a bucket be split more than once, <strong>unless there are a large number of records with the same search key</strong>.<br>If all the records in bucket $j$ have the <strong>same search-key value (å³å…è®¸å‡ºç°é‡å¤çš„key value)</strong>, no amount of splitting will help. In such cases, overflow buckets are used to store the records, as in static hashing. (è§<a href="#ä¾‹å­">ä¾‹å­ä¸­ç¬¬äº”æ­¥</a>)</li>
</ul>
</li>
</ul>
</li>
<li>If $i &gt; i_j$, then more than one entry in the bucket address table points to bucket $j$. <ul>
<li><strong>The system can split bucket $j$ without increasing the size of the bucket address table</strong>. Observe that all the entries that point to bucket $j$ correspond to hash prefixes that have the same value on the leftmost $i_j$ bits.</li>
<li><strong>The system allocates a new bucket (bucket $z$), and sets $i_j$ and $i_z$ to the value that results from adding 1 to the original $i_j$ value.</strong> </li>
<li>Next, the system needs to <strong>adjust the entries in <em>the bucket address table</em> that previously pointed to bucket $j$</strong>. (Note that with the new value for $i_j$, not all the entries correspond to hash prefixes that have the same value on the leftmost $i_j$ bits.) The system leaves the first half of the entries as they were (pointing to bucket $j$), and sets all the remaining entries to point to the newly created bucket (bucket $z$).</li>
<li>Next, as in the previous case, the system rehashes each record in bucket $j$, and allocates it either to bucket $j$ or to the newly created bucket $z$.</li>
</ul>
</li>
<li><strong>Note that, in both cases, the system needs to recompute the hash function on only the records in bucket $j$.</strong></li>
<li>æ€»ä½“ä¸Š: $i = i_j$çš„æƒ…å†µåªæ¯”$i &gt; i_j$çš„æƒ…å†µå¤šäº†ä¸€æ­¥, å³<strong>increase the size of the bucket address table</strong>ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Deletion"><a href="#Deletion" class="headerlink" title="Deletion"></a>Deletion</h3><ol>
<li>å…ˆæŒ‰ç…§Lookup æ‰¾åˆ°å¯¹åº”çš„bucket (è§<a href="#-loopup">Loopupæ­¥éª¤</a>)</li>
<li>It removes both the search key from the bucket and the record from the file. </li>
<li>The bucket is removed if it becomes empty. Note that, at this point, several buckets can be coalesced, and the size of the bucket address table can be cut in half.</li>
<li>The bucket address table can be reduced in size. Unlike coalescing of buckets, changing the size of the bucket address table is a rather expensive operation if the table is large. Therefore it may be worthwhile to reduce the bucket-address-table size only if the number of buckets reduces greatly.</li>
</ol>
<p><br></p>
<blockquote>
<p>Let $i$ denote the number of bits of the hash value used in the hash table. Let <strong>bsize</strong> denote the maximum capacity of each bucket. The pseudocode is shown in Figure 11.2.<br>Note that we can <strong>only merge two buckets at a time</strong>. The common hash prefix of the resultant bucket will have length one less than the two buckets merged. Hence we look at the buddy bucket of bucket $j$ differing from it only at the last bit. If the common hash prefix of this bucket is not $i_j$, then this implies that the buddy bucket has been further split and merge is not possible.<br>When merge is successful, further merging may be possible, which is handled by a recursive call to <em>coalesce</em> at the end of the function. <sup><a href="#fn1">1</a></sup></p>
</blockquote>
<p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.S4.png" alt="11.Solution. <sup>[1](#fn1)</sup>"></p>
<p><br><br><br></p>
<h3 id="ä¾‹å­-1"><a href="#ä¾‹å­-1" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>Search Key: <em>dept_name</em> with 32-bit hash value<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.27.png" alt="Figure 11.27 Hash Function for *dept_name*."></p>
<p><br><br><br></p>
<p>To illustrate all the features of extendable hashing in a small structure, we shall make the unrealistic assumption that a bucket can hold only two records.</p>
<ol>
<li><p>The file is empty:<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.28.png" alt="Figure 11.28 Initial extendable hash structure."></p>
</li>
<li><ul>
<li>insert record (10101, Srinivasan, Comp. Sci., 65000); </li>
<li>insert record (12121, Wu, Finance, 90000); </li>
<li>insert record (15151, Mozart, Music, 40000);<ul>
<li>split since $i_0$ full and $i=i_0$;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.29.png" alt="Figure 11.29 Hash structure after three insertions."></li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>insert record (22222,Einstein,Physics,95000);<ul>
<li>split since $i_1$ full and $i=i_1$;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.30.png" alt="Figure 11.30 Hash structure after four insertions."></li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>insert record (32343, El Said, History, 60000);</li>
<li>insert record (33456, Gold, Physics, 87000);<ul>
<li>split since $i_1$ full and $i=i_1$;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.31.png" alt="Figure 11.31 Hash structure after six insertions."></li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>insert record (45565, Katz, Comp. Sci., 75000);<ul>
<li>split since $i_3$ full;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.32.png" alt="Figure 11.32 Hash structure after seven insertions."></li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>insert record (58583, Califieri, History, 62000);</li>
<li>insert record (83821, Brandt, Comp. Sci., 92000);<ul>
<li>This overflow cannot be handled by increasing the number of bits, since there are three records with exactly the same hash value. Hence the system uses an overflow bucket.<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.33.png" alt="Figure 11.33 Hash structure after eleven insertions."></li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>insert record (98345, Kim, Elec. Eng., 80000);<ul>
<li>split since $i_0$ full;<br><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.34.png" alt="Figure 11.34 Extendable hash structure for the instructor file."></li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="11-7-3-Static-Hashing-versus-Dynamic-Hashing"><a href="#11-7-3-Static-Hashing-versus-Dynamic-Hashing" class="headerlink" title="11.7.3 Static Hashing versus Dynamic Hashing"></a>11.7.3 Static Hashing versus Dynamic Hashing</h1><p>å®é™…ä¸Šæ˜¯è®¨è®º<strong>extendable hashingçš„ä¼˜ç¼ºç‚¹</strong></p>
<h2 id="Advantages"><a href="#Advantages" class="headerlink" title="Advantages"></a>Advantages</h2><ul>
<li><strong>performance does not degrade</strong> as the file grows </li>
<li><strong>minimal space overhead</strong>: Although the bucket address table incurs additional overhead, it contains one pointer for each hash value for the current prefix length. This table is thus small. The main space saving of extendable hashing over other forms of hashing is that no buckets need to be reserved for future growth; rather, buckets can be allocated dynamically.</li>
</ul>
<h2 id="Disadvantages"><a href="#Disadvantages" class="headerlink" title="Disadvantages"></a>Disadvantages</h2><ul>
<li>lookup involves <strong>an additional level of indirection (ä½¿ç”¨ä¸€æ¬¡æŒ‡é’ˆ)</strong>, since the system <strong>must access the bucket address table</strong> before accessing the bucket itself. This extra reference has only a minor effect on performance. Although the hash structures that we discussed in Section 11.6 do not have this extra level of indirection, they lose their minor performance advantage as they become full.</li>
</ul>
<p>another form of dynamic hashing: <strong>linear hashing</strong>, which avoids the extra level of indirection associated with extendable hashing, at the possible cost of more overflow buckets. <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Linear-Hashing">è§åšå®¢å¦ä¸€ç¯‡æ–‡ç« : [CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨ - Linear Hashing</a></p>
<hr>
<h1 id="Errata-2"><a href="#Errata-2" class="headerlink" title="Errata 2"></a>Errata <sup><a href="#fn2">2</a></sup></h1><p><img data-src="https://cakebytheoceanluo.github.io/images/DSC/11.E1.png" alt="Errata"></p>
<p>17å·²ç»è¢«æˆ‘åœ¨è¿™ç¯‡æ–‡ç« ä¸­çº æ­£</p>
<p>18åœ¨å›¾ä¸­ï¼Œä½†æ˜¯ä¸é‡è¦</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><p><a name="#fn1">1</a>: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L3ByYWN0aWNlLWV4ZXItZGlyL2luZGV4Lmh0bWw=" title="https://www.db-book.com/db6/practice-exer-dir/index.html">https://www.db-book.com/db6/practice-exer-dir/index.html<i class="fa fa-external-link"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L3ByYWN0aWNlLWV4ZXItZGlyLzExcy5wZGY=" title="https://www.db-book.com/db6/practice-exer-dir/11s.pdf">https://www.db-book.com/db6/practice-exer-dir/11s.pdf<i class="fa fa-external-link"></i></span></p>
</li>
<li><p><a name="#fn2">2</a>: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L2VycmF0YS1kaXIvZXJyYXRhLXBhcnQzLnBkZg==" title="https://www.db-book.com/db6/errata-dir/errata-part3.pdf">https://www.db-book.com/db6/errata-dir/errata-part3.pdf<i class="fa fa-external-link"></i></span></p>
</li>
<li><p>Abraham Silberschatz, Henry F. Korth, S. Sudarshan: <strong>Database System Concepts</strong>, 6th Edition. McGraw-Hill Book Company 2010</p>
<ul>
<li>6th Edition: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db6/index.html">https://www.db-book.com/db6/index.html<i class="fa fa-external-link"></i></span></li>
<li>7th Edition: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI3L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db7/index.html">https://www.db-book.com/db7/index.html<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Database System Concepts</category>
      </categories>
      <tags>
        <tag>Hash Function</tag>
        <tag>Hash Scheme</tag>
        <tag>Static Hashing Scheme</tag>
        <tag>Dynamic Hashing Scheme</tag>
        <tag>Chained Hashing</tag>
        <tag>Extendible Hashing</tag>
        <tag>Books</tag>
      </tags>
  </entry>
  <entry>
    <title>Database System Concepts-ç²¾è¯»</title>
    <url>/2020/04/10/DSC-0/</url>
    <content><![CDATA[<h1 id="ç¬”è®°æ–‡ç« é“¾æ¥"><a href="#ç¬”è®°æ–‡ç« é“¾æ¥" class="headerlink" title="ç¬”è®°æ–‡ç« é“¾æ¥"></a>ç¬”è®°æ–‡ç« é“¾æ¥</h1><ul>
<li>Chapter 11 Indexing and Hashing:<ul>
<li>11.6-11.7 Hashing: <a href="https://cakebytheoceanluo.github.io/2020/04/11/DSC-11-6-11-7-Hashing/">Database System Concepts ç²¾è¯» [11.6-11.7] Hashing</a></li>
</ul>
</li>
</ul>
<p>æ­¤åŒºåŸŸæŒç»­æ›´æ–°</p>
<hr>
<a id="more"></a>
<h1 id="ç¬”è®°æ¦‚è¦"><a href="#ç¬”è®°æ¦‚è¦" class="headerlink" title="ç¬”è®°æ¦‚è¦"></a>ç¬”è®°æ¦‚è¦</h1><p>æ­¤ç³»åˆ—æ–‡ç« ä¼šä¸å®šæ—¶æ›´æ–°ã€‚<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8">ğŸ˜„</span></p>
<p>æˆ‘åœ¨è¿™é‡Œåˆ†äº«æˆ‘çš„è¯»ä¹¦ç¬”è®°, æˆ‘ä½¿ç”¨æ˜¯è¿™æœ¬ä¹¦ç¬¬å…­ç‰ˆ: Abraham Silberschatz, Henry F. Korth, S. Sudarshan: <strong>Database System Concepts</strong>, 6th Edition. McGraw-Hill Book Company 2010</p>
<blockquote>
<ul>
<li>å¸†èˆ¹ä¹¦ï¼šAbraham Silberschatz, Henry F. Korth, S. Sudarshan: <strong>Database System Concepts</strong>, 6th Edition. McGraw-Hill Book Company 2010<ul>
<li>ç¬¬å…­ç‰ˆ: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db6/index.html">https://www.db-book.com/db6/index.html<i class="fa fa-external-link"></i></span></li>
<li>ç¬¬ä¸ƒç‰ˆ 2019: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI3L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db7/index.html">https://www.db-book.com/db7/index.html<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8xMDU0ODM3OS8=" title="https://book.douban.com/subject/10548379/">https://book.douban.com/subject/10548379/<i class="fa fa-external-link"></i></span></li>
<li>æ³¨: é«˜ç­‰æ•™è‚²å‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yNjA0NTkzMS8=" title="https://book.douban.com/subject/26045931/">https://book.douban.com/subject/26045931/<i class="fa fa-external-link"></i></span></li>
<li>æ³¨: æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yMDQ4MDY5My8=" title="https://book.douban.com/subject/20480693/">https://book.douban.com/subject/20480693/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
</ul>
</blockquote>
<p>â€” å¼•ç”¨è‡ªæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/10/books/">[DBMS Books] æ•°æ®åº“ä¹¦ç±æ¨è</a></p>
<p>æˆ‘çš„ç¬”è®°å±äº<strong>ç²¾è¯»ç»†è¯»</strong>, å¤§è‡´ä¸Šæˆ‘ä¼šä»”ç»†çœ‹å¯¹åº”çš„éƒ¨åˆ†ä¸¤æ¬¡, ç„¶åç•™ä¸‹ç¬”è®°ã€‚æˆ‘çš„ç›®æ ‡æ˜¯: </p>
<ul>
<li>åœ¨æˆ‘<strong>é‡è§†éƒ¨åˆ†</strong>ç¬”è®°ä¼šä½¿ç”¨åŸæ–‡é‡çš„50%ã€‚æˆ‘é‡è§†éƒ¨åˆ†å¤§è‡´å’Œ<strong>æ•°æ®åº“çš„å®ç°å’Œç®—æ³•ç›¸å…³</strong>ã€‚</li>
<li>æˆ‘ç›®å‰å…ˆä¸å¤„ç†<strong>ä¸å¤ªé‡è§†éƒ¨åˆ†</strong>ã€‚æ¯”å¦‚æ•°æ®åº“çš„ç†è®ºçš„éƒ¨åˆ†: Relation Algebra, Function Dependence.</li>
</ul>
<p>å› æ­¤æˆ‘çš„ç¬”è®°ä¼šå¼ºçƒˆä¾èµ–äºè‹±æ–‡åŸæ–‡ã€‚ç¬”è®°å¯¹æˆ‘ä¸ªäººçš„ç”¨é€”æ˜¯ï¼Œåœ¨å®ç°çš„æ—¶å€™å¯ä»¥æœ‰å¾ˆå¤§çš„å¸®åŠ©å’Œæç¤º(æ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä¸ä¼šå¤§é‡æ›´æ”¹åŸæ–‡)ã€‚å¯¹äºå¤§å®¶ï¼Œå¯ä»¥æŠŠæˆ‘çš„ç¬”è®°æƒ³è±¡æˆåŸä¹¦çš„ç²¾ç®€ç‰ˆã€‚æˆ–è€…å¯ä»¥è¯»å®Œä¹¦ä»¥åï¼Œé‚£æˆ‘çš„ç¬”è®°å»å¤ä¹ ã€‚</p>
<p>æˆ‘å…·ä½“ä¼š<strong>å¢åŠ </strong>çš„åœ°æ–¹:</p>
<ul>
<li>æ®µè½é‡æ–°æ’åº</li>
<li>æ·»åŠ å°‘é‡æ³¨é‡Šå’Œè§£é‡Š(<strong>ä½¿ç”¨ä¸­æ–‡</strong>)</li>
<li>æ·»åŠ åˆ°å…¶å®ƒç¬”è®°çš„é“¾æ¥</li>
<li>é‡æ–°ç»„ç»‡è¯­è¨€</li>
</ul>
<p>æˆ‘å…·ä½“ä¼š<strong>ä¿ç•™</strong>çš„éƒ¨åˆ†:</p>
<ul>
<li>æ•°æ®åº“å®ç°ç›¸å…³<ul>
<li>æ•°æ®åº“ä¸­çš„ç®—æ³•å’Œæ•°æ®ç»“æ„</li>
</ul>
</li>
<li>å„ä¸ªæ¦‚å¿µçš„å®šä¹‰</li>
<li>å„ä¸ªéƒ¨åˆ†çš„å…³è”æ€§å’Œä¼˜ç¼ºç‚¹</li>
</ul>
<p>æˆ‘å…·ä½“ä¼š<strong>å»æ‰</strong>çš„åœ°æ–¹:</p>
<ul>
<li>éæ ¸å¿ƒä¾‹å­</li>
<li>å»æ‰æ•™ç§‘ä¹¦ä¸­é‡å¤æç¤ºçš„éƒ¨åˆ†</li>
</ul>
<h1 id="å£°æ˜"><a href="#å£°æ˜" class="headerlink" title="å£°æ˜"></a>å£°æ˜</h1><p>æ­¤ç³»åˆ—æ–‡ç« ä¸æ„æˆå•†ä¸šè¡Œä¸ºï¼Œè‹¥æœ‰ä¾µæƒï¼Œæˆ‘ç«‹å³åˆ é™¤ã€‚</p>
<h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><p>æˆ‘åœ¨è¿™ä¸€ç¯‡æ–‡ç« ä¸­å¯¹æˆ‘è¿™æœ¬ä¹¦çš„è¯»ä¹¦ç¬”è®°å¼•ç”¨è¿›è¡Œå£°æ˜:</p>
<p>Abraham Silberschatz, Henry F. Korth, S. Sudarshan: <strong>Database System Concepts</strong>, 6th Edition. McGraw-Hill Book Company 2010</p>
<ul>
<li>6th Edition: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db6/index.html">https://www.db-book.com/db6/index.html<i class="fa fa-external-link"></i></span></li>
<li>7th Edition: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI3L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db7/index.html">https://www.db-book.com/db7/index.html<i class="fa fa-external-link"></i></span></li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Database System Concepts</category>
      </categories>
      <tags>
        <tag>Books</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(7)</title>
    <url>/2020/04/09/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-7/</url>
    <content><![CDATA[<p>åœ¨äº†è§£äº†çª—å£å‡½æ•°åï¼Œ æˆ‘ä»¬è¿™æ¬¡å¯¹å®ƒè¿›è¡Œæœ€å(?)ä¸€æ¬¡ç»ƒä¹ ã€‚æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªç§‹æœ‰é—®é¢˜ï¼Œå³ä¸€äº›è¿ç»­çš„æ•°å­—æ˜¯å¦è¢«ä½¿ç”¨å®Œã€‚è¿™æ¬¡çš„æ•°æ®é›†ç›´æ¥å­˜åœ¨äºSQLè¯­å¥é‡Œé¢ã€‚</p>
<a id="more"></a>
<h1 id="ç§‹æ¸¸é—®é¢˜"><a href="#ç§‹æ¸¸é—®é¢˜" class="headerlink" title="ç§‹æ¸¸é—®é¢˜"></a>ç§‹æ¸¸é—®é¢˜</h1><p>æˆ‘ä»¬ç”¨SQLä¸ºä¸‹é¢çš„é—®é¢˜å»ºç«‹ä¸€ä¸ªæ¨¡å‹ï¼š</p>
<ul>
<li>æˆ‘ä»¬åœ¨Aç‚¹åˆ°Bç‚¹æ¸¸ç©ï¼Œè¿™ä¸¤ç‚¹ä¹‹å‰æœ‰å¾ˆå¤šè·¯æ®µå¯ä»¥å»æ¸¸ç©ï¼Œè€Œæˆ‘ä»¬ä»¥åŠæ¸¸ç©è¿‡å…¶ä¸­éƒ¨åˆ†çš„è·¯æ®µäº†</li>
<li><code>trails</code>æŒ‡æ‰€æœ‰çš„è·¯æ®µï¼Œè¿™äº›è·¯æ®µæœ‰è‡ªå·±çš„<code>id</code>å»ç¡®å®šå”¯ä¸€æ€§<ul>
<li>æˆ‘ä»¬ä¸€å…±æœ‰ä¸¤ç§è·¯æ®µ, åˆ†åˆ«ä¸º<code>id</code>0å’Œ1ï¼Œ <code>leg</code>é•¿åº¦ä¸º28å’Œ15</li>
</ul>
</li>
<li><code>completed</code>æŒ‡æˆ‘ä»¬å·²ç»ç©è¿‡çš„è·¯æ®µ</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> completed;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="å®Œæˆè¿ç»­çš„è·¯æ®µçš„æ•°é‡"><a href="#å®Œæˆè¿ç»­çš„è·¯æ®µçš„æ•°é‡" class="headerlink" title="å®Œæˆè¿ç»­çš„è·¯æ®µçš„æ•°é‡"></a>å®Œæˆè¿ç»­çš„è·¯æ®µçš„æ•°é‡</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span> (*)</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> trail_id,</span><br><span class="line">                    leg - row_number() <span class="keyword">over</span> (</span><br><span class="line">                        <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">                        <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">section</span></span><br><span class="line">    <span class="keyword">from</span> completed</span><br><span class="line">) <span class="keyword">as</span> temp;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> count </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line">     5</span><br><span class="line">(1 row)</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é¢˜ä¸­è¡¨æ ¼çš„æ€è·¯æ˜¯</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> trail_id,</span><br><span class="line">                leg,</span><br><span class="line">                row_number() <span class="keyword">over</span> (</span><br><span class="line">                    <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> leg),</span><br><span class="line">                leg - row_number() <span class="keyword">over</span> (</span><br><span class="line">                    <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">section</span></span><br><span class="line"><span class="keyword">from</span> completed</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> trail_id, <span class="keyword">section</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> trail_id | leg | row_number | section </span><br><span class="line"><span class="comment">----------+-----+------------+---------</span></span><br><span class="line">        1 |   1 |          1 |       0</span><br><span class="line">        1 |   2 |          2 |       0</span><br><span class="line">        1 |   3 |          3 |       0</span><br><span class="line">        1 |   8 |          4 |       4</span><br><span class="line">        1 |   9 |          5 |       4</span><br><span class="line">        1 |  22 |          6 |      16</span><br><span class="line">        1 |  23 |          7 |      16</span><br><span class="line">        2 |   1 |          1 |       0</span><br><span class="line">        2 |   2 |          2 |       0</span><br><span class="line">        2 |  11 |          3 |       8</span><br><span class="line">        2 |  12 |          4 |       8</span><br><span class="line">(11 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><code>section</code>å€¼ç›¸åŒçš„éƒ¨åˆ†ï¼Œå±äºè¿ç»­çš„è·¯æ®µ</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> trail_id,</span><br><span class="line">                leg - row_number() <span class="keyword">over</span> (</span><br><span class="line">                    <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">section</span></span><br><span class="line"><span class="keyword">from</span> completed</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> trail_id, <span class="keyword">section</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> trail_id | section </span><br><span class="line"><span class="comment">----------+---------</span></span><br><span class="line">        1 |       0</span><br><span class="line">        1 |       4</span><br><span class="line">        1 |      16</span><br><span class="line">        2 |       0</span><br><span class="line">        2 |       8</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="æ±‚è¿ç»­è·¯æ®µé•¿åº¦çš„å¹³å‡å€¼ï¼Œæœ€å¤§å€¼å’Œæœ€å°å€¼"><a href="#æ±‚è¿ç»­è·¯æ®µé•¿åº¦çš„å¹³å‡å€¼ï¼Œæœ€å¤§å€¼å’Œæœ€å°å€¼" class="headerlink" title="æ±‚è¿ç»­è·¯æ®µé•¿åº¦çš„å¹³å‡å€¼ï¼Œæœ€å¤§å€¼å’Œæœ€å°å€¼"></a>æ±‚è¿ç»­è·¯æ®µé•¿åº¦çš„å¹³å‡å€¼ï¼Œæœ€å¤§å€¼å’Œæœ€å°å€¼</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(c), <span class="keyword">min</span>(c), <span class="keyword">max</span>(c)</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> c</span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">select</span> trail_id,</span><br><span class="line">        leg - row_number() <span class="keyword">over</span> (</span><br><span class="line">            <span class="keyword">partition</span> <span class="keyword">by</span> trail_id</span><br><span class="line">            <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">as</span> <span class="keyword">section</span></span><br><span class="line">        <span class="keyword">from</span> completed</span><br><span class="line">    ) <span class="keyword">as</span> temp_count</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> trail_id , <span class="keyword">section</span></span><br><span class="line">) <span class="keyword">as</span> temp_stat;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">        avg         | min | max </span><br><span class="line"><span class="comment">--------------------+-----+-----</span></span><br><span class="line"> 2.2000000000000000 |   2 |   3</span><br><span class="line">(1 row)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="å¯¹æœªå®Œæˆçš„è·¯æ®µè¿›è¡Œåˆ†æ"><a href="#å¯¹æœªå®Œæˆçš„è·¯æ®µè¿›è¡Œåˆ†æ" class="headerlink" title="å¯¹æœªå®Œæˆçš„è·¯æ®µè¿›è¡Œåˆ†æ"></a>å¯¹æœªå®Œæˆçš„è·¯æ®µè¿›è¡Œåˆ†æ</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">id</span>,</span><br><span class="line">    <span class="keyword">min</span>(leg) <span class="keyword">as</span> firstLeg,</span><br><span class="line">    <span class="keyword">max</span>(leg) <span class="keyword">as</span> LastLeg,</span><br><span class="line">    <span class="keyword">max</span>(leg) - <span class="keyword">min</span>(leg) + <span class="number">1</span> <span class="keyword">as</span> <span class="keyword">length</span>,</span><br><span class="line">    <span class="keyword">section</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span>,</span><br><span class="line">           leg,</span><br><span class="line">           leg - row_number() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">order</span> <span class="keyword">by</span> leg) <span class="keyword">section</span></span><br><span class="line">    <span class="keyword">from</span> trails</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> completed c</span><br><span class="line">        <span class="keyword">where</span> trail_id = trails.id</span><br><span class="line">        <span class="keyword">and</span> trails.leg = c.leg</span><br><span class="line">    )</span><br><span class="line">) <span class="keyword">as</span> temp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>, <span class="keyword">section</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">length</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> id | firstleg | lastleg | length | section </span><br><span class="line"><span class="comment">----+----------+---------+--------+---------</span></span><br><span class="line">  2 |       13 |      15 |      3 |       4</span><br><span class="line">  1 |        4 |       7 |      4 |       3</span><br><span class="line">  1 |       24 |      28 |      5 |       7</span><br><span class="line">  2 |        3 |      10 |      8 |       2</span><br><span class="line">  1 |       10 |      21 |     12 |       5</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure>
<p>æ€è·¯:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> trails (<span class="keyword">id</span>, leg) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">28</span>) leg</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">2</span>, leg</span><br><span class="line">    <span class="keyword">from</span> generate_series (<span class="number">1</span>, <span class="number">15</span>) leg</span><br><span class="line">    ),</span><br><span class="line">     completed (trail_id , leg) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">values</span> (<span class="number">1</span> ,<span class="number">1</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">22</span>),</span><br><span class="line">               (<span class="number">1</span>, <span class="number">23</span>), (<span class="number">2</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">               (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">2</span>,<span class="number">12</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,</span><br><span class="line">       leg,</span><br><span class="line">       row_number() <span class="keyword">over</span> w,</span><br><span class="line">       leg - row_number() <span class="keyword">over</span> w <span class="keyword">section</span></span><br><span class="line"><span class="keyword">from</span> trails</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> completed c</span><br><span class="line">    <span class="keyword">where</span> trail_id = trails.id</span><br><span class="line">    <span class="keyword">and</span> trails.leg = c.leg</span><br><span class="line">)</span><br><span class="line"><span class="keyword">window</span> w <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">id</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> leg</span><br><span class="line">)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>, leg;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> id | leg | row_number | section </span><br><span class="line"><span class="comment">----+-----+------------+---------</span></span><br><span class="line">  1 |   4 |          1 |       3</span><br><span class="line">  1 |   5 |          2 |       3</span><br><span class="line">  1 |   6 |          3 |       3</span><br><span class="line">  1 |   7 |          4 |       3</span><br><span class="line">  1 |  10 |          5 |       5</span><br><span class="line">  1 |  11 |          6 |       5</span><br><span class="line">  1 |  12 |          7 |       5</span><br><span class="line">  1 |  13 |          8 |       5</span><br><span class="line">  1 |  14 |          9 |       5</span><br><span class="line">  1 |  15 |         10 |       5</span><br><span class="line">  1 |  16 |         11 |       5</span><br><span class="line">  1 |  17 |         12 |       5</span><br><span class="line">  1 |  18 |         13 |       5</span><br><span class="line">  1 |  19 |         14 |       5</span><br><span class="line">  1 |  20 |         15 |       5</span><br><span class="line">  1 |  21 |         16 |       5</span><br><span class="line">  1 |  24 |         17 |       7</span><br><span class="line">  1 |  25 |         18 |       7</span><br><span class="line">  1 |  26 |         19 |       7</span><br><span class="line">  1 |  27 |         20 |       7</span><br><span class="line">  1 |  28 |         21 |       7</span><br><span class="line">  2 |   3 |          1 |       2</span><br><span class="line">  2 |   4 |          2 |       2</span><br><span class="line">  2 |   5 |          3 |       2</span><br><span class="line">  2 |   6 |          4 |       2</span><br><span class="line">  2 |   7 |          5 |       2</span><br><span class="line">  2 |   8 |          6 |       2</span><br><span class="line">  2 |   9 |          7 |       2</span><br><span class="line">  2 |  10 |          8 |       2</span><br><span class="line">  2 |  13 |          9 |       4</span><br><span class="line">  2 |  14 |         10 |       4</span><br><span class="line">  2 |  15 |         11 |       4</span><br><span class="line">(32 rows)</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(6)</title>
    <url>/2020/04/08/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-6/</url>
    <content><![CDATA[<p>æˆ‘ä»¬ç»§ç»­ç»ƒä¹ çª—å£å‡½æ•°ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨TPC-Hæ•°æ®é›†æ¥ç»ƒä¹ ã€‚TPC-Hæ˜¯ä¸€ä¸ªå•†ä¸šå†³ç­–æ–¹å‘çš„æ•°æ®é›†ï¼Œå› æ­¤é‡Œé¢æœ‰å¾ˆå¤šé‡‘é¢/é”€å”®é¢/å¹´åº¦é”€å”®é¢/å›½å®¶é”€å”®é¢ç­‰ç­‰OLAPçš„æ•°ç›®å¯ä»¥è¢«è®¡ç®—ã€‚</p>
<a id="more"></a>
<h1 id="TPC-H-æ•°æ®é›†"><a href="#TPC-H-æ•°æ®é›†" class="headerlink" title="TPC-H æ•°æ®é›†"></a>TPC-H æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br><code>TPC-H</code>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p><strong>æœ¬åœ°è½½å…¥æ”¹æ•°æ®é›†</strong>çš„æ–¹æ³•è§æˆ‘çš„åšå®¢ä¸¤ç¯‡æ–‡ç« :</p>
<ul>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥ TPC-H æ•°æ®é›†</a></li>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†</a></li>
</ul>
<p><br><br><br></p>
<h2 id="sets-rollup-cube"><a href="#sets-rollup-cube" class="headerlink" title="sets, rollup, cube"></a>sets, rollup, cube</h2><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/36.jpg" alt="36.jpg"></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">group by grouping sets ((a, b), (a), ())</span><br><span class="line">``` </span><br><span class="line">= </span><br><span class="line">```SQL</span><br><span class="line">group by rollup (a, b)</span><br></pre></td></tr></tbody></table></figure>
<p>=<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a, b, <span class="keyword">sum</span>(x) <span class="keyword">from</span> r <span class="keyword">group</span> <span class="keyword">by</span> a, b</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> a, <span class="literal">null</span>, <span class="keyword">sum</span>(x) <span class="keyword">from</span> r <span class="keyword">group</span> <span class="keyword">by</span> a</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="literal">null</span>, <span class="literal">null</span>, <span class="keyword">sum</span>(x) <span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><br><br><br></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">group by cube (a, b)</span><br><span class="line">``` </span><br><span class="line">= </span><br><span class="line">```SQL</span><br><span class="line">group by grouping sets ((a, b), (a), (b), ())</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<ul>
<li>å…¶ä¸­<code>()</code>æŒ‡çš„æ˜¯ç©ºé›†</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                        (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                        (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                        (<span class="literal">NULL</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(y)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> x;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x | sum </span><br><span class="line"><span class="comment">---+-----</span></span><br><span class="line">   |   4</span><br><span class="line"> 1 |   5</span><br><span class="line">(2 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                        (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                        (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                        (<span class="literal">NULL</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(y), <span class="keyword">grouping</span>(x)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">rollup</span>(x);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x | sum | grouping </span><br><span class="line"><span class="comment">---+-----+----------</span></span><br><span class="line">   |   9 |        1</span><br><span class="line">   |   4 |        0</span><br><span class="line"> 1 |   5 |        0</span><br><span class="line">(3 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<h3 id="è®¡ç®—å„ä¸ªnation-region-all-å…¨çƒ-çš„revenue"><a href="#è®¡ç®—å„ä¸ªnation-region-all-å…¨çƒ-çš„revenue" class="headerlink" title="è®¡ç®—å„ä¸ªnation, region, all(å…¨çƒ)çš„revenue:"></a>è®¡ç®—å„ä¸ªnation, region, all(å…¨çƒ)çš„revenue:</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/37.jpg" alt="37.jpg"></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> revenue, r_name, n_name</span><br><span class="line"><span class="keyword">from</span> orders, customer, nation, region</span><br><span class="line"><span class="keyword">where</span> o_custkey = c_custkey <span class="keyword">and</span> c_nationkey = n_nationkey <span class="keyword">and</span> n_regionkey = r_regionkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">rollup</span>(r_name, n_name)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> r_name, n_name;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="grouping"><a href="#grouping" class="headerlink" title="grouping"></a>grouping</h4><p>ä¸‹é¢è¿™ä¸ªç‰ˆæœ¬åœ¨ä¸Šé¢SQLåŸºç¡€ä¸ŠåŠ ä¸Šäº†<code>grouping</code>, å®ƒä»£è¡¨<strong>è¢«èšåˆæˆç»„çš„ä¸ªæ•°</strong>ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> revenue, r_name, n_name, <span class="keyword">grouping</span>(r_name, n_name)</span><br><span class="line"><span class="keyword">from</span> orders, customer, nation, region</span><br><span class="line"><span class="keyword">where</span> o_custkey = c_custkey <span class="keyword">and</span> c_nationkey = n_nationkey <span class="keyword">and</span> n_regionkey = r_regionkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">rollup</span>(r_name, n_name)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> r_name, n_name;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">     revenue     |          r_name           |          n_name           | grouping </span><br><span class="line"><span class="comment">-----------------+---------------------------+---------------------------+----------</span></span><br><span class="line">   9065723966.78 | AFRICA                    | ALGERIA                   |        0</span><br><span class="line">   9032642974.38 | AFRICA                    | ETHIOPIA                  |        0</span><br><span class="line">   8897163266.18 | AFRICA                    | KENYA                     |        0</span><br><span class="line">   8985579085.22 | AFRICA                    | MOROCCO                   |        0</span><br><span class="line">   9249114609.66 | AFRICA                    | MOZAMBIQUE                |        0</span><br><span class="line">  45230223902.22 | AFRICA                    |                           |        1</span><br><span class="line">   9022490350.05 | AMERICA                   | ARGENTINA                 |        0</span><br><span class="line">   9107367126.70 | AMERICA                   | BRAZIL                    |        0</span><br><span class="line">   9143635385.19 | AMERICA                   | CANADA                    |        0</span><br><span class="line">   8946481134.38 | AMERICA                   | PERU                      |        0</span><br><span class="line">   9086969258.89 | AMERICA                   | UNITED STATES             |        0</span><br><span class="line">  45306943255.21 | AMERICA                   |                           |        1</span><br><span class="line">   9161685172.34 | ASIA                      | CHINA                     |        0</span><br><span class="line">   9035791922.09 | ASIA                      | INDIA                     |        0</span><br><span class="line">   9300830039.29 | ASIA                      | INDONESIA                 |        0</span><br><span class="line">   8993418470.64 | ASIA                      | JAPAN                     |        0</span><br><span class="line">   9121689438.20 | ASIA                      | VIETNAM                   |        0</span><br><span class="line">  45613415042.56 | ASIA                      |                           |        1</span><br><span class="line">   9318715232.78 | EUROPE                    | FRANCE                    |        0</span><br><span class="line">   9039194008.74 | EUROPE                    | GERMANY                   |        0</span><br><span class="line">   9196280024.51 | EUROPE                    | ROMANIA                   |        0</span><br><span class="line">   9282323186.28 | EUROPE                    | RUSSIA                    |        0</span><br><span class="line">   8956753007.40 | EUROPE                    | UNITED KINGDOM            |        0</span><br><span class="line">  45793265459.71 | EUROPE                    |                           |        1</span><br><span class="line">   8925726169.17 | MIDDLE EAST               | EGYPT                     |        0</span><br><span class="line">   9025552858.09 | MIDDLE EAST               | IRAN                      |        0</span><br><span class="line">   8892603095.99 | MIDDLE EAST               | IRAQ                      |        0</span><br><span class="line">   9229296044.98 | MIDDLE EAST               | JORDAN                    |        0</span><br><span class="line">   8812280619.53 | MIDDLE EAST               | SAUDI ARABIA              |        0</span><br><span class="line">  44885458787.76 | MIDDLE EAST               |                           |        1</span><br><span class="line"> 226829306447.46 |                           |                           |        3</span><br><span class="line">(31 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<h2 id="cube"><a href="#cube" class="headerlink" title="cube"></a><code>cube</code></h2><h2 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h2><ul>
<li>æ±‚å‡ºæ‰€æœ‰è¦æ±‚çš„lineitemçš„trade volume(å³l_quantity * l_extendedprice)çš„æ€»å’Œ<ul>
<li>è¿™äº›lineitemè¢«è¦æ±‚ï¼šå¯¹åº”<code>nation.n_name</code>æ˜¯<code>UNITED STATES</code>, å¯¹åº”çš„<code>c_mktsegment</code>æ˜¯<code>AUTOMOBILE</code></li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span> (l_quantity * l_extendedprice)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    lineitem,</span><br><span class="line">    orders,</span><br><span class="line">    customer,</span><br><span class="line">    nation</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_orderkey = o_orderkey <span class="keyword">and</span></span><br><span class="line">    o_custkey = c_custkey <span class="keyword">and</span></span><br><span class="line">    c_nationkey = n_nationkey <span class="keyword">and</span></span><br><span class="line">    c_mktsegment = <span class="string">'AUTOMOBILE'</span> <span class="keyword">and</span></span><br><span class="line">    n_name = <span class="string">'UNITED STATES'</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ±‚æ‰€æœ‰è¦æ±‚çš„lineitemçš„trade volumeçš„æ€»å’Œ<ul>
<li>è¿™äº›lineitemè¢«è¦æ±‚æ˜¯æ¥è‡ªè¢«åŒä¸€ä¸ªnationçš„supplierå’Œcustomer</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">sum</span>(l_quantity * l_extendedprice)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    lineitem,</span><br><span class="line">    orders,</span><br><span class="line">    customer,</span><br><span class="line">    supplier</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_orderkey = o_orderkey <span class="keyword">and</span></span><br><span class="line">    o_custkey = c_custkey <span class="keyword">and</span></span><br><span class="line">    l_suppkey = s_suppkey <span class="keyword">and</span></span><br><span class="line">    s_nationkey = c_nationkey;</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸ºäº†å¯¹ç±»ä¼¼è¿™äº›Queryè¿›è¡ŒåŠ é€Ÿï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>cube</code>å‡½æ•°æ¥ç‰©è´¨åŒ–(materialize)é¢„å…ˆè®¡ç®—(precompute)é›†åˆ(aggregates)ã€‚</p>
<p><br></p>
<h3 id="ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦c-mktsegment-c-nation-s-nationä¸Šçš„cube-åœ¨ç»„é‡Œé¢å¯¹l-quantity-l-extendedpriceæ±‚å’Œ"><a href="#ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦c-mktsegment-c-nation-s-nationä¸Šçš„cube-åœ¨ç»„é‡Œé¢å¯¹l-quantity-l-extendedpriceæ±‚å’Œ" class="headerlink" title="ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦c_mktsegment, c_nation, s_nationä¸Šçš„cube, åœ¨ç»„é‡Œé¢å¯¹l_quantity * l_extendedpriceæ±‚å’Œ"></a>ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦<code>c_mktsegment, c_nation, s_nation</code>ä¸Šçš„<code>cube</code>, åœ¨ç»„é‡Œé¢å¯¹<code>l_quantity * l_extendedprice</code>æ±‚å’Œ</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> volume_cube (</span><br><span class="line">    volume <span class="built_in">bigint</span>,</span><br><span class="line">    c_mktsegment <span class="built_in">character</span> (<span class="number">10</span>),</span><br><span class="line">    c_nationkey <span class="built_in">integer</span>,</span><br><span class="line">    s_nationkey <span class="built_in">integer</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> volume_cube2 (</span><br><span class="line">    volume <span class="built_in">bigint</span>,</span><br><span class="line">    c_mktsegment <span class="built_in">character</span> (<span class="number">10</span>),</span><br><span class="line">    c_nationkey <span class="built_in">integer</span>,</span><br><span class="line">    s_nationkey <span class="built_in">integer</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> volume_cube2 <span class="keyword">select</span></span><br><span class="line">    <span class="keyword">sum</span>(l_quantity * l_extendedprice),</span><br><span class="line">    c_mktsegment,</span><br><span class="line">    c_nationkey,</span><br><span class="line">    s_nationkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    lineitem,</span><br><span class="line">    orders,</span><br><span class="line">    customer,</span><br><span class="line">    supplier</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_orderkey = o_orderkey <span class="keyword">and</span></span><br><span class="line">    o_custkey = c_custkey <span class="keyword">and</span></span><br><span class="line">    l_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    <span class="keyword">cube</span> (</span><br><span class="line">    c_mktsegment,</span><br><span class="line">    c_nationkey,</span><br><span class="line">    s_nationkey</span><br><span class="line">    );</span><br></pre></td></tr></tbody></table></figure>
<h3 id="æ”¹å†™å¼•å…¥ä¸­çš„ä¸¤ä¸ªä¾‹å­"><a href="#æ”¹å†™å¼•å…¥ä¸­çš„ä¸¤ä¸ªä¾‹å­" class="headerlink" title="æ”¹å†™å¼•å…¥ä¸­çš„ä¸¤ä¸ªä¾‹å­"></a>æ”¹å†™å¼•å…¥ä¸­çš„ä¸¤ä¸ªä¾‹å­</h3><p>å¯ä»¥å¯¹è¿è¡Œæ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨<code>psql</code>å‘½ä»¤è¡Œä¸­è¾“å…¥<code>\timing</code>:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">tpch1=# \timing</span><br><span class="line">Timing is on.</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> volume</span><br><span class="line"><span class="keyword">from</span> volume_cube2, nation</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    c_mktsegment = <span class="string">'AUTOMOBILE'</span> <span class="keyword">and</span></span><br><span class="line">    c_nationkey = n_nationkey <span class="keyword">and</span></span><br><span class="line">    n_name = <span class="string">'UNITED STATES'</span> <span class="keyword">and</span></span><br><span class="line">    s_nationkey <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">   volume    </span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"> 59435954414</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 1.048 ms</span><br></pre></td></tr></tbody></table></figure>
<p>&lt;/br&gt;<br>&lt;/br&gt;</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(volume)</span><br><span class="line"><span class="keyword">from</span> volume_cube2</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    c_nationkey = s_nationkey <span class="keyword">and</span></span><br><span class="line">    c_mktsegment <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">     sum      </span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line"> 309577834070</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 1.505 ms</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<p>ä¸‹é¢æ˜¯å¼•å…¥ä¾‹å­æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå®ƒä»¬å¾ˆæ…¢ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">       sum        </span><br><span class="line"><span class="comment">------------------</span></span><br><span class="line"> 59435954414.0900</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 1301.876 ms (00:01.302)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">        sum        </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> 309577834069.9700</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 4526.136 ms (00:04.526)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="è€ƒè™‘ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦p-partkey-s-partkey-o-orderkey-c-custkeyä¸Šçš„cubeæ˜¯å¦åˆç†"><a href="#è€ƒè™‘ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦p-partkey-s-partkey-o-orderkey-c-custkeyä¸Šçš„cubeæ˜¯å¦åˆç†" class="headerlink" title="è€ƒè™‘ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦p_partkey, s_partkey, o_orderkey, c_custkeyä¸Šçš„cubeæ˜¯å¦åˆç†"></a>è€ƒè™‘ç‰©è´¨åŒ–ä¸€ä¸ªåœ¨ç»´åº¦<code>p_partkey, s_partkey, o_orderkey, c_custkey</code>ä¸Šçš„<code>cube</code>æ˜¯å¦åˆç†</h3><p>å³ä½¿æ˜¯å”¯ä¸€çš„å…ƒç´ (unique elements)çš„ä¸ªæ•°ï¼š200k <em> 800k </em> 1500k * 150k = 3.6e22</p>
<p>è¿™ä¸ªæ•°å­—æ˜¯cubeè‡³å°‘æ‹¥æœ‰çš„æ¡ç›®æ€»æ•°çš„ä¸‹é™</p>
<p>å‡è®¾æ¯ä¸ªå…ƒç´ éƒ½æ˜¯4Byteçš„Intï¼Œé¢„å…ˆè®¡ç®—éœ€è¦çš„ç©ºé—´æ˜¯ï¼š1.44e23 Byte = 192 Zebibyte </p>
<p>è¿™ä¸ªç©ºé—´å ç”¨è¿‡å¤§ï¼Œè¿™ä¸ªè€ƒè™‘æ˜¯éå¸¸ä¸åˆç†çš„</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>TUM-IN2326</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(5)</title>
    <url>/2020/04/06/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-5/</url>
    <content><![CDATA[<p>æˆ‘ä»¬ç»§ç»­ç»ƒä¹ çª—å£å‡½æ•°ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨TPC-Hæ•°æ®é›†æ¥ç»ƒä¹ ã€‚TPC-Hæ˜¯ä¸€ä¸ªå•†ä¸šå†³ç­–æ–¹å‘çš„æ•°æ®é›†ï¼Œå› æ­¤é‡Œé¢æœ‰å¾ˆå¤šé‡‘é¢/é”€å”®é¢/å¹´åº¦é”€å”®é¢/å›½å®¶é”€å”®é¢ç­‰ç­‰OLAPçš„æ•°ç›®å¯ä»¥è¢«è®¡ç®—ã€‚</p>
<a id="more"></a>
<h1 id="TPC-H-æ•°æ®é›†"><a href="#TPC-H-æ•°æ®é›†" class="headerlink" title="TPC-H æ•°æ®é›†"></a>TPC-H æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br><code>TPC-H</code>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p><strong>æœ¬åœ°è½½å…¥æ”¹æ•°æ®é›†</strong>çš„æ–¹æ³•è§æˆ‘çš„åšå®¢ä¸¤ç¯‡æ–‡ç« :</p>
<ul>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥ TPC-H æ•°æ®é›†</a></li>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†</a></li>
</ul>
<h2 id="ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o-totalprice"><a href="#ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o-totalprice" class="headerlink" title="ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o_totalprice"></a>ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o_totalprice</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> o_custkey, o_orderdate,</span><br><span class="line">       <span class="keyword">sum</span>(o_totalprice) <span class="keyword">over</span> <span class="comment">-- window function</span></span><br><span class="line">    (<span class="keyword">partition</span> <span class="keyword">by</span> o_custkey <span class="comment">-- partitioning clause</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> o_orderdate <span class="comment">-- ordering clause</span></span><br><span class="line">    <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">    ) <span class="comment">-- framing clause</span></span><br><span class="line">    <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders;</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¾ä»¶ä¸Šé¢çš„ç‰ˆæœ¬å…¶å®ä¸èƒ½å……åˆ†æ˜¾ç¤ºå‡ºwindow functionçš„ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ç‰ˆæœ¬ï¼ŒåŒæ—¶çœ‹ä¸€ä¸‹å¯¹åº”çš„è¾“å‡ºï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> o_custkey, o_orderdate, o_totalprice,</span><br><span class="line">       <span class="keyword">sum</span>(o_totalprice) <span class="keyword">over</span> <span class="comment">-- window function</span></span><br><span class="line">    (<span class="keyword">partition</span> <span class="keyword">by</span> o_custkey <span class="comment">-- partitioning clause</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> o_orderdate <span class="comment">-- ordering clause</span></span><br><span class="line">    <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">    ) <span class="comment">-- framing clause</span></span><br><span class="line">    <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_custkey, o_orderdate;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> o_custkey | o_orderdate | o_totalprice | o_totalprice_sum </span><br><span class="line"><span class="comment">-----------+-------------+--------------+------------------</span></span><br><span class="line">         1 | 1992-10-21  |    202660.52 |        202660.52</span><br><span class="line">         1 | 1993-08-05  |      4225.26 |        206885.78</span><br><span class="line">         1 | 1997-05-09  |    113954.89 |        320840.67</span><br><span class="line">         1 | 1997-11-21  |     39835.54 |        360676.21</span><br><span class="line">         1 | 1998-05-31  |    159171.69 |        519847.90</span><br><span class="line">         2 | 1992-07-08  |     44777.63 |         44777.63</span><br><span class="line">         2 | 1992-08-28  |     89399.40 |        134177.03</span><br><span class="line">         2 | 1993-03-09  |    169847.63 |        304024.66</span><br><span class="line">         2 | 1993-07-31  |     29305.47 |        333330.13</span><br><span class="line">         2 | 1993-12-31  |    179984.42 |        513314.55</span><br><span class="line">         2 | 1994-04-20  |     41433.48 |        554748.03</span><br><span class="line">         2 | 1996-08-16  |     63873.14 |        618621.17</span><br><span class="line">         2 | 1997-06-09  |     24362.39 |        642983.56</span><br><span class="line">         2 | 1998-05-28  |    140363.70 |        783347.26</span><br><span class="line">         .................................................</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬å¯ä»¥å…³æ³¨<code>o_totalprice_sum</code>è¿™ä¸ªå­—æ®µï¼Œå®ƒå¯¹æ¯ä¸€ä¸ªç‹¬ç«‹çš„<code>o_custkey</code>çš„ä¸åŒ<code>o_orderdate</code>çš„<code>o_totalprice</code>è¿›è¡Œç´¯åŠ ã€‚</p>
<ul>
<li><code>o_custkey</code>: partition</li>
<li><code>o_orderdate</code>: order by è¿›è¡Œæ’åº</li>
<li><code>range between unbounded preceding and current row</code>ï¼š ä»è¿™ä¸ª<code>o_custkey</code>ç¬¬ä¸€ä¸ª<code>o_orderdate</code>åˆ°å½“å‰<code>o_orderdate</code></li>
</ul>
<p><br></p>
<p>é’ˆå¯¹è¿™ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ¥ç”¨<strong>ä¸å¸¦window functionçš„ç‰ˆæœ¬</strong>å»å®ŒæˆåŒæ ·è¿™ä¸ªä»»åŠ¡ï¼Œ<strong>ç»Ÿè®¡æ¯ä¸€ä¸ªcustomerçš„æ€»o_totalprice</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> o1.o_custkey, o1.o_orderdate, o1.o_totalprice, <span class="keyword">sum</span>(o2.o_totalprice) <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders o1, orders o2</span><br><span class="line"><span class="keyword">where</span> o1.o_custkey = o2.o_custkey <span class="keyword">and</span> o1.o_orderdate &gt;= o2.o_orderdate</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o1.o_custkey, o1.o_orderdate, o1.o_totalprice</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o1.o_custkey, o1.o_orderdate;</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œè¿˜éœ€è¦æä¸€ä¸‹ï¼Œä¸Šé¢è¿™ä¸ªä¸å¸¦window functionçš„ç‰ˆæœ¬è¿è¡Œå¾ˆæ…¢ï¼Œè€Œå¸¦window functionä¼šå¿«å¾ˆå¤šã€‚(æˆ‘åœ¨PostgreSQLå’ŒHyPerå‡æ¯”è¾ƒè¿‡ã€‚)</p>
<p><br></p>
<h2 id="ç´¯è®¡æ¯ä¸€ä¸ªo-orderdate-customerçš„o-totalpriceï¼ŒæŒ‰ç…§o-custkeyæ¥é¡ºåºç´¯åŠ "><a href="#ç´¯è®¡æ¯ä¸€ä¸ªo-orderdate-customerçš„o-totalpriceï¼ŒæŒ‰ç…§o-custkeyæ¥é¡ºåºç´¯åŠ " class="headerlink" title="ç´¯è®¡æ¯ä¸€ä¸ªo_orderdate customerçš„o_totalpriceï¼ŒæŒ‰ç…§o_custkeyæ¥é¡ºåºç´¯åŠ "></a>ç´¯è®¡æ¯ä¸€ä¸ªo_orderdate customerçš„o_totalpriceï¼ŒæŒ‰ç…§o_custkeyæ¥é¡ºåºç´¯åŠ </h2><p>ç´¯è®¡æ¯ä¸€ä¸ªo_orderdate(æ¯ä¸€å¤©)customerçš„o_totalpriceï¼ŒæŒ‰ç…§o_custkeyæ¥é¡ºåºç´¯åŠ </p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> o_orderdate, o_custkey, o_totalprice, <span class="keyword">sum</span>(o_totalprice) <span class="keyword">over</span></span><br><span class="line">    (<span class="keyword">partition</span> <span class="keyword">by</span> o_orderdate</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> o_custkey</span><br><span class="line">    <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">    ) <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderdate, o_custkey;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> o_orderdate | o_custkey | o_totalprice | o_totalprice_sum </span><br><span class="line"><span class="comment">-------------+-----------+--------------+------------------</span></span><br><span class="line"> 1992-01-01  |        34 |     86534.05 |         86534.05</span><br><span class="line"> 1992-01-01  |        92 |     24660.06 |        111194.11</span><br><span class="line"> 1992-01-02  |        17 |     40975.96 |         40975.96</span><br><span class="line"> 1992-01-02  |        49 |    210713.88 |        251689.84</span><br><span class="line"> 1992-01-02  |        64 |    127527.05 |        379216.89</span><br><span class="line"> 1992-01-04  |        70 |     84053.93 |         84053.93</span><br><span class="line"> 1992-01-06  |        11 |    118570.79 |        118570.79</span><br><span class="line"> 1992-01-06  |        37 |     91795.13 |        210365.92</span><br><span class="line"> 1992-01-07  |        62 |     58168.07 |         58168.07</span><br><span class="line"> 1992-01-09  |        13 |    145040.38 |        145040.38</span><br><span class="line"> 1992-01-09  |        25 |    145906.24 |        290946.62</span><br><span class="line"> .........................................................</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸å¸¦window functionçš„ç‰ˆæœ¬ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> o1.o_orderdate, o1.o_custkey, o1.o_totalprice, <span class="keyword">sum</span>(o2.o_totalprice) <span class="keyword">as</span> o_totalprice_sum</span><br><span class="line"><span class="keyword">from</span> orders o1, orders o2</span><br><span class="line"><span class="keyword">where</span> o1.o_orderdate = o2.o_orderdate <span class="keyword">and</span> o1.o_custkey &gt;= o2.o_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o1.o_orderdate, o1.o_custkey, o1.o_totalprice</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderdate, o_custkey;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="è®¡ç®—æ¯ä¸€ä¸ªGERMANYçš„customeræ¯ä¸€å¹´çš„running-sum-o-totalprice"><a href="#è®¡ç®—æ¯ä¸€ä¸ªGERMANYçš„customeræ¯ä¸€å¹´çš„running-sum-o-totalprice" class="headerlink" title="è®¡ç®—æ¯ä¸€ä¸ªGERMANYçš„customeræ¯ä¸€å¹´çš„running sum(o_totalprice)"></a>è®¡ç®—æ¯ä¸€ä¸ªGERMANYçš„customeræ¯ä¸€å¹´çš„running sum(o_totalprice)</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> base_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> c_custkey, <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> o_orderdate) <span class="keyword">as</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> yr_revernue</span><br><span class="line">    <span class="keyword">from</span> nation, customer, orders</span><br><span class="line">    <span class="keyword">where</span> n_name = <span class="string">'GERMANY'</span> <span class="keyword">and</span> n_nationkey = c_nationkey <span class="keyword">and</span> c_custkey = o_custkey</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_custkey, <span class="keyword">year</span></span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> c_custkey, <span class="keyword">year</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *,</span><br><span class="line">       <span class="keyword">sum</span>(yr_revernue) <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> c_custkey</span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span></span><br><span class="line">           <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">0</span> <span class="keyword">following</span></span><br><span class="line">           ) <span class="keyword">as</span> running_sum</span><br><span class="line"><span class="keyword">from</span> base_table;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">c_custkey | year | yr_revernue | running_sum </span><br><span class="line"><span class="comment">-----------+------+-------------+-------------</span></span><br><span class="line">        62 | 1992 |   169991.32 |   169991.32</span><br><span class="line">        62 | 1993 |   174385.47 |   344376.79</span><br><span class="line">        62 | 1994 |    89262.19 |   433638.98</span><br><span class="line">        62 | 1995 |   526408.33 |   960047.31</span><br><span class="line">        62 | 1996 |   412013.97 |  1372061.28</span><br><span class="line">        62 | 1997 |   286185.97 |  1658247.25</span><br><span class="line">        62 | 1998 |   397422.69 |  2055669.94</span><br><span class="line">        71 | 1992 |   403017.41 |   403017.41</span><br><span class="line">        71 | 1993 |   348239.45 |   751256.86</span><br><span class="line">        71 | 1994 |   270189.86 |  1021446.72</span><br><span class="line">        71 | 1995 |   239565.38 |  1261012.10</span><br><span class="line">        71 | 1997 |   203579.58 |  1464591.68</span><br><span class="line">        71 | 1998 |   174001.98 |  1638593.66</span><br><span class="line">        .....................................</span><br></pre></td></tr></tbody></table></figure>
<p>&lt;/br&gt;</p>
<h3 id="å¯¹ä¸åŒå›½å®¶çš„orderæ•°é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå‰å‡ å"><a href="#å¯¹ä¸åŒå›½å®¶çš„orderæ•°é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå‰å‡ å" class="headerlink" title="å¯¹ä¸åŒå›½å®¶çš„orderæ•°é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå‰å‡ å"></a>å¯¹ä¸åŒå›½å®¶çš„orderæ•°é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå‰å‡ å</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/28.jpg" alt="28.jpg"></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> *, </span><br><span class="line">        <span class="keyword">case</span> (<span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>)) </span><br><span class="line">              <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">              <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">              <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c</span><br><span class="line">    <span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line">    <span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_custkey) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c,</span><br><span class="line">       <span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">rank</span>,</span><br><span class="line">       <span class="keyword">case</span> (<span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>))  </span><br><span class="line">             <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">else</span> <span class="string">' '</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line"><span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_custkey</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> c_custkey | c  | case </span><br><span class="line"><span class="comment">-----------+----+------</span></span><br><span class="line">      3451 | 41 | gold</span><br><span class="line">    102022 | 41 | gold</span><br><span class="line">    102004 | 41 | gold</span><br><span class="line">    122623 | 40 | </span><br><span class="line">     79300 | 40 | </span><br><span class="line">    117082 | 40 | </span><br><span class="line">     69682 | 39 | </span><br><span class="line">    143500 | 39 | </span><br><span class="line">    129637 | 38 | </span><br><span class="line">    124048 | 38 |</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> *, </span><br><span class="line">       <span class="keyword">case</span> (<span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>)) </span><br><span class="line">             <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c</span><br><span class="line">    <span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line">    <span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_custkey) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(*) <span class="keyword">as</span> c,</span><br><span class="line">       <span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">rank</span>,</span><br><span class="line">       <span class="keyword">case</span> (<span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>))  </span><br><span class="line">             <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">'gold'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">'silver'</span> </span><br><span class="line">             <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">'bronze'</span> <span class="keyword">else</span> <span class="string">' '</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders</span><br><span class="line"><span class="keyword">on</span> o_custkey = c_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_custkey</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> c_custkey | c  |  case  </span><br><span class="line"><span class="comment">-----------+----+--------</span></span><br><span class="line">      3451 | 41 | gold</span><br><span class="line">    102022 | 41 | gold</span><br><span class="line">    102004 | 41 | gold</span><br><span class="line">    122623 | 40 | silver</span><br><span class="line">     79300 | 40 | silver</span><br><span class="line">    117082 | 40 | silver</span><br><span class="line">     69682 | 39 | bronze</span><br><span class="line">    143500 | 39 | bronze</span><br><span class="line">    129637 | 38 | </span><br><span class="line">    124048 | 38 |</span><br></pre></td></tr></tbody></table></figure>
<p>ç»™å‡ºäº†ä¸¤ç§ä¸åŒæ–¹æ³•ï¼Œå–å†³äºæˆ‘ä»¬æ€ä¹ˆå®šä¹‰å¥–ç‰Œ(æ€ä¹ˆå®šä¹‰æ’å)ã€‚</p>
<p><br><br><br>s</p>
<h3 id="æ±‚æ¯ä¸€å¹´çš„revenueçš„ç™¾åˆ†æ¯”æ¯”å‰ä¸€å¹´çš„å˜åŒ–ï¼š"><a href="#æ±‚æ¯ä¸€å¹´çš„revenueçš„ç™¾åˆ†æ¯”æ¯”å‰ä¸€å¹´çš„å˜åŒ–ï¼š" class="headerlink" title="æ±‚æ¯ä¸€å¹´çš„revenueçš„ç™¾åˆ†æ¯”æ¯”å‰ä¸€å¹´çš„å˜åŒ–ï¼š"></a>æ±‚æ¯ä¸€å¹´çš„revenueçš„ç™¾åˆ†æ¯”æ¯”å‰ä¸€å¹´çš„å˜åŒ–ï¼š</h3><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/29.jpg" alt="29.jpg"></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> orders_with_years <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> * , <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> o_orderdate) <span class="keyword">as</span> <span class="keyword">year</span></span><br><span class="line">    <span class="keyword">from</span> orders</span><br><span class="line">    ), tmp_re <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(o_totalprice) <span class="keyword">as</span> revenue</span><br><span class="line">    <span class="keyword">from</span> orders_with_years</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">year</span></span><br><span class="line">    ), tmp_re_comp <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *, lag(revenue, <span class="number">1</span>, <span class="literal">null</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span>) <span class="keyword">as</span> prev</span><br><span class="line">    <span class="keyword">from</span> tmp_re</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *, <span class="keyword">round</span>(<span class="number">100</span> * ((revenue - prev) / prev), <span class="number">2</span>) <span class="keyword">as</span> differ_percentage</span><br><span class="line"><span class="keyword">from</span> tmp_re_comp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> year |    revenue     |      prev      | differ_percentage </span><br><span class="line"><span class="comment">------+----------------+----------------+-------------------</span></span><br><span class="line"> 1992 | 34330674052.43 |                |                  </span><br><span class="line"> 1993 | 34340410079.03 | 34330674052.43 |              0.03</span><br><span class="line"> 1994 | 34416369052.97 | 34340410079.03 |              0.22</span><br><span class="line"> 1995 | 34546133183.60 | 34416369052.97 |              0.38</span><br><span class="line"> 1996 | 34609364760.86 | 34546133183.60 |              0.18</span><br><span class="line"> 1997 | 34373633413.04 | 34609364760.86 |             -0.68</span><br><span class="line"> 1998 | 20212721905.53 | 34373633413.04 |            -41.20</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>å¼•ç”¨: </p>
<p>è¯¾ä»¶: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>TUM-IN2326</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(4)</title>
    <url>/2020/04/05/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-4/</url>
    <content><![CDATA[<p>åœ¨å‰ä¸‰ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åŸºæœ¬ä¸Šè®¤è¯†äº†window functionã€‚è¿™æ¬¡æˆ‘ä»¬æœ‰å…·ä½“çš„æ•°æ®é›†å»è¿›è¡Œå¤§é‡ç»ƒä¹ (ç»å¤§éƒ¨åˆ†æ˜¯æ’å)ã€‚</p>
<a id="more"></a>
<h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p>æ¶æ„ Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p>
<p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p>
<p>ä¸‹è½½:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p>
<p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p>
<p>è¯¾ä»¶ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li>
</ul>
<p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<p><br><br><br></p>
<h1 id="çª—å£å‡½æ•°"><a href="#çª—å£å‡½æ•°" class="headerlink" title="çª—å£å‡½æ•°"></a>çª—å£å‡½æ•°</h1><h2 id="æ•™æˆä¾‹å­"><a href="#æ•™æˆä¾‹å­" class="headerlink" title="æ•™æˆä¾‹å­"></a>æ•™æˆä¾‹å­</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> Professors;</span><br><span class="line"></span><br><span class="line"> persnr |    name     | paygrade | room | salary | taxclass </span><br><span class="line"><span class="comment">--------+-------------+----------+------+--------+----------</span></span><br><span class="line">   2125 | Sokrates    | C4       |  226 |  85000 |        1</span><br><span class="line">   2126 | Russel      | C4       |  232 |  80000 |        3</span><br><span class="line">   2127 | Kopernikus  | C3       |  310 |  65000 |        5</span><br><span class="line">   2128 | Aristoteles | C4       |  250 |  85000 |        1</span><br><span class="line">   2133 | Popper      | C3       |   52 |  68000 |        1</span><br><span class="line">   2134 | Augustinus  | C3       |  309 |  55000 |        5</span><br><span class="line">   2136 | Curie       | C4       |   36 |  95000 |        3</span><br><span class="line">   2137 | Kant        | C4       |    7 |  98000 |        1</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="æ ¹æ®salaryæ’å"><a href="#æ ¹æ®salaryæ’å" class="headerlink" title="æ ¹æ®salaryæ’å:"></a>æ ¹æ®salaryæ’å:</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary,</span><br><span class="line">       <span class="keyword">rank</span>() <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span></span><br><span class="line">       ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">rank</span> <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> persnr |    name     | salary | rank </span><br><span class="line"><span class="comment">--------+-------------+--------+------</span></span><br><span class="line">   2137 | Kant        |  98000 |    1</span><br><span class="line">   2136 | Curie       |  95000 |    2</span><br><span class="line">   2125 | Sokrates    |  85000 |    3</span><br><span class="line">   2128 | Aristoteles |  85000 |    3</span><br><span class="line">   2126 | Russel      |  80000 |    5</span><br><span class="line">   2133 | Popper      |  68000 |    6</span><br><span class="line">   2127 | Kopernikus  |  65000 |    7</span><br><span class="line">   2134 | Augustinus  |  55000 |    8</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œæ ¹æ®salaryæ’å"><a href="#åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œæ ¹æ®salaryæ’å" class="headerlink" title="åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œæ ¹æ®salaryæ’å:"></a>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œæ ¹æ®salaryæ’å:</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary, paygrade,</span><br><span class="line">       <span class="keyword">rank</span>() <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> paygrade</span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span></span><br><span class="line">       ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> paygrade <span class="keyword">asc</span>, <span class="keyword">rank</span> <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line"> persnr |    name     | salary | paygrade | rank </span><br><span class="line">--------+-------------+--------+----------+------</span><br><span class="line">   2133 | Popper      |  68000 | C3       |    1</span><br><span class="line">   2127 | Kopernikus  |  65000 | C3       |    2</span><br><span class="line">   2134 | Augustinus  |  55000 | C3       |    3</span><br><span class="line">   2137 | Kant        |  98000 | C4       |    1</span><br><span class="line">   2136 | Curie       |  95000 | C4       |    2</span><br><span class="line">   2128 | Aristoteles |  85000 | C4       |    3</span><br><span class="line">   2125 | Sokrates    |  85000 | C4       |    3</span><br><span class="line">   2126 | Russel      |  80000 | C4       |    5</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œè®¡ç®—salary-running-sum"><a href="#åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œè®¡ç®—salary-running-sum" class="headerlink" title="åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—salary running sum:"></a>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—salary running sum:</h3><p>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—æ¯ä¸€ä¸ªprofessorçš„salary running sum(å³salaryå°äºè¯¥professorçš„å…¶ä»–professorçš„salaryæ€»å’Œ)</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">sum</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">        )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…åŠ ä¸Šä¸€è¡Œ<code>range</code>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">sum</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">           <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="keyword">UNBOUNDED</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span> <span class="comment">-- è¿™è¡Œæ˜¯é»˜è®¤å€¼</span></span><br><span class="line">        )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> persnr |    name     | paygrade | salary |  sum   </span><br><span class="line"><span class="comment">--------+-------------+----------+--------+--------</span></span><br><span class="line">   2134 | Augustinus  | C3       |  55000 |  55000</span><br><span class="line">   2127 | Kopernikus  | C3       |  65000 | 120000</span><br><span class="line">   2133 | Popper      | C3       |  68000 | 188000</span><br><span class="line">   2126 | Russel      | C4       |  80000 |  80000</span><br><span class="line">   2125 | Sokrates    | C4       |  85000 | 250000</span><br><span class="line">   2128 | Aristoteles | C4       |  85000 | 250000</span><br><span class="line">   2136 | Curie       | C4       |  95000 | 345000</span><br><span class="line">   2137 | Kant        | C4       |  98000 | 443000</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œè®¡ç®—salary-running-average"><a href="#åœ¨åŒä¸€ä¸ªpay-gradeç»„ä¸­ï¼Œè®¡ç®—salary-running-average" class="headerlink" title="åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—salary running average:"></a>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—salary running average:</h3><ul>
<li>åœ¨åŒä¸€ä¸ªpay gradeç»„ä¸­ï¼Œè®¡ç®—æ¯ä¸€ä¸ªprofessorçš„salary running average(å³è€ƒè™‘ä¸¤ä¸ªä¸Šæ–¹çš„professorï¼Œå†è€ƒè™‘ä¸¤ä¸ªä¸‹æ–¹çš„professor)</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">avg</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">           <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="number">2</span> <span class="keyword">FOLLOWING</span></span><br><span class="line">           )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> persnr |    name     | paygrade | salary |        avg         </span><br><span class="line"><span class="comment">--------+-------------+----------+--------+--------------------</span></span><br><span class="line">   2134 | Augustinus  | C3       |  55000 | 62666.666666666667</span><br><span class="line">   2127 | Kopernikus  | C3       |  65000 | 62666.666666666667</span><br><span class="line">   2133 | Popper      | C3       |  68000 | 62666.666666666667</span><br><span class="line">   2126 | Russel      | C4       |  80000 | 83333.333333333333</span><br><span class="line">   2125 | Sokrates    | C4       |  85000 | 86250.000000000000</span><br><span class="line">   2128 | Aristoteles | C4       |  85000 | 88600.000000000000</span><br><span class="line">   2136 | Curie       | C4       |  95000 | 90750.000000000000</span><br><span class="line">   2137 | Kant        | C4       |  98000 | 92666.666666666667</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<ul>
<li>åœ¨pay gradeç»„ä¸­ï¼Œè®¡ç®—æ¯ä¸€ä¸ªprofessorçš„salary running average(å³è€ƒè™‘æ¯”è¯¥professorçš„salaryä½5000,é«˜5000åŒºé—´ä¸­professorçš„salaryçš„å¹³å‡å€¼)ï¼š</li>
</ul>
<p>PostgreSQLæ— æ³•æ‰§è¡Œè¿™ä¸€æ¡ï¼Œéœ€ä½¿ç”¨HyPerç½‘é¡µæ¥å£ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, paygrade, salary,</span><br><span class="line">       <span class="keyword">avg</span>(salary) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">PARTITION</span> <span class="keyword">BY</span> paygrade</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">           <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="number">5000</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="number">5000</span> <span class="keyword">FOLLOWING</span></span><br><span class="line">           )</span><br><span class="line"><span class="keyword">FROM</span> Professors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> paygrade <span class="keyword">ASC</span>, salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> persnr |    name     | paygrade | salary |        avg         </span><br><span class="line"><span class="comment">--------+-------------+----------+--------+--------------------</span></span><br><span class="line">   2134 | Augustinus  | C3       |  55000 | 55000.0000</span><br><span class="line">   2127 | Kopernikus  | C3       |  65000 | 66500.0000</span><br><span class="line">   2133 | Popper      | C3       |  68000 | 66500.0000</span><br><span class="line">   2126 | Russel      | C4       |  80000 | 83333.3333</span><br><span class="line">   2125 | Sokrates    | C4       |  85000 | 83333.3333</span><br><span class="line">   2128 | Aristoteles | C4       |  85000 | 83333.3333</span><br><span class="line">   2136 | Curie       | C4       |  95000 | 96500.0000</span><br><span class="line">   2137 | Kant        | C4       |  98000 | 96500.0000</span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="æ ¹æ®salaryæ’åï¼Œç»™å‡ºå‰ä¸€åå’Œåä¸€åï¼š"><a href="#æ ¹æ®salaryæ’åï¼Œç»™å‡ºå‰ä¸€åå’Œåä¸€åï¼š" class="headerlink" title="æ ¹æ®salaryæ’åï¼Œç»™å‡ºå‰ä¸€åå’Œåä¸€åï¼š"></a>æ ¹æ®salaryæ’åï¼Œç»™å‡ºå‰ä¸€åå’Œåä¸€åï¼š</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary,</span><br><span class="line">       lag(<span class="keyword">name</span>) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">           ),</span><br><span class="line">       <span class="keyword">lead</span>(<span class="keyword">name</span>) <span class="keyword">OVER</span> (</span><br><span class="line">           <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">           )</span><br><span class="line"><span class="keyword">FROM</span> Professors;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> persnr |    name     | salary |     lag     |    lead     </span><br><span class="line"><span class="comment">--------+-------------+--------+-------------+-------------</span></span><br><span class="line">   2137 | Kant        |  98000 |             | Curie</span><br><span class="line">   2136 | Curie       |  95000 | Kant        | Sokrates</span><br><span class="line">   2125 | Sokrates    |  85000 | Curie       | Aristoteles</span><br><span class="line">   2128 | Aristoteles |  85000 | Sokrates    | Russel</span><br><span class="line">   2126 | Russel      |  80000 | Aristoteles | Popper</span><br><span class="line">   2133 | Popper      |  68000 | Russel      | Kopernikus</span><br><span class="line">   2127 | Kopernikus  |  65000 | Popper      | Augustinus</span><br><span class="line">   2134 | Augustinus  |  55000 | Kopernikus  | </span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è®¡ç®—å‡ºsalaryçš„å‰ä¸‰åï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary, <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> *,</span><br><span class="line">           <span class="keyword">rank</span>() <span class="keyword">OVER</span> (</span><br><span class="line">               <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">desc</span></span><br><span class="line">               ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line">    <span class="keyword">FROM</span> Professors</span><br><span class="line">) <span class="keyword">as</span> temp</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">rank</span> &lt; <span class="number">4</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">), temp <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> *,</span><br><span class="line">           <span class="keyword">rank</span>() <span class="keyword">OVER</span> (</span><br><span class="line">               <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">desc</span></span><br><span class="line">               ) <span class="keyword">as</span> <span class="keyword">rank</span></span><br><span class="line">    <span class="keyword">FROM</span> Professors</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary, <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> temp</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">rank</span> &lt; <span class="number">4</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> persnr |    name     | salary | rank </span><br><span class="line"><span class="comment">--------+-------------+--------+------</span></span><br><span class="line">   2137 | Kant        |  98000 |    1</span><br><span class="line">   2136 | Curie       |  95000 |    2</span><br><span class="line">   2125 | Sokrates    |  85000 |    3</span><br><span class="line">   2128 | Aristoteles |  85000 |    3</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸ä½¿ç”¨çª—å£å‡½æ•°çš„ç‰ˆæœ¬ï¼š<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="number">2125</span>, <span class="string">'Sokrates'</span>, <span class="string">'C4'</span>, <span class="number">226</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2126</span>, <span class="string">'Russel'</span>, <span class="string">'C4'</span>, <span class="number">232</span>, <span class="number">80000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2127</span>, <span class="string">'Kopernikus'</span>, <span class="string">'C3'</span>, <span class="number">310</span>, <span class="number">65000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2128</span>, <span class="string">'Aristoteles'</span>, <span class="string">'C4'</span>, <span class="number">250</span>, <span class="number">85000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2133</span>, <span class="string">'Popper'</span>, <span class="string">'C3'</span>, <span class="number">52</span>, <span class="number">68000</span>, <span class="number">1</span>),</span><br><span class="line">           (<span class="number">2134</span>, <span class="string">'Augustinus'</span>, <span class="string">'C3'</span>, <span class="number">309</span>, <span class="number">55000</span>, <span class="number">5</span>),</span><br><span class="line">           (<span class="number">2136</span>, <span class="string">'Curie'</span>, <span class="string">'C4'</span>, <span class="number">36</span>, <span class="number">95000</span>, <span class="number">3</span>),</span><br><span class="line">           (<span class="number">2137</span>, <span class="string">'Kant'</span>, <span class="string">'C4'</span>, <span class="number">7</span>, <span class="number">98000</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> persnr, <span class="keyword">name</span>, salary</span><br><span class="line"><span class="keyword">FROM</span> Professors p</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">3</span> &gt; (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">FROM</span> Professors c</span><br><span class="line">    <span class="keyword">WHERE</span> p.salary &lt; c.salary</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><p></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> persnr |    name     | salary </span><br><span class="line"><span class="comment">--------+-------------+--------</span></span><br><span class="line">   2125 | Sokrates    |  85000</span><br><span class="line">   2128 | Aristoteles |  85000</span><br><span class="line">   2136 | Curie       |  95000</span><br><span class="line">   2137 | Kant        |  98000</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>è¿™é‡Œè¦æä¸€ä¸‹ï¼Œä¸‹é¢è¿™ä¸ªç‰ˆæœ¬ä¸å¯¹ï¼Œå®ƒæ— æ³•ç…§é¡¾åˆ°å¹¶åˆ—çš„åæ¬¡:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Professors (persnr, <span class="keyword">name</span>, paygrade, room, salary, taxclass) <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">values</span> (<span class="number">2125</span>,<span class="string">'Sokrates'</span>,<span class="string">'C4'</span>,<span class="number">226</span>,<span class="number">85000</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2126</span>,<span class="string">'Russel'</span>,<span class="string">'C4'</span>,<span class="number">232</span>,<span class="number">80000</span>,<span class="number">3</span>),</span><br><span class="line">(<span class="number">2127</span>,<span class="string">'Kopernikus'</span>,<span class="string">'C3'</span>,<span class="number">310</span>,<span class="number">65000</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">2128</span>,<span class="string">'Aristoteles'</span>,<span class="string">'C4'</span>,<span class="number">250</span>,<span class="number">85000</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2133</span>,<span class="string">'Popper'</span>,<span class="string">'C3'</span>,<span class="number">52</span>,<span class="number">68000</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2134</span>,<span class="string">'Augustinus'</span>,<span class="string">'C3'</span>,<span class="number">309</span>,<span class="number">55000</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">2136</span>,<span class="string">'Curie'</span>,<span class="string">'C4'</span>,<span class="number">36</span>,<span class="number">95000</span>,<span class="number">3</span>),</span><br><span class="line">(<span class="number">2137</span>,<span class="string">'Kant'</span>,<span class="string">'C4'</span>,<span class="number">7</span>,<span class="number">98000</span>,<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> persnr, <span class="keyword">name</span>, salary</span><br><span class="line"><span class="keyword">from</span> Professors</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> persnr |    name     | salary </span><br><span class="line"><span class="comment">--------+-------------+--------</span></span><br><span class="line">   2137 | Kant        |  98000</span><br><span class="line">   2136 | Curie       |  95000</span><br><span class="line">   2128 | Aristoteles |  85000</span><br><span class="line">(3 rows)</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(3)</title>
    <url>/2020/04/04/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-3/</url>
    <content><![CDATA[<p>åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åŸºæœ¬ä¸Šè®¤è¯†äº†window functionã€‚è¿™æ¬¡æˆ‘ä»¬æœ‰å…·ä½“çš„æ•°æ®é›†å»è¿›è¡Œå¤§é‡ç»ƒä¹ (ç»å¤§éƒ¨åˆ†æ˜¯æ’å)ã€‚</p>
<a id="more"></a>
<h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p>æ¶æ„ Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p>
<p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p>
<p>ä¸‹è½½:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p>
<p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p>
<p>è¯¾ä»¶ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li>
</ul>
<p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<p><br><br><br></p>
<h1 id="çª—å£å‡½æ•°"><a href="#çª—å£å‡½æ•°" class="headerlink" title="çª—å£å‡½æ•°"></a>çª—å£å‡½æ•°</h1><h2 id="æˆç»©ä¾‹å­"><a href="#æˆç»©ä¾‹å­" class="headerlink" title="æˆç»©ä¾‹å­"></a>æˆç»©ä¾‹å­</h2><p>æˆ‘ä»¬é‡‡ç”¨ä¸€ä¸ªæ›´å¤§çš„è¡¨æ ¼ï¼ŒåŸºäºåŸæ•°æ®é›†è¡¨æ ¼<code>pruefen</code>ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> examination;</span><br><span class="line"></span><br><span class="line"> matrnr | coursenr | persnr | grade </span><br><span class="line"><span class="comment">--------+----------+--------+-------</span></span><br><span class="line">  28106 |     5001 |   2126 |   1.0</span><br><span class="line">  27550 |     4630 |   2137 |   2.0</span><br><span class="line">  29555 |        0 |      0 |   1.3</span><br><span class="line">  29120 |        0 |      0 |   3.0</span><br><span class="line">  25403 |     5041 |   2125 |   2.0</span><br><span class="line">  29555 |        0 |      0 |   2.0</span><br><span class="line">  29555 |        0 |      0 |   1.0</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»©-ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å"><a href="#åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»©-ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å" class="headerlink" title="åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»© ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å:"></a>åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»© ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å:</h3><p>åŸºäºå­¦ç”Ÿçš„å¹³å‡æˆç»© ç¡®å®šåŒå¹´çº§ä¸­çš„æ’å(å’ŒåŒä¸€ä¸ªå­¦æœŸçš„åŒå­¦æ¯”è¾ƒ)</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- è®¡ç®—å¹³å‡æˆç»©</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * , </span><br><span class="line">       <span class="keyword">rank</span> () <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> Semester <span class="comment">-- å’ŒåŒä¸€å­¦æœŸçš„åŒå­¦æ¯”è¾ƒ</span></span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> Grade <span class="keyword">asc</span>    <span class="comment">-- æ•°å­—å°æ˜¯é«˜åˆ†ã€€æ’åä¹Ÿé å‰</span></span><br><span class="line">           ) <span class="keyword">as</span> Rang</span><br><span class="line"><span class="keyword">from</span> grades</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>ä¸ä½¿ç”¨çª—å£å‡½æ•°çš„ç‰ˆæœ¬ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- è®¡ç®—å¹³å‡æˆç»©</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * ,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">count</span>(*) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> Grades x</span><br><span class="line">        <span class="keyword">where</span> x.Semester = n.Semester <span class="keyword">and</span> x.Grade &lt; n.Grade) <span class="keyword">as</span> Rang</span><br><span class="line"><span class="keyword">from</span> grades n</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> matrnr | semester |         grade          | rang </span><br><span class="line"><span class="comment">--------+----------+------------------------+------</span></span><br><span class="line">  29555 |        2 |     1.4333333333333333 |    1</span><br><span class="line">  29120 |        2 |     3.0000000000000000 |    2</span><br><span class="line">  28106 |        3 | 1.00000000000000000000 |    1</span><br><span class="line">  27550 |        6 |     2.0000000000000000 |    1</span><br><span class="line">  25403 |       12 |     2.0000000000000000 |    1</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h3 id="åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¦»å¹³å‡æˆç»©çš„å·®è·"><a href="#åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¦»å¹³å‡æˆç»©çš„å·®è·" class="headerlink" title="åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¦»å¹³å‡æˆç»©çš„å·®è·:"></a>åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¦»å¹³å‡æˆç»©çš„å·®è·:</h3><p>åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ æ¯ä¸ªåŒå­¦ç¦»å¹³å‡æˆç»©çš„å·®è·ï¼Œå’ŒåŒå¹´çº§å¹³å‡æˆç»©çš„å·®è·(å’ŒåŒä¸€ä¸ªå­¦æœŸçš„åŒå­¦æ¯”è¾ƒ)</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- è®¡ç®—å¹³å‡æˆç»©</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * ,</span><br><span class="line">       <span class="keyword">rank</span> () <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> Semester <span class="comment">-- å’ŒåŒä¸€å­¦æœŸçš„åŒå­¦æ¯”è¾ƒ</span></span><br><span class="line">           <span class="keyword">order</span> <span class="keyword">by</span> Grade <span class="keyword">asc</span>    <span class="comment">-- æ•°å­—å°æ˜¯é«˜åˆ†ã€€æ’åä¹Ÿé å‰</span></span><br><span class="line">           ) <span class="keyword">as</span> Rang,</span><br><span class="line">       <span class="keyword">avg</span> (Grade) <span class="keyword">over</span> (</span><br><span class="line">           <span class="keyword">partition</span> <span class="keyword">by</span> Semester  <span class="comment">-- å’ŒåŒä¸€å­¦æœŸçš„åŒå­¦æ¯”è¾ƒ</span></span><br><span class="line">       ) <span class="keyword">as</span> GPA ,                 <span class="comment">-- åŒå¹´çº§çš„å¹³å‡æˆç»©</span></span><br><span class="line">       <span class="keyword">avg</span> (Grade) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> Semester) - Grade <span class="keyword">as</span> <span class="keyword">difference</span></span><br><span class="line"><span class="keyword">from</span> grades</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>ä¸ä½¿ç”¨çª—å£å‡½æ•°çš„ç‰ˆæœ¬ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> examination (MatrNr, CourseNr, PersNr, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="number">29120</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2.0</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.3</span>),</span><br><span class="line">           (<span class="number">29555</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">), grades (MatrNr, Semester, Grade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, semester, <span class="keyword">avg</span>(Grade) <span class="comment">-- è®¡ç®—å¹³å‡æˆç»©</span></span><br><span class="line">    <span class="keyword">from</span> studenten s, examination p</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = p.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * ,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">count</span>(*) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> Grades x</span><br><span class="line">        <span class="keyword">where</span> x.Semester = n.Semester <span class="keyword">and</span> x.Grade &lt; n.Grade) <span class="keyword">as</span> Rang,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">avg</span>(x.Grade)</span><br><span class="line">       <span class="keyword">from</span> Grades x</span><br><span class="line">       <span class="keyword">where</span> x.Semester = n.Semester) <span class="keyword">as</span> GPA,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">avg</span>(x.Grade)</span><br><span class="line">       <span class="keyword">from</span> Grades x</span><br><span class="line">       <span class="keyword">where</span> x.Semester = n.Semester) - Grade <span class="keyword">as</span> <span class="keyword">difference</span></span><br><span class="line"><span class="keyword">from</span> grades n</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> semester, rang;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> matrnr | semester |         grade          | rang |          gpa           |       difference       </span><br><span class="line"><span class="comment">--------+----------+------------------------+------+------------------------+------------------------</span></span><br><span class="line">  29555 |        2 |     1.4333333333333333 |    1 |     2.2166666666666667 |     0.7833333333333334</span><br><span class="line">  29120 |        2 |     3.0000000000000000 |    2 |     2.2166666666666667 |    -0.7833333333333333</span><br><span class="line">  28106 |        3 | 1.00000000000000000000 |    1 | 1.00000000000000000000 | 0.00000000000000000000</span><br><span class="line">  27550 |        6 |     2.0000000000000000 |    1 |     2.0000000000000000 |     0.0000000000000000</span><br><span class="line">  25403 |       12 |     2.0000000000000000 |    1 |     2.0000000000000000 |     0.0000000000000000</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(2)</title>
    <url>/2020/04/02/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-2/</url>
    <content><![CDATA[<p>æˆ‘ä»¬åœ¨<a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/">[CMU-15445]Lec02_part2 Advanced SQL - é«˜çº§ SQL</a>ä¸­éå¸¸åˆæ­¥äº†äº†è§£äº†window functionçª—å£å‡½æ•°ã€‚å®ƒæ˜¯åœ¨OLAPä¸­éå¸¸é«˜æ•ˆçš„ä¸€ç§å‡½æ•°ï¼Œåœ¨å·¥ä¸šä¸šåŠ¡ä¸­éå¸¸å¸¸è§ã€‚å¦å¤–æˆ‘åœ¨Leetcodeä¸­çš„SQLéƒ¨åˆ†ä¹Ÿå‘ç°å¾ˆå¤šé¢˜ç›®å¯ä»¥é€‚ç”¨window functionã€‚CMUè¯¾å®é™…ä¸Šæœ‰ä¸€äº›ç®€ç•¥ã€‚æˆ‘ä¼šä½¿ç”¨TUMçš„<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en">Foundations in Data Engineering<i class="fa fa-external-link"></i></span>è¯¾ä»¶æ¥é‡ç‚¹å­¦ä¹ ç»ƒä¹ è¿™å—å†…å®¹ã€‚</p>
<p>æˆ‘ä»¬è¿™æ¬¡ç»ƒä¹  ä½¿ç”¨frameçš„window function</p>
<a id="more"></a>
<h1 id="ä½¿ç”¨frameçš„window-functions"><a href="#ä½¿ç”¨frameçš„window-functions" class="headerlink" title="ä½¿ç”¨frameçš„window functions"></a>ä½¿ç”¨frameçš„window functions</h1><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/30.jpg" alt="30.jpg"></p>
<h2 id="rows"><a href="#rows" class="headerlink" title="rows"></a><code>rows</code></h2><h3 id="ä¸Šä¸€è¡Œï½ä¸‹ä¸€è¡Œ"><a href="#ä¸Šä¸€è¡Œï½ä¸‹ä¸€è¡Œ" class="headerlink" title="ä¸Šä¸€è¡Œï½ä¸‹ä¸€è¡Œ"></a>ä¸Šä¸€è¡Œï½ä¸‹ä¸€è¡Œ</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |  20</span><br><span class="line"> 10 |  34</span><br><span class="line"> 14 |  41</span><br><span class="line"> 17 |  48</span><br><span class="line"> 17 |  52</span><br><span class="line"> 18 |  55</span><br><span class="line"> 20 |  38</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ä¸Šä¸€è¡Œï½æœ€åä¸€è¡Œ"><a href="#ä¸Šä¸€è¡Œï½æœ€åä¸€è¡Œ" class="headerlink" title="ä¸Šä¸€è¡Œï½æœ€åä¸€è¡Œ"></a>ä¸Šä¸€è¡Œï½æœ€åä¸€è¡Œ</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">unbounded</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 106</span><br><span class="line"> 10 | 106</span><br><span class="line"> 14 |  96</span><br><span class="line"> 17 |  86</span><br><span class="line"> 17 |  72</span><br><span class="line"> 18 |  55</span><br><span class="line"> 20 |  38</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="range"><a href="#range" class="headerlink" title="range"></a><code>range</code></h2><p>PostgreSQLä¸èƒ½å¤„ç†ä¸‹é¢çš„SQLï¼Œä½†æ˜¯HyPerå¯ä»¥ã€‚</p>
<h3 id="forall-x-x-x-1"><a href="#forall-x-x-x-1" class="headerlink" title="$\forall x: [x, x+1]$"></a>$\forall x: [x, x+1]$</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 20</span><br><span class="line"> 10 | 20</span><br><span class="line"> 14 | 14</span><br><span class="line"> 17 | 52</span><br><span class="line"> 17 | 52</span><br><span class="line"> 18 | 18</span><br><span class="line"> 20 | 20</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="forall-x-x-x-2"><a href="#forall-x-x-x-2" class="headerlink" title="$\forall x: [x, x+2]$"></a>$\forall x: [x, x+2]$</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">2</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 20</span><br><span class="line"> 10 | 20</span><br><span class="line"> 14 | 14</span><br><span class="line"> 17 | 52</span><br><span class="line"> 17 | 52</span><br><span class="line"> 18 | 38</span><br><span class="line"> 20 | 20</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<p>ç›¸æ¯”è¾ƒä¸Šé¢ä¸¤ä¸ªä¾‹å­ï¼Œ ç»“æœä¸­ä»<code>18 | 18</code>å˜æˆ<code>18 | 38</code>ï¼Œå› ä¸º<code>18</code>è¿™ä¸ªtupelå¯ä»¥æ¶‰åŠçš„å€¼åŸŸèŒƒå›´ä»$[18, 19]$å˜æˆ$[18, 20]$</p>
<h3 id="forall-x-mathrm-unbounded-x"><a href="#forall-x-mathrm-unbounded-x" class="headerlink" title="$\forall x: [\mathrm{unbounded}, x]$"></a>$\forall x: [\mathrm{unbounded}, x]$</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x <span class="keyword">range</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">0</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |  20</span><br><span class="line"> 10 |  20</span><br><span class="line"> 14 |  34</span><br><span class="line"> 17 |  68</span><br><span class="line"> 17 |  68</span><br><span class="line"> 18 |  86</span><br><span class="line"> 20 | 106</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="forall-x-y-1-y-1"><a href="#forall-x-y-1-y-1" class="headerlink" title="$\forall x: [y-1, y+1]$"></a>$\forall x: [y-1, y+1]$</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                       (<span class="number">10</span>, <span class="number">1</span>),</span><br><span class="line">                       (<span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">                       (<span class="number">14</span>, <span class="number">2</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">3</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">4</span>),</span><br><span class="line">                       (<span class="number">18</span>, <span class="number">15</span>),</span><br><span class="line">                       (<span class="number">20</span>, <span class="number">6</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> y <span class="keyword">range</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> y;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 | 10</span><br><span class="line"> 14 | 24</span><br><span class="line"> 17 | 41</span><br><span class="line"> 17 | 58</span><br><span class="line"> 20 | 78</span><br><span class="line"> 10 | 88</span><br><span class="line"> 18 | 106</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x, y) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                       (<span class="number">10</span>, <span class="number">1</span>),</span><br><span class="line">                       (<span class="number">10</span>, <span class="number">10</span>),</span><br><span class="line">                       (<span class="number">14</span>, <span class="number">2</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">3</span>),</span><br><span class="line">                       (<span class="number">17</span>, <span class="number">4</span>),</span><br><span class="line">                       (<span class="number">18</span>, <span class="number">15</span>),</span><br><span class="line">                       (<span class="number">20</span>, <span class="number">6</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">sum</span>(x) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> y)</span><br><span class="line"><span class="keyword">from</span> testdata</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> y;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | sum </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |  10</span><br><span class="line"> 14 |  24</span><br><span class="line"> 17 |  41</span><br><span class="line"> 17 |  58</span><br><span class="line"> 20 |  78</span><br><span class="line"> 10 |  88</span><br><span class="line"> 18 | 106</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>å¼•ç”¨: </p>
<p>è¯¾ä»¶: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>TUM-IN2326</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-çª—å£å‡½æ•°(1)</title>
    <url>/2020/04/01/SQL-%E9%AB%98%E7%BA%A7SQL-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0-1/</url>
    <content><![CDATA[<p>æˆ‘ä»¬åœ¨<a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/">[CMU-15445]Lec02_part2 Advanced SQL - é«˜çº§ SQL</a>ä¸­éå¸¸åˆæ­¥äº†äº†è§£äº†window functionçª—å£å‡½æ•°ã€‚å®ƒæ˜¯åœ¨OLAPä¸­éå¸¸é«˜æ•ˆçš„ä¸€ç§å‡½æ•°ï¼Œåœ¨å·¥ä¸šä¸šåŠ¡ä¸­éå¸¸å¸¸è§ã€‚å¦å¤–æˆ‘åœ¨Leetcodeä¸­çš„SQLéƒ¨åˆ†ä¹Ÿå‘ç°å¾ˆå¤šé¢˜ç›®å¯ä»¥é€‚ç”¨window functionã€‚CMUè¯¾å®é™…ä¸Šæœ‰ä¸€äº›ç®€ç•¥ã€‚æˆ‘ä¼šä½¿ç”¨TUMçš„<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvP2xhbmc9ZW4=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/?lang=en">Foundations in Data Engineering<i class="fa fa-external-link"></i></span>è¯¾ä»¶æ¥é‡ç‚¹å­¦ä¹ ç»ƒä¹ è¿™å—å†…å®¹ã€‚</p>
<p>æˆ‘ä»¬è¿™æ¬¡ç»ƒä¹  ä¸ä½¿ç”¨frameçš„window function</p>
<a id="more"></a>
<h1 id="ä¸ä½¿ç”¨frameçš„window-functions"><a href="#ä¸ä½¿ç”¨frameçš„window-functions" class="headerlink" title="ä¸ä½¿ç”¨frameçš„window functions"></a>ä¸ä½¿ç”¨frameçš„window functions</h1><p><img data-src="https://cakebytheoceanluo.github.io/images/FDE/chap3/27.jpg" alt="27.jpg"></p>
<h2 id="ranking-æ’åº"><a href="#ranking-æ’åº" class="headerlink" title="ranking æ’åº"></a>ranking æ’åº</h2><h3 id="rank"><a href="#rank" class="headerlink" title="rank()"></a>rank()</h3><p>å¹¶åˆ—ä¼šå ç”¨åé¢çš„æ’åæ•°å­—ã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | rank </span><br><span class="line"><span class="comment">----+------</span></span><br><span class="line"> 10 |    1</span><br><span class="line"> 10 |    1</span><br><span class="line"> 14 |    3</span><br><span class="line"> 17 |    4</span><br><span class="line"> 17 |    4</span><br><span class="line"> 18 |    6</span><br><span class="line"> 20 |    7</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="dense-rank"><a href="#dense-rank" class="headerlink" title="dense_rank()"></a>dense_rank()</h3><p>å¹¶åˆ—ä¸ä¼šå ç”¨åé¢çš„æ’åæ•°å­—ã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | dense_rank </span><br><span class="line"><span class="comment">----+------------</span></span><br><span class="line"> 10 |          1</span><br><span class="line"> 10 |          1</span><br><span class="line"> 14 |          2</span><br><span class="line"> 17 |          3</span><br><span class="line"> 17 |          3</span><br><span class="line"> 18 |          4</span><br><span class="line"> 20 |          5</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="row-number"><a href="#row-number" class="headerlink" title="row_number()"></a>row_number()</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, row_number() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | row_number </span><br><span class="line"><span class="comment">----+------------</span></span><br><span class="line"> 10 |          1</span><br><span class="line"> 10 |          2</span><br><span class="line"> 14 |          3</span><br><span class="line"> 17 |          4</span><br><span class="line"> 17 |          5</span><br><span class="line"> 18 |          6</span><br><span class="line"> 20 |          7</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ntile-INT"><a href="#ntile-INT" class="headerlink" title="ntile(INT)"></a>ntile(INT)</h3><p>æŠŠè¡¨æ ¼å‡åˆ†ä¸º<code>INT</code>ä»½</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, ntile(<span class="number">2</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | ntile </span><br><span class="line"><span class="comment">----+-------</span></span><br><span class="line"> 10 |     1</span><br><span class="line"> 10 |     1</span><br><span class="line"> 14 |     1</span><br><span class="line"> 17 |     1</span><br><span class="line"> 17 |     2</span><br><span class="line"> 18 |     2</span><br><span class="line"> 20 |     2</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, ntile(<span class="number">3</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | ntile </span><br><span class="line"><span class="comment">----+-------</span></span><br><span class="line"> 10 |     1</span><br><span class="line"> 10 |     1</span><br><span class="line"> 14 |     1</span><br><span class="line"> 17 |     2</span><br><span class="line"> 17 |     2</span><br><span class="line"> 18 |     3</span><br><span class="line"> 20 |     3</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="distribution-åˆ†å¸ƒ"><a href="#distribution-åˆ†å¸ƒ" class="headerlink" title="distribution åˆ†å¸ƒ"></a>distribution åˆ†å¸ƒ</h2><h3 id="percent-rank"><a href="#percent-rank" class="headerlink" title="percent_rank()"></a>percent_rank()</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">percent_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  |   percent_rank    </span><br><span class="line"><span class="comment">----+-------------------</span></span><br><span class="line"> 10 |                 0</span><br><span class="line"> 10 |                 0</span><br><span class="line"> 14 | 0.333333333333333</span><br><span class="line"> 17 |               0.5</span><br><span class="line"> 17 |               0.5</span><br><span class="line"> 18 | 0.833333333333333</span><br><span class="line"> 20 |                 1</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="cume-dist"><a href="#cume-dist" class="headerlink" title="cume_dist()"></a>cume_dist()</h3><p>cumulative distribution function(cdf): æ¦‚ç‡ç´¯åŠ å‡½æ•°</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">cume_dist</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  |     cume_dist     </span><br><span class="line"><span class="comment">----+-------------------</span></span><br><span class="line"> 10 | 0.285714285714286</span><br><span class="line"> 10 | 0.285714285714286</span><br><span class="line"> 14 | 0.428571428571429</span><br><span class="line"> 17 | 0.714285714285714</span><br><span class="line"> 17 | 0.714285714285714</span><br><span class="line"> 18 | 0.857142857142857</span><br><span class="line"> 20 |                 1</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="navigation-in-partition-åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­è¿›è¡Œå®šä½"><a href="#navigation-in-partition-åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­è¿›è¡Œå®šä½" class="headerlink" title="navigation in partition åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­è¿›è¡Œå®šä½"></a>navigation in partition åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­è¿›è¡Œå®šä½</h2><h3 id="lag-expr-offset-default"><a href="#lag-expr-offset-default" class="headerlink" title="lag(expr, offset, default)"></a>lag(expr, offset, default)</h3><p>å¯ä»¥å¾—åˆ°åŒç»„å‰<code>offset</code>çš„tupelçš„æ•°å€¼ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, lag(x, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | lag </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |    </span><br><span class="line"> 10 |  10</span><br><span class="line"> 14 |  10</span><br><span class="line"> 17 |  14</span><br><span class="line"> 17 |  17</span><br><span class="line"> 18 |  17</span><br><span class="line"> 20 |  18</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<p>å…¶ä¸­ç©ºç€çš„é‚£ä¸€æ ¼æ˜¯<code>NULL</code>ï¼Œæ˜¯æˆ‘ä»¬è®¾ç½®çš„defaulté»˜è®¤å€¼ã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, lag(<span class="number">2</span> * x, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | lag </span><br><span class="line"><span class="comment">----+-----</span></span><br><span class="line"> 10 |    </span><br><span class="line"> 10 |  20</span><br><span class="line"> 14 |  20</span><br><span class="line"> 17 |  28</span><br><span class="line"> 17 |  34</span><br><span class="line"> 18 |  34</span><br><span class="line"> 20 |  36</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="lead-expr-offset-default"><a href="#lead-expr-offset-default" class="headerlink" title="lead(expr, offset, default)"></a>lead(expr, offset, default)</h3><p>å¯ä»¥å¾—åˆ°åŒç»„å‰<code>offset</code>çš„tupelçš„æ•°å€¼ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> testdata(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">10</span>),</span><br><span class="line">                    (<span class="number">14</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">17</span>),</span><br><span class="line">                    (<span class="number">18</span>),</span><br><span class="line">                    (<span class="number">20</span>))</span><br><span class="line"><span class="keyword">select</span> x, <span class="keyword">lead</span>(<span class="number">2</span> * x, <span class="number">2</span>, <span class="number">-1</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> x)</span><br><span class="line"><span class="keyword">from</span> testdata;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> x  | lead </span><br><span class="line"><span class="comment">----+------</span></span><br><span class="line"> 10 |   28</span><br><span class="line"> 10 |   34</span><br><span class="line"> 14 |   34</span><br><span class="line"> 17 |   36</span><br><span class="line"> 17 |   40</span><br><span class="line"> 18 |   -1</span><br><span class="line"> 20 |   -1</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>å¼•ç”¨: </p>
<p>è¯¾ä»¶: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>TUM-IN2326</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(6)</title>
    <url>/2020/03/31/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-6/</url>
    <content><![CDATA[<h1 id="Six-Degrees-of-Kevin-Bacon"><a href="#Six-Degrees-of-Kevin-Bacon" class="headerlink" title="Six Degrees of Kevin Bacon"></a>Six Degrees of Kevin Bacon</h1><p>å…·ä½“æè¿°è§: <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2l4X0RlZ3JlZXNfb2ZfS2V2aW5fQmFjb24=" title="https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon">https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon<i class="fa fa-external-link"></i></span></p>
<p>Six Degrees of Kevin Baconæˆ–â€Baconâ€™s Lawâ€æ˜¯åŸºäºâ€six degrees of separationå…­åº¦åˆ†ç¦»â€ï¼Œå®ƒå‡å®šåœ°çƒä¸Šä»»ä½•ä¸¤ä¸ªäººç›¸è·å…­ä¸ªæˆ–æ›´å°‘çš„ç†Ÿäººé“¾æ¥ã€‚ æ¯”å¦‚å¯»æ‰¾ä»»æ„æ¼”å‘˜å’Œå¤šäº§æ¼”å‘˜Kevin Baconä¹‹é—´çš„æœ€çŸ­è·¯å¾„ã€‚ å®ƒåŸºäºä¸€ä¸ªå‡è®¾ï¼Œå³å¥½è±åç”µå½±ç•Œçš„ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡å…¶ç”µå½±è§’è‰²åœ¨å…­ä¸ªæ­¥éª¤ä¸­å°†å…¶ä¸Kevin Baconè”ç³»èµ·æ¥ã€‚è¿™ä¸ªæ¦‚å¿µä¹Ÿç±»ä¼¼Fackbookæå‡ºçš„æ¦‚å¿µã€‚å½“ç„¶åœ¨è®¡ç®—æœºæˆ–è€…ç®—æ³•è§’åº¦ï¼Œè¿™æ˜¯ä¸€ä¸ªBFSå¹¿åº¦ä¼˜å…ˆçš„å›¾é—®é¢˜ã€‚é€šè¿‡é—´æ¥çš„6æ­¥å¯èƒ½ä¼šæ¥è§¦éå¸¸å¤šäººï¼Œäº§ç”Ÿéå¸¸å¤§çš„æ•°æ®ã€‚å…·ä½“æˆ‘ä»¬ä¼šåœ¨ä¸‹é¢çš„ç»ƒä¹ ä¸­ä½“éªŒåˆ°ã€‚</p>
<p>è¿™é‡Œå†é™„ä¸ŠKevin Baconçš„ä¸€äº›é“¾æ¥:</p>
<ul>
<li>ä¸ªäººç½‘ç«™(ä»–ç›´æ¥ç”¨äº†six degreeè¿™ä¸ªæ¦‚å¿µ): <span class="exturl" data-url="aHR0cHM6Ly93d3cuc2l4ZGVncmVlcy5vcmc=" title="https://www.sixdegrees.org">https://www.sixdegrees.org<i class="fa fa-external-link"></i></span></li>
<li>è±†ç“£ä¸»é¡µ: <span class="exturl" data-url="aHR0cHM6Ly9tb3ZpZS5kb3ViYW4uY29tL2NlbGVicml0eS8xMDA5MjYwLw==" title="https://movie.douban.com/celebrity/1009260/">https://movie.douban.com/celebrity/1009260/<i class="fa fa-external-link"></i></span></li>
</ul>
<a id="more"></a>
<h2 id="IMDbæ•°æ®é›†"><a href="#IMDbæ•°æ®é›†" class="headerlink" title="IMDbæ•°æ®é›†"></a>IMDbæ•°æ®é›†</h2><p>æˆ‘ä»¬è¿™æ¬¡ä½¿ç”¨IMDbæ•°æ®é›†ï¼Œæœ¬åœ°è½½å…¥æ•°æ®é›†çš„æ–¹å¼è§æˆ‘ä»¥å‰çš„ä¸€ç¯‡æ–‡ç« : <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#IMDb-%E6%95%B0%E6%8D%AE%E9%9B%86">[DBMS]PostgreSQLå¯¼å…¥æ•°æ®é›† - IMDb æ•°æ®é›†</a></p>
<p><br></p>
<p>æˆ‘ä»¬æ‰“å¼€psqlçš„è®¡æ—¶å™¨:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">imdb=# \timing</span><br><span class="line">Timing is on.</span><br></pre></td></tr></tbody></table></figure>
<h2 id="è°ƒæ•´buffer-poolå’Œcacheå¤§å°"><a href="#è°ƒæ•´buffer-poolå’Œcacheå¤§å°" class="headerlink" title="è°ƒæ•´buffer poolå’Œcacheå¤§å°"></a>è°ƒæ•´buffer poolå’Œcacheå¤§å°</h2><p>æˆ‘ä»¬ç”¨è‡ªå·±å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨å»æ‰“å¼€<code>/etc/postgresql/10/main/postgresql.conf</code>æ–‡ä»¶:</p>
<ul>
<li>æ³¨æ„æˆ‘<code>postgresql</code>çš„ç‰ˆæœ¬æ˜¯<code>10</code></li>
<li>å…·ä½“çš„é…ç½®æ–‡ä»¶ä½ç½®å’Œ<code>postgresql</code>å®‰è£…ä½ç½®å’Œå®‰è£…ç‰ˆæœ¬æœ‰å…³</li>
</ul>
<p>æ‰¾åˆ°ä¸‹é¢å¯¹åº”çš„<code>shared_buffers</code>å»ºè®®æ›´æ”¹æ•°å€¼ä¸º1024MBï¼Œ <code>work_mem</code>å»ºè®®æ›´æ”¹ä¸º1024MB (æˆ‘éƒ½æ”¹æˆæ¯”å»ºè®®å€¼å¤§ï¼Œè¿™é‡Œå¤§å®¶æŒ‰ç…§è‡ªå·±æœºå™¨çš„ç¡¬ä»¶é…ç½®æ¥ä¼°è®¡):</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># RESOURCE USAGE (except WAL)</span></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Memory -</span></span><br><span class="line"></span><br><span class="line">shared_buffers = 2048MB                 <span class="comment"># min 128kB</span></span><br><span class="line">                                        <span class="comment"># (change requires restart)</span></span><br><span class="line"><span class="comment">#huge_pages = try                       # on, off, or try</span></span><br><span class="line">                                        <span class="comment"># (change requires restart)</span></span><br><span class="line"><span class="comment">#temp_buffers = 8MB                     # min 800kB </span></span><br><span class="line"><span class="comment">#max_prepared_transactions = 0          # zero disables the feature</span></span><br><span class="line">                                        <span class="comment"># (change requires restart)</span></span><br><span class="line"><span class="comment"># Caution: it is not advisable to set max_prepared_transactions nonzero unless</span></span><br><span class="line"><span class="comment"># you actively intend to use prepared transactions.</span></span><br><span class="line">work_mem = 8196MB                               <span class="comment"># min 64kB  </span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure>
<p>æ›´æ”¹å¥½åä¿å­˜ï¼Œæ‰§è¡Œä¸‹é¢çš„æŒ‡ä»¤ï¼Œè®©psqlé‡å¯æ¥ä½¿é…ç½®ç”Ÿæ•ˆ:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="æ±‚Bacon-Kevinæ¼”è¿‡çš„ç”µå½±æ•°é‡"><a href="#æ±‚Bacon-Kevinæ¼”è¿‡çš„ç”µå½±æ•°é‡" class="headerlink" title="æ±‚Bacon, Kevinæ¼”è¿‡çš„ç”µå½±æ•°é‡"></a>æ±‚<code>Bacon, Kevin</code>æ¼”è¿‡çš„ç”µå½±æ•°é‡</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> movie_name)</span><br><span class="line"><span class="keyword">from</span> playedin_text</span><br><span class="line"><span class="keyword">where</span> actor_name = <span class="string">'Bacon, Kevin'</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> count </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line">   322</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 838.464 ms</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº1çš„æ¼”å‘˜æ•°é‡"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº1çš„æ¼”å‘˜æ•°é‡" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº1çš„æ¼”å‘˜æ•°é‡"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº1çš„æ¼”å‘˜æ•°é‡</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (<span class="keyword">id</span>, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> p2.actor_name, baconnr.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> baconnr, playedin_text p1, playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> baconnr.id = p1.actor_name <span class="keyword">and</span> </span><br><span class="line">          p1.movie_name = p2.movie_name <span class="keyword">and</span> </span><br><span class="line">          baconnr.nr &lt; <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> count </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line"> 35893</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 5718.960 ms (00:05.719)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-ä¸€æ¬¡å°è¯•"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-ä¸€æ¬¡å°è¯•" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - ä¸€æ¬¡å°è¯•"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - ä¸€æ¬¡å°è¯•</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (<span class="keyword">id</span>, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> p2.actor_name, baconnr.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> baconnr, playedin_text p1, playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> baconnr.id = p1.actor_name <span class="keyword">and</span> </span><br><span class="line">          p1.movie_name = p2.movie_name <span class="keyword">and</span> </span><br><span class="line">          baconnr.nr &lt; <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure>
<p>å¾ˆå¯æƒœè¿™æ¡SQLåœ¨æˆ‘çš„ç”µè„‘ä¸Šååˆ†é’Ÿå†…æ— æ³•ç»ˆæ­¢ã€‚æœ¬è´¨ä¸Šè¿™å±äºä¸€ä¸ªå¹¿åº¦æœç´¢ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡å¤æ¥è§¦åˆ°å¾ˆå¤šäººï¼Œè¿™ä½¿è¿™æ¡SQLåœ¨çŸ­æ—¶é—´å†…ä¸èƒ½ç»ˆæ­¢ã€‚</p>
<h3 id="cardinality"><a href="#cardinality" class="headerlink" title="cardinality"></a>cardinality</h3><p>å³Bacon Numberç­‰äº1ï¼Œä½†æ˜¯å­˜åœ¨é‡å¤</p>
<p>the size of intermediate results</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(p2.actor_name)</span><br><span class="line"><span class="keyword">from</span> playedin_text p1, playedin_text p2</span><br><span class="line"><span class="keyword">where</span> p1.actor_name = <span class="string">'Bacon, Kevin'</span> <span class="keyword">and</span> p1.movie_name = p2.movie_name;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">  count  </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line"> 1391638</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 11896.991 ms (00:11.897)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-é™¤å»é‡å¤"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-é™¤å»é‡å¤" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - é™¤å»é‡å¤"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - é™¤å»é‡å¤</h2><p>ä½¿ç”¨<code>union all</code>å’Œ<code>select distinct</code>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (actor_name, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> p2.actor_name, movies.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> p1.movie_name, baconnr.nr</span><br><span class="line">          <span class="keyword">from</span> baconnr, playedin_text p1</span><br><span class="line">          <span class="keyword">where</span> baconnr.actor_name = p1.actor_name</span><br><span class="line">         ) movies,</span><br><span class="line">         playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> movies.movie_name = p2.movie_name <span class="keyword">and</span> movies.nr &lt; <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> actor_name)</span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">  count  </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line"> 1046450</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 27453.873 ms (00:27.454)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-é™¤å»é‡å¤-1"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡-é™¤å»é‡å¤-1" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - é™¤å»é‡å¤"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº2çš„æ¼”å‘˜æ•°é‡ - é™¤å»é‡å¤</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (actor_name, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Bacon, Kevin'</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> p2.actor_name, movies.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> p1.movie_name, baconnr.nr</span><br><span class="line">          <span class="keyword">from</span> baconnr, playedin_text p1</span><br><span class="line">          <span class="keyword">where</span> baconnr.actor_name = p1.actor_name</span><br><span class="line">         ) movies,</span><br><span class="line">         playedin_text p2</span><br><span class="line">    <span class="keyword">where</span> movies.movie_name = p2.movie_name <span class="keyword">and</span> movies.nr &lt; <span class="number">3</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> actor_name)</span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br><br><br></p>
<h2 id="string-to-int"><a href="#string-to-int" class="headerlink" title="string to int"></a>string to int</h2><p>å¯¹stringçš„æ“ä½œæ˜¯ç›¸å¯¹æ˜‚è´µçš„ï¼Œä½†æ˜¯å¯¹intçš„æ“ä½œæ˜¯ç›¸å¯¹å»‰ä»·çš„ã€‚æˆ‘ä»¬æ–°å»ºå¯¹åº”çš„å‡ ä¸ªæ–°çš„è¡¨æ ¼ï¼Œä½¿ç”¨int, è¿™æ ·ä¹Ÿå¯ä»¥é™ä½è¡¨æ ¼çš„å¤§å°ã€‚</p>
<ul>
<li>table actors (id::integer, name::text)</li>
<li>table movies (id::integer, name::text)</li>
<li>table playedin (actor::integer, movies::integer)</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> movies (<span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>, <span class="keyword">name</span> <span class="built_in">text</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> actors (<span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>, <span class="keyword">name</span> <span class="built_in">text</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> playedin (</span><br><span class="line">    movie <span class="built_in">integer</span> <span class="keyword">references</span> movies (<span class="keyword">id</span>),</span><br><span class="line">    actor <span class="built_in">integer</span> <span class="keyword">references</span> actors (<span class="keyword">id</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actors (<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">distinct</span> actor_name <span class="keyword">from</span> playedin_text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> movies (<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">distinct</span> movie_name <span class="keyword">from</span> playedin_text;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- read from all</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> playedin (actor, movie)</span><br><span class="line"><span class="keyword">select</span> actors.id, movies.id</span><br><span class="line"><span class="keyword">from</span> actors, movies, playedin_text p</span><br><span class="line"><span class="keyword">where</span> p.actor_name = actors.name <span class="keyword">and</span> p.movie_name = movies.name;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ‰¾åˆ°Bacon-Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡"><a href="#æ‰¾åˆ°Bacon-Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡" class="headerlink" title="æ‰¾åˆ°Bacon Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡"></a>æ‰¾åˆ°Bacon Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> baconnr (<span class="keyword">id</span>, nr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span> , <span class="number">0</span></span><br><span class="line">    <span class="keyword">from</span> actors</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'Bacon, Kevin'</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> p2.actor, movies.nr + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    ( <span class="keyword">select</span> <span class="keyword">distinct</span> p1.movie, baconnr.nr</span><br><span class="line">    <span class="keyword">from</span> baconnr, playedin p1</span><br><span class="line">    <span class="keyword">where</span> baconnr.id = p1.actor) movies,</span><br><span class="line">    playedin p2</span><br><span class="line">    <span class="keyword">where</span> movies.movie = p2.movie <span class="keyword">and</span> movies.nr &lt; <span class="number">5</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span> (<span class="keyword">distinct</span> <span class="keyword">id</span>)</span><br><span class="line"><span class="keyword">from</span> baconnr;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">  count  </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line"> 1821293</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 175282.570 ms (02:55.283)</span><br></pre></td></tr></tbody></table></figure>
<h1 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h1><p>æ•°æ®é›†(ä»¥åŠç°å®ä¸–ç•Œ)ä¸­ç”šè‡³æœ‰Bacon Numberä¸º7çš„æ¼”å‘˜ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å†ç»§ç»­äº†ã€‚å¤§å®¶å¦‚æœèƒ½å®éªŒä¸€ä¸‹ï¼Œäº†è§£ä¸»æ—¨å°±å¾ˆå¥½ã€‚</p>
<p><br><br><br><br><br></p>
<h1 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h1><h2 id="Optional-æ‰¾åˆ°Bacon-Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡-Query-Plan"><a href="#Optional-æ‰¾åˆ°Bacon-Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡-Query-Plan" class="headerlink" title="Optional: æ‰¾åˆ°Bacon Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡ - Query Plan"></a>Optional: æ‰¾åˆ°Bacon Numberå°äºç­‰äº6çš„æ¼”å‘˜æ•°é‡ - Query Plan</h2><p>è¿™éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œè€Œä¸æ˜¯å¿…é¡»çš„ã€‚è¿™éƒ¨åˆ†æˆ‘é™„ä¸Šäº†ä¸Šä¸€ä¸ªSQLå¯¹åº”çš„Query Planã€‚</p>
<ul>
<li>æˆ‘æ‰“å¼€äº†å¤šçº¿ç¨‹é€‰é¡¹: <code>testdb=# set max_parallel_workers_per_gather = 4;</code>, å¯¹åº”ä¸‹é¢çš„Query Planä¸­çš„Workersã€‚</li>
<li>æˆ‘ä½¿ç”¨äº†ç»å¯¹å¤§çš„buffer poolå»å®¹çº³æ‰€æœ‰çš„page, å› æ­¤ä¸‹é¢Query Planåªæœ‰<code>shared hit</code>ï¼Œ è€Œæ²¡æœ‰<code>shared read</code></li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">imdb=# explain (analyze, buffers) with recursive baconnr (id, nr) as (</span><br><span class="line">    select id , <span class="number">0</span></span><br><span class="line">    from actors</span><br><span class="line">    where name = 'Bacon, Kevin'</span><br><span class="line">    <span class="keyword">union</span> all</span><br><span class="line">    select distinct p2.actor, movies.nr + <span class="number">1</span></span><br><span class="line">    from</span><br><span class="line">    ( select distinct p1.movie, baconnr.nr</span><br><span class="line">    from baconnr, playedin p1</span><br><span class="line">    where baconnr.id = p1.actor) movies,</span><br><span class="line">    playedin p2</span><br><span class="line">    where movies.movie = p2.movie <span class="keyword">and</span> movies.nr &lt; <span class="number">5</span></span><br><span class="line">)</span><br><span class="line">select count (distinct id)</span><br><span class="line">from baconnr;</span><br><span class="line">                                                                                QUERY PLAN                                                                                </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">3243681.47</span>.<span class="number">.3243681</span><span class="number">.48</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">181539.730</span>.<span class="number">.181539</span><span class="number">.730</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">72933155</span></span><br><span class="line">   CTE baconnr</span><br><span class="line">     -&gt;  Recursive Union  (cost=<span class="number">1000.00</span>.<span class="number">.3196845</span><span class="number">.00</span> rows=<span class="number">2081621</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">1.375</span>.<span class="number">.178161</span><span class="number">.180</span> rows=<span class="number">6480755</span> loops=<span class="number">1</span>)</span><br><span class="line">           Buffers: shared hit=<span class="number">72933155</span></span><br><span class="line">           -&gt;  Gather  (cost=<span class="number">1000.00</span>.<span class="number">.23770</span><span class="number">.35</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">1.366</span>.<span class="number">.65</span><span class="number">.451</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">                 Workers Planned: <span class="number">2</span></span><br><span class="line">                 Workers Launched: <span class="number">2</span></span><br><span class="line">                 Buffers: shared hit=<span class="number">12501</span></span><br><span class="line">                 -&gt;  Parallel Seq Scan on actors  (cost=<span class="number">0.00</span>.<span class="number">.22770</span><span class="number">.25</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">40.406</span>.<span class="number">.61</span><span class="number">.732</span> rows=<span class="number">0</span> loops=<span class="number">3</span>)</span><br><span class="line">                       Filter: (name = 'Bacon, Kevin'::text)</span><br><span class="line">                       Rows Removed by Filter: <span class="number">657232</span></span><br><span class="line">                       Buffers: shared hit=<span class="number">12501</span></span><br><span class="line">           -&gt;  HashAggregate  (cost=<span class="number">310542.20</span>.<span class="number">.313144</span><span class="number">.22</span> rows=<span class="number">208162</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">29230.371</span>.<span class="number">.29512</span><span class="number">.804</span> rows=<span class="number">1080126</span> loops=<span class="number">6</span>)</span><br><span class="line">                 Group Key: p2.actor, (baconnr_1.nr + <span class="number">1</span>)</span><br><span class="line">                 Buffers: shared hit=<span class="number">72920654</span></span><br><span class="line">                 -&gt;  Nested Loop  (cost=<span class="number">2384.03</span>.<span class="number">.309501</span><span class="number">.39</span> rows=<span class="number">208162</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">13040.311</span>.<span class="number">.25542</span><span class="number">.265</span> rows=<span class="number">10389484</span> loops=<span class="number">6</span>)</span><br><span class="line">                       Buffers: shared hit=<span class="number">72920654</span></span><br><span class="line">                       -&gt;  HashAggregate  (cost=<span class="number">2376.97</span>.<span class="number">.2383</span><span class="number">.06</span> rows=<span class="number">609</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">13039.878</span>.<span class="number">.13290</span><span class="number">.218</span> rows=<span class="number">570802</span> loops=<span class="number">6</span>)</span><br><span class="line">                             Group Key: p1.movie, baconnr_1.nr</span><br><span class="line">                             Buffers: shared hit=<span class="number">30919755</span></span><br><span class="line">                             -&gt;  Nested Loop  (cost=<span class="number">6.01</span>.<span class="number">.2373</span><span class="number">.92</span> rows=<span class="number">609</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">16.277</span>.<span class="number">.9987</span><span class="number">.675</span> rows=<span class="number">8778940</span> loops=<span class="number">6</span>)</span><br><span class="line">                                   Buffers: shared hit=<span class="number">30919755</span></span><br><span class="line">                                   -&gt;  WorkTable Scan on baconnr baconnr_1  (cost=<span class="number">0.00</span>.<span class="number">.0</span><span class="number">.22</span> rows=<span class="number">3</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">16.246</span>.<span class="number">.173</span><span class="number">.118</span> rows=<span class="number">776577</span> loops=<span class="number">6</span>)</span><br><span class="line">                                         Filter: (nr &lt; <span class="number">5</span>)</span><br><span class="line">                                         Rows Removed by Filter: <span class="number">303549</span></span><br><span class="line">                                   -&gt;  Bitmap Heap Scan on playedin p1  (cost=<span class="number">6.01</span>.<span class="number">.789</span><span class="number">.20</span> rows=<span class="number">203</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.006</span>.<span class="number">.0</span><span class="number">.010</span> rows=<span class="number">11</span> loops=<span class="number">4659462</span>)</span><br><span class="line">                                         Recheck Cond: (actor = baconnr_1.id)</span><br><span class="line">                                         Heap Blocks: exact=<span class="number">16784601</span></span><br><span class="line">                                         Buffers: shared hit=<span class="number">30919755</span></span><br><span class="line">                                         -&gt;  Bitmap Index Scan on playedin_actor_idx  (cost=<span class="number">0.00</span>.<span class="number">.5</span><span class="number">.96</span> rows=<span class="number">203</span> <span class="built_in">width</span>=<span class="number">0</span>) (actual time=<span class="number">0.004</span>.<span class="number">.0</span><span class="number">.004</span> rows=<span class="number">11</span> loops=<span class="number">4659462</span>)</span><br><span class="line">                                               Index Cond: (actor = baconnr_1.id)</span><br><span class="line">                                               Buffers: shared hit=<span class="number">14135154</span></span><br><span class="line">                       -&gt;  Bitmap Heap Scan on playedin p2  (cost=<span class="number">7.07</span>.<span class="number">.500</span><span class="number">.01</span> rows=<span class="number">342</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.007</span>.<span class="number">.0</span><span class="number">.018</span> rows=<span class="number">18</span> loops=<span class="number">3424813</span>)</span><br><span class="line">                             Recheck Cond: (movie = p1.movie)</span><br><span class="line">                             Heap Blocks: exact=<span class="number">31546852</span></span><br><span class="line">                             Buffers: shared hit=<span class="number">42000899</span></span><br><span class="line">                             -&gt;  Bitmap Index Scan on playedin_movie_idx  (cost=<span class="number">0.00</span>.<span class="number">.6</span><span class="number">.98</span> rows=<span class="number">342</span> <span class="built_in">width</span>=<span class="number">0</span>) (actual time=<span class="number">0.005</span>.<span class="number">.0</span><span class="number">.005</span> rows=<span class="number">18</span> loops=<span class="number">3424813</span>)</span><br><span class="line">                                   Index Cond: (movie = p1.movie)</span><br><span class="line">                                   Buffers: shared hit=<span class="number">10454047</span></span><br><span class="line">   -&gt;  CTE Scan on baconnr  (cost=<span class="number">0.00</span>.<span class="number">.41632</span><span class="number">.42</span> rows=<span class="number">2081621</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1.379</span>.<span class="number">.179511</span><span class="number">.482</span> rows=<span class="number">6480755</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">72933155</span></span><br><span class="line"> Planning time: <span class="number">0.260</span> ms</span><br><span class="line"> Execution time: <span class="number">181676.112</span> ms</span><br><span class="line">(<span class="number">44</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">181676.868</span> ms (<span class="number">03</span>:<span class="number">01.677</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Optional-Buffer-Poolé¢„åŠ è½½"><a href="#Optional-Buffer-Poolé¢„åŠ è½½" class="headerlink" title="Optional: Buffer Poolé¢„åŠ è½½"></a>Optional: Buffer Poolé¢„åŠ è½½</h2><p>è¿™éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œè€Œä¸æ˜¯å¿…é¡»çš„ã€‚è¿™éƒ¨åˆ†çš„å…·ä½“è§£é‡Šè§æˆ‘çš„å¦ä¸€ä¸ªå®éªŒ <a href="https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/">[DBMS][PostgreSQL] ç¼“å­˜åŒºç®¡ç† BufferPool</a></p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼ï¼Œåœ¨æ‰§è¡Œæˆ‘ä»¬çš„SQLä¹‹å‰ï¼Œå°†éœ€è¦çš„pageé¢„åŠ è½½è¿›buffer pool:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">imdb=# CREATE EXTENSION pg_prewarm;</span><br><span class="line">CREATE EXTENSION</span><br><span class="line"></span><br><span class="line">imdb=# select * from pg_prewarm('actors');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">      <span class="number">12501</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">71.137</span> ms</span><br><span class="line">imdb=# select * from pg_prewarm('movies');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">       <span class="number">8396</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">88.954</span> ms</span><br><span class="line">imdb=# select * from pg_prewarm('playedin');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">      <span class="number">76623</span></span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>DBMS</category>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>PostgreSQL</tag>
        <tag>Recursion</tag>
        <tag>Six Degrees of Kevin Bacon</tag>
        <tag>BFS</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(5)</title>
    <url>/2020/03/30/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-5/</url>
    <content><![CDATA[<h1 id="å›¾è®º"><a href="#å›¾è®º" class="headerlink" title="å›¾è®º"></a>å›¾è®º</h1><p>åœ¨è¿™ç¯‡æ–‡ç« é«˜çº§ SQL ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢å›¾è®ºçš„é¢˜ç›®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†(å›¾)éƒ½åœ¨æ–‡ç« ä¸­çš„SQLä¸­ã€‚</p>
<a id="more"></a>
<h2 id="æ— ç¯å›¾-æ ‘"><a href="#æ— ç¯å›¾-æ ‘" class="headerlink" title="æ— ç¯å›¾ / æ ‘"></a>æ— ç¯å›¾ / æ ‘</h2><p><img data-src="/images/FDE/chap3/21.jpg" alt="21.jpg"></p>
<h3 id="æ‰¾çˆ¶èŠ‚ç‚¹"><a href="#æ‰¾çˆ¶èŠ‚ç‚¹" class="headerlink" title="æ‰¾çˆ¶èŠ‚ç‚¹"></a>æ‰¾çˆ¶èŠ‚ç‚¹</h3><ul>
<li>æœç´¢<code>turtle</code>çš„çˆ¶èŠ‚ç‚¹(æ‰€æœ‰ç›´æ¥å’Œé—´æ¥çˆ¶äº²)ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span></span><br><span class="line">     animals (<span class="keyword">id</span>, <span class="keyword">name</span>, <span class="keyword">parent</span>) <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'animal'</span>, <span class="literal">null</span>), (<span class="number">2</span>, <span class="string">'mammal'</span>, <span class="number">1</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="string">'giraffe'</span>, <span class="number">2</span>), (<span class="number">4</span>, <span class="string">'tiger'</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="string">'reptile'</span>, <span class="number">1</span>), (<span class="number">6</span>, <span class="string">'snake'</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">7</span>, <span class="string">'turtle'</span>, <span class="number">5</span>), (<span class="number">8</span>, <span class="string">'grean sea turtle'</span>, <span class="number">7</span>)),</span><br><span class="line">     r <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> * </span><br><span class="line">         <span class="keyword">from</span> animals </span><br><span class="line">         <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'turtle'</span></span><br><span class="line">         <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">         <span class="keyword">select</span> animals.*</span><br><span class="line">         <span class="keyword">from</span> r, animals</span><br><span class="line">         <span class="keyword">where</span> animals.id = r.parent)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"> id |  name   | parent </span><br><span class="line">----+---------+--------</span><br><span class="line">  7 | turtle  |      5</span><br><span class="line">  5 | reptile |      1</span><br><span class="line">  1 | animal  |       </span><br><span class="line">(3 rows)</span><br></pre></td></tr></tbody></table></figure>
<p>&lt;/br&gt;</p>
<h3 id="æ‰¾å­èŠ‚ç‚¹"><a href="#æ‰¾å­èŠ‚ç‚¹" class="headerlink" title="æ‰¾å­èŠ‚ç‚¹"></a>æ‰¾å­èŠ‚ç‚¹</h3><ul>
<li>æœç´¢<code>reptile</code>çš„å­èŠ‚ç‚¹(æ‰€æœ‰ç›´æ¥å’Œé—´æ¥å­©å­)ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span></span><br><span class="line">     animals (<span class="keyword">id</span>, <span class="keyword">name</span>, <span class="keyword">parent</span>) <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'animal'</span>, <span class="literal">null</span>), (<span class="number">2</span>, <span class="string">'mammal'</span>, <span class="number">1</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="string">'giraffe'</span>, <span class="number">2</span>), (<span class="number">4</span>, <span class="string">'tiger'</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="string">'reptile'</span>, <span class="number">1</span>), (<span class="number">6</span>, <span class="string">'snake'</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">7</span>, <span class="string">'turtle'</span>, <span class="number">5</span>), (<span class="number">8</span>, <span class="string">'grean sea turtle'</span>, <span class="number">7</span>)),</span><br><span class="line">     r <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> *</span><br><span class="line">         <span class="keyword">from</span> animals</span><br><span class="line">         <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'reptile'</span></span><br><span class="line">         <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">         <span class="keyword">select</span> animals.* <span class="comment">-- get the descendants</span></span><br><span class="line">         <span class="keyword">from</span> r, animals</span><br><span class="line">         <span class="keyword">where</span> animals.parent = r.id <span class="comment">-- r is the parent of the new founded animal</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> id |       name       | parent </span><br><span class="line"><span class="comment">----+------------------+--------</span></span><br><span class="line">  5 | reptile          |      1</span><br><span class="line">  7 | turtle           |      5</span><br><span class="line">  6 | snake            |      5</span><br><span class="line">  8 | grean sea turtle |      7</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="å¸¦ç¯å›¾"><a href="#å¸¦ç¯å›¾" class="headerlink" title="å¸¦ç¯å›¾"></a>å¸¦ç¯å›¾</h2><p><img data-src="/images/FDE/chap3/24.jpg" alt="24.jpg"></p>
<ul>
<li>æœç´¢<code>Alice</code>çš„æ‰€æœ‰æœ‹å‹(å³ä»<code>Alice</code>èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹):</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span></span><br><span class="line">     friends (a, b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'Alice'</span>, <span class="string">'Bob'</span>), (<span class="string">'Alice'</span>, <span class="string">'Carol'</span>),</span><br><span class="line">           (<span class="string">'Carol'</span>, <span class="string">'Grace'</span>), (<span class="string">'Carol'</span>, <span class="string">'Chuck'</span>),</span><br><span class="line">           (<span class="string">'Chuck'</span>, <span class="string">'Grace'</span>), (<span class="string">'Chuck'</span>,<span class="string">'Anne'</span>),</span><br><span class="line">           (<span class="string">'Bob'</span>,<span class="string">'Dan'</span>),(<span class="string">'Dan'</span>,<span class="string">'Anne'</span>),(<span class="string">'Eve'</span>,<span class="string">'Adam'</span>)</span><br><span class="line">           ),</span><br><span class="line">     friendship (<span class="keyword">name</span>, friend) <span class="keyword">as</span> <span class="comment">-- friendship is symmetric, bi-directional graph</span></span><br><span class="line">    (<span class="keyword">select</span> a, b</span><br><span class="line">    <span class="keyword">from</span> friends</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> b, a</span><br><span class="line">    <span class="keyword">from</span> friends),</span><br><span class="line">     r <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">'Alice'</span> <span class="keyword">as</span> <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> friendship.name</span><br><span class="line">    <span class="keyword">from</span> r, friendship</span><br><span class="line">    <span class="keyword">where</span> r.name = friendship.friend)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> name  </span><br><span class="line"><span class="comment">-------</span></span><br><span class="line"> Alice</span><br><span class="line"> Bob</span><br><span class="line"> Carol</span><br><span class="line"> Grace</span><br><span class="line"> Chuck</span><br><span class="line"> Dan</span><br><span class="line"> Anne</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ æˆ‘ä»¬åœ¨é«˜çº§SQL-é€’å½’éƒ¨åˆ†å¯¹å°è§„æ¨¡çš„æ ‘å’Œå›¾è¿›è¡Œäº†éå†ã€‚æˆ‘ä»¬ä¸»è¦ç ”ç©¶èŠ‚ç‚¹çš„çˆ¶å­å…³ç³»å’ŒèŠ‚ç‚¹é—´çš„å¯åˆ°è¾¾æ€§é—®é¢˜ã€‚ä½¿ç”¨<code>with recursive</code>å­å¥ï¼Œæ­é…å¯¹åº”çš„<code>union all</code>æˆ–<code>union</code>è®©é€’å½’é—®é¢˜ä¸€é€šç™¾é€šã€‚</p>
<p>ä¸‹ä¸€æ¬¡æˆ‘ä»¬ä¼šç ”ç©¶ä¸€ä¸ªçœŸå®æ•°æ®é›†ä¸­çš„é—®é¢˜ï¼Œä¾æ—§æ˜¯<em>æœ‹å‹</em>çš„å›¾å…³ç³»ï¼Œä½†æ˜¯æ•°æ®é›†å¾ˆå¤§ï¼ŒåŒæ—¶è®¡ç®—é‡ä¹Ÿéå¸¸å·¨å¤§ã€‚</p>
<p>å¼•ç”¨: </p>
<p>è¯¾ä»¶: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Graph</category>
        <category>TUM-IN2326</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Recursion</tag>
        <tag>Graph</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(4)</title>
    <url>/2020/03/27/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-4/</url>
    <content><![CDATA[<h1 id="å›¾è®º"><a href="#å›¾è®º" class="headerlink" title="å›¾è®º"></a>å›¾è®º</h1><p>åœ¨è¿™ç¯‡æ–‡ç« é«˜çº§ SQL ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢å›¾è®ºçš„é¢˜ç›®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†(å›¾)éƒ½åœ¨æ–‡ç« ä¸­çš„SQLä¸­ã€‚</p>
<a id="more"></a>
<h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p><img data-src="/images/SQL/graph1.png" alt="graph1.png"></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> singleDirection;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity"><a href="#å¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity" class="headerlink" title="å¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):"></a>å¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">    ), undirectedGraph <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> b, a</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">    ), transitive_closure (a, b) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph</span><br><span class="line">        <span class="keyword">union</span></span><br><span class="line">        <span class="keyword">select</span> a.a, b.b</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph b, transitive_closure a</span><br><span class="line">        <span class="keyword">where</span> a.b = b.a</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> transitive_closure</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a, b;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="6å’Œ1æ˜¯è”é€š-connected-reachable-çš„å—"><a href="#6å’Œ1æ˜¯è”é€š-connected-reachable-çš„å—" class="headerlink" title="6å’Œ1æ˜¯è”é€š(connected, reachable)çš„å—?"></a>6å’Œ1æ˜¯è”é€š(connected, reachable)çš„å—?</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">    ), undirectedGraph <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> b, a</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">    ), transitive_closure (a, b) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph</span><br><span class="line">        <span class="keyword">union</span></span><br><span class="line">        <span class="keyword">select</span> a.a, b.b</span><br><span class="line">        <span class="keyword">from</span> undirectedGraph b, transitive_closure a</span><br><span class="line">        <span class="keyword">where</span> a.b = b.a</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> transitive_closure </span><br><span class="line"><span class="keyword">where</span> a = <span class="number">6</span> <span class="keyword">and</span> b = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="æ±‚6å’Œ1çš„æœ€çŸ­è·ç¦»"><a href="#æ±‚6å’Œ1çš„æœ€çŸ­è·ç¦»" class="headerlink" title="æ±‚6å’Œ1çš„æœ€çŸ­è·ç¦»?"></a>æ±‚6å’Œ1çš„æœ€çŸ­è·ç¦»?</h3><p>è¿™é‡Œæˆ‘ä»¬åœ¨<code>transitive_closure</code>ä¸­ä½¿ç”¨äº†<code>union all</code>ï¼Œä¸ºäº†é¿å…å¯¹åº”å‡ºç°çš„ä¸ç»ˆæ­¢çš„é€’å½’ï¼Œæˆ‘ä»¬å¿…é¡»åŠ ä¸Šå¯¹åº”çš„æ¡ä»¶<code>dist &lt;= 4</code>ã€‚å¦å¤–è¿™ä¸ª4æ˜¯æˆ‘ä»¬ç›®æµ‹å‡ºæ¥çš„ä¸€ä¸ªå‚æ•°ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ›´å¤§æ›´æ™®éçš„æ•°å­—ï¼Œæ¯”å¦‚å›¾ä¸­è¾¹çš„æ€»æ•°ï¼Œè¿™æ ·ä¹Ÿèƒ½è¯•é€’å½’ç»ˆæ­¢ã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> singleDirection (a ,b) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">5</span>),</span><br><span class="line">                (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">6</span>)) <span class="keyword">as</span> graph</span><br><span class="line">    ), undirectedGraph <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> b, a</span><br><span class="line">        <span class="keyword">from</span> singleDirection</span><br><span class="line">    ), transitive_closure (a, b, dist) <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> a, b, <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> undirectedGraph</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">        <span class="keyword">select</span> a.a, b.b, dist + <span class="number">1</span></span><br><span class="line">        <span class="keyword">from</span> undirectedGraph b, transitive_closure a</span><br><span class="line">        <span class="keyword">where</span> a.b = b.a <span class="keyword">and</span> dist &lt;= <span class="number">4</span> <span class="comment">-- æˆ–è€…ã€€dist &lt;= 9ï¼Œå› ä¸ºè¿™ä¸ªå›¾é‡Œé¢ä¸€å…±9æ¡è¾¹</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">min</span>(dist)</span><br><span class="line"><span class="keyword">from</span> transitive_closure</span><br><span class="line"><span class="keyword">where</span> a = <span class="number">6</span> <span class="keyword">and</span> b = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br><br><br></p>
<h3 id="ä¾‹å­3"><a href="#ä¾‹å­3" class="headerlink" title="ä¾‹å­3"></a>ä¾‹å­3</h3><p>SQL Standardä¸­æ˜¯è¿™æ ·å®šä¹‰æ¥<code>union all</code>çš„é€’å½’è¯­å¥çš„:</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">workingTable = evaluateNonRecursive()</span><br><span class="line">output workingTable</span><br><span class="line"><span class="keyword">while</span> workingTable <span class="keyword">is</span> <span class="keyword">not</span> empty:</span><br><span class="line">  workingTable = evaluateRecursive(workingTable)</span><br><span class="line">  output workingTable</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªè¡¨æ ¼ï¼Œä»£è¡¨ä¸€ä¸ªå›¾:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>From</th>
<th>To</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>b</td>
</tr>
<tr>
<td>b</td>
<td>c</td>
</tr>
<tr>
<td>b</td>
<td>d</td>
</tr>
<tr>
<td>c</td>
<td>e</td>
</tr>
<tr>
<td>d</td>
<td>e</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> edges (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">   <span class="keyword">values</span></span><br><span class="line">          (<span class="string">'a'</span>, <span class="string">'b'</span>), (<span class="string">'b'</span>, <span class="string">'c'</span>), (<span class="string">'b'</span>, <span class="string">'d'</span>),</span><br><span class="line">          (<span class="string">'c'</span>, <span class="string">'e'</span>), (<span class="string">'d'</span>, <span class="string">'e'</span>)</span><br><span class="line">), discovered (node) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> edges.to_</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    edges, discovered</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">    discovered.node = edges.from_)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> discovered;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> node </span><br><span class="line"><span class="comment">------</span></span><br><span class="line"> a</span><br><span class="line"> b</span><br><span class="line"> d</span><br><span class="line"> c</span><br><span class="line"> e</span><br><span class="line"> e</span><br><span class="line">(6 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h4 id="æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹"><a href="#æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹" class="headerlink" title="æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹"></a>æ±‚ä»<code>a</code>å¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹</h4><p>åº”ç”¨SQL Standardä¸­çš„Working Tableè¡¨è¾¾:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> edges (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">   <span class="keyword">values</span></span><br><span class="line">          (<span class="string">'a'</span>, <span class="string">'b'</span>), (<span class="string">'b'</span>, <span class="string">'c'</span>), (<span class="string">'b'</span>, <span class="string">'d'</span>),</span><br><span class="line">          (<span class="string">'c'</span>, <span class="string">'e'</span>), (<span class="string">'d'</span>, <span class="string">'e'</span>)</span><br><span class="line">), discovered (node, step) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="string">'a'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> edges.to_, discovered.step + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">    edges, discovered</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">    discovered.node = edges.from_)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> discovered;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> node | step </span><br><span class="line"><span class="comment">------+------</span></span><br><span class="line"> a    |    0</span><br><span class="line"> b    |    1</span><br><span class="line"> d    |    2</span><br><span class="line"> c    |    2</span><br><span class="line"> e    |    3</span><br><span class="line"> e    |    3</span><br><span class="line">(6 rows)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">step | WorkingTable</span><br><span class="line">init | {a}</span><br><span class="line">1    | {b}</span><br><span class="line">2    | {c, d}</span><br><span class="line">3    | {e, e}</span><br><span class="line">4    | {}</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h4 id="å›¾è¢«æ›´æ”¹-å†æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹"><a href="#å›¾è¢«æ›´æ”¹-å†æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹" class="headerlink" title="å›¾è¢«æ›´æ”¹, å†æ±‚ä»aå¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹"></a>å›¾è¢«æ›´æ”¹, å†æ±‚ä»<code>a</code>å¼€å§‹æ¯ä¸€æ­¥èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹</h4><p>å›¾ä¸­æˆ‘ä»¬å¤šåŠ äº†ä¸€ä¸ª<code>('c', 'b')</code>çš„è¾¹ã€‚åº”ç”¨SQL Standardä¸­çš„<code>WorkingTable</code>è¡¨è¾¾:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> edges (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">   <span class="keyword">values</span></span><br><span class="line">          (<span class="string">'a'</span>, <span class="string">'b'</span>), (<span class="string">'b'</span>, <span class="string">'c'</span>), (<span class="string">'b'</span>, <span class="string">'d'</span>),</span><br><span class="line">          (<span class="string">'c'</span>, <span class="string">'e'</span>), (<span class="string">'d'</span>, <span class="string">'e'</span>), (<span class="string">'c'</span>, <span class="string">'b'</span>)</span><br><span class="line">), discovered (node, step) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="string">'a'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> edges.to_, discovered.step + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> edges, discovered</span><br><span class="line">    <span class="keyword">where</span> discovered.node = edges.from_ <span class="keyword">and</span> step &lt; <span class="number">6</span></span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> discovered;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> node | step </span><br><span class="line"><span class="comment">------+------</span></span><br><span class="line"> a    |    0</span><br><span class="line"> b    |    1</span><br><span class="line"> c    |    2</span><br><span class="line"> d    |    2</span><br><span class="line"> e    |    3</span><br><span class="line"> e    |    3</span><br><span class="line"> b    |    3</span><br><span class="line"> c    |    4</span><br><span class="line"> d    |    4</span><br><span class="line"> e    |    5</span><br><span class="line"> e    |    5</span><br><span class="line"> b    |    5</span><br><span class="line"> c    |    6</span><br><span class="line"> d    |    6</span><br><span class="line">(14 rows)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">step | WorkingTable</span><br><span class="line">init | {a}</span><br><span class="line">1    | {b}</span><br><span class="line">2    | {c, d}</span><br><span class="line">3    | {e, e, b}</span><br><span class="line">4    | {c, d}</span><br><span class="line">5    | {e, e, b}</span><br><span class="line">6    | {c, d}</span><br></pre></td></tr></tbody></table></figure>
<p>ç”±äºè¿™æ¡å¤šåŠ çš„è¾¹ï¼Œè®©<code>union all</code>å¯¹åº”çš„å¾ªç¯ä¸€ç›´ä¸ç»ˆæ­¢ï¼Œå³<code>WorkingTable</code>ä¸€ç›´ä¸ä¸ºç©ºã€‚æ‰€æœ‰æˆ‘åœ¨ä¸Šé¢å¤šåŠ äº†<code>step &lt; 6</code>è¿™ä¸ªæ¡ä»¶ï¼Œå¼ºåˆ¶ï¼–æ­¥ä»¥åç»ˆæ­¢ã€‚å½“ç„¶å¦‚æœæ¢ç”¨<code>union</code>å¯ä»¥è®©å®ƒç»ˆæ­¢ã€‚</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Graph</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Recursion</tag>
        <tag>Graph</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(3)</title>
    <url>/2020/03/26/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-3/</url>
    <content><![CDATA[<h1 id="å›¾è®º"><a href="#å›¾è®º" class="headerlink" title="å›¾è®º"></a>å›¾è®º</h1><p>åœ¨è¿™ç¯‡æ–‡ç« é«˜çº§ SQL ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢å›¾è®ºçš„é¢˜ç›®ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†(å›¾)éƒ½åœ¨æ–‡ç« ä¸­çš„SQLä¸­ã€‚</p>
<a id="more"></a>
<h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p>ä¸€ä¸ªå›¾è®ºçš„ä¾‹å­ï¼š</p>
<p><img data-src="/images/SQL/dag.png" alt="dag.png"></p>
<p><strong>å¦‚æœæˆ‘ä»¬æ— è§†å›¾ä¸­çš„ç®­å¤´</strong>ï¼Œé‚£ä¹ˆè¿™ä¸ªå›¾æ˜¯ä¸€ä¸ª<strong>æœ‰å‘æ— ç¯å›¾(DAG, directed acyclic graph)</strong>ã€‚</p>
<p><br></p>
<h3 id="è§†ä½œæœ‰å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity"><a href="#è§†ä½œæœ‰å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity" class="headerlink" title="è§†ä½œæœ‰å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):"></a>è§†ä½œæœ‰å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), transitive_closure (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> transitive_closure c, graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> transitive_closure</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure>
<p>è¾“å‡º:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | b</span><br><span class="line"> a     | c</span><br><span class="line"> a     | d</span><br><span class="line"> a     | e</span><br><span class="line"> b     | c</span><br><span class="line"> b     | d</span><br><span class="line"> b     | e</span><br><span class="line"> c     | d</span><br><span class="line"> f     | c</span><br><span class="line"> f     | d</span><br><span class="line"> x     | y</span><br><span class="line">(11 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h3 id="è¡¨è¾¾æˆæ— å‘å›¾ï¼š"><a href="#è¡¨è¾¾æˆæ— å‘å›¾ï¼š" class="headerlink" title="è¡¨è¾¾æˆæ— å‘å›¾ï¼š"></a>è¡¨è¾¾æˆæ— å‘å›¾ï¼š</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- æ— å‘å›¾</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> un_dir_graph</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure>
<p>è¾“å‡º:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | b</span><br><span class="line"> b     | a</span><br><span class="line"> b     | c</span><br><span class="line"> b     | e</span><br><span class="line"> c     | b</span><br><span class="line"> c     | d</span><br><span class="line"> c     | f</span><br><span class="line"> d     | c</span><br><span class="line"> e     | b</span><br><span class="line"> f     | c</span><br><span class="line"> x     | y</span><br><span class="line"> y     | x</span><br><span class="line">(12 rows)</span><br></pre></td></tr></tbody></table></figure>
<p>å¾ˆå®¹æ˜“å‘ç°<code>un_dir_graph</code>æ˜¯ä¸€ä¸ªå¯¹ç§°çš„å…³ç³»(symmetric relation): </p>
<script type="math/tex; mode=display">\exists (a , b) \in R \Rightarrow (b, a) \in R</script><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>un_dir_graph</code>é€’å½’çš„æ—¶å€™ï¼Œã€€ç”¨<code>UNION ALL</code>æ˜¯è‚¯å®šä¸ä¼šç»ˆæ­¢çš„ï¼Œå› ä¸º<code>UNION ALL</code>é‡‡ç”¨åŒ…è¯­ä¹‰(Bag Semantics)ï¼Œå®ƒä¸ä¼šæ¶ˆé™¤é‡å¤(duplicates)ã€‚<br>è€Œ<code>UNION</code>é‡‡ç”¨é›†åˆè¯­ä¹‰(Set Semantics)ï¼Œå®ƒä¼šæ¶ˆé™¤é‡å¤ã€‚</p>
<p><br></p>
<h3 id="è§†ä½œæ— å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity"><a href="#è§†ä½œæ— å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…-Transitive-closure-ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹-Connectivity" class="headerlink" title="è§†ä½œæ— å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):"></a>è§†ä½œæ— å‘å›¾ï¼Œå¯»æ‰¾ä¼ é€’é—­åŒ…(Transitive closure)ï¼Œå³è¿™ä¸ªå›¾ä¸­èŠ‚ç‚¹çš„è”é€šèŠ‚ç‚¹(Connectivity):</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- æ— å‘å›¾</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">), clo (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> un_dir_graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> clo c, un_dir_graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> clo</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure>
<p>è¾“å‡º:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | a</span><br><span class="line"> a     | b</span><br><span class="line"> a     | c</span><br><span class="line"> a     | d</span><br><span class="line"> a     | e</span><br><span class="line"> a     | f</span><br><span class="line"> b     | a</span><br><span class="line"> b     | b</span><br><span class="line"> b     | c</span><br><span class="line"> b     | d</span><br><span class="line"> b     | e</span><br><span class="line"> b     | f</span><br><span class="line"> c     | a</span><br><span class="line"> c     | b</span><br><span class="line"> c     | c</span><br><span class="line"> c     | d</span><br><span class="line"> c     | e</span><br><span class="line"> c     | f</span><br><span class="line"> d     | a</span><br><span class="line"> d     | b</span><br><span class="line"> d     | c</span><br><span class="line"> d     | d</span><br><span class="line"> d     | e</span><br><span class="line"> d     | f</span><br><span class="line"> e     | a</span><br><span class="line"> e     | b</span><br><span class="line"> e     | c</span><br><span class="line"> e     | d</span><br><span class="line"> e     | e</span><br><span class="line"> e     | f</span><br><span class="line"> f     | a</span><br><span class="line"> f     | b</span><br><span class="line"> f     | c</span><br><span class="line"> f     | d</span><br><span class="line"> f     | e</span><br><span class="line"> f     | f</span><br><span class="line"> x     | x</span><br><span class="line"> x     | y</span><br><span class="line"> y     | x</span><br><span class="line"> y     | y</span><br><span class="line">(40 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¦ä¸€ç§è§£æ³•:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- æ— å‘å›¾</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">), closure (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> un_dir_graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> closure c, graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">), connected_graph (from_ ,to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> to_ , from_</span><br><span class="line">    <span class="keyword">from</span> closure)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_ , cg.to_</span><br><span class="line">    <span class="keyword">from</span> closure c, connected_graph cg</span><br><span class="line">    <span class="keyword">where</span> c.to_ = cg.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> connected_graph</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> from_, to_;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>è¿™é‡Œå¿…é¡»è§£é‡Šä¸€ä¸‹<code>closure</code>æ‰€å½¢æˆçš„è¡¨æ ¼ï¼Œå®ƒå³ä¸æ˜¯å¯¹åº”æœ‰å‘å›¾çš„ä¼ é€’é—­åŒ…(transitive_closure)ï¼Œä¹Ÿä¸æ˜¯å¯¹åº”æ— å‘å›¾çš„ä¼ é€’é—­åŒ…(transitive_closure)ã€‚å®ƒæ˜¯æˆ‘ä»¬æ±‚æ— å‘å›¾ä¼ é€’é—­åŒ…çš„ä¸€ä¸ªä¸­é—´æ­¥éª¤, å®ƒä»£è¡¨çš„è·¯å¾„æ˜¯:</p>
<ul>
<li>ç¬¬ä¸€æ­¥æ¥è‡ªäºæ— å‘å›¾</li>
<li>å¦‚æœæœ‰åç»­çš„æ­¥éª¤ï¼Œé‚£ä¹ˆåç»­çš„æ­¥éª¤æ¥è‡ªäºæœ‰å‘å›¾ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯å®ƒçš„å†…å®¹ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"> from_ | to_ </span><br><span class="line"><span class="comment">-------+-----</span></span><br><span class="line"> a     | b</span><br><span class="line"> a     | c</span><br><span class="line"> a     | d</span><br><span class="line"> a     | e</span><br><span class="line"> b     | a</span><br><span class="line"> b     | b</span><br><span class="line"> b     | c</span><br><span class="line"> b     | d</span><br><span class="line"> b     | e</span><br><span class="line"> c     | b</span><br><span class="line"> c     | c</span><br><span class="line"> c     | d</span><br><span class="line"> c     | e</span><br><span class="line"> c     | f</span><br><span class="line"> d     | c</span><br><span class="line"> d     | d</span><br><span class="line"> e     | b</span><br><span class="line"> e     | c</span><br><span class="line"> e     | d</span><br><span class="line"> e     | e</span><br><span class="line"> f     | c</span><br><span class="line"> f     | d</span><br><span class="line"> x     | y</span><br><span class="line"> y     | x</span><br><span class="line"> y     | y</span><br><span class="line">(25 rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>(b, b)</code>åœ¨é‡Œé¢ï¼Œå› ä¸ºç¬¬ä¸€æ­¥<code>(b, a)</code>å±äºæ— å‘å›¾ï¼Œç¬¬äºŒæ­¥<code>(a, b)</code>å±äºæœ‰å‘å›¾ã€‚</li>
<li><code>(c, a)</code>ä¸åœ¨é‡Œé¢ï¼Œå› ä¸ºå³ä½¿ç¬¬ä¸€æ­¥<code>(c, b)</code>å±äºæ— å‘å›¾ï¼Œä½†æ˜¯ç¬¬äºŒæ­¥<code>(b, a)</code>ä¸å±äºæœ‰å‘å›¾ã€‚</li>
</ul>
<p><br></p>
<h3 id="æ±‚ä»bä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š"><a href="#æ±‚ä»bä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š" class="headerlink" title="æ±‚ä»bä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š"></a>æ±‚ä»<code>b</code>ä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- Basic relation</span></span><br><span class="line">    <span class="keyword">values</span> (<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'c'</span> ,<span class="string">'d'</span>),</span><br><span class="line">           (<span class="string">'b'</span>, <span class="string">'e'</span>),</span><br><span class="line">           (<span class="string">'f'</span>, <span class="string">'c'</span>),</span><br><span class="line">           (<span class="string">'x'</span>, <span class="string">'y'</span>) <span class="comment">-- ç¬¬äºŒä¸ªè”é€šéƒ¨åˆ†</span></span><br><span class="line">), un_dir_graph (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- æ— å‘å›¾</span></span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    (<span class="keyword">select</span> to_, from_</span><br><span class="line">    <span class="keyword">from</span> graph)</span><br><span class="line">), clo (from_, to_) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> from_, to_</span><br><span class="line">    <span class="keyword">from</span> un_dir_graph)</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    (<span class="keyword">select</span> c.from_, g.to_</span><br><span class="line">    <span class="keyword">from</span> clo c, un_dir_graph g</span><br><span class="line">    <span class="keyword">where</span> c.to_ = g.from_)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> clo</span><br><span class="line"><span class="keyword">where</span> from_ = <span class="string">'b'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> to_;</span><br></pre></td></tr></tbody></table></figure>
<p>å½“ç„¶çœ‹å›¾çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°<code>b</code>å¯ä»¥åˆ°è¾¾ä¸Šé¢é‚£ä¸ªè¿é€šå›¾ä¸­æ‰€æœ‰çš„6ä¸ªèŠ‚ç‚¹ã€‚</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Graph</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Recursion</tag>
        <tag>Graph</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-å»å…³è”(2)</title>
    <url>/2020/03/25/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-2/</url>
    <content><![CDATA[<p>è¿™ç¯‡æ–‡ç« ç»§<a href="https://cakebytheoceanluo.github.io/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/">[SQL]é«˜çº§SQL-å»å…³è”(1)</a>åï¼Œç»§ç»­å¯¹å»å…³è”è¿™ä¸ªä¸»é¢˜è¿›è¡Œç»ƒä¹ ã€‚</p>
<a id="more"></a>
<h1 id="TPC-Hä¾‹å­ä¸€"><a href="#TPC-Hä¾‹å­ä¸€" class="headerlink" title="TPC-Hä¾‹å­ä¸€"></a>TPC-Hä¾‹å­ä¸€</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">l_extendedprice &gt; (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(l2.l_extendedprice)</span><br><span class="line">    <span class="keyword">from</span> lineitem l2</span><br><span class="line">    <span class="keyword">where</span> l2.l_orderkey = l1.l_orderkey</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p><code>l1.l_orderkey</code>æ˜¯è¿™ä¸ªå­æŸ¥è¯¢(Sub-Query)ä¸­æ¥è‡ªå¤–æŸ¥è¯¢çš„å­—æ®µï¼Œä¹Ÿå°±æ˜¯å®ƒé€ æˆäº†è¿™ä¸ªä¾èµ–(dependency)ã€‚</p>
<p>å¾ˆå®¹æ˜“å¯ä»¥å‘ç°ï¼š</p>
<ul>
<li>å¯¹æ¯ä¸€ä¸ªå­æŸ¥è¯¢çš„<code>lineitem l2</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>l2.l_orderkey</code>å­—æ®µå€¼ä¾èµ–äºå¤–ç•Œ<code>lineitem l1</code>çš„å¯¹åº”<code>l1.l_orderkey</code>å­—æ®µå€¼ã€‚</li>
<li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>l2.l_orderkey = l1.l_orderkey</code></li>
<li>$D$æ˜¯<code>l1.l_orderkey</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚<strong>è¿™é‡Œè¿™ä¸ªå¤–ä¾èµ–æ¡ä»¶æ²¡æœ‰æ„ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨<code>lineitem</code>è¡¨æ ¼ä¸­è®¡ç®—å¹³å‡å€¼, è€Œçœå»regular joinè·å¾—é«˜æ€§èƒ½ã€‚</strong></p>
<h2 id="å»é™¤joinçš„ç»“æœ"><a href="#å»é™¤joinçš„ç»“æœ" class="headerlink" title="å»é™¤joinçš„ç»“æœ"></a>å»é™¤joinçš„ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l,</span><br><span class="line">     (<span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice) <span class="keyword">as</span> avgPrice, </span><br><span class="line">             l_orderkey</span><br><span class="line">      <span class="keyword">from</span> lineitem</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> l_orderkey) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_extendedprice &gt; precomputed.avgPrice <span class="keyword">and</span> </span><br><span class="line">    l.l_orderkey = precomputed.l_orderkey;</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice) <span class="keyword">as</span> avgPrice, </span><br><span class="line">           l_orderkey</span><br><span class="line">    <span class="keyword">from</span> lineitem</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> l_orderkey)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l,</span><br><span class="line">     precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    l_extendedprice &gt; precomputed.avgPrice</span><br><span class="line">    <span class="keyword">and</span> l.l_orderkey = precomputed.l_orderkey;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="TPC-Hä¾‹å­äºŒ"><a href="#TPC-Hä¾‹å­äºŒ" class="headerlink" title="TPC-Hä¾‹å­äºŒ"></a>TPC-Hä¾‹å­äºŒ</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        orders o1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        o_totalprice &lt; (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">                <span class="keyword">avg</span>(o_totalprice)</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">                orders o2</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">                o2.o_shippriority = o1.o_shippriority <span class="keyword">or</span></span><br><span class="line">                o2.o_orderstatus = o1.o_orderstatus)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å¾ˆå®¹æ˜“å¯ä»¥å‘ç°ï¼š</p>
<ul>
<li>å¯¹æ¯ä¸€ä¸ª<code>orders o2</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>o2.o_shippriority</code>å’Œ<code>o2.o_orderstatus</code>å­—æ®µå€¼ä¾èµ–å¤–ç•Œ<code>order o1</code>çš„å¯¹åº”å­—æ®µå€¼ã€‚</li>
<li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>o2.o_shippriority = o1.o_shippriority or o2.o_orderstatus = o1.o_orderstatus</code></li>
<li>$D$æ˜¯<code>o1.o_shippriority, o1.o_orderstatus</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚</p>
<h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        orders o1,</span><br><span class="line">        (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">                <span class="keyword">avg</span>(o2.o_totalprice), d.o_shippriority, d.o_orderstatus</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">                orders o2, </span><br><span class="line">                (<span class="keyword">select</span> <span class="keyword">distinct</span> o_shippriority , o_orderstatus <span class="keyword">from</span> orders) d</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">                o2.o_shippriority = d.o_shippriority <span class="keyword">or</span></span><br><span class="line">                o2.o_orderstatus = d.o_orderstatus</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> d.o_shippriority, d.o_orderstatus</span><br><span class="line">        ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        o_totalprice &lt; precomputed.avg <span class="keyword">and</span></span><br><span class="line">        precomputed.o_shippriority = o1.o_shippriority <span class="keyword">and</span></span><br><span class="line">        precomputed.o_orderstatus = o1.o_orderstatus</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">            <span class="keyword">avg</span>(o2.o_totalprice), d.o_shippriority, d.o_orderstatus</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">            orders o2, </span><br><span class="line">            (<span class="keyword">select</span> <span class="keyword">distinct</span> o_shippriority , o_orderstatus <span class="keyword">from</span> orders) d</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">            o2.o_shippriority = d.o_shippriority <span class="keyword">or</span></span><br><span class="line">            o2.o_orderstatus = d.o_orderstatus</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> d.o_shippriority, d.o_orderstatus</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        orders o1, precomputed</span><br><span class="line">        </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        o_totalprice &lt; precomputed.avg <span class="keyword">and</span></span><br><span class="line">        precomputed.o_shippriority = o1.o_shippriority <span class="keyword">and</span></span><br><span class="line">        precomputed.o_orderstatus = o1.o_orderstatus</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="TPC-Hä¾‹å­ä¸‰"><a href="#TPC-Hä¾‹å­ä¸‰" class="headerlink" title="TPC-Hä¾‹å­ä¸‰"></a>TPC-Hä¾‹å­ä¸‰</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span> </span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span><span class="keyword">and</span> </span><br><span class="line">    <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            *</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            lineitem</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            l_orderkey = o_orderkey <span class="keyword">and</span> </span><br><span class="line">            l_commitdate &lt; l_receiptdate</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å¾ˆå®¹æ˜“å¯ä»¥å‘ç°ï¼š</p>
<ul>
<li>å¯¹æ¯ä¸€ä¸ª<code>lineitem</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>l_orderkey</code>å­—æ®µå€¼ä¾èµ–å¤–ç•Œ<code>order</code>çš„å¯¹åº”å­—æ®µå€¼ã€‚</li>
<li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>l_orderkey = o_orderkey</code></li>
<li>$D$æ˜¯<code>order.o_orderkey</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚</p>
<h2 id="ç»“æœ-1"><a href="#ç»“æœ-1" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders,(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem,</span><br><span class="line">        (<span class="keyword">select</span> <span class="keyword">distinct</span> o_orderkey <span class="keyword">from</span> orders) <span class="keyword">as</span> o</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_orderkey = o_orderkey <span class="keyword">and</span> </span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        o_orderkey</span><br><span class="line">    ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.o_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        o_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem,</span><br><span class="line">        (<span class="keyword">select</span> <span class="keyword">distinct</span> o_orderkey <span class="keyword">from</span> orders) <span class="keyword">as</span> o</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_orderkey = o_orderkey <span class="keyword">and</span> </span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        o_orderkey</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders,</span><br><span class="line">    precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.o_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å»é™¤joinçš„ç»“æœ-1"><a href="#å»é™¤joinçš„ç»“æœ-1" class="headerlink" title="ã€€å»é™¤joinçš„ç»“æœ"></a>ã€€å»é™¤joinçš„ç»“æœ</h2><p><strong>è¿™é‡Œè¿™ä¸ªå¤–ä¾èµ–æ¡ä»¶æ²¡æœ‰æ„ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨<code>lineitem</code>è¡¨æ ¼ä¸­è·å¾—<code>l_orderkey</code>(å®ƒæ˜¯<code>o_orderkey</code>çš„å¤–é”®), è€Œçœå»regular joinè·å¾—é«˜æ€§èƒ½ã€‚</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders,(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        l_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        l_orderkey</span><br><span class="line">    ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.l_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        l_orderkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        lineitem</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        l_commitdate &lt; l_receiptdate</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        l_orderkey</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    o_orderpriority,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> order_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    orders, precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    o_orderdate &gt;= <span class="built_in">date</span> <span class="string">'1993-07-01'</span> <span class="keyword">and</span></span><br><span class="line">    o_orderdate &lt; <span class="built_in">date</span> <span class="string">'1993-10-01'</span> <span class="keyword">and</span></span><br><span class="line">    precomputed.l_orderkey = orders.o_orderkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> o_orderpriority</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_orderpriority;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è®ºæ–‡ä¸­çš„Q2"><a href="#è®ºæ–‡ä¸­çš„Q2" class="headerlink" title="è®ºæ–‡ä¸­çš„Q2"></a>è®ºæ–‡ä¸­çš„Q2</h1><p>è¿™ä¸ªQ2ä¸å¯¹åº”ä»»ä½•æˆ‘å·²çŸ¥çš„æ•°æ®é›†ï¼Œåªæ˜¯åœ¨è®ºæ–‡ä¸­é€»è¾‘æ€§åœ°è¢«æå‡ºã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name , e.course</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    students s,</span><br><span class="line">    exams e</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    s.id = e.sid <span class="keyword">and</span></span><br><span class="line">    (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>)</span><br><span class="line"><span class="keyword">and</span> e.grade &gt;= (</span><br><span class="line">    <span class="comment">-- one grade worse</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        <span class="keyword">avg</span> (e2.grade) + <span class="number">1</span></span><br><span class="line">    <span class="comment">-- than the average grade</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        exams e2</span><br><span class="line">    <span class="comment">-- of exams taken by</span></span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        s.id = e2.sid <span class="keyword">or</span></span><br><span class="line">        <span class="comment">-- him / her or taken by elder peers</span></span><br><span class="line">        (e2.curriculum = s.major <span class="keyword">and</span> s.year &gt; e2.date))</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å¾ˆå®¹æ˜“å¯ä»¥å‘ç°ï¼š</p>
<ul>
<li>å¯¹æ¯ä¸€ä¸ª<code>exams e2</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>e2.sid, e2.curriculum, e2.data</code>å­—æ®µå€¼ä¾èµ–å¤–ç•Œ<code>student s</code>çš„å¯¹åº”å­—æ®µå€¼ã€‚</li>
<li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>s.id = e2.sid or (e2.curriculum = s.major and s.year &gt; e2.date))</code></li>
<li>$D$æ˜¯<code>s.id, s.major, s.year</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚</p>
<h2 id="ç»“æœ-2"><a href="#ç»“æœ-2" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    students s,</span><br><span class="line">    exams e, (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> students s, exams e</span><br><span class="line">        <span class="keyword">where</span> s.id = e.sid <span class="keyword">and</span> (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>)</span><br><span class="line">     ) <span class="keyword">as</span> l, (</span><br><span class="line">         <span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">year</span>, major </span><br><span class="line">         <span class="keyword">from</span> l</span><br><span class="line">     ) <span class="keyword">as</span> d, (</span><br><span class="line">         <span class="keyword">select</span> d.id, d.year, d.major, <span class="keyword">avg</span>(e2.grade) <span class="keyword">as</span> m</span><br><span class="line">         <span class="keyword">from</span> d, exam e2</span><br><span class="line">         <span class="keyword">where</span> d.id = e2.sid <span class="keyword">or</span> (d.year &gt; e2.year <span class="keyword">and</span> e2.curriculum = d.major)</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> d.id, d.year, d.major</span><br><span class="line">     ) <span class="keyword">as</span> d_</span><br><span class="line"><span class="keyword">where</span> e.grade &gt; m + <span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">      d_.id = s.id <span class="keyword">and</span> </span><br><span class="line">      d_.year = e.date <span class="keyword">and</span> </span><br><span class="line">      e.curriculum = d_.major;</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> l <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> students s, exams e</span><br><span class="line">        <span class="keyword">where</span> s.id = e.sid <span class="keyword">and</span> (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>)</span><br><span class="line">),</span><br><span class="line">d <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">year</span>, major</span><br><span class="line">         <span class="keyword">from</span> l</span><br><span class="line">     ),</span><br><span class="line">d_ <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> d.id, d.year, d.major, <span class="keyword">avg</span>(e2.grade) <span class="keyword">as</span> m</span><br><span class="line">         <span class="keyword">from</span> d, exam e2</span><br><span class="line">         <span class="keyword">where</span> d.id = e2.sid <span class="keyword">or</span> (d.year &gt; e2.year <span class="keyword">and</span> e2.curriculum = d.major)</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> d.id, d.year, d.major</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span> l, d_</span><br><span class="line"><span class="keyword">where</span> e.grade &gt; m + <span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">         d_.id = l.id <span class="keyword">and</span></span><br><span class="line">         d_.year = l.year <span class="keyword">and</span></span><br><span class="line">         d_.major = l.curriculum;</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    students s,</span><br><span class="line">    exams e, (</span><br><span class="line">         <span class="keyword">select</span> s2.id, s2.year, s2.major, <span class="keyword">avg</span>(e2.grade) <span class="keyword">as</span> m</span><br><span class="line">         <span class="keyword">from</span> exam e2,</span><br><span class="line">              (<span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">year</span>, major <span class="keyword">from</span> students) <span class="keyword">as</span> s2</span><br><span class="line">         <span class="keyword">where</span></span><br><span class="line">               s2.id = e2.sid</span><br><span class="line">               <span class="keyword">or</span> (s2.year &gt; e2.year <span class="keyword">and</span> e2.curriculum = s2.major)</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> s2.id, s2.year, s2.major</span><br><span class="line">     ) <span class="keyword">as</span> preagg</span><br><span class="line"><span class="keyword">where</span> s.id = e.sid <span class="keyword">and</span></span><br><span class="line">      (s.major = <span class="string">'CS'</span> <span class="keyword">or</span> s. major = <span class="string">'Games Eng'</span>) <span class="keyword">and</span></span><br><span class="line">      s.id = preagg.id <span class="keyword">and</span> </span><br><span class="line">      s.major = preagg.major <span class="keyword">and</span></span><br><span class="line">      s.year = preagg.year <span class="keyword">and</span></span><br><span class="line">      e.grade &gt; m + <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨: </p>
<p>1: TUM Foundation of Data Engineering Chap3.Advanced SQL: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<p>2.<span class="exturl" data-url="aHR0cHM6Ly9kbC5naS5kZS9iaXRzdHJlYW0vaGFuZGxlLzIwLjUwMC4xMjExNi8yNDE4LzM4My5wZGY/c2VxdWVuY2U9MQ==" title="https://dl.gi.de/bitstream/handle/20.500.12116/2418/383.pdf?sequence=1">Unnesting Arbitrary Queries - Thomas Neumann and Alfons Kemper - (BTW 2015)<i class="fa fa-external-link"></i></span></p>
<p>3.<a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Query Optimizer</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Query Optimizer</tag>
        <tag>Subquery Optimization</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-å»å…³è”(1)</title>
    <url>/2020/03/24/SQL-%E9%AB%98%E7%BA%A7SQL-%E5%8E%BB%E5%85%B3%E8%81%94-1/</url>
    <content><![CDATA[<p>æˆ‘ä»¬åœ¨ä¸€ç¯‡è®ºæ–‡è§£è¯»æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">[Paper]BTW 2015 | Unnesting Arbitrary Queries</a>ä¸­æåˆ°äº†å»å…³è”, åœ¨è¿™ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å¯¹è¿™ä¸ªä¸»é¢˜è¿›è¡Œ<strong>ç»ƒä¹ </strong>ã€‚</p>
<p>è¿™ä¸ªä¸»é¢˜å…¶å®è¿œæ¯”å¤§å®¶æƒ³è±¡ä¸­çš„è¦å®ç”¨: å¯¹äº1GiBå¤§å°å·¦å³çš„æ•°æ®é›†ï¼ŒSQLæŸ¥è¯¢å¦‚æœæ‹¥æœ‰$O(n^2)$çš„æ—¶é—´å¤æ‚åº¦ï¼ŒåŸºæœ¬å¯ä»¥åˆ¤æ–­å¾ˆæ…¢ï¼Œæˆ–è€…æ…¢åˆ°æ— å®é™…æ„ä¹‰ã€‚å¾€å¾€æˆ‘ä»¬ä½¿ç”¨çš„å„ç§å¤§åé¼é¼çš„å¼€æºæ•°æ®åº“å’Œå•†ç”¨æ•°æ®åº“ä¸ä¸€å®šæ”¯æŒUnnestingè¿™ä¸ªfeature(å…·ä½“çš„æ”¯æŒåœ¨å„ä¸ªæ•°æ®åº“çš„Documentä¸­æè¿°ï¼Œåœ¨å¯¹åº”çš„è®ºæ–‡ä¸­çš„Motivationéƒ¨åˆ†ä¹Ÿæœ‰ç®€å•æåˆ°)ã€‚è¿™å°±æ„å‘³ç€, æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æˆä¸ºQuery Optimizerå»ä¼˜åŒ–æˆ‘ä»¬SQLçš„æ—¶é—´å¤æ‚åº¦ã€‚ </p>
<a id="more"></a>
<h1 id="Correlated-Sub-Query-vs-Uncorrelated-Sub-Query"><a href="#Correlated-Sub-Query-vs-Uncorrelated-Sub-Query" class="headerlink" title="Correlated Sub-Query vs. Uncorrelated Sub-Query"></a>Correlated Sub-Query vs. Uncorrelated Sub-Query</h1><p>ä¸€èˆ¬æ¥è¯´ï¼Œcorrelated sub-query(å…³è”å­query)çš„æ—¶é—´å¤æ‚åº¦ä¼šæ¯”uncorrelated sub-query(æ— å…³è”å­query)å¤§ã€‚</p>
<p>å½“ç„¶è¿™éƒ¨åˆ†çš„å‰ææ˜¯ï¼šquery optimizer(ä¼˜åŒ–å™¨)ä¸å¯¹SQLçš„logical planè¿›è¡Œä¼˜åŒ–ã€‚<br>è€Œä¸€äº›ä¼˜ç§€çš„æ•°æ®åº“<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbmRleC5odG1sIw==" title="https://hyper-db.de/index.html#">HyPer<i class="fa fa-external-link"></i></span>å·²ç»æŠŠè¿™ä¸ªé—®é¢˜ç”¨query optimizerè§£å†³äº†ï¼Œå®ƒä¼šä¸»åŠ¨å»ä¼˜åŒ–ï¼Œæ¯”å¦‚å¯ä»¥<strong>å»å…³è”</strong>ã€‚</p>
<p>æ›´å¤šçš„å¯ä»¥çœ‹è¿™ä¸€ç¯‡è®ºæ–‡<span class="exturl" data-url="aHR0cDovL3d3dy5idHctMjAxNS5kZS9yZXMvcHJvY2VlZGluZ3MvSGF1cHRiYW5kL1dpc3MvTmV1bWFubi1Vbm5lc3RpbmdfQXJiaXRyYXJ5X1F1ZXJpZS5wZGY=" title="http://www.btw-2015.de/res/proceedings/Hauptband/Wiss/Neumann-Unnesting_Arbitrary_Querie.pdf">Unnesting Arbitrary Queries, Thomas Neumann and Alfons Kemper, Technische Universitat MÃ¼nchen<i class="fa fa-external-link"></i></span></p>
<h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä¼šä½¿ç”¨å¦‚ä¸‹çš„æ•°æ®é›†:</p>
<ul>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#TUM-Uni%E6%95%B0%E6%8D%AE%E9%9B%86">TUM Uni æ•°æ®é›†</a></li>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#TPC-H">TPC-H æ•°æ®é›†</a></li>
</ul>
<p>å…·ä½“çš„æ•°æ®é›†å®‰è£…è§ä¸Šé¢çš„å¯¹åº”çš„é“¾æ¥ã€‚å¦å¤–æœ‰ä¸€äº›SQLå¹¶ä¸å¯¹åº”ä»»ä½•æ•°æ®é›†, åªæ˜¯åœ¨è®ºæ–‡ä¸­é€»è¾‘æ€§åœ°è¢«æå‡ºå’Œä½¿ç”¨ï¼Œè¿™æ ·çš„SQLæˆ‘ä¼šç‰¹åˆ«æ³¨æ˜: <strong>ä¸å¯¹åº”æ•°æ®é›†</strong>ã€‚</p>
<hr>
<h1 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h1><h2 id="ä½¿ç”¨maxä»£æ›¿exists-æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”æ‰€æœ‰æ•™æˆæ—©çš„å­¦ç”Ÿ"><a href="#ä½¿ç”¨maxä»£æ›¿exists-æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”æ‰€æœ‰æ•™æˆæ—©çš„å­¦ç”Ÿ" class="headerlink" title="ä½¿ç”¨maxä»£æ›¿exists: æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”æ‰€æœ‰æ•™æˆæ—©çš„å­¦ç”Ÿ"></a>ä½¿ç”¨<code>max</code>ä»£æ›¿<code>exists</code>: æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”æ‰€æœ‰æ•™æˆæ—©çš„å­¦ç”Ÿ</h2><p>è¿™ä¸ªQueryéœ€è¦çš„å±æ€§å€¼(gebdatumã€€å‡ºç”Ÿæ—¥æœŸ)æ²¡æœ‰è¢«å†™å…¥æ•°æ®é›†ã€‚<br>æ‰€ä»¥ä¸èƒ½è¿è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹ç€ç†è§£æ„æ€ã€‚</p>
<ul>
<li>correlated sub-query</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> p.*</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">    <span class="keyword">where</span> p.gebdatum &gt; s.gebdatumm</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹æ¯ä¸€ä¸ªstudenten séƒ½éœ€è¦çœ‹æ•´ä¸ªprofessorenè¡¨æ ¼ã€‚<br>è¿™ä¸ªæƒ…å†µå¾ˆç±»ä¼¼cross product(é›†åˆçš„å‰ä¹˜)ã€‚è¿™ä¸ªsubqueryéœ€è¦è¢«æ‰§è¡Œ<code>|studenten|</code>æ¬¡ã€‚</p>
<p>å¦‚æœquery optimizer(ä¼˜åŒ–å™¨)ä¸å¯¹è¿™ä¸ªSQLçš„logical planè¿›è¡Œä¼˜åŒ–çš„è¯ï¼Œé‚£å®ƒçš„runtime complexity(æ—¶é—´å¤æ‚åº¦)æ˜¯<code>O(|studenten| * |professoren|)</code>ï¼Œç±»æ¨åˆ°<code>O(n^2)</code>ã€‚</p>
<p><br></p>
<ul>
<li>uncorrelated Sub-query</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> s.gebdatum &lt; (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">max</span>(gebdatum)</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™æ ·è¿™ä¸ªsubqueryåªéœ€ä¸€æ¬¡è¢«materialized(materializationï¼Œç‰©è´¨åŒ–ï¼Œå®ä¾‹åŒ–)ï¼Œä¹Ÿå°±æ˜¯åªéœ€è¦è¢«æ‰§è¡Œä¸€æ¬¡å¾—åˆ°è¿™ä¸ª<code>max</code>ã€‚ç„¶ååœ¨å»çœ‹<code>studenten</code>ä¸­çš„æ¯ä¸€ä¸ªäººå»å’Œè¿™ä¸ª<code>max</code>æ¯”è¾ƒã€‚è¿™æ ·è‚¯å®šä¼šæ›´åŠ æœ‰æ•ˆç‡ã€‚å®ƒçš„runtime complexityæ˜¯$O(|\mathrm{studenten}| ï¼‹ |\mathrm{professoren}|)$ï¼Œç±»æ¨åˆ° $O(n)$ã€‚</p>
<p><br></p>
<h2 id="ä½¿ç”¨joinä»£æ›¿subquery-æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”å¯¹åº”æ•™æˆæ—©çš„åŠ©æ‰‹-åŠ©æ‰‹éœ€è¦åœ¨å¯¹åº”æ•™æˆæ‰‹ä¸‹å·¥ä½œ"><a href="#ä½¿ç”¨joinä»£æ›¿subquery-æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”å¯¹åº”æ•™æˆæ—©çš„åŠ©æ‰‹-åŠ©æ‰‹éœ€è¦åœ¨å¯¹åº”æ•™æˆæ‰‹ä¸‹å·¥ä½œ" class="headerlink" title="ä½¿ç”¨joinä»£æ›¿subquery: æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”å¯¹åº”æ•™æˆæ—©çš„åŠ©æ‰‹(åŠ©æ‰‹éœ€è¦åœ¨å¯¹åº”æ•™æˆæ‰‹ä¸‹å·¥ä½œ)"></a>ä½¿ç”¨joinä»£æ›¿subquery: æœç´¢å‡ºç”Ÿæ—¥æœŸæ¯”å¯¹åº”æ•™æˆæ—©çš„åŠ©æ‰‹(åŠ©æ‰‹éœ€è¦åœ¨å¯¹åº”æ•™æˆæ‰‹ä¸‹å·¥ä½œ)</h2><ul>
<li>correlated sub-query:</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a.*</span><br><span class="line"><span class="keyword">from</span> assistenten a</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> p.*</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">    <span class="keyword">where</span> a.boss = p.persnr <span class="keyword">and</span> p.gebdatum &gt; a.gebdatum</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>unnested query(å»åµŒå¥—):</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a.*</span><br><span class="line"><span class="keyword">from</span> assistenten a, professoren p</span><br><span class="line"><span class="keyword">where</span> a.boss = p.persnr <span class="keyword">and</span> p.gebdatum &gt; a.gebdatum</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™æ—¶å€™æˆ‘ä»¬ç›´æ¥ç”¨<code>join</code>æ¥å¯¹åŸcorrelated sub-queryå»åµŒå¥—ã€‚é‡‡ç”¨<code>join</code>åŸå› ä¹‹ä¸€æ˜¯ï¼šè¿™æ—¶å€™ä¸éœ€è¦å’Œæ‰€æœ‰professorenè¿›è¡Œæ¯”è¾ƒï¼Œåªéœ€è¦å’Œå¯¹åº”çš„ä¸€ä¸ªprofessoræ¯”è¾ƒã€‚</p>
<p><br></p>
<hr>
<h1 id="æ™®éä½œæ³•"><a href="#æ™®éä½œæ³•" class="headerlink" title="æ™®éä½œæ³•"></a>æ™®éä½œæ³•</h1><p>æˆ‘ä»¬è¿™é‡Œç»™å‡ºä¸€ä¸ªæ™®éçš„ä½œæ³•ï¼Œä½†æ˜¯ä¸ç™¾åˆ†ä¹‹ç™¾å’ŒåŸè®ºæ–‡çš„æƒ³æ³•å¥‘åˆã€‚å…·ä½“ä½œæ³•æœ€å¥½å‚è€ƒåŸè®ºæ–‡ï¼š</p>
<p>ä¸‹é¢è¿™ä¸ªå¾ˆæ˜æ˜¾æ˜¯ä¸€ä¸ªå…³è”çš„æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢ä¸­éœ€è¦å¤–ç•Œ<code>r1</code>çš„<code>attr1</code>, <code>attr2</code>ã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ...</span><br><span class="line"><span class="keyword">from</span> r1, </span><br><span class="line"><span class="keyword">where</span> ... </span><br><span class="line">(</span><br><span class="line">        <span class="keyword">select</span> ...</span><br><span class="line">        <span class="keyword">from</span> r2</span><br><span class="line">        <span class="keyword">where</span> r1.attr1 = ... <span class="keyword">and</span> r1.attr2 = ...</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±å°†è¿™ä¸ªå­æŸ¥è¯¢ç»™æŠ½ç¦»å‡ºæ¥åˆ°<code>from</code>ä¸‹é¢æˆ–è€…<code>with</code>é‡Œé¢ï¼Œæå‰ç”¨ä¸å…³è”çš„æ–¹å¼ç‰©ç†åŒ–å®ƒçš„ç»“æœï¼Œè€Œä¸æ˜¯ä¹‹åè¿›è¡Œä½æ•ˆçš„ç¬›å¡å°”ç§¯ã€‚<br>å¦‚æœæˆ‘ä»¬æƒ³ç”¨ä¸å…³è”çš„æ–¹å¼ç‰©ç†åŒ–å­æŸ¥è¯¢çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥éœ€è¦<code>r1</code>è¿™ä¸ªè¡¨æ ¼çš„å¦å¤–ä¸€ä»½å¤åˆ¶å“ï¼Œä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦<code>r1</code>ä¸­å’Œjoinç›¸å…³çš„å­—æ®µå€¼ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ...</span><br><span class="line"><span class="keyword">from</span> r1, </span><br><span class="line">       (</span><br><span class="line">        <span class="keyword">select</span> d.attr1, d.attr2 <span class="comment">-- æœ‰å¯èƒ½è¿˜æœ‰å…¶ä»–èšåˆå‡½æ•°</span></span><br><span class="line">        <span class="keyword">from</span> r2,</span><br><span class="line">             (<span class="keyword">select</span> <span class="keyword">distinct</span> r1.attr1, r1.attr2 <span class="keyword">from</span> r1) <span class="keyword">as</span> d</span><br><span class="line">        <span class="keyword">where</span> d.attr1 = ... <span class="keyword">and</span> d.attr2 = ...</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> d.attr1, d.attr2</span><br><span class="line">        ) <span class="keyword">as</span> precomputed</span><br><span class="line"><span class="keyword">where</span> ... </span><br><span class="line">        precomputed.attr1 = r1.attr1 <span class="keyword">and</span></span><br><span class="line">        precomputed.attr2 = r1.attr1</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="TPC-Hä¾‹å­ä¸€-1"><a href="#TPC-Hä¾‹å­ä¸€-1" class="headerlink" title="TPC-Hä¾‹å­ä¸€ 1"></a>TPC-Hä¾‹å­ä¸€ <sup><a href="#fn1">1</a></sup></h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l1</span><br><span class="line"><span class="keyword">where</span> l_extendedprice =</span><br><span class="line">   (<span class="keyword">select</span> <span class="keyword">min</span>(l_extendedprice)</span><br><span class="line">    <span class="keyword">from</span> lineitem l2</span><br><span class="line">    <span class="keyword">where</span> l1.l_orderkey = l2.l_orderkey);</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(l_extendedprice)</span><br><span class="line"><span class="keyword">from</span> lineitem l1,</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">min</span>(l_extendedprice) m, l_orderkey</span><br><span class="line">    <span class="keyword">from</span> lineitem</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> l_orderkey) l2</span><br><span class="line"><span class="keyword">where</span> l1.l_orderkey = l2.l_orderkey</span><br><span class="line"><span class="keyword">and</span> l_extendedprice = l2.m;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å¯¹<code>l2</code>è¿›è¡Œä¸€æ¬¡æ±‚å€¼ã€‚</li>
</ul>
<p><br></p>
<h1 id="TPC-Hä¾‹å­äºŒ-1"><a href="#TPC-Hä¾‹å­äºŒ-1" class="headerlink" title="TPC-Hä¾‹å­äºŒ 1"></a>TPC-Hä¾‹å­äºŒ <sup><a href="#fn1">1</a></sup></h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c1.c_name</span><br><span class="line"><span class="keyword">from</span> customer c1</span><br><span class="line"><span class="keyword">where</span> c1.c_mktsegment = <span class="string">'AUTOMOBILE'</span> </span><br><span class="line">      <span class="keyword">or</span> c1.c_acctbal &gt;</span><br><span class="line">                        (<span class="keyword">select</span> <span class="keyword">avg</span>(c2.c_acctbal)</span><br><span class="line">                        <span class="keyword">from</span> customer c2</span><br><span class="line">                        <span class="keyword">where</span> c2.c_mktsegment = c1.c_mktsegment);</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ç»“æœ-1"><a href="#ç»“æœ-1" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c1.c_name</span><br><span class="line"><span class="keyword">from</span> customer c1, (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(c.c_acctbal) <span class="keyword">as</span> <span class="keyword">avg</span>, c_mktsegment</span><br><span class="line">    <span class="keyword">from</span> customer c</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_mktsegment</span><br><span class="line">    ) <span class="keyword">as</span> c2</span><br><span class="line"><span class="keyword">where</span> (c1.c_mktsegment = <span class="string">'AUTOMOBILE'</span></span><br><span class="line">      <span class="keyword">or</span> c1.c_acctbal &gt; c2.avg)</span><br><span class="line">      <span class="keyword">and</span> c1.c_mktsegment = c2.c_mktsegment</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> c2 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(c.c_acctbal) <span class="keyword">as</span> <span class="keyword">avg</span>, c_mktsegment</span><br><span class="line">    <span class="keyword">from</span> customer c</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> c_mktsegment</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> c1.c_name</span><br><span class="line"><span class="keyword">from</span> customer c1, c2</span><br><span class="line"><span class="keyword">where</span> (c1.c_mktsegment = <span class="string">'AUTOMOBILE'</span></span><br><span class="line">      <span class="keyword">or</span> c1.c_acctbal &gt; c2.avg)</span><br><span class="line">      <span class="keyword">and</span> c1.c_mktsegment = c2.c_mktsegment</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="TPC-H-Q17-ä¾‹å­"><a href="#TPC-H-Q17-ä¾‹å­" class="headerlink" title="TPC-H Q17 ä¾‹å­"></a>TPC-H Q17 ä¾‹å­</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- TPC-H Query 17</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">        <span class="keyword">sum</span>(l_extendedprice) / <span class="number">7.0</span> <span class="keyword">as</span> avg_yearly</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        lineitem,</span><br><span class="line">        part</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        p_partkey = l_partkey</span><br><span class="line">        <span class="keyword">and</span> p_brand = <span class="string">'Brand#23'</span></span><br><span class="line">        <span class="keyword">and</span> p_container = <span class="string">'MED BOX'</span></span><br><span class="line">        <span class="keyword">and</span> l_quantity &lt; (</span><br><span class="line">                <span class="keyword">select</span></span><br><span class="line">                        <span class="number">0.2</span> * <span class="keyword">avg</span>(l_quantity)</span><br><span class="line">                <span class="keyword">from</span></span><br><span class="line">                        lineitem</span><br><span class="line">                <span class="keyword">where</span></span><br><span class="line">                        l_partkey = p_partkey</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å¾ˆæ¸…æ™°ï¼Œå…³è”(nested, correlated)çš„éƒ¨åˆ†å¦‚ä¸‹ï¼š<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">...</span><br><span class="line">from</span><br><span class="line">        lineitem,</span><br><span class="line">        part</span><br><span class="line">...</span><br><span class="line">        and l_quantity &lt; (</span><br><span class="line">                <span class="keyword">select</span></span><br><span class="line">                        <span class="number">0.2</span> * <span class="keyword">avg</span>(l_quantity)</span><br><span class="line">                <span class="keyword">from</span></span><br><span class="line">                        lineitem</span><br><span class="line">                <span class="keyword">where</span></span><br><span class="line">                        l_partkey = p_partkey</span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>p_partkey</code>æ˜¯è¿™ä¸ªå­æŸ¥è¯¢(Sub-Query)ä¸­æ¥è‡ªå¤–æŸ¥è¯¢çš„å­—æ®µï¼Œä¹Ÿå°±æ˜¯å®ƒé€ æˆäº†è¿™ä¸ªä¾èµ–(dependency)ã€‚</p>
<p>æˆ‘ä»¬ç”¨æ–‡å­—å»æè¿°ä¸€ä¸‹è¿™ä¸ªå…³è”éƒ¨åˆ†:  </p>
<ul>
<li>å¯¹æ¯ä¸€ä¸ªå­æŸ¥è¯¢çš„<code>lineitem</code>çš„å…ƒç»„ï¼Œéœ€è¦å®ƒçš„<code>l_partkey</code>å­—æ®µå€¼ä¾èµ–äºå¤–ç•Œ<code>part</code>çš„å¯¹åº”<code>p_partkey</code>å­—æ®µå€¼ã€‚</li>
<li>å¤–ä¾èµ–æ¡ä»¶æŒ‡ï¼š<code>l_partkey = p_partkey</code></li>
<li>$D$æ˜¯<code>part.p_partkey</code>å¯¹åº”å­—æ®µå€¼çš„é›†åˆã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å®Œå…¨æŠ½ç¦»è¿™ä¸ªå…³è”éƒ¨åˆ†åˆ°å¦å¤–ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼ï¼Œå†ç”¨<strong>å¤–ä¾èµ–æ¡ä»¶</strong>å’Œå®ƒregular joinã€‚</p>
<h2 id="ç»“æœ-2"><a href="#ç»“æœ-2" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        <span class="keyword">sum</span> (l_extendedprice) / <span class="number">7.0</span> <span class="keyword">as</span> avg_yearly</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        lineitem l,</span><br><span class="line">        part,</span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">select</span></span><br><span class="line">                    <span class="number">0.2</span> * <span class="keyword">avg</span> (l_quantity) <span class="keyword">avg</span>, l_partkey</span><br><span class="line">            <span class="keyword">from</span></span><br><span class="line">                    lineitem</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                    l_partkey</span><br><span class="line">        ) quaprecomputednt</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        p_partkey = l. l_partkey</span><br><span class="line">        <span class="keyword">and</span> p_brand = <span class="string">'Brand #23'</span></span><br><span class="line">        <span class="keyword">and</span> p_container = <span class="string">'MED BOX'</span></span><br><span class="line">        <span class="keyword">and</span> precomputed.l_partkey = p_partkey  <span class="comment">-- ä½¿ç”¨å¤–ä¾èµ–æ¡ä»¶çš„regular join</span></span><br><span class="line">        <span class="keyword">and</span> l_quantity &lt; precomputed.avg       <span class="comment">-- å»é™¤åŸä¾èµ–</span></span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> precomputed <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">            <span class="number">0.2</span> * <span class="keyword">avg</span> (l_quantity) <span class="keyword">avg</span> , l_partkey</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">            lineitem</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            l_partkey</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">        <span class="keyword">sum</span> (l_extendedprice) / <span class="number">7.0</span> <span class="keyword">as</span> avg_yearly</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">        lineitem l,</span><br><span class="line">        part,</span><br><span class="line">        precomputed</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">        p_partkey = l. l_partkey</span><br><span class="line">        <span class="keyword">and</span> p_brand = <span class="string">'Brand #23'</span></span><br><span class="line">        <span class="keyword">and</span> p_container = <span class="string">'MED BOX'</span></span><br><span class="line">        <span class="keyword">and</span> precomputed.l_partkey = p_partkey  <span class="comment">-- ä½¿ç”¨å¤–ä¾èµ–æ¡ä»¶çš„regular join</span></span><br><span class="line">        <span class="keyword">and</span> l_quantity &lt; precomputed.avg       <span class="comment">-- å»é™¤åŸä¾èµ–</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨: </p>
<p><a name="fn1">1</a>: TUM Foundation of Data Engineering Chap3.Advanced SQL: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2ZvdW5kYXRpb25zZGUvY2hhcHRlcjMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de">https://db.in.tum.de/teaching/ws1920/foundationsde/chapter3.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<p>2.<span class="exturl" data-url="aHR0cHM6Ly9kbC5naS5kZS9iaXRzdHJlYW0vaGFuZGxlLzIwLjUwMC4xMjExNi8yNDE4LzM4My5wZGY/c2VxdWVuY2U9MQ==" title="https://dl.gi.de/bitstream/handle/20.500.12116/2418/383.pdf?sequence=1">Unnesting Arbitrary Queries - Thomas Neumann and Alfons Kemper - (BTW 2015)<i class="fa fa-external-link"></i></span></p>
<p>3.<a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Query Optimizer</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Query Optimizer</tag>
        <tag>Subquery Optimization</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]ä¸­çº§SQL(5)</title>
    <url>/2020/03/22/SQL-%E4%B8%AD%E7%BA%A7SQL-5/</url>
    <content><![CDATA[<h1 id="TPC-H-æ•°æ®é›†"><a href="#TPC-H-æ•°æ®é›†" class="headerlink" title="TPC-H æ•°æ®é›†"></a>TPC-H æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br><code>TPC-H</code>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p><strong>æœ¬åœ°è½½å…¥æ”¹æ•°æ®é›†</strong>çš„æ–¹æ³•è§æˆ‘çš„åšå®¢ä¸¤ç¯‡æ–‡ç« :</p>
<ul>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥ TPC-H æ•°æ®é›†</a></li>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†</a></li>
</ul>
<a id="more"></a>
<h1 id="ä¸­çº§SQL"><a href="#ä¸­çº§SQL" class="headerlink" title="ä¸­çº§SQL"></a>ä¸­çº§SQL</h1><p>è¿™ä¸€ç¯‡æ–‡ç« å…¶å®ç›®çš„æ˜¯ç”¨ç®€å•çš„SQLå»ç†Ÿæ‚‰TPC-Hè¿™ä¸ªæ•°æ®é›†ï¼Œå› ä¸ºè¿™ä¸ªæ•°æ®é›†ä¼šåœ¨<strong>é«˜çº§SQL</strong>éƒ¨åˆ†ä¸€ç›´è¢«ä½¿ç”¨ã€‚</p>
<ul>
<li>æœ‰å¤šå°‘customeræ‹¥æœ‰orderï¼Œè€Œè¿™ä¸ªorderçš„commentå«æœ‰â€packagesâ€è¿™ä¸ªå•è¯ï¼Ÿ</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> c_custkey)</span><br><span class="line"><span class="keyword">from</span> customer, orders</span><br><span class="line"><span class="keyword">where</span> c_custkey = o_custkey <span class="keyword">and</span> o_comment <span class="keyword">like</span> <span class="string">'%packages%'</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> o_custkey)</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">where</span> o_comment <span class="keyword">like</span> <span class="string">'%packages%'</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ±‚<code>l_orderkey</code>çš„æ•°å­—æ•°é‡çš„å¹³å‡å€¼(<code>char_length()</code>å‡½æ•°)ï¼š<ul>
<li><code>l_orderkey::text</code>å’Œ<code>l_orderkey || ''</code>éƒ½å¯ä»¥ä½¿intå˜æˆstring<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(<span class="keyword">char_length</span>(l_orderkey || <span class="string">''</span>))</span><br><span class="line"><span class="keyword">from</span> lineitem;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span> (<span class="keyword">char_length</span>(l_orderkey::<span class="built_in">text</span>))</span><br><span class="line"><span class="keyword">from</span> lineitem ;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>æ±‚æ‰€æœ‰<code>customer</code>å’Œæ‰€æœ‰<code>supplier</code>çš„åå­—ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c_name</span><br><span class="line"><span class="keyword">from</span> customer</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> s_name</span><br><span class="line"><span class="keyword">from</span> supplier</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>è¯»å–10ä¸ªcustomerså¯¹åº”çš„nationï¼Œç”¨JSONçš„å½¢å¼å»è¡¨è¾¾<code>custkey, name, nation</code>ï¼š</p>
</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'{" custkey ": '</span> || c_custkey || <span class="string">', " name ":" '</span> || c_name || <span class="string">'", " nation ":{" nationkey ": '</span> || n_nationkey || <span class="string">', " name ":" '</span> || n_name || <span class="string">' "}} '</span> <span class="keyword">as</span> custjson</span><br><span class="line"><span class="keyword">from</span> customer , nation</span><br><span class="line"><span class="keyword">where</span> c_nationkey = n_nationkey <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">                                                  custjson                                                  </span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> {" custkey ": 86, " name ":" Customer#000000086", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 80, " name ":" Customer#000000080", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 76, " name ":" Customer#000000076", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 73, " name ":" Customer#000000073", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 48, " name ":" Customer#000000048", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 29, " name ":" Customer#000000029", " nation ":{" nationkey ": 0, " name ":" ALGERIA "}} </span><br><span class="line"> {" custkey ": 144, " name ":" Customer#000000144", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line"> {" custkey ": 141, " name ":" Customer#000000141", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line"> {" custkey ": 106, " name ":" Customer#000000106", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line"> {" custkey ": 59, " name ":" Customer#000000059", " nation ":{" nationkey ": 1, " name ":" ARGENTINA "}} </span><br><span class="line">(10 rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>German Supplieråœ¨1995å¹´å‘äº†å¤šå°‘lineitem?</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(lineitem)</span><br><span class="line"><span class="keyword">from</span> supplier, nation, lineitem</span><br><span class="line"><span class="keyword">where</span> n_name = <span class="string">'GERMANY'</span> <span class="keyword">and</span> n_nationkey = s_nationkey <span class="keyword">and</span> s_suppkey = l_suppkey <span class="keyword">and</span> <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> l_shipdate) = <span class="number">1995</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(lineitem)</span><br><span class="line"><span class="keyword">from</span> supplier, nation, lineitem</span><br><span class="line"><span class="keyword">where</span> n_name = <span class="string">'GERMANY'</span> <span class="keyword">and</span> n_nationkey = s_nationkey <span class="keyword">and</span> s_suppkey = l_suppkey <span class="keyword">and</span> l_shipdate <span class="keyword">between</span> <span class="string">'1995-01-01'</span> <span class="keyword">and</span> <span class="string">'1995-12-31'</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢EUROPEåœ¨FURNITUREã€€market segmentä¸­æœ€é«˜account balanceçš„åä¸ªcustomers:</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c_name, c_acctbal</span><br><span class="line"><span class="keyword">from</span> customer, nation, region</span><br><span class="line"><span class="keyword">where</span> r_name = <span class="string">'EUROPE'</span> <span class="keyword">and</span> r_regionkey = n_regionkey <span class="keyword">and</span> n_nationkey = c_nationkey <span class="keyword">and</span> c_mktsegment = <span class="string">'FURNITURE'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c_acctbal <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>How many orders do customer have?</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c_custkey, <span class="keyword">count</span>(o_orderkey) <span class="keyword">as</span> o_count</span><br><span class="line"><span class="keyword">from</span> customer <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders <span class="keyword">on</span> c_custkey = o_custkey</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_custkey</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> o_count <span class="keyword">desc</span>, c_custkey <span class="keyword">asc</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ul>
<li><code>sum(l_extendedprice * (1 - l_discount))</code>: revenue</li>
<li>å¾—åˆ°å¹´ä»½çš„ä¾‹å­ï¼š<code>extract(year from l_shipdate) = 1995</code></li>
<li><code>c_mktsegment</code>: market segment</li>
<li><code>c_acctbal</code>: account balance</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>TPC-H</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]Lec07 Tree Indexes Part I - æ ‘ç´¢å¼• I</title>
    <url>/2020/03/19/CMU-15445-Lec07/</url>
    <content><![CDATA[<p>Tree Indexes Part I - æ ‘ç´¢å¼• I</p>
<p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA3LXRyZWVzMS5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/07-trees1.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDctdHJlZXMxLnBkZg==" title="https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/07-trees1.pdf<i class="fa fa-external-link"></i></span><br>Readings:  Chapter 11.1-11.4</p>
<p>Database Tree Indexes åœ¨CMUåˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œåœ¨ä¸¤èŠ‚è¯¾ä¸­è®²ã€‚è¿™æ˜¯ç¬¬ä¸€éƒ¨åˆ†ã€‚</p>
<p>è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“çš„ä¸­ä½¿ç”¨çš„B+æ ‘ï¼Œå®ƒæ•°æ®åº“æœ€é‡è¦çš„æ•°æ®ç»“æ„ã€‚å‡ åå¹´æ¥ï¼Œæ•°æ®åº“çš„å½¢å¼å’ŒæŠ€æœ¯å˜åŒ–å¾ˆå¤§ï¼Œä½†æ˜¯å§‹ç»ˆåšæŒåœ¨ä½¿ç”¨B+æ ‘ä»¥åŠå®ƒçš„å˜å½¢ã€‚</p>
<a id="more"></a>
<p><img data-src="/images/CMU1544564/Lec07/1.jpg" alt="1.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/3.jpg" alt="3.jpg"></p>
<ul>
<li>ä¸Šå›¾æˆ‘ä»¬åœ¨å‰ä¸€ç¯‡æ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/18/CMU-15445-Lec06/#Data-Structure-in-DBMS">[CMU-15445] Lec06 Hash Tables - å“ˆå¸Œè¡¨ - Data Structure in DBMS</a>ä¸­å·²ç»è®¨è®ºè¿‡ã€‚æˆ‘ä»¬ç°åœ¨ä»£å…¥hash tableå’Œtreeå†çœ‹çœ‹è¿™ä¸€é¡µã€‚</li>
<li>å‰ä¸‰ç‚¹ä¸­hash tableå¯ä»¥è¢«åº”ç”¨ï¼ŒåŒæ—¶æ•ˆæœä¸é”™ã€‚ä½†æ˜¯åœ¨<strong>table indexes</strong>ä¸­treeæ›´å¥½ï¼Œä»¥è‡³äºå„ä¸ªDBMSé»˜è®¤çš„table indexéƒ½æ˜¯treeã€‚å…·ä½“treeå“ªé‡Œå¥½ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™å‡ èŠ‚è¯¾ä¸­å…·ä½“è®¨è®ºã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec07/4.jpg" alt="4.jpg"></p>
<ul>
<li>ä»ä¸Šå›¾ä¸­:</li>
<li>indexç´¢å¼•ä¸¥æ ¼ä¸Šè¯´ä¸æ˜¯å¿…é¡»ï¼Œå®ƒçš„æ˜¯ä¸€ä¸ªèµ·åˆ°æé€Ÿæœç´¢çš„æ•°æ®ç»“æ„ã€‚å¦‚æœæ²¡æœ‰å®ƒï¼Œé‚£å°±linear sequential scanå»æ‰¾æƒ³è¦çš„tupleï¼Œ $O(n)$</li>
<li>indexç´¢å¼•å…¶å®å°†åŸè¡¨æ ¼å†…å®¹å­˜å‚¨åœ¨æ•°æ®ç»“æ„ä¸­ï¼Œå› æ­¤å®ƒä¹Ÿé‡å¤(replica)äº†ä¸€éƒ¨åˆ†åŸè¡¨æ ¼çš„å†…å®¹ã€‚å¦‚æœæˆ‘ä»¬å¯¹åŸè¡¨æ ¼è¿›è¡Œæ›´æ–°(å†™æ“ä½œ)ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦å¯¹indexè¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œ<strong>è®©åŸè¡¨æ ¼å’ŒindexåŒæ­¥</strong>ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec07/5.jpg" alt="5.jpg"></p>
<ul>
<li>ä»ä¸Šå›¾ä¸­:</li>
<li>indexçš„å­˜åœ¨ä¼šå¸¦æ¥:</li>
<li>Storage Overhead: indexé‡å¤äº†ä¸€éƒ¨åˆ†åŸè¡¨æ ¼å†…å®¹ï¼Œindexè¿™ä¸ªæ•°æ®ç»“æ„è¦å ä¸€å—å­˜å‚¨ã€‚å¸¸å¸¸éœ€è¦å¤šä¸ªpageï¼Œä¸èƒ½ä¿è¯å…¨éƒ¨åœ¨å†…å­˜ä¸Šã€‚</li>
<li>Maintenance Overhead: å¦‚æœæˆ‘ä»¬å¯¹åŸè¡¨æ ¼è¿›è¡Œæ›´æ–°(å†™æ“ä½œ)ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦å¯¹indexè¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œ<strong>è®©åŸè¡¨æ ¼å’ŒindexåŒæ­¥</strong>ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec07/6.jpg" alt="6.jpg"></p>
<h1 id="B-Tree-Family"><a href="#B-Tree-Family" class="headerlink" title="B-Tree Family"></a>B-Tree Family</h1><p><img data-src="/images/CMU1544564/Lec07/7.jpg" alt="7.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/8.jpg" alt="8.jpg"></p>
<ul>
<li>Efficient locking for concurrent operations on B-trees: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzMxOTYyOC4zMTk2NjM=" title="https://dl.acm.org/doi/10.1145/319628.319663">https://dl.acm.org/doi/10.1145/319628.319663<i class="fa fa-external-link"></i></span></li>
</ul>
<h1 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B+ Tree"></a>B+ Tree</h1><p><img data-src="/images/CMU1544564/Lec07/9.jpg" alt="9.jpg"></p>
<ul>
<li>Ubiquitous B-Tree: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzM1Njc3MC4zNTY3NzY=" title="https://dl.acm.org/doi/10.1145/356770.356776">https://dl.acm.org/doi/10.1145/356770.356776<i class="fa fa-external-link"></i></span></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec07/10.jpg" alt="10.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/11.jpg" alt="11.jpg"></p>
<ul>
<li>ä»ä¸Šå›¾ä¸­:</li>
<li>leaf node: æŒ‡æœ€ä¸‹é¢ä¸€å±‚çš„èŠ‚ç‚¹</li>
<li>inner node: æŒ‡éleaf nodeçš„èŠ‚ç‚¹</li>
<li>sibling pointer: æŒ‡æ‹¥æœ‰åŒä¸€ä¸ªçˆ¶äº²çš„leaf node</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec07/12.jpg" alt="12.jpg"></p>
<ul>
<li>ä»ä¸Šå›¾ä¸­:</li>
<li>inner node: ç”±<code>node*</code>å’Œ<code>key</code>ç»„æˆ</li>
<li>leaf node: ç”±<code>value</code>å’Œ<code>key</code>ç»„æˆ</li>
</ul>
<h2 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h2><p><img data-src="/images/CMU1544564/Lec07/13.jpg" alt="13.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/15.jpg" alt="15.jpg"></p>
<ul>
<li>ä»ä¸Šå›¾ä¸­:</li>
<li><code>prev</code>å’Œ<code>next</code>æ˜¯ä¸¤ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘sibling node</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec07/16.jpg" alt="16.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/18.jpg" alt="18.jpg"></p>
<ul>
<li>ä»ä¸Šå›¾æ˜¯å®é™…å®ç°ä¸­ï¼ŒB+ Treeçš„æ ·å­</li>
<li><code>sortd keys</code>æ’åˆ—åœ¨ä¸€å—å„¿ã€‚å› ä¸ºscançš„æ—¶å€™ï¼Œåªæ˜¯æ£€æŸ¥<code>key</code>ã€‚å¦å¤–<code>key</code>çš„æ•°æ®ç±»å‹å¤§å°ä¸€è‡´,ã€€<code>values</code>å¤§å°å¾ˆå¯èƒ½ä¸ä¸€è‡´ï¼Œå¦‚å­—ç¬¦ä¸²ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec07/19.jpg" alt="19.jpg"></p>
<h2 id="B-Tree-vs-B-Tree"><a href="#B-Tree-vs-B-Tree" class="headerlink" title="B Tree vs. B+ Tree"></a>B Tree vs. B+ Tree</h2><p><img data-src="/images/CMU1544564/Lec07/20.jpg" alt="20.jpg"></p>
<ul>
<li>ä»ä¸Šå›¾ä¸­:</li>
<li>B Treeä¸­æ˜¯æ²¡æœ‰é‡å¤çš„ï¼Œ<code>key</code>è¢«å­˜å‚¨åœ¨inner nodeå’Œleaf nodeä¹‹é—´</li>
<li>B+ Treeä¸­æ˜¯æœ‰é‡å¤çš„ï¼Œ<code>key</code>åªè¢«å­˜å‚¨åœ¨leaf nodeä¸­</li>
<li><code>key</code>çš„å­˜å‚¨åœ°ç‚¹ä¸æ­¢å½±å“æ ‘çš„æ ·å­ï¼Œæ›´å½±å“å¤šçº¿ç¨‹æ›´æ”¹æ ‘ä¿¡æ¯çš„æ€§èƒ½ã€‚B+ Treeçš„<code>key</code>ä¿¡æ¯åªåœ¨leaf nodeä¸­ï¼Œæ›´æ”¹ä¿¡æ¯ä»¥ååªéœ€è¦å‘ä¸Šèµ°ï¼Œå› æ­¤åªéœ€è¦latchä¸€ä¸ªå‘ä¸Šçš„æ–¹å‘ã€‚ä½†æ˜¯B Treeéœ€è¦latchä¸¤ä¸ªæ–¹å‘ï¼Œå³å‘ä¸Šå’Œå‘ä¸‹ã€‚è¿™ä¸ªæˆ‘ä»¬ä¼šåœ¨åä¸¤æ¬¡è¯¾ä¸­ä»”ç»†è®¨è®ºã€‚<!-- TODO:åä¸¤æ¬¡è¯¾ã€‚ -->
<!-- TODO: B Tree ä»‹ç» -->
</li>
</ul>
<h2 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h2><p><img data-src="/images/CMU1544564/Lec07/21.jpg" alt="21.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/22.jpg" alt="22.jpg"></p>
<ul>
<li>ä¸Šå›¾ä¸­çš„é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY3MudXNmY2EuZWR1L35nYWxsZXMvdmlzdWFsaXphdGlvbi9CUGx1c1RyZWUuaHRtbA==" title="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html<i class="fa fa-external-link"></i></span></li>
</ul>
<p>æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸‹ä½œä¸ºDemo:<br><code>insert 4; insert 2; insert 6; insert 1; insert 5;</code><br>å¾—åˆ°å¦‚ä¸‹çš„æ ‘:</p>
<p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec07/b+tree_insert.png" alt="B+Tree-Insert"></p>
<h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h2><p><img data-src="/images/CMU1544564/Lec07/23.jpg" alt="23.jpg"></p>
<ul>
<li>ä¸Šå›¾ä¸­çš„é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMzQ2LzIwMTUvbm90ZXMvQmxpbmsucHB0eA==" title="https://web.stanford.edu/class/cs346/2015/notes/Blink.pptx">https://web.stanford.edu/class/cs346/2015/notes/Blink.pptx<i class="fa fa-external-link"></i></span></li>
</ul>
<p>æˆ‘ä»¬å†ç»§ç»­åˆšåˆšçš„Demo:</p>
<p><code>delete 5; delete 4;</code><br>å¾—åˆ°å¦‚ä¸‹çš„æ ‘:</p>
<p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec07/b+tree_delete.png" alt="B+Tree-Delete"></p>
<h2 id="B-Tree-In-Practice"><a href="#B-Tree-In-Practice" class="headerlink" title="B+ Tree In Practice"></a>B+ Tree In Practice</h2><p><img data-src="/images/CMU1544564/Lec07/24.jpg" alt="24.jpg"></p>
<ul>
<li>ä»ä¸Šå›¾ä¸­:</li>
<li>Fill-Factoræ˜¯æŒ‡<code>leaf nodeçš„ä¸ªæ•° / æ‰€æœ‰ nodeçš„ä¸ªæ•°</code>æ¯”å€¼</li>
<li>å®é™…ä¸ŠB+æ ‘ä¸éœ€è¦ï¼•å±‚ä»¥ä¸Šã€‚</li>
</ul>
<h2 id="Clustered-Indexes"><a href="#Clustered-Indexes" class="headerlink" title="Clustered Indexes"></a>Clustered Indexes</h2><p><img data-src="/images/CMU1544564/Lec07/25.jpg" alt="25.jpg"></p>
<p>æŒ‡é¡µé¢åœ¨ç¡¬ç›˜å­˜å‚¨çš„é¡ºåºå’Œç´¢å¼•ä¸­æ’åºçš„é¡ºåºä¸€è‡´ï¼Œå³ä¹Ÿè¢«æ’åºï¼Œè€Œå¹¶éä»»æ„é¡ºåºã€‚è¿™ç§Clustered Indexesåœ¨å¯¹äºrange queryå¾ˆæœ‰å¸®åŠ©ã€‚range queryçš„ä¸€ä¸ªä¾‹å­æ˜¯è¦<code>primary key</code>åœ¨0åˆ°100çš„æ‰€æœ‰tupleã€‚å¯¹è¿™ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦5ä¸ªpageã€‚é‚£è¿™5ä¸ªpageåœ¨clustered indexä»¥åçš„ç¡¬ç›˜ä¸Šæ˜¯è¿ç»­çš„ï¼Œä¸€æ¬¡sequential I/Oå°±å¯ä»¥è§£å†³ã€‚å¦‚æœä¸ä½¿ç”¨clustered indexes, é‚£å°±å¯èƒ½å‡ºç°5æ¬¡random I/Oï¼Œå¯¹åº”çš„æ€§èƒ½å°±å¾ˆåƒåœ¾äº†ã€‚</p>
<!-- TODO:å®éªŒ -->
<h2 id="Selection-Conditions"><a href="#Selection-Conditions" class="headerlink" title="Selection Conditions"></a>Selection Conditions</h2><p>Selection Conditionsæ˜¯B+ treeçš„ä¼˜åŠ¿ï¼ŒæŒ‡æˆ‘ä»¬å¯ä»¥æœç´¢indexå¯¹åº”çš„search keyçš„prefixå‰ç¼€, suffixåç¼€, æˆ–è€…å…¶ä¸­çš„éƒ¨åˆ†ã€‚</p>
<p>è¿™æ˜¯hash tableæ— æ³•åšåˆ°çš„ï¼Œå®ƒåªèƒ½æœç´¢å®Œæ•´äº†search keyã€‚</p>
<p><img data-src="/images/CMU1544564/Lec07/26.jpg" alt="26.jpg"></p>
<h3 id="å‰ç¼€ä¾‹å­"><a href="#å‰ç¼€ä¾‹å­" class="headerlink" title="å‰ç¼€ä¾‹å­"></a>å‰ç¼€ä¾‹å­</h3><p>é€šè¿‡å‰ç¼€æˆ‘ä»¬å¯ä»¥çŸ¥é“æˆ‘ä»¬æƒ³è¦æ‰¾çš„tupleå‡ºç°åœ¨indexä¸­çš„åŒºé—´ï¼Œå³ä»å°äºæˆ‘ä»¬å‰ç¼€çš„ä½ç½®ï¼Œæ‰«æåˆ°å¤§äºæˆ‘ä»¬å‰ç¼€çš„ä½ç½®ã€‚ä¸‹é¢æ˜¯ä¸¤ä¸ªå‰ç¼€çš„ä¾‹å­:</p>
<p><img data-src="/images/CMU1544564/Lec07/27.jpg" alt="27.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/28.jpg" alt="28.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/29.jpg" alt="29.jpg"></p>
<h3 id="åç¼€ä¾‹å­"><a href="#åç¼€ä¾‹å­" class="headerlink" title="åç¼€ä¾‹å­"></a>åç¼€ä¾‹å­</h3><p>æˆ‘ä»¬ç¼ºå¤±ä¸€ä¸ªå‰ç¼€ï¼Œé‚£å°±å°†æ‰€æœ‰çš„å¯èƒ½éƒ½å¡«å…¥å‰ç¼€ã€‚è¿™æ ·ä¼šäº§ç”Ÿå¥½å‡ ä¸ªéœ€è¦æ‰«æçš„åŒºé—´ï¼Œè¿™äº›åŒºé—´çš„ä¸ªæ•°ç­‰äºæ‰€æœ‰å‰ç¼€å¯èƒ½çš„ä¸ªæ•°ã€‚å¦‚ä¸‹å›¾<code>*</code>å¯ä»¥æ˜¯A, B, Cã€€(ä¾‹å­ä¸­åˆå¹¶äº†åé¢ä¸¤ä¸ªåŒºé—´åˆ°ä¸€èµ·)ï¼š</p>
<p><img data-src="/images/CMU1544564/Lec07/30.jpg" alt="30.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/31.jpg" alt="31.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/32.jpg" alt="32.jpg"></p>
<p><br></p>
<h2 id="B-Tree-Design-Choices"><a href="#B-Tree-Design-Choices" class="headerlink" title="B+ Tree Design Choices"></a>B+ Tree Design Choices</h2><p><img data-src="/images/CMU1544564/Lec07/33.jpg" alt="33.jpg"></p>
<ul>
<li>ä¸Šå›¾ä¸­çš„é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xNTYxLzE5MDAwMDAwMjg=" title="https://dl.acm.org/doi/10.1561/1900000028">https://dl.acm.org/doi/10.1561/1900000028<i class="fa fa-external-link"></i></span></li>
<li>è¿™éƒ¨åˆ†éƒ½æ˜¯å®ç°çš„ç»éªŒä¹‹è°ˆ</li>
</ul>
<h3 id="Node-size"><a href="#Node-size" class="headerlink" title="Node size"></a>Node size</h3><p><img data-src="/images/CMU1544564/Lec07/34.jpg" alt="34.jpg"></p>
<ul>
<li>å¦‚ä¸Šå›¾ä¸­:</li>
<li>Nodeå¯ä»¥æ˜¯ä¸€ä¸ªpageï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªpage</li>
<li>åœ¨é€Ÿåº¦æ…¢çš„ç¡¬ä»¶ä¸Šçš„nodeçš„å®¹é‡å»ºè®®ä¼šæ›´å¤§ï¼Œè¿™æ ·å¯ä»¥å‡å°‘I/Oçš„æ¬¡æ•°</li>
<li>leaf node scan: æ¶‰åŠæ•°é‡å¾ˆå¤šçš„node, æ˜¯sequential I/O</li>
<li>root-to-leaf traversal: æ¶‰åŠæ•°é‡å¾ˆå°‘çš„node, ä½†æ˜¯æ˜¯random I/O, å› ä¸ºè¿™äº›pageå¾ˆå¤§æ¦‚ç‡ä¸å­˜å‚¨åœ¨ä¸€èµ·</li>
</ul>
<p><br></p>
<ul>
<li>å¦å¤–indexå’ŒåŸè¡¨æ ¼å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªbuffer pool:</li>
<li>index buffer page: 1 MiB</li>
<li>table data buffer page: 8 KiB</li>
</ul>
<h3 id="Merge-Threshold"><a href="#Merge-Threshold" class="headerlink" title="Merge Threshold"></a>Merge Threshold</h3><p><img data-src="/images/CMU1544564/Lec07/35.jpg" alt="35.jpg"></p>
<ul>
<li>å¦‚ä¸Šå›¾:</li>
<li>å¦‚æœä¸€ä¸ªnodeä¸­å…ƒç´ å°‘äº<code>M/2 - 1</code>ï¼Œå³æ²¡æœ‰half-full, å‘ç”Ÿunderflowã€‚æˆ‘ä»¬å¯ä»¥è®©è¿™ä¸ªnodeä¿å­˜å­˜åœ¨ï¼Œè€Œä¸å»mergeå®ƒã€‚ç„¶åæ¯ä¸€æ®µæ—¶é—´ï¼Œæ‰¹é‡å¤„ç†B+ treeä¸­æ‰€æœ‰è¿™ç±»çš„nodeã€‚</li>
</ul>
<h3 id="Variable-Length-Keys"><a href="#Variable-Length-Keys" class="headerlink" title="Variable Length Keys"></a>Variable Length Keys</h3><p><img data-src="/images/CMU1544564/Lec07/36.jpg" alt="36.jpg"></p>
<ul>
<li>å¦‚ä¸Šå›¾:</li>
<li>Approach 1: Pointersã€€å¤ªæ…¢</li>
<li>Approach 2: Variable Length Nodesä¸é€‚åˆfix size page</li>
<li>Approach 3: Padding å¤ªæµªè´¹ç©ºé—´</li>
<li>Approach 4: Key Map / Indirection æ€§èƒ½è¾ƒå¥½</li>
</ul>
<h4 id="Key-Map-Indirection"><a href="#Key-Map-Indirection" class="headerlink" title="Key Map / Indirection"></a>Key Map / Indirection</h4><p>è¿™ä¸ªå°±å’Œslotted pageç±»ä¼¼ï¼Œå°†vaiable lenght keyå­˜åœ¨åŒä¸€ä¸ªpageã€‚</p>
<p><img data-src="/images/CMU1544564/Lec07/38.jpg" alt="38.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/39.jpg" alt="39.jpg"></p>
<ul>
<li>å¦‚ä¸Šå›¾:</li>
<li>å¯ä»¥åœ¨<code>sorted key map</code>è¿™ä¸ªåŒºåŸŸå­˜ä¸€ä¸ª<strong>é¦–å­—æ¯</strong>ï¼Œè¿™æ ·å¯ä»¥å‡å°‘è·³åˆ°<code>key+values</code>åŒºåŸŸçš„æ¬¡æ•°ã€‚ä¸å¿…æ¯ä¸€ä¸ª<code>key</code>éƒ½å»çœ‹å®ƒçš„å…¨éƒ¨å†…å®¹ã€‚</li>
</ul>
<h3 id="Non-Unique-Indexes"><a href="#Non-Unique-Indexes" class="headerlink" title="Non-Unique Indexes"></a>Non-Unique Indexes</h3><p><img data-src="/images/CMU1544564/Lec07/40.jpg" alt="40.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/41.jpg" alt="41.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/42.jpg" alt="42.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/43.jpg" alt="43.jpg"></p>
<h3 id="Intra-Node-Search"><a href="#Intra-Node-Search" class="headerlink" title="Intra-Node Search"></a>Intra-Node Search</h3><p>Intra-Node SearchæŒ‡åœ¨nodeä¸­æœç´¢ï¼Œå¯ä»¥æƒ³è±¡æˆåœ¨pageä¸­é‚£äº›å·²ç»æ’åºå®Œçš„æ•°æ®ä¸­æœç´¢ï¼š</p>
<h4 id="Linear"><a href="#Linear" class="headerlink" title="Linear"></a>Linear</h4><p><img data-src="/images/CMU1544564/Lec07/44.jpg" alt="44.jpg"></p>
<h4 id="Binary-Search"><a href="#Binary-Search" class="headerlink" title="Binary Search"></a>Binary Search</h4><p><img data-src="/images/CMU1544564/Lec07/46.jpg" alt="46.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/47.jpg" alt="47.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/48.jpg" alt="48.jpg"></p>
<h4 id="Interpolation"><a href="#Interpolation" class="headerlink" title="Interpolation"></a>Interpolation</h4><p>InterpolationæŒ‡æ•°å­—çš„åˆ†å¸ƒå¦‚æœå·²çŸ¥ï¼Œå¯ä»¥ç›´æ¥çŒœåˆ°æƒ³æœçš„<code>key</code>çš„ä½ç½®ã€‚è¿™ä¸ªå±äºç‰¹ä¾‹ï¼Œè€Œä¸”ä¸é€‚ç”¨äºå­—ç¬¦ä¸²ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec07/49.jpg" alt="49.jpg"></p>
<p><br><br><br></p>
<h2 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h2><p><img data-src="/images/CMU1544564/Lec07/50.jpg" alt="50.jpg"></p>
<h3 id="Prefix-Compression"><a href="#Prefix-Compression" class="headerlink" title="Prefix Compression"></a>Prefix Compression</h3><p>Prefix Compressionå³å­—ç¬¦ä¸²å…±æœ‰çš„å‰ç¼€åªéœ€è¦å­˜å‚¨ä¸€æ¬¡ï¼Œèƒ½é«˜æ•ˆèŠ‚çœå‡ºå­˜å‚¨çš„ç©ºé—´ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é™ä½B+ Treeçš„é«˜åº¦ï¼ŒåŠ å¿«æœç´¢é€Ÿåº¦ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec07/51.jpg" alt="51.jpg"></p>
<h3 id="Suffix-Truncation"><a href="#Suffix-Truncation" class="headerlink" title="Suffix Truncation"></a>Suffix Truncation</h3><p>æˆ‘ä»¬åœ¨æœ€å¼€å§‹è¯´è¿‡leaf nodeèµ·åˆ°å­˜å‚¨ä¿¡æ¯çš„ä½œç”¨ï¼Œinner nodeèµ·åˆ°lookupä¸­å¯¼èˆªçš„ä½œç”¨ã€‚å¯¹äºå­—ç¬¦ä¸²ï¼Œinner nodeä¸­æ²¡æœ‰å¿…è¦ä¿å­˜å…¨éƒ¨ï¼Œåªéœ€è¦ä¿å­˜è¶³å¤Ÿçš„å‰ç¼€ï¼Œ<strong>ä¿è¯å¤§äºå°äºçš„å…³ç³»å’Œå¯¼èˆªçš„ä½œç”¨</strong>ã€‚è§ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå®é™…ä¸Š<code>a</code>å’Œ<code>l</code>ä¹Ÿå·²ç»è¶³å¤Ÿ:</p>
<p><img data-src="/images/CMU1544564/Lec07/52.jpg" alt="52.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/53.jpg" alt="53.jpg"></p>
<h3 id="Bulk-Insert"><a href="#Bulk-Insert" class="headerlink" title="Bulk Insert"></a>Bulk Insert</h3><p>ä¸€æ¬¡æ¬¡insertæ¥è·å¾—ä¸€ä¸ªB+ Treeå¾ˆæ…¢ã€‚Bulk Insertæ˜¯å°†keyså…ˆæ’åºï¼Œå†å®Œæˆleaf node, å†æ ¹æ®leaf nodeå»å®Œæˆinner nodeã€‚Bulk Insertè®©æˆ‘ä»¬èƒ½æ›´å¿«å»è·å¾—ä¸€ä¸ªB+ Tree:</p>
<p><img data-src="/images/CMU1544564/Lec07/54.jpg" alt="54.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/55.jpg" alt="55.jpg"></p>
<h3 id="Pointer-Swizzling"><a href="#Pointer-Swizzling" class="headerlink" title="Pointer Swizzling"></a>Pointer Swizzling</h3><p>æˆ‘ä»¬æ¯ä¸€æ¬¡ä»B+ Treeä¸­éœ€è¦ä¸€ä¸ªpageï¼Œéƒ½éœ€è¦è°ƒç”¨buffer poolä¸­çš„å‡½æ•°ï¼Œç”¨<code>pageid</code>è·å¾—å¯¹åº”pageçš„æŒ‡é’ˆã€‚è¿™ç§é—´æ¥indirectionï¼Œå¸¦æ¥å›ºå®šçš„å¼€é”€ã€‚è€Œæˆ‘ä»¬å¯ä»¥èŠ‚çœè¿™ä¸€éƒ¨åˆ†ï¼Œç‰¹åˆ«åœ¨B+ Treeçš„ä¸Šé¢å‡ å±‚ã€‚å› ä¸ºæ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦ä¸Šé¢å‡ å±‚çš„pageï¼Œå®ƒä»¬å±äºhot pageï¼Œå³å®ƒä»¬ç»å¸¸éœ€è¦æœ‰è¢«è®¿é—®ï¼Œæ¯ä¸€æ¬¡éƒ½æ‰¾buffer poolæ˜¾å¾—èŠ±é”€æ›´å¤§äº†ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠè¿™äº›pageä¸€ç›´ç•™ç€å†…å­˜é‡Œï¼Œç„¶ååœ¨B+_Treeä¸­ç›´æ¥å¸¦ä¸Šå®ƒä»¬å†…å®¹çš„æŒ‡é’ˆï¼Œè¿™æ ·è®¿é—®å®ƒä»¬ä¸éœ€è¦ç»è¿‡buffer poolã€‚è€Œè¿™äº›hot pageçš„æ•°é‡ä¸æ˜¯å¾ˆå¤šï¼Œå®Œå…¨å¯ä»¥é•¿ä¹…ç•™ç€å†…å­˜ä¸­ã€‚(è§<a href="#b+-tree-in-practice">B+ Tree In Practice</a>ä¸­ï¼Œä¸¤å±‚nodeå¤§æ¦‚åœ¨134ä¸ªpage, å 1MiBã€‚)</p>
<p><img data-src="/images/CMU1544564/Lec07/57.jpg" alt="57.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/58.jpg" alt="58.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/59.jpg" alt="59.jpg"></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><img data-src="/images/CMU1544564/Lec07/60.jpg" alt="60.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec07/61.jpg" alt="61.jpg"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>Access Methods</category>
        <category>B Tree</category>
        <category>Indexing</category>
      </categories>
      <tags>
        <tag>Indexing</tag>
        <tag>B Tree</tag>
        <tag>Clustered Index</tag>
        <tag>Variable Length Key</tag>
        <tag>Prefix Compression</tag>
        <tag>Suffix Truncation</tag>
        <tag>Bulk Load (Bulk Insert)</tag>
        <tag>Pointer Swizzling</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]Lec06 Hash Tables - å“ˆå¸Œè¡¨</title>
    <url>/2020/03/18/CMU-15445-Lec06/</url>
    <content><![CDATA[<p>Hash Tables - å“ˆå¸Œè¡¨</p>
<p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA2LWhhc2h0YWJsZXMucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/06-hashtables.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDYtaGFzaHRhYmxlcy5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/06-hashtables.pdf<i class="fa fa-external-link"></i></span><br>Readings: Chapter 11.6-11.7<!-- TODO:link here --></p>
<p>è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“çš„ä¸­ä½¿ç”¨çš„å“ˆå¸Œè¡¨hash tableï¼Œå®é™…ä¸Šæˆ‘ä»¬æ¶‰åŠçº¯ç®—æ³•è¯¾ä¸­çš„ç†è®ºï¼Œä½†æ›´é‡è¦çš„æ˜¯å·¥ç¨‹å®ç°çš„è§’åº¦ã€‚æ•°æ®åº“ä¸­ä½¿ç”¨çš„hash tableéœ€è¦æœ‰é«˜æ€§èƒ½ï¼Œå¤šçº¿ç¨‹è¯»å†™ï¼Œå†…å­˜è®¿é—®å‹å¥½ã€‚</p>
<a id="more"></a>
<p><img data-src="/images/CMU1544564/Lec06/1.jpg" alt="1.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/3.jpg" alt="3.jpg"></p>
<h1 id="Data-Structure-in-DBMS"><a href="#Data-Structure-in-DBMS" class="headerlink" title="Data Structure in DBMS"></a>Data Structure in DBMS</h1><p><img data-src="/images/CMU1544564/Lec06/4.jpg" alt="4.jpg"></p>
<ul>
<li>Internal Metadata: ç”¨äºç®¡ç†æ•°æ®åº“å†…éƒ¨åŸæ•°æ®çš„æ•°æ®ç»“æ„ï¼Œå¦‚ page table, page directory</li>
<li>Core Data Storage: å­˜å‚¨tuple/è¡¨æ ¼çš„æ•°æ®ç»“æ„, å¦‚ï¼šMemacacheæ•°æ®åº“ç”¨hash table,ã€€MySQLä½¿ç”¨B+æ ‘</li>
<li>Temporary Data Structures:å¯¹SQL Queryæš‚æ—¶çš„æ•°æ®ç»“æ„ï¼Œå¦‚ä¸€ä¸ªä½¿ç”¨hash joinçš„SQL Queryéœ€è¦æ–°å»ºä¸€ä¸ªhash table,ç„¶åå¯¹å®ƒæŸ¥è¯¢ï¼Œè¿™ä¸ªhash tableæ˜¯æš‚æ—¶çš„ï¼Œå³Queryç»“æŸå°±æ¸…é™¤é‡Šæ”¾</li>
<li>Table Indexes: è¾…åŠ©å‹ç´¢å¼•æ•°æ®ç»“æ„, ä½¿å¾—æŸ¥è¯¢æ›´å¿«ï¼Œä¸éœ€éå†æ‰€æœ‰tuple</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/5.jpg" alt="5.jpg"></p>
<h1 id="Hash-Table-Overview"><a href="#Hash-Table-Overview" class="headerlink" title="Hash Table Overview"></a>Hash Table Overview</h1><p><img data-src="/images/CMU1544564/Lec06/6.jpg" alt="6.jpg"></p>
<ul>
<li>ä¸Šå›¾ä¸­ï¼š</li>
<li>ç©ºé—´å¤æ‚åº¦æ˜¯$O(n)$, hash tableå¹¶ä¸æ˜¯ä¸€ä¸ªèƒ½èŠ‚çœå­˜å‚¨ç©ºé—´çš„æ•°æ®ç»“æ„ã€‚</li>
<li>æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦:<ul>
<li>average case: $O(1)$. ä»ç®—æ³•ç†è®ºä¸Šï¼Œå®ƒçš„å¤æ‚åº¦æ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚ä½†åœ¨å·¥ä¸šä¸­ï¼Œä¸€ä¸ªå¸¸æ•°ä¹Ÿæœ‰<strong>å¤§å°</strong>ä¹‹åˆ†ã€‚æ¯”å¦‚<strong>å°çš„å¸¸æ•°æ—¶é—´å¤æ‚åº¦</strong>ä»£è¡¨CPUæŒ‡ä»¤æ•°è¾ƒå°‘ï¼Œè€Œ<strong>å¤§çš„å¸¸æ•°æ—¶é—´å¤æ‚åº¦</strong>ä»£è¡¨CPUæŒ‡ä»¤æ•°è¾ƒå¤šï¼Œå³ä½¿å®ƒä»¬å¯¹åº”çš„CPUæŒ‡ä»¤æ•°éƒ½æ˜¯å¸¸æ•°ï¼Œä½†æ˜¯è¿è¡Œæ—¶é—´è¿˜æ˜¯æœ‰åŒºåˆ«ã€‚</li>
<li>worst case: $O(n)$ã€‚æ¯”å¦‚hash functionæ•ˆæœå¾ˆä¸å¹³å‡ï¼Œå°†æ‰€æœ‰æŒ‡hashåˆ°äº†ä¸€ä¸ªä½ç½®ï¼Œåè€Œå½¢æˆäº†ä¸€ä¸ªlistã€‚è¿™ç§ä¸å¹³å‡çš„hash functionæ¯”å¦‚æ˜¯ï¼šã€€$f(x) = 1$, å³å¸¸æ•°å‡½æ•°ã€‚</li>
</ul>
</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/7.jpg" alt="7.jpg"></p>
<ul>
<li>ä¸Šå›¾ä¸­ï¼š</li>
<li>f(abc)=0, f(def)=2, f(xyz)=n</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/8.jpg" alt="8.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/9.jpg" alt="9.jpg"></p>
<ul>
<li>ä¸Šå›¾ä¸­çš„ä¸€äº›å‡è®¾æ¥è‡ªäºç®—æ³•ä¸­ç†è®ºéƒ¨åˆ†ï¼Œä½†æ˜¯å®é™…ä¸Šï¼š</li>
<li>æ²¡æœ‰å†²çªcollisionçš„perfect hash functionåœ¨å¤§æ•°æ®å‰æä¸‹æ˜¯ä¸å­˜åœ¨çš„ã€‚hash collisionæ˜¯ä¸€å®šå‘ç”Ÿçš„ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/10.jpg" alt="10.jpg"></p>
<ul>
<li>ä»ä¸Šå›¾ä¸­, hash tableåˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œå®ƒä»¬äº’ç›¸ä¸ä¾èµ–ï¼š</li>
<li>hash function: å³æˆ‘ä»¬ä¹‹å‰æåˆ°çš„$f$å‡½æ•°, $f (\mathrm{key}) \rightarrow \mathrm{int} \in D$, $D$æ˜¯ä¸€ä¸ªintçš„é›†åˆã€‚æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªhash functionå¾ˆå¿«ï¼Œå¹¶ä¸”å†²çªæ¦‚ç‡å¾ˆä½ï¼š<ul>
<li>æˆ‘ä»¬ç­¾åæåˆ°çš„$f(x) = 1$å¸¸æ•°å‡½æ•°å¾ˆå¿«ï¼Œä½†æ˜¯å®ƒæŠŠä»»ä½•ä¸€ä¸ªkeyéƒ½åŒ¹é…åˆ°1è¿™ä¸ªä½ç½®ï¼Œå³å®ƒçš„å†²çªæ¦‚ç‡æ˜¯100%,è¿™ä¸ªéå¸¸ä¸å¥½ï¼Œä½¿æˆ‘ä»¬çš„hash tableå˜æˆäº†list,æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å˜æˆäº†$O(n)$çš„average case</li>
</ul>
</li>
<li>hash scheme:ã€€å³å¦‚ä½•å»å¤„ç†ä¸€å®šä¼šå‘ç”Ÿçš„å†²çªã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/11.jpg" alt="11.jpg"></p>
<p><br></p>
<h1 id="Hash-Function"><a href="#Hash-Function" class="headerlink" title="Hash Function"></a>Hash Function</h1><p><img data-src="/images/CMU1544564/Lec06/12.jpg" alt="12.jpg"></p>
<ul>
<li>ä¸Šå›¾ä¸­:</li>
<li>æˆ‘ä»¬ä¸è€ƒè™‘å¯†ç å­¦cryptographicçš„hash function,ã€€å› ä¸ºæˆ‘ä»¬åªæ˜¯åœ¨æ•°æ®åº“å†…éƒ¨ä½¿ç”¨hash tableï¼Œæ¥<a href="#data-structure-in-dbms">åŠ é€Ÿå¤„ç†æ•°æ®åº“çš„å…ƒæ•°æ®, å­˜å‚¨, join, ç´¢å¼•</a>ã€‚è€Œä¸æ˜¯ç”¨æ¥åŠ å¯†è§£å¯†ä¿¡æ¯ã€‚<strong>æ•°æ®åº“å¸Œæœ›hash functionå¾ˆå¿«ï¼Œå¹¶ä¸”å†²çªæ¦‚ç‡å¾ˆä½ã€‚</strong></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/13.jpg" alt="13.jpg"></p>
<ul>
<li>CRC-64: <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGUuc3RlcGhhbi1icnVtbWUuY29tL2NyYzMyLw==" title="https://create.stephan-brumme.com/crc32/">https://create.stephan-brumme.com/crc32/<i class="fa fa-external-link"></i></span></li>
<li>MurmurHash: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FhcHBsZWJ5L3NtaGFzaGVy" title="https://github.com/aappleby/smhasher">https://github.com/aappleby/smhasher<i class="fa fa-external-link"></i></span></li>
<li>Google CityHash: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9jaXR5aGFzaA==" title="https://github.com/google/cityhash">https://github.com/google/cityhash<i class="fa fa-external-link"></i></span></li>
<li>Facebook XXHash: <span class="exturl" data-url="aHR0cHM6Ly9jeWFuNDk3My5naXRodWIuaW8veHhIYXNoLw==" title="https://cyan4973.github.io/xxHash/">https://cyan4973.github.io/xxHash/<i class="fa fa-external-link"></i></span></li>
<li>Google FarmHash: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9mYXJtaGFzaA==" title="https://github.com/google/farmhash">https://github.com/google/farmhash<i class="fa fa-external-link"></i></span></li>
</ul>
<!-- TODO -->
<p><img data-src="/images/CMU1544564/Lec06/14.jpg" alt="14.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/15.jpg" alt="15.jpg"></p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FwYXZsby9oYXNoLWZ1bmN0aW9uLWJlbmNobWFyaw==" title="https://github.com/apavlo/hash-function-benchmark">https://github.com/apavlo/hash-function-benchmark<i class="fa fa-external-link"></i></span></li>
</ul>
<p><br></p>
<p>å¦å¤–è¿˜æœ‰ä¸€ç§Fibonacci Hashing, æ¨èé˜…è¯»: <span class="exturl" data-url="aHR0cHM6Ly9wcm9iYWJseWRhbmNlLmNvbS8yMDE4LzA2LzE2L2ZpYm9uYWNjaS1oYXNoaW5nLXRoZS1vcHRpbWl6YXRpb24tdGhhdC10aGUtd29ybGQtZm9yZ290LW9yLWEtYmV0dGVyLWFsdGVybmF0aXZlLXRvLWludGVnZXItbW9kdWxvLw==" title="https://probablydance.com/2018/06/16/fibonacci-hashing-the-optimization-that-the-world-forgot-or-a-better-alternative-to-integer-modulo/">https://probablydance.com/2018/06/16/fibonacci-hashing-the-optimization-that-the-world-forgot-or-a-better-alternative-to-integer-modulo/<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<h1 id="Static-Hashing-Schemes"><a href="#Static-Hashing-Schemes" class="headerlink" title="Static Hashing Schemes"></a>Static Hashing Schemes</h1><p>Static Hashing Schemesæ­£å¦‚staicæ‰€è¯´ï¼Œè¿™ç§schemeä¸‹çš„hash tableçš„å®¹é‡æ˜¯å›ºå®šçš„ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨hashçš„åŒæ—¶ï¼Œå‘ç°å®¹é‡ä¸å¤Ÿï¼Œåªèƒ½resizeåˆ°æ›´å¤§çš„å®¹é‡ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰çš„keyå†é‡æ–°hashè¿›æ‰©å¤§å®¹é‡çš„hash tableã€‚è¿™ç§resizeåœ¨static hashing schemeæ„å‘³è€…rehashingï¼Œè¿™ä¸ªæ“ä½œå¯¹æ€§èƒ½æ¥è¯´æ˜¯ç¾éš¾çº§åˆ«çš„ã€‚å¾ˆæ˜¾ç„¶å¦‚æœæˆ‘ä»¬èƒ½ä¸€å¼€å§‹å°±çŸ¥é“<strong>åˆé€‚çš„å®¹é‡</strong>,ã€€å°±èƒ½ç›´æ¥é¿å…è¿™éƒ¨åˆ†çš„æµªè´¹æ—¶é—´ã€‚å¦‚ä½•å¯»æ‰¾åˆé€‚çš„å®¹é‡ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œcardinality estimationåŸºæ•°ä¼°è®¡ã€‚è¿™ä¸ªéƒ¨åˆ†åé¢ä¼šæåˆ°ã€‚<!-- TODO: --></p>
<blockquote>
<p>A static hashing scheme is one where the size of the hash table is fixed. This means that if the DBMS runs out of storage space in the hash table, then it has to rebuild it from scratch with a larger table. Typically the new hash table is twice the size of the original hash table.</p>
</blockquote>
<p><img data-src="/images/CMU1544564/Lec06/16.jpg" alt="16.jpg"></p>
<h2 id="Linear-Probe-Hashing"><a href="#Linear-Probe-Hashing" class="headerlink" title="Linear Probe Hashing"></a>Linear Probe Hashing</h2><p>Linear Probe Hashingæ˜¯open address hashingçš„ä¸€ç§ã€‚</p>
<p>Linear Probingæ–¹å¼è™½ç„¶ç®€å•ï¼Œä½†å¹¶ä¸æ˜¯è§£å†³å†²çªçš„æœ€å¥½çš„ç­–ç•¥ï¼Œå› ä¸ºå®ƒä¼šå¯¼è‡´<strong>åŒç±»å“ˆå¸Œçš„èšé›†(Primary Clustering)</strong>ã€‚è¿™å¯¼è‡´æœç´¢å“ˆå¸Œè¡¨æ—¶ï¼Œå†²çªä¾ç„¶å­˜åœ¨ã€‚å¦‚æœæˆ‘ä»¬è¦è®¿é—® Edward çš„ä¿¡æ¯ï¼Œå› ä¸º Edward çš„ç¤¾ä¿å· 111-00-1235 å“ˆå¸Œä¸º 1235ï¼Œç„¶è€Œæˆ‘ä»¬åœ¨ 1235 ä½ç½®æ‰¾åˆ°çš„æ˜¯ Bobï¼Œæ‰€ä»¥å†æœç´¢ 1236ï¼Œæ‰¾åˆ°çš„å´æ˜¯ Dannyï¼Œä»¥æ­¤ç±»æ¨ç›´åˆ°æ‰¾åˆ° Edwardã€‚<sup><a href="#fn2">2</a></sup></p>
<p><img data-src="/images/CMU1544564/Lec06/17.jpg" alt="17.jpg"></p>
<blockquote>
<ul>
<li>To see if value is present, go to slot using hash, and scan for the key. The scan stops if you find the desired key or you encounter an empty slot.</li>
</ul>
</blockquote>
<h3 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h3><p>hash tableå­˜å‚¨ä¸ä»…ä»…æ˜¯<code>value</code>ï¼Œè€Œæ˜¯<code>(key, value)</code>è¿™ä¸€å¯¹ã€‚è¿™æ˜¯å› ä¸ºLinear Probe Hashingä¼šé‡åˆ°å†²çªï¼Œåœ¨æŸ¥è¯¢æ—¶éœ€è¦æ¯”è¾ƒkeyæ¥ç¡®å®šæ˜¯å¦æ‰¾åˆ°(keyç›¸ç­‰)æˆ–è€…åªæ˜¯ä¸€æ¬¡å†²çª(keyä¸ç›¸ç­‰)ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec06/18.jpg" alt="18.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/19.jpg" alt="19.jpg"></p>
<p>ä¸‹å›¾ä¸­Cå’ŒAçš„hashä½ç½®ç›¸åŒ(å†²çª), æˆ‘ä»¬å°†Cå†™åœ¨Açš„åé¢ï¼Œå¹¶Aè¿æ¥Cï¼š<br><img data-src="/images/CMU1544564/Lec06/20.jpg" alt="20.jpg"></p>
<p>ä¸‹å›¾ä¸­Då’ŒCçš„hashä½ç½®ç›¸åŒ(å†²çª), æˆ‘ä»¬å°†Då†™åœ¨Cçš„åé¢ï¼Œå¹¶Cè¿æ¥Dï¼š<br><img data-src="/images/CMU1544564/Lec06/21.jpg" alt="21.jpg"></p>
<p>ä¸‹å›¾ä¸­Eå’ŒA/Cçš„hashä½ç½®ç›¸åŒ(å†²çª), æˆ‘ä»¬å°†Eå†™åœ¨Cçš„åé¢ï¼Œ<strong>ä½†æ˜¯Cåé¢è¢«Då æœ‰äº†</strong>ï¼Œæ‰€æœ‰å°†Eå†™åœ¨Dåé¢,å¹¶Dè¿æ¥Eï¼š<br><img data-src="/images/CMU1544564/Lec06/22.jpg" alt="22.jpg"></p>
<p>ä¸‹å›¾ä¸­Få’ŒEçš„hashä½ç½®ç›¸åŒ(å†²çª), æˆ‘ä»¬å°†Få†™åœ¨Eçš„åé¢ï¼Œå¹¶Eè¿æ¥Fï¼š<br><img data-src="/images/CMU1544564/Lec06/23.jpg" alt="23.jpg"></p>
<h3 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h3><h4 id="Delete-C"><a href="#Delete-C" class="headerlink" title="Delete C"></a>Delete C</h4><p>ä¸‹å›¾ä¸­æˆ‘ä»¬æƒ³åˆ é™¤C, æˆ‘ä»¬å·²ç»è§åˆ°Cå’ŒAå†²çªã€‚æˆ‘ä»¬çœ‹ç¬¬ä¸€ä¸ªä½ç½®æ˜¯keyæ˜¯A, è€ŒA!=C, ç„¶åå¾€ä¸‹çœ‹ï¼š<br><img data-src="/images/CMU1544564/Lec06/24.jpg" alt="24.jpg"></p>
<p>ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬å‘ç°åœ¨ç¬¬äºŒä¸ªä½ç½®, hash tableæ¡ç›®ä¸­çš„keyæ˜¯Cï¼Œè€Œæˆ‘ä»¬å°±åƒåˆ å»C, C==Cã€‚è¿™ä¸ªæ¡ç›®è¢«åˆ é™¤ï¼š<br><img data-src="/images/CMU1544564/Lec06/25.jpg" alt="25.jpg"></p>
<h4 id="Find-D-after-deletion-of-C"><a href="#Find-D-after-deletion-of-C" class="headerlink" title="Find D after deletion of C"></a>Find D after deletion of C</h4><p>ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬æƒ³å¯»æ‰¾Dã€‚ç”±äºä¹‹å‰Då’ŒCçš„hashä½ç½®ç›¸åŒ(å†²çª)ï¼Œè€ŒCå·²ç»è¢«åˆ é™¤ï¼ŒDå¤±å»äº†å’ŒCçš„è”ç³»ã€‚å¯¼è‡´æˆ‘ä»¬ä¸èƒ½æ‰¾åˆ°Dï¼š<br><img data-src="/images/CMU1544564/Lec06/26.jpg" alt="26.jpg"></p>
<h5 id="Approach1-Tombstone"><a href="#Approach1-Tombstone" class="headerlink" title="Approach1: Tombstone"></a>Approach1: Tombstone</h5><p>è§£å†³ä¸Šè¿°é—®é¢˜çš„ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª<em>å¢“ç¢‘</em>:ã€€åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ é™¤äº†Cï¼Œä½†æ˜¯ç•™ä¸‹äº†ä¸€ä¸ªCçš„å¢“ç¢‘ï¼Œå¢“ç¢‘ä¾ç„¶ä¿ç•™ç€åˆ°Dçš„è”ç³»é“¾æ¥ã€‚é€šè¿‡è¿™ä¸ªå¢“ç¢‘çš„é“¾æ¥æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°D:<br><img data-src="/images/CMU1544564/Lec06/27.jpg" alt="27.jpg"></p>
<p>è¿™ç§ä½œæ³•çš„ç¼ºç‚¹æ˜¯ï¼šä¿å­˜å¢“ç¢‘ä¼šå æœ‰ç©ºé—´ã€‚</p>
<h5 id="Approach2-Movement"><a href="#Approach2-Movement" class="headerlink" title="Approach2: Movement"></a>Approach2: Movement</h5><p>è§£å†³ä¸Šè¿°é—®é¢˜çš„ç¬¬äºŒç§æ–¹æ³•æ˜¯<em>ç§»åŠ¨</em>ï¼šå³åˆ é™¤ä¸€ä¸ªæ¡ç›®ä¹‹åï¼Œå¯¹hash tableä¸­å’Œå·²è¢«åˆ é™¤æ¡ç›®æœ‰è”ç³»çš„æ¡ç›®è¿›è¡Œç§»åŠ¨ï¼Œç§»åŠ¨è‡³æ­£ç¡®çš„åœ°æ–¹ã€‚</p>
<p>ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œåªèƒ½ç§»åŠ¨å’Œå·²è¢«åˆ é™¤<strong>æœ‰è”ç³»çš„æ¡ç›®</strong> (Bå’ŒFå¹¶ä¸æ›¾ç¢°æ’å†²çªï¼Œä½†æ˜¯Båœ¨å¦‚ä¸‹ä¾‹å­ä¸åº”è¯¥è¢«ç§»åŠ¨):</p>
<p><img data-src="/images/CMU1544564/Lec06/28.jpg" alt="28.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/29.jpg" alt="29.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/30.jpg" alt="30.jpg"></p>
<p>ä¸‹å›¾ä¸­æ£€æŸ¥Bæ˜¯å¦å’Œè¢«åˆ é™¤çš„æ¡ç›®Cå­˜åœ¨è”ç³»ï¼Œå‘ç°Bå°±åœ¨å®ƒè‡ªå·±åº”è¯¥åœ¨çš„åœ°æ–¹ï¼Œè€Œå’Œå…¶ä»–æ¡ç›®æ— ä»»ä½•è”ç³»ï¼Œå› æ¬¡ä¸ç§»åŠ¨Bã€‚<strong>æ— è§†é‚£ä¸ªä»ä¸Šåˆ°ä¸‹çš„ç®­å¤´</strong>:<br><img data-src="/images/CMU1544564/Lec06/31.jpg" alt="31.jpg"></p>
<p>è¿™ç§ä½œæ³•çš„ç¼ºç‚¹æ˜¯:åˆ é™¤ä¼šå˜å¾—éå¸¸éº»çƒ¦ã€‚</p>
<p><br></p>
<p>è¿™é‡Œæä¸€ä¸‹ï¼Œåœ¨hash joinä¸­ï¼Œæˆ‘ä»¬åªç”¨insertå’Œfindè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œè€Œä¸ç”¨deleteã€‚å¯¹äºhash joinè¿™ä¸­æ“ä½œå¯ä»¥æ— è§†åˆ é™¤ä¼šå¯¼è‡´çš„ç¼ºç‚¹ã€‚</p>
<p>ä½†æ˜¯åœ¨indexç´¢å¼•ä¸­ï¼Œinsert, find, deleteè¿™äº›æ“ä½œéƒ½è¢«éœ€è¦ã€‚</p>
<h3 id="Non-Unique-Keys"><a href="#Non-Unique-Keys" class="headerlink" title="Non-Unique Keys"></a>Non-Unique Keys</h3><p>æœ‰ä¸¤ç§å¤„ç†<strong>é‡å¤key</strong>çš„æ–¹å¼:</p>
<ul>
<li>value listå­˜å‚¨é‡å¤keyæ‰€æ‹¥æœ‰çš„value</li>
<li>å­˜å‚¨keyå’Œvalueï¼Œè¿™æ ·å³ä½¿keyé‡å¤,valueå€¼ä¹Ÿä¸ä¸€æ ·ã€‚<strong>è¿™ç§æ–¹å¼æ›´åŠ å¸¸è§ã€‚</strong><br><img data-src="/images/CMU1544564/Lec06/32.jpg" alt="32.jpg"></li>
</ul>
<p><br></p>
<h2 id="Robin-Hood-Hashing"><a href="#Robin-Hood-Hashing" class="headerlink" title="Robin Hood Hashing"></a>Robin Hood Hashing</h2><p>Robin Hood Hashingå’ŒLinear Probe Hashingç›¸æ¯”ï¼Œæ›´å¯ä»¥å»å¹³è¡¡å†²çªï¼Œè®©å†²çªçš„keyç¦»å®ƒåº”è¯¥æ‹¥æœ‰çš„ä½ç½®(optimal position)è¿‘ä¸€äº›ã€‚æ­£å¦‚å®ƒçš„åå­—ä¸€æ ·ï¼Œç½—å®¾æ±‰ï¼ŒåŠ«å¯Œæµè´«ï¼Œè§£å†³badcaseã€‚</p>
<p><img data-src="/images/CMU1544564/Lec06/33.jpg" alt="33.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/34.jpg" alt="34.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/35.jpg" alt="35.jpg"></p>
<p>ä¸‹å›¾ä¸­, Cä¸Aå†²çªäºçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„ä½ç½®ã€‚</p>
<ul>
<li>è¿™æ—¶Aç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0, Cç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0ã€‚ä¸¤å€¼ç›¸ç­‰ï¼ŒCä¸èƒ½è·å¾—Açš„ä½ç½®ã€‚</li>
<li>Cè·å¾—Aåé¢ç©ºçš„ä½ç½®ï¼ŒCç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ï¼š<br><img data-src="/images/CMU1544564/Lec06/36.jpg" alt="36.jpg"></li>
</ul>
<p><br></p>
<p>ä¸‹å›¾ä¸­, Dä¸Cå†²çªäºçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„ä½ç½®ã€‚</p>
<ul>
<li>è¿™æ—¶Cç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1, Dç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0ã€‚Dçš„è·ç¦»å€¼å°äºCçš„è·ç¦»å€¼ï¼ŒDä¸èƒ½è·å¾—Cçš„ä½ç½®ã€‚</li>
<li>Dè·å¾—Cåé¢ç©ºçš„ä½ç½®ï¼ŒDç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ï¼š<br><img data-src="/images/CMU1544564/Lec06/37.jpg" alt="37.jpg"></li>
</ul>
<p><br></p>
<p><strong>ä¸‹ä¸¤å¼ å›¾ä¸­</strong>, Eä¸Aå†²çªäºçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„ä½ç½®ã€‚</p>
<ul>
<li>è¿™æ—¶Aç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0, Eç¦»å®ƒçš„optimal postionè·ç¦»ä¸º0ã€‚ä¸¤å€¼ç›¸ç­‰ï¼ŒEä¸èƒ½è·å¾—Açš„ä½ç½®ã€‚</li>
<li>Eè·å¾—Aåé¢ç©ºçš„ä½ç½®ï¼Œç„¶åEä¸Cå†²çªã€‚</li>
<li>è¿™æ—¶Cç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1, Eç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ã€‚ä¸¤å€¼ç›¸ç­‰ï¼ŒEä¸èƒ½è·å¾—Cçš„ä½ç½®ã€‚</li>
<li>Eè·å¾—Cåé¢ç©ºçš„ä½ç½®ï¼Œç„¶åEä¸Då†²çªã€‚è¿™æ—¶Dç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1, Eç¦»å®ƒçš„optimal postionè·ç¦»ä¸º2ã€‚<strong>Eçš„è·ç¦»å€¼å¤§äºDçš„è·ç¦»å€¼ï¼ŒEè·å¾—Dçš„ä½ç½®ã€‚</strong></li>
<li>Dåªèƒ½å‘åç§»åŠ¨ï¼ŒåŒæ—¶ä¹Ÿæ›´æ–°è‡ªå·±ç¦»è‡ªå·±optimal positionçš„è·ç¦»:<br><img data-src="/images/CMU1544564/Lec06/38.jpg" alt="38.jpg"></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/39.jpg" alt="39.jpg"></p>
<p><br></p>
<p>ä¸‹å›¾ä¸­, Fä¸Då†²çªäºçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„ä½ç½®ã€‚</p>
<ul>
<li>è¿™æ—¶Dç¦»å®ƒçš„optimal postionè·ç¦»ä¸º2, Fç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ã€‚Fçš„è·ç¦»å€¼å°äºDçš„è·ç¦»å€¼ï¼ŒFä¸èƒ½è·å¾—Dçš„ä½ç½®ã€‚</li>
<li>Fè·å¾—Dåé¢ç©ºçš„ä½ç½®ï¼ŒFç¦»å®ƒçš„optimal postionè·ç¦»ä¸º1ï¼š<br><img data-src="/images/CMU1544564/Lec06/40.jpg" alt="40.jpg"></li>
</ul>
<p><br></p>
<p>æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ç»“æœï¼š</p>
<ul>
<li>Linear Probe Hashing: Dåœ¨Eçš„ä¸Šé¢ã€‚Dç¦»è‡ªå·±optimal positionè·ç¦»ä¸º1,Eç¦»è‡ªå·±optimal positionè·ç¦»ä¸º3ã€‚</li>
<li>Robin Hood Hashing:ã€€Eåœ¨Dçš„ä¸Šé¢ã€‚Dç¦»è‡ªå·±optimal positionè·ç¦»ä¸º2,Eç¦»è‡ªå·±optimal positionè·ç¦»ä¸º2ã€‚</li>
</ul>
<p>Robin Hood Hashingå¹³å‡äº†ä¸€ä¸‹å„ä¸ªkeyç¦»è‡ªå·±optimal positionçš„è·ç¦»ã€‚ä½†æ˜¯å®ƒåœ¨insertçš„æ—¶å€™ï¼Œæœ‰å¯èƒ½ä¼šè°ƒæ•´å…¶ä»–æ¡ç›®çš„ä½ç½®, åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œåœ¨insert Eçš„æ—¶å€™è°ƒæ•´äº†Dçš„ä½ç½®ã€‚è¯´æ˜å®ƒä¼šéœ€è¦æ›´å¤šwrite operationçš„æ¬¡æ•°ï¼Œå¦å¤–åœ¨insertçš„æ—¶å€™å®ƒä¹Ÿæœ‰æ›´å¤šæ¡ä»¶éœ€è¦æ£€æŸ¥ï¼Œè¿™ä¼šé€ æˆæ›´å¤šçš„branch miss predictionã€‚</p>
<p>å®é™…å®ç°ä¸ŠLinear Probe Hashingæ›´ä¸ºå¸¸è§ã€‚</p>
<p><br></p>
<h2 id="Cuckoo-Hashing"><a href="#Cuckoo-Hashing" class="headerlink" title="Cuckoo Hashing"></a>Cuckoo Hashing</h2><p>Cuckoo Hashingä½¿ç”¨å¤šä¸ªhash table, æ¯ä¸ªhash tableæ‹¥æœ‰è‡ªå·±çš„hash function (hash function seed)ã€‚æˆ‘ä»¬ä¸‹é¢çš„ä¾‹å­æ˜¯ç”¨ä¸¤ä¸ªè¡¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨ä¸‰ä¸ªæ¥å®ç°Cuckoo Hashingã€‚</p>
<blockquote>
<p>The hash functions are the same algorithm (e.g., XXHash, CityHash); they generate different hashes for the same key by using different seed values.</p>
</blockquote>
<p>insert: </p>
<ul>
<li>æ€»å‘æœ‰ç©ºä½ç½®(optimal position)çš„hash tableæ’å…¥ã€‚å¦‚æœå¤šä¸ªhash tableéƒ½æœ‰ç©ºä½ç½®å¯ä»¥æ’å…¥ï¼Œéšæ„é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªå³å¯ã€‚</li>
<li>å¦‚æœæ‰€æœ‰çš„hash tableéƒ½æ²¡æœ‰ç©ºä½ç½®å¯ä»¥æ’å…¥ã€‚éšæœºé€‰æ‹©ä¸€ä¸ªhash tableä¸­å¯¹åº”çš„ä½ç½®æ’å…¥,ã€€å¹¶å–å‡ºåŸæ¥åœ¨è¿™ä½ç½®ä¸Šçš„key, å°†å®ƒinsertåˆ°å…¶ä»–çš„hash tableã€‚</li>
</ul>
<p>ä¼˜ç‚¹æ˜¯æŸ¥è¯¢å¿«ï¼Œè·¯å¾„çŸ­ï¼Œæœ€å¤šä¸¤æ¬¡å°±èƒ½æŸ¥è¯¢åˆ°ã€‚</p>
<p>ç¼ºç‚¹æ˜¯æ’å…¥æ€§èƒ½å·®ï¼Œåœ¨å®¹é‡å°çš„æƒ…å†µä¸‹å¾ˆå®¹æ˜“å†²çªã€‚è¿é”çš„å†²çªä¼šé™·å…¥æ­»å¾ªç¯, è§£å†³åªèƒ½å¢åŠ å®¹é‡å¹¶ä¸”rehashã€‚</p>
<p><img data-src="/images/CMU1544564/Lec06/41.jpg" alt="41.jpg"></p>
<p>ä¸‹å›¾ä¸­ï¼ŒAå¯¹åº”çš„ä½ç½®éƒ½æ˜¯ç©ºçš„ï¼ŒAå¯ä»¥è¢«æ’å…¥è‡³ä»»ä½•ä¸€ä¸ªhash tableï¼Œä¾‹å­ä¸­é€‰æ‹©äº†#1:<br><img data-src="/images/CMU1544564/Lec06/42.jpg" alt="42.jpg"></p>
<p><br></p>
<p>ä¸‹å›¾ä¸­ï¼ŒBå¯¹åº”çš„ä½ç½®åªæœ‰åœ¨#2æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆæ’å…¥è‡³#2:<br><img data-src="/images/CMU1544564/Lec06/43.jpg" alt="43.jpg"></p>
<p><br></p>
<p>ä¸‹é¢å‡ å¼ å›¾ä¸­ï¼Œ</p>
<ul>
<li>Cå¯¹åº”çš„ä½ç½®<strong>éƒ½ä¸æ˜¯ç©ºçš„</strong>ï¼ŒCå¯ä»¥é€‰æ‹©ä»»ä½•ä¸€ä¸ªhash tableï¼Œä»£æ›¿å æœ‰ä½ç½®çš„keyï¼Œä¾‹å­ä¸­é€‰æ‹©äº†#2, å³ä»£æ›¿äº†B</li>
<li>Bè¢«rehashåˆ°#1ï¼Œåœ¨#1ä¸­Bå¯¹åº”çš„ä½ç½®ä¹Ÿä¸æ˜¯ç©ºçš„ï¼ŒBä»£æ›¿å æœ‰ä½ç½®çš„key A</li>
<li>Aè¢«rehashåˆ°#2, åœ¨#2ä¸­å¯¹åº”çš„ä½ç½®æ˜¯ç©ºçš„ï¼š<br><img data-src="/images/CMU1544564/Lec06/44.jpg" alt="44.jpg"></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/45.jpg" alt="45.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/46.jpg" alt="46.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/47.jpg" alt="47.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/48.jpg" alt="48.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/49.jpg" alt="49.jpg"></p>
<p><br></p>
<p>åœ¨Cuckoo Hashingä¸­<strong>æœ‰å¯èƒ½ä¸ç»ˆæ­¢</strong>ï¼Œå³è¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæ°¸è¿œæ‰¾ä¸åˆ°èƒ½æ’å…¥çš„åœ°æ–¹ã€‚è¿™æ—¶å€™è¯´æ˜hash tableå®¹é‡å¤ªå°ï¼Œéœ€è¦<code>resize</code>åˆ°æ›´å¤§çš„å®¹é‡ã€‚</p>
<blockquote>
<p> If we find a cycle, then we can rebuild all of the hash tables with new hash function seeds (less common) or rebuild the hash tables using larger tables (more common).</p>
</blockquote>
<h1 id="Dynamic-Hashing-Schemes"><a href="#Dynamic-Hashing-Schemes" class="headerlink" title="Dynamic Hashing Schemes"></a>Dynamic Hashing Schemes</h1><p>Dynamic Hashing Schemesçš„ç‰¹å¾å°±æ˜¯åœ¨èƒ½æŒç»­å®¹é‡å¢é•¿ï¼Œè€Œä¸éœ€è¦é¢å¤–rehashã€‚å³resizeçš„æ“ä½œèŠ±é”€ä¸å¤§ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec06/50.jpg" alt="50.jpg"></p>
<h2 id="Chained-Hashing"><a href="#Chained-Hashing" class="headerlink" title="Chained Hashing"></a>Chained Hashing</h2><p>Chained Hashingåˆç§°Hashing with Chainingã€‚ç‰¹å¾æ˜¯æ¯ä¸€ä¸ªhash tableä¸­çš„æ¡ç›®éƒ½æ˜¯ä¸€ä¸ªlinked list of bucketã€‚å¦‚æœbucketæ»¡äº†ï¼Œé‚£å°±å†æŒ‡å‘ä¸€ä¸ªæ–°çš„bucketã€‚</p>
<p><strong>è¿™é‡Œçš„bucketå¯ä»¥å…·è±¡æˆä¸€ä¸ªpageã€‚</strong></p>
<p>ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œä¸éœ€è¦resizeã€‚</p>
<p>ç¼ºç‚¹æ˜¯æ¯ä¸€ä¸ªlinked listå¦‚æœå¾ˆé•¿, å°±å˜æˆ$O(n)$ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec06/51.jpg" alt="51.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/52.jpg" alt="52.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/53.jpg" alt="53.jpg"></p>
<h2 id="Extendible-Hashing"><a href="#Extendible-Hashing" class="headerlink" title="Extendible Hashing"></a>Extendible Hashing</h2><ul>
<li>global <code>n bit</code>: æŒ‡keyä¸­å‰nä¸ªbitæ˜¯å¯¹å·¦ä¾§directoryæœ‰æ•ˆã€‚</li>
<li>local <code>m bit</code>: æŒ‡globalä¸­<code>n bit</code>ä¸­çš„å‰<code>m</code>ä¸ªbit<strong>åœ¨è¿™ä¸€ä¸ªbucket</strong>æœ‰æ•ˆã€‚</li>
<li>$n \geq m$æ’æˆç«‹</li>
<li>å¦‚æœlocal bucketæ»¡äº†(overflow)ï¼Œé‚£å°±å¢åŠ ä¸€ä¸ªlocal bitå»å®¹çº³æ›´å¤šã€‚å¦‚æœ$n=m$ï¼Œé‚£å°±å…ˆå¢åŠ ä¸€ä¸ªglobal bitï¼Œå†å¢åŠ local bitã€‚ä½¿$n \geq m$æ¡ä»¶ä¾ç„¶æˆç«‹</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/54.jpg" alt="54.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/55.jpg" alt="55.jpg"></p>
<h3 id="Find-A"><a href="#Find-A" class="headerlink" title="Find A"></a>Find A</h3><p><img data-src="/images/CMU1544564/Lec06/56.jpg" alt="56.jpg"></p>
<h3 id="Insert-B-No-Overflow"><a href="#Insert-B-No-Overflow" class="headerlink" title="Insert B - No Overflow"></a>Insert B - No Overflow</h3><p><img data-src="/images/CMU1544564/Lec06/57.jpg" alt="57.jpg"></p>
<h3 id="Insert-C-Overflow"><a href="#Insert-C-Overflow" class="headerlink" title="Insert C - Overflow"></a>Insert C - Overflow</h3><p>Cå¯¹åº”çš„local bucketå·²ç»æ»¡äº†ï¼Œå¦å¤–local bit = global bit = 2</p>
<p>æˆ‘ä»¬æ­£å¦‚å‰é¢ä»‹ç»çš„ï¼Œå…ˆå¢åŠ global bitåˆ°3, å†å°†local bitå¢åŠ åˆ°3, æœ€åinsert Cã€‚</p>
<p><img data-src="/images/CMU1544564/Lec06/58.jpg" alt="58.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/59.jpg" alt="59.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/60.jpg" alt="60.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/61.jpg" alt="61.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/62.jpg" alt="62.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/63.jpg" alt="63.jpg"></p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªä¸Šè¯¾é—®é¢˜å¼•å‘çš„è®¨è®ºã€‚ç»“æœæ˜¯extendible hash tableçš„<code>resize</code>æ“ä½œæ˜¯å¾ˆç®€å•å»‰ä»·çš„ã€‚å·¦ä¾§çš„directoryæ˜¯ä¸€ä¸ªarray of pointeræˆ–è€…array of page idã€‚ç”¨latchä¿æŠ¤è¿™ä¸ªarray,ã€€ç„¶åæ‰©å¤§å®ƒçš„å®¹é‡ï¼Œå¤åˆ¶åŸæ¥çš„å†…å®¹è¿›å…¥ä»¥åï¼Œå°±å¯ä»¥è§£å¼€latchäº†ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸æ¶‰åŠrehashå’Œå¤§é‡çš„æ•°æ®å¤åˆ¶ï¼Œå› æ­¤å¾ˆå¿«é€Ÿã€‚</p>
<!-- TODO: TUM GDB é¢˜ç›® -->
<h2 id="Linear-Hashing"><a href="#Linear-Hashing" class="headerlink" title="Linear Hashing"></a>Linear Hashing</h2><p>Linear Hashingçš„ç›®çš„æ˜¯ä¸åœ¨<code>resize</code>çš„æ—¶å€™ç”¨ä¸€ä¸ªglobal latchï¼Œæ¥æé«˜æ€§èƒ½ã€‚æˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢ä¾‹å­ä¸­çœ‹å‡ºï¼Œåœ¨Linear Hashingä¸­åªéœ€è¦å»latchä¸€ä¸ªä½ç½®, å³<code>split pointer</code>æ‰€æŒ‡çš„åœ°æ–¹ã€‚</p>
<p>ä½œæ³•æ˜¯æŒ‰ç…§<em>é¡ºåº</em>å»åˆ†è£‚bucketï¼Œè€Œä¸æ˜¯åˆ†è£‚ç‰¹å®šæ»¡çš„bucketã€‚é¡ºåºå®é™…ä¸Šåªæ˜¯bucket idé¡ºåºï¼Œæœ‰ä¸€ä¸ª<code>split pointer</code>å»è·Ÿè¸ªä¸‹ä¸€ä¸ªéœ€è¦åˆ†è£‚çš„bucketã€‚è€Œä¸”Linear Hashingä½¿ç”¨å¤šä¸ªhash functionã€‚</p>
<blockquote>
<p>Instead of immediately splitting a bucket when it overflows, this scheme maintains a split pointer that keeps track of the next bucket to split. No matter whether this pointer is pointing to the bucket that overflowed, the DBMS always splits. The overflow criterion is left up to the implementation</p>
</blockquote>
<p>å…·ä½“æè¿°å’Œå’ŒJavaå®ç°ï¼Œè§ä¸€ç¯‡åˆ«äººçš„åšå®¢: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYmYyNDAwNzg2ZjY=" title="https://www.jianshu.com/p/0bf2400786f6">https://www.jianshu.com/p/0bf2400786f6<i class="fa fa-external-link"></i></span></p>
<p><img data-src="/images/CMU1544564/Lec06/64.jpg" alt="64.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/65.jpg" alt="65.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/66.jpg" alt="66.jpg"></p>
<h3 id="Find-6"><a href="#Find-6" class="headerlink" title="Find 6"></a>Find 6</h3><p><img data-src="/images/CMU1544564/Lec06/67.jpg" alt="67.jpg"></p>
<p><br></p>
<h3 id="Insert-17-Overflow"><a href="#Insert-17-Overflow" class="headerlink" title="Insert 17 - Overflow"></a>Insert 17 - Overflow</h3><ul>
<li>Overflowçš„bucketåé¢ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„bucketã€‚</li>
<li><code>split pointer</code>æ‰€æŒ‡çš„bucketä¼šè¿›è¡Œåˆ†è£‚ï¼Œåˆ†è£‚æˆä¸¤ä¸ªbucketï¼ŒåŸå†…å®¹é‡æ–°ç”¨æ–°çš„hash functionï¼Œå†åˆ†é…åŸå†…å®¹åˆ°æ–°æ—§ä¸¤ä¸ªbucketã€‚ä¸‹é¢ä¾‹å­ä¸­:<ul>
<li>$\mathrm{hash_2}(8) = 8 \% 8 = 0 \; \rightarrow \mathrm{bucket_0}$</li>
<li>$\mathrm{hash_2}(20) = 20 \% 8 = 4 \; \rightarrow \mathrm{bucket_4}$</li>
</ul>
</li>
<li>åˆ†è£‚å®Œä»¥åï¼Œ<code>split pointer</code>æŒ‡å‘ä¸‹ä¸€ä¸ªbucket(bucket id)ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/68.jpg" alt="68.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/69.jpg" alt="69.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/70.jpg" alt="70.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/71.jpg" alt="71.jpg"></p>
<p><br></p>
<h3 id="Find-20"><a href="#Find-20" class="headerlink" title="Find 20"></a>Find 20</h3><ul>
<li>å…ˆåº”ç”¨$\mathrm{hash_1}$</li>
<li>$\mathrm{hash_1}$çš„ç»“æœæ˜¯0, 0è¿™ä¸ªä½ç½®<strong>é«˜äº</strong><code>split pointer</code>, è¯´æ˜0è¿™ä¸ªä½ç½®å·²ç»åˆ†è£‚è¿‡äº†ã€‚éœ€è¦å†åº”ç”¨$\mathrm{hash_2}$</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/72.jpg" alt="72.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/73.jpg" alt="73.jpg"></p>
<p><br></p>
<h3 id="Find-9"><a href="#Find-9" class="headerlink" title="Find 9"></a>Find 9</h3><ul>
<li>å…ˆåº”ç”¨$\mathrm{hash_1}$</li>
<li>$\mathrm{hash_1}$çš„ç»“æœæ˜¯1, 1è¿™ä¸ªä½ç½®<strong>æ²¡æœ‰é«˜äº</strong><code>split pointer</code>, è¯´æ˜1è¿™ä¸ªä½ç½®æ²¡æœ‰åˆ†è£‚è¿‡äº†ã€‚ä¸éœ€è¦å†åº”ç”¨$\mathrm{hash_2}$</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec06/74.jpg" alt="74.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/75.jpg" alt="75.jpg"></p>
<p><br></p>
<h3 id="Delete-20"><a href="#Delete-20" class="headerlink" title="Delete 20"></a>Delete 20</h3><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œåˆ†è£‚å‡ºçš„bucketå› ä¸ºåˆ é™¤çš„åŸå› å˜æˆäº†ç©ºbucketã€‚è¿™æ—¶å€™å¯ä»¥å›æ”¶è¿™ä¸ªbucketï¼ŒåŒæ—¶æ˜¯é€†æ“ä½œä¹‹å‰çš„åˆ†è£‚æ­¥éª¤ï¼Œéœ€è¦å°†<code>split pointer</code>å‘ä¸Šç§»åŠ¨ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec06/76.jpg" alt="76.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/77.jpg" alt="77.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/78.jpg" alt="78.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/79.jpg" alt="79.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/80.jpg" alt="80.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/81.jpg" alt="81.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/82.jpg" alt="82.jpg"></p>
<h3 id="Insert-21"><a href="#Insert-21" class="headerlink" title="Insert 21"></a>Insert 21</h3><p>è¿™é‡Œä¹Ÿè§†ä½œä¸€ä¸ªoverflowã€‚</p>
<p><img data-src="/images/CMU1544564/Lec06/83.jpg" alt="83.jpg"></p>
<p><br></p>
<p>å½“<code>split point</code>æŒ‡å‘4çš„æ—¶å€™ï¼Œå³åˆ†è£‚å®Œä¸€è½®äº†ï¼Œå½“å‰ # bucket=8ã€‚æŠŠ<code>split point</code>é‡ç½®æˆ0ï¼Œ<strong>å¼€å§‹ä¸‹ä¸€è½®</strong>ï¼Œæ¯è½®çš„bucketæ•°ç¿»å€ï¼Œæ‰€ä»¥hashå‡½æ•°ä¸­çš„å–ä½™çš„æ•°ä¹Ÿè¦ç¿»å€ã€‚è¿™æ ·å°±å®ç°äº†åŠ¨æ€æ‰©å±•ã€‚<sup><a href="#fn1">1</a></sup></p>
<blockquote>
<p>When pointer reaches last slot, delete original hash function and replace it with new hash function.</p>
</blockquote>
<p><br></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><img data-src="/images/CMU1544564/Lec06/84.jpg" alt="84.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec06/85.jpg" alt="85.jpg"></p>
<p>å¼•ç”¨:</p>
<p><a name="fn1">1</a>: CMU Database Systems - Indexes - fxjwind: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9wLzEwODM0ODQ0Lmh0bWw=" title="https://www.cnblogs.com/fxjwind/p/10834844.html">https://www.cnblogs.com/fxjwind/p/10834844.html<i class="fa fa-external-link"></i></span></p>
<p><a name="fn1">2</a>: CMU 15445 5. hash è¡¨ - è¥¿éƒ¨å°ç¬¼åŒ…: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYmYyNDAwNzg2ZjY=" title="https://www.jianshu.com/p/0bf2400786f6">https://www.jianshu.com/p/0bf2400786f6<i class="fa fa-external-link"></i></span></p>
<p>æ¨èé˜…è¯»:</p>
<p>Lec 13 Cuckoo Hashing - CS166 Stanford: <span class="exturl" data-url="aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMTY2L2xlY3R1cmVzLzEzL1NtYWxsMTMucGRm" title="https://web.stanford.edu/class/cs166/lectures/13/Small13.pdf">https://web.stanford.edu/class/cs166/lectures/13/Small13.pdf<i class="fa fa-external-link"></i></span></p>
<p>Extendible Hashing Example: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY29zYy5icm9ja3UuY2EvfmVmb3h3ZWxsLzJQMDMvc2xpZGVzL1dlZWsxMlNsaWRlcy5wZGY=" title="https://www.cosc.brocku.ca/~efoxwell/2P03/slides/Week12Slides.pdf">https://www.cosc.brocku.ca/~efoxwell/2P03/slides/Week12Slides.pdf<i class="fa fa-external-link"></i></span></p>
<p>LINEAR HASHING - QuePer: <span class="exturl" data-url="aHR0cDovL3F1ZXBlci5pbi9kcnVwYWwvYmxvZ3MvZGJzeXMvbGluZWFyX2hhc2hpbmc=" title="http://queper.in/drupal/blogs/dbsys/linear_hashing">http://queper.in/drupal/blogs/dbsys/linear_hashing<i class="fa fa-external-link"></i></span></p>
<!-- TODO: --><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>Access Methods</category>
        <category>Hash Table</category>
        <category>Indexing</category>
      </categories>
      <tags>
        <tag>Indexing</tag>
        <tag>Hash Function</tag>
        <tag>Hash Scheme</tag>
        <tag>Static Hashing Scheme</tag>
        <tag>Linear Probe Hashing</tag>
        <tag>Robin Hood Hashing</tag>
        <tag>Cuckoo Hashing</tag>
        <tag>Dynamic Hashing Scheme</tag>
        <tag>Chained Hashing</tag>
        <tag>Extendible Hashing</tag>
        <tag>Linear Hashing</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]Lec05 Buffer Pools - æ•°æ®åº“ç¼“å­˜åŒº</title>
    <url>/2020/03/17/CMU-15445-Lec05/</url>
    <content><![CDATA[<p>Buffer Pools - æ•°æ®åº“ç¼“å­˜åŒº</p>
<p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA1LWJ1ZmZlcnBvb2wucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDUtYnVmZmVycG9vbC5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/05-bufferpool.pdf<i class="fa fa-external-link"></i></span><br>Readings: Chapter 10.5-10.8</p>
<p>è¿™èŠ‚ä¸¤è¯¾ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“çš„ç¼“å­˜åŒºç®¡ç†ï¼Œè¿™éƒ¨åˆ†åŸºäºå‰é¢ä¸¤èŠ‚è¯¾(Storage Iå’ŒStorage II)ã€‚</p>
<p>ç¼“å­˜åŒºbuffer poolå°±æ˜¯åœ¨å†…å­˜ä¸­å¯¹pageçš„ç¼“å­˜(cache)ã€‚</p>
<a id="more"></a>
<p><img data-src="/images/CMU1544564/Lec05/1.jpg" alt="1.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/6.jpg" alt="6.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/7.jpg" alt="7.jpg"><br>ä¸Šå›¾ä¸­</p>
<ul>
<li>spatial control ç©ºé—´æ§åˆ¶: ç‰©ç†(physically)ä¸Šæˆ‘ä»¬éœ€è¦æŠŠæœ‰äº’ç›¸ä¾èµ–çš„pageå†™åœ¨ç¡¬ç›˜ä¸­å¾ˆè¿‘çš„ä½ç½®ã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨è¿™äº›pageçš„æ—¶å€™ï¼Œå¯ä»¥å¾ˆå¿«å®Œæˆç¡¬ç›˜çš„å¯»å€ï¼Œsequantial I/Oè·å¾—è¿™äº›pageã€‚</li>
<li>temporal contral æ—¶é—´æ§åˆ¶: æˆ‘ä»¬éœ€è¦æœ€å¤§åŒ–æ¯ä¸€ä¸ªpageçš„å·¦å³ï¼Œæœ€å°åŒ–èŠ±åœ¨I/Oæ“ä½œä¸Šçš„æ—¶é—´ã€‚</li>
</ul>
<p><br></p>
<p><img data-src="/images/CMU1544564/Lec05/8.jpg" alt="8.jpg"></p>
<ul>
<li>ä¸Šå›¾æˆ‘ä»¬å·²ç»åœ¨<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/#Demo">Lec03 - System Design Goals (in Disk-oriented databases) - Demo</a>è§è¿‡</li>
</ul>
<p><br></p>
<p><img data-src="/images/CMU1544564/Lec05/9.jpg" alt="9.jpg"></p>
<h1 id="Buffer-Pool-Manager"><a href="#Buffer-Pool-Manager" class="headerlink" title="Buffer Pool Manager"></a>Buffer Pool Manager</h1><h2 id="Buffer-Pool-Organization-Demo"><a href="#Buffer-Pool-Organization-Demo" class="headerlink" title="Buffer Pool Organization - Demo"></a>Buffer Pool Organization - Demo</h2><p>å’Œæ“ä½œç³»ç»Ÿä¸­çš„æ¦‚å¿µä¸€æ ·ï¼Œæˆ‘ä»¬å°†ç¡¬ç›˜ä¸Šçš„blockæˆä¸ºpage, å°†å†…å­˜(buffer pool)ä¸­çš„blockç§°ä¸ºframeï¼Œframeå¯ä»¥å®¹çº³pageã€‚</p>
<p><code>pin(int pageid)</code>è¿™ä¸ªå‡½æ•°å°±ä»£è¡¨äº†ä¹‹å‰çš„<code>get page</code>è¿™ä¸ªæ“ä½œã€‚è¿™ä¸ªå‡½æ•°ä¹‹åæˆ‘ä»¬å¯ä»¥è·å¾—ä¸€ä¸ªæŒ‡å‘è¿™ä¸ªpageæ•°æ®çš„æŒ‡é’ˆã€‚æˆ‘ä»¬ä½¿ç”¨å®Œè¿™ä¸ªpageä¹‹åï¼Œéœ€è¦<code>unpin(int pageid)</code>ã€‚</p>
<p>åœ¨ä¸‹é¢3å¼ å›¾ä¸­ï¼š</p>
<ul>
<li>ä¸€å¼€å§‹buffer poolæ˜¯ç©ºçš„</li>
<li>ç„¶åæˆ‘ä»¬<code>pin(pageid 1)</code>, page1è¢«åŠ è½½è¿›å…¥buffer pool</li>
<li>ç„¶åæˆ‘ä»¬<code>pin(pageid 3)</code>, page3è¢«åŠ è½½è¿›å…¥buffer pool</li>
<li>æˆ‘ä»¬ä¼šåœ¨åé¢çœ‹åˆ°ä¸€ä¸ªpage tableï¼Œä»–è´Ÿè´£å‘Šè¯‰æˆ‘ä»¬pageå’Œframeçš„å¯¹åº”ï¼Œä¾‹å¦‚ï¼špage1åœ¨frame1, page3åœ¨frame2</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec05/10.jpg" alt="10.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/11.jpg" alt="11.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/12.jpg" alt="12.jpg"></p>
<p><br></p>
<h2 id="Buffer-Pool-Metadata-Demo"><a href="#Buffer-Pool-Metadata-Demo" class="headerlink" title="Buffer Pool Metadata - Demo"></a>Buffer Pool Metadata - Demo</h2><p>è¿™ä¸ªDemoåŸºäºä¸Šä¸€ä¸ªDemoã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œè®¨è®ºç¼“å­˜åŒºçš„metadata, å®ƒä»¬æ˜¯ç®¡ç†åŒºçš„ç®¡ç†ä¿¡æ¯ã€‚</p>
<ul>
<li>page table (ä¹Ÿå’Œæ“ä½œç³»ç»Ÿä¸­æ¦‚å¿µç±»ä¼¼ï¼Œåªæ˜¯ä¸éœ€è¦MMU, TLB)æ˜¯ä¸€ä¸ªin-memory hashtable, è´Ÿè´£ <code>page id -&gt; frame id</code>çš„æ˜ å°„ï¼Œä¾‹å¦‚ï¼špage1åœ¨frame1, page3åœ¨frame2ã€‚</li>
<li>dirty flage: å‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ªbuffer poolä¸­çš„frameæ˜¯å¦è¢«æ”¹å†™ã€‚å¦‚æœè¢«æ”¹å†™ï¼Œå³pageä¸Šå‡ºç°æ–°æ•°æ®ï¼Œéœ€è¦è¢«å†™å›è‡³ç¡¬ç›˜ã€‚</li>
<li>pin / reference counter: å¯¹ä¸€ä¸ªpageå½“å‰ä½¿ç”¨çš„threadæ•°è¿›è¡Œè®¡æ•°ã€‚æˆ‘ä»¬åªå…è®¸å°†æ­¤æ•°å­—ä¸º0çš„pageå†™å›ç¡¬ç›˜ï¼Œå³å½“å‰æ²¡æœ‰ä»»ä½•threadåœ¨ä½¿ç”¨æ­¤pageã€‚</li>
</ul>
<p>è¿™ä¸ªDemoä¸­å¾ˆç”ŸåŠ¨åœ°è¡¨è¾¾äº†ï¼Œå¦‚ä½•åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå‘buffer poolä¸­åŠ è½½ä¸€ä¸ªæ–°çš„page:</p>
<ul>
<li>é¦–å…ˆæˆ‘ä»¬<code>pin(pageid 2)</code>ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨page tableä¸­æ‰¾ä¸åˆ°å¯¹åº”ï¼Œè¿™æ—¶æ˜¯ä¸€ä¸ªpage fault, è¯´æ˜æˆ‘ä»¬éœ€è¦ä»ç¡¬ç›˜ä¸­åŠ è½½è¿™ä¸ªpage2</li>
<li>è¿™æ—¶æˆ‘ä»¬ç»™page tableä¸Šä¸€ä¸ªglobal latchï¼Œç¡®ä¿æˆ‘ä»¬åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¼šæ”¹å˜è¿™ä¸ªpage table(æ¯”å¦‚åŠ è½½page, ç§»é™¤page)</li>
<li>ç¡®è®¤è·å¾—global latchä¹‹åï¼Œæˆ‘ä»¬å‘buffer poolåŠ è½½è¿™ä¸ªpage2, åŒæ—¶ä¹Ÿæ›´æ–°page tableç­‰metadata</li>
<li>æ•´ä¸ªè¿‡ç¨‹ç»“æŸåï¼Œæˆ‘ä»¬æ¾å¼€global latchã€‚è¿™æ ·æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªæœ‰æˆ‘ä»¬è¿™ä¸ªå½“å‰çº¿ç¨‹æ›´æ”¹äº†page tableã€‚</li>
<li>å…¶ä»–metadataæ˜¯å¦ä¹Ÿéœ€è¦çº¿ç¨‹å®‰å…¨ï¼Œå–å†³äºå…·ä½“å®ç°ã€‚</li>
</ul>
<p><br></p>
<ul>
<li>ä¸Šè¿°ä¸­å¯ä»¥ä¸ç”¨global latchã€‚è€Œåªæ˜¯ç»™å¯¹åº”çš„slotæ¥ä¸€ä¸ªlatchã€‚ä¿è¯åœ¨è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å…¶ä»–äººä¼šè¯»æˆ–è€…å†™è¿™ä¸ªslotã€‚è¿™æ ·ä¾æ—§æ˜¯ä¸€ç§çº¿ç¨‹å®‰å…¨çš„å®ç°ã€‚å¦å¤–ç›¸å¯¹æ€§èƒ½æ›´å¥½ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec05/13.jpg" alt="13.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/14.jpg" alt="14.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/15.jpg" alt="15.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/16.jpg" alt="16.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/17.jpg" alt="17.jpg"></p>
<p><br></p>
<h2 id="Locks-vs-Latches-2"><a href="#Locks-vs-Latches-2" class="headerlink" title="Locks vs. Latches 2"></a>Locks vs. Latches <sup><a href="#fn2">2</a></sup></h2><ul>
<li>locksæ˜¯ä¸€ä¸ªhigh level å¾ˆæŠ½è±¡çš„æ¦‚å¿µ, å®ƒç›´æ¥å’Œtransactionäº‹åŠ¡ç›¸å…³ï¼Œåº”ç”¨äºäº‹åŠ¡çš„lock protocolä¸­ã€‚æ˜¯åº”ç”¨å±‚é¢çš„ã€‚æ˜¯é€»è¾‘å†…å®¹çš„äº’æ–¥ï¼Œæ¯”å¦‚è¡Œï¼Œè¡¨ï¼Œäº‹åŠ¡ã€‚</li>
<li>latchåŸºæœ¬ä¸Šå’Œlow levelå®ç°ç›¸å…³ï¼ŒæŒ‡<code>std::mutex</code>è¿™ç±»å’Œä»£ç ç›¸å…³çš„ç±»(class)ï¼Œæ¥ä¿æŠ¤ä»£ç ä¸­çš„critical sectionã€‚æ˜¯åº”ç”¨ä¸å¯è§çš„ï¼Œå†…éƒ¨æ•°æ®çš„äº’æ–¥ã€‚</li>
<li>(è¿™éƒ¨åˆ†æˆ‘ä»¬ä»¥åè¿˜ä¼šæåˆ°)<!-- TODO: --></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec05/18.jpg" alt="18.jpg"></p>
<h2 id="Page-Table-vs-Page-Directory"><a href="#Page-Table-vs-Page-Directory" class="headerlink" title="Page Table vs. Page Directory"></a>Page Table vs. Page Directory</h2><ul>
<li>åœ¨<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/#Page-Directory">[CMU-15445]Lec03 - Database Storage - Database Heap - Page Directory</a>æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»æåˆ°äº† page directory, å®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„page, è®°å½•äº†pageå¯¹åº”æ–‡ä»¶çš„ä½ç½®ï¼Œå› æ­¤è¿™ä¸ªpage directoryä¹Ÿä¼šä»¥pageçš„æ–¹å¼ä»ç¡¬ç›˜è¯»å–åˆ°å†…å­˜ï¼Œæœ€åä»å†…å­˜å†™å›è‡³ç¡¬ç›˜ã€‚å³å®ƒæ˜¯æŒä¹…åŒ–çš„(persistent, durable)ã€‚</li>
<li>page table åªæ˜¯ä¸€ä¸ª<code>page id -&gt; frame id</code>çš„æ˜ å°„, å…·ä½“æ˜¯ä¸€ä¸ª<code>page id -&gt; frame pointer</code>çš„hash tableï¼ŒæŒ‡é’ˆçš„ä½ç½®åªæ˜¯åœ¨æœ¬æ¬¡å¯åŠ¨æœ‰æ•ˆï¼Œå› ä¸ºå…³æœºé‡å¯åï¼Œæˆ‘ä»¬ä¼šallocateå¦ä¸€å—å†…å­˜åŒºåŸŸç»™æ•°æ®åº“buffer poolã€‚è¿™ç±»å®Œå…¨ä¾èµ–å†…å­˜çš„æ•°æ®ç»“æ„(in-memory data structure)æ²¡æœ‰æ„ä¹‰å»å­˜åˆ°ç¡¬ç›˜ä¸Šã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec05/19.jpg" alt="19.jpg"></p>
<h2 id="Allocation-Policies"><a href="#Allocation-Policies" class="headerlink" title="Allocation Policies"></a>Allocation Policies</h2><ul>
<li>global policies: æŒ‡æ‰€æœ‰query, transactionä½¿ç”¨åŒä¸€ä¸ªbuffer poolçš„replacement policy</li>
<li>local policies: æŒ‡æ¯ä¸€ä¸ªquery, transactionå¯ä»¥æœ‰ä¸€ä¸ªè‡ªå·±çš„buffer poolï¼Œ å’Œè‡ªå·±çš„replacement policyã€‚åŒæ—¶å¯ä»¥åœ¨ä¸€ä¸ªå…±æœ‰çš„buffer poolå»share pages</li>
<li>å®é™…ä¸Šä¼šæ··åˆè¿™ä¸¤ç§ä¸»æ„ï¼Œ æ¯”å¦‚æ•°æ®tableæ‹¥æœ‰ä¸€ä¸ªbuffer pool, index(ç´¢å¼•æ•°æ®ç»“æ„)æ‹¥æœ‰å¦ä¸€ä¸ªbuffer poolã€‚è¿™ä¸ªæˆ‘ä»¬ä¼šåœ¨indexçš„è¯¾ä¸Šæåˆ°ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec05/20.jpg" alt="20.jpg"></p>
<p><br><br><br></p>
<h1 id="Buffer-Pool-Optimizations"><a href="#Buffer-Pool-Optimizations" class="headerlink" title="Buffer Pool Optimizations"></a>Buffer Pool Optimizations</h1><p><img data-src="/images/CMU1544564/Lec05/21.jpg" alt="21.jpg"></p>
<h2 id="Multiple-Buffer-Pools"><a href="#Multiple-Buffer-Pools" class="headerlink" title="Multiple Buffer Pools"></a>Multiple Buffer Pools</h2><p>è§<a href="#allocation-policies">Allocation Policies</a>ä¸­æåˆ°äº†éƒ¨åˆ†Local Policiesã€‚</p>
<p><img data-src="/images/CMU1544564/Lec05/22.jpg" alt="22.jpg"></p>
<p>å¦å¤–è¿™éƒ¨åˆ†ä¸çŸ¥é“ä¸ºä½•æ²¡æœ‰è¯¾ä»¶ï¼Œ æˆ‘æˆªå›¾äº†è§†é¢‘æ¥ä½œä¸ºç¼ºå¤±çš„è¯¾ä»¶ã€‚</p>
<ul>
<li>Approach2 Hashing: ç”¨ä¸€ä¸ªhash function: <code>RID -&gt; buffer pool id</code>, æŠŠæœ‰ç›¸åŒhash valueçš„tupleåˆ†é…åˆ°åŒä¸€ä¸ªbuffer poolï¼Œæé«˜buffer poolä¸­çš„spatial locality(ç©ºé—´å±€éƒ¨æ€§)ã€‚(ç±»ä¼¼hash join)</li>
</ul>
<p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/missing_1.png" alt="Lec5_missing_1.jpg"></p>
<p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/missing_2.png" alt="Lec5_missing_2.jpg"></p>
<p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/missing_3.png" alt="Lec5_missing_3.jpg"></p>
<h2 id="Pre-Fetching"><a href="#Pre-Fetching" class="headerlink" title="Pre-Fetching"></a>Pre-Fetching</h2><p>æˆ‘ä»¬å¯ä»¥é¢„åŠ è½½ä¸€äº›page, ä¸€ä¸ªthreadåœ¨å¯¹page Aè¿›è¡Œæ‰«æè®¡ç®—çš„åŒæ—¶ï¼Œå¦å¤–ä¸€ä¸ªthreadå¯ä»¥å°†ä¸‹ä¸€ä¸ªpage BåŠ è½½åˆ°buffer poolä¸­ã€‚è¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯ç”¨çŒœæµ‹æˆ–è€…é¢„å…ˆçš„åªæ˜¯ï¼Œå»åŠ è½½æœªæ¥å¯èƒ½ç”¨å¾—åˆ°çš„page, æœ€ç»ˆç›®çš„å‡å°‘ä»ç¡¬ç›˜åŠ è½½çš„æ—¶é—´ã€‚å…·ä½“æœ‰ä¸¤ç§æƒ…å†µï¼Œæ ¹æ®è¿™ä¸ª<strong>ä¸‹ä¸€ä¸ªpage</strong>æ˜¯å“ªä¸€ä¸ª:</p>
<ul>
<li>Sequential Scans: å³ç‰©ç†ä¸Šè¿ç»­å­˜å‚¨çš„ä¸‹ä¸€ä¸ªpage</li>
<li>Index Scans: </li>
</ul>
<h3 id="Sequential-Scans"><a href="#Sequential-Scans" class="headerlink" title="Sequential Scans"></a>Sequential Scans</h3><p><img data-src="/images/CMU1544564/Lec05/23.jpg" alt="23.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/24.jpg" alt="24.jpg"></p>
<p>Q1åœ¨æ‰«æpage1çš„æ—¶å€™ï¼Œbuffer pool managerå‘ç°è¿™æ˜¯ä¸€ä¸ªsequenial scanï¼Œå†³å®špre fetchåé¢çš„pageï¼Œæ‰€ä»¥åœ¨åŒæ—¶å°†page2,3åŠ è½½è¿›buffer poolã€‚ç†æƒ³çš„è¯ï¼Œç­‰Q1ç»“æŸå¯¹page1çš„æ‰«æï¼Œpage2,3å°±å·²ç»åœ¨buffer poolï¼Œç›¸å½“äºæ²¡æœ‰æ”¶åˆ°page faultçš„å½±å“ï¼Œæ²¡æœ‰æµªè´¹æ—¶é—´ç­‰å¾…ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec05/25.jpg" alt="25.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/26.jpg" alt="26.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/27.jpg" alt="27.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/28.jpg" alt="28.jpg"></p>
<h3 id="Index-Scans"><a href="#Index-Scans" class="headerlink" title="Index Scans"></a>Index Scans</h3><p>è¿™é‡Œçš„indexæ˜¯ä¸€ä¸ªB+ Treeï¼Œ å…·ä½“ä½œæ³•æ˜¯ä»æ ¹èŠ‚ç‚¹æŸ¥æ‰¾è‡³å¶å­èŠ‚ç‚¹ï¼Œå†æ°´å¹³éå†æœ‰å…³çš„å¶å­èŠ‚ç‚¹ã€‚è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦çš„pageä¸ä¸€å®šæ˜¯ç‰©ç†ä¸Šè¿ç»­å­˜å‚¨çš„ï¼š</p>
<p><img data-src="/images/CMU1544564/Lec05/29.jpg" alt="29.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/30.jpg" alt="30.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/31.jpg" alt="31.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/32.jpg" alt="32.jpg"></p>
<p><br></p>
<p>ä¸‹å›¾ä¸­å¾ˆæ˜æ˜¾è¡¨è¾¾ï¼Œæˆ‘ä»¬æ¥ä¸‹é¢éœ€è¦çš„æ˜¯page3å’Œpage5, å®ƒä»¬ä¸æ˜¯è¿ç»­çš„ï¼Œä¹Ÿä¸ç´§è·Ÿåœ¨page1(å½“å‰page)ä¹‹åã€‚ ä½†æ˜¯indexè¿™ä¸ªæ•°æ®ç»“æ„å‘Šè¯‰æˆ‘ä»¬ï¼Œä¸‹ä¸€æ­¥æ˜¯page3å’Œpage5è¢«éœ€è¦ï¼Œå› æ­¤å»pre fetchå®ƒä»¬ä¿©ã€‚è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ä¾‹å­ï¼Œæ“ä½œç³»ç»Ÿåœ¨è¿™ä¸€ç‚¹å¸®ä¸äº†æˆ‘ä»¬ï¼Œæ“ä½œç³»ç»Ÿæœ€å¤šèƒ½å¸®æˆ‘ä»¬pre fetchè¿ç»­çš„pageï¼Œä½†æ˜¯å®ƒä¸çŸ¥é“indexçš„å­˜åœ¨ï¼Œæ²¡æœ‰åŠæ³•å¸®åŠ©æˆ‘ä»¬å‡†ç¡®å»å¾—åˆ°page3å’Œpage5ï¼š<br><img data-src="/images/CMU1544564/Lec05/33.jpg" alt="33.jpg"></p>
<h2 id="Scan-Sharing"><a href="#Scan-Sharing" class="headerlink" title="Scan Sharing"></a>Scan Sharing</h2><ul>
<li>Scan Sharing: reuse data retrieved from storage or operator computationsï¼Œ å³ä½¿ç”¨å…¶ä»–æ­£åœ¨è¿è¡Œçš„queryçš„ä¸­é—´è¿‡ç¨‹å€¼</li>
<li>result caching: åªæ˜¯ç¼“å­˜æœ€ç»ˆç»“æœå€¼ï¼Œè€Œä¸æ˜¯ä¸­é—´è¿‡ç¨‹å€¼</li>
</ul>
<p>å…·ä½“æµç¨‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªQueryå·²ç»åœ¨è¿è¡Œï¼Œæœ‰ä¸€äº›ä¸­é—´è¿‡ç¨‹å€¼</li>
<li>ç¬¬äºŒä¸ªQueryå¼€å§‹è¿è¡Œï¼ŒDBMSå‘ç°è¿™ç¬¬äºŒä¸ªQueryå¯ä»¥å…¬ç”¨ç¬¬ä¸€ä¸ªQueryçš„å€¼ï¼Œè€Œä¸”å®ƒä»¬ä¿©éœ€è¦æ‰«æçš„èŒƒå›´ä¸€æ ·ã€‚</li>
<li>DBMSå°†ç¬¬äºŒä¸ªQuery attchè¿›ç¬¬ä¸€ä¸ªQuery, è®°å½•ä¸‹ç¬¬äºŒä¸ªQueryè¢«attachçš„åœ°æ–¹, è®©å®ƒä»¬ä¿©ä¸€èµ·æ‰«æã€‚</li>
<li>ç­‰å®ƒä»¬ä¿©å…±åŒæ‰«æç»“æŸåï¼Œå†æ‰«æä¸€å¼€å§‹ç¬¬äºŒä¸ªQueryè·³è¿‡çš„åœ°æ–¹ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec05/34.jpg" alt="34.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/35.jpg" alt="35.jpg"></p>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>Q1éœ€è¦æ‰«ææ‰€æœ‰çš„page, å°†valä¸æ–­ç´¯åŠ ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec05/36.jpg" alt="36.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/37.jpg" alt="37.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/38.jpg" alt="38.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/39.jpg" alt="39.jpg"></p>
<p><br><br><br></p>
<p>åœ¨Q1æ‰«æè‡³page3çš„æ—¶å€™ï¼ŒQ2åŠ å…¥ã€‚å¾ˆå·§ï¼ŒQ2ä¹Ÿéœ€è¦æ‰«ææ‰€æœ‰çš„page, å°†valä¸æ–­ç´¯åŠ ã€‚è¿™è¯´æ˜Q2å·²åŠ å…¥å°±å¯ä»¥ä½¿ç”¨Q1çš„ä¸­é—´ç»“æœï¼Œå¹¶ä¸”å¯ä»¥å’ŒQ1ç»“åˆåœ¨ä¸€èµ·æ‰«æå‰©ä¸‹çš„pageï¼š<br><img data-src="/images/CMU1544564/Lec05/40.jpg" alt="40.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/41.jpg" alt="41.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/42.jpg" alt="42.jpg"></p>
<p><br><br><br></p>
<p>Q1ç»“æŸåï¼Œ è¿™ä¸ªä¾‹å­ä¸­ï¼ŒQ2è¿˜éœ€è¦æ‰«æå®ƒæ²¡æœ‰æ‰«æè¿‡çš„pageï¼Œ å› ä¸ºQ2è®¡ç®—å¹³å‡å€¼ï¼Œ éœ€è¦çŸ¥é“æ¯ä¸€ä¸ªpageä¸Štupleçš„ä¸ªæ•°ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec05/43.jpg" alt="43.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/44.jpg" alt="44.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/45.jpg" alt="45.jpg"></p>
<p>æˆ‘ä»¬ä¹Ÿæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰scan sharingè¿™ä¸ªfeatureï¼Œ Q1å’ŒQ2ç›¸äº’ç«äº‰buffer poolä¼šå¯¼è‡´è¿™ä¸¤ä¸ªQueryæ€§èƒ½éƒ½å¾ˆå·®ã€‚</p>
<h2 id="Buffer-Pool-Bypass"><a href="#Buffer-Pool-Bypass" class="headerlink" title="Buffer Pool Bypass"></a>Buffer Pool Bypass</h2><p>sequantial scanä¼šå°†å¤§éƒ¨åˆ†pageåŠ è½½è¿›buffer pool, è€Œè¿™äº›pageåˆå¹¶ä¸ä¸€å®šåœ¨æœªæ¥ä¼šè¢«é‡å¤åˆ©ç”¨ã€‚å¯¹è¿™ç§sequantial scançš„Queryï¼Œæˆ‘ä»¬å¯ä»¥å•ç‹¬ç»™allocateä¸€å—å†…å­˜åŒºåŸŸï¼Œè€Œç‹¬ç«‹äºä¸”ä¸å½±å“buffer poolã€‚è¿™ä¸€å—ä¸“å±çš„å†…å­˜åŒºåŸŸä¾ç„¶èƒ½ä¿è¯å¯¹å½“å‰Queryçš„æ€§èƒ½ï¼Œè€Œä¸”å› ä¸ºä¸ä¼š<em>æ‰“ä¹±æ±¡æŸ“</em>buffer poolè€Œå½±å“å…¶ä»–Queryçš„æ€§èƒ½ã€‚è¿™å—å†…å­˜åŒºåŸŸä¼šåœ¨è¯¥sequantial scan Queryç»“æŸåè¢«é‡Šæ”¾ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec05/46.jpg" alt="46.jpg"></p>
<ul>
<li>Light Scans: <span class="exturl" data-url="aHR0cHM6Ly93d3cuaWJtLmNvbS9zdXBwb3J0L2tub3dsZWRnZWNlbnRlci9lbi9TU0dVOEdfMTIuMS4wL2NvbS5pYm0ucGVyZi5kb2MvaWRzX3ByZl8yMzcuaHRt" title="https://www.ibm.com/support/knowledgecenter/en/SSGU8G_12.1.0/com.ibm.perf.doc/ids_prf_237.htm">https://www.ibm.com/support/knowledgecenter/en/SSGU8G_12.1.0/com.ibm.perf.doc/ids_prf_237.htm<i class="fa fa-external-link"></i></span></li>
</ul>
<p><br></p>
<h2 id="OS-Page-Cache"><a href="#OS-Page-Cache" class="headerlink" title="OS Page Cache"></a>OS Page Cache</h2><p><img data-src="/images/CMU1544564/Lec05/47.jpg" alt="47.jpg"></p>
<ul>
<li>O_DIRECT: <span class="exturl" data-url="aHR0cHM6Ly9saW51eC5kaWUubmV0L21hbi8yL29wZW4=" title="https://linux.die.net/man/2/open">https://linux.die.net/man/2/open<i class="fa fa-external-link"></i></span></li>
<li>å¤§éƒ¨åˆ†DBMS<strong>ä½¿ç”¨direct I/O</strong>ï¼Œçœå»æ–‡ä»¶è¢«åŠ è½½å…¥æ“ä½œç³»ç»Ÿæ–‡ä»¶ç¼“å­˜åŒºã€‚direct I/Oå¯ä»¥ç›´æ¥è®²æ–‡ä»¶è¯»å–åˆ°æ•°æ®åº“ç¼“å­˜åŒºçš„address spaceã€‚çœå»äº†ä»æ“ä½œç³»ç»Ÿç¼“å­˜åŒºå¤åˆ¶è¿›æ•°æ®åº“ç¼“å­˜åŒºçš„address spaceï¼Œè¿™æ ·æ€§èƒ½ä¹Ÿæ›´å¥½ã€‚æ›´å¤šè§<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/#mmap">[CMU-15445]Lec03 - Why not use the OS? - mmap</a></li>
<li>ä¹Ÿæœ‰å…¶ä»–çš„DBMS<strong>ä¸ä½¿ç”¨direct I/O</strong>ï¼Œ æ¯”å¦‚PostgreSQLã€‚å®ƒä»¬ä»å·¥ç¨‹çš„è§’åº¦è§‰å¾—ä¸ä½¿ç”¨direct I/Oæ›´å¥½ï¼šæ•°æ®åº“buffer poolå‡ºç°page faultçš„æ—¶å€™ï¼Œå¦‚æœå¯¹åº”çš„pageåœ¨æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç¼“å­˜åŒºä¸­ï¼Œé‚£è¿™æ—¶å€™åªéœ€è¦ä¸€æ¬¡å†…å­˜ä¸­çš„å¤åˆ¶(ä»æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç¼“å­˜åŒºå¤åˆ¶åˆ°æ•°æ®åº“buffer pool)ï¼Œè€Œä¸æ˜¯å»ç¡¬ç›˜åšæ¼«é•¿çš„I/Oã€‚æ¯”å¦‚PostgreSQLé‡å¯åbuffer poolæ˜¯ç©ºçš„ï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿçš„page cacheä»¥åŠè¿˜æ˜¯æœ‰å¯¹åº”æ–‡ä»¶ï¼Œè¿™æ—¶å€™å¯ä»¥ä»page cacheä¸­å¤åˆ¶ï¼Œé¿å…å†·å¯åŠ¨ã€‚</li>
</ul>
<p>è¯¾ä¸Šçš„PostgreSQLå®éªŒ, è§<a href="https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/">[DBMS][PostgreSQL] ç¼“å­˜åŒºç®¡ç† BufferPool</a></p>
<p><br></p>
<h2 id="Buffer-Replacement-Policies"><a href="#Buffer-Replacement-Policies" class="headerlink" title="Buffer Replacement Policies"></a>Buffer Replacement Policies</h2><p>è¿™éƒ¨åˆ†ä¸­çš„ç†è®ºå’Œæ“ä½œç³»ç»Ÿä¸­çš„é¡µæ›¿æ¢æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec05/48.jpg" alt="48.jpg"></p>
<h3 id="Lest-Recently-Used-LRU"><a href="#Lest-Recently-Used-LRU" class="headerlink" title="Lest Recently Used (LRU)"></a>Lest Recently Used (LRU)</h3><p><img data-src="/images/CMU1544564/Lec05/49.jpg" alt="49.jpg"></p>
<h3 id="Clock"><a href="#Clock" class="headerlink" title="Clock"></a>Clock</h3><p>LRUéœ€è¦è·å–çœŸçš„timestampï¼Œã€€è€Œæ— è®ºè·å–software timeræˆ–è€…hardware timeréƒ½æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œéœ€è¦å¾ˆå¤šCPUå‘¨æœŸã€‚æ‰€æœ‰æˆ‘ä»¬é€‰ç”¨Clock, å®ƒæ˜¯LRUçš„ä¸€ä¸ªè¿‘ä¼¼(approximation), å®ƒå°±å»é™¤äº†æ¯ä¸€ä¸ªpageçš„timestampå±æ€§ã€‚è€ŒClockä½¿ç”¨ä¸€ä¸ªä¸å‡†ç¡®çš„æ—¶é—´åŒºé—´, å³referenceè‡³é¡ºæ—¶é’ˆè¢«é€‰æ‹©ã€‚å…·ä½“æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹é¢çš„Demo:</p>
<p>ä¸‹å›¾æˆ‘ä»¬è®¿é—®page1, å®ƒåœ¨æˆ‘ä»¬buffer poolä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°è¿™ä¸ªpage, ä¹Ÿè®©å®ƒçš„refï¼1:<br><img data-src="/images/CMU1544564/Lec05/50.jpg" alt="50.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/51.jpg" alt="51.jpg"></p>
<p><br><br><br></p>
<p>ç„¶åæˆ‘ä»¬éœ€è¦åŠ è½½ä¸€ä¸ªæ–°çš„page5,ã€€è¦å»é™¤ä¸€ä¸ªbuffer poolä¸­çš„pageã€‚æŒ‡é’ˆæŒ‡å‘çš„page1çš„ref=1, å®ƒå¯ä»¥ç•™åœ¨buffer pool, å¹¶ä¸”ref=0, æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªpage:</p>
<p><img data-src="/images/CMU1544564/Lec05/52.jpg" alt="52.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/53.jpg" alt="53.jpg"></p>
<p><br><br><br></p>
<p>æŒ‡é’ˆæŒ‡å‘çš„page2çš„ref=0, å®ƒä¸å¯ä»¥ç•™åœ¨buffer poolï¼š</p>
<p><img data-src="/images/CMU1544564/Lec05/54.jpg" alt="54.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/55.jpg" alt="55.jpg"></p>
<p><br><br><br></p>
<h3 id="Problem-Sequential-Flooding-é¡ºåºæ³›æ´ª"><a href="#Problem-Sequential-Flooding-é¡ºåºæ³›æ´ª" class="headerlink" title="Problem - Sequential Flooding é¡ºåºæ³›æ´ª"></a>Problem - Sequential Flooding é¡ºåºæ³›æ´ª</h3><p>LRUå’ŒClockå®¹æ˜“æ”¶åˆ°Sequential Floodingçš„å½±å“ã€‚Sequential Floodingæˆ‘ä»¬ä¹‹å‰ä¹Ÿé—´æ¥çš„æåˆ°è¿‡ï¼Œä¸€ä¸ªQueryå¦‚æœéœ€è¦æ‰«ææ‰€æœ‰çš„page, buffer poolä¼šå› ä¸ºå®ƒçš„å˜å¾—å¾ˆä¹±ï¼Œè€Œæœ€åç•™åœ¨buffer poolä¸­çš„pageä¹Ÿä¸ä¸€å®šå¯¹æœªæ¥çš„Queryæœ‰å¸®åŠ©ã€‚è¿™é‡Œæˆ‘ä»¬æ›´ä¸¥è°¨å®šä¹‰è¿™ä¸ªè¡Œä¸ºå«Sequential Floodingï¼Œæœ€åç•™åœ¨buffer poolä¸­çš„pageæ˜¯æœ€è¿‘è¢«ä½¿ç”¨è¿‡çš„(least recently used)ï¼Œã€€ä½†æ˜¯å®ƒä»¬å®é™…ä¸Šæ˜¯æœ€ä¸éœ€è¦çš„(most unneeded)ã€‚(è¿™äº›pageå¾€å¾€æ˜¯ç¡¬ç›˜ä¸Šæœ€åå‡ ä¸ªpage)</p>
<p><img data-src="/images/CMU1544564/Lec05/58.jpg" alt="58.jpg"></p>
<p><br></p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªDemoã€‚ä¸‹é¢è¿™ä¸ªDemoä¸­çš„é—®é¢˜å¯ä»¥æ¢ä¸€ä¸ªæ€è·¯è§£å†³ï¼šæ¯æ¬¡æŠŠQ2å¸¦è¿›æ¥çš„pageä¸­page idæœ€å¤§çš„èˆå¼ƒã€‚</p>
<p><img data-src="/images/CMU1544564/Lec05/59.jpg" alt="59.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/60.jpg" alt="60.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/61.jpg" alt="61.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/62.jpg" alt="62.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/63.jpg" alt="63.jpg"></p>
<h3 id="LRU-K-1"><a href="#LRU-K-1" class="headerlink" title="LRU-K 1"></a>LRU-K <sup><a href="#fn1">1</a></sup></h3><p>LRU-Kä¸­çš„<code>K</code>ä»£è¡¨<strong>æœ€è¿‘ä½¿ç”¨çš„æ¬¡æ•°</strong>ï¼Œå› æ­¤LRUå¯ä»¥è®¤ä¸ºæ˜¯LRU-1ã€‚LRU-Kçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³LRUç®—æ³•â€ç¼“å­˜æ±¡æŸ“â€çš„é—®é¢˜ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†â€œæœ€è¿‘ä½¿ç”¨è¿‡1æ¬¡â€çš„åˆ¤æ–­æ ‡å‡†<strong>æ‰©å±•ä¸ºâ€œæœ€è¿‘ä½¿ç”¨è¿‡Kæ¬¡â€</strong>ã€‚</p>
<p>ç›¸æ¯”LRUï¼ŒLRU-Kéœ€è¦å¤šç»´æŠ¤<strong>ä¸€ä¸ªé˜Ÿåˆ—: ç¼“å­˜é˜Ÿåˆ—ã€‚å®ƒç”¨äºè®°å½•æ‰€æœ‰ç¼“å­˜æ•°æ®è¢«è®¿é—®çš„å†å²ã€‚åªæœ‰å½“æ•°æ®çš„è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡çš„æ—¶å€™ï¼Œæ‰å°†æ•°æ®æ”¾å…¥ç¼“å­˜é˜Ÿåˆ—</strong>ã€‚å½“éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼ŒLRU-Kä¼šæ·˜æ±°ç¬¬Kæ¬¡è®¿é—®æ—¶é—´è·å½“å‰æ—¶é—´æœ€å¤§çš„æ•°æ®ã€‚è¯¦ç»†å®ç°å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ•°æ®ç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼ŒåŠ å…¥åˆ°è®¿é—®<strong>å†å²é˜Ÿåˆ—</strong></li>
<li>å¦‚æœæ•°æ®åœ¨è®¿é—®<strong>å†å²é˜Ÿåˆ—</strong>é‡Œåæ²¡æœ‰è¾¾åˆ°Kæ¬¡è®¿é—®ï¼Œåˆ™æŒ‰ç…§ä¸€å®šè§„åˆ™(FIFOï¼ŒLRU)æ·˜æ±°</li>
<li>å½“è®¿é—®<strong>å†å²é˜Ÿåˆ—</strong>ä¸­çš„æ•°æ®è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡åï¼Œå°†æ•°æ®ç´¢å¼•ä»<strong>å†å²é˜Ÿåˆ—</strong>åˆ é™¤ï¼Œå°†æ•°æ®ç§»åˆ°<strong>ç¼“å­˜é˜Ÿåˆ—</strong>ä¸­ï¼Œå¹¶ç¼“å­˜æ­¤æ•°æ®ï¼Œ<strong>ç¼“å­˜é˜Ÿåˆ—</strong>é‡æ–°æŒ‰ç…§æ—¶é—´æ’åº</li>
<li><strong>ç¼“å­˜é˜Ÿåˆ—</strong>ä¸­è¢«å†æ¬¡è®¿é—®åï¼Œé‡æ–°æ’åº</li>
<li>éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œæ·˜æ±°<strong>ç¼“å­˜é˜Ÿåˆ—</strong>ä¸­æ’åœ¨æœ«å°¾çš„æ•°æ®ï¼Œå³æ·˜æ±°â€å€’æ•°ç¬¬Kæ¬¡è®¿é—®ç¦»ç°åœ¨æœ€ä¹…â€çš„æ•°æ®</li>
</ol>
<p>LRU-Kå…·æœ‰LRUçš„ä¼˜ç‚¹ï¼ŒåŒæ—¶èƒ½å¤Ÿé¿å…LRUçš„ç¼ºç‚¹ï¼Œå®é™…åº”ç”¨ä¸­LRU-2æ˜¯ç»¼åˆå„ç§å› ç´ åæœ€ä¼˜çš„é€‰æ‹©ï¼ŒLRU-3æˆ–è€…æ›´å¤§çš„Kå€¼å‘½ä¸­ç‡ä¼šé«˜ï¼Œä½†é€‚åº”æ€§å·®ï¼Œéœ€è¦å¤§é‡çš„æ•°æ®è®¿é—®æ‰èƒ½å°†å†å²è®¿é—®è®°å½•æ¸…é™¤æ‰ã€‚</p>
<p>å¦å¤–LRU-Kå¯¹sequential scan<strong>ä¸æ•æ„Ÿ</strong>ï¼Œå› ä¸ºsequential scanåªä½¿ç”¨æ¯ä¸ªpageä¸€æ¬¡ã€‚è€Œä½¿ç”¨ä¸€æ¬¡çš„pageåœ¨LRU-Kéå¸¸å®¹æ˜“è¢«evictã€‚</p>
<!-- TODO: TUM ModernDBS -->
<p><img data-src="/images/CMU1544564/Lec05/64.jpg" alt="64.jpg"></p>
<h3 id="Localization"><a href="#Localization" class="headerlink" title="Localization"></a>Localization</h3><p>è¿™éƒ¨åˆ†å·²ç»åœ¨è¿™è¯¾ä¸­çš„å®éªŒä¸­ä½“ç°äº†ï¼šPostgreSQLç»™æ¯ä¸€ä¸ªQueryä¸€ä¸ªç‹¬ç«‹çš„buffer poolï¼Œ åŒæ—¶æ‰€æœ‰Queryå…¬ç”¨ä¸€ä¸ªshared buffer poolã€‚è¿™æœ€å¤§é™åº¦åœ°å‡å°‘äº†æ¯ä¸ªqueryå¯¹buffer poolçš„æ±¡æŸ“ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec05/65.jpg" alt="65.jpg"></p>
<h3 id="Priority-Hints"><a href="#Priority-Hints" class="headerlink" title="Priority Hints"></a>Priority Hints</h3><p>DBMSçŸ¥é“å“ªäº›pageæ¯”è¾ƒé‡è¦ï¼Œç»å¸¸è®¿é—®ï¼Œæ‰“ä¸Šæ ‡ç­¾ã€‚<sup><a href="#fn2">2</a></sup></p>
<p><img data-src="/images/CMU1544564/Lec05/67.jpg" alt="67.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/68.jpg" alt="68.jpg"></p>
<h2 id="Dirty-Pages"><a href="#Dirty-Pages" class="headerlink" title="Dirty Pages"></a>Dirty Pages</h2><p>åªæœ‰è¢«æ›´æ”¹è¿‡çš„pageæ‰æœ‰å¿…è¦å†™å›ç¡¬ç›˜ï¼ŒæŒä¹…åŒ–ã€‚</p>
<p>DBMSå¯ä»¥å®šæœŸéå†page tableå¹¶å°†è„é¡µå†™å›ç¡¬ç›˜ã€‚å› ä¸ºå¦‚æœæ¯æ¬¡ç­‰evictionçš„æ—¶å€™å†å»flushè„é¡µï¼Œä¼šè®©evictionçš„è¿‡ç¨‹éå¸¸çš„æ…¢ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šæœ‰ä¸ªåå°è¿›ç¨‹å®šæœŸæ‰¹é‡çš„å»å†™å›è„é¡µã€‚<sup><a href="#fn2">2</a></sup>å½“å®‰å…¨åœ°å†™ä¼šè„é¡µä¹‹åï¼ŒDBMSå¯ä»¥evicté¡µé¢æˆ–è€…åªæ˜¯å–æ¶ˆè®¾ç½®dirty bit, å› ä¸ºè¿™ä¸ªé¡µé¢å·²ç»<strong>ä¸å†è„äº†</strong>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å†™æ—¥å¿—è®°å½•ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸ä¼šå»å†™è„é¡µã€‚<sup><a href="#fn1">1</a></sup></p>
<p><img data-src="/images/CMU1544564/Lec05/69.jpg" alt="69.jpg"></p>
<h2 id="Background-Writing"><a href="#Background-Writing" class="headerlink" title="Background Writing"></a>Background Writing</h2><p>æˆ‘ä»¬éœ€è¦æ§åˆ¶pageè¢«å†™å›ç¡¬ç›˜çš„æ—¶é—´ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>mmap</code>,å°±å¾ˆéš¾æ§åˆ¶æ¯ä¸€ä¸ªpageå†™å›çš„æ—¶é—´ç‚¹ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec05/70.jpg" alt="70.jpg"></p>
<h2 id="Other-Memory-Pool"><a href="#Other-Memory-Pool" class="headerlink" title="Other Memory Pool"></a>Other Memory Pool</h2><p><img data-src="/images/CMU1544564/Lec05/71.jpg" alt="71.jpg"></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><img data-src="/images/CMU1544564/Lec05/72.jpg" alt="72.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec05/80.jpg" alt="80.jpg"></p>
<p>å¼•ç”¨:</p>
<p><a name="fn1">1</a>: CMU 15445 4. ç¼“å­˜å±‚ - è¥¿éƒ¨å°ç¬¼åŒ…: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wODUxNDIxZjRjYjg=" title="https://www.jianshu.com/p/0851421f4cb8">https://www.jianshu.com/p/0851421f4cb8<i class="fa fa-external-link"></i></span></p>
<p><a name="fn2">2</a>: Database Storage - fxjwind: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9wLzEwODE4ODE0Lmh0bWw=" title="https://www.cnblogs.com/fxjwind/p/10818814.html">https://www.cnblogs.com/fxjwind/p/10818814.html<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>Storage</category>
        <category>Buffer Management</category>
      </categories>
      <tags>
        <tag>Page</tag>
        <tag>Buffer Pool</tag>
        <tag>LRU</tag>
        <tag>Clock</tag>
      </tags>
  </entry>
  <entry>
    <title>[DBMS][PostgreSQL]ç¼“å­˜åŒºç®¡ç†BufferPool</title>
    <url>/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/</url>
    <content><![CDATA[<p>è¿™ç¯‡æ–‡ç« æœåŠ¡äº<a href="https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/">[CMU-15445]Lec05</a></p>
<p>æˆ‘ä»¬æ²¿ç”¨ä¸Šä¸€ä¸ªå®éªŒçš„æ•°æ®é›†å’Œæ•°æ®åº“:</p>
<ul>
<li>ä¸Šä¸€ä¸ªå®éªŒï¼Œè§<a href="https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/">[DBMS]Postgresæµ®ç‚¹æ•°ï¼Œå®šç‚¹æ•°ç²¾åº¦é—®é¢˜ precision_numbers</a></li>
<li>å…·ä½“æ•°æ®é›†ï¼Œè§<a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#CMU-15445-%E5%88%86%E6%95%B0%E6%95%B0%E6%8D%AE%E9%9B%86-Mock">[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›†: CMU-15445 åˆ†æ•°æ•°æ®é›† (Mock)</a></li>
</ul>
<p>è¿™ä¸ªå®éªŒçš„ç›®çš„æ˜¯è§‚å¯ŸPostgreSQL: </p>
<ul>
<li>buffer poolå¯¹Queryæ€§èƒ½çš„å½±å“,</li>
<li>æ“ä½œç³»ç»Ÿæ–‡ä»¶ç¼“å­˜åŒºå¯¹Queryåœ¨page faultçš„å½±å“ï¼Œå› ä¸ºPostgreSQLä¸ä½¿ç”¨direct I/O</li>
</ul>
<a id="more"></a>
<hr>
<h1 id="æ¸…ç©ºæ“ä½œç³»ç»Ÿ-pagecache-dentries-and-inodes"><a href="#æ¸…ç©ºæ“ä½œç³»ç»Ÿ-pagecache-dentries-and-inodes" class="headerlink" title="æ¸…ç©ºæ“ä½œç³»ç»Ÿ pagecache, dentries and inodes"></a>æ¸…ç©ºæ“ä½œç³»ç»Ÿ pagecache, dentries and inodes</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            15G        9.8G        2.3G        1.9G        3.2G        3.3G</span><br><span class="line">Swap:          2.0G        1.4G        643M</span><br><span class="line">$ sync; <span class="built_in">echo</span> 3 | sudo tee /proc/sys/vm/drop_caches</span><br><span class="line">3</span><br><span class="line">$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            15G        9.9G        3.0G        1.8G        2.5G        3.3G</span><br><span class="line">Swap:          2.0G        1.4G        579M</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>free -h</code> å¯ä»¥æ˜¾ç¤ºç³»ç»Ÿç©ºé—²ä»¥åŠå ç”¨çš„å†…å­˜å®¹é‡<blockquote>
<pre><code>   free - Display amount of free and used memory in the system
</code></pre></blockquote>
</li>
<li><code>sync</code> å¯ä»¥å°†ç¼“å­˜çš„é¡µå†™å…¥ç¡¬ç›˜<blockquote>
<pre><code>   sync - Synchronize cached writes to persistent storage
</code></pre></blockquote>
</li>
<li><code>echo 3 | sudo tee /proc/sys/vm/drop_caches</code> é‡Šæ”¾ pagecache, dentries and inodes</li>
<li>æˆ–è€…åœ¨<code>su</code>çš„æƒé™ä¸‹<code>echo 3 &gt; /proc/sys/vm/drop_caches</code></li>
</ul>
<p>ä»ä¸Šé¢çš„è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<code>buff/cache</code>åœ¨è¿è¡ŒæŒ‡ä»¤åå‡å°‘äº†å¾ˆå¤šï¼Œè¯´æ˜è¿™å—è¢«é‡Šæ”¾äº†ä¸€éƒ¨åˆ†ã€‚</p>
<p><br></p>
<p>æœ‰å…³é˜…è¯»ï¼š</p>
<ul>
<li>How do you empty the buffers and cache on a Linux system? - Stackoverflow: <span class="exturl" data-url="aHR0cHM6Ly91bml4LnN0YWNrZXhjaGFuZ2UuY29tL3F1ZXN0aW9ucy84NzkwOC9ob3ctZG8teW91LWVtcHR5LXRoZS1idWZmZXJzLWFuZC1jYWNoZS1vbi1hLWxpbnV4LXN5c3RlbQ==" title="https://unix.stackexchange.com/questions/87908/how-do-you-empty-the-buffers-and-cache-on-a-linux-system">https://unix.stackexchange.com/questions/87908/how-do-you-empty-the-buffers-and-cache-on-a-linux-system<i class="fa fa-external-link"></i></span></li>
<li>How to Clear RAM Memory Cache, Buffer and Swap Space on Linux - TecMint: <span class="exturl" data-url="aHR0cHM6Ly93d3cudGVjbWludC5jb20vY2xlYXItcmFtLW1lbW9yeS1jYWNoZS1idWZmZXItYW5kLXN3YXAtc3BhY2Utb24tbGludXgv" title="https://www.tecmint.com/clear-ram-memory-cache-buffer-and-swap-space-on-linux/">https://www.tecmint.com/clear-ram-memory-cache-buffer-and-swap-space-on-linux/<i class="fa fa-external-link"></i></span></li>
</ul>
<h1 id="æ¸…ç©ºpsql-buffer-pool-é‡å¯psql"><a href="#æ¸…ç©ºpsql-buffer-pool-é‡å¯psql" class="headerlink" title="æ¸…ç©ºpsql buffer pool - é‡å¯psql"></a>æ¸…ç©ºpsql buffer pool - é‡å¯psql</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨é‡å¯PostgreSQLæœåŠ¡åï¼Œbuffer poolä¼šè¢«æ¸…ç©ºã€‚</p>
<h1 id="å®éªŒ-æŸ¥çœ‹-page-hit-page-fault"><a href="#å®éªŒ-æŸ¥çœ‹-page-hit-page-fault" class="headerlink" title="å®éªŒ - æŸ¥çœ‹ page hit, page fault"></a>å®éªŒ - æŸ¥çœ‹ page hit, page fault</h1><p>åœ¨è¿™æ—¶å€™æˆ‘ä»¬å·²ç»åšè¿‡äº†å‰é¢ä¸¤æ­¥ï¼š</p>
<ul>
<li>æ“ä½œç³»ç»Ÿæ²¡æœ‰æˆ‘ä»¬éœ€è¦çš„çš„page cache</li>
<li>PostgreSQLçš„buffer poolæ˜¯ç©ºçš„</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">testdb=# \timing</span><br><span class="line">Timing is on.</span><br><span class="line">testdb=# <span class="built_in">set</span> max_parallel_workers_per_gather = <span class="number">0</span>;</span><br><span class="line">SET</span><br><span class="line">Time: <span class="number">7.740</span> ms</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1817.296</span>.<span class="number">.1817</span><span class="number">.296</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared <span class="built_in">read</span>=<span class="number">44248</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.401</span>.<span class="number">.814</span><span class="number">.209</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared <span class="built_in">read</span>=<span class="number">44248</span></span><br><span class="line"> Planning time: <span class="number">0.225</span> ms</span><br><span class="line"> Execution time: <span class="number">1817.316</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1824.317</span> ms (<span class="number">00</span>:<span class="number">01.824</span>)</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1772.469</span>.<span class="number">.1772</span><span class="number">.469</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">32</span> <span class="built_in">read</span>=<span class="number">44216</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.032</span>.<span class="number">.765</span><span class="number">.356</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">32</span> <span class="built_in">read</span>=<span class="number">44216</span></span><br><span class="line"> Planning time: <span class="number">0.025</span> ms</span><br><span class="line"> Execution time: <span class="number">1772.488</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1772.799</span> ms (<span class="number">00</span>:<span class="number">01.773</span>)</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1673.223</span>.<span class="number">.1673</span><span class="number">.223</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">64</span> <span class="built_in">read</span>=<span class="number">44184</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.030</span>.<span class="number">.719</span><span class="number">.406</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">64</span> <span class="built_in">read</span>=<span class="number">44184</span></span><br><span class="line"> Planning time: <span class="number">0.025</span> ms</span><br><span class="line"> Execution time: <span class="number">1673.243</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1673.562</span> ms (<span class="number">00</span>:<span class="number">01.674</span>)</span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1657.359</span>.<span class="number">.1657</span><span class="number">.359</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">96</span> <span class="built_in">read</span>=<span class="number">44152</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.034</span>.<span class="number">.711</span><span class="number">.246</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">96</span> <span class="built_in">read</span>=<span class="number">44152</span></span><br><span class="line"> Planning time: <span class="number">0.025</span> ms</span><br><span class="line"> Execution time: <span class="number">1657.378</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1657.683</span> ms (<span class="number">00</span>:<span class="number">01.658</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>explain (analyze, buffers) select sum(a + b) from testreals;</code>ä¸­<ul>
<li><code>explain</code>: ç»™å‡ºquery plan</li>
<li><code>analyze</code>: æ‰§è¡Œquery</li>
<li><code>buffers</code>: ç»™å‡ºbuffer poolä¿¡æ¯</li>
</ul>
</li>
<li>ç„¶åæˆ‘å‰åæ‰§è¡Œ4æ¬¡åŒä¸€ä¸ªquery:<ul>
<li>PostgreSQLæœ‰ä¸€ä¸ªå…±ç”¨çš„share buffer pool, ç„¶åæ¯ä¸€ä¸ªqueryä¹Ÿæœ‰ä¸€ä¸ªè‡ªå·±çš„buffer poolã€‚queryçš„ä¸“å±buffer poolçš„å¤§å°ï¼Œä¼šéšç€æ‰§è¡Œæ¬¡æ•°è€Œå¢åŠ ï¼Œé»˜è®¤æ˜¯æ¯æ¬¡å¢åŠ 32ä¸ªä½ç½®ã€‚</li>
<li>ç¬¬ä¸€æ¬¡: <code>Buffers: shared read=44248</code> å› ä¸ºbuffer poolæ˜¯ç©ºçš„ï¼Œæ¯ä¸€æ¬¡éƒ½æ˜¯page faultã€‚åŒæ—¶æ“ä½œç³»ç»Ÿfile page cacheä¹Ÿæ˜¯ç©ºçš„ï¼Œæ‰€æœ‰pageéƒ½éœ€è¦ä»ç¡¬ç›˜å…ˆåŠ è½½åˆ°æ“ä½œç³»ç»Ÿfile page cache, åœ¨ä»è¿™é‡Œå¤åˆ¶è¿›æ•°æ®åº“buffer poolã€‚<code>shared read</code>æŒ‡çš„å°±æ˜¯page fault, æ˜¯é‚£äº›ä¸åœ¨buffer poolä¸­ï¼Œéœ€è¦ä»ç¡¬ç›˜æˆ–ä»æ“ä½œç³»ç»Ÿfile cacheä¸­è¯»å–çš„pageã€‚</li>
<li><strong>æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°è¿™ä¸ªè¡¨æ ¼ä¸€å…±å¯¹åº”<code>44248</code>ä¸ªpageã€‚</strong></li>
<li>ç¬¬äºŒæ¬¡: <code>Buffers: shared hit=32 read=44216</code> Queryçš„buffer poolæ˜¯å¤§å°æ˜¯32ï¼Œ å·²å¢åŠ 32ä¸ªä½ç½®ã€‚</li>
<li>ç¬¬ä¸‰æ¬¡: <code>Buffers: shared hit=64 read=44184</code> Queryçš„buffer poolæ˜¯å¤§å°æ˜¯64ï¼Œ å·²å¢åŠ 32ä¸ªä½ç½®ã€‚</li>
<li>ç¬¬å››æ¬¡: <code>Buffers: shared hit=96 read=44152</code> Queryçš„buffer poolæ˜¯å¤§å°æ˜¯94ï¼Œ å·²å¢åŠ 32ä¸ªä½ç½®ã€‚</li>
</ul>
</li>
</ul>
<h1 id="å®éªŒ-æ‰©å¤§buffer-pool-size"><a href="#å®éªŒ-æ‰©å¤§buffer-pool-size" class="headerlink" title="å®éªŒ - æ‰©å¤§buffer pool size"></a>å®éªŒ - æ‰©å¤§buffer pool size</h1><p>ä¸‹é¢æˆ‘ä»¬å‘ç°æœ€å¤§çš„buffer pool sizeæ˜¯<code>128MB</code>ï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# show shared_buffers;</span><br><span class="line"> shared_buffers </span><br><span class="line">----------------</span><br><span class="line"> <span class="number">128</span>MB</span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">0.196</span> ms</span><br></pre></td></tr></tbody></table></figure>
<p>ä½†æ˜¯æˆ‘ä»¬å¯¹åº”çš„è¡¨æ ¼çš„æ‰€æœ‰pageå¤§æ¦‚æ˜¯<code>345MB</code>, æ¯ä¸€ä¸ªpageæ˜¯<code>8KiB</code>:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select (<span class="number">44248</span> * <span class="number">8</span>) / <span class="number">1024</span>;</span><br><span class="line"> ?column? </span><br><span class="line">----------</span><br><span class="line">      <span class="number">345</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">0.381</span> ms</span><br></pre></td></tr></tbody></table></figure>
<p>å› æ­¤è¿™ä¸ªé»˜è®¤çš„buffer pool sizeä¸è¶³ä»¥å®¹çº³æˆ‘ä»¬è¿™ä¸ªè¡¨æ ¼ã€‚æ­£å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬çš„queryéœ€è¦çš„pageæ•°æ€»å¤§äºbuffer sizeä¸€æ¬¡æ€§æ‰€èƒ½å®¹çº³çš„æ•°é‡ï¼Œä¸€å®šä¼šå‡ºç°page faultã€‚</p>
<h2 id="æ›´æ”¹PostgresSQLé…ç½®æ–‡ä»¶ä¸­çš„shared-buffers"><a href="#æ›´æ”¹PostgresSQLé…ç½®æ–‡ä»¶ä¸­çš„shared-buffers" class="headerlink" title="æ›´æ”¹PostgresSQLé…ç½®æ–‡ä»¶ä¸­çš„shared_buffers"></a>æ›´æ”¹PostgresSQLé…ç½®æ–‡ä»¶ä¸­çš„<code>shared_buffers</code></h2><p>æˆ‘ä»¬ç”¨è‡ªå·±å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨å»æ‰“å¼€<code>/etc/postgresql/10/main/postgresql.conf</code>æ–‡ä»¶:</p>
<ul>
<li>æ³¨æ„æˆ‘postgresqlçš„ç‰ˆæœ¬æ˜¯<code>10</code></li>
<li>å…·ä½“çš„é…ç½®æ–‡ä»¶ä½ç½®å’Œpostgresqlå®‰è£…ä½ç½®å’Œå®‰è£…ç‰ˆæœ¬æœ‰å…³</li>
</ul>
<p>æ‰¾åˆ°ä¸‹é¢å¯¹åº”çš„<code>shared_buffers</code>, æ›´æ”¹æ•°å€¼ä¸º<code>360MB</code>:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------                                                                                          </span></span><br><span class="line"><span class="comment"># RESOURCE USAGE (except WAL)                                                                                                                                            </span></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------                                                                                          </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Memory -                                                                                                                                                             </span></span><br><span class="line"></span><br><span class="line">shared_buffers = 128MB                  <span class="comment"># min 128kB  </span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>ä¿å­˜å®Œä»¥åæˆ‘ä»¬æ‰“å¼€<code>psql</code>çœ‹çœ‹æ˜¯å¦æ›´æ”¹æˆåŠŸã€‚å¦‚æœåƒä¸‹é¢ä¾‹å­ä¸­ï¼Œçœ‹è§<code>360MB</code>ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„<code>128MB</code>,å³æ›´æ”¹æˆåŠŸï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">testdb=# show shared_buffers;</span><br><span class="line"> shared_buffers </span><br><span class="line">----------------</span><br><span class="line"> <span class="number">360</span>MB</span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="é‡æ–°ä¹‹å‰å®éªŒ-å†·å¯åŠ¨"><a href="#é‡æ–°ä¹‹å‰å®éªŒ-å†·å¯åŠ¨" class="headerlink" title="é‡æ–°ä¹‹å‰å®éªŒ - å†·å¯åŠ¨"></a>é‡æ–°ä¹‹å‰å®éªŒ - å†·å¯åŠ¨</h2><p>æˆ‘ä»¬ä¾ç„¶æ‰§è¡Œä¸‹é¢ä¸¤ä¸ªå‘½ä»¤ï¼Œ å»æ¸…ç©ºæ“ä½œç³»ç»Ÿfile page cacheå’Œæ•°æ®åº“çš„buffer pool:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sync; <span class="built_in">echo</span> 3 | sudo tee /proc/sys/vm/drop_caches</span><br><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™æ ·æ“ä½œä»¥åæˆ‘ä»¬çš„æ•°æ®åº“buffer poolè¢«æ¸…ç©ºï¼Œæ“ä½œç³»ç»Ÿpage cacheé‡Œé¢ä¹Ÿæ²¡ä¹Ÿå¯¹åº”çš„page, æ‰€ä»¥æˆ‘ä»¬ç§°ä¹‹ä¸º<strong>å†·å¯åŠ¨</strong>ã€‚</p>
<p><br></p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">testdb=# \timing</span><br><span class="line">Timing is on.</span><br><span class="line"></span><br><span class="line">testdb=# <span class="built_in">set</span> max_parallel_workers_per_gather = <span class="number">0</span>;</span><br><span class="line">SET</span><br><span class="line">Time: <span class="number">9.680</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# CREATE EXTENSION pg_prewarm;</span><br><span class="line">CREATE EXTENSION</span><br><span class="line">Time: <span class="number">12.151</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# select * from pg_prewarm('testreals');</span><br><span class="line"> pg_prewarm </span><br><span class="line">------------</span><br><span class="line">      <span class="number">44248</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">473.944</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# explain (analyze, buffers) select sum(a + b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1628.475</span>.<span class="number">.1628</span><span class="number">.475</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   Buffers: shared hit=<span class="number">44248</span></span><br><span class="line">   -&gt;  Seq Scan on testreals  (cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>) (actual time=<span class="number">0.008</span>.<span class="number">.664</span><span class="number">.942</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span><br><span class="line">         Buffers: shared hit=<span class="number">44248</span></span><br><span class="line"> Planning time: <span class="number">6.139</span> ms</span><br><span class="line"> Execution time: <span class="number">1628.495</span> ms</span><br><span class="line">(<span class="number">6</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>select * from pg_prewarm('testreals');</code>æˆ–<code>select pg_prewarm('testreals');</code>æ˜¯å°†è¿™ä¸ªè¡¨æ ¼çš„æ‰€æœ‰pageéƒ½é¢„åŠ è½½è¿›buffer poolã€‚å› ä¸ºæˆ‘ä»¬è°ƒæ•´è¿‡shared buffer pool size, ç°åœ¨æˆ‘ä»¬çš„shared buffer poolè¶³å¤Ÿå®¹çº³è¿™ä¸ªè¡¨æ ¼å¯¹åº”çš„æ‰€æœ‰pageäº†ã€‚<strong>æ³¨æ„è¿™ä¸ªæ‰§è¡Œçš„è¿”å›å€¼<code>44248</code>, å®ƒå°±æ˜¯è¿™ä¸ªè¡¨æ ¼æ‰€æœ‰å¯¹åº”pageçš„æ•°å€¼ã€‚</strong></li>
<li><code>CREATE EXTENSION pg_prewarm;</code>è¿™ä¸ªæŒ‡ä»¤æ˜¯è¿è¡Œä¸Šä¸€æ¡æŒ‡ä»¤çš„å‰æã€‚</li>
<li>ç„¶åæˆ‘ä»¬åˆè§åˆ°è¿™ä¸ªqueryï¼š <code>explain (analyze, buffers) select sum(a + b) from testreals;</code><ul>
<li><code>Buffers: shared hit=44248</code> <strong>æˆ‘ä»¬åˆå‘ç°<code>44248</code>è¿™ä¸ªæ•°å€¼ï¼Œè¯´æ˜æ‰€æœ‰çš„pageéƒ½æ˜¯page hitï¼Œè€Œä¸æ˜¯page faultã€‚</strong></li>
</ul>
</li>
</ul>
<p><br></p>
<p>çƒ­å¯åŠ¨å¥½åƒæ— æ³•åœ¨psqlä¸­ç›´æ¥å±•ç¤ºï¼Œè¿™é‡Œç•¥è¿‡ã€‚ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">ğŸ˜‚</span></p>
<p><br></p>
<p>æ¨èçš„é˜…è¯»ï¼š</p>
<p>PREWARMING POSTGRESQL I/O CACHES - Hans-JÃ¼rgen SchÃ¶nigï¼š <span class="exturl" data-url="aHR0cHM6Ly93d3cuY3liZXJ0ZWMtcG9zdGdyZXNxbC5jb20vZW4vcHJld2FybWluZy1wb3N0Z3Jlc3FsLWktby1jYWNoZXMv" title="https://www.cybertec-postgresql.com/en/prewarming-postgresql-i-o-caches/">https://www.cybertec-postgresql.com/en/prewarming-postgresql-i-o-caches/<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>Storage</category>
        <category>DBMS</category>
        <category>PostgreSQL</category>
        <category>Buffer Management</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]Lec04 Database Storage Part II - æ•°æ®åº“å­˜å‚¨  II</title>
    <url>/2020/03/16/CMU-15445-Lec04/</url>
    <content><![CDATA[<p>Database Storage Part II - æ•°æ®åº“å­˜å‚¨  II</p>
<p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA0LXN0b3JhZ2UyLnBkZg==" title="https://15445.courses.cs.cmu.edu/fall2019/slides/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/04-storage2.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDQtc3RvcmFnZTIucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf<i class="fa fa-external-link"></i></span></p>
<p>è¿™èŠ‚ä¸¤è¯¾ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“å†…éƒ¨çš„å­˜å‚¨ã€‚</p>
<p>Database Storage åœ¨CMUåˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œåœ¨ä¸¤èŠ‚è¯¾ä¸­è®²ã€‚è¿™æ˜¯ç¬¬äºŒéƒ¨åˆ†ã€‚</p>
<p>è¿™éƒ¨åˆ†è®¾æ¶‰åŠåŸºç¡€æ•°æ®ç±»å‹çš„è¡¨ç¤º, OLAP, OLTP, HTAP, row-store (NSM), column store(DSM) ç­‰ç­‰ã€‚</p>
<a id="more"></a>
<p><img data-src="/images/CMU1544564/Lec04/1.jpg" alt="1.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/12.jpg" alt="12.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/13.jpg" alt="13.jpg"></p>
<p>a sequence of bytes = byte array</p>
<h1 id="Data-Representation"><a href="#Data-Representation" class="headerlink" title="Data Representation"></a>Data Representation</h1><p><img data-src="/images/CMU1544564/Lec04/14.jpg" alt="14.jpg"></p>
<ul>
<li>æˆ‘ä»¬åœ¨<a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part1/#DATE-TIME-OPERATIONS">[CMU-15445]Lec02_part1</a>, åœ¨ä¸åŒçš„æ•°æ®åº“ä¸­å·²ç»è§è¿‡Date Time Operationsä¹Ÿä¸ä¸€æ ·ï¼Œæ²¡æœ‰å”¯ä¸€çš„æ ‡å‡†ã€‚</li>
</ul>
<!-- TODO: unix epoch -->
<h2 id="Variable-Precision-Numbers-æµ®ç‚¹æ•°"><a href="#Variable-Precision-Numbers-æµ®ç‚¹æ•°" class="headerlink" title="Variable Precision Numbers æµ®ç‚¹æ•°"></a>Variable Precision Numbers æµ®ç‚¹æ•°</h2><p><img data-src="/images/CMU1544564/Lec04/15.jpg" alt="15.jpg"></p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSUVFRV83NTQ=" title="https://en.wikipedia.org/wiki/IEEE_754">https://en.wikipedia.org/wiki/IEEE_754<i class="fa fa-external-link"></i></span>  <!-- TODO --></li>
<li>å¯¹<code>FLOAT</code>, <code>REAL/DOUBLE</code>çš„æ“ä½œä¼šæ¯”è¾ƒå¿«ï¼Œå› ä¸ºCPUæœ‰ç›´æ¥å¯¹åº”çš„æŒ‡ä»¤(instruction)å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯å› ä¸ºç²¾åº¦æœ‰é™çš„åŸå› ï¼Œä½¿ç”¨è¿™å‡ ä¸ªä¾ç„¶ä¼šå¤±å»ç²¾åº¦ã€‚(å’Œç¼–ç¨‹è¯­è¨€ä¸­ä¸€æ ·)ã€‚å› ä¸ºè®¡ç®—æœºå¯¹æ•°å­—å­˜å‚¨æ˜¯ç¦»æ•£çš„ï¼Œæœ‰é™çš„ï¼Œå¿…ç„¶ä¼šå¤±å»ä¸€å®šç²¾åº¦ï¼Œç»“æœæ˜¯è¿‘ä¼¼çš„ã€‚</li>
</ul>
<h3 id="Demo-å¤±å»ç²¾åº¦"><a href="#Demo-å¤±å»ç²¾åº¦" class="headerlink" title="Demo - å¤±å»ç²¾åº¦"></a>Demo - å¤±å»ç²¾åº¦</h3><p><img data-src="/images/CMU1544564/Lec04/16.jpg" alt="16.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/17.jpg" alt="17.jpg"></p>
<h2 id="Fixed-Precision-Numbers-å®šç‚¹æ•°"><a href="#Fixed-Precision-Numbers-å®šç‚¹æ•°" class="headerlink" title="Fixed Precision Numbers å®šç‚¹æ•°"></a>Fixed Precision Numbers å®šç‚¹æ•°</h2><p>å®šç‚¹æ•°å°±æ˜¯å°æ•°ç‚¹æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨intåˆ†åˆ«å­˜å‚¨å°æ•°ç‚¹å‰åçš„æ•°å­—å°±å¯ä»¥å®ç°ï¼Œå®šç‚¹æ•°æ˜¯å¯ä»¥åšåˆ°ç²¾ç¡®è®¡ç®—çš„ã€‚ä½†æ˜¯å±€é™ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œåªèƒ½è¡¨ç¤ºå›ºå®šç²¾åº¦ã€‚<sup><a href="#fn1">1</a></sup></p>
<p><img data-src="/images/CMU1544564/Lec04/18.jpg" alt="18.jpg"></p>
<p>æ›´å¤šå…³äºè¿™ä¸ªDemoå®éªŒï¼Œè§è¿™ä¸ªæ–‡ç« <a href="https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/">[DBMS]Postgresæµ®ç‚¹æ•°ï¼Œå®šç‚¹æ•°ç²¾åº¦é—®é¢˜ precision_numbers</a></p>
<p><img data-src="/images/CMU1544564/Lec04/19.jpg" alt="19.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/20.jpg" alt="20.jpg"></p>
<ul>
<li>PostgreSQL Source Code: <span class="exturl" data-url="aHR0cHM6Ly9kb3h5Z2VuLnBvc3RncmVzcWwub3JnL2ludGVyZmFjZXNfMmVjcGdfMnBndHlwZXNsaWJfMm51bWVyaWNfOGNfc291cmNlLmh0bWwjbDAwNzIy" title="https://doxygen.postgresql.org/interfaces_2ecpg_2pgtypeslib_2numeric_8c_source.html#l00722">https://doxygen.postgresql.org/interfaces_2ecpg_2pgtypeslib_2numeric_8c_source.html#l00722<i class="fa fa-external-link"></i></span></li>
<li>ä»æºä»£ç ä¸­å¯ä»¥çœ‹å‡ºå›ºå®šç²¾åº¦çš„æ•°å­—çš„æ“ä½œå¾ˆå¤æ‚ï¼Œæœ‰å¾ˆå¤šbranchï¼Œæ‰€ä»¥ä¼šæ¯”è¾ƒæ…¢ã€‚</li>
</ul>
<h2 id="Large-Values"><a href="#Large-Values" class="headerlink" title="Large Values"></a>Large Values</h2><p><img data-src="/images/CMU1544564/Lec04/21.jpg" alt="21.jpg"></p>
<ul>
<li>å¦‚æœ<code>c</code>å¾ˆå¤§ï¼Œç”šè‡³è¶…è¿‡äº†ä¸€ä¸ªpageçš„å¤§å°ã€‚æ¯”å¦‚<code>c</code>æ˜¯ä¸€ä¸ªtupleä¸­ä¸€ä¸ªå¾ˆé•¿çš„<code>VARCHAR</code>å­—æ®µã€‚Stringæ€»æ˜¯æ•°æ®åº“ä¸­æœ€éº»çƒ¦çš„ã€‚å¯¹äºè¿™ä¸ªè¶…è¿‡ä¸€ä¸ªpageå¤§å°çš„<code>c</code>ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒé¢å¤–å­˜å‚¨åœ¨ä¸€ä¸ª<em>overflow page</em>ä¸Šï¼Œè¿™æ—¶ä¸Šå›¾ä¸­çš„<code>c</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘overflow pageçš„ä¸€ä¸ªæŒ‡é’ˆã€‚</li>
<li>å½“ç„¶overflow pageå¯ä»¥æ˜¯å¤šä¸ªã€‚å‡å¦‚ä¸€ä¸ªoverflow pageä¾ç„¶ä¸å¤Ÿå¤§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡ ä¸ªoverflow pageï¼Œå®ƒä»¬ä¹‹é—´ç»§ç»­ç”¨<em>æŒ‡é’ˆ</em>ç›¸è¿ã€‚</li>
<li>æ•´ä½“ä¸Šoverflow pageåªæ˜¯ä¸€ç§å®ç°å­˜å‚¨large valueçš„æ–¹å¼ã€‚å®ƒå¯¹ä½¿ç”¨æ•°æ®åº“çš„åº”ç”¨æ˜¯<strong>é€æ˜çš„(transparent)</strong>, ä½¿ç”¨æ•°æ®åº“çš„åº”ç”¨åªè·å¾—é‚£ä¸ªå¾ˆé•¿çš„<code>c</code>å­—ç¬¦ä¸²ï¼Œè€Œä¸å¿…çŸ¥é“å®ƒæ˜¯å¦‚ä½•è¢«å­˜å‚¨ï¼Œå­˜å‚¨åœ¨å“ªå„¿ã€‚</li>
</ul>
<h2 id="External-Value-Storage"><a href="#External-Value-Storage" class="headerlink" title="External Value Storage"></a>External Value Storage</h2><p><img data-src="/images/CMU1544564/Lec04/22.jpg" alt="22.jpg"></p>
<ul>
<li>External Value Storageæ˜¯æŒ‡é‚£äº›ç‰¹åˆ«å¤§çš„æ–‡ä»¶ï¼Œè¶…è¿‡æˆ‘ä»¬å‰é¢æåˆ°çš„large valueã€‚å®ƒæ¯”å¦‚è¯´æ˜¯GiBå¤§å°çš„è§†é¢‘ã€‚</li>
<li>BLOB: Binary Large Object data</li>
<li>è¿™ç§æ–‡ä»¶ï¼Œæˆ‘ä»¬æ²¡æœ‰å¿…è¦æŠŠå®ƒå­˜å‚¨åœ¨æ•°æ®åº“å†…éƒ¨ï¼Œè¿™æ ·ä¼šæµªè´¹æ•°æ®åº“ç©ºé—´ã€‚</li>
<li>æˆ‘ä»¬ç›´æ¥åœ¨<code>c</code>çš„åœ°æ–¹å­˜å‚¨ï¼Œè¯¥æ–‡ä»¶åœ¨æ“ä½œç³»ç»Ÿæ–‡ä»¶ç³»ç»Ÿä¸­ç¡¬ç›˜çš„ä½ç½®ã€‚è¿™æ ·åšä¸ä¼šæµªè´¹æ•°æ®åº“å†…éƒ¨ç©ºé—´ã€‚</li>
<li>å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„High Endçš„è®¾å¤‡å»è¿è¡Œé«˜æ€§èƒ½æ•°æ®åº“ï¼Œé‚£ä¹ˆè¯¥æœåŠ¡å™¨ä¸­ç£ç›˜å®¹é‡æ˜¯å¾ˆå®è´µçš„ï¼Œä¸åº”è¯¥è¢«æµªè´¹çš„ã€‚åœ¨<code>c</code>å­˜å‚¨ä¸€ä¸ªç¡¬ç›˜ä½ç½®ï¼Œèƒ½é™ä½æ•°æ®åº“çš„æˆæœ¬ï¼Œç‰¹åˆ«æ˜¯è¿™ä¸ªç¡¬ç›˜å¯ä»¥æ˜¯HTFSæˆ–è€…network storageã€‚</li>
<li>è¿™é‡Œæ³¨æ„å¯¹äºå­˜æ”¾åˆ°å¤–éƒ¨æ–‡ä»¶çš„æ•°æ®ï¼Œæ˜¯ä¸ä¿è¯transactionç­‰è¯­ä¹‰çš„ã€‚<sup><a href="#fn1">1</a></sup></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec04/23.jpg" alt="23.jpg"></p>
<p>To BLOB or Not To BLOB: Large Object Storage in a Database or a Filesystem: <span class="exturl" data-url="aHR0cHM6Ly93d3cubWljcm9zb2Z0LmNvbS9lbi11cy9yZXNlYXJjaC9wdWJsaWNhdGlvbi90by1ibG9iLW9yLW5vdC10by1ibG9iLWxhcmdlLW9iamVjdC1zdG9yYWdlLWluLWEtZGF0YWJhc2Utb3ItYS1maWxlc3lzdGVtLw==" title="https://www.microsoft.com/en-us/research/publication/to-blob-or-not-to-blob-large-object-storage-in-a-database-or-a-filesystem/">https://www.microsoft.com/en-us/research/publication/to-blob-or-not-to-blob-large-object-storage-in-a-database-or-a-filesystem/<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<h1 id="System-Catalogs-metadata"><a href="#System-Catalogs-metadata" class="headerlink" title="System Catalogs = metadata"></a>System Catalogs = metadata</h1><p><img data-src="/images/CMU1544564/Lec04/24.jpg" alt="24.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/25.jpg" alt="25.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/26.jpg" alt="26.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/27.jpg" alt="27.jpg"></p>
<!-- TODO: MySQL, SQLIte -->
<p>PostgreSQLçš„æŸ¥çœ‹Schemaæ“ä½œï¼Œå…·ä½“è§å¦å¤–ä¸€ç¯‡åšå®¢ï¼Œé‡Œé¢æœ‰å¾ˆå¤šä¾‹å­ï¼š<a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/#%E6%95%B0%E6%8D%AE%E9%9B%86">[DBMS] PostgreSQL å¯¼å…¥æ•°æ®é›† - æ•°æ®é›†</a></p>
<p><br><br><br></p>
<h1 id="Storage-Levels"><a href="#Storage-Levels" class="headerlink" title="Storage Levels"></a>Storage Levels</h1><p><img data-src="/images/CMU1544564/Lec04/28.jpg" alt="28.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/29.jpg" alt="29.jpg"></p>
<h2 id="OLTP"><a href="#OLTP" class="headerlink" title="OLTP"></a>OLTP</h2><p>OLTP := On-line Transaction Processing é€šå¸¸æ˜¯å¯¹å¾ˆå°ä¸€éƒ¨åˆ†tupleçš„å†™æ“ä½œ</p>
<p>OLTP: On-line Transaction Processing</p>
<ul>
<li>Fast, short running operations</li>
<li>Queries operate on single entity at a time</li>
<li>More writes than reads</li>
<li>Repetitive operations</li>
<li>Usually the kind of application that people build first</li>
<li>Example: User invocations of Amazon. They can add things to their cart, they can make purchases,<br>but the actions only affect their account.<br>â€” å¼•ç”¨è‡ª: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDQtc3RvcmFnZTIucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf<i class="fa fa-external-link"></i></span></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec04/30.jpg" alt="30.jpg"></p>
<h2 id="OLAP"><a href="#OLAP" class="headerlink" title="OLAP"></a>OLAP</h2><p>OLAP := On-line Analytical Processing é€šå¸¸æ˜¯å¯¹å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯tupleåšè¯»æ“ä½œ, åŒå¤æ‚çš„åˆ†æèšåˆã€€(decision-support, big data)</p>
<p>OLTP: On-line Transaction Processing</p>
<ul>
<li>Fast, short running operations</li>
<li>Queries operate on single entity at a time</li>
<li>More writes than reads</li>
<li>Repetitive operations</li>
<li>Usually the kind of application that people build first</li>
<li>Example: User invocations of Amazon. They can add things to their cart, they can make purchases,<br>but the actions only affect their account.<br>â€” å¼•ç”¨è‡ª: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDQtc3RvcmFnZTIucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf<i class="fa fa-external-link"></i></span></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec04/31.jpg" alt="31.jpg"></p>
<h2 id="HTAP"><a href="#HTAP" class="headerlink" title="HTAP"></a>HTAP</h2><p><img data-src="/images/CMU1544564/Lec04/32.jpg" alt="32.jpg"></p>
<p>SOURCE: <span class="exturl" data-url="aHR0cHM6Ly9jYWNtLmFjbS5vcmcvbWFnYXppbmVzLzIwMTEvNi8xMDg2NTEtMTAtcnVsZXMtZm9yLXNjYWxhYmxlLXBlcmZvcm1hbmNlLWluLXNpbXBsZS1vcGVyYXRpb24tZGF0YXN0b3Jlcy9mdWxsdGV4dA==" title="https://cacm.acm.org/magazines/2011/6/108651-10-rules-for-scalable-performance-in-simple-operation-datastores/fulltext">https://cacm.acm.org/magazines/2011/6/108651-10-rules-for-scalable-performance-in-simple-operation-datastores/fulltext<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<h1 id="Storage-Models"><a href="#Storage-Models" class="headerlink" title="Storage Models"></a>Storage Models</h1><p><img data-src="/images/CMU1544564/Lec04/33.jpg" alt="33.jpg"></p>
<h2 id="N-ary-Storage-Model-NSM-row-store"><a href="#N-ary-Storage-Model-NSM-row-store" class="headerlink" title="N-ary Storage Model (NSM): row store"></a>N-ary Storage Model (NSM): row store</h2><p><img data-src="/images/CMU1544564/Lec04/34.jpg" alt="34.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/35.jpg" alt="35.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/36.jpg" alt="36.jpg"></p>
<h3 id="OLTP-1"><a href="#OLTP-1" class="headerlink" title="OLTP"></a>OLTP</h3><p>OLTPå¾€å¾€æœ‰ä¸€ä¸ªindex(ç´¢å¼•)ï¼Œå®ƒå¯ä»¥å¿«é€Ÿæ‰¾åˆ°OLTPéœ€è¦çš„é‚£ä¸€ä¸ªtupleã€‚</p>
<p><img data-src="/images/CMU1544564/Lec04/37.jpg" alt="37.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/38.jpg" alt="38.jpg"></p>
<h3 id="OLAP-1"><a href="#OLAP-1" class="headerlink" title="OLAP"></a>OLAP</h3><p>è€ŒOLAPå¾€å¾€éœ€è¦æ‰«æå¾ˆå¤§ä¸€éƒ¨åˆ†çš„è¡¨æ ¼ï¼Œè¿™ç§æƒ…å†µindexçš„å¸®åŠ©ä¸ä¼šå¾ˆå¤§ã€‚<strong>æ‰«æ</strong>å…·ä½“å°±æ˜¯ä»æ¯ä¸€ä¸ªtupleå¤´åˆ°å°¾ï¼Œæˆ‘ä»¬ä¹‹å‰æè¿‡tupleå°±æ˜¯ä¸€ä¸ªbyte arrayã€‚å³ä½¿æˆ‘ä»¬ä¸‹å›¾ä¸­ï¼Œåªéœ€è¦æ£€æŸ¥æ·±è“è‰²å’Œæµ…è“è‰²ä¸¤ä¸ªå­—æ®µï¼Œä½†æ˜¯æ•´ä¸ªtupleè¿˜æ˜¯éœ€è¦ä»å†…å­˜åŠ è½½åˆ°CPU cacheã€‚è€Œä¸”ä¸€ä¸ªpageä¸Šçš„å¤§éƒ¨åˆ†æ•°æ®ä¹Ÿéƒ½å’Œå½“å‰queryæ— å…³ï¼Œè¿™å®é™…ä¸Šå¾ˆä¸é«˜æ•ˆã€‚æ‰€ä»¥ä¸‹å›¾çº¢åœˆä¸­çš„éƒ½æ˜¯useless dataã€‚</p>
<p><img data-src="/images/CMU1544564/Lec04/43.jpg" alt="43.jpg"></p>
<h3 id="NSM-Pros-amp-Cons"><a href="#NSM-Pros-amp-Cons" class="headerlink" title="NSM Pros&amp;Cons"></a>NSM Pros&amp;Cons</h3><p><img data-src="/images/CMU1544564/Lec04/44.jpg" alt="44.jpg"></p>
<ul>
<li>NSMé€‚åˆOLTP, å› ä¸ºå¯¹å•ä¸ªtupleçš„æ“ä½œå¾ˆç®€å•ã€‚ä½†æ˜¯ä¸é€‚åˆOLAPï¼Œå¦‚æœOLAPä¸éœ€è¦æ‰€æœ‰å­—æ®µçš„è¯ã€‚</li>
</ul>
<p>There are two different ways to organize a NSM database:</p>
<ul>
<li><strong>Heap-Organized Tables</strong>: Tuples are stored in blocks called a heap, and the heap does not necessarily<br>define an order.</li>
<li><strong>Index-Organized Tables</strong>: Tuples are stored in the primary key index itself, but different from a<br>clustered index.</li>
</ul>
<p>â€” å¼•ç”¨è‡ª: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDQtc3RvcmFnZTIucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/04-storage2.pdf<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<h2 id="Decomposition-Storage-Model-DSM-column-store"><a href="#Decomposition-Storage-Model-DSM-column-store" class="headerlink" title="Decomposition Storage Model (DSM): column store"></a>Decomposition Storage Model (DSM): column store</h2><p>åœ¨DSMä¸­ï¼Œæ¯ä¸€ä¸ªå­—æ®µ(æˆ–æ¯ä¸€åˆ—)éƒ½æœ‰æ‹¥æœ‰è‡ªå·±çš„page, ä¸Šé¢éƒ½æ˜¯å½“å‰åˆ—çš„æ•°æ®ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec04/45.jpg" alt="45.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/46.jpg" alt="46.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/47.jpg" alt="47.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/49.jpg" alt="49.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/50.jpg" alt="50.jpg"></p>
<ul>
<li>ä¸Šå›¾ä¸­ã€€Choice1æ˜¯æ›´å¥½çš„ä¸»æ„ï¼Œä¹Ÿæ›´å¸¸è§ã€‚é€‚åˆæ¯ä¸ªå­—æ®µçš„æ•°æ®ç±»å‹æ˜¯<strong>ç­‰é•¿çš„</strong>ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec04/51.jpg" alt="51.jpg"></p>
<ul>
<li>DSMå°†åŒä¸€åˆ—ä¸­çš„æ•°æ®å­˜åœ¨ä¸€èµ·ï¼Œè¿™äº›æ•°æ®è‡ªç„¶ä¹Ÿå±äºåŒä¸€ä¸ªæ•°æ®ç±»å‹ã€‚è¿™æ ·å¤„ç†èµ·æ¥å¯¹CPU cacheæ›´é«˜æ•ˆ, åŒæ—¶ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šcomrpession(å‹ç¼©), materialized aggregate(small index for a page), SIMDæŒ‡ä»¤çš„ä¼˜åŒ–ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec04/52.jpg" alt="52.jpg"></p>
<ul>
<li>DSM Proposal - A Query Processing Strategy for the Decomposed Storage Model: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC41NTU1LzY0NTQ3Mi42NTU1NTU=" title="https://dl.acm.org/doi/10.5555/645472.655555">https://dl.acm.org/doi/10.5555/645472.655555<i class="fa fa-external-link"></i></span></li>
<li>å¤§éƒ¨åˆ†åˆ†æå‹çš„æ•°æ®åº“éƒ½æ˜¯ç”¨column storeï¼Œå®ƒä»¬é‡‡ç”¨çš„å¾€å¾€æ˜¯DSMçš„ç°ä»£å˜ç§</li>
<li>ä¸€ä¸ªDSMçš„å˜ç§: <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvZG93bmxvYWRzL3B1YmxpY2F0aW9ucy9kYXRhYmxvY2tzLnBkZg==" title="https://db.in.tum.de/downloads/publications/datablocks.pdf">Data Blocks: Hybrid OLTP and OLAP on Compressed Storage using both Vectorization and Compilation<i class="fa fa-external-link"></i></span></li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Row stores are usually better for OLTP, while column stores ar better for OLAP.</p>
<p>å¤§éƒ¨åˆ†ç°ä»£æ•°æ®åº“:</p>
<ul>
<li>Frontend: OLTP in client, å¤„ç†ç”¨æˆ·çš„äº‹åŠ¡</li>
<li>Backend: OLAP in Server, data warehouseã€€å¤§æ•°æ®åˆ†ææ‰€æœ‰ç”¨æˆ·çš„èµ„æ–™(æ¯”å¦‚è®¢å•)</li>
</ul>
<p>ä¸‹é¢ä¸‰é¡µæ˜¯æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzA1LWJ1ZmZlcnBvb2wucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/slides/05-bufferpool.pdf">Lec05<i class="fa fa-external-link"></i></span>, åœ¨è¿™èŠ‚è¯¾æœ€å¼€å§‹çš„æ—¶å€™ï¼Œé‡æ–°è®²äº†è¿™éƒ¨åˆ†ï¼Œæˆ‘å°†è¿™ä¸‰é¡µè¯¾ä»¶ç§»åŠ¨åˆ°è¿™é‡Œã€‚</p>
<p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/3.jpg" alt="Lec5_3.jpg"></p>
<p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/4.jpg" alt="Lec5_4.jpg"></p>
<ul>
<li>ä¸Šå›¾çš„å®¢æˆ·ç«¯ä¸ºä¼ ç»Ÿçš„OLTP Data Silosï¼Œå°†æ•°æ®å‘åˆ°Server - Data Warehouse(æ•°æ®ä»“åº“)ã€‚Serverç«¯è¿è¡ŒOLAP, åˆ†æè¿™äº›ç”¨æˆ·çš„ä¿¡æ¯ã€‚</li>
<li>ETL(Extract-Transform-Load)ï¼Œå°†æ•°æ®ä»æ¥æºç«¯ç»è¿‡æŠ½å–extractã€è½¬æ¢transformã€åŠ è½½loadè‡³ç›®çš„ç«¯çš„è¿‡ç¨‹ã€‚æ˜¯ä¸€ä¸ªå¸¸ç”¨åœ¨æ•°æ®ä»“åº“çš„æŠ€æœ¯ã€‚ServerçŸ­å¾—åˆ°è¿™äº›ETLåçš„æ•°æ®ï¼Œå°±å¯ä»¥è¿è¡ŒOLAP Queryæˆ–è€…æ•°æ®æŒ–æ˜ç­‰æœºå™¨å­¦ä¹ ç®—æ³•ã€‚</li>
</ul>
<p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec05/5.jpg" alt="Lec5_5.jpg"></p>
<ul>
<li>ä¸Šå›¾çš„å®¢æˆ·ç«¯æœ‰HTAPï¼Œ å³å®¢æˆ·ç«¯ä¸­è¿è¡ŒTPå’ŒAPï¼Œå†å°†åœ¨å®¢æˆ·ç«¯ä¸­å¤„ç†è¿‡çš„æ•°æ®ETLè‡³Server - Data Warehouseã€‚</li>
</ul>
<p><br></p>
<p><img data-src="/images/CMU1544564/Lec04/53.jpg" alt="53.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec04/54.jpg" alt="54.jpg"> </p>
<p>å¼•ç”¨:</p>
<p><a name="fn1">1</a>: Database Storage - fxjwind: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9wLzEwODE4ODE0Lmh0bWw=" title="https://www.cnblogs.com/fxjwind/p/10818814.html">https://www.cnblogs.com/fxjwind/p/10818814.html<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>Storage</category>
        <category>Disk Management</category>
      </categories>
      <tags>
        <tag>N-ary Storage Model</tag>
        <tag>Decomposition Storage Model</tag>
        <tag>OLAP</tag>
        <tag>OLTP</tag>
        <tag>HTAP</tag>
        <tag>Variable Precision Numbers</tag>
        <tag>Fixed Precision Numbers</tag>
      </tags>
  </entry>
  <entry>
    <title>[DBMS]Postgres æµ®ç‚¹æ•°ï¼Œå®šç‚¹æ•° ç²¾åº¦é—®é¢˜precision_numbers</title>
    <url>/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/</url>
    <content><![CDATA[<p>è¿™ç¯‡æ–‡ç« æœåŠ¡äº<a href="https://cakebytheoceanluo.github.io/2020/03/16/CMU-15445-Lec04/">[CMU-15445]Lec04</a></p>
<p>æ•°æ®åº“ä¸­ç»™å°æ•°(åˆ†æ•°)æœ‰ä¸¤ç§ç±»å‹</p>
<ul>
<li>Variable Precision Numbers: å¯å˜ç²¾åº¦æ•°å­—ï¼Œå¯èƒ½æœ‰ä¼šrounding error</li>
<li>Fixed Precision Numbers: å®šç²¾åº¦æ•°å­—ï¼Œåœ¨ç»™å®šçš„ç²¾åº¦ä¸‹æ²¡æœ‰è¯¯å·®</li>
</ul>
<p>æˆ‘ä»¬ä»Šå¤©æ¥çœ‹ä¸€çœ‹PostgreSQLä¸­çš„è¿™ä¸¤ç§ç±»å‹å’Œå®ƒä»¬å¯èƒ½äº§ç”Ÿçš„è¯¯å·®ã€‚</p>
<p>PostgreSQLä¸­å…·ä½“å¯¹åº”çš„æ•°æ®ç±»å‹æ˜¯:</p>
<ul>
<li>Variable Precision Numbers: <code>REAL</code></li>
<li>Fixed Precision Numbers: <code>DECIMAL(precision, scale), NUMERIC(precision, scale)</code></li>
</ul>
<hr>
<p><code>DECIMAL(precision, scale)</code>:</p>
<ul>
<li><code>precision</code>: The <code>precision</code> must be positive. The <code>precision</code> of a <em>numeric</em> is the total count of significant digits in the whole number, that is, the number of digits to both sides of the decimal point.</li>
<li><code>scale</code>: The <code>scale</code> must be zero or positive.   The <code>scale</code> of a <em>numeric</em> is the count of decimal digits in the fractional part, to the right of the decimal point</li>
</ul>
<p>So the number 23.5141 has a precision of 6 and a scale of 4. Integers can be considered to have a scale of zero.</p>
<p>ä»¥ä¸Šå¼•ç”¨è‡ª: <span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjEvZGF0YXR5cGUtbnVtZXJpYy5odG1s" title="https://www.postgresql.org/docs/9.1/datatype-numeric.html">https://www.postgresql.org/docs/9.1/datatype-numeric.html<i class="fa fa-external-link"></i></span></p>
<a id="more"></a>
<hr>
<h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/Lec04/data_csv.png" alt="num_range"></p>
<p>ä¸Šå›¾ä¸ºCMU-15445-Lec04è¯¾ä¸Šçš„æˆªå›¾ï¼Œå†…å®¹æ˜¯<code>data.csv</code>ã€‚å®é™…ä¸Šè¿™åªæ˜¯ä¸€ä¸ªéšæœºç”Ÿæˆçš„æ–‡ä»¶:</p>
<ul>
<li>ä¸€å…±10000000è¡Œ</li>
<li>æ¯è¡Œæœ‰ä¸¤ä¸ªæ•°å­—ï¼Œç”±<code>,</code>åˆ†éš”å¼€ï¼Œæ¯ä¸ªæ•°å­—æ˜¯100ä»¥å†…çš„å°æ•°ï¼Œå¹¶æœ‰6ä½å°æ•°éƒ¨åˆ†</li>
</ul>
<h2 id="æ•°æ®é›†faker"><a href="#æ•°æ®é›†faker" class="headerlink" title="æ•°æ®é›†faker"></a>æ•°æ®é›†faker</h2><p>æˆ‘ç”¨pythonå†™äº†ä¸€ä¸ªç±»ä¼¼çš„æ•°æ®é›†faker:</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">    print(<span class="string">f'<span class="subst">{float(Decimal(random.randrange(<span class="number">0</span>, <span class="number">100000000</span>) / <span class="number">1000000</span>))}</span>,<span class="subst">{float(Decimal(random.randrange(<span class="number">0</span>, <span class="number">100000000</span>) / <span class="number">1000000</span>))}</span>'</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p>ä¸‹è½½: <a href="https://cakebytheoceanluo.github.io/download/CMU15445/lec04_float_faker.py">lec04_float_faker.py</a></p>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>ä½¿ç”¨:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./lec04_float_faker.py &gt; data.csv</span><br></pre></td></tr></tbody></table></figure>
<p>åˆ°ç°åœ¨æˆ‘ä»¬è·å¾—äº†<code>data.csv</code>è¿™ä¸ªæ–‡ä»¶:</p>
<h2 id="æ•°æ®é›†æ–‡ä»¶"><a href="#æ•°æ®é›†æ–‡ä»¶" class="headerlink" title="æ•°æ®é›†æ–‡ä»¶"></a>æ•°æ®é›†æ–‡ä»¶</h2><p>æˆ‘å±•ç¤ºä¸€äº›æ•°æ®é›†æ–‡ä»¶ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ file data.csv </span><br><span class="line">data.csv: ASCII text</span><br><span class="line"></span><br><span class="line">$ ll data.csv</span><br><span class="line">-rw-rw-r-- 1 jigao jigao 195777640 Mar 11 19:17 data.csv</span><br><span class="line"></span><br><span class="line">$ shuf -n 5 data.csv </span><br><span class="line">66.798295,30.742821</span><br><span class="line">51.166558,51.72633</span><br><span class="line">87.780032,67.175637</span><br><span class="line">25.172411,70.619547</span><br><span class="line">12.432782,9.736797</span><br><span class="line"></span><br><span class="line">$ shuf -n 5 data.csv </span><br><span class="line">23.496402,68.946932</span><br><span class="line">6.035276,55.565444</span><br><span class="line">80.652459,83.420552</span><br><span class="line">69.633828,75.871921</span><br><span class="line">3.157022,43.588741</span><br></pre></td></tr></tbody></table></figure>
<h1 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h1><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# drop table <span class="keyword">if</span> <span class="built_in">exists</span> testreals;</span><br><span class="line">DROP TABLE</span><br><span class="line"></span><br><span class="line">testdb=# drop table <span class="keyword">if</span> <span class="built_in">exists</span> testdecimals;</span><br><span class="line">DROP TABLE</span><br><span class="line"></span><br><span class="line">testdb=# create table testreals (a REAL <span class="keyword">not</span> null, b REAL <span class="keyword">not</span> null);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">testdb=# create table testdecimals (a DECIMAL(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> null, b DECIMAL(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> null);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">testdb=# copy testreals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">COPY <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line">testdb=# copy testdecimals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">COPY <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line">testdb=# \timing</span><br><span class="line">Timing is on.</span><br><span class="line"></span><br><span class="line">testdb=# <span class="built_in">set</span> max_parallel_workers_per_gather = <span class="number">0</span>;</span><br><span class="line">SET</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>testreals</code>: Variable Precision Numbers, <code>REAL</code></li>
<li><code>testdecimals</code>: Fixed Precision Numbers, <code>DECIMAL(10, 6)</code></li>
<li><code>\timing</code>: æ‰“å¼€è®¡æ—¶å™¨</li>
<li><code>set max_parallel_workers_per_gather = 0;</code>: <span class="exturl" data-url="aHR0cHM6Ly9kYmEuc3RhY2tleGNoYW5nZS5jb20vcXVlc3Rpb25zLzIyNjY1NC9ob3ctY2FuLWktZGlzYWJsZS1wYXJhbGxlbC1xdWVyaWVzLWluLXBvc3RncmVzcWw=" title="https://dba.stackexchange.com/questions/226654/how-can-i-disable-parallel-queries-in-postgresql">å–æ¶ˆå¹¶è¡Œçš„queryæ‰§è¡Œ<i class="fa fa-external-link"></i></span>, å› ä¸ºæˆ‘ä»¬æƒ³çœ‹single CPU performance</li>
</ul>
<h1 id="REALè¡¨æ ¼"><a href="#REALè¡¨æ ¼" class="headerlink" title="REALè¡¨æ ¼"></a><code>REAL</code>è¡¨æ ¼</h1><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select sum(a+b) from testreals;</span><br><span class="line">     sum     </span><br><span class="line">-------------</span><br><span class="line"> <span class="number">1.00012e+09</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">384.460</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# select sum(a+b) from testreals;</span><br><span class="line">     sum     </span><br><span class="line">-------------</span><br><span class="line"> <span class="number">1.00013e+09</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">386.714</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# select cast(sum(a+b) as decimal) from testreals;</span><br><span class="line">    sum     </span><br><span class="line">------------</span><br><span class="line"> <span class="number">1000120000</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">535.749</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# select cast(sum(a+b) as decimal) from testreals;</span><br><span class="line">    sum     </span><br><span class="line">------------</span><br><span class="line"> <span class="number">1000110000</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">943.324</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# explain select sum(a+b) from testreals;</span><br><span class="line">                                QUERY PLAN                                </span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>)</span><br><span class="line">   -&gt;  <span class="function">Seq Scan on <span class="title">testreals</span>  <span class="params">(cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">(<span class="number">2</span> rows)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">Time: 2.369 ms</span><br><span class="line"></span><br><span class="line">testdb=# explain analyze select sum(a+b) from testreals;</span><br><span class="line">                                                         QUERY PLAN                                                          </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Aggregate  (cost=<span class="number">194247.66</span>.<span class="number">.194247</span><span class="number">.67</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">4</span>) (actual time=<span class="number">1598.636</span>.<span class="number">.1598</span><span class="number">.636</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span><br><span class="line">   -&gt;  <span class="function">Seq Scan on <span class="title">testreals</span>  <span class="params">(cost=<span class="number">0.00</span>.<span class="number">.144247</span><span class="number">.77</span> rows=<span class="number">9999977</span> <span class="built_in">width</span>=<span class="number">8</span>)</span> <span class="params">(actual time=<span class="number">0.036</span>.<span class="number">.705</span><span class="number">.511</span> rows=<span class="number">10000000</span> loops=<span class="number">1</span>)</span></span></span><br><span class="line"> Planning time: 0.025 ms</span><br><span class="line"> Execution time: <span class="number">1598.656</span> ms</span><br><span class="line">(<span class="number">4</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æˆ‘ä»¬å¤šæ¬¡æ‰§è¡ŒåŒä¸€æ¡æŒ‡ä»¤<code>select sum(a+b) from testreals;</code>ï¼Œå‰åæœ‰å‡ ç‡å‡ºç°ä¸ä¸€æ ·çš„æ•°å€¼ã€‚è¿™åŸå› å°±æ˜¯å› ä¸ºrounding errorã€‚åŒæ ·çš„æƒ…å†µä¹Ÿå‡ºç°åœ¨<code>select cast(sum(a+b) as decimal) from testreals;</code></li>
<li><code>explain &lt;sql&gt;</code>: ç»™å‡ºå¯¹åº”çš„query plan</li>
<li><code>explain analyze &lt;sql&gt;</code>: : ç»™å‡ºå¯¹åº”çš„query plan + æ‰§è¡Œsql</li>
</ul>
<h1 id="DECIMALè¡¨æ ¼"><a href="#DECIMALè¡¨æ ¼" class="headerlink" title="DECIMALè¡¨æ ¼"></a><code>DECIMAL</code>è¡¨æ ¼</h1><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select sum(a+b) from testdecimals;</span><br><span class="line">        sum        </span><br><span class="line">-------------------</span><br><span class="line"> <span class="number">1000169047.417319</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1175.335</span> ms (<span class="number">00</span>:<span class="number">01.175</span>)</span><br><span class="line"></span><br><span class="line">testdb=# explain select sum(a+b) from testdecimals;</span><br><span class="line">                                            QUERY PLAN                                             </span><br><span class="line">---------------------------------------------------------------------------------------------------</span><br><span class="line"> <span class="function">Finalize <span class="title">Aggregate</span>  <span class="params">(cost=<span class="number">126949.30</span>.<span class="number">.126949</span><span class="number">.31</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">32</span>)</span></span></span><br><span class="line">   -&gt;  Gather  (cost=126949.08..126949.29 rows=2 width=32)</span><br><span class="line">         Workers Planned: <span class="number">2</span></span><br><span class="line">         -&gt;  <span class="function">Partial <span class="title">Aggregate</span>  <span class="params">(cost=<span class="number">125949.08</span>.<span class="number">.125949</span><span class="number">.09</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">32</span>)</span></span></span><br><span class="line">               -&gt;  Parallel Seq Scan on testdecimals  (cost=0.00..105116.05 rows=4166605 width=16)</span><br><span class="line">(<span class="number">5</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">0.295</span> ms</span><br><span class="line"></span><br><span class="line">testdb=# explain analyze select sum(a+b) from testdecimals;</span><br><span class="line">                                                                     QUERY PLAN                                                                      </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> <span class="function">Finalize <span class="title">Aggregate</span>  <span class="params">(cost=<span class="number">126949.30</span>.<span class="number">.126949</span><span class="number">.31</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">32</span>)</span> <span class="params">(actual time=<span class="number">1382.202</span>.<span class="number">.1382</span><span class="number">.202</span> rows=<span class="number">1</span> loops=<span class="number">1</span>)</span></span></span><br><span class="line">   -&gt;  Gather  (cost=126949.08..126949.29 rows=2 width=32) (actual time=1382.191..1384.527 rows=3 loops=1)</span><br><span class="line">         Workers Planned: <span class="number">2</span></span><br><span class="line">         Workers Launched: <span class="number">2</span></span><br><span class="line">         -&gt;  <span class="function">Partial <span class="title">Aggregate</span>  <span class="params">(cost=<span class="number">125949.08</span>.<span class="number">.125949</span><span class="number">.09</span> rows=<span class="number">1</span> <span class="built_in">width</span>=<span class="number">32</span>)</span> <span class="params">(actual time=<span class="number">1380.379</span>.<span class="number">.1380</span><span class="number">.379</span> rows=<span class="number">1</span> loops=<span class="number">3</span>)</span></span></span><br><span class="line">               -&gt;  Parallel Seq Scan on testdecimals  (cost=0.00..105116.05 rows=4166605 width=16) (actual time=0.023..310.259 rows=3333333 loops=3)</span><br><span class="line"> Planning time: <span class="number">0.034</span> ms</span><br><span class="line"> Execution time: <span class="number">1384.563</span> ms</span><br><span class="line">(<span class="number">8</span> rows)</span><br><span class="line"></span><br><span class="line">Time: <span class="number">1384.835</span> ms (<span class="number">00</span>:<span class="number">01.385</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>select sum(a+b) from testdecimals;</code>æ— è®ºæˆ‘ä»¬æ‰§è¡Œå¤šå°‘æ¬¡ï¼Œå‡ºç°çš„ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚</li>
</ul>
<p>æ¨èé˜…è¯»ï¼š</p>
<p>8.1. Numeric Types - Documentation of PostgreSQL 9.1: <span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjEvZGF0YXR5cGUtbnVtZXJpYy5odG1s" title="https://www.postgresql.org/docs/9.1/datatype-numeric.html">https://www.postgresql.org/docs/9.1/datatype-numeric.html<i class="fa fa-external-link"></i></span></p>
<p>How can I disable parallel queries in PostgreSQL? - Stackoverflow: <span class="exturl" data-url="aHR0cHM6Ly9kYmEuc3RhY2tleGNoYW5nZS5jb20vcXVlc3Rpb25zLzIyNjY1NC9ob3ctY2FuLWktZGlzYWJsZS1wYXJhbGxlbC1xdWVyaWVzLWluLXBvc3RncmVzcWw=" title="https://dba.stackexchange.com/questions/226654/how-can-i-disable-parallel-queries-in-postgresql">https://dba.stackexchange.com/questions/226654/how-can-i-disable-parallel-queries-in-postgresql<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>Storage</category>
        <category>DBMS</category>
        <category>Disk Management</category>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[DBMS]PostgreSQLå¯¼å…¥æ•°æ®é›†</title>
    <url>/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/</url>
    <content><![CDATA[<p>æœ¬æ–‡ä»‹ç»äº†å‡ ç§æ•°æ®é›†ï¼Œä»¥åŠå¯¼å…¥å®ƒä»¬åˆ°PostgreSQLçš„æ–¹æ³•ï¼Œå¦å¤–ä¹Ÿæäº†ä¸€ä¸‹å¦‚ä½•æŸ¥çœ‹æ•°æ®é›†ä¿¡æ¯çš„å‘½ä»¤ã€‚è¿™äº›æ•°æ®é›†éƒ½ä¼šåœ¨æˆ‘çš„åšå®¢ä¸­<a href="https://cakebytheoceanluo.github.io/categories/SQL/">SQL åˆçº§/ä¸­çº§/é«˜çº§éƒ¨åˆ†</a>å‡ºç°ã€‚</p>
<h1 id="æŸ¥çœ‹æ•°æ®é›†ä¿¡æ¯çš„å‘½ä»¤"><a href="#æŸ¥çœ‹æ•°æ®é›†ä¿¡æ¯çš„å‘½ä»¤" class="headerlink" title="æŸ¥çœ‹æ•°æ®é›†ä¿¡æ¯çš„å‘½ä»¤"></a>æŸ¥çœ‹æ•°æ®é›†ä¿¡æ¯çš„å‘½ä»¤</h1><p>æˆ‘ä»¬å¯ä»¥åœ¨psqlç¯å¢ƒä¸­è¾“å…¥ï¼š</p>
<ul>
<li><code>\d;</code>, <code>\d+;</code> å¯ä»¥æŸ¥çœ‹å½“å‰æ•°æ®åº“ä¸­çš„è¡¨æ ¼</li>
<li><code>\d &lt;table_name&gt;;</code>, <code>\d+ &lt;table_name&gt;;</code>: å¯ä»¥æŸ¥çœ‹å¯¹åº”è¡¨æ ¼çš„schema</li>
</ul>
<p><br></p>
<p>å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨<strong>å‘½ä»¤è¡Œ</strong>ä¸­è¾“å…¥ï¼š</p>
<ul>
<li><code>psql -d testdb -c '\d'</code></li>
<li><code>psql -d testdb -c '\d+'</code></li>
<li><code>psql -d testdb -c '\d &lt;table_name&gt;'</code></li>
<li><code>psql -d testdb -c '\d+ &lt;table_name&gt;'</code></li>
</ul>
<p>å¦å¤–æœ‰å…³PostgreSQLçš„å®‰è£…å’Œé…ç½®è§æˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç« : <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">[DBMS] PostgreSQL å®‰è£…ä¸é…ç½®</a></p>
<a id="more"></a>
<h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><h2 id="TUM-Uniæ•°æ®é›†"><a href="#TUM-Uniæ•°æ®é›†" class="headerlink" title="TUM Uniæ•°æ®é›†"></a>TUM Uniæ•°æ®é›†</h2><p><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p>
<p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p>
<p>Schmaæ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚æ˜¯ä¸€ä¸ªå¾ˆå°çš„æ•°æ®é›†ï¼Œ å…³äºå­¦ç”Ÿæ•™æˆå¤§å­¦è¯¾ç¨‹è€ƒè¯•ç­‰ç­‰è¡¨æ ¼ã€‚è¿™ä¸ªæ•°æ®é›†å¾ˆé€‚åˆç”¨æ¥å­¦ä¹ ï¼Œç»ƒä¹ SQLã€‚æˆ‘å¯¹è¿™ä¸ªæ•°æ®é›†å†™äº†å¾ˆå¤šæ–‡ç« ï¼Œæä¾›SQLçš„ç»ƒä¹ ï¼Œå¤§å®¶å¯ä»¥å»<span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAyMTYxODQ2MQ==" title="https://segmentfault.com/a/1190000021618461">æˆ‘çš„ä¸“æ ç›®å½•<i class="fa fa-external-link"></i></span>å»å¯»æ‰¾ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql</span><br><span class="line">$ psql testdb &lt; uni_mysql.sql</span><br><span class="line">$ psql testdb <span class="comment"># ç„¶åæˆ‘ä»¬å°±è¿›å…¥è¿™ä¸ªtestdbï¼Œå¯ä»¥å¯¹è¿™äº›è¡¨æ ¼è¿›è¡Œæ“ä½œäº†ã€‚</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                        List of relations</span><br><span class="line"> Schema |     Name     | Type  | Owner |    Size    | Description </span><br><span class="line">--------+--------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | assistenten  | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | hoeren       | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | professoren  | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | pruefen      | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | studenten    | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | voraussetzen | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | vorlesungen  | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line">(<span class="number">7</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ studenten;</span><br><span class="line">                                         Table <span class="string">"public.studenten"</span></span><br><span class="line">  Column  |         Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">----------+-----------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> matrnr   | integer               |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> name     | character varying(30) |           | not null |         | extended |              | </span><br><span class="line"> semester | integer               |           |          |         | plain    |              | </span><br><span class="line">Indexes:</span><br><span class="line">    <span class="string">"studenten_pkey"</span> PRIMARY KEY, btree (matrnr)</span><br><span class="line">Referenced by:</span><br><span class="line">    TABLE <span class="string">"hoeren"</span> CONSTRAINT <span class="string">"hoeren_matrnr_fkey"</span> <span class="function">FOREIGN <span class="title">KEY</span> <span class="params">(matrnr)</span> REFERENCES <span class="title">studenten</span><span class="params">(matrnr)</span> ON DELETE CASCADE</span></span><br><span class="line">    TABLE "pruefen" CONSTRAINT "pruefen_matrnr_fkey" FOREIGN KEY (matrnr) REFERENCES studenten(matrnr) ON DELETE CASCADE</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="TUM-åé¡¹å…¨èƒ½æ¯”èµ›æ•°æ®é›†"><a href="#TUM-åé¡¹å…¨èƒ½æ¯”èµ›æ•°æ®é›†" class="headerlink" title="TUM åé¡¹å…¨èƒ½æ¯”èµ›æ•°æ®é›†"></a>TUM åé¡¹å…¨èƒ½æ¯”èµ›æ•°æ®é›†</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vc3FsX3plaG5rYW1wZl9kaXN6aXBsaW4uc3FsP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/ws1920/grundlagen/sql_zehnkampf_disziplin.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/sql_zehnkampf_disziplin.sql?lang=de<i class="fa fa-external-link"></i></span></p>
<p>è¿™é‡Œæˆ‘æŠŠschemaæ”¹å†™æˆè‹±æ–‡ï¼š<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> ZehnkampfD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ZehnkampfD (</span><br><span class="line">    <span class="keyword">Name</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    Discipline <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    points <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ZehnkampfD <span class="keyword">values</span></span><br><span class="line">    (<span class="string">'Bolt'</span>,        <span class="string">'100m'</span>,         <span class="number">50</span>),</span><br><span class="line">    (<span class="string">'Bolt'</span>,        <span class="string">'Weitsprung'</span>,   <span class="number">50</span>),</span><br><span class="line">    (<span class="string">'Eaton'</span>,       <span class="string">'100m'</span>,         <span class="number">40</span>),</span><br><span class="line">    (<span class="string">'Eaton'</span>,       <span class="string">'Weitsprung'</span>,   <span class="number">60</span>),</span><br><span class="line">    (<span class="string">'Suarez'</span>,      <span class="string">'100m'</span>,         <span class="number">60</span>),</span><br><span class="line">    (<span class="string">'Suarez'</span>,      <span class="string">'Weitsprung'</span>,   <span class="number">60</span>),</span><br><span class="line">    (<span class="string">'Behrenbruch'</span>, <span class="string">'100m'</span>,         <span class="number">30</span>),</span><br><span class="line">    (<span class="string">'Behrenbruch'</span>, <span class="string">'Weitsprung'</span>,   <span class="number">50</span>)</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>å†æŠŠè¿™å‡ è¡Œå†™å…¥æ–‡ä»¶<code>ZehnkampfD.sql</code>ï¼Œè½½å…¥æ•°æ®åº“<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># è¿™é‡Œtestdbåº”è¯¥æ˜¯å¦å¤–ä¸€ä¸ªæ–°å»ºçš„ æ²¡æœ‰è½½å…¥æ•°æ®çš„æ•°æ®åº“</span></span><br><span class="line">$ psql testdb &lt; ZehnkampfD.sql</span><br><span class="line">$ psql testdb <span class="comment"># ç„¶åæˆ‘ä»¬å°±è¿›å…¥è¿™ä¸ªtestdbï¼Œå¯ä»¥å¯¹è¿™äº›è¡¨æ ¼è¿›è¡Œæ“ä½œäº†ã€‚</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                       List of relations</span><br><span class="line"> Schema |    Name    | Type  | Owner |    Size    | Description </span><br><span class="line">--------+------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | zehnkampfd | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ zehnkampfd;</span><br><span class="line">                                          Table <span class="string">"public.zehnkampfd"</span></span><br><span class="line">  Column   |          Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">-----------+------------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> name      | character varying(100) |           | not null |         | extended |              | </span><br><span class="line"> disziplin | character varying(100) |           | not null |         | extended |              | </span><br><span class="line"> punkte    | integer                |           | <span class="keyword">not</span> null |         | plain    |              |</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="TUM-å…¬å…±äº¤é€šæ•°æ®é›†"><a href="#TUM-å…¬å…±äº¤é€šæ•°æ®é›†" class="headerlink" title="TUM å…¬å…±äº¤é€šæ•°æ®é›†"></a>TUM å…¬å…±äº¤é€šæ•°æ®é›†</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vc3FsX2ZhaHJwbGFuLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/sql_fahrplan.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/sql_fahrplan.sql?lang=de<i class="fa fa-external-link"></i></span></p>
<p>è¿™é‡Œæˆ‘æŠŠschemaæ”¹å†™æˆè‹±æ–‡ï¼š<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> Fahrplan;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Fahrplan (</span><br><span class="line">    From_ <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    To_ <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    Line_ <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    depart <span class="built_in">TIME</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    arrival <span class="built_in">TIME</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Fahrplan <span class="keyword">values</span></span><br><span class="line">    (<span class="string">'Garching, Forschungszentrum'</span>,     <span class="string">'Garching'</span>,                     <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:06:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:09:00'</span>),</span><br><span class="line">    (<span class="string">'Garching'</span>,                        <span class="string">'Garching-HochbrÃ¼ck'</span>,           <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:09:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:11:00'</span>),</span><br><span class="line">    (<span class="string">'Garching-HochbrÃ¼ck'</span>,              <span class="string">'FrÃ¶ttmaning'</span>,                  <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:11:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:15:00'</span>),</span><br><span class="line">    (<span class="string">'Garching'</span>,                        <span class="string">'Garching, Forschungszentrum'</span>,  <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:06:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:09:00'</span>),</span><br><span class="line">    (<span class="string">'Garching-HochbrÃ¼ck'</span>,              <span class="string">'Garching'</span>,                     <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:04:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:06:00'</span>),</span><br><span class="line">    (<span class="string">'FrÃ¶ttmaning'</span>,                     <span class="string">'Garching-HochbrÃ¼ck'</span>,           <span class="string">'U6'</span>,  <span class="built_in">TIME</span> <span class="string">'09:00:00'</span>, <span class="built_in">TIME</span> <span class="string">'09:04:00'</span>),</span><br><span class="line">    (<span class="string">'Garching, Forschungszentrum'</span>,     <span class="string">'Technische UniversitÃ¤t'</span>,       <span class="string">'690'</span>, <span class="built_in">TIME</span> <span class="string">'17:56:00'</span>, <span class="built_in">TIME</span> <span class="string">'17:57:00'</span>)</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>å†æŠŠè¿™å‡ è¡Œå†™å…¥æ–‡ä»¶<code>Fahrplan.sql</code>ï¼Œè½½å…¥æ•°æ®åº“<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># è¿™é‡Œtestdbåº”è¯¥æ˜¯å¦å¤–ä¸€ä¸ªæ–°å»ºçš„ æ²¡æœ‰è½½å…¥æ•°æ®çš„æ•°æ®åº“</span></span><br><span class="line">$ psql testdb &lt; Fahrplan.sql</span><br><span class="line">$ psql testdb <span class="comment"># ç„¶åæˆ‘ä»¬å°±è¿›å…¥è¿™ä¸ªtestdbï¼Œå¯ä»¥å¯¹è¿™äº›è¡¨æ ¼è¿›è¡Œæ“ä½œäº†ã€‚</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# \d+;</span><br><span class="line">                      List of relations</span><br><span class="line"> Schema |   Name   | Type  | Owner |    Size    | Description </span><br><span class="line">--------+----------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | fahrplan | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ fahrplan;</span><br><span class="line">                                          Table <span class="string">"public.fahrplan"</span></span><br><span class="line"> Column  |          Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">---------+------------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> von     | character varying(100) |           | not null |         | extended |              | </span><br><span class="line"> nach    | character varying(100) |           | not null |         | extended |              | </span><br><span class="line"> linie   | character varying(10)  |           | not null |         | extended |              | </span><br><span class="line"> abfahrt | time without time zone |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> ankunft | time without time zone |           | <span class="keyword">not</span> null |         | plain    |              |</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="TPC-H"><a href="#TPC-H" class="headerlink" title="TPC-H"></a>TPC-H</h2><p>æˆ‘å•ç‹¬å†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œè§æˆ‘çš„åšå®¢: <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS]PostgreSQLå¯¼å…¥TPC-Hæ•°æ®é›†</a></p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                        List of relations</span><br><span class="line"> Schema |     Name     | Type  | Owner |    Size    | Description </span><br><span class="line">--------+--------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | customer     | table | jigao | <span class="number">28</span> MB      | </span><br><span class="line"> <span class="keyword">public</span> | lineitem     | table | jigao | <span class="number">879</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | nation       | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | orders       | table | jigao | <span class="number">204</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | part         | table | jigao | <span class="number">32</span> MB      | </span><br><span class="line"> <span class="keyword">public</span> | partsupp     | table | jigao | <span class="number">136</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | region       | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | supplier     | table | jigao | <span class="number">1800</span> kB    | </span><br><span class="line">(<span class="number">8</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ customer;</span><br><span class="line">                                            Table <span class="string">"public.customer"</span></span><br><span class="line">    Column    |          Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">--------------+------------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> c_custkey    | integer                |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> c_name       | character varying(25)  |           | not null |         | extended |              | </span><br><span class="line"> c_address    | character varying(40)  |           | not null |         | extended |              | </span><br><span class="line"> c_nationkey  | integer                |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> c_phone      | character(<span class="number">15</span>)          |           | <span class="keyword">not</span> null |         | extended |              | </span><br><span class="line"> c_acctbal    | numeric(<span class="number">15</span>,<span class="number">2</span>)          |           | <span class="keyword">not</span> null |         | main     |              | </span><br><span class="line"> c_mktsegment | character(<span class="number">10</span>)          |           | <span class="keyword">not</span> null |         | extended |              | </span><br><span class="line"> c_comment    | character varying(117) |           | not null |         | extended |              |</span><br></pre></td></tr></tbody></table></figure>
<h2 id="IMDb-æ•°æ®é›†"><a href="#IMDb-æ•°æ®é›†" class="headerlink" title="IMDb æ•°æ®é›†"></a>IMDb æ•°æ®é›†</h2><h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxNzE4L2ZvdW5kYXRpb25zZGUvYWN0b3JzLmxpc3QueHo=" title="https://db.in.tum.de/teaching/ws1718/foundationsde/actors.list.xz">https://db.in.tum.de/teaching/ws1718/foundationsde/actors.list.xz<i class="fa fa-external-link"></i></span></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://db.in.tum.de/teaching/ws1718/foundationsde/actors.list.xz</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¤„ç†"><a href="#å¤„ç†" class="headerlink" title="å¤„ç†"></a>å¤„ç†</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ unxz actors.list.xz </span><br><span class="line">$ awk <span class="string">'NR &gt;= 241 &amp;&amp; NR &lt;= 20494548'</span> actors.list &gt; actorsTrimmed.list</span><br><span class="line">$ iconv -f latin1 -t utf-8 actorsTrimmed.list &gt; actorsUtf8.list</span><br><span class="line">$ sed -r -e <span class="string">'s/\t+/|/g'</span> -e <span class="string">'s/((\s*)|(\{.*\})|(\[.*\])|(&lt;.*&gt;)|\(.*[a-zA-Z].*\))*$//g'</span> actorsUtf8.list | awk -F <span class="string">'|'</span>  <span class="string">'{if($1 != "") { actor = $1 }; if ($2) print actor "|" $2 }'</span> &gt; actors.csv</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¯¼å…¥psqlå¹¶å»ºç«‹ç´¢å¼•"><a href="#å¯¼å…¥psqlå¹¶å»ºç«‹ç´¢å¼•" class="headerlink" title="å¯¼å…¥psqlå¹¶å»ºç«‹ç´¢å¼•"></a>å¯¼å…¥psqlå¹¶å»ºç«‹ç´¢å¼•</h3><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"># è¿™é‡Œtestdbåº”è¯¥æ˜¯å¦å¤–ä¸€ä¸ªæ–°å»ºçš„ æ²¡æœ‰è½½å…¥æ•°æ®çš„æ•°æ®åº“</span><br><span class="line">$ psql testdb # ç„¶åæˆ‘ä»¬å°±è¿›å…¥è¿™ä¸ªtestdbï¼Œå¯ä»¥å¯¹è¿™äº›è¡¨æ ¼è¿›è¡Œæ“ä½œäº†ã€‚</span><br><span class="line"></span><br><span class="line">testdb=# create table playedin_text (actor_name <span class="built_in">text</span> <span class="keyword">not</span> null, movie_name <span class="built_in">text</span> <span class="keyword">not</span> null);</span><br><span class="line"></span><br><span class="line">testdb=# \copy playedin_text from actors.csv delimiter <span class="string">'|'</span>;</span><br><span class="line"></span><br><span class="line">testdb=# create table movies (id serial primary key , name <span class="built_in">text</span> <span class="keyword">not</span> null );</span><br><span class="line"></span><br><span class="line">testdb=# insert into movies ( name ) select distinct movie_name from playedin_text ;</span><br><span class="line"></span><br><span class="line">testdb=# create table actors (id serial primary key , name <span class="built_in">text</span> <span class="keyword">not</span> null );</span><br><span class="line"></span><br><span class="line">testdb=# insert into actors ( name ) select distinct actor_name from playedin_text ;</span><br><span class="line"></span><br><span class="line">testdb=# create table playedin ( movie integer references movies (id), actor integer references actors (id));</span><br><span class="line"></span><br><span class="line">testdb=# insert into playedin (actor , movie ) select actors.id , movies.id from actors, movies, playedin_text p where p.actor_name = actors.name <span class="keyword">and</span> p.movie_name = movies.name;</span><br><span class="line"></span><br><span class="line">testdb=# create index on playedin ( actor ); <span class="function">create index on <span class="title">playedin</span> <span class="params">( movie )</span></span>;</span><br><span class="line"></span><br><span class="line">testdb=# create index on playedin (actor); </span><br><span class="line"></span><br><span class="line">testdb=# create index on playedin (movie);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="æ£€æŸ¥"><a href="#æ£€æŸ¥" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h3><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                          List of relations</span><br><span class="line"> Schema |     Name      |   Type   | Owner |    Size    | Description </span><br><span class="line">--------+---------------+----------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | actors        | table    | jigao | <span class="number">98</span> MB      | </span><br><span class="line"> <span class="keyword">public</span> | actors_id_seq | sequence | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | movies        | table    | jigao | <span class="number">66</span> MB      | </span><br><span class="line"> <span class="keyword">public</span> | movies_id_seq | sequence | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | playedin      | table    | jigao | <span class="number">599</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | playedin_text | table    | jigao | <span class="number">1183</span> MB    | </span><br><span class="line">(<span class="number">6</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d actors</span><br><span class="line">                            Table <span class="string">"public.actors"</span></span><br><span class="line"> Column |  Type   | Collation | Nullable |              Default               </span><br><span class="line">--------+---------+-----------+----------+------------------------------------</span><br><span class="line"> id     | integer |           | not null | nextval('actors_id_seq'::regclass)</span><br><span class="line"> name   | <span class="built_in">text</span>    |           | <span class="keyword">not</span> null | </span><br><span class="line">Indexes:</span><br><span class="line">    <span class="string">"actors_pkey"</span> PRIMARY KEY, btree (id)</span><br><span class="line">Referenced by:</span><br><span class="line">    TABLE <span class="string">"playedin"</span> CONSTRAINT <span class="string">"playedin_actor_fkey"</span> <span class="function">FOREIGN <span class="title">KEY</span> <span class="params">(actor)</span> REFERENCES <span class="title">actors</span><span class="params">(id)</span></span></span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="CMU-15445-æ­Œæ‰‹æ•°æ®é›†"><a href="#CMU-15445-æ­Œæ‰‹æ•°æ®é›†" class="headerlink" title="CMU-15445 æ­Œæ‰‹æ•°æ®é›†"></a>CMU-15445 æ­Œæ‰‹æ•°æ®é›†</h2><p>è¿™ä¸ªæ•°æ®é›†åœ¨CMU-15445 Lec2 Advanced SQLä¸­ä½¿ç”¨ï¼Œè§æˆ‘çš„ä¸¤ç¯‡åšå®¢ç¬”è®°:</p>
<ul>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part1/">[CMU-15445]Lec02_part1</a></li>
<li><a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/">[CMU-15445]Lec02_part2</a></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec02/7.jpg" alt="7.jpg"></p>
<p>å¯¹åº”çš„SQLè¯­å¥ã€€<a href="https://cakebytheoceanluo.github.io/download/CMU15445/lec02_schema.sql">ä¸‹è½½</a>ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> student <span class="keyword">CASCADE</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> course <span class="keyword">CASCADE</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> enrolled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student </span><br><span class="line">   (<span class="keyword">sid</span> <span class="built_in">int</span> primary <span class="keyword">key</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">16</span>), </span><br><span class="line">    login <span class="built_in">varchar</span>(<span class="number">32</span>), </span><br><span class="line">    age <span class="built_in">smallint</span>, </span><br><span class="line">    gpa <span class="built_in">numeric</span>(<span class="number">2</span>, <span class="number">1</span>) <span class="keyword">check</span> (gpa <span class="keyword">between</span> <span class="number">0.0</span> <span class="keyword">and</span> <span class="number">4.0</span>)</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> course </span><br><span class="line">   (cid <span class="built_in">varchar</span>(<span class="number">32</span>) primary <span class="keyword">key</span>, </span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> enrolled </span><br><span class="line">   (<span class="keyword">sid</span> <span class="built_in">int</span> <span class="keyword">references</span> student (<span class="keyword">sid</span>) <span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">cascade</span>, </span><br><span class="line">    cid <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">references</span> course (cid) <span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">cascade</span>, </span><br><span class="line">    grade <span class="built_in">char</span>(<span class="number">1</span>) <span class="keyword">check</span> (grade <span class="keyword">in</span> (<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>)),</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">sid</span>, cid)</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (<span class="keyword">sid</span>, <span class="keyword">name</span>, login, age, gpa) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'Kanye'</span>, <span class="string">'kanye@cs'</span>, <span class="number">39</span>, <span class="number">4.0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (<span class="keyword">sid</span>, <span class="keyword">name</span>, login, age, gpa) <span class="keyword">values</span> (<span class="number">53688</span>, <span class="string">'Bieber'</span>, <span class="string">'jbieber@cs'</span>, <span class="number">22</span>, <span class="number">3.9</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (<span class="keyword">sid</span>, <span class="keyword">name</span>, login, age, gpa) <span class="keyword">values</span> (<span class="number">53655</span>, <span class="string">'Tupac'</span>, <span class="string">'shakur@cs'</span>, <span class="number">26</span>, <span class="number">3.5</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-445'</span>, <span class="string">'Database Systems'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-721'</span>, <span class="string">'Advanced Database Systems'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-826'</span>, <span class="string">'Data Mining'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-823'</span>, <span class="string">'Advanced Topics in Databases'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'15-445'</span>, <span class="string">'C'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53688</span>, <span class="string">'15-721'</span>, <span class="string">'A'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'15-826'</span>, <span class="string">'B'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53655</span>, <span class="string">'15-445'</span>, <span class="string">'B'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'15-721'</span>, <span class="string">'C'</span>);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯ä»¥åœ¨PostgreSQL, MySQL, SQLiteä¸­ä½¿ç”¨</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://cakebytheoceanluo.github.io/download/CMU15445/lec02_schema.sql</span><br><span class="line">$ psql testdb &lt; uni_mysql.sql</span><br><span class="line">$ psql testdb <span class="comment"># ç„¶åæˆ‘ä»¬å°±è¿›å…¥è¿™ä¸ªtestdbï¼Œå¯ä»¥å¯¹è¿™äº›è¡¨æ ¼è¿›è¡Œæ“ä½œäº†ã€‚</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                        List of relations</span><br><span class="line"> Schema |     Name     | Type  | Owner |    Size    | Description </span><br><span class="line">--------+--------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | course       | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | enrolled     | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line"> <span class="keyword">public</span> | student      | table | jigao | <span class="number">8192</span> bytes | </span><br><span class="line">(<span class="number">3</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ enrolled</span><br><span class="line">                                         Table <span class="string">"public.enrolled"</span></span><br><span class="line"> Column |         Type          | Collation | Nullable | Default | Storage  | Stats target | Description </span><br><span class="line">--------+-----------------------+-----------+----------+---------+----------+--------------+-------------</span><br><span class="line"> sid    | integer               |           | <span class="keyword">not</span> null |         | plain    |              | </span><br><span class="line"> cid    | character varying(<span class="number">32</span>) |           | <span class="keyword">not</span> null |         | extended |              | </span><br><span class="line"> grade  | character(<span class="number">1</span>)          |           |          |         | extended |              | </span><br><span class="line">Indexes:</span><br><span class="line">    <span class="string">"enrolled_pkey"</span> PRIMARY KEY, btree (sid, cid)</span><br><span class="line">Check constraints:</span><br><span class="line">    <span class="string">"enrolled_grade_check"</span> CHECK (grade = ANY (ARRAY[<span class="string">'A'</span>::bpchar, <span class="string">'B'</span>::bpchar, <span class="string">'C'</span>::bpchar]))</span><br><span class="line">Foreign-key constraints:</span><br><span class="line">    <span class="string">"enrolled_cid_fkey"</span> FOREIGN KEY (cid) REFERENCES course(cid) ON DELETE CASCADE</span><br><span class="line">    <span class="string">"enrolled_sid_fkey"</span> FOREIGN KEY (sid) REFERENCES student(sid) ON DELETE CASCADE</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="CMU-15445-åˆ†æ•°æ•°æ®é›†-Mock"><a href="#CMU-15445-åˆ†æ•°æ•°æ®é›†-Mock" class="headerlink" title="CMU-15445 åˆ†æ•°æ•°æ®é›† (Mock)"></a>CMU-15445 åˆ†æ•°æ•°æ®é›† (Mock)</h2><p>æ›´å¤šå…³äºè¿™ä¸ªæ•°æ®é›†ï¼Œè§è¿™ä¸ªå®éªŒ<a href="https://cakebytheoceanluo.github.io/2020/03/16/DBMS-Postgres%E7%B2%BE%E5%BA%A6%E9%97%AE%E9%A2%98precision-numbers/">[DBMS] Postgres ç²¾åº¦é—®é¢˜ precision_numbers</a></p>
<p>è¿™ä¸ªå®éªŒæœåŠ¡äº<a href="https://cakebytheoceanluo.github.io/2020/03/16/CMU-15445-Lec04/">[CMU-15445]Lec04</a></p>
<h3 id="æ•°æ®é›†faker"><a href="#æ•°æ®é›†faker" class="headerlink" title="æ•°æ®é›†faker"></a>æ•°æ®é›†faker</h3><p>æˆ‘ç”¨pythonå†™äº†ä¸€ä¸ªç±»ä¼¼çš„æ•°æ®é›†faker:</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">    print(<span class="string">f'<span class="subst">{float(Decimal(random.randrange(<span class="number">0</span>, <span class="number">100000000</span>) / <span class="number">1000000</span>))}</span>,<span class="subst">{float(Decimal(random.randrange(<span class="number">0</span>, <span class="number">100000000</span>) / <span class="number">1000000</span>))}</span>'</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="ä¸‹è½½-1"><a href="#ä¸‹è½½-1" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h4><p>ä¸‹è½½: <a href="https://cakebytheoceanluo.github.io/download/CMU15445/lec04_float_faker.py">lec04_float_faker.py</a></p>
<h4 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h4><p>ä½¿ç”¨:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./lec04_float_faker.py &gt; data.csv</span><br></pre></td></tr></tbody></table></figure>
<p>åˆ°ç°åœ¨æˆ‘ä»¬è·å¾—äº†<code>data.csv</code>è¿™ä¸ªæ–‡ä»¶:</p>
<h3 id="å¯¼å…¥æ•°æ®é›†"><a href="#å¯¼å…¥æ•°æ®é›†" class="headerlink" title="å¯¼å…¥æ•°æ®é›†"></a>å¯¼å…¥æ•°æ®é›†</h3><h4 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h4><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> testreals;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> testdecimals;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> testreals (a <span class="built_in">REAL</span> <span class="keyword">not</span> <span class="literal">null</span>, b <span class="built_in">REAL</span> <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> testdecimals (a <span class="built_in">DECIMAL</span>(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> <span class="literal">null</span>, b <span class="built_in">DECIMAL</span>(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line">copy testreals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">copy testdecimals from '/tmp/data.csv' delimiter ',' csv;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="è¾“å‡ºä¾‹å­"><a href="#è¾“å‡ºä¾‹å­" class="headerlink" title="è¾“å‡ºä¾‹å­"></a>è¾“å‡ºä¾‹å­</h4><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# drop table <span class="keyword">if</span> <span class="built_in">exists</span> testreals;</span><br><span class="line">DROP TABLE</span><br><span class="line"></span><br><span class="line">testdb=# drop table <span class="keyword">if</span> <span class="built_in">exists</span> testdecimals;</span><br><span class="line">DROP TABLE</span><br><span class="line"></span><br><span class="line">testdb=# create table testreals (a REAL <span class="keyword">not</span> null, b REAL <span class="keyword">not</span> null);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">testdb=# create table testdecimals (a DECIMAL(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> null, b DECIMAL(<span class="number">10</span>, <span class="number">6</span>) <span class="keyword">not</span> null);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">testdb=# copy testreals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">COPY <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line">testdb=# copy testdecimals from '/tmp/data.csv' delimiter ',' csv;</span><br><span class="line">COPY <span class="number">10000000</span></span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# \d+</span><br><span class="line">                        List of relations</span><br><span class="line"> Schema |     Name     | Type  | Owner |    Size    | Description </span><br><span class="line">--------+--------------+-------+-------+------------+-------------</span><br><span class="line"> <span class="keyword">public</span> | testdecimals | table | jigao | <span class="number">496</span> MB     | </span><br><span class="line"> <span class="keyword">public</span> | testreals    | table | jigao | <span class="number">346</span> MB     | </span><br><span class="line">(<span class="number">2</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# \d+ testreals </span><br><span class="line">                               Table <span class="string">"public.testreals"</span></span><br><span class="line"> Column | Type | Collation | Nullable | Default | Storage | Stats target | Description </span><br><span class="line">--------+------+-----------+----------+---------+---------+--------------+-------------</span><br><span class="line"> a      | real |           | <span class="keyword">not</span> null |         | plain   |              | </span><br><span class="line"> b      | real |           | <span class="keyword">not</span> null |         | plain   |              | </span><br><span class="line"></span><br><span class="line">testdb=# \d+ testdecimals </span><br><span class="line">                                  Table <span class="string">"public.testdecimals"</span></span><br><span class="line"> Column |     Type      | Collation | Nullable | Default | Storage | Stats target | Description </span><br><span class="line">--------+---------------+-----------+----------+---------+---------+--------------+-------------</span><br><span class="line"> a      | numeric(<span class="number">10</span>,<span class="number">6</span>) |           | <span class="keyword">not</span> null |         | main    |              | </span><br><span class="line"> b      | numeric(<span class="number">10</span>,<span class="number">6</span>) |           | <span class="keyword">not</span> null |         | main    |              |</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>DBMS</category>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[DBMS]PostgreSQLå¯¼å…¥TPC-Hæ•°æ®é›†</title>
    <url>/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5TPC-H%E6%95%B0%E6%8D%AE%E9%9B%86/</url>
    <content><![CDATA[<p>æœ¬æ–‡å…³æ³¨å¦‚ä½•å°†TPC-Hæ•°æ®é›†å¯¼å…¥è‡³PostgreSQL, åŒæ—¶ç®€å•æä¸€ä¸‹å¦‚ä½•ç”ŸæˆTPC-Hæ•°æ®ã€‚</p>
<h1 id="TPC-Hä»‹ç»"><a href="#TPC-Hä»‹ç»" class="headerlink" title="TPC-Hä»‹ç»"></a>TPC-Hä»‹ç»</h1><blockquote>
<p>TPC-H is a Decision Support Benchmark. The TPC Benchmarkâ„¢H (TPC-H) is a decision support benchmark. It consists of a suite of business oriented ad-hoc queries and concurrent data modifications. <sup><a href="#fn1">1</a></sup></p>
</blockquote>
<p>TPC-Hæ˜¯TPCåä¼šæä¾›çš„ä¸€ä¸ªbenchmarkï¼Œç”¨æ¥æ¨¡æ‹Ÿä¸€ä¸ªç°å®ä¸­çš„å•†ä¸šåº”ç”¨ï¼Œä¸”è‡ªå¸¦22ä¸ªSQL Queryã€‚è¿™22ä¸ªQueryå‡å…³æ³¨äºOLAPåˆ†æå‹æŸ¥è¯¢ã€‚<br>è¿™äº›Queryå¯ä»¥åœ¨å¦‚ä¸‹çš„åœ°æ–¹æ‰¾åˆ°:</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLzJuZFF1YWRyYW50L3BnLXRwY2gvdHJlZS9tYXN0ZXIvcXVlcmllcw==" title="https://github.com/2ndQuadrant/pg-tpch/tree/master/queries">https://github.com/2ndQuadrant/pg-tpch/tree/master/queries<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbCM=" title="https://hyper-db.de/interface.html#">https://hyper-db.de/interface.html#<i class="fa fa-external-link"></i></span> ç‚¹å‡»å³ä¸‹è§’Insert TPC-H Query</li>
<li><span class="exturl" data-url="aHR0cHM6Ly91bWJyYS5kYi5pbi50dW0uZGUvaW50ZXJmYWNlLw==" title="https://umbra.db.in.tum.de/interface/">https://umbra.db.in.tum.de/interface/<i class="fa fa-external-link"></i></span>ã€€ç‚¹å‡»Load Query</li>
</ul>
<p>æœ‰ä¸€ç¯‡è®ºæ–‡å…·ä½“è®²æ¯ä¸€ä¸ªTPC-Hçš„Queryï¼Œå®é™…ä¸Šå’Œæœ¬æ–‡æ— å…³ï¼Œæˆ‘é“¾æ¥åœ¨è¿™é‡Œï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9ob21lcGFnZXMuY3dpLm5sL35ib25jei9zbmItY2hhbGxlbmdlL2Nob2tlcG9pbnRzLXRwY3RjLnBkZg==" title="https://homepages.cwi.nl/~boncz/snb-challenge/chokepoints-tpctc.pdf">TPC-H Analyzed: Hidden Messages and Lessons Learned from an Influential Benchmark<i class="fa fa-external-link"></i></span></p>
<a id="more"></a>
<h1 id="TPC-Hæ•°æ®é›†"><a href="#TPC-Hæ•°æ®é›†" class="headerlink" title="TPC-Hæ•°æ®é›†"></a>TPC-Hæ•°æ®é›†</h1><p>æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ç”ŸæˆTPC-Hæ˜¯æ•°æ®é›†ï¼Œå¸¸å¸¸æˆä¸º<strong>synthetic dataset</strong>, äººå·¥ç”Ÿæˆçš„æ•°æ®é›†ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VsZWN0cnVtL3RwY2gtZGJnZW4=" title="https://github.com/electrum/tpch-dbgen">https://github.com/electrum/tpch-dbgen<i class="fa fa-external-link"></i></span></p>
<p>ä½¿ç”¨æ–¹æ³•æ˜¯ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git@github.com:electrum/tpch-dbgen.git</span><br><span class="line">Cloning into <span class="string">'tpch-dbgen'</span>...</span><br><span class="line">remote: Enumerating objects: 149, <span class="keyword">done</span>.</span><br><span class="line">remote: Total 149 (delta 0), reused 0 (delta 0), pack-reused 149</span><br><span class="line">Receiving objects: 100% (149/149), 214.31 KiB | 637.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Resolving deltas: 100% (34/34), <span class="keyword">done</span>.</span><br><span class="line">$ <span class="built_in">cd</span> tpch-dbgen/</span><br><span class="line">$ make</span><br><span class="line"><span class="comment">## make çš„è¾“å‡ºæˆ‘å…¨éƒ¨åˆ å»äº†</span></span><br><span class="line">$ ./dbgen</span><br><span class="line">TPC-H Population Generator (Version 2.14.0)</span><br><span class="line">Copyright Transaction Processing Performance Council 1994 - 2010</span><br><span class="line">$ ls | grep <span class="string">'.*.tbl'</span></span><br><span class="line">customer.tbl</span><br><span class="line">lineitem.tbl</span><br><span class="line">nation.tbl</span><br><span class="line">orders.tbl</span><br><span class="line">partsupp.tbl</span><br><span class="line">part.tbl</span><br><span class="line">region.tbl</span><br><span class="line">supplier.tbl</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°æœ€åç”Ÿæˆäº†8ä¸ª<code>.tbl</code>æ–‡ä»¶ï¼Œå®ƒä»¬å°±æ˜¯TPC-Hçš„8ä¸ªè¡¨æ ¼(a.k.aå…³ç³»)ã€‚å¦å¤–æˆ‘è¿™é‡Œç”Ÿæˆçš„æ˜¯TPC-H scale factor=1çš„æ•°æ®é›†ï¼Œå³å®ƒçš„ä¼¸ç¼©ç³»æ•°æ˜¯ï¼‘ï¼Œç”Ÿæˆçš„æ•°æ®å¤§æ¦‚æ˜¯1GiBå·¦å³ã€‚æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ç”Ÿæˆæ•°æ®çš„æ—¶å€™è°ƒæ•´è¿™è¿™scale factor(sf)ï¼Œæ¯”å¦‚å½“å®ƒä¸º10çš„æ—¶å€™ï¼Œç”Ÿæˆçš„æ•°æ®å¤§æ¦‚æ˜¯10GiBå·¦å³ã€‚å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ç”Ÿæˆçš„æ—¶å€™å»ç‰¹å®šç”Ÿæˆä¸€å¼ è¡¨æ ¼ã€‚è¿™äº›æƒ…å†µéƒ½å¯ä»¥åœ¨ï¼Œã€€<code>dbgen</code>è¿™ä¸ªç¨‹åºä¸­é€šè¿‡å‚æ•°ç¡®å®šï¼Œè¿™é‡Œä¹Ÿä¸å†è¯¦ç»†è¯´äº†ã€‚</p>
<h2 id="dbgençš„å„ç§å‚æ•°-å¯ç•¥è¯»æµè§ˆ"><a href="#dbgençš„å„ç§å‚æ•°-å¯ç•¥è¯»æµè§ˆ" class="headerlink" title="dbgençš„å„ç§å‚æ•° (å¯ç•¥è¯»æµè§ˆ)"></a><code>dbgen</code>çš„å„ç§å‚æ•° (å¯ç•¥è¯»æµè§ˆ)</h2><p>è¯¦è§ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./dbgen --<span class="built_in">help</span></span><br><span class="line">./dbgen: invalid option -- <span class="string">'-'</span></span><br><span class="line">ERROR: option <span class="string">'-'</span> unknown.</span><br><span class="line">TPC-H Population Generator (Version 2.14.0 build 0)</span><br><span class="line">Copyright Transaction Processing Performance Council 1994 - 2010</span><br><span class="line">USAGE:</span><br><span class="line">dbgen [-{vf}][-T {pcsoPSOL}]</span><br><span class="line">	[-s &lt;scale&gt;][-C &lt;procs&gt;][-S &lt;step&gt;]</span><br><span class="line">dbgen [-v] [-O m] [-s &lt;scale&gt;] [-U &lt;updates&gt;]</span><br><span class="line"></span><br><span class="line">Basic Options</span><br><span class="line">===========================</span><br><span class="line">-C &lt;n&gt; -- separate data <span class="built_in">set</span> into &lt;n&gt; chunks (requires -S, default: 1)</span><br><span class="line">-f     -- force. Overwrite existing files</span><br><span class="line">-h     -- display this message</span><br><span class="line">-q     -- <span class="built_in">enable</span> QUIET mode</span><br><span class="line">-s &lt;n&gt; -- <span class="built_in">set</span> Scale Factor (SF) to  &lt;n&gt; (default: 1) </span><br><span class="line">-S &lt;n&gt; -- build the &lt;n&gt;th step of the data/update <span class="built_in">set</span> (used with -C or -U)</span><br><span class="line">-U &lt;n&gt; -- generate &lt;n&gt; update sets</span><br><span class="line">-v     -- <span class="built_in">enable</span> VERBOSE mode</span><br><span class="line"></span><br><span class="line">Advanced Options</span><br><span class="line">===========================</span><br><span class="line">-b &lt;s&gt; -- load distributions <span class="keyword">for</span> &lt;s&gt; (default: dists.dss)</span><br><span class="line">-d &lt;n&gt; -- split deletes between &lt;n&gt; files (requires -U)</span><br><span class="line">-i &lt;n&gt; -- split inserts between &lt;n&gt; files (requires -U)</span><br><span class="line">-T c   -- generate cutomers ONLY</span><br><span class="line">-T l   -- generate nation/region ONLY</span><br><span class="line">-T L   -- generate lineitem ONLY</span><br><span class="line">-T n   -- generate nation ONLY</span><br><span class="line">-T o   -- generate orders/lineitem ONLY</span><br><span class="line">-T O   -- generate orders ONLY</span><br><span class="line">-T p   -- generate parts/partsupp ONLY</span><br><span class="line">-T P   -- generate parts ONLY</span><br><span class="line">-T r   -- generate region ONLY</span><br><span class="line">-T s   -- generate suppliers ONLY</span><br><span class="line">-T S   -- generate partsupp ONLY</span><br><span class="line"></span><br><span class="line">To generate the SF=1 (1GB), validation database population, use:</span><br><span class="line">	dbgen -vf -s 1</span><br><span class="line"></span><br><span class="line">To generate updates <span class="keyword">for</span> a SF=1 (1GB), use:</span><br><span class="line">	dbgen -v -U 1 -s 1</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å¦å¤–å¯æ›¿ä»£ç”Ÿæˆçš„å·¥å…·"><a href="#å¦å¤–å¯æ›¿ä»£ç”Ÿæˆçš„å·¥å…·" class="headerlink" title="å¦å¤–å¯æ›¿ä»£ç”Ÿæˆçš„å·¥å…·"></a>å¦å¤–å¯æ›¿ä»£ç”Ÿæˆçš„å·¥å…·</h2><p>å½“ç„¶ä¹Ÿæœ‰å…¶ä»–å·¥å…·å¯ä»¥ç”Ÿæˆè¿™ä¸ªæ•°æ®é›†ï¼Œã€€æ¯”å¦‚: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dyZWdyYWhuL3RwY2gta2l0" title="https://github.com/gregrahn/tpch-kit">https://github.com/gregrahn/tpch-kit<i class="fa fa-external-link"></i></span>ã€€ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸åœ¨è¿™ç¯‡æ–‡ç« ä¸­èµ˜è¿°ã€‚</p>
<p><br><br><br></p>
<h1 id="PostgreSQLå‡†å¤‡"><a href="#PostgreSQLå‡†å¤‡" class="headerlink" title="PostgreSQLå‡†å¤‡"></a>PostgreSQLå‡†å¤‡</h1><h2 id="æ–°å»ºæ•°æ®åº“"><a href="#æ–°å»ºæ•°æ®åº“" class="headerlink" title="æ–°å»ºæ•°æ®åº“"></a>æ–°å»ºæ•°æ®åº“</h2><p>PostgreSQLå…·ä½“æ“ä½œè¯¦è§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« : <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E5%BA%93">[DBMS] PostgreSQL å®‰è£…ä¸é…ç½® - æ–°å»ºä¸€ä¸ªç”¨æˆ·æ•°æ®åº“</a></p>
<p>è¿™é‡Œæˆ‘å°±å±•ç¤ºæˆ‘çš„å‘½ä»¤å’Œè¾“å‡ºä¾‹å­ï¼Œåœ¨ä½ çš„ç¯å¢ƒä¹Ÿå¤§åŒå°å¼‚ã€‚</p>
<h3 id="æ–°å»ºæ•°æ®åº“å‘½ä»¤"><a href="#æ–°å»ºæ•°æ®åº“å‘½ä»¤" class="headerlink" title="æ–°å»ºæ•°æ®åº“å‘½ä»¤"></a>æ–°å»ºæ•°æ®åº“å‘½ä»¤</h3><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo -u postgres psql</span><br><span class="line">postgres=# CREATE DATABASE tpch;</span><br><span class="line">postgres=# GRANT ALL ON DATABASE tpch to &lt;æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ç”¨æˆ·å ä¸å¸¦å°–è§’æ‹¬å·&gt;;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="è¾“å‡ºä¾‹å­"><a href="#è¾“å‡ºä¾‹å­" class="headerlink" title="è¾“å‡ºä¾‹å­"></a>è¾“å‡ºä¾‹å­</h3><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo -u postgres psql</span><br><span class="line">[sudo] password <span class="keyword">for</span> jigao: </span><br><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">postgres=# CREATE DATABASE tpch_sf1;</span><br><span class="line">CREATE DATABASE</span><br><span class="line">postgres=#  GRANT ALL ON DATABASE tpch_sf1 to jigao;</span><br><span class="line">GRANT</span><br><span class="line">postgres=# \q</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ–°å»ºè¡¨æ ¼"><a href="#æ–°å»ºè¡¨æ ¼" class="headerlink" title="æ–°å»ºè¡¨æ ¼"></a>æ–°å»ºè¡¨æ ¼</h2><p>è¿™é‡Œéœ€è¦ç”¨åˆ°<code>tpch-dbgen/dss.ddl</code>è¿™ä¸ªæ–‡ä»¶ï¼Œå®ƒå°±åœ¨å’Œæˆ‘ä»¬åˆšåˆš<code>dbgen</code>ç¨‹åºåŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨repoä¸­æ‰¾åˆ°ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VsZWN0cnVtL3RwY2gtZGJnZW4vYmxvYi9tYXN0ZXIvZHNzLmRkbA==" title="https://github.com/electrum/tpch-dbgen/blob/master/dss.ddl">https://github.com/electrum/tpch-dbgen/blob/master/dss.ddl<i class="fa fa-external-link"></i></span></p>
<h3 id="æ–°å»ºè¡¨æ ¼å‘½ä»¤"><a href="#æ–°å»ºè¡¨æ ¼å‘½ä»¤" class="headerlink" title="æ–°å»ºè¡¨æ ¼å‘½ä»¤"></a>æ–°å»ºè¡¨æ ¼å‘½ä»¤</h3><p><code>$ psql -d tpch_sf1 &lt; dss.ddl</code></p>
<h3 id="è¾“å‡ºä¾‹å­-1"><a href="#è¾“å‡ºä¾‹å­-1" class="headerlink" title="è¾“å‡ºä¾‹å­"></a>è¾“å‡ºä¾‹å­</h3><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">$ file dss.ddl</span><br><span class="line">dss.ddl: ASCII text</span><br><span class="line">$ psql tpch_sf1 &lt; dss.ddl </span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br></pre></td></tr></tbody></table></figure>
<h3 id="æ£€æŸ¥"><a href="#æ£€æŸ¥" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ psql -d tpch_sf1 -c <span class="string">'\dt+'</span></span><br><span class="line">                      List of relations</span><br><span class="line"> Schema |   Name   | Type  | Owner |  Size   | Description </span><br><span class="line">--------+----------+-------+-------+---------+-------------</span><br><span class="line"> public | customer | table | jigao | 0 bytes | </span><br><span class="line"> public | lineitem | table | jigao | 0 bytes | </span><br><span class="line"> public | nation   | table | jigao | 0 bytes | </span><br><span class="line"> public | orders   | table | jigao | 0 bytes | </span><br><span class="line"> public | part     | table | jigao | 0 bytes | </span><br><span class="line"> public | partsupp | table | jigao | 0 bytes | </span><br><span class="line"> public | region   | table | jigao | 0 bytes | </span><br><span class="line"> public | supplier | table | jigao | 0 bytes | </span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¦‚æœèƒ½çœ‹åˆ°ä¸Šé¢çš„è¾“å‡ºï¼Œé‚£ä¹ˆè¿™äº›è¡¨æ ¼å·²ç»è¢«æ–°å»ºäº†ã€‚</li>
</ul>
<p><br></p>
<p><code>$man psql</code>:</p>
<blockquote>
<pre><code>   -d dbname
   -c command
</code></pre></blockquote>
<h2 id="TPC-H-Schema"><a href="#TPC-H-Schema" class="headerlink" title="TPC-H Schema"></a>TPC-H Schema</h2><p>ddlå³Data Definition Language æ•°æ®å®šä¹‰è¯­è¨€, ä¹Ÿæ˜¯å°±æ˜¯TPC-Hä¸­è¡¨æ ¼çš„æ¶æ„å’Œç›¸äº’å…³ç³»ã€‚</p>
<p><img data-src="https://hyper-db.de/tpch.png" alt="TPC-H Schema, Source: https://hyper-db.de/tpch.png"></p>
<p><br><br><br></p>
<h1 id="å¯¼å…¥PostgreSQL-2"><a href="#å¯¼å…¥PostgreSQL-2" class="headerlink" title="å¯¼å…¥PostgreSQL 2"></a>å¯¼å…¥PostgreSQL <sup><a href="#fn2">2</a></sup></h1><h2 id="å¯¼å…¥å‘½ä»¤"><a href="#å¯¼å…¥å‘½ä»¤" class="headerlink" title="å¯¼å…¥å‘½ä»¤"></a>å¯¼å…¥å‘½ä»¤</h2><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">$ </span><br><span class="line">for i in `ls *.tbl`; do</span><br><span class="line">    echo $i;</span><br><span class="line">    sed -i 's/|$//' *.tbl;</span><br><span class="line">    name=`echo $i| cut -d'.' -f1`;</span><br><span class="line">    psql -d tpch_sf1 -c "COPY $name FROM '`pwd`/$i' DELIMITER '|' ENCODING 'LATIN1';";</span><br><span class="line">done</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>sed -i 's/|$//' *.tbl;</code>: å¯¹äºæ¯ä¸€ä¸ª<code>.tbl</code>æ–‡ä»¶ï¼Œå°†æ¯ä¸€è¡Œæœ€åçš„<code>|</code>å»æ‰</li>
<li>å› ä¸ºpsqlä¼šè®¤ä¸ºåˆ†éš”ç¬¦<code>|</code>åé¢è¿˜ä¾ç„¶æœ‰æ•°æ®ã€‚</li>
</ul>
<h2 id="è¾“å‡ºä¾‹å­-2"><a href="#è¾“å‡ºä¾‹å­-2" class="headerlink" title="è¾“å‡ºä¾‹å­"></a>è¾“å‡ºä¾‹å­</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> `ls *.tbl`; <span class="keyword">do</span></span><br><span class="line">&gt;     <span class="built_in">echo</span> <span class="variable">$i</span>;</span><br><span class="line">&gt;     sed -i <span class="string">'s/|$//'</span> *.tbl;</span><br><span class="line">&gt;     name=`<span class="built_in">echo</span> <span class="variable">$i</span>| cut -d<span class="string">'.'</span> -f1`;</span><br><span class="line">&gt;     psql -d tpch_sf1 -c <span class="string">"COPY <span class="variable">$name</span> FROM '`pwd`/<span class="variable">$i</span>' DELIMITER '|' ENCODING 'LATIN1';"</span>;</span><br><span class="line">&gt; <span class="keyword">done</span></span><br><span class="line">customer.tbl</span><br><span class="line">COPY 150000</span><br><span class="line">lineitem.tbl</span><br><span class="line">COPY 6001215</span><br><span class="line">nation.tbl</span><br><span class="line">COPY 25</span><br><span class="line">orders.tbl</span><br><span class="line">COPY 1500000</span><br><span class="line">partsupp.tbl</span><br><span class="line">COPY 800000</span><br><span class="line">part.tbl</span><br><span class="line">COPY 200000</span><br><span class="line">region.tbl</span><br><span class="line">COPY 5</span><br><span class="line">supplier.tbl</span><br><span class="line">COPY 1000</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ£€æŸ¥-1"><a href="#æ£€æŸ¥-1" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ psql -d tpch_sf1 -c <span class="string">'\dt+'</span></span><br><span class="line">                      List of relations</span><br><span class="line"> Schema |   Name   | Type  | Owner |    Size    | Description </span><br><span class="line">--------+----------+-------+-------+------------+-------------</span><br><span class="line"> public | customer | table | jigao | 28 MB      | </span><br><span class="line"> public | lineitem | table | jigao | 879 MB     | </span><br><span class="line"> public | nation   | table | jigao | 8192 bytes | </span><br><span class="line"> public | orders   | table | jigao | 204 MB     | </span><br><span class="line"> public | part     | table | jigao | 32 MB      | </span><br><span class="line"> public | partsupp | table | jigao | 136 MB     | </span><br><span class="line"> public | region   | table | jigao | 8192 bytes | </span><br><span class="line"> public | supplier | table | jigao | 1800 kB    | </span><br><span class="line">(8 rows)</span><br><span class="line"></span><br><span class="line">$ psql -d tpch_sf1  -c <span class="string">"select count(*) from lineitem"</span>;</span><br><span class="line">  count  </span><br><span class="line">---------</span><br><span class="line"> 6001215</span><br><span class="line">(1 row)r | table | jigao | 1800 kB    | </span><br><span class="line">(8 rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¦‚æœèƒ½çœ‹åˆ°ä¸Šé¢çš„è¾“å‡ºï¼Œé‚£ä¹ˆè¿™äº›è¡¨æ ¼å·²ç»è¢«è½½å…¥äº†ã€‚</li>
</ul>
<h2 id="æ›¿ä»£æ–¹å¼-Bash-Script"><a href="#æ›¿ä»£æ–¹å¼-Bash-Script" class="headerlink" title="æ›¿ä»£æ–¹å¼: Bash Script"></a>æ›¿ä»£æ–¹å¼: Bash Script</h2><p>æˆ‘å°†<a href="#å¯¼å…¥å‘½ä»¤">ä¸Šé¢çš„å¯¼å…¥æ•°æ®å‘½ä»¤</a>å†™æˆäº†ä¸€ä¸ªbash scriptè„šæœ¬: <a href="https://cakebytheoceanluo.github.io/download/dbms/psql_tpch_import.sh">ä¸‹è½½</a></p>
<p><strong>æ³¨æ„æˆ‘æ›´æ”¹äº†å¸¦psqlé‚£è¡Œï¼Œè¿™ä¸ªè„šæœ¬éœ€è¦ä¸€ä¸ªå˜é‡ï¼Œå³æ•°æ®åº“çš„åå­—ï¼Œåœ¨æœ¬æ–‡ä¾‹å­ä¸­æ˜¯<code>tpch_sf1</code>ï¼Œä½ å½“ç„¶å¯ä»¥åœ¨æ–°å»ºæ•°æ®åº“çš„æ—¶å€™è‡ªè¡Œé€‰æ‹©ã€‚</strong></p>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ chmod +x psql_tpch_import.sh </span><br><span class="line">$ ./psql_tpch_import.sh tpch_sf1</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<p>å¼•ç”¨ï¼š</p>
<p><a name="fn1">1</a>: <span class="exturl" data-url="aHR0cDovL3d3dy50cGMub3JnL3RwY2gv" title="http://www.tpc.org/tpch/">http://www.tpc.org/tpch/<i class="fa fa-external-link"></i></span></p>
<p><a name="fn2">2</a>: TPCH on PostgreSQL - Xi Liang: <span class="exturl" data-url="aHR0cDovL3h0ci5haS9ibG9nLzIwMTktMDMtMTItdHBjaC8=" title="http://xtr.ai/blog/2019-03-12-tpch/">http://xtr.ai/blog/2019-03-12-tpch/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VsZWN0cnVtL3RwY2gtZGJnZW4=" title="https://github.com/electrum/tpch-dbgen">https://github.com/electrum/tpch-dbgen<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>DBMS</category>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
        <tag>TPC-H</tag>
      </tags>
  </entry>
  <entry>
    <title>[DBMS]PostgreSQLå®‰è£…ä¸é…ç½®</title>
    <url>/2020/03/15/DBMS-PostgreSQL%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="PostgreSQLä»‹ç»"><a href="#PostgreSQLä»‹ç»" class="headerlink" title="PostgreSQLä»‹ç»"></a>PostgreSQLä»‹ç»</h1><p>PostgreSQLæ˜¯ä¸€ä¸ªå¼€æºçš„å¯¹è±¡-å…³ç³»æ•°æ®åº“æ•°æ®åº“ç®¡ç†ç³»ç»Ÿã€‚å®ƒæœ€åˆå¼€å§‹äºåœ¨åŠ åˆ©ç¦å°¼äºšå¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡(UCB)çš„Ingresè®¡åˆ’ã€‚è¿™ä¸ªè®¡åˆ’çš„é¢†å¯¼è€…Michael Stonebrakeråœ¨1982å¹´ç¦»å¼€åŠ åˆ©ç¦å°¼äºšå¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡å»æ¨è¿›Ingresçš„å•†ä¸šåŒ–ï¼Œä½†æœ€åè¿˜æ˜¯è¿”å›äº†å­¦æœ¯ç•Œã€‚åœ¨1985å¹´è¿”å›ä¼¯å…‹åˆ©ä¹‹åï¼ŒMichael Stonebrakerå¼€å§‹äº†post-Ingresè®¡åˆ’ï¼Œè‡´åŠ›äºè§£å†³åœ¨1980å¹´ä»£æ—©æœŸæ‰€å‡ºç°ä¸€äº›æ•°æ®åº“ç³»ç»Ÿå­˜åœ¨çš„é—®é¢˜ã€‚Postgreså’ŒIngresçš„ä»£ç åº“å¼€å§‹(å¹¶ä¿æŒ)å®Œå…¨åˆ†ç¦»ã€‚<sup><a href="#myfootnote1">1</a></sup></p>
<p>Michael Stonebrakeräº2014å¹´è·å¾—å›¾çµå¥–ã€‚å¦å¤–PostgreSQLä¹Ÿå¸¸ç§°ä¸ºpsqlã€‚</p>
<p>æœ¬æ–‡ä¸»è¦è®°å½•PostgreSQLçš„å®‰è£…å’ŒåŸºæœ¬é…ç½®ã€‚</p>
<a id="more"></a>
<h1 id="PostgreSQL-å®‰è£…"><a href="#PostgreSQL-å®‰è£…" class="headerlink" title="PostgreSQL å®‰è£…"></a>PostgreSQL å®‰è£…</h1><p>æœ¬æ–‡åŸºäºdeb Linuxç³»ç»Ÿã€‚</p>
<p>å®‰è£…PostgreSQL:<br></p><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt install postgresql postgresql-contrib</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>ä¸Šé¢è¿™æ¡æŒ‡ä»¤åŒ…æ‹¬äº†PostgreSQLçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›å…¶ä»–æ’ä»¶ã€‚ã€€</p>
<p>ä¾‹å¦‚<code>apt-get install postgresql-11</code>ä¼šå®‰è£…ä¸Šå¦‚ä¸‹è½¯ä»¶ã€€<sup><a href="#fn">2</a></sup>ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>software</th>
<th>functionality</th>
</tr>
</thead>
<tbody>
<tr>
<td>postgresql-client-11</td>
<td>client libraries and client binaries</td>
</tr>
<tr>
<td>postgresql-11</td>
<td>core database server</td>
</tr>
<tr>
<td>postgresql-contrib-9.x</td>
<td>additional supplied modules (part of the postgresql-xx package in version 10 and later)</td>
</tr>
<tr>
<td>libpq-dev</td>
<td>libraries and headers for C language frontend development</td>
</tr>
<tr>
<td>postgresql-server-dev-11</td>
<td>libraries and headers for C language backend development</td>
</tr>
<tr>
<td>pgadmin4</td>
<td>pgAdmin 4 graphical administration utility</td>
</tr>
</tbody>
</table>
</div>
<p>å…¶ä»–çš„ç³»ç»Ÿå¯ä»¥åœ¨å®˜æ–¹ä¸‹è½½ç½‘é¡µä¸­æ‰¾åˆ°ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG93bmxvYWQv" title="https://www.postgresql.org/download/">https://www.postgresql.org/download/<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<p>å¦å¤–PostgreSQLå’ŒMySQLä¸€æ ·å±äºâ€<strong>æ­£å¼çš„æ•°æ®åº“</strong>â€œ: å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡ç«¯å£é€šä¿¡ã€‚ä¸åƒSQLiteè¿™ç§åµŒå…¥å¼çš„æ•°æ®åº“ï¼Œä¸åŒºåˆ†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ã€‚</p>
<p>å½“æˆ‘ä»¬è¿è¡Œpsqlçš„æ—¶å€™(æˆ‘ä»¬åé¢ä¼šè®²å¦‚ä½•è¿è¡Œ):</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">psql (12.2 (Ubuntu 12.2-2.pgdg18.04+1), server 10.12 (Ubuntu 10.12-2.pgdg18.04+1))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> <span class="built_in">help</span>.</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>12.2</code>: æ˜¯å®¢æˆ·ç«¯çš„ç‰ˆæœ¬</li>
<li><code>10.12</code>: æ˜¯æœåŠ¡å™¨ç«¯çš„ç‰ˆæœ¬</li>
</ul>
<p>åŒæ—¶æŸ¥çœ‹ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥åœ¨PostgreSQLé€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ psql -c <span class="string">'select version();'</span></span><br><span class="line">                                                               version                                                               </span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> PostgreSQL 10.12 (Ubuntu 10.12-2.pgdg18.04+1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 7.4.0-1ubuntu1~18.04.1) 7.4.0, 64-bit</span><br><span class="line">(1 row)</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="ç®¡ç†PostgreSQL"><a href="#ç®¡ç†PostgreSQL" class="headerlink" title="ç®¡ç†PostgreSQL"></a>ç®¡ç†PostgreSQL</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo systemctl (start|stop|restart|reload|status) postgresql</span><br></pre></td></tr></tbody></table></figure>
<p>æ¯”å¦‚ï¼š</p>
<ul>
<li>å¯åŠ¨PostgreSQL: <code>sudo systemctl start postgresql</code></li>
<li>åœæ­¢PostgreSQL: <code>sudo systemctl stop postgresql</code></li>
<li>é‡å¯PostgreSQL: <code>sudo systemctl restart postgresql</code></li>
<li>æŸ¥çœ‹PostgreSQLçŠ¶æ€: <code>systemctl status postgresql</code></li>
<li>reload (æˆ‘ä»æ¥æ²¡ç”¨è¿‡è¿™ä¸ª): : <code>sudo systemctl reload postgresql</code></li>
</ul>
<h2 id="å¼€æœºè‡ªåŠ¨å¯åŠ¨"><a href="#å¼€æœºè‡ªåŠ¨å¯åŠ¨" class="headerlink" title="å¼€æœºè‡ªåŠ¨å¯åŠ¨"></a>å¼€æœºè‡ªåŠ¨å¯åŠ¨</h2><p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯ä»¥ä½¿postgreSQLè‡ªåŠ¨éšç€ç³»ç»Ÿå¯åŠ¨ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> postgresql</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æŸ¥çœ‹è¿›ç¨‹"><a href="#æŸ¥çœ‹è¿›ç¨‹" class="headerlink" title="æŸ¥çœ‹è¿›ç¨‹"></a>æŸ¥çœ‹è¿›ç¨‹</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ps -ef | grep postgres</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<h1 id="ç”¨æˆ·userå’Œè§’è‰²role"><a href="#ç”¨æˆ·userå’Œè§’è‰²role" class="headerlink" title="ç”¨æˆ·userå’Œè§’è‰²role"></a>ç”¨æˆ·userå’Œè§’è‰²role</h1><h2 id="postgresæœ¬åœ°è®¿é—®"><a href="#postgresæœ¬åœ°è®¿é—®" class="headerlink" title="postgresæœ¬åœ°è®¿é—®"></a><code>postgres</code>æœ¬åœ°è®¿é—®</h2><p>åœ¨UNIXå¹³å°ä¸­å®‰è£…PostgreSQLä¹‹åï¼ŒPostgreSQLä¼šåœ¨UNIXç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªåä¸º<code>postgres</code>çš„<strong>linuxç™»å½•ç”¨æˆ·</strong>(å±äºæœ€é«˜æƒé™ Superuser)ã€‚</p>
<p>PostgreSQLçš„é»˜è®¤ç”¨æˆ·åå’Œæ•°æ®åº“ä¹Ÿæ˜¯<code>postgres</code>ï¼Œ ä¸è¿‡æ²¡æœ‰é»˜è®¤å¯†ç ã€‚æˆ‘ä»¬é€šè¿‡å¦‚ä¸‹å‡ ä¸ªå‘½ä»¤å»è¿›è¡Œè¯¥ç”¨æˆ·çš„æœ¬åœ°è®¿é—®:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo su postgres</span><br><span class="line">$ psql postgres</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo -i -u postgres psql</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å¯†ç "><a href="#å¯†ç " class="headerlink" title="å¯†ç "></a>å¯†ç </h3><p>æœ€å¼€å§‹çš„æ—¶å€™<code>postgres</code>ç”¨æˆ·ä¸æ”¯æŒè¿œç¨‹ç™»å½•(æŠ¥é”™ï¼špsql: fe_sendauth: no password supplied)ï¼Œå¿…é¡»è®¾ç½®å¯†ç åæ‰è¡Œ(æ™®é€šç”¨æˆ·ä¹Ÿé€‚åº”è¿™ä¸ªè§„åˆ™)ã€‚<sup><a href="#fn2">3</a></sup></p>
<p>å¦‚æœéœ€è¦æ”¹å¯†ç çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>passwd postgres</code>è¿›è¡Œè¿›è¡Œå¯†ç ä¿®æ”¹ã€‚</p>
<p>åœ¨å½“å‰ç”¨æˆ·ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬psqlçš„é»˜è®¤ç«¯å£å·<code>5432</code>ï¼Œä½¿ç”¨<code>lsof</code>æˆ–è€…<code>netstat</code>:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">postgres:/$ lsof -i:5432</span><br><span class="line">COMMAND   PID     USER   FD   TYPE    DEVICE SIZE/OFF NODE NAME</span><br><span class="line">postgres 7877 postgres    5u  IPv4 700026722      0t0  TCP localhost:postgresql (LISTEN)</span><br><span class="line">postgres:/$ netstat -an | grep 5432</span><br><span class="line">tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN     </span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING     700026723 /var/run/postgresql/.s.PGSQL.5432</span><br><span class="line">unix  3      [ ]         STREAM     CONNECTED     3941554326 </span><br><span class="line">unix  3      [ ]         STREAM     CONNECTED     3941554325</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ›å»ºç”¨æˆ·-createuser"><a href="#åˆ›å»ºç”¨æˆ·-createuser" class="headerlink" title="åˆ›å»ºç”¨æˆ· - createuser"></a>åˆ›å»ºç”¨æˆ· - createuser</h2><p>PostgreSQL æ¯åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ª<strong>æ–°çš„å¯¹åº”çš„linuxåŒåç”¨æˆ·</strong>ã€‚é»˜è®¤çš„ç”¨æˆ·æ˜¯<code>postgres</code>ï¼Œç™»å½•æ­¤ç”¨æˆ·çš„shellï¼Œå»æ‰§è¡Œpsqlæ— éœ€å¯†ç  (æœ¬è´¨ä¸Šæ˜¯å› ä¸º pg_hba.conf çš„é…ç½®) ã€‚PostgreSQLè¿™ç§é€šè¿‡å°†Linuxç”¨æˆ·ä¸PostgreSQLå¸æˆ·ç›¸å…³è”æ¥å¤„ç†èº«ä»½éªŒè¯çš„æ–¹å¼ï¼Œè¢«ç§°ä¸ºâ€œå¯¹ç­‰â€èº«ä»½éªŒè¯ã€‚</p>
<p>åˆ›å»ºç”¨æˆ·å¾€å¾€æ˜¯æˆ‘ä»¬ä½¿ç”¨PostgreSQLçš„ç¬¬ä¸€æ­¥ã€‚å› ä¸ºæˆ‘ä»¬å¦‚æœæ–°å»ºäº†ä¸€ä¸ªç”¨æˆ·(user)ï¼Œ æˆ‘ä»¬ä»¥åå°±å¯ä»¥é€šè¿‡<code>psql</code>ç™»é™†æˆ‘ä»¬çš„PostgeSQLã€‚ä¸ªäººå»ºè®®è¿™ä¸ªç”¨æˆ·åå¯ä»¥è®¾ç½®æˆå’Œæˆ‘ä»¬Linuxç³»ç»Ÿç”¨æˆ·åä¸€è‡´ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo -u postgres createuser --interactive -P &lt;æˆ‘ä»¬çš„ç”¨æˆ·å ä¸å¸¦å°–è§’æ‹¬å·&gt;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p><code>$ man createuser</code>:</p>
<blockquote>
<pre><code>   createuser - define a new PostgreSQL user account 
</code></pre></blockquote>
<h2 id="æŸ¥çœ‹å½“å‰ç”¨æˆ·"><a href="#æŸ¥çœ‹å½“å‰ç”¨æˆ·" class="headerlink" title="æŸ¥çœ‹å½“å‰ç”¨æˆ·"></a>æŸ¥çœ‹å½“å‰ç”¨æˆ·</h2><p><code>select current_user;</code>:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">jigao=# select current_user;</span><br><span class="line"> current_user </span><br><span class="line">--------------</span><br><span class="line"> jigao</span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ‡æ¢ç”¨æˆ·"><a href="#åˆ‡æ¢ç”¨æˆ·" class="headerlink" title="åˆ‡æ¢ç”¨æˆ·"></a>åˆ‡æ¢ç”¨æˆ·</h2><p><code>\c &lt;user_name&gt;</code> å¯ä»¥è®©æˆ‘ä»¬åˆ‡æ¢ä¸åŒçš„ç”¨æˆ·å</p>
<p><br></p>
<p>è¿œç¨‹ç™»é™†çš„éƒ¨åˆ†è§: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veGpub3R4ai9wLzExMTk4MjU1Lmh0bWwjMzU5NDY3MzQwOA==" title="https://www.cnblogs.com/xjnotxj/p/11198255.html#3594673408">https://www.cnblogs.com/xjnotxj/p/11198255.html#3594673408<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<h1 id="æ–°å»ºä¸€ä¸ªç”¨æˆ·æ•°æ®åº“"><a href="#æ–°å»ºä¸€ä¸ªç”¨æˆ·æ•°æ®åº“" class="headerlink" title="æ–°å»ºä¸€ä¸ªç”¨æˆ·æ•°æ®åº“"></a>æ–°å»ºä¸€ä¸ªç”¨æˆ·æ•°æ®åº“</h1><p>åœ¨bashä¸­è¾“å…¥(ä¸æ˜¯åœ¨psqlä¸­)ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ createdb &lt;æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ç”¨æˆ·å ä¸å¸¦å°–è§’æ‹¬å·&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªæ•°æ®åº“ä»å±äºæˆ‘ä»¬å½“å‰çš„ç”¨æˆ·ï¼Œæ–°å»ºå®Œæˆä¹‹åï¼Œæˆ‘ä»¬(å½“å‰ç”¨æˆ·)å¯ä»¥ç”¨<code>psql</code>å‘½ä»¤è¿›å…¥è¯¥æ•°æ®åº“, è¿™å°±æ˜¯æˆ‘ä»¬åˆšåˆšæåˆ°çš„<em>å¯¹ç­‰èº«ä»½éªŒè¯</em>ã€‚æ¯”å¦‚æˆ‘æ˜¯è¿™ä¹ˆæ“ä½œçš„ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ createdb jigao</span><br><span class="line">$ psql</span><br><span class="line">psql (12.2 (Ubuntu 12.2-2.pgdg18.04+1), server 10.12 (Ubuntu 10.12-2.pgdg18.04+1))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> <span class="built_in">help</span>.</span><br><span class="line"></span><br><span class="line">jigao=<span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p><code>$ man createdb</code>:</p>
<blockquote>
<pre><code>   createdb - create a new PostgreSQL database
</code></pre></blockquote>
<h1 id="æ–°å»ºä¸€ä¸ªæ•°æ®åº“-create-database"><a href="#æ–°å»ºä¸€ä¸ªæ•°æ®åº“-create-database" class="headerlink" title="æ–°å»ºä¸€ä¸ªæ•°æ®åº“ - create database"></a>æ–°å»ºä¸€ä¸ªæ•°æ®åº“ - create database</h1><p>æœ‰äº†ç”¨æˆ·åä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œè¿™ä¸ªæ•°æ®åº“æœ‰ä¸€äº›è¡¨æ ¼ã€‚æˆ‘ä»¬æ‰å¯ä»¥è¿è¡ŒSQLè¯­å¥ã€‚æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æˆ‘ä»¬åœ¨<a href="#æ–°å»ºä¸€ä¸ªç”¨æˆ·æ•°æ®åº“">ä¸Šä¸€å—å†…å®¹: æ–°å»ºä¸€ä¸ªç”¨æˆ·æ•°æ®åº“</a>å·²ç»è§è¿‡ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦åœ¨<code>postgres</code>ç”¨æˆ·ä¸‹æ–°å»ºï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo -u postgres createdb testdb</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–ç”¨ä¸‹é¢æŒ‡ä»¤ï¼š</p>
<p>å¯¹äºPostgreSQLæ¯ä¸€ä¸ªæ•°æ®åº“databaseæ˜¯å¸¦æœ‰æƒé™çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠè¿™ä¸ªæ–°å»ºçš„æ•°æ®åº“<code>GRANT</code>(æˆæƒ)ç»™æˆ‘ä»¬ä¸Šä¸€æ­¥çš„ç”¨æˆ·åã€‚</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo -u postgres psql</span><br><span class="line">postgres=# CREATE DATABASE testdb;</span><br><span class="line">postgres=# GRANT ALL ON DATABASE testdb to &lt;æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ç”¨æˆ·å ä¸å¸¦å°–è§’æ‹¬å·&gt;;</span><br></pre></td></tr></tbody></table></figure>
<p><code>sudo -u postgres psql</code>å¯ä»¥è®©æˆ‘ä»¬è¿›å…¥<code>postgres</code>è¿™ä¸ªæ•°æ®åº“ï¼Œå®ƒæ˜¯default administrative connection databaseã€‚</p>
<p>å¦‚æœæˆåŠŸï¼Œ æˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ª<code>psql</code>ç•Œé¢ç”¨ï¼š<code>\q</code>é€€å‡ºåˆ°shellã€‚</p>
<h2 id="æ–°å»ºè¡¨æ ¼-â€”-create-table"><a href="#æ–°å»ºè¡¨æ ¼-â€”-create-table" class="headerlink" title="æ–°å»ºè¡¨æ ¼ â€” create table"></a>æ–°å»ºè¡¨æ ¼ â€” create table</h2><p>è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å‘åˆšåˆšæ–°å»ºçš„æ•°æ®åº“é‡Œé¢åŠ å…¥æˆ‘ä»¬çš„è¡¨æ ¼äº†ã€‚PostgreSQLæ˜¯ä¸€ç§å…³ç³»æ•°æ®åº“(relational Database system)ï¼Œæˆ‘ä»¬éœ€è¦æä¾›<code>create table...</code>è¯­å¥å»æ–°å»ºè¡¨æ ¼ï¼Œå®šä¹‰æ¯ä¸€ä¸ªè¡¨æ ¼å­—æ®µ(field)çš„æ•°æ®ç±»å‹(data type)ä»¥åŠå…¶ä»–ä¿¡æ¯(å¦‚èƒ½ä¸èƒ½æ˜¯<code>null value</code>)ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€äº›åˆ«äººæä¾›å¥½çš„è¡¨æ ¼ã€‚</p>
<p>å…·ä½“å¯¼å…¥æ•°æ®é›†å¯ä»¥çœ‹è¿™ä¸€ç¯‡æ–‡ç« ï¼š <a href="https://cakebytheoceanluo.github.io/2020/03/15/DBMS-PostgreSQL%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86/">[DBMS]PostgreSQLå¯¼å…¥æ•°æ®é›†</a></p>
<h2 id="æŸ¥çœ‹å½“å‰æ•°æ®åº“"><a href="#æŸ¥çœ‹å½“å‰æ•°æ®åº“" class="headerlink" title="æŸ¥çœ‹å½“å‰æ•°æ®åº“"></a>æŸ¥çœ‹å½“å‰æ•°æ®åº“</h2><p><code>select current_database();</code>:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select current_database();</span><br><span class="line"> current_database </span><br><span class="line">------------------</span><br><span class="line"> testdb</span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“"><a href="#æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“" class="headerlink" title="æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“"></a>æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“</h2><p>åœ¨ä»»ä½•ä¸€ä¸ªpsqlæ•°æ®åº“ä¸­, æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>\l</code>æˆ–<code>\l+</code>å‘½ä»¤æ¥ï¼ŒæŸ¥çœ‹psqlä¸‹æ€»å…±æœ‰å“ªäº›æ•°æ®åº“ã€‚æˆ‘å¯ä»¥ä»æˆ‘çš„ç”¨æˆ·æ•°æ®åº“<code>jigao</code>æŸ¥çœ‹ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">jigao=# \l</span><br><span class="line">                                     List of databases</span><br><span class="line">     Name     |    Owner    | Encoding |   Collate   |    Ctype    |   Access privileges   </span><br><span class="line">--------------+-------------+----------+-------------+-------------+-----------------------</span><br><span class="line"> dbname       | owning_user | UTF8     | en_US.UTF-8 | en_US.UTF-8 | </span><br><span class="line"> jigao        | jigao       | UTF8     | en_US.UTF-8 | en_US.UTF-8 | </span><br><span class="line"> postgres     | postgres    | UTF8     | en_US.UTF-8 | en_US.UTF-8 | </span><br><span class="line"> template0    | postgres    | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +</span><br><span class="line">              |             |          |             |             | postgres=CTc/postgres</span><br><span class="line"> template1    | postgres    | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +</span><br><span class="line">              |             |          |             |             | postgres=CTc/postgres</span><br><span class="line"> testdb       | testuser    | UTF8     | en_US.UTF-8 | en_US.UTF-8 | </span><br><span class="line">(6 rows)</span><br><span class="line"></span><br><span class="line">jigao=# \l+</span><br><span class="line">                                                                       List of databases</span><br><span class="line">     Name     |    Owner    | Encoding |   Collate   |    Ctype    |   Access privileges   |  Size   | Tablespace |                Description                 </span><br><span class="line">--------------+-------------+----------+-------------+-------------+-----------------------+---------+------------+--------------------------------------------</span><br><span class="line"> dbname       | owning_user | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 7497 kB | pg_default | </span><br><span class="line"> jigao        | jigao       | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 7631 kB | pg_default | </span><br><span class="line"> postgres     | postgres    | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 7631 kB | pg_default | default administrative connection database</span><br><span class="line"> template0    | postgres    | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +| 7497 kB | pg_default | unmodifiable empty database</span><br><span class="line">              |             |          |             |             | postgres=CTc/postgres |         |            | </span><br><span class="line"> template1    | postgres    | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +| 7631 kB | pg_default | default template for new databases</span><br><span class="line">              |             |          |             |             | postgres=CTc/postgres |         |            | </span><br><span class="line"> testdb       | testuser    | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 848 MB  | pg_default | </span><br><span class="line">(6 rows)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ‡æ¢æ•°æ®åº“"><a href="#åˆ‡æ¢æ•°æ®åº“" class="headerlink" title="åˆ‡æ¢æ•°æ®åº“"></a>åˆ‡æ¢æ•°æ®åº“</h2><p><code>\c &lt;database_name&gt;</code> å¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸åŒæ•°æ®åº“ä¸­åˆ‡æ¢</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">jigao=# \c jigao</span><br><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">You are now <span class="built_in">connected</span> to database <span class="string">"jigao"</span> as user <span class="string">"jigao"</span>.</span><br><span class="line">jigao=# \c testdb</span><br><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">You are now <span class="built_in">connected</span> to database <span class="string">"testdb"</span> as user <span class="string">"jigao"</span>.</span><br><span class="line">testdb-# \c postgres</span><br><span class="line">psql (<span class="number">12.2</span> (Ubuntu <span class="number">12.2</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>), server <span class="number">10.12</span> (Ubuntu <span class="number">10.12</span><span class="number">-2.</span>pgdg18<span class="number">.04</span>+<span class="number">1</span>))</span><br><span class="line">You are now <span class="built_in">connected</span> to database <span class="string">"postgres"</span> as user <span class="string">"jigao"</span>.</span><br><span class="line">postgres=#</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="æŸ¥çœ‹SQLå‡½æ•°"><a href="#æŸ¥çœ‹SQLå‡½æ•°" class="headerlink" title="æŸ¥çœ‹SQLå‡½æ•°"></a>æŸ¥çœ‹SQLå‡½æ•°</h1><blockquote>
<p>  \df[anptw][S+] [PATRN] list [only agg/normal/procedures/trigger/window] functions</p>
</blockquote>
<h2 id="æŸ¥çœ‹æ‰€æœ‰å‡½æ•°"><a href="#æŸ¥çœ‹æ‰€æœ‰å‡½æ•°" class="headerlink" title="æŸ¥çœ‹æ‰€æœ‰å‡½æ•°ã€€"></a>æŸ¥çœ‹æ‰€æœ‰å‡½æ•°ã€€</h2><p>postgreSQLä¸­æ‰€æœ‰çš„å‡½æ•°éƒ½ä¼šè¢«åˆ—å‡º(è¾“å‡ºä¼šéå¸¸å¤šï¼)ï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">jigao=# \df *</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åŒ¹é…æŸ¥çœ‹å‡½æ•°"><a href="#åŒ¹é…æŸ¥çœ‹å‡½æ•°" class="headerlink" title="åŒ¹é…æŸ¥çœ‹å‡½æ•°"></a>åŒ¹é…æŸ¥çœ‹å‡½æ•°</h2><h3 id="substringä¾‹å­"><a href="#substringä¾‹å­" class="headerlink" title="substringä¾‹å­"></a><code>substring</code>ä¾‹å­</h3><p>æ¯”å¦‚æˆ‘ä»¬å¿˜è®°äº†<code>substring</code>è¿™ä¸ªå‡½æ•°ï¼Œåªè®°å¾—<code>sub</code>:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">jigao=# \df sub*</span><br><span class="line">                             List of functions</span><br><span class="line">   Schema   |   Name    | Result data type |   Argument data types   | Type </span><br><span class="line">------------+-----------+------------------+-------------------------+------</span><br><span class="line"> pg_catalog | substr    | bytea            | bytea, integer          | func</span><br><span class="line"> pg_catalog | substr    | bytea            | bytea, integer, integer | func</span><br><span class="line"> pg_catalog | substr    | <span class="built_in">text</span>             | <span class="built_in">text</span>, integer           | func</span><br><span class="line"> pg_catalog | substr    | <span class="built_in">text</span>             | <span class="built_in">text</span>, integer, integer  | func</span><br><span class="line"> pg_catalog | substring | <span class="built_in">bit</span>              | <span class="built_in">bit</span>, integer            | func</span><br><span class="line"> pg_catalog | substring | <span class="built_in">bit</span>              | <span class="built_in">bit</span>, integer, integer   | func</span><br><span class="line"> pg_catalog | substring | bytea            | bytea, integer          | func</span><br><span class="line"> pg_catalog | substring | bytea            | bytea, integer, integer | func</span><br><span class="line"> pg_catalog | substring | <span class="built_in">text</span>             | <span class="built_in">text</span>, integer           | func</span><br><span class="line"> pg_catalog | substring | <span class="built_in">text</span>             | <span class="built_in">text</span>, integer, integer  | func</span><br><span class="line"> pg_catalog | substring | <span class="built_in">text</span>             | <span class="built_in">text</span>, <span class="built_in">text</span>              | func</span><br><span class="line"> pg_catalog | substring | <span class="built_in">text</span>             | <span class="built_in">text</span>, <span class="built_in">text</span>, <span class="built_in">text</span>        | func</span><br><span class="line">(<span class="number">12</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="sumä¾‹å­"><a href="#sumä¾‹å­" class="headerlink" title="sumä¾‹å­"></a><code>sum</code>ä¾‹å­</h3><p>æ¯”å¦‚æˆ‘ä»¬å¿˜è®°äº†<code>sum</code>è¿™ä¸ªå‡½æ•°ï¼Œåªè®°å¾—<code>su</code>ã€‚å¦å¤–æˆ‘ä»¬è¿˜çŸ¥é“å®ƒè¿˜æ˜¯ä¸€ä¸ªèšåˆå‡½æ•°(aggregation) - agg - <strong>a</strong>:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">jigao=# \dfa su*</span><br><span class="line">                         List of functions</span><br><span class="line">   Schema   | Name | Result data type | Argument data types | Type </span><br><span class="line">------------+------+------------------+---------------------+------</span><br><span class="line"> pg_catalog | sum  | numeric          | bigint              | agg</span><br><span class="line"> pg_catalog | sum  | <span class="keyword">double</span> precision | <span class="keyword">double</span> precision    | agg</span><br><span class="line"> pg_catalog | sum  | bigint           | integer             | agg</span><br><span class="line"> pg_catalog | sum  | interval         | interval            | agg</span><br><span class="line"> pg_catalog | sum  | money            | money               | agg</span><br><span class="line"> pg_catalog | sum  | numeric          | numeric             | agg</span><br><span class="line"> pg_catalog | sum  | real             | real                | agg</span><br><span class="line"> pg_catalog | sum  | bigint           | smallint            | agg</span><br><span class="line">(<span class="number">8</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨:</p>
<p><a name="myfootnote1">1</a>:ã€€PostgreSQL ç»´åŸºç™¾ç§‘. <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvUG9zdGdyZVNRTA==" title="https://zh.wikipedia.org/wiki/PostgreSQL">https://zh.wikipedia.org/wiki/PostgreSQL<i class="fa fa-external-link"></i></span></p>
<p><a name="fn">2</a>: Linux downloads (Ubuntu): <span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG93bmxvYWQvbGludXgvdWJ1bnR1Lw==" title="https://www.postgresql.org/download/linux/ubuntu/">https://www.postgresql.org/download/linux/ubuntu/<i class="fa fa-external-link"></i></span></p>
<p><a name="fn2">3</a>: PostgreSQL å®‰è£… &amp; ç”¨æˆ·é…ç½® - å°è’‹ä¸ç´ å°è’‹: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veGpub3R4ai9wLzExMTk4MjU1Lmh0bWw=" title="https://www.cnblogs.com/xjnotxj/p/11198255.html">https://www.cnblogs.com/xjnotxj/p/11198255.html<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<p>æ¨èçš„é˜…è¯»:</p>
<p>PostgreSQL å®‰è£…æœ€æ–°çš„ç‰ˆæœ¬ - DaozyIT: <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RlbmN1cG9ma2Fpd2F0ZXIvYXJ0aWNsZS9kZXRhaWxzLzgxNDgyMzQw" title="https://blog.csdn.net/tencupofkaiwater/article/details/81482340">https://blog.csdn.net/tencupofkaiwater/article/details/81482340<i class="fa fa-external-link"></i></span></p>
<p>How To Install and Use PostgreSQL on Ubuntu 18.04 -  Justin Ellingwood and Mark Drake: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGlnaXRhbG9jZWFuLmNvbS9jb21tdW5pdHkvdHV0b3JpYWxzL2hvdy10by1pbnN0YWxsLWFuZC11c2UtcG9zdGdyZXNxbC1vbi11YnVudHUtMTgtMDQ=" title="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-18-04">https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-18-04<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>DBMS</category>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 1179.reformat-department-table</title>
    <url>/2020/03/13/SQL-Leetcode-1179-reformat-department-table/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>1179.Reformat Department Table</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Department (<span class="keyword">id</span> <span class="built_in">int</span>, revenue <span class="built_in">int</span>, <span class="keyword">month</span> <span class="built_in">varchar</span>(<span class="number">5</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Department</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'8000'</span>, <span class="string">'Jan'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'9000'</span>, <span class="string">'Jan'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'10000'</span>, <span class="string">'Feb'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'7000'</span>, <span class="string">'Feb'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'6000'</span>, <span class="string">'Mar'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--PostgreSQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Department (<span class="keyword">id</span> <span class="built_in">int</span>, revenue <span class="built_in">int</span>, <span class="keyword">month</span> <span class="built_in">varchar</span>(<span class="number">5</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Department</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'8000'</span>, <span class="string">'Jan'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'9000'</span>, <span class="string">'Jan'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'10000'</span>, <span class="string">'Feb'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'7000'</span>, <span class="string">'Feb'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">id</span>, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'6000'</span>, <span class="string">'Mar'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>Table: <code>Department</code><br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------------+---------+</span></span><br><span class="line">| Column Name   | Type    |</span><br><span class="line">+<span class="comment">---------------+---------+</span></span><br><span class="line">| id            | int     |</span><br><span class="line">| revenue       | int     |</span><br><span class="line">| month         | varchar |</span><br><span class="line">+<span class="comment">---------------+---------+</span></span><br><span class="line">(id, month) is the primary key of this table.</span><br><span class="line">The table has information about the revenue of each department per month.</span><br><span class="line">The month has <span class="keyword">values</span> <span class="keyword">in</span> [<span class="string">"Jan"</span>,<span class="string">"Feb"</span>,<span class="string">"Mar"</span>,<span class="string">"Apr"</span>,<span class="string">"May"</span>,<span class="string">"Jun"</span>,<span class="string">"Jul"</span>,<span class="string">"Aug"</span>,<span class="string">"Sep"</span>,<span class="string">"Oct"</span>,<span class="string">"Nov"</span>,<span class="string">"Dec"</span>].</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>Write an SQL query to reformat the table such that there is a department id column and a revenue column <strong>for each month</strong>.</p>
<p>The query result format is in the following example:<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">Department table:</span><br><span class="line">+<span class="comment">------+---------+-------+</span></span><br><span class="line">| id   | revenue | month |</span><br><span class="line">+<span class="comment">------+---------+-------+</span></span><br><span class="line">| 1    | 8000    | Jan   |</span><br><span class="line">| 2    | 9000    | Jan   |</span><br><span class="line">| 3    | 10000   | Feb   |</span><br><span class="line">| 1    | 7000    | Feb   |</span><br><span class="line">| 1    | 6000    | Mar   |</span><br><span class="line">+<span class="comment">------+---------+-------+</span></span><br><span class="line"></span><br><span class="line">Result table:</span><br><span class="line">+<span class="comment">------+-------------+-------------+-------------+-----+-------------+</span></span><br><span class="line">| id   | Jan_Revenue | Feb_Revenue | Mar_Revenue | ... | Dec_Revenue |</span><br><span class="line">+<span class="comment">------+-------------+-------------+-------------+-----+-------------+</span></span><br><span class="line">| 1    | 8000        | 7000        | 6000        | ... | null        |</span><br><span class="line">| 2    | 9000        | null        | null        | ... | null        |</span><br><span class="line">| 3    | null        | 10000       | null        | ... | null        |</span><br><span class="line">+<span class="comment">------+-------------+-------------+-------------+-----+-------------+</span></span><br><span class="line"></span><br><span class="line">Note that the result table has 13 columns (1 for the department id + 12 for the months).</span><br></pre></td></tr></tbody></table></figure><p></p>
<a id="more"></a>
<hr>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">id</span>,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'jan'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Jan_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'feb'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Feb_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'mar'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Mar_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'apr'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Apr_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'may'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> May_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'jun'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Jun_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'jul'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Jul_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'aug'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Aug_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'sep'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Sep_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'oct'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Oct_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'nov'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Nov_Revenue,</span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">month</span> = <span class="string">'dec'</span> <span class="keyword">then</span> revenue <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span>) <span class="keyword">as</span> Dec_Revenue</span><br><span class="line"><span class="keyword">from</span> department</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">asc</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">id</span>,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Jan'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Jan_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Feb'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Feb_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Mar'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Mar_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Apr'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Apr_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'May'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> May_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Jun'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Jun_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Jul'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Jul_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Aug'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Aug_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Sep'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Sep_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Oct'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Oct_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Nov'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Nov_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>( <span class="keyword">if</span>( <span class="keyword">month</span> = <span class="string">'Dec'</span>, revenue, <span class="literal">null</span> ) ) <span class="keyword">AS</span> Dec_Revenue</span><br><span class="line"><span class="keyword">FROM</span> Department</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">id</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="è§£æ³•ï¼’ï¼š-Pivot-table"><a href="#è§£æ³•ï¼’ï¼š-Pivot-table" class="headerlink" title="è§£æ³•ï¼’ï¼šã€€Pivot table"></a>è§£æ³•ï¼’ï¼šã€€Pivot table</h1><p>è¿™ä¸ªè§£æ³•åªèƒ½åœ¨SQL Serverä¸­ä½¿ç”¨ï¼Œæˆ‘ä¹Ÿå¤´ä¸€å›çœ‹è§ã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">id</span>,</span><br><span class="line">    Jan <span class="keyword">AS</span> Jan_Revenue,</span><br><span class="line">    Feb <span class="keyword">AS</span> Feb_Revenue, </span><br><span class="line">    Mar <span class="keyword">AS</span> Mar_Revenue, </span><br><span class="line">    Apr <span class="keyword">AS</span> Apr_Revenue,</span><br><span class="line">    May <span class="keyword">AS</span> May_Revenue,</span><br><span class="line">    Jun <span class="keyword">AS</span> Jun_Revenue,</span><br><span class="line">    Jul <span class="keyword">AS</span> Jul_Revenue,</span><br><span class="line">    Aug <span class="keyword">AS</span> Aug_Revenue,</span><br><span class="line">    Sep <span class="keyword">AS</span> Sep_Revenue,</span><br><span class="line">    <span class="keyword">Oct</span> <span class="keyword">AS</span> Oct_Revenue,</span><br><span class="line">    Nov <span class="keyword">AS</span> Nov_Revenue,</span><br><span class="line">    <span class="built_in">Dec</span> <span class="keyword">AS</span> Dec_Revenue</span><br><span class="line"><span class="keyword">FROM</span> Department</span><br><span class="line"><span class="keyword">PIVOT</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">MAX</span>(revenue)</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">month</span> <span class="keyword">IN</span> (Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, <span class="keyword">Oct</span>, Nov, <span class="built_in">Dec</span>)        </span><br><span class="line">) <span class="keyword">AS</span> MonthsRevenue</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvcmVmb3JtYXQtZGVwYXJ0bWVudC10YWJsZS8=" title="https://leetcode.com/problems/reformat-department-table/">https://leetcode.com/problems/reformat-department-table/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvcmVmb3JtYXQtZGVwYXJ0bWVudC10YWJsZS9kaXNjdXNzLzQyMjM4My9teXNxbC1lYXN5LXNvbHV0aW9u" title="https://leetcode.com/problems/reformat-department-table/discuss/422383/mysql-easy-solution">https://leetcode.com/problems/reformat-department-table/discuss/422383/mysql-easy-solution<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvcmVmb3JtYXQtZGVwYXJ0bWVudC10YWJsZS9kaXNjdXNzLzM3NjI0MS9NeVNRTC1Tb2x1dGlvbi13aXRoLTM4MS1tcy1mYXN0ZXItdGhhbi0xMDAuMDA=" title="https://leetcode.com/problems/reformat-department-table/discuss/376241/MySQL-Solution-with-381-ms-faster-than-100.00">https://leetcode.com/problems/reformat-department-table/discuss/376241/MySQL-Solution-with-381-ms-faster-than-100.00<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjEvdGFibGVmdW5jLmh0bWw=" title="https://www.postgresql.org/docs/9.1/tablefunc.html">https://www.postgresql.org/docs/9.1/tablefunc.html<i class="fa fa-external-link"></i></span> : pivot table in PostgreSQL</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc3Fsc2VydmVydHV0b3JpYWwubmV0L3NxbC1zZXJ2ZXItYmFzaWNzL3NxbC1zZXJ2ZXItcGl2b3Qv" title="https://www.sqlservertutorial.net/sql-server-basics/sql-server-pivot/">https://www.sqlservertutorial.net/sql-server-basics/sql-server-pivot/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNDgzODYyNjMvcGl2b3QtdGFibGUtaW4tc3FsLWNvbHVtbi1yZXN1bHRzLXRvLXJvd3M=" title="https://stackoverflow.com/questions/48386263/pivot-table-in-sql-column-results-to-rows">https://stackoverflow.com/questions/48386263/pivot-table-in-sql-column-results-to-rows<i class="fa fa-external-link"></i></span><br><!-- 
è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 627.swap.salary</title>
    <url>/2020/03/13/SQL-Leetcode-627-swap-salary/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>627.Swap Salary</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--MySQL</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> salary(<span class="keyword">id</span> <span class="built_in">int</span>, <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>), sex <span class="built_in">char</span>(<span class="number">1</span>), salary <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> salary</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> salary (<span class="keyword">id</span>, <span class="keyword">name</span>, sex, salary) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'A'</span>, <span class="string">'m'</span>, <span class="string">'2500'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> salary (<span class="keyword">id</span>, <span class="keyword">name</span>, sex, salary) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'B'</span>, <span class="string">'f'</span>, <span class="string">'1500'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> salary (<span class="keyword">id</span>, <span class="keyword">name</span>, sex, salary) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'C'</span>, <span class="string">'m'</span>, <span class="string">'5500'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> salary (<span class="keyword">id</span>, <span class="keyword">name</span>, sex, salary) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'D'</span>, <span class="string">'f'</span>, <span class="string">'500'</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> salary;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> salary(<span class="keyword">id</span> <span class="built_in">int</span>, <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>), sex <span class="built_in">char</span>(<span class="number">1</span>), salary <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> salary</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> salary (<span class="keyword">id</span>, <span class="keyword">name</span>, sex, salary) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'A'</span>, <span class="string">'m'</span>, <span class="string">'2500'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> salary (<span class="keyword">id</span>, <span class="keyword">name</span>, sex, salary) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'B'</span>, <span class="string">'f'</span>, <span class="string">'1500'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> salary (<span class="keyword">id</span>, <span class="keyword">name</span>, sex, salary) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'C'</span>, <span class="string">'m'</span>, <span class="string">'5500'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> salary (<span class="keyword">id</span>, <span class="keyword">name</span>, sex, salary) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'D'</span>, <span class="string">'f'</span>, <span class="string">'500'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Given a table <code>salary</code>, such as the one below, that has m=male and f=female values. Swap all f and m values (i.e., change all f values to m and vice versa) with a single update statement and no intermediate temp table.</p>
<p>Note that you must write a single update statement, DO NOT write any select statement for this problem.</p>
<p>Example:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">| id | name | sex | salary |</span><br><span class="line">|<span class="comment">----|------|-----|--------|</span></span><br><span class="line">| 1  | A    | m   | 2500   |</span><br><span class="line">| 2  | B    | f   | 1500   |</span><br><span class="line">| 3  | C    | m   | 5500   |</span><br><span class="line">| 4  | D    | f   | 500    |</span><br></pre></td></tr></tbody></table></figure>
<p>After running your update statement, the above salary table should have the following rows:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">| id | name | sex | salary |</span><br><span class="line">|<span class="comment">----|------|-----|--------|</span></span><br><span class="line">| 1  | A    | f   | 2500   |</span><br><span class="line">| 2  | B    | m   | 1500   |</span><br><span class="line">| 3  | C    | f   | 5500   |</span><br><span class="line">| 4  | D    | m   | 500    |</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> salary s</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">id</span> = s.id, <span class="keyword">name</span> = s.name, salary = s.salary, sex = (<span class="keyword">case</span> <span class="keyword">when</span> s.sex = <span class="string">'f'</span> <span class="keyword">then</span> <span class="string">'m'</span> <span class="keyword">else</span> <span class="string">'f'</span> <span class="keyword">end</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> salary s</span><br><span class="line"><span class="keyword">set</span> sex = (<span class="keyword">case</span> <span class="keyword">when</span> s.sex = <span class="string">'f'</span> <span class="keyword">then</span> <span class="string">'m'</span> <span class="keyword">else</span> <span class="string">'f'</span> <span class="keyword">end</span>);</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><p><strong>ä¸é€‚ç”¨äºPostgreSQL</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> salary <span class="keyword">SET</span> sex = <span class="keyword">IF</span>(sex = <span class="string">'m'</span>, <span class="string">'f'</span>, <span class="string">'m'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼“"><a href="#è§£æ³•ï¼“" class="headerlink" title="è§£æ³•ï¼“"></a>è§£æ³•ï¼“</h1><p><strong>é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> salary <span class="keyword">set</span> sex = <span class="keyword">CHR</span>(<span class="keyword">ASCII</span>(<span class="string">'f'</span>) + <span class="keyword">ASCII</span>(<span class="string">'m'</span>) - <span class="keyword">ASCII</span>(sex));</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>ascii</code>: char -&gt; ascii</li>
<li><code>chr</code>: ascii -&gt; char</li>
</ul>
<p><strong>ä¸é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> salary <span class="keyword">set</span> sex = <span class="built_in">CHAR</span>(<span class="keyword">ASCII</span>(<span class="string">'f'</span>) ^ <span class="keyword">ASCII</span>(<span class="string">'m'</span>) ^ <span class="keyword">ASCII</span>(sex));</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> salary <span class="keyword">set</span> sex= <span class="built_in">CHAR</span>(<span class="keyword">ASCII</span>(<span class="string">'f'</span>) + <span class="keyword">ASCII</span>(<span class="string">'m'</span>) - <span class="keyword">ASCII</span>(sex));</span><br></pre></td></tr></tbody></table></figure>
<p>å…¶å®åœ¨å¾ˆå¤šè§£æ³•ä¸­ï¼Œæœ‰å¾ˆå¤šçœ‹èµ·æ¥å¾ˆfancyçš„SQLè§£æ³•ï¼Œå…¶å®æˆ‘è§‰å¾—åªæ˜¯çœ‹èµ·æ¯”è¾ƒå‰å®³ç½¢äº†ã€‚<br>ä½†æ˜¯è¿™ä¸ª<strong>è§£æ³•3</strong>è¯´ä¸å®šçœŸçš„å¯ä»¥å¸¦æ¥æ›´çŸ­çš„è¿è¡Œæ—¶é—´ï¼Œå› ä¸ºå®ƒçœ‹èµ·æ¥branch-freeï¼Œå›é¿äº†<code>case</code>æˆ–è€…<code>if</code>ã€‚</p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvc3dhcC1zYWxhcnkv" title="https://leetcode.com/problems/swap-salary/">https://leetcode.com/problems/swap-salary/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvc3dhcC1zYWxhcnkvZGlzY3Vzcy8xMDQ3MTMvQWNjZXB0LXNvbHV0aW9uLXdpdGgteG9y" title="https://leetcode.com/problems/swap-salary/discuss/104713/Accept-solution-with-xor">https://leetcode.com/problems/swap-salary/discuss/104713/Accept-solution-with-xor<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjEvZnVuY3Rpb25zLWNvbmRpdGlvbmFsLmh0bWw=" title="https://www.postgresql.org/docs/9.1/functions-conditional.html">https://www.postgresql.org/docs/9.1/functions-conditional.html<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTEyOTkwMzcvcG9zdGdyZXNxbC1pZi1zdGF0ZW1lbnQ=" title="https://stackoverflow.com/questions/11299037/postgresql-if-statement">https://stackoverflow.com/questions/11299037/postgresql-if-statement<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 626.exchange.seats</title>
    <url>/2020/03/13/SQL-Leetcode-626-exchange-seats/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>626.Exchange Seats</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> seat(<span class="keyword">id</span> <span class="built_in">int</span>, student <span class="built_in">varchar</span>(<span class="number">255</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> seat</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Abbot'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Doris'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Emerson'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Green'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'Jeames'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> seat;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> seat(<span class="keyword">id</span> <span class="built_in">int</span>, student <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Abbot'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Doris'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Emerson'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Green'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> seat (<span class="keyword">id</span>, student) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'Jeames'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Mary is a teacher in a middle school and she has a table <code>seat</code> storing studentsâ€™ names and their corresponding <code>seat</code> ids.</p>
<p>The column id is continuous increment.</p>
<p>Mary wants to change seats for the adjacent students.</p>
<p>Can you write a SQL query to output the result for Mary?</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------+---------+</span></span><br><span class="line">|    id   | student |</span><br><span class="line">+<span class="comment">---------+---------+</span></span><br><span class="line">|    1    | Abbot   |</span><br><span class="line">|    2    | Doris   |</span><br><span class="line">|    3    | Emerson |</span><br><span class="line">|    4    | Green   |</span><br><span class="line">|    5    | Jeames  |</span><br><span class="line">+<span class="comment">---------+---------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>For the sample input, the output is:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------+---------+</span></span><br><span class="line">|    id   | student |</span><br><span class="line">+<span class="comment">---------+---------+</span></span><br><span class="line">|    1    | Doris   |</span><br><span class="line">|    2    | Abbot   |</span><br><span class="line">|    3    | Green   |</span><br><span class="line">|    4    | Emerson |</span><br><span class="line">|    5    | Jeames  |</span><br><span class="line">+<span class="comment">---------+---------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Note:<br>If the number of students is odd, there is no need to change the last oneâ€™s seat.</p>
<a id="more"></a>
<hr>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><p><strong>é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,</span><br><span class="line">        (<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">id</span> % <span class="number">2</span> = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">lead</span>(student, <span class="number">1</span>, student) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>)</span><br><span class="line">                              <span class="keyword">else</span> lag(student, <span class="number">1</span>, <span class="literal">null</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>) <span class="keyword">end</span>) <span class="keyword">as</span> student</span><br><span class="line"><span class="keyword">from</span> seat;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    (<span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="keyword">MOD</span>(<span class="keyword">id</span>, <span class="number">2</span>) != <span class="number">0</span> <span class="keyword">AND</span> counts != <span class="keyword">id</span> <span class="keyword">THEN</span> <span class="keyword">id</span> + <span class="number">1</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="keyword">MOD</span>(<span class="keyword">id</span>, <span class="number">2</span>) != <span class="number">0</span> <span class="keyword">AND</span> counts = <span class="keyword">id</span> <span class="keyword">THEN</span> <span class="keyword">id</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="keyword">id</span> - <span class="number">1</span></span><br><span class="line">    <span class="keyword">END</span>) <span class="keyword">AS</span> <span class="keyword">id</span>,</span><br><span class="line">    student</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    seat,</span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">        <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> counts</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        seat) <span class="keyword">AS</span> seat_counts</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼“"><a href="#è§£æ³•ï¼“" class="headerlink" title="è§£æ³•ï¼“"></a>è§£æ³•ï¼“</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    s1.id, <span class="keyword">COALESCE</span>(s2.student, s1.student) <span class="keyword">AS</span> student</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    seat s1</span><br><span class="line">        <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">    seat s2 <span class="keyword">ON</span> ((s1.id + <span class="number">1</span>) ^ <span class="number">1</span>) - <span class="number">1</span> = s2.id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> s1.id;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><p>Bit manipulation expression <code>(id+1)^1-1</code> can calculate the new id after switch.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span>, (<span class="keyword">id</span>+<span class="number">1</span>)^<span class="number">1</span><span class="number">-1</span>, student <span class="keyword">FROM</span> seat;</span><br><span class="line"></span><br><span class="line">| id | (id+1)^1-1 | student |</span><br><span class="line">|<span class="comment">----|------------|---------|</span></span><br><span class="line">| 1  | 2          | Abbot   |</span><br><span class="line">| 2  | 1          | Doris   |</span><br><span class="line">| 3  | 4          | Emerson |</span><br><span class="line">| 4  | 3          | Green   |</span><br><span class="line">| 5  | 6          | Jeames  |</span><br></pre></td></tr></tbody></table></figure>
<p>Then, we can make a temp table and join seat with this table like below.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    seat s1</span><br><span class="line">        <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">    seat s2 <span class="keyword">ON</span> (s1.id+<span class="number">1</span>)^<span class="number">1</span><span class="number">-1</span> = s2.id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> s1.id;</span><br><span class="line"></span><br><span class="line">| id | student | id | student |</span><br><span class="line">|<span class="comment">----|---------|----|---------|</span></span><br><span class="line">| 1  | Abbot   | 2  | Doris   |</span><br><span class="line">| 2  | Doris   | 1  | Abbot   |</span><br><span class="line">| 3  | Emerson | 4  | Green   |</span><br><span class="line">| 4  | Green   | 3  | Emerson |</span><br><span class="line">| 5  | Jeames  |    |         |</span><br></pre></td></tr></tbody></table></figure>
<p>Note:The first two columns are from s1 and the last two are from s2.</p>
<p>At last, we can output s1.id and s2.student. However, the s2.student is NULL for seat id â€˜5â€™ but s1.student is right. Thus, we we can use function <code>COALESCE()</code> to generate the correct output for the last record.</p>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZXhjaGFuZ2Utc2VhdHMv" title="https://leetcode.com/problems/exchange-seats/">https://leetcode.com/problems/exchange-seats/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZXhjaGFuZ2Utc2VhdHMvZGlzY3Vzcy81MjQ1MzkvNC1saW5lLXNvbHV0aW9uLXVzaW5nLXdpbmRvdy1mdW5jdGlvbi1Ub3AtUnVudGltZQ==" title="https://leetcode.com/problems/exchange-seats/discuss/524539/4-line-solution-using-window-function-Top-Runtime">https://leetcode.com/problems/exchange-seats/discuss/524539/4-line-solution-using-window-function-Top-Runtime<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZXhjaGFuZ2Utc2VhdHMvc29sdXRpb24v" title="https://leetcode.com/problems/exchange-seats/solution/">https://leetcode.com/problems/exchange-seats/solution/<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 620.not.boring.movies</title>
    <url>/2020/03/13/SQL-Leetcode-620-not-boring-movies/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>627.Swap Salary</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> cinema (<span class="keyword">id</span> <span class="built_in">int</span>, movie <span class="built_in">varchar</span>(<span class="number">255</span>), description <span class="built_in">varchar</span>(<span class="number">255</span>), rating <span class="built_in">float</span>(<span class="number">2</span>, <span class="number">1</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> cinema</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'War'</span>, <span class="string">'great 3D'</span>, <span class="string">'8.9'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Science'</span>, <span class="string">'fiction'</span>, <span class="string">'8.5'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'irish'</span>, <span class="string">'boring'</span>, <span class="string">'6.2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Ice song'</span>, <span class="string">'Fantacy'</span>, <span class="string">'8.6'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'House card'</span>, <span class="string">'Interesting'</span>, <span class="string">'9.1'</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> cinema;</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> cinema (<span class="keyword">id</span> <span class="built_in">int</span>, movie <span class="built_in">varchar</span>(<span class="number">255</span>), description <span class="built_in">varchar</span>(<span class="number">255</span>), rating <span class="built_in">decimal</span>(<span class="number">2</span>, <span class="number">1</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'War'</span>, <span class="string">'great 3D'</span>, <span class="string">'8.9'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Science'</span>, <span class="string">'fiction'</span>, <span class="string">'8.5'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'irish'</span>, <span class="string">'boring'</span>, <span class="string">'6.2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Ice song'</span>, <span class="string">'Fantacy'</span>, <span class="string">'8.6'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cinema (<span class="keyword">id</span>, movie, description, rating) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'House card'</span>, <span class="string">'Interesting'</span>, <span class="string">'9.1'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>X city opened a new cinema, many people would like to go to this cinema. The cinema also gives out a poster indicating the moviesâ€™ ratings and descriptions.<br>Please write a SQL query to output movies with an odd numbered ID and a description that is not â€˜boringâ€™. Order the result by rating.</p>
<p>For example, table <code>cinema</code>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------+-----------+--------------+-----------+</span></span><br><span class="line">|   id    | movie     |  description |  rating   |</span><br><span class="line">+<span class="comment">---------+-----------+--------------+-----------+</span></span><br><span class="line">|   1     | War       |   great 3D   |   8.9     |</span><br><span class="line">|   2     | Science   |   fiction    |   8.5     |</span><br><span class="line">|   3     | irish     |   boring     |   6.2     |</span><br><span class="line">|   4     | Ice song  |   Fantacy    |   8.6     |</span><br><span class="line">|   5     | House card|   Interesting|   9.1     |</span><br><span class="line">+<span class="comment">---------+-----------+--------------+-----------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>For the example above, the output should be:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------+-----------+--------------+-----------+</span></span><br><span class="line">|   id    | movie     |  description |  rating   |</span><br><span class="line">+<span class="comment">---------+-----------+--------------+-----------+</span></span><br><span class="line">|   5     | House card|   Interesting|   9.1     |</span><br><span class="line">|   1     | War       |   great 3D   |   8.9     |</span><br><span class="line">+<span class="comment">---------+-----------+--------------+-----------+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> cinema c</span><br><span class="line"><span class="keyword">where</span> c.id % <span class="number">2</span> = <span class="number">1</span> <span class="keyword">and</span> c.description != <span class="string">'boring'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c.rating <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> cinema c</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">mod</span>(c.id, <span class="number">2</span>) = <span class="number">1</span> <span class="keyword">and</span> c.description != <span class="string">'boring'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> c.rating <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvbm90LWJvcmluZy1tb3ZpZXMv" title="https://leetcode.com/problems/not-boring-movies/">https://leetcode.com/problems/not-boring-movies/<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 601.human.traffic.of.stadium</title>
    <url>/2020/03/13/SQL-Leetcode-601-human-traffic-of-stadium/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>601.Human Traffic of Stadium</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> stadium (<span class="keyword">id</span> <span class="built_in">int</span>, visit_date <span class="built_in">DATE</span> <span class="literal">NULL</span>, people <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> stadium</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'2017-01-01'</span>, <span class="string">'10'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'2017-01-02'</span>, <span class="string">'109'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'2017-01-03'</span>, <span class="string">'150'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'2017-01-04'</span>, <span class="string">'99'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'2017-01-05'</span>, <span class="string">'145'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'2017-01-06'</span>, <span class="string">'1455'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'7'</span>, <span class="string">'2017-01-07'</span>, <span class="string">'199'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'8'</span>, <span class="string">'2017-01-08'</span>, <span class="string">'188'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> stadium;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stadium (<span class="keyword">id</span> <span class="built_in">int</span>, visit_date <span class="built_in">DATE</span> <span class="literal">NULL</span>, people <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'2017-01-01'</span>, <span class="string">'10'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'2017-01-02'</span>, <span class="string">'109'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'2017-01-03'</span>, <span class="string">'150'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'2017-01-04'</span>, <span class="string">'99'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'2017-01-05'</span>, <span class="string">'145'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'2017-01-06'</span>, <span class="string">'1455'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'7'</span>, <span class="string">'2017-01-07'</span>, <span class="string">'199'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stadium (<span class="keyword">id</span>, visit_date, people) <span class="keyword">values</span> (<span class="string">'8'</span>, <span class="string">'2017-01-08'</span>, <span class="string">'188'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>X city built a new stadium, each day many people visit it and the stats are saved as these columns: id, visit_date, people</p>
<p>Please write a query to display the records which have 3 or more consecutive rows and the amount of people more than 100(inclusive).</p>
<p>For example, the table <code>stadium</code>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">------+------------+-----------+</span></span><br><span class="line">| id   | visit_date | people    |</span><br><span class="line">+<span class="comment">------+------------+-----------+</span></span><br><span class="line">| 1    | 2017-01-01 | 10        |</span><br><span class="line">| 2    | 2017-01-02 | 109       |</span><br><span class="line">| 3    | 2017-01-03 | 150       |</span><br><span class="line">| 4    | 2017-01-04 | 99        |</span><br><span class="line">| 5    | 2017-01-05 | 145       |</span><br><span class="line">| 6    | 2017-01-06 | 1455      |</span><br><span class="line">| 7    | 2017-01-07 | 199       |</span><br><span class="line">| 8    | 2017-01-08 | 188       |</span><br><span class="line">+<span class="comment">------+------------+-----------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>For the sample data above, the output is:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">------+------------+-----------+</span></span><br><span class="line">| id   | visit_date | people    |</span><br><span class="line">+<span class="comment">------+------------+-----------+</span></span><br><span class="line">| 5    | 2017-01-05 | 145       |</span><br><span class="line">| 6    | 2017-01-06 | 1455      |</span><br><span class="line">| 7    | 2017-01-07 | 199       |</span><br><span class="line">| 8    | 2017-01-08 | 188       |</span><br><span class="line">+<span class="comment">------+------------+-----------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Note:<br>Each day only have one row record, and the dates are increasing with id increasing.</p>
<a id="more"></a>
<hr>
<p>è¿™é‡Œæˆ‘éœ€è¦å®ådissä¸€ä¸‹<span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvaHVtYW4tdHJhZmZpYy1vZi1zdGFkaXVtL3NvbHV0aW9uLw==" title="https://leetcode.com/problems/human-traffic-of-stadium/solution/">Leetcodeæ‰€é€‰å‡ºçš„ç­”æ¡ˆ<i class="fa fa-external-link"></i></span>ã€‚ç¬›å¡å„¿ç§¯å½¢å¼çš„ç®—æ³•åœ¨å¤§å‹æ•°æ®é›†ä¸‹çš„SQLåŸºæœ¬ä¸Šéƒ½ä¸èƒ½ç»ˆæ­¢ã€‚</p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> three_day <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *, </span><br><span class="line">           <span class="keyword">lead</span>(people, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>) <span class="keyword">as</span> next1, </span><br><span class="line">           <span class="keyword">lead</span>(people, <span class="number">2</span>, <span class="literal">NULl</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>) <span class="keyword">as</span> next2 </span><br><span class="line">    <span class="keyword">from</span> stadium</span><br><span class="line">), ids <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span> </span><br><span class="line">    <span class="keyword">from</span> three_day</span><br><span class="line">    <span class="keyword">where</span> people &gt;= <span class="number">100</span> <span class="keyword">and</span> next1 &gt;= <span class="number">100</span> <span class="keyword">and</span> next2 &gt;= <span class="number">100</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span> + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> three_day</span><br><span class="line">    <span class="keyword">where</span> people &gt;= <span class="number">100</span> <span class="keyword">and</span> next1 &gt;= <span class="number">100</span> <span class="keyword">and</span> next2 &gt;= <span class="number">100</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span> + <span class="number">2</span></span><br><span class="line">    <span class="keyword">from</span> three_day</span><br><span class="line">    <span class="keyword">where</span> people &gt;= <span class="number">100</span> <span class="keyword">and</span> next1 &gt;= <span class="number">100</span> <span class="keyword">and</span> next2 &gt;= <span class="number">100</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> stadium s </span><br><span class="line"><span class="keyword">where</span> s.id <span class="keyword">in</span> (<span class="keyword">select</span> * <span class="keyword">from</span> ids);</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s1.id, s1.visit_date, s1.people</span><br><span class="line"><span class="keyword">FROM</span>(</span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">    s.id, </span><br><span class="line">    s.visit_date, </span><br><span class="line">    s.people, </span><br><span class="line">    <span class="keyword">lead</span>(people) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">ASC</span>) <span class="keyword">as</span> next1,</span><br><span class="line">    <span class="keyword">lead</span>(people,<span class="number">2</span>) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">ASC</span> ) <span class="keyword">as</span> next2,</span><br><span class="line">    lag(people) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">ASC</span>) <span class="keyword">as</span> prev1,</span><br><span class="line">    lag(people,<span class="number">2</span>) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">ASC</span> ) <span class="keyword">as</span> prev2</span><br><span class="line">    <span class="keyword">FROM</span> stadium <span class="keyword">as</span> s</span><br><span class="line">    ) <span class="keyword">AS</span> s1	</span><br><span class="line"><span class="keyword">WHERE</span> (people&gt;=<span class="number">100</span> <span class="keyword">and</span> </span><br><span class="line">       ((next1&gt;=<span class="number">100</span> <span class="keyword">and</span> next2&gt;=<span class="number">100</span>)</span><br><span class="line">        <span class="keyword">or</span> (prev1&gt;=<span class="number">100</span> <span class="keyword">and</span> prev2&gt;=<span class="number">100</span>)</span><br><span class="line">        <span class="keyword">or</span> (prev1&gt;=<span class="number">100</span> <span class="keyword">and</span> next1&gt;=<span class="number">100</span>) <span class="comment">-- &lt;-this one is missing</span></span><br><span class="line">       ));</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvaHVtYW4tdHJhZmZpYy1vZi1zdGFkaXVtLw==" title="https://leetcode.com/problems/human-traffic-of-stadium/">https://leetcode.com/problems/human-traffic-of-stadium/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvaHVtYW4tdHJhZmZpYy1vZi1zdGFkaXVtL2Rpc2N1c3MvMjM3Mjk1L01TLVNRTC1TaW1wbGUtTGVhZC1hbmQtTGFn" title="https://leetcode.com/problems/human-traffic-of-stadium/discuss/237295/MS-SQL-Simple-Lead-and-Lag">https://leetcode.com/problems/human-traffic-of-stadium/discuss/237295/MS-SQL-Simple-Lead-and-Lag<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 596.classes.more.than.5.students</title>
    <url>/2020/03/12/SQL-Leetcode-596-classes-more-than-5-students/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>596.Classes More Than 5 Students</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> courses (student <span class="built_in">varchar</span>(<span class="number">255</span>), <span class="keyword">class</span> <span class="built_in">varchar</span>(<span class="number">255</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> courses</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'A'</span>, <span class="string">'Math'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'B'</span>, <span class="string">'English'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'C'</span>, <span class="string">'Math'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'D'</span>, <span class="string">'Biology'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'E'</span>, <span class="string">'Math'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'F'</span>, <span class="string">'Computer'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'G'</span>, <span class="string">'Math'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'H'</span>, <span class="string">'Math'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'I'</span>, <span class="string">'Math'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> courses;</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> courses (student <span class="built_in">varchar</span>(<span class="number">255</span>), <span class="keyword">class</span> <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'A'</span>, <span class="string">'Math'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'B'</span>, <span class="string">'English'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'C'</span>, <span class="string">'Math'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'D'</span>, <span class="string">'Biology'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'E'</span>, <span class="string">'Math'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'F'</span>, <span class="string">'Computer'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'G'</span>, <span class="string">'Math'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'H'</span>, <span class="string">'Math'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (student, <span class="keyword">class</span>) <span class="keyword">values</span> (<span class="string">'I'</span>, <span class="string">'Math'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>There is a table <code>courses</code> with columns: student and class</p>
<p>Please list out all classes which have more than or equal to 5 students.</p>
<p>For example, the table:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------+------------+</span></span><br><span class="line">| student | class      |</span><br><span class="line">+<span class="comment">---------+------------+</span></span><br><span class="line">| A       | Math       |</span><br><span class="line">| B       | English    |</span><br><span class="line">| C       | Math       |</span><br><span class="line">| D       | Biology    |</span><br><span class="line">| E       | Math       |</span><br><span class="line">| F       | Computer   |</span><br><span class="line">| G       | Math       |</span><br><span class="line">| H       | Math       |</span><br><span class="line">| I       | Math       |</span><br><span class="line">+<span class="comment">---------+------------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Should output:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------+</span></span><br><span class="line">| class   |</span><br><span class="line">+<span class="comment">---------+</span></span><br><span class="line">| Math    |</span><br><span class="line">+<span class="comment">---------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Note:<br>The students should not be counted duplicate in each course.</p>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> c.class </span><br><span class="line"><span class="keyword">from</span> courses c </span><br><span class="line"><span class="keyword">where</span> <span class="number">5</span> &lt;= (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> s.student) </span><br><span class="line">    <span class="keyword">from</span> courses s </span><br><span class="line">    <span class="keyword">where</span> s.class = c.class</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c.class </span><br><span class="line"><span class="keyword">from</span> courses c </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c.class </span><br><span class="line"><span class="keyword">having</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> c.student) &gt;= <span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvY2xhc3Nlcy1tb3JlLXRoYW4tNS1zdHVkZW50cy8=" title="https://leetcode.com/problems/classes-more-than-5-students/">https://leetcode.com/problems/classes-more-than-5-students/<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 595.big.countries</title>
    <url>/2020/03/12/SQL-Leetcode-595-big-countries/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>595.Big Countries</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> World (<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">255</span>), continent <span class="built_in">varchar</span>(<span class="number">255</span>), area <span class="built_in">int</span>, population <span class="built_in">int</span>, gdp <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> World</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Afghanistan'</span>, <span class="string">'Asia'</span>, <span class="string">'652230'</span>, <span class="string">'25500100'</span>, <span class="string">'20343000000'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Albania'</span>, <span class="string">'Europe'</span>, <span class="string">'28748'</span>, <span class="string">'2831741'</span>, <span class="string">'12960000000'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Algeria'</span>, <span class="string">'Africa'</span>, <span class="string">'2381741'</span>, <span class="string">'37100000'</span>, <span class="string">'188681000000'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Andorra'</span>, <span class="string">'Europe'</span>, <span class="string">'468'</span>, <span class="string">'78115'</span>, <span class="string">'3712000000'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Angola'</span>, <span class="string">'Africa'</span>, <span class="string">'1246700'</span>, <span class="string">'20609294'</span>, <span class="string">'100990000000'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> World;</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> World (<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">255</span>), continent <span class="built_in">varchar</span>(<span class="number">255</span>), area <span class="built_in">int</span>, population <span class="built_in">int</span>, gdp <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Afghanistan'</span>, <span class="string">'Asia'</span>, <span class="string">'652230'</span>, <span class="string">'25500100'</span>, <span class="string">'20343000000'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Albania'</span>, <span class="string">'Europe'</span>, <span class="string">'28748'</span>, <span class="string">'2831741'</span>, <span class="string">'12960000000'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Algeria'</span>, <span class="string">'Africa'</span>, <span class="string">'2381741'</span>, <span class="string">'37100000'</span>, <span class="string">'188681000000'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Andorra'</span>, <span class="string">'Europe'</span>, <span class="string">'468'</span>, <span class="string">'78115'</span>, <span class="string">'3712000000'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> World (<span class="keyword">name</span>, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">'Angola'</span>, <span class="string">'Africa'</span>, <span class="string">'1246700'</span>, <span class="string">'20609294'</span>, <span class="string">'100990000000'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>There is a table <code>World</code></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">-----------------+------------+------------+--------------+---------------+</span></span><br><span class="line">| name            | continent  | area       | population   | gdp           |</span><br><span class="line">+<span class="comment">-----------------+------------+------------+--------------+---------------+</span></span><br><span class="line">| Afghanistan     | Asia       | 652230     | 25500100     | 20343000      |</span><br><span class="line">| Albania         | Europe     | 28748      | 2831741      | 12960000      |</span><br><span class="line">| Algeria         | Africa     | 2381741    | 37100000     | 188681000     |</span><br><span class="line">| Andorra         | Europe     | 468        | 78115        | 3712000       |</span><br><span class="line">| Angola          | Africa     | 1246700    | 20609294     | 100990000     |</span><br><span class="line">+<span class="comment">-----------------+------------+------------+--------------+---------------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>A country is big if it has an area of bigger than 3 million square km or a population of more than 25 million.</p>
<p>Write a SQL solution to output big countriesâ€™ name, population and area.</p>
<p>For example, according to the above table, we should output:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">--------------+-------------+--------------+</span></span><br><span class="line">| name         | population  | area         |</span><br><span class="line">+<span class="comment">--------------+-------------+--------------+</span></span><br><span class="line">| Afghanistan  | 25500100    | 652230       |</span><br><span class="line">| Algeria      | 37100000    | 2381741      |</span><br><span class="line">+<span class="comment">--------------+-------------+--------------+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•1"><a href="#è§£æ³•1" class="headerlink" title="è§£æ³•1"></a>è§£æ³•1</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> w.name, w.population, w.area</span><br><span class="line"><span class="keyword">from</span> world w</span><br><span class="line"><span class="keyword">where</span> w.area &gt; <span class="number">3000000</span> <span class="keyword">or</span> w.population &gt; <span class="number">25000000</span></span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•2"><a href="#è§£æ³•2" class="headerlink" title="è§£æ³•2"></a>è§£æ³•2</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">name</span>, population, area</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    world</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    area &gt; <span class="number">3000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">name</span>, population, area</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    world</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    population &gt; <span class="number">25000000</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é¢˜éå¸¸ç®€å•ï¼Œä½†æ˜¯æœ‰å¦å¤–ä¸€ç‚¹å¼•èµ·æˆ‘çš„æ³¨æ„ï¼š<br><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvYmlnLWNvdW50cmllcy9zb2x1dGlvbi8=" title="https://leetcode.com/problems/big-countries/solution/">https://leetcode.com/problems/big-countries/solution/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTM3NTA0NzUvc3FsLXBlcmZvcm1hbmNlLXVuaW9uLXZzLW9y" title="https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or">https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvYmlnLWNvdW50cmllcy9kaXNjdXNzLzEwMzU2MS9Vbmlvbi1hbmQtT1ItYW5kLXRoZS1FeHBsYW5hdGlvbg==" title="https://leetcode.com/problems/big-countries/discuss/103561/Union-and-OR-and-the-Explanation">https://leetcode.com/problems/big-countries/discuss/103561/Union-and-OR-and-the-Explanation<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvYmlnLWNvdW50cmllcy8=" title="https://leetcode.com/problems/big-countries/">https://leetcode.com/problems/big-countries/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvYmlnLWNvdW50cmllcy9zb2x1dGlvbi8=" title="https://leetcode.com/problems/big-countries/solution/">https://leetcode.com/problems/big-countries/solution/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTM3NTA0NzUvc3FsLXBlcmZvcm1hbmNlLXVuaW9uLXZzLW9y" title="https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or">https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvYmlnLWNvdW50cmllcy9kaXNjdXNzLzEwMzU2MS9Vbmlvbi1hbmQtT1ItYW5kLXRoZS1FeHBsYW5hdGlvbg==" title="https://leetcode.com/problems/big-countries/discuss/103561/Union-and-OR-and-the-Explanation">https://leetcode.com/problems/big-countries/discuss/103561/Union-and-OR-and-the-Explanation<i class="fa fa-external-link"></i></span></p>
<p>è¯¥æ–‡ç« éµå¾ª<span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLzQuMC9kZWVkLnpo" title="https://creativecommons.org/licenses/by-nc/4.0/deed.zh">åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0<i class="fa fa-external-link"></i></span>ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³<span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLzQuMC9kZWVkLnpo" title="https://creativecommons.org/licenses/by-nc/4.0/deed.zh">åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0<i class="fa fa-external-link"></i></span> çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 262.trips.and.users</title>
    <url>/2020/03/12/SQL-Leetcode-262-trips-and-users/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>262.Trips and Users</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Trips (<span class="keyword">Id</span> <span class="built_in">int</span>, Client_Id <span class="built_in">int</span>, Driver_Id <span class="built_in">int</span>, City_Id <span class="built_in">int</span>, <span class="keyword">Status</span> ENUM(<span class="string">'completed'</span>, <span class="string">'cancelled_by_driver'</span>, <span class="string">'cancelled_by_client'</span>), Request_at <span class="built_in">varchar</span>(<span class="number">50</span>))</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="keyword">Users</span> (Users_Id <span class="built_in">int</span>, Banned <span class="built_in">varchar</span>(<span class="number">50</span>), <span class="keyword">Role</span> ENUM(<span class="string">'client'</span>, <span class="string">'driver'</span>, <span class="string">'partner'</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Trips</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'10'</span>, <span class="string">'1'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-01'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'11'</span>, <span class="string">'1'</span>, <span class="string">'cancelled_by_driver'</span>, <span class="string">'2013-10-01'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'12'</span>, <span class="string">'6'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-01'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'13'</span>, <span class="string">'6'</span>, <span class="string">'cancelled_by_client'</span>, <span class="string">'2013-10-01'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'1'</span>, <span class="string">'10'</span>, <span class="string">'1'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-02'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'2'</span>, <span class="string">'11'</span>, <span class="string">'6'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-02'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'7'</span>, <span class="string">'3'</span>, <span class="string">'12'</span>, <span class="string">'6'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-02'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'8'</span>, <span class="string">'2'</span>, <span class="string">'12'</span>, <span class="string">'12'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-03'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'9'</span>, <span class="string">'3'</span>, <span class="string">'10'</span>, <span class="string">'12'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-03'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'10'</span>, <span class="string">'4'</span>, <span class="string">'13'</span>, <span class="string">'12'</span>, <span class="string">'cancelled_by_driver'</span>, <span class="string">'2013-10-03'</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="keyword">Users</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'No'</span>, <span class="string">'client'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Yes'</span>, <span class="string">'client'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'No'</span>, <span class="string">'client'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'No'</span>, <span class="string">'client'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'10'</span>, <span class="string">'No'</span>, <span class="string">'driver'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'11'</span>, <span class="string">'No'</span>, <span class="string">'driver'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'12'</span>, <span class="string">'No'</span>, <span class="string">'driver'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'13'</span>, <span class="string">'No'</span>, <span class="string">'driver'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> Trips;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">Users</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TYPE</span> <span class="keyword">status</span> <span class="keyword">AS</span> ENUM(<span class="string">'completed'</span>, <span class="string">'cancelled_by_driver'</span>, <span class="string">'cancelled_by_client'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TYPE</span> <span class="keyword">role</span> <span class="keyword">AS</span> ENUM(<span class="string">'client'</span>, <span class="string">'driver'</span>, <span class="string">'partner'</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Trips (<span class="keyword">Id</span> <span class="built_in">int</span>, Client_Id <span class="built_in">int</span>, Driver_Id <span class="built_in">int</span>, City_Id <span class="built_in">int</span>, <span class="keyword">Status</span> <span class="keyword">status</span>, Request_at <span class="built_in">varchar</span>(<span class="number">50</span>));</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">Users</span> (Users_Id <span class="built_in">int</span>, Banned <span class="built_in">varchar</span>(<span class="number">50</span>), <span class="keyword">Role</span> <span class="keyword">role</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'10'</span>, <span class="string">'1'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'11'</span>, <span class="string">'1'</span>, <span class="string">'cancelled_by_driver'</span>, <span class="string">'2013-10-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'12'</span>, <span class="string">'6'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'4'</span>, <span class="string">'13'</span>, <span class="string">'6'</span>, <span class="string">'cancelled_by_client'</span>, <span class="string">'2013-10-01'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'1'</span>, <span class="string">'10'</span>, <span class="string">'1'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-02'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'2'</span>, <span class="string">'11'</span>, <span class="string">'6'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-02'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'7'</span>, <span class="string">'3'</span>, <span class="string">'12'</span>, <span class="string">'6'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-02'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'8'</span>, <span class="string">'2'</span>, <span class="string">'12'</span>, <span class="string">'12'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-03'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'9'</span>, <span class="string">'3'</span>, <span class="string">'10'</span>, <span class="string">'12'</span>, <span class="string">'completed'</span>, <span class="string">'2013-10-03'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Trips (<span class="keyword">Id</span>, Client_Id, Driver_Id, City_Id, <span class="keyword">Status</span>, Request_at) <span class="keyword">values</span> (<span class="string">'10'</span>, <span class="string">'4'</span>, <span class="string">'13'</span>, <span class="string">'12'</span>, <span class="string">'cancelled_by_driver'</span>, <span class="string">'2013-10-03'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'No'</span>, <span class="string">'client'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Yes'</span>, <span class="string">'client'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'No'</span>, <span class="string">'client'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'No'</span>, <span class="string">'client'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'10'</span>, <span class="string">'No'</span>, <span class="string">'driver'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'11'</span>, <span class="string">'No'</span>, <span class="string">'driver'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'12'</span>, <span class="string">'No'</span>, <span class="string">'driver'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Users</span> (Users_Id, Banned, <span class="keyword">Role</span>) <span class="keyword">values</span> (<span class="string">'13'</span>, <span class="string">'No'</span>, <span class="string">'driver'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>Trips</code> table holds all taxi trips. Each trip has a unique Id, while Client_Id and Driver_Id are both foreign keys to the Users_Id at the Users table. Status is an ENUM type of (â€˜completedâ€™, â€˜cancelled_by_driverâ€™, â€˜cancelled_by_clientâ€™).</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+-----------+-----------+---------+--------------------+----------+</span></span><br><span class="line">| Id | Client_Id | Driver_Id | City_Id |        Status      |Request_at|</span><br><span class="line">+<span class="comment">----+-----------+-----------+---------+--------------------+----------+</span></span><br><span class="line">| 1  |     1     |    10     |    1    |     completed      |2013-10-01|</span><br><span class="line">| 2  |     2     |    11     |    1    | cancelled_by_driver|2013-10-01|</span><br><span class="line">| 3  |     3     |    12     |    6    |     completed      |2013-10-01|</span><br><span class="line">| 4  |     4     |    13     |    6    | cancelled_by_client|2013-10-01|</span><br><span class="line">| 5  |     1     |    10     |    1    |     completed      |2013-10-02|</span><br><span class="line">| 6  |     2     |    11     |    6    |     completed      |2013-10-02|</span><br><span class="line">| 7  |     3     |    12     |    6    |     completed      |2013-10-02|</span><br><span class="line">| 8  |     2     |    12     |    12   |     completed      |2013-10-03|</span><br><span class="line">| 9  |     3     |    10     |    12   |     completed      |2013-10-03| </span><br><span class="line">| 10 |     4     |    13     |    12   | cancelled_by_driver|2013-10-03|</span><br><span class="line">+<span class="comment">----+-----------+-----------+---------+--------------------+----------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>The Users table holds all users. Each user has an unique Users_Id, and Role is an ENUM type of (â€˜clientâ€™, â€˜driverâ€™, â€˜partnerâ€™).</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----------+--------+--------+</span></span><br><span class="line">| Users_Id | Banned |  Role  |</span><br><span class="line">+<span class="comment">----------+--------+--------+</span></span><br><span class="line">|    1     |   No   | client |</span><br><span class="line">|    2     |   Yes  | client |</span><br><span class="line">|    3     |   No   | client |</span><br><span class="line">|    4     |   No   | client |</span><br><span class="line">|    10    |   No   | driver |</span><br><span class="line">|    11    |   No   | driver |</span><br><span class="line">|    12    |   No   | driver |</span><br><span class="line">|    13    |   No   | driver |</span><br><span class="line">+<span class="comment">----------+--------+--------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query to find the cancellation rate of requests made by unbanned users (both client and driver must be unbanned) between Oct 1, 2013 and Oct 3, 2013. The cancellation rate is computed by dividing the number of canceled (by client or driver) requests made by unbanned users by the total number of requests made by unbanned users.</p>
<p>For the above tables, your SQL query should return the following rows with the cancellation rate being rounded to two decimal places.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">------------+-------------------+</span></span><br><span class="line">|     Day    | Cancellation Rate |</span><br><span class="line">+<span class="comment">------------+-------------------+</span></span><br><span class="line">| 2013-10-01 |       0.33        |</span><br><span class="line">| 2013-10-02 |       0.00        |</span><br><span class="line">| 2013-10-03 |       0.50        |</span><br><span class="line">+<span class="comment">------------+-------------------+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><p><strong>é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> temp.request_at <span class="keyword">as</span> <span class="string">"Day"</span>, </span><br><span class="line">       <span class="keyword">round</span>(<span class="keyword">cast</span>(<span class="keyword">count</span>(*) filter (<span class="keyword">where</span> temp.status != <span class="string">'completed'</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> temp.request_at) <span class="keyword">as</span> <span class="built_in">decimal</span>) / <span class="keyword">count</span>(*) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> temp.request_at), <span class="number">2</span>) <span class="keyword">as</span> <span class="string">"Cancellation Rate"</span> </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> request_at, <span class="keyword">status</span> </span><br><span class="line">    <span class="keyword">from</span> trips t, <span class="keyword">users</span> <span class="keyword">client</span>, <span class="keyword">users</span> driver </span><br><span class="line">    <span class="keyword">where</span> t.client_id = client.users_id <span class="keyword">and</span> t.driver_id = driver.users_id <span class="keyword">and</span> client.banned = <span class="string">'No'</span> <span class="keyword">and</span> driver.banned = <span class="string">'No'</span>) <span class="keyword">as</span> temp;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p><strong>é€‚ç”¨äºMSSQLå’ŒPostgreSQL</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> temp.request_at <span class="keyword">as</span> <span class="string">"Day"</span>, </span><br><span class="line">       <span class="keyword">round</span>(<span class="keyword">cast</span>(<span class="keyword">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> temp.status != <span class="string">'completed'</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">end</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> temp.request_at) <span class="keyword">as</span> <span class="built_in">decimal</span>) / <span class="keyword">count</span>(*) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> temp.request_at), <span class="number">2</span>) <span class="keyword">as</span> <span class="string">"Cancellation Rate"</span> </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> request_at, <span class="keyword">status</span> </span><br><span class="line">    <span class="keyword">from</span> trips t, <span class="keyword">users</span> <span class="keyword">client</span>, <span class="keyword">users</span> driver </span><br><span class="line">    <span class="keyword">where</span> t.client_id = client.users_id <span class="keyword">and</span> t.driver_id = driver.users_id <span class="keyword">and</span> client.banned = <span class="string">'No'</span> <span class="keyword">and</span> driver.banned = <span class="string">'No'</span>) <span class="keyword">as</span> temp;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvdHJpcHMtYW5kLXVzZXJzLw==" title="https://leetcode.com/problems/trips-and-users/">https://leetcode.com/problems/trips-and-users/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzkzNzg1NTAvc3FsLXdpbmRvdy1mdW5jdGlvbi13aXRoLWEtd2hlcmUtY2xhdXNl" title="https://stackoverflow.com/questions/39378550/sql-window-function-with-a-where-clause">https://stackoverflow.com/questions/39378550/sql-window-function-with-a-where-clause<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9tb2Rlcm4tc3FsLmNvbS9kZS9mZWF0dXJlL2ZpbHRlcg==" title="https://modern-sql.com/de/feature/filter">https://modern-sql.com/de/feature/filter<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 197.rising.temperature</title>
    <url>/2020/03/12/SQL-Leetcode-197-rising-temperature/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>197.Rising Temperature</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Weather (<span class="keyword">Id</span> <span class="built_in">int</span>, RecordDate <span class="built_in">date</span>, Temperature <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Weather;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Weather (<span class="keyword">Id</span>, RecordDate, Temperature) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'2015-01-01'</span>, <span class="string">'10'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Weather (<span class="keyword">Id</span>, RecordDate, Temperature) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'2015-01-02'</span>, <span class="string">'25'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Weather (<span class="keyword">Id</span>, RecordDate, Temperature) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'2015-01-03'</span>, <span class="string">'20'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Weather (<span class="keyword">Id</span>, RecordDate, Temperature) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'2015-01-04'</span>, <span class="string">'30'</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Weather;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Weather (<span class="keyword">Id</span> <span class="built_in">int</span>, RecordDate <span class="built_in">date</span>, Temperature <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Weather (<span class="keyword">Id</span>, RecordDate, Temperature) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'2015-01-01'</span>, <span class="string">'10'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Weather (<span class="keyword">Id</span>, RecordDate, Temperature) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'2015-01-02'</span>, <span class="string">'25'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Weather (<span class="keyword">Id</span>, RecordDate, Temperature) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'2015-01-03'</span>, <span class="string">'20'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Weather (<span class="keyword">Id</span>, RecordDate, Temperature) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'2015-01-04'</span>, <span class="string">'30'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Given a <code>Weather</code> table, write a SQL query to find all datesâ€™ Ids with higher temperature compared to its previous (yesterdayâ€™s) dates.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------+------------------+------------------+</span></span><br><span class="line">| Id(INT) | RecordDate(DATE) | Temperature(INT) |</span><br><span class="line">+<span class="comment">---------+------------------+------------------+</span></span><br><span class="line">|       1 |       2015-01-01 |               10 |</span><br><span class="line">|       2 |       2015-01-02 |               25 |</span><br><span class="line">|       3 |       2015-01-03 |               20 |</span><br><span class="line">|       4 |       2015-01-04 |               30 |</span><br><span class="line">+<span class="comment">---------+------------------+------------------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>For example, return the following Ids for the above <code>Weather</code> table:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+</span></span><br><span class="line">| Id |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">|  2 |</span><br><span class="line">|  4 |</span><br><span class="line">+<span class="comment">----+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<p>æˆ‘ç¬¬ä¸€æ¬¡å®¡é¢˜ï¼Œè¯¯çœ‹æˆå’Œå‰ä¸€ä¸ªtuple(å½“ç„¶ä¸ä¸€å®šæ˜¯å‰ä¸€å¤©)æ¯”è¾ƒæ¸©åº¦çš„å¤§å°ï¼Œç„¶åå†™äº†å¦‚ä¸‹çš„å¸¦window functionçš„ç‰ˆæœ¬ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> w.id <span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> *, lag(Temperature, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> RecordDate) <span class="keyword">as</span> last_temp </span><br><span class="line">    <span class="keyword">from</span> weather) <span class="keyword">as</span> w </span><br><span class="line"><span class="keyword">where</span> w.temperature &gt; w.last_temp;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><p><strong>é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> temp.id <span class="keyword">as</span> <span class="keyword">Id</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> w1.id <span class="keyword">as</span> <span class="keyword">id</span>, w1.temperature <span class="keyword">as</span> temp, w2.temperature <span class="keyword">as</span> last_temp </span><br><span class="line">    <span class="keyword">from</span> weather w1, weather w2 </span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">EXTRACT</span> (<span class="keyword">DAY</span> <span class="keyword">FROM</span> w1.recorddate) - <span class="keyword">EXTRACT</span> (<span class="keyword">DAY</span> <span class="keyword">FROM</span> w2.recorddate) = <span class="number">1</span>) <span class="keyword">as</span> temp </span><br><span class="line"><span class="keyword">where</span> temp.temp &gt; temp.last_temp;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><p><strong>é€‚ç”¨äºMySQL</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> temp.id <span class="keyword">as</span> <span class="keyword">Id</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> w1.id <span class="keyword">as</span> <span class="keyword">id</span>, w1.temperature <span class="keyword">as</span> temp, w2.temperature <span class="keyword">as</span> last_temp </span><br><span class="line">    <span class="keyword">from</span> weather w1, weather w2 </span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">DATEDIFF</span>(w1.recorddate, w2.recorddate) = <span class="number">1</span>) <span class="keyword">as</span> temp </span><br><span class="line"><span class="keyword">where</span> temp.temp &gt; temp.last_temp;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    t1.Id</span><br><span class="line"><span class="keyword">From</span> </span><br><span class="line">    Weather t1, Weather t2</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">    t1.Temperature &gt; t2.Temperature</span><br><span class="line"><span class="keyword">AND</span></span><br><span class="line">    <span class="keyword">subdate</span>(t1.Date, <span class="number">1</span>) = t2.Date</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvcmlzaW5nLXRlbXBlcmF0dXJlLw==" title="https://leetcode.com/problems/rising-temperature/">https://leetcode.com/problems/rising-temperature/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvcmlzaW5nLXRlbXBlcmF0dXJlL2Rpc2N1c3MvNTU2NDkvU29sdXRpb24td2l0aC1teXNxbC1idWlsdC1pbi1mdW5jdGlvbg==" title="https://leetcode.com/problems/rising-temperature/discuss/55649/Solution-with-mysql-built-in-function">https://leetcode.com/problems/rising-temperature/discuss/55649/Solution-with-mysql-built-in-function<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjMvZnVuY3Rpb25zLWRhdGV0aW1lLmh0bWwjRlVOQ1RJT05TLURBVEVUSU1FLUVYVFJBQ1Q=" title="https://www.postgresql.org/docs/9.3/functions-datetime.html#FUNCTIONS-DATETIME-EXTRACT">https://www.postgresql.org/docs/9.3/functions-datetime.html#FUNCTIONS-DATETIME-EXTRACT<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 196.delete.duplicate.emails</title>
    <url>/2020/03/12/SQL-Leetcode-196-delete-duplicate-emails/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>196.Delete Duplicate Emails</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> Person (<span class="keyword">Id</span> <span class="built_in">int</span>, Email <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Person</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'john@example.com'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'bob@example.com'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'john@example.com'</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Person;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Person (<span class="keyword">Id</span> <span class="built_in">int</span>, Email <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'john@example.com'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'bob@example.com'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'john@example.com'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query to delete all duplicate email entries in a table named <code>Person</code>, keeping only unique emails based on its smallest Id.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+------------------+</span></span><br><span class="line">| Id | Email            |</span><br><span class="line">+<span class="comment">----+------------------+</span></span><br><span class="line">| 1  | john@example.com |</span><br><span class="line">| 2  | bob@example.com  |</span><br><span class="line">| 3  | john@example.com |</span><br><span class="line">+<span class="comment">----+------------------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Id is the primary key column for this table.<br>For example, after running your query, the above <code>Person</code> table should have the following rows:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+------------------+</span></span><br><span class="line">| Id | Email            |</span><br><span class="line">+<span class="comment">----+------------------+</span></span><br><span class="line">| 1  | john@example.com |</span><br><span class="line">| 2  | bob@example.com  |</span><br><span class="line">+<span class="comment">----+------------------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Note:</p>
<p>Your output is the whole <code>Person</code> table after executing your sql. Use <code>delete</code> statement.</p>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><p><strong>é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> </span><br><span class="line"><span class="keyword">from</span> person p1 </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> * </span><br><span class="line">    <span class="keyword">from</span> person p2 </span><br><span class="line">    <span class="keyword">where</span> p1.id &gt; p2.id <span class="keyword">and</span> p1.email = p2.email</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><p><strong>ä¸é€‚ç”¨äºPostgreSQL</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> p1 </span><br><span class="line"><span class="keyword">FROM</span> Person p1,</span><br><span class="line">    Person p2</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    p1.Email = p2.Email <span class="keyword">AND</span> p1.Id &gt; p2.Id;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZGVsZXRlLWR1cGxpY2F0ZS1lbWFpbHMv" title="https://leetcode.com/problems/delete-duplicate-emails/">https://leetcode.com/problems/delete-duplicate-emails/<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]Lec03 Database Storage Part I - æ•°æ®åº“å­˜å‚¨ I</title>
    <url>/2020/03/11/CMU-15445-Lec03/</url>
    <content><![CDATA[<p>Database Storage Part I - æ•°æ®åº“å­˜å‚¨ I</p>
<p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzAzLXN0b3JhZ2UxLnBkZg==" title="https://15445.courses.cs.cmu.edu/fall2019/slides/03-storage1.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/03-storage1.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDMtc3RvcmFnZTEucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/03-storage1.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/03-storage1.pdf<i class="fa fa-external-link"></i></span><br>Reading: Chapter 10.1-10.2, 10.5-10.6</p>
<p>è¿™èŠ‚ä¸¤è¯¾ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ æ•°æ®åº“å†…éƒ¨çš„å­˜å‚¨ã€‚</p>
<p>Database Storage åœ¨CMUåˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œåœ¨ä¸¤èŠ‚è¯¾ä¸­è®²ã€‚è¿™æ˜¯ç¬¬ä¸€éƒ¨åˆ†ã€‚</p>
<p>è¿™éƒ¨åˆ†æ¶‰åŠå­˜å‚¨çš„ç¡¬ä»¶, æ“ä½œç³»ç»Ÿæä¾›çš„syscall, æ•°æ®åº“ç¼“å­˜åŒº(buffer pool)çš„ç¼“å­˜é¡µ(buffer page), Slotted pageç­‰ç­‰ã€‚</p>
<a id="more"></a>
<p><img data-src="/images/CMU1544564/Lec03/1.jpg" alt="1.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/3.jpg" alt="3.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/4.jpg" alt="4.jpg"></p>
<h1 id="Disk-Oriented-Architecture"><a href="#Disk-Oriented-Architecture" class="headerlink" title="Disk-Oriented Architecture"></a>Disk-Oriented Architecture</h1><p><img data-src="/images/CMU1544564/Lec03/5.jpg" alt="5.jpg"></p>
<p>è¿™ä¸ªè¯¾æˆ‘ä»¬é‡ç‚¹åœ¨Disk-oriented databases(é¢å‘ç£ç›˜çš„æ•°æ®åº“), è¿™æ˜¯ä¸€ç§æ¯”è¾ƒæˆç†Ÿï¼Œè¯ç”Ÿå¾ˆæ—©çš„æ•°æ®åº“ç±»å‹ã€‚åœ¨2010sã€€å­¦æœ¯ç•Œå’Œå·¥ä¸šç•Œä¸­å¼€å‘äº†éå¸¸å¤šä¼˜ç§€çš„In-Memory databases(å†…å­˜æ•°æ®åº“)ï¼Œå½“ç„¶å®ƒçš„æ•°æ®ä¸»è¦å­˜å‚¨(primary storage location)äºå†…å­˜ä¸­ã€‚å†…å­˜æ•°æ®åº“å…·ä½“çš„ç»†èŠ‚å¯ä»¥åœ¨CMUçš„é«˜çº§æ•°æ®åº“è¯¾(CMU 15-721)ä¸­å­¦åˆ°ã€‚</p>
<p>å¦å¤–ï¼Œ<strong>å¹´é¾„æ¯”è¾ƒå¤§</strong>å¹¶ä¸æ„å‘³ç€Disk-oriented databasesæ²¡è½ã€‚ç›¸åçš„æ˜¯ï¼Œ HDDçš„å¯é æ€§å’Œä½å»‰çš„ä»·æ ¼ä¿éšœäº†Disk-oriented databasesçš„å¸‚åœºä»½é¢ï¼ŒSSDç¡¬ä»¶çš„è¯»å†™èƒ½åŠ›çš„è¿›æ­¥è®©Disk-oriented databaseså¹¶ä¸æ¯” In-Memory databasesæ…¢å¾ˆå¤šã€‚è¿‘äº›å¹´ï¼ŒDisk-oriented databasesæ­£åœ¨åŠªåŠ›èåˆæ¥çº³ In-Memory databases çš„æŠ€æœ¯ï¼Œå¹¶æ‹¥æœ‰ç›¸åŒçš„performanceï¼Œè§ã€€<span class="exturl" data-url="aHR0cHM6Ly91bWJyYS5kYi5pbi50dW0uZGUv" title="https://umbra.db.in.tum.de/">https://umbra.db.in.tum.de/<i class="fa fa-external-link"></i></span></p>
<h2 id="Storage-Hierarchy"><a href="#Storage-Hierarchy" class="headerlink" title="Storage Hierarchy"></a>Storage Hierarchy</h2><p><img data-src="/images/CMU1544564/Lec03/6.jpg" alt="6.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/7.jpg" alt="7.jpg"></p>
<p>æˆ‘ä»¬æ³¨æ„æ°´å¹³çš„è™šçº¿ï¼š</p>
<ul>
<li>è™šçº¿ä»¥ä¸Šï¼šã€€voltaile devices (æ˜“å¤±çš„å­˜å‚¨ç¡¬ä»¶è®¾å¤‡)ï¼Œæ•°æ®åªèƒ½åœ¨ç”µåŠ›æä¾›çš„æƒ…å†µä¸‹è¢«å­˜å‚¨ã€‚å•ä½å®¹é‡ä»·æ ¼æ›´è´µï¼Œéšæœºè®¿é—®(random access)è¾ƒå¿«ï¼Œè®¿é—®æ•°æ®ç²’åº¦(granularity)æ˜¯Byte, å³æ¯æ¬¡è®¿é—®å¯ä»¥è·å¾—æ•°æ®çš„æœ€å°å•å…ƒæ˜¯Byteã€‚</li>
<li>è™šçº¿ä»¥ä¸‹ï¼šã€€non-voltaile devices (éæ˜“å¤±çš„å­˜å‚¨ç¡¬ä»¶è®¾å¤‡)ï¼Œæ•°æ®å¯ä»¥åœ¨æ— ç”µåŠ›æä¾›çš„æƒ…å†µä¸‹è¢«å­˜å‚¨ã€‚å•ä½å®¹é‡ä»·æ ¼æ›´ä¾¿å®œï¼Œéšæœºè®¿é—®(random access)è¾ƒæ…¢ï¼Œè®¿é—®æ•°æ®ç²’åº¦(granularity)æ˜¯Block, å³æ¯æ¬¡è®¿é—®å¯ä»¥è·å¾—æ•°æ®çš„æœ€å°å•å…ƒæ˜¯Blockã€‚ä¸€ä¸ªBlockä¸€èˆ¬ä¸º4KiBã€‚</li>
</ul>
<p>non-voltaile deviceså¯ä»¥è¢«æ¨¡ç³Šç§°ä¸º<em>disk</em>ï¼Œå½“ç„¶æ˜¯åœ¨æˆ‘ä»¬ä¸åŒºåˆ†SSD, HDD, Network Storage, Tapeçš„æ—¶å€™ã€‚å¦å¤–å®ƒä»¬ä¹Ÿè¢«ç§°ä¸ºã€€block devicesï¼Œå› ä¸ºæ˜¯è®¿é—®ç²’åº¦æ˜¯ä¸€ä¸ªblockã€‚</p>
<h3 id="NVM"><a href="#NVM" class="headerlink" title="NVM"></a>NVM</h3><p><img data-src="/images/CMU1544564/Lec03/8.jpg" alt="8.jpg"></p>
<p>Pavloæ•™æˆçš„ç¬¬ä¸€ä¸ªPhDå­¦ç”Ÿ Joy Arulrajçš„ä¸»è¦ç ”ç©¶æ–¹å‘æ˜¯ä¸€ç§æ–°çš„ç¡¬ä»¶ Non-voltaile Memoryï¼Œè¿™ç§ç¡¬ä»¶ä¼šæ”¹å˜æˆ‘ä»¬å·²çŸ¥çš„ Storage Hierarchyã€‚</p>
<p>éå¸¸ä¸ä¸¥è°¨çš„è¯´ï¼Œå®ƒåƒæ˜¯å†…å­˜å’Œç¡¬ç›˜çš„å­©å­ï¼š</p>
<ul>
<li>è®¿é—®ç²’åº¦æ˜¯Byte</li>
<li>è®¿é—®é€Ÿåº¦ç¨æ…¢äºå†…å­˜</li>
<li>éæ˜“å¤±</li>
</ul>
<p><img data-src="https://blobs.gitbook.com/assets%2F-LCeQxrze3Z6fEniTf2v%2F-LLjk64O7_5of1p_CGnO%2F-LLjkCG1sMXBB_QrIqZp%2Fpmem_storage_pyramid.jpg?alt=media&amp;token=7b37e107-1927-43a8-b4c1-6e4289cdb458" alt="NVM -- Source: Persistent Memory Documentation, pmem"></p>
<p>Non-Volatile Memory Database Management Systems: <span class="exturl" data-url="aHR0cHM6Ly93d3cubW9yZ2FuY2xheXBvb2wuY29tL2RvaS8xMC4yMjAwL1MwMDg5MUVEMVYwMVkyMDE4MTJEVE0wNTU=" title="https://www.morganclaypool.com/doi/10.2200/S00891ED1V01Y201812DTM055">https://www.morganclaypool.com/doi/10.2200/S00891ED1V01Y201812DTM055<i class="fa fa-external-link"></i></span></p>
<p>å¦é™„ä¸Šä¸¤ç¯‡NVMæœ‰å…³çš„è®ºæ–‡, ä½œè€…æ˜¯æˆ‘æœ¬ç§‘è®ºæ–‡çš„å¯¼å¸ˆ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8">ğŸ˜„</span> : </p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL3ZhbnJlbmVuL3BhcGVycy9IeU1lbS5wZGY/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/vanrenen/papers/HyMem.pdf?lang=de">Managing Non-Volatile Memory in Database Systems<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL3ZhbnJlbmVuL3BhcGVycy9udm1fc3RhdHMucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/people/sites/vanrenen/papers/nvm_stats.pdf?lang=de">Persistent Memory I/O Primitives<i class="fa fa-external-link"></i></span></li>
</ul>
<p><br></p>
<h2 id="Acess-Time"><a href="#Acess-Time" class="headerlink" title="Acess Time"></a>Acess Time</h2><p><img data-src="/images/CMU1544564/Lec03/9.jpg" alt="9.jpg"></p>
<ul>
<li>1s = 1,000 ms = 1,000,000 ns</li>
<li>çº¢è‰²ç®­å¤´å³ä¾§çš„æ˜¯æ•°å­—åªæ˜¯ä¸€ä¸ª<strong>ç±»æ¯”æ¯”å–»</strong>ï¼Œå‡è®¾<code>1ns = 1s</code>,ã€€æ¥ä½¿å¾—å„ä¸ªå­˜å‚¨ä»‹è´¨çš„è®¿é—®æ—¶é—´å·®è·å˜å¾—æ›´æ¸…æ™°ã€‚</li>
</ul>
<p>Latency numbers every programmer should know: <span class="exturl" data-url="aHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vaGVsbGVyYmFyZGUvMjg0MzM3NQ==" title="https://gist.github.com/hellerbarde/2843375">https://gist.github.com/hellerbarde/2843375<i class="fa fa-external-link"></i></span></p>
<!-- TODO: link more access time -->
<be>

<h2 id="System-Design-Goals-in-Disk-oriented-databases"><a href="#System-Design-Goals-in-Disk-oriented-databases" class="headerlink" title="System Design Goals (in Disk-oriented databases)"></a>System Design Goals (in Disk-oriented databases)</h2><p>Disk-oriented databasesã€€éœ€è¦å¤„ç†æ¯”ç‰©ç†å†…å­˜æ›´å¤§çš„æ•°æ®ï¼Œè¿™æ„å‘³ç€æ•°æ®åº“éœ€è¦æœ‰ç¼“å­˜åŒºç®¡ç†å™¨ï¼Œå®ƒ<em>æä¾›æœåŠ¡</em>ç»™ä¸Šå±‚çš„æ•°æ®åº“ï¼Œè®©æ•°æ®åº“èƒ½è®¿é—®ä»»ä½•ä¸€ä¸ªæ•°æ®ï¼Œè€Œè¿™ä¸ªæ•°æ®å®é™…ä¸Šå·²ç»ç”±ç¼“å­˜åŒºç®¡ç†å™¨ç”±ç¡¬ç›˜ load è¿›å†…å­˜ã€‚ç¼“å­˜åŒºç®¡ç†å™¨çš„å·¥ä½œå°±æ˜¯å°†æ•°æ®(å®é™…ä¸Šæ˜¯<strong>é¡µ</strong>)ä»ç¡¬ç›˜è¯»è¿›å†…å­˜ æˆ– ä»å†…å­˜å†™å…¥ç¡¬ç›˜ï¼Œç›®çš„æ˜¯è®©ä¸Šå±‚çš„æ•°æ®åº“æœ‰æ›´é«˜æ•ˆçš„ç¼“å­˜æœºåˆ¶(caching)ï¼Œæ›´å°‘çš„I/O Operationï¼Œæ›´é«˜çš„æ€§èƒ½ï¼Œæ›´çŸ­çš„è¿è¡Œæ—¶é—´ã€‚</p>
<p>å‡ ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>ç¼“å­˜åŒº: Buffer Pool</li>
<li>ç¼“å­˜åŒºç®¡ç†å™¨: Buffer Manager / buffer pool manager</li>
<li>é¡µ:ã€€page / Buffer page</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec03/10.jpg" alt="10.jpg"></p>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>æˆ‘ä»¬æ¼”ç¤ºä¸€ä¸‹ï¼Œå‡è®¾æˆ‘ä»¬åˆšåˆšæ‰“å¼€æ•°æ®åº“ï¼Œæ­¤æ—¶æ•°æ®åº“çš„Buffer Poolæ˜¯ç©ºçš„ï¼š</p>
<p><img data-src="/images/CMU1544564/Lec03/12.jpg" alt="12.jpg"></p>
<p><br></p>
<p>Execution Engineè°ƒç”¨äº†buffer pool managerçš„ä¸€ä¸ªå‡½æ•°: <code>getpage(int : 2)</code>, ä¸ºäº†å¾—åˆ°ç¬¬äºŒä¸ª pageã€‚ã€€ç›®å‰æˆ‘ä»¬åªå°†ã€€Execution Engineè§†ä½œä¸€ä¸ªéœ€è¦ page çš„æ•°æ®åº“é«˜å±‚çš„éƒ¨åˆ†ï¼Œéœ€è¦ buffer pool managerã€€æä¾›çš„æœåŠ¡:</p>
<p><img data-src="/images/CMU1544564/Lec03/13.jpg" alt="13.jpg"></p>
<p><br></p>
<p>è¿™æ—¶å€™æ•°æ®åº“éœ€è¦ä»ç¡¬ç›˜ä¸­è¯»<strong>directory page</strong>åˆ°å†…å­˜ï¼Œdirectory pageæ˜¯buffer poolçš„header,ã€€è®°å½•äº†æ¯ä¸€ä¸ªpageå¯¹åº”çš„æ–‡ä»¶ã€‚</p>
<p>Directory pageåœ¨è¿™èŠ‚è¯¾åé¢ä¼šè¢«æåˆ°ï¼Œè§<a href="#page-directory">Heap File - Page Directory</a></p>
<p>å½“directory pageè¿›å…¥å†…å­˜ï¼Œbuffer pool managerä»å®ƒä¸Šé¢è¯»åˆ°äº†page 2å¯¹åº”çš„æ–‡ä»¶ä½ç½®:</p>
<p><img data-src="/images/CMU1544564/Lec03/14.jpg" alt="14.jpg"></p>
<p><br></p>
<p>æ¥ä¸‹æ¥page 2è¢«è¯»åˆ°å†…å­˜ä¸­ï¼Œexecution engineå¾—åˆ°å®ƒæƒ³è¦çš„ä¸œè¥¿ï¼š ä¸€ä¸ªpage2å†…å®¹åœ¨å†…å­˜çš„æŒ‡é’ˆã€‚</p>
<p><img data-src="/images/CMU1544564/Lec03/15.jpg" alt="15.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/16.jpg" alt="16.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/17.jpg" alt="17.jpg"></p>
<p><br></p>
<h2 id="Why-not-use-the-OS"><a href="#Why-not-use-the-OS" class="headerlink" title="Why not use the OS?"></a>Why not use the OS?</h2><p>ä¸Šè¿°æ•´ä¸ªæœºåˆ¶å®Œå…¨å’Œ<strong>æ“ä½œç³»ç»Ÿä¸­è™šæ‹Ÿå†…å­˜</strong>ä¸€è‡´ã€‚æ“ä½œç³»ç»Ÿç»™æ¯ä¸€ä¸ªè¿›ç¨‹(process)æä¾›è™šæ‹Ÿå†…å­˜å¤§å°çš„åœ°å€ç©ºé—´(address space)ï¼Œè€Œè™šæ‹Ÿå†…å­˜çš„å¤§å°å¾€å¾€æ¯”æœºå™¨çš„ç‰©ç†å†…å­˜è¦å¤§ï¼Œè¿›ç¨‹è¢«<em>æ¬ºéª—</em>è€Œä½¿ç”¨è™šæ‹Ÿå†…å­˜å¯¹åº”çš„åœ°å€ã€‚è€Œæ“ä½œç³»ç»Ÿé€šè¿‡MMUæ˜ å°„æ¯ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜ï¼Œä»è€Œå‘è¿›ç¨‹æä¾›å¯¹åº”çš„ç‰©ç†å†…å­˜çš„åœ°å€ä¸Šçš„æ•°æ®ã€‚è€Œå½“è¿›ç¨‹ä½¿ç”¨è¶…è¿‡ç‰©ç†å†…å­˜å¤§å°çš„åœ°å€ç©ºé—´(address space)æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿæ˜¯åœ¨ç¡¬ç›˜å’Œå†…å­˜ä¸­ç¼“å­˜ pageï¼Œè¿›è¡Œswapã€‚</p>
<p>é‚£æ—¢ç„¶æ“ä½œç³»ç»Ÿå’Œæ•°æ®åº“çš„ç¼“å­˜é¡µæœºåˆ¶ç±»ä¼¼ï¼Œæˆ‘ä»¬å‘è‡ªå·±æå‡ºä¸€ä¸ªç›´å‡»çµé­‚çš„é—®é¢˜ï¼š<br><strong>ä¸ºä»€ä¹ˆæ•°æ®åº“ä¸ç›´æ¥ç”¨æ“ä½œç³»ç»Ÿçš„é¡µï¼Œè€Œæµªè´¹æ—¶é—´(?)å¼€å‘ä¸€ä¸ªbuffer pool manageråšç±»ä¼¼çš„äº‹æƒ…å‘¢ï¼Ÿ</strong></p>
<h3 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a><code>mmap</code></h3><blockquote>
<p>One way to achieve this virtual memory, is by using mmap to map the contents of a file in a process address space</p>
</blockquote>
<p>ä¸Šé¢è¿™å¥è¯æ¥è‡ªäº<span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDMtc3RvcmFnZTEucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/03-storage1.pdf">Note<i class="fa fa-external-link"></i></span>, å®ƒå®é™…ä¸Šä¸å¤ªå®Œæ•´ï¼Œ<code>mmap</code>æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿæä¾›çš„<code>syscall</code>:  </p>
<ul>
<li>map <strong>the OS file caching area, where the reqeusted file is readed</strong>, in a process address space</li>
<li>åŸè¯ä¸­çš„<code>map the contents of file...</code>ä¼šè®©äººè¯¯è§£ä¸ºï¼Œç›´æ¥ä»ç¡¬ç›˜å¼€å§‹æ˜ å°„ï¼Œè¿™å½“ç„¶æ˜¯é”™çš„ã€‚å®é™…ä¸Šï¼Œæ“ä½œç³»ç»Ÿå…ˆå°†æ–‡ä»¶è¯»è¿›æ“ä½œç³»ç»Ÿæ–‡ä»¶ç¼“å­˜åŒº(file cache)ï¼Œå†å°†è¿™ä¸ªç¼“å­˜åŒºçš„æ–‡ä»¶å†…å®¹æ˜ å°„åˆ°å¯¹åº”è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</li>
<li>æˆ–è€…</li>
<li>ä½¿ç”¨direct I/O: <code>O_DIRECT</code> = disable page cache in OS for reading/writing file, å¯ä»¥é¿å…ä½¿ç”¨æ“ä½œç³»ç»Ÿæ–‡ä»¶ç¼“å­˜åŒºï¼Œç›´æ¥å°†æ–‡ä»¶è¯»å–åˆ°æ•°æ®åº“(æ¯”å¦‚buffer poolç¼“å­˜åŒº)çš„address spaceã€‚è¿™æ ·æ€§èƒ½ä¹Ÿä¼šæ›´å¥½ã€‚å› ä¸ºçœå»ä»æ“ä½œç³»ç»Ÿæ–‡ä»¶ç¼“å­˜åŒºå¤åˆ¶è¿›æ•°æ®åº“address spaceè¿™ä¸€æ­¥ã€‚<code>mmap</code>å¯ä»¥äº§ç”Ÿå†…å­˜æ–‡ä»¶ï¼ŒæŠŠç£ç›˜æ–‡ä»¶çš„å†…å®¹mapåˆ°å†…å­˜çš„åœ°å€ç©ºé—´ã€‚</li>
</ul>
<p><br></p>
<ul>
<li>åœ¨Lec05ä¸­ï¼Œæˆ‘ä»¬ç»§ç»­ä¼šæåˆ°æ“ä½œç³»ç»Ÿä¸­çš„page cache<a href="https://cakebytheoceanluo.github.io/2020/03/17/CMU-15445-Lec05/#OS-Page-Cache">[CMU-15445]Lec05 - OS Page Cache</a></li>
<li>Lec05è¯¾ä¸Šçš„å¯¹åº”çš„PostgreSQLå®éªŒ, è§<a href="https://cakebytheoceanluo.github.io/2020/03/17/DBMS-PostgreSQL-%E7%BC%93%E5%AD%98%E5%8C%BA%E7%AE%A1%E7%90%86BufferPool/">[DBMS][PostgreSQL] ç¼“å­˜åŒºç®¡ç† BufferPool</a></li>
</ul>
<p><code>mmap</code>æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è¿›ç¨‹é€šä¿¡æ–¹å¼(if <code>shared</code>)ï¼ŒåŒæ—¶ä¹Ÿæ˜¯é«˜æ€§èƒ½æ–‡ä»¶æ“ä½œçš„æ–¹æ³•ã€‚æˆ‘ä»¬ä»¥åä¼šä»”ç»†è®²è®²ã€‚</p>
<!-- TODO: mmap -->
<h3 id="Demo-1"><a href="#Demo-1" class="headerlink" title="Demo"></a>Demo</h3><p><img data-src="/images/CMU1544564/Lec03/18.jpg" alt="18.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/19.jpg" alt="19.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/20.jpg" alt="20.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/21.jpg" alt="21.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/22.jpg" alt="22.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/23.jpg" alt="23.jpg"></p>
<p>ä¸Šé¢çš„demoçš„æ„æ€æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨ç‰©ç†å†…å­˜å·²æ»¡çš„æƒ…å†µä¸‹ï¼Œç»§ç»­éœ€è¦page2ï¼Œè¿™æ—¶å€™ä¼šå‡ºç°ä¸€ä¸ªpage fault(é¡µç¼ºå¤±)ï¼Œæˆ‘ä»¬éœ€è¦ä»ç‰©ç†å†…å­˜ä¸­å»æ‰ä¸€ä¸ªpageï¼Œæ¥ç»™page2æä¾›ç©ºé—´ã€‚å½“ç„¶demoæœ€å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦page1çš„æ—¶å€™ï¼Œå’Œæˆ‘ä»¬éœ€è¦page3çš„æ—¶å€™ï¼Œå®ƒä»¬éƒ½ä¸å†ç‰©ç†å†…å­˜ä¸­ï¼Œè¿™æ—¶å€™æˆ‘ä»¬ä¹Ÿé‡åˆ°äº†page Faultã€‚</p>
<p>å½“<code>mmap</code>é‡åˆ°ä¸€ä¸ªpage faultçš„æ—¶å€™ä¼šè¢«blocked:</p>
<blockquote>
<p>Unfortunately, this means that if <code>mmap</code> hits a page fault, this will <strong>block</strong> the process. </p>
</blockquote>
<p>ä¸Šé¢è¿™å¥è¯æ¥è‡ªäº<span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDMtc3RvcmFnZTEucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/03-storage1.pdf">Note<i class="fa fa-external-link"></i></span></p>
<blockquote>
<p>â€¦ mmap() can block, because setting up a user visible virtual memory mapping requires a relatively complex data structure setup on the kernel side, which involves kernel allocating memory from its internal allocators â€¦</p>
</blockquote>
<p>ä¸Šé¢è¿™å¥è¯æ¥è‡ªäº<span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzIwMDg1NDU2LzgwNDk0MDg=" title="https://stackoverflow.com/a/20085456/8049408">Can sbrk(2) or mmap(2) block? - oakadâ€™s answer<i class="fa fa-external-link"></i></span></p>
<p>page Faultæ—¶å…·ä½“å‘ç”Ÿçš„äº‹æƒ…ï¼Œå®Œå…¨ç±»ä¼¼<code>syscall</code>å‘ç”Ÿçš„äº‹æƒ…ä¸€æ ·:<br>å½“å‰ç¨‹åºä¼šä»ser mode TRAPè¿›å…¥ kernel modeï¼Œè¿™æ—¶è¿›ç¨‹ä¸€ç›´è¢«blocked (CPU stalled), ç›´åˆ°å¯¹åº”æ–°çš„pageè¢«åŠ è½½è¿›å…¥kernel spaceè€Œä¸”ç¨‹åºå›åˆ°user modeä¸ºæ­¢ã€‚</p>
<h3 id="ç­”æ¡ˆ"><a href="#ç­”æ¡ˆ" class="headerlink" title="ç­”æ¡ˆ"></a>ç­”æ¡ˆ</h3><p>æˆ‘ä»¬å·²çŸ¥<code>mmap</code>ä¼šè¢«blocked, è¿™ä¸ªé˜»æ–­æ—¶é—´ä¸­ï¼Œæ•°æ®åº“ä¸Šé¢ä¹Ÿåšä¸äº†ï¼Œåªèƒ½ç­‰å¾…æ–°çš„pageåŠ è½½ç»“æŸã€‚è¿™ä¼šå¸¦æ¥æ€§èƒ½ä¸‹é™é—®é¢˜ã€‚å¦å¤–å¦‚æœæœ‰å¤šä¸ªå¹¶å‘å†™ï¼Œéœ€è¦åŒæ­¥æœºåˆ¶ï¼Œç³»ç»Ÿä¹Ÿæä¾›ä¸€äº›åŒæ­¥æŒ‡ä»¤<code>madvise</code>, <code>mlock</code>, <code>msync</code>ã€‚ä½†æ˜¯æ“ä½œç³»ç»Ÿåªæ˜¯ä¸€ä¸ªé€šç”¨æ–¹æ¡ˆï¼Œè¾¾ä¸åˆ°æ€§èƒ½æœ€ä¼˜ã€‚</p>
<p>å¦å¤–æ“ä½œç³»ç»Ÿä¸èƒ½å°†ä¸€ä¸ªpageç«‹å³å†™å›ç¡¬ç›˜ï¼Œè¿™ä¸€ç‚¹ä¼šåœ¨äº‹åŠ¡Loggingä¸­ä½¿æ­£ç¡®æ€§ä¸èƒ½è¢«ä¿è¯ã€‚</p>
<p>ç”±äº<strong>æ€§èƒ½é—®é¢˜</strong>å’Œ<strong>æ­£ç¡®æ€§é—®é¢˜</strong>ï¼Œ<code>mmap</code>æ¯”è¾ƒå°‘åœ¨æ•°æ®åº“ä¸­è¢«é‡‡ç”¨ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec03/24.jpg" alt="24.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/25.jpg" alt="25.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/26.jpg" alt="26.jpg"></p>
<p><br><br><br><br><br></p>
<h1 id="Database-Storage"><a href="#Database-Storage" class="headerlink" title="Database Storage"></a>Database Storage</h1><p><img data-src="/images/CMU1544564/Lec03/27.jpg" alt="27.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/28.jpg" alt="28.jpg"></p>
<h2 id="File-Storage"><a href="#File-Storage" class="headerlink" title="File Storage"></a>File Storage</h2><p><img data-src="/images/CMU1544564/Lec03/29.jpg" alt="29.jpg"></p>
<h3 id="Storage-Manager"><a href="#Storage-Manager" class="headerlink" title="Storage Manager"></a>Storage Manager</h3><p>ä¸‹é¢ä¸€ä¸ªé—®é¢˜ï¼ŒDBMSå¦‚ä½•å°†æ•°æ®åº“çš„æ•°æ®æ”¾åˆ°ç£ç›˜æ–‡ä»¶ä¸Šï¼Ÿ è¿™é‡Œæœ‰ä¸ªé€‰æ‹©ï¼ŒDBMSæ˜¯å¦è¦ç”¨æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿˜æ˜¯æ‹¿ä¸€å—raw storageè‡ªå·±ç®¡ç†ã€‚ç°åœ¨ä¸€èˆ¬çš„é€‰æ‹©æ˜¯è¿˜æ˜¯ä½¿ç”¨æ“ä½œç³»ç»Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œæ¯•ç«Ÿæ–¹ä¾¿ã€‚æ—¢ç„¶ç”¨æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£ä¹ˆDBMSå°±éœ€è¦æŠŠæ•°æ®åº“æ•°æ®å­˜æˆä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ã€‚æ¯ä¸ªæ–‡ä»¶æœ‰å¤šä¸ªpageç»„æˆã€‚pageå…¶å®å°±æ˜¯å›ºå®šå¤§å°çš„æ•°æ®å—ï¼Œé‚£ä¸ºä»€ä¹ˆè¦æœ‰è¿™å±‚æŠ½è±¡ï¼Ÿè¿™ä¸ªå’Œæˆ‘ä»¬ä½¿ç”¨çš„å­˜å‚¨çš„ç£ç›˜æœ‰å…³ï¼Œå®ƒé™¤äº†æ…¢ï¼Œè¿˜æœ‰ä¸ªç‰¹ç‚¹æ˜¯å¯¹é¡ºåºè¯»å†™æ¯”è¾ƒå‹å¥½ï¼Œå› ä¸ºéšæœºè¯»éœ€è¦ç£å¤´ä¸æ–­çš„æœºæ¢°ç§»åŠ¨çš„ã€‚æ‰€ä»¥æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜é—´çš„I/Oï¼Œéœ€è¦<strong>å°½é‡æ‰¹é‡è¯»</strong>ï¼Œè¯»å†™æ•°æ®çš„æœ€å°å•ä½ç§°ä¸ºæ•°æ®å—blockï¼Œä¸€èˆ¬æ˜¯4KiBï¼Œå› ä¸º4KiBæ¯”è¾ƒç»æµã€‚è€Œæ•°æ®åº“çš„pageæ˜¯åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„ï¼Œæ‰€ä»¥è®¾è®¡æˆ4KiBçš„å€æ•°ä¼šæ¯”è¾ƒåˆç†ã€‚<sup><a href="#fn1">1</a></sup></p>
<p>storage managerèƒ½å¤Ÿç†è§£è§£é‡Šinterpretå¯¹åº”çš„æ•°æ®åº“æ–‡ä»¶ï¼Œå°†æ•°æ®åº“æ–‡ä»¶representæˆä¸€ä¸ªpageçš„é›†åˆã€‚å®ƒä¹Ÿè®°å½•ä¸‹pageçš„è¯»ä¸å†™æ“ä½œï¼Œå¦å¤–pageä¸Šå‰©ä¸‹çš„å­˜å‚¨ç©ºé—´å¤§å°ä¹Ÿä¼šè¢«è®°å½•ä¸‹æ¥ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec03/30.jpg" alt="30.jpg"></p>
<h3 id="Database-Pages"><a href="#Database-Pages" class="headerlink" title="Database Pages"></a>Database Pages</h3><blockquote>
<p>Self-contained:= all the information needed to read each page is on the page itself.</p>
</blockquote>
<p>ä¸Šé¢è¿™å¥è¯æ¥è‡ªäº<span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDMtc3RvcmFnZTEucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/03-storage1.pdf">Note<i class="fa fa-external-link"></i></span></p>
<ul>
<li>Self-containedæŒ‡è¿™ä¸ªpageæ‹¥æœ‰metadata(å…ƒæ•°æ®)ï¼Œè¿™ä¸ªmetadataç”¨æ¥å‘Šè¯‰æˆ‘ä»¬å¦‚ä½•interpretè¯¥pageã€‚</li>
<li>æ¯ä¸€ä¸ªpageæœ‰ä¸€ä¸ªå”¯ä¸€çš„page id:<ul>
<li>å¦‚æœæ•°æ®åº“åªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨è¿™ç§ç®€å•çš„æƒ…å†µä¸‹ï¼Œpage idå¯ä»¥æ˜¯å¯¹åº”æ•°æ®åœ¨è¯¥æ–‡ä»¶çš„offset</li>
<li>å¤§å¤šæ•°æƒ…å†µï¼Œæ•°æ®åº“æœ‰å¤šä¸ªæ–‡ä»¶ã€‚è¿™æ˜¯page idå¯ä»¥æ˜¯å¯¹åº”æ•°æ®æ‰€åœ¨çš„<strong>é‚£ä¸€ä¸ª</strong>æ–‡ä»¶çš„è·¯å¾„ï¼‹åœ¨è¯¥æ–‡ä»¶ä¸­çš„offset</li>
<li>å› æ­¤æ¯ä¸€ä¸ªpage idå¯ä»¥å¯¹åº”ä¸ŠæŸäº›æ•°æ®ï¼Œè¿™äº›æ•°æ®çš„å¤§å°æ˜¯ä¸€ä¸ªpageçš„å¤§å°</li>
<li>åœ¨æ•°æ®åº“çš„é«˜å±‚ç»„æˆæˆåˆ†ä¸­(æ¯”å¦‚ execution engine)ï¼Œéƒ½éœ€è¦å°†å¯¹åº”çš„page idå½“åšå‚æ•°ï¼Œä»buffer pool managerä¸­è·å¾—å¯¹åº”çš„page(å’Œæ•°æ®)ã€‚</li>
</ul>
</li>
<li>å¦å¤–åœ¨å­¦æœ¯ä¸­pageä¹Ÿå¯ä»¥æ˜¯å˜é•¿çš„(variable sized): è§ <span class="exturl" data-url="aHR0cDovL2NpZHJkYi5vcmcvY2lkcjIwMjAvcGFwZXJzL3AyOS1uZXVtYW5uLWNpZHIyMC5wZGY=" title="http://cidrdb.org/cidr2020/papers/p29-neumann-cidr20.pdf">Umbra: A Disk-Based System with In-Memory Performance<i class="fa fa-external-link"></i></span></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec03/31.jpg" alt="31.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/32.jpg" alt="32.jpg"></p>
<h3 id="Database-Heap"><a href="#Database-Heap" class="headerlink" title="Database Heap"></a>Database Heap</h3><p><img data-src="/images/CMU1544564/Lec03/33.jpg" alt="33.jpg"></p>
<p>ä¸Šå›¾è¯´ï¼Œæˆ‘ä»¬æœ‰å¤šç§é€”å¾„å»å¯¹ç¡¬ç›˜ä¸Šçš„pageä½ç½®è¿›è¡Œç®¡ç†ï¼Œheap fileæ˜¯å…¶ä¸­çš„ä¸€ç§é€”å¾„ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹heap fileã€‚<strong>heap fileå°±æ˜¯ç”¨æ¥æ”¾pageçš„æ–‡ä»¶ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡æ–‡ä»¶å+offsetï¼Œè®¿é—®æŸä¸ªç‰¹å®šçš„pageã€‚</strong><sup><a href="#fn1">1</a></sup>  heap fileä¹Ÿæœ‰ä¸¤ç§å®ç°æ–¹å¼: linked list, page directoryã€‚</p>
<blockquote>
<p>A <strong>heap file</strong> is an unordered collection of pages where tuples that are stored in random order.</p>
</blockquote>
<p><img data-src="/images/CMU1544564/Lec03/34.jpg" alt="34.jpg"></p>
<h4 id="Linked-List"><a href="#Linked-List" class="headerlink" title="Linked List"></a>Linked List</h4><p>Header pageæœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼š</p>
<ul>
<li><code>free page list</code> æŒ‡å‘ä¸€ä¸ªfree pageçš„list</li>
<li><code>data page list</code> æŒ‡å‘ä¸€ä¸ªnot free pageçš„list</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬æƒ³å¯»æ‰¾æŸä¸€ä¸ªç‰¹å®šçš„page (æˆ–è€…ä¸€ä¸ªç‰¹å®šçš„page id), æˆ‘ä»¬åªèƒ½ä½æ•ˆåœ°sequential scanã€‚æ€»ä½“ä¸Šlinked listä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec03/36.jpg" alt="36.jpg"></p>
<h4 id="Page-Directory"><a href="#Page-Directory" class="headerlink" title="Page Directory"></a>Page Directory</h4><p>page directory:= special pages that tracks <strong>the location and the amount of free space</strong> of data pages in the database files.</p>
<p>page directoryæ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„æ–¹å¼ï¼Œã€€å®ƒæä¾›äº†ä¸€ç§æ˜ å°„ï¼š<code>page id -&gt; offset in file</code>, è¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡page idæ‰¾åˆ°å¯¹åº”çš„æ•°æ®ã€‚</p>
<p>å¦å¤–æˆ‘ä»¬éœ€è¦åŒæ­¥(sync)page directoryä¸Šçš„ä¿¡æ¯å’Œå®é™…ä¸Šçš„pageä¿¡æ¯ã€‚è¿™éœ€è¦æˆ‘ä»¬åœ¨æ¯æ¬¡æ›´æ”¹pageçš„æ—¶å€™ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦æ›´æ”¹page directoryä¸Šçš„ä¿¡æ¯ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec03/37.jpg" alt="37.jpg"></p>
<p><br><br><br></p>
<h2 id="Page-Layout"><a href="#Page-Layout" class="headerlink" title="Page Layout"></a>Page Layout</h2><p><img data-src="/images/CMU1544564/Lec03/38.jpg" alt="38.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/39.jpg" alt="39.jpg"></p>
<h3 id="Tuple-oriented"><a href="#Tuple-oriented" class="headerlink" title="Tuple-oriented"></a>Tuple-oriented</h3><h4 id="Strawman-idea"><a href="#Strawman-idea" class="headerlink" title="Strawman idea"></a>Strawman idea</h4><p>Strawman ideaåªæ˜¯ä¸€ä¸ª<strong>åé¢æ•™æï¼Œå¹¶ä¸æ˜¯ä¸€ç§å¥½çš„å®ç°</strong>ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec03/41.jpg" alt="41.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/42.jpg" alt="42.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/43.jpg" alt="43.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/44.jpg" alt="44.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/45.jpg" alt="45.jpg"></p>
<p>è¿™ä¸ªä½œæ³•çš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>åˆ é™¤tupleæ—¶ï¼Œä¼šå‡ºç°external fragmentation</li>
<li>æ— æ³•å­˜å‚¨é•¿åº¦å˜é•¿çš„tupleï¼Œæ¯”å¦‚<code>VARCHAR</code>å­—ç¬¦ä¸²</li>
</ul>
<p><br></p>
<h4 id="Slotted-Pages"><a href="#Slotted-Pages" class="headerlink" title="Slotted Pages"></a>Slotted Pages</h4><p><img data-src="/images/CMU1544564/Lec03/47.jpg" alt="47.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/48.jpg" alt="48.jpg"></p>
<p>å¯¹äºslotted pagesï¼Œå¦‚æœæˆ‘ä»¬åˆ é™¤tuple3ä¸æ›´æ”¹headerå,ã€€æˆ‘ä»¬å¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©ï¼š</p>
<ul>
<li>å°†åŸtuple3çš„ä½ç½®ç•™ç©ºï¼Œä¸æ”¹å˜å…¶ä»–tupleçš„ä½ç½®</li>
<li>æˆ–</li>
<li>å°†tuple4å‘å³ç§»åŠ¨ï¼Œå æœ‰åŸtuple3çš„ç©ºé—´ï¼Œä¹Ÿè°ƒæ•´tuple4çš„æŒ‡é’ˆå’Œheader (å½“ç„¶åœ¨æ™®éæƒ…å†µä¸‹ï¼Œéœ€è¦è°ƒæ•´<strong>æ‰€æœ‰</strong>tupleï¼“ä¹‹åçš„tuple)</li>
</ul>
<p>æˆ‘ä»¬å°†ä¸Šé¢ç¬¬äºŒç§é€‰æ‹©æˆä¸ºcompactionï¼Œå®ƒéœ€è¦åœ¨ä»€ä¹ˆæ—¶é—´å‘ç”Ÿï¼Œæœ‰å¦‚ä¸‹å‡ ç§å¯èƒ½ï¼š</p>
<ul>
<li>æ¯ä¸€æ¬¡deleteä»¥å</li>
<li>ç´¯åŠ ä¸€å®šé‡çš„deleteå</li>
<li>æ¯ä¸€æ¬¡insertä¹‹å‰</li>
<li>åœ¨ä¸€æ¬¡ç‰¹å®šinsertçš„æ—¶å€™ï¼Œå‘ç°æ²¡æœ‰<strong>è¶³å¤Ÿç©ºé—´(å³slot arrayå’Œtuple dataé‡åˆ)</strong></li>
<li>â€¦</li>
</ul>
<p>ä¸Šè¿°çš„compactionæ—¶é—´ç‚¹å¯èƒ½æ€§è‡ªç„¶ä¼šå½±å“æ€§èƒ½ï¼Œè¿™äº›å¯èƒ½æ€§éƒ½æ˜¯å®ç°ç›¸å…³ï¼Œä¹Ÿè¿™è¯¥æ•°æ®åº“ä¸­insertå’Œdeleteçš„åˆ†å¸ƒå’Œæ¯”ä¾‹æœ‰å…³ã€‚</p>
<p>æœ‰å…³çš„ä¸€ä¸ªPostgreSQLä¸­çš„å®éªŒï¼šè§<a href="https://cakebytheoceanluo.github.io/2020/03/11/DBMS-PostgreSQL-PageLayout/">[DBMS][PostgreSQL] Page Layout é¡µé¢å¸ƒå±€</a></p>
<p><br></p>
<h4 id="Log-Structured-File-Organization"><a href="#Log-Structured-File-Organization" class="headerlink" title="Log-Structured File Organization"></a>Log-Structured File Organization</h4><p><img data-src="/images/CMU1544564/Lec03/49.jpg" alt="49.jpg"></p>
<ul>
<li>å¦‚ä¸Šå›¾ä¸­ï¼Œæ–°çš„æ“ä½œ(insert, delete, update)ç›´æ¥è¢«è®°å½•ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åœ¨ç»´æŠ¤è¿™ä¸ªlog file</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec03/50.jpg" alt="50.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/51.jpg" alt="51.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/52.jpg" alt="52.jpg"></p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>é€Ÿåº¦å¾ˆå¿«ï¼Œåªéœ€è¦å‘æ–‡ä»¶ä¸­å†™å…¥ä¸€è¡Œlogä¿¡æ¯</li>
<li>è‡ªå¸¦log, åœ¨recoveryå¾ˆå¤§å¸®åŠ©</li>
<li>é€‚åˆappend onlyçš„å­˜å‚¨å½¢å¼ã€€(å¤§éƒ¨åˆ†çš„åˆ†å¸ƒå¼å­˜å‚¨æ˜¯append only)</li>
</ul>
<p>ç¼ºç‚¹:</p>
<ul>
<li>æ•°æ®è¯»å†™è¾ƒæ…¢ï¼Œéœ€è¦ä¾é logç”Ÿæˆtuple (è¿™ä¸ªç”Ÿæˆè¿‡ç¨‹å«replay)</li>
<li>æ•°æ®åˆ†æ•£ï¼Œä¸”éš¾ä»¥ç¼“å­˜(data ends up spread out wide and hard to cache.)</li>
</ul>
<p><br><br><br></p>
<h2 id="Tuple-Layout"><a href="#Tuple-Layout" class="headerlink" title="Tuple Layout"></a>Tuple Layout</h2><p><img data-src="/images/CMU1544564/Lec03/54.jpg" alt="54.jpg"></p>
<h3 id="Tuple-Header"><a href="#Tuple-Header" class="headerlink" title="Tuple Header"></a>Tuple Header</h3><p><img data-src="/images/CMU1544564/Lec03/55.jpg" alt="55.jpg"></p>
<h3 id="Tuple-Data"><a href="#Tuple-Data" class="headerlink" title="Tuple Data"></a>Tuple Data</h3><p><img data-src="/images/CMU1544564/Lec03/56.jpg" alt="56.jpg"></p>
<h3 id="Record-ids-â€”-Unique-identifier"><a href="#Record-ids-â€”-Unique-identifier" class="headerlink" title="Record ids â€” Unique identifier"></a>Record ids â€” Unique identifier</h3><p>(è¿™ä¸€é¡µslideè¢«æˆ‘æå‰äº†)</p>
<p>Record idsç¼©å†™æˆRID, å¸¸è§çš„æŒ‡æ˜¯<code>page id + offset / slot</code>ï¼Œå³å’Œè¿™ä¸ªtupleå­˜å‚¨çš„ä½ç½®ç›¸å…³ã€‚æ—¢ç„¶å®ƒæ˜¯å”¯ä¸€çš„ï¼Œè€Œä¸”å¯ä»¥ç¡®å®šä¸€ä¸ªtupleï¼Œå› æ­¤RIDå¯ä»¥ä½œä¸ºindex(ç´¢å¼•)çš„keyã€‚</p>
<p><img data-src="/images/CMU1544564/Lec03/61.jpg" alt="61.jpg"></p>
<h3 id="Denormalized-Tuple-Data"><a href="#Denormalized-Tuple-Data" class="headerlink" title="Denormalized Tuple Data"></a>Denormalized Tuple Data</h3><p>è¿™éƒ¨åˆ†ä¹Ÿæ˜¯å®ç°ç›¸å…³ï¼Œä¹Ÿå’Œæ•°æ®åº“çš„Normal Form, Functional Dependencyæœ‰å…³ã€‚</p>
<p>Denormalizedï¼Œéƒ½çŸ¥é“å…³ç³»æ¨¡å‹æœ‰èŒƒå¼ï¼Œå†—ä½™æ•°æ®ä¸€å®šæ˜¯ä¼šæ‰“ç ´èŒƒå¼çš„ï¼Œæ‰€ä»¥æ˜¯<strong>de</strong>ã€‚<sup><a href="#fn1">1</a></sup></p>
<p><img data-src="/images/CMU1544564/Lec03/57.jpg" alt="57.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/58.jpg" alt="58.jpg"></p>
<ul>
<li>æ³¨æ„ä¸Šå›¾ä¸­<code>bar</code>çš„ä¸‰ä¸ª<code>c</code>å€¼ä¸ä¸€æ ·ï¼Œå³<code>c1</code>, <code>c2</code>, <code>c3</code></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec03/59.jpg" alt="59.jpg"></p>
<ul>
<li>æ³¨æ„ä¸Šå›¾ä¸­<code>bar</code>çš„ä¸‰ä¸ª<code>c</code>å€¼ä¸ä¸€æ ·ï¼Œå³<code>c1</code>, <code>c2</code>, <code>c3</code></li>
<li>å¦‚ä¸Šå›¾çš„prejoinä¹‹å:<ul>
<li>readä¼šæ›´å¿«ï¼Œå› ä¸ºä¸¤ä¸ªè¡¨æ ¼å·²ç»è¢«å­˜å‚¨åœ¨ä¸€ä¸ªpageä¸Š</li>
<li>updateä¼šå¤æ‚ä¸€äº›ï¼Œå› ä¸ºtupleæ‰€å ç©ºé—´æ›´å¤§ï¼Œè€Œä¸”åŸæ¥çš„fixed-sized tupleå˜æˆvariable-sized tupleï¼Œå¤„ç†èµ·æ¥æ›´éº»çƒ¦ã€‚</li>
</ul>
</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec03/60.jpg" alt="60.jpg"></p>
<h1 id="Conclusion-ç»“è®º"><a href="#Conclusion-ç»“è®º" class="headerlink" title="Conclusion ç»“è®º"></a>Conclusion ç»“è®º</h1><p><img data-src="/images/CMU1544564/Lec03/62.jpg" alt="62.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec03/63.jpg" alt="63.jpg"></p>
<p>å¼•ç”¨:</p>
<p><a name="fn1">1</a>: Database Storage - fxjwind: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9wLzEwODE4ODE0Lmh0bWw=" title="https://www.cnblogs.com/fxjwind/p/10818814.html">https://www.cnblogs.com/fxjwind/p/10818814.html<i class="fa fa-external-link"></i></span></p>
</be><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>Storage</category>
        <category>Disk Management</category>
      </categories>
      <tags>
        <tag>Slotted Page</tag>
      </tags>
  </entry>
  <entry>
    <title>[DBMS][PostgreSQL]Page Layout é¡µé¢å¸ƒå±€</title>
    <url>/2020/03/11/DBMS-PostgreSQL-PageLayout/</url>
    <content><![CDATA[<p>è¿™ç¯‡æ–‡ç« æœåŠ¡äº<a href="https://cakebytheoceanluo.github.io/2020/03/11/CMU-15445-Lec03/">[CMU-15445]Lec03</a></p>
<p>ç»å¤§éƒ¨åˆ†çš„å…³ç³»æ•°æ®åº“çš„page layouté‡‡ç”¨çš„éƒ½æ˜¯slotted page, å­¦æœ¯ä¸Šçš„åˆ›æ–°çš„ä¸»æ„ä¹Ÿå¾€å¾€åŸºäºå®ƒã€‚æˆ‘ä»¬ä»Šå¤©æ¥çœ‹ä¸€çœ‹PostgreSQLä¸­çš„page layoutï¼Œä»¥åŠå®ƒåœ¨<code>insert</code>, <code>delete</code>ç­‰æ“ä½œä¸‹çš„å…·ä½“è¡Œä¸ºã€‚</p>
<a id="more"></a>
<h1 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h1><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# drop table <span class="keyword">if</span> <span class="built_in">exists</span> r;</span><br><span class="line">DROP TABLE</span><br><span class="line">testdb=# create table r (id <span class="keyword">int</span> primary key , val varchar(<span class="number">6</span>));</span><br><span class="line">CREATE TABLE</span><br><span class="line">testdb=# insert into r values (101, 'aaa'), (102, 'bbb'), (103, 'ccc');</span><br><span class="line">INSERT <span class="number">0</span> <span class="number">3</span></span><br><span class="line">testdb=# select * from r;</span><br><span class="line"> id  | val </span><br><span class="line">-----+-----</span><br><span class="line"> <span class="number">101</span> | aaa</span><br><span class="line"> <span class="number">102</span> | bbb</span><br><span class="line"> <span class="number">103</span> | ccc</span><br><span class="line">(<span class="number">3</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<h1 id="ctid-â€”-PostgreSQLä¸­çš„RID"><a href="#ctid-â€”-PostgreSQLä¸­çš„RID" class="headerlink" title="ctid â€” PostgreSQLä¸­çš„RID"></a><code>ctid</code> â€” PostgreSQLä¸­çš„RID</h1><ul>
<li><code>ctid</code>å°±æ˜¯PostgreSQLä¸­çš„Record ID, æ˜¯ä¸€ä¸ªæ¥è‡ªpage idå’Œoffsetçš„pair</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select r.ctid, r.* from r;</span><br><span class="line"> ctid  | id  | val </span><br><span class="line">-------+-----+-----</span><br><span class="line"> (<span class="number">0</span>,<span class="number">1</span>) | <span class="number">101</span> | aaa</span><br><span class="line"> (<span class="number">0</span>,<span class="number">2</span>) | <span class="number">102</span> | bbb</span><br><span class="line"> (<span class="number">0</span>,<span class="number">3</span>) | <span class="number">103</span> | ccc</span><br><span class="line">(<span class="number">3</span> rows)</span><br><span class="line">testdb=# select r.ctid, r.* from r where ctid = '(0, 1)';</span><br><span class="line"> ctid  | id  | val </span><br><span class="line">-------+-----+-----</span><br><span class="line"> (<span class="number">0</span>,<span class="number">1</span>) | <span class="number">101</span> | aaa</span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°: </p>
<ul>
<li>page idå‡ä¸º0, è¯´æ˜æ‰€æœ‰çš„tupleéƒ½åœ¨åŒä¸€ä¸ªpageä¸Š</li>
<li><code>insert</code>é¡ºåºæ’å…¥tupleåˆ°pageä¸­ï¼Œå³ç¬¬ä¸€ä¸ªinsertçš„tupleåœ¨pageçš„ç¬¬ä¸€ä¸ªoffset</li>
</ul>
<h1 id="deleteåçš„è¡Œä¸º"><a href="#deleteåçš„è¡Œä¸º" class="headerlink" title="deleteåçš„è¡Œä¸º"></a><code>delete</code>åçš„è¡Œä¸º</h1><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# <span class="keyword">delete</span> from r where id = <span class="number">102</span>;</span><br><span class="line">DELETE <span class="number">1</span></span><br><span class="line">testdb=# select r.ctid, r.* from r;</span><br><span class="line"> ctid  | id  | val </span><br><span class="line">-------+-----+-----</span><br><span class="line"> (<span class="number">0</span>,<span class="number">1</span>) | <span class="number">101</span> | aaa</span><br><span class="line"> (<span class="number">0</span>,<span class="number">3</span>) | <span class="number">103</span> | ccc</span><br><span class="line">(<span class="number">2</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬å°†ä¸­é—´çš„<code>102</code>tupleåˆ é™¤:</p>
<ul>
<li>å¯ä»¥çœ‹åˆ°å¯¹åº”çš„page layouté™¤äº†äº†<code>102</code>tupleä»¥å¤–ï¼Œæ²¡æœ‰å…¶ä»–åŒºåˆ«</li>
<li>è¿™è¯´æ˜PostgreSQLæ²¡æœ‰åœ¨deleteåé©¬ä¸Šcompact page, åˆ é™¤çš„ä½ç½®ç©ºç€ï¼Œè€Œä¸æ˜¯å»ç§»åŠ¨å…¶ä»–çš„tupleå»å æœ‰ç©ºå‡ºæ¥çš„ä½ç½®ã€‚</li>
</ul>
<h1 id="deleteåçš„insertè¡Œä¸º"><a href="#deleteåçš„insertè¡Œä¸º" class="headerlink" title="deleteåçš„insertè¡Œä¸º"></a><code>delete</code>åçš„<code>insert</code>è¡Œä¸º</h1><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# insert into r values (104, 'xxx');</span><br><span class="line">INSERT <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# select r.ctid, r.* from r;</span><br><span class="line"> ctid  | id  | val </span><br><span class="line">-------+-----+-----</span><br><span class="line"> (<span class="number">0</span>,<span class="number">1</span>) | <span class="number">101</span> | aaa</span><br><span class="line"> (<span class="number">0</span>,<span class="number">3</span>) | <span class="number">103</span> | ccc</span><br><span class="line"> (<span class="number">0</span>,<span class="number">4</span>) | <span class="number">104</span> | xxx</span><br><span class="line">(<span class="number">3</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬åœ¨åˆ é™¤<code>102</code>åï¼Œæ’å…¥<code>104</code>:</p>
<ul>
<li>æˆ‘ä»¬çœ‹åˆ°<code>104</code>tupleçš„ä½ç½®çš„offset4, å³ä¹‹å‰æœ€åä¸€ä¸ªtupleä¹‹å</li>
<li>è¯´æ˜PostgreSQLåœ¨åˆ é™¤åçš„æ’å…¥ï¼Œä¸ä¼šé‡æ–°åˆ©ç”¨ç©ºå‡ºæ¥çš„ç©ºé—´ã€‚</li>
</ul>
<p><br></p>
<ul>
<li>æˆ‘ä»¬çœ‹åˆ°äº†ä¸Šé¢<code>deleteåçš„è¡Œä¸º</code>å’Œ<code>deleteåçš„insertè¡Œä¸º</code>, å¯ä»¥çŒœæµ‹ï¼ŒPostgreSQLä¸ºäº†æ€§èƒ½ï¼Œå¹¶æ²¡æœ‰è®©<code>delete</code>å’Œ<code>insert</code>å»å¹²é¢„page layout</li>
</ul>
<h1 id="vacuum-full-â€”-æ•´åˆç©ºé—´"><a href="#vacuum-full-â€”-æ•´åˆç©ºé—´" class="headerlink" title="vacuum full; â€” æ•´åˆç©ºé—´"></a><code>vacuum full;</code> â€” æ•´åˆç©ºé—´</h1><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# vacuum full;</span><br><span class="line">VACUUM</span><br><span class="line">testdb=# select r.ctid, r.* from r;</span><br><span class="line"> ctid  | id  | val </span><br><span class="line">-------+-----+-----</span><br><span class="line"> (<span class="number">0</span>,<span class="number">1</span>) | <span class="number">101</span> | aaa</span><br><span class="line"> (<span class="number">0</span>,<span class="number">2</span>) | <span class="number">103</span> | ccc</span><br><span class="line"> (<span class="number">0</span>,<span class="number">3</span>) | <span class="number">104</span> | xxx</span><br><span class="line">(<span class="number">3</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>vacuum full;</code> å¯ä»¥æ˜¾å¼(explicit)å»compact pageï¼Œä¹Ÿå°±æ˜¯å æœ‰ç©ºç€çš„ç©ºé—´</li>
<li>è¿™ä¸ªæŒ‡ä»¤ä¹‹åï¼Œåé¢çš„tupleå‘å‰ç§»åŠ¨, å æ®äº†åŸ<code>102</code>æœ‰çš„ç©ºé—´</li>
</ul>
<h1 id="SQL-Script"><a href="#SQL-Script" class="headerlink" title="SQL Script"></a>SQL Script</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> r;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> r (<span class="keyword">id</span> <span class="built_in">int</span> primary <span class="keyword">key</span> , val <span class="built_in">varchar</span>(<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> r <span class="keyword">values</span> (<span class="number">101</span>, <span class="string">'aaa'</span>), (<span class="number">102</span>, <span class="string">'bbb'</span>), (<span class="number">103</span>, <span class="string">'ccc'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> r;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ctid := a pair of page id and offset</span></span><br><span class="line"><span class="keyword">select</span> r.ctid, r.* <span class="keyword">from</span> r;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- tuple 102 delete, but the page is not compacted after deletion</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> r <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">102</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> r.ctid, r.* <span class="keyword">from</span> r;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> r <span class="keyword">values</span> (<span class="number">104</span>, <span class="string">'xxx'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- in PostgreSQL:</span></span><br><span class="line"><span class="comment">-- insert after after the last inserted offset</span></span><br><span class="line"><span class="comment">-- ignore the free space after the previous deletion</span></span><br><span class="line"><span class="keyword">select</span> r.ctid, r.* <span class="keyword">from</span> r;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- like GC (garbegac collection)</span></span><br><span class="line"><span class="comment">-- compact(reorganize) the pages</span></span><br><span class="line"><span class="comment">-- takes time</span></span><br><span class="line">vacuum full;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> r.ctid, r.* <span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>Storage</category>
        <category>DBMS</category>
        <category>Disk Management</category>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
        <tag>Slotted Page</tag>
      </tags>
  </entry>
  <entry>
    <title>[DBMS Books]æ•°æ®åº“ä¹¦ç±æ¨è</title>
    <url>/2020/03/10/books/</url>
    <content><![CDATA[<p>è¿™ç¯‡æ–‡ç« å›Šæ‹¬äº†æ•°æ®åº“é¢†åŸŸç»å…¸ä¹¦ç±ï¼Œå¹¶é™„ä¸Šå¿…è¦é“¾æ¥ï¼Œæ–¹ä¾¿æœç´¢ã€‚æ‰€æ¨èä¹¦ç±å›Šæ‹¬åŸºç¡€æ¦‚å¿µï¼Œå®ç°åŸç†ï¼Œæ•°æ®åº“ç†è®ºï¼Œåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œæ•°æ®åº“äº‹åŠ¡ã€‚</p>
<p>æœ¬æ–‡åŸºäºè¯¥æ–‡ç« ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">ä½œè€…ï¼šé’±å«å® åä¸œå¸ˆèŒƒå¤§å­¦ æ•°æ®ç§‘å­¦ä¸å·¥ç¨‹å­¦é™¢ æ•™æˆ/é™¢é•¿</span><br><span class="line">é“¾æ¥ï¼šhttps://www.zhihu.com/question/52498996/answer/142789892</span><br><span class="line">æ¥æºï¼šçŸ¥ä¹</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<p>0.å®Œæ•´æ•™æï¼š</p>
<ul>
<li><p>å…¨ä¹¦ï¼šHector Garcia-Molina, Jeffrey D. Ullman, Jennifer Widom: <strong>Database systems - the complete book</strong> (2. ed.). Pearson Education 2009, ISBN 978-0-13-187325-4, pp. I-XXVI, 1-1203</p>
<ul>
<li>å®˜ç½‘ï¼šã€€<span class="exturl" data-url="aHR0cDovL2luZm9sYWIuc3RhbmZvcmQuZWR1L351bGxtYW4vZHNjYi5odG1s" title="http://infolab.stanford.edu/~ullman/dscb.html">http://infolab.stanford.edu/~ullman/dscb.html<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8xMTM3MjYyLw==" title="https://book.douban.com/subject/1137262/">https://book.douban.com/subject/1137262/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
<li><p>å¥¶ç‰›ä¹¦ï¼šRaghu Ramakrishnan, Johannes Gehrke: <strong>Database management systems</strong> (3. ed.). McGraw-Hill 2003, ISBN 978-0-07-115110-8, pp. I-XXXII, 1-1065</p>
<ul>
<li>å®˜ç½‘: <span class="exturl" data-url="aHR0cDovL3BhZ2VzLmNzLndpc2MuZWR1L35kYmJvb2sv" title="http://pages.cs.wisc.edu/~dbbook/">http://pages.cs.wisc.edu/~dbbook/<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8xMTU1OTM0Lw==" title="https://book.douban.com/subject/1155934/">https://book.douban.com/subject/1155934/<i class="fa fa-external-link"></i></span></li>
<li>æ³¨: æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8xMTQ2MjMzLw==" title="https://book.douban.com/subject/1146233/">https://book.douban.com/subject/1146233/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
</ul>
<p>1.æ•°æ®åº“åŸºç¡€</p>
<ul>
<li><p>å¸†èˆ¹ä¹¦ï¼šAbraham Silberschatz, Henry F. Korth, S. Sudarshan: <strong>Database System Concepts</strong>, 6th Edition. McGraw-Hill Book Company 2010</p>
<ul>
<li>ç¬¬å…­ç‰ˆ: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI2L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db6/index.html">https://www.db-book.com/db6/index.html<i class="fa fa-external-link"></i></span></li>
<li>ç¬¬ä¸ƒç‰ˆ 2019: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGItYm9vay5jb20vZGI3L2luZGV4Lmh0bWw=" title="https://www.db-book.com/db7/index.html">https://www.db-book.com/db7/index.html<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8xMDU0ODM3OS8=" title="https://book.douban.com/subject/10548379/">https://book.douban.com/subject/10548379/<i class="fa fa-external-link"></i></span></li>
<li>æ³¨: é«˜ç­‰æ•™è‚²å‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yNjA0NTkzMS8=" title="https://book.douban.com/subject/26045931/">https://book.douban.com/subject/26045931/<i class="fa fa-external-link"></i></span></li>
<li>æ³¨: æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yMDQ4MDY5My8=" title="https://book.douban.com/subject/20480693/">https://book.douban.com/subject/20480693/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
<li><p>å…¨ä¹¦å‰ä¸€åŠï¼šHector Garcia-Molina, Jeffrey D. Ullman, Jennifer Widom: <strong>Database systems - the complete book</strong> (2. ed.). Pearson Education 2009, ISBN 978-0-13-187325-4, pp. I-XXVI, 1-1203</p>
<ul>
<li>å…¨ä¹¦å‰ä¸€åŠå¯¹åº”: Jeff Ullman, Jennifer Widom: <strong>A First Course in Database systems</strong><ul>
<li>å®˜ç½‘: <span class="exturl" data-url="aHR0cDovL2luZm9sYWIuc3RhbmZvcmQuZWR1L351bGxtYW4vZmNkYi5odG1s" title="http://infolab.stanford.edu/~ullman/fcdb.html">http://infolab.stanford.edu/~ullman/fcdb.html<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8zOTIzNTc1Lw==" title="https://book.douban.com/subject/3923575/">https://book.douban.com/subject/3923575/<i class="fa fa-external-link"></i></span></li>
<li>æ³¨: æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8zMTgyMTEwLw==" title="https://book.douban.com/subject/3182110/">https://book.douban.com/subject/3182110/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>2.å®ç°</p>
<ul>
<li><p>å¥¶ç‰›ä¹¦ï¼šRaghu Ramakrishnan, Johannes Gehrke: <strong>Database management systems</strong> (3. ed.). McGraw-Hill 2003, ISBN 978-0-07-115110-8, pp. I-XXXII, 1-1065</p>
</li>
<li><p>å…¨ä¹¦åä¸€åŠï¼šHector Garcia-Molina, Jeffrey D. Ullman, Jennifer Widom: <strong>Database systems - the complete book</strong> (2. ed.). Pearson Education 2009, ISBN 978-0-13-187325-4, pp. I-XXVI, 1-1203</p>
<ul>
<li>å…¨ä¹¦åä¸€åŠå¯¹åº”: Hector Garcia-Molina, Jeff Ullman, Jennifer Widom: <strong>Database System Implementation</strong><ul>
<li>: å®˜ç½‘: <span class="exturl" data-url="aHR0cDovL2luZm9sYWIuc3RhbmZvcmQuZWR1L351bGxtYW4vZGJzaS5odG1s" title="http://infolab.stanford.edu/~ullman/dbsi.html">http://infolab.stanford.edu/~ullman/dbsi.html<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC80ODM4NDMwLw==" title="https://book.douban.com/subject/4838430/">https://book.douban.com/subject/4838430/<i class="fa fa-external-link"></i></span></li>
<li>æ³¨: æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC80MTY2NTQ2Lw==" title="https://book.douban.com/subject/4166546/">https://book.douban.com/subject/4166546/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
</ul>
</li>
<li><p>M. Tamer Ã–zsu, Patrick Valduriez: <strong>Principles of Distributed Database Systems</strong>, Third Edition. Springer 2011, ISBN 978-1-4419-8833-1, pp. I-XIX, 1-845</p>
<ul>
<li>Spingerå‡ºç‰ˆç¤¾-ä¹¦ç›®ç½‘ç«™: <span class="exturl" data-url="aHR0cHM6Ly93d3cuc3ByaW5nZXIuY29tL3VzL2Jvb2svOTc4MTQ5Mzk0MTc0Mmh0dHBzOi8vYm9vay5kb3ViYW4uY29tL3N1YmplY3QvMjY4NTE2MDUv" title="https://www.springer.com/us/book/9781493941742https://book.douban.com/subject/26851605/">https://www.springer.com/us/book/9781493941742https://book.douban.com/subject/26851605/<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yNjg1MTYwNS8=" title="https://book.douban.com/subject/26851605/">https://book.douban.com/subject/26851605/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
</ul>
<p>3.ç†è®º</p>
<ul>
<li><p>æ£’çƒä¹¦ï¼šJ.D. Ullman: <strong>Principles of Database and Knowledge-base Systems</strong>, Vol. I/II. 1988/1989</p>
<ul>
<li>ACM-ä¹¦ç›®é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS9ib29rLzEwLjU1NTUvNDI3OTA=" title="https://dl.acm.org/doi/book/10.5555/42790">https://dl.acm.org/doi/book/10.5555/42790<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
<li><p>çˆ±ä¸½ä¸ä¹¦ï¼šSerge Abiteboul, Richard Hull, Victor Vianu: <strong>Foundations of Databases</strong>. Addison-Wesley 1995, ISBN 0-201-53771-0</p>
<ul>
<li>å®˜ç½‘ï¼š<span class="exturl" data-url="aHR0cDovL3dlYmRhbS5pbnJpYS5mci9BbGljZS8=" title="http://webdam.inria.fr/Alice/">http://webdam.inria.fr/Alice/<i class="fa fa-external-link"></i></span></li>
<li>ä¸å®˜ç½‘å³å¯ä¸‹è½½ç”µå­ç‰ˆ</li>
</ul>
</li>
</ul>
<p>4.äº‹åŠ¡</p>
<ul>
<li><p>åŸºç¡€ï¼šPhilip A. Bernstein, Eric Newcomer: <strong>Principles of Transaction Processing for Systems Professionals</strong> (2nd Edition). Morgan Kaufmann. 2009</p>
<ul>
<li>ACMï¼ä¹¦ç›®é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS9ib29rLzEwLjU1NTUvMTIwODkzMA==" title="https://dl.acm.org/doi/book/10.5555/1208930">https://dl.acm.org/doi/book/10.5555/1208930<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC81NDEyODM1Lw==" title="https://book.douban.com/subject/5412835/">https://book.douban.com/subject/5412835/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
<li><p>ç†è®ºï¼šGerhard Weikum, Gottfried Vossen: <strong>Transactional Information Systems: Theory, Algorithms, and the Practice of Concurrency Control and Recovery</strong>. Morgan Kaufmann 2002, ISBN 1-55860-508-8</p>
<ul>
<li>ACM-ä¹¦ç›®é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS9ib29rLzEwLjU1NTUvMjgyMTU3Mg==" title="https://dl.acm.org/doi/book/10.5555/2821572">https://dl.acm.org/doi/book/10.5555/2821572<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8xNTAzODEyLw==" title="https://book.douban.com/subject/1503812/">https://book.douban.com/subject/1503812/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
<li><p>å®ç°ï¼šJim Gray, Andreas Reuter: <strong>Transaction Processing: Concepts and Techniques</strong>. Morgan Kaufmann 1993, ISBN 1-55860-190-2</p>
<ul>
<li>ACM-ä¹¦ç›®é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS9ib29rLzEwLjU1NTUvNTczMzA0" title="https://dl.acm.org/doi/book/10.5555/573304">https://dl.acm.org/doi/book/10.5555/573304<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘ç‰ˆè±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8xMTQ0NTQzLw==" title="https://book.douban.com/subject/1144543/">https://book.douban.com/subject/1144543/<i class="fa fa-external-link"></i></span></li>
<li>æ³¨: äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾æœ‰å‡ºç‰ˆè‹±æ–‡å½±å°ç‰ˆ, è±†ç“£é“¾æ¥: <span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8zNjUxMDE1Lw==" title="https://book.douban.com/subject/3651015/">https://book.douban.com/subject/3651015/<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
</ul>
<p>5.è¿›é˜¶</p>
<ul>
<li><p>çº¢å®ä¹¦ï¼šPeter Bailis, Joseph M. Hellerstein, Michael Stonebraker, editors. <strong>Readings in Database Systems</strong>, 5th Edition (Readings in Database Systems, 5th Edition)</p>
<ul>
<li>å®˜ç½‘ï¼š<span class="exturl" data-url="aHR0cDovL3d3dy5yZWRib29rLmlvLw==" title="http://www.redbook.io/">http://www.redbook.io/<i class="fa fa-external-link"></i></span></li>
<li>ä¸å®˜ç½‘å³å¯ä¸‹è½½ç”µå­ç‰ˆ</li>
</ul>
</li>
<li><p>Joseph M. Hellerstein, Michael Stonebraker, James Hamilton. Architecture of a Database System</p>
<ul>
<li>ç”µå­ç‰ˆ: <span class="exturl" data-url="aHR0cHM6Ly9kc2YuYmVya2VsZXkuZWR1L3BhcGVycy9mbnRkYjA3LWFyY2hpdGVjdHVyZS5wZGY=" title="https://dsf.berkeley.edu/papers/fntdb07-architecture.pdf">https://dsf.berkeley.edu/papers/fntdb07-architecture.pdf<i class="fa fa-external-link"></i></span></li>
<li>ä¸­æ–‡ç¿»è¯‘(å¦é—¨å¤§å­¦æ•°æ®åº“å®éªŒå®¤ æ—å­é›¨): <span class="exturl" data-url="aHR0cDovL2RibGFiLnhtdS5lZHUuY24vd3AtY29udGVudC91cGxvYWRzL29sZC9maWxlcy9saW56aXl1LUFyY2hpdGVjdHVyZSUyMG9mJTIwYSUyMERhdGFiYXNlJTIwU3lzdGVtKENoaW5lc2UlMjBWZXJzaW9uKS1BTEwucGRm" title="http://dblab.xmu.edu.cn/wp-content/uploads/old/files/linziyu-Architecture%20of%20a%20Database%20System(Chinese%20Version)-ALL.pdf">http://dblab.xmu.edu.cn/wp-content/uploads/old/files/linziyu-Architecture%20of%20a%20Database%20System(Chinese%20Version)-ALL.pdf<i class="fa fa-external-link"></i></span></li>
</ul>
</li>
</ul>
<p><br></p>
<p>æ¨èé˜…è¯»ï¼š</p>
<p>hzbooksï¼å§šç¼–è¾‘: <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h6Ym9va3MvYXJ0aWNsZS9kZXRhaWxzLzIxMDU0MjA=" title="https://blog.csdn.net/hzbooks/article/details/2105420">https://blog.csdn.net/hzbooks/article/details/2105420<i class="fa fa-external-link"></i></span></p>
<p>æ•°æ®åº“æœ‰æ²¡æœ‰ç±»ä¼¼ç°ä»£æ“ä½œç³»ç»Ÿçš„å¥½ä¹¦ï¼Ÿ - <span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzUyNDk4OTk2" title="https://www.zhihu.com/question/52498996">https://www.zhihu.com/question/52498996<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>DBMS</category>
      </categories>
      <tags>
        <tag>Books</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 185.department.top.three.salaries</title>
    <url>/2020/03/10/SQL-Leetcode-185-department-top-three-salaries/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>185.Department Top Three Salaries</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>), Salary <span class="built_in">int</span>, DepartmentId <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Department (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Employee</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Joe'</span>, <span class="string">'85000'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Henry'</span>, <span class="string">'80000'</span>, <span class="string">'2'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Sam'</span>, <span class="string">'60000'</span>, <span class="string">'2'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Max'</span>, <span class="string">'90000'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'Janet'</span>, <span class="string">'69000'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'Randy'</span>, <span class="string">'85000'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'7'</span>, <span class="string">'Will'</span>, <span class="string">'70000'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Department</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'IT'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Sales'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Employee;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Department;</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>), Salary <span class="built_in">int</span>, DepartmentId <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> Department (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Joe'</span>, <span class="string">'85000'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Henry'</span>, <span class="string">'80000'</span>, <span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Sam'</span>, <span class="string">'60000'</span>, <span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Max'</span>, <span class="string">'90000'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'Janet'</span>, <span class="string">'69000'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'Randy'</span>, <span class="string">'85000'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'7'</span>, <span class="string">'Will'</span>, <span class="string">'70000'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'IT'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Sales'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>Employee</code> table holds all employees. Every employee has an Id, a salary, and there is also a column for the department Id.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+-------+--------+--------------+</span></span><br><span class="line">| Id | Name  | Salary | DepartmentId |</span><br><span class="line">+<span class="comment">----+-------+--------+--------------+</span></span><br><span class="line">| 1  | Joe   | 85000  | 1            |</span><br><span class="line">| 2  | Henry | 80000  | 2            |</span><br><span class="line">| 3  | Sam   | 60000  | 2            |</span><br><span class="line">| 4  | Max   | 90000  | 1            |</span><br><span class="line">| 5  | Janet | 69000  | 1            |</span><br><span class="line">| 6  | Randy | 85000  | 1            |</span><br><span class="line">| 7  | Will  | 70000  | 1            |</span><br><span class="line">+<span class="comment">----+-------+--------+--------------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>The <code>Department</code> table holds all departments of the company.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| Id | Name     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| 1  | IT       |</span><br><span class="line">| 2  | Sales    |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query to find employees who earn the top three salaries in each of the department. For the above tables, your SQL query should return the following rows (order of rows does not matter).</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">------------+----------+--------+</span></span><br><span class="line">| Department | Employee | Salary |</span><br><span class="line">+<span class="comment">------------+----------+--------+</span></span><br><span class="line">| IT         | Max      | 90000  |</span><br><span class="line">| IT         | Randy    | 85000  |</span><br><span class="line">| IT         | Joe      | 85000  |</span><br><span class="line">| IT         | Will     | 70000  |</span><br><span class="line">| Sales      | Henry    | 80000  |</span><br><span class="line">| Sales      | Sam      | 60000  |</span><br><span class="line">+<span class="comment">------------+----------+--------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Explanation:</p>
<p>In IT department, Max earns the highest salary, both Randy and Joe earn the second highest salary, and Will earns the third highest salary. There are only two employees in the Sales department, Henry earns the highest salary while Sam earns the second highest salary.</p>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><p>ç”¨Window Functionçš„è§£æ³•å’Œ<a href="https://cakebytheoceanluo.github.io/2020/03/10/SQL-Leetcode-184-department-highest-salary/">Leetcode 184</a>å‡ ä¹æ¯«æ— å·®åˆ«ã€‚</p>
<p><strong>é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> d.name <span class="keyword">as</span> Department, temp.name <span class="keyword">as</span> Employee, temp.salary <span class="keyword">as</span> Salary</span><br><span class="line"><span class="keyword">from</span> department d, (</span><br><span class="line">    <span class="keyword">select</span> e.departmentid <span class="keyword">as</span> did, </span><br><span class="line">    ã€€ã€€ã€€ã€€e.name, </span><br><span class="line">    ã€€ã€€ã€€ã€€e.salary, </span><br><span class="line">    ã€€ã€€ã€€ã€€<span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> departmentid <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">rank</span> </span><br><span class="line">    <span class="keyword">from</span> employee e) <span class="keyword">as</span> temp </span><br><span class="line"><span class="keyword">where</span> d.id = temp.did <span class="keyword">and</span> temp.rank &lt;= <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    d.Name <span class="keyword">AS</span> Department, e1.Name <span class="keyword">AS</span> Employee, e1.Salary</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    Employee e1 <span class="keyword">JOIN</span> Department d </span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">    e1.DepartmentId = d.Id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    <span class="number">3</span> &gt; (<span class="keyword">SELECT</span></span><br><span class="line">            <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> e2.Salary)</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            Employee e2</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            e2.Salary &gt; e1.Salary <span class="keyword">AND</span> e1.DepartmentId = e2.DepartmentId</span><br><span class="line">        )</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZGVwYXJ0bWVudC10b3AtdGhyZWUtc2FsYXJpZXMv" title="https://leetcode.com/problems/department-top-three-salaries/">https://leetcode.com/problems/department-top-three-salaries/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZGVwYXJ0bWVudC10b3AtdGhyZWUtc2FsYXJpZXMvc29sdXRpb24v" title="https://leetcode.com/problems/department-top-three-salaries/solution/">https://leetcode.com/problems/department-top-three-salaries/solution/<i class="fa fa-external-link"></i></span></p>
<p><a href="https://cakebytheoceanluo.github.io/2020/03/10/SQL-Leetcode-184-department-highest-salary/">https://cakebytheoceanluo.github.io/2020/03/10/SQL-Leetcode-184-department-highest-salary/</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 184.department.highest.salary</title>
    <url>/2020/03/10/SQL-Leetcode-184-department-highest-salary/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>184.Department Highest Salary</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>), Salary <span class="built_in">int</span>, DepartmentId <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Department (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Employee</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Joe'</span>, <span class="string">'70000'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Jim'</span>, <span class="string">'90000'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Henry'</span>, <span class="string">'80000'</span>, <span class="string">'2'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Sam'</span>, <span class="string">'60000'</span>, <span class="string">'2'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'Max'</span>, <span class="string">'90000'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Department</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'IT'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Sales'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Employee;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Department;</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>), Salary <span class="built_in">int</span>, DepartmentId <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> Department (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Joe'</span>, <span class="string">'70000'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Jim'</span>, <span class="string">'90000'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Henry'</span>, <span class="string">'80000'</span>, <span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Sam'</span>, <span class="string">'60000'</span>, <span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, DepartmentId) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'Max'</span>, <span class="string">'90000'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'IT'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Department (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Sales'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>Employee</code> table holds all employees. Every employee has an Id, a salary, and there is also a column for the department Id.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+-------+--------+--------------+</span></span><br><span class="line">| Id | Name  | Salary | DepartmentId |</span><br><span class="line">+<span class="comment">----+-------+--------+--------------+</span></span><br><span class="line">| 1  | Joe   | 70000  | 1            |</span><br><span class="line">| 2  | Jim   | 90000  | 1            |</span><br><span class="line">| 3  | Henry | 80000  | 2            |</span><br><span class="line">| 4  | Sam   | 60000  | 2            |</span><br><span class="line">| 5  | Max   | 90000  | 1            |</span><br><span class="line">+<span class="comment">----+-------+--------+--------------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>The <code>Department</code> table holds all departments of the company.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| Id | Name     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| 1  | IT       |</span><br><span class="line">| 2  | Sales    |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query to find employees who have the highest salary in each of the departments. For the above tables, your SQL query should return the following rows (order of rows does not matter).</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">------------+----------+--------+</span></span><br><span class="line">| Department | Employee | Salary |</span><br><span class="line">+<span class="comment">------------+----------+--------+</span></span><br><span class="line">| IT         | Max      | 90000  |</span><br><span class="line">| IT         | Jim      | 90000  |</span><br><span class="line">| Sales      | Henry    | 80000  |</span><br><span class="line">+<span class="comment">------------+----------+--------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Explanation:</p>
<p>Max and Jim both have the highest salary in the IT department and Henry has the highest salary in the Sales department.</p>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><p><strong>é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> d.name <span class="keyword">as</span> Department, temp.name <span class="keyword">as</span> Employee, temp.salary <span class="keyword">as</span> Salary</span><br><span class="line"><span class="keyword">from</span> department d, (</span><br><span class="line">    <span class="keyword">select</span> e.departmentid <span class="keyword">as</span> did, </span><br><span class="line">           e.name, </span><br><span class="line">           e.salary, </span><br><span class="line">           <span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> departmentid <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">rank</span> </span><br><span class="line">    <span class="keyword">from</span> employee e) <span class="keyword">as</span> temp </span><br><span class="line"><span class="keyword">where</span> d.id = temp.did <span class="keyword">and</span> temp.rank = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    Department.name <span class="keyword">AS</span> Department,</span><br><span class="line">    Employee.name <span class="keyword">AS</span> Employee,</span><br><span class="line">    Salary</span><br><span class="line"><span class="keyword">FROM</span> Employee <span class="keyword">JOIN</span> Department </span><br><span class="line"><span class="keyword">ON</span> Employee.DepartmentId = Department.Id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    (Employee.DepartmentId, Salary) <span class="keyword">IN</span></span><br><span class="line">    (   <span class="keyword">SELECT</span></span><br><span class="line">            DepartmentId, <span class="keyword">MAX</span>(Salary)</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            Employee</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> DepartmentId</span><br><span class="line">	)</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZGVwYXJ0bWVudC1oaWdoZXN0LXNhbGFyeS8=" title="https://leetcode.com/problems/department-highest-salary/">https://leetcode.com/problems/department-highest-salary/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZGVwYXJ0bWVudC1oaWdoZXN0LXNhbGFyeS9zb2x1dGlvbi8=" title="https://leetcode.com/problems/department-highest-salary/solution/">https://leetcode.com/problems/department-highest-salary/solution/<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 183.customers.who.never.order</title>
    <url>/2020/03/10/SQL-Leetcode-183-customers-who-never-order/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>183.Customers Who Never Order</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Customers (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>))</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Orders (<span class="keyword">Id</span> <span class="built_in">int</span>, CustomerId <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Customers</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customers (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Joe'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customers (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Henry'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customers (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Sam'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customers (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Max'</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Orders</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (<span class="keyword">Id</span>, CustomerId) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'3'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (<span class="keyword">Id</span>, CustomerId) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'1'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Customers;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Orders;</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> Customers (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> Orders (<span class="keyword">Id</span> <span class="built_in">int</span>, CustomerId <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customers (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Joe'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customers (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Henry'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customers (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Sam'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customers (<span class="keyword">Id</span>, <span class="keyword">Name</span>) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Max'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (<span class="keyword">Id</span>, CustomerId) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'3'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (<span class="keyword">Id</span>, CustomerId) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'1'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Suppose that a website contains two tables, the <code>Customers</code> table and the <code>Orders</code> table. Write a SQL query to find all customers who never order anything.</p>
<p>Table: <code>Customers</code>.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+-------+</span></span><br><span class="line">| Id | Name  |</span><br><span class="line">+<span class="comment">----+-------+</span></span><br><span class="line">| 1  | Joe   |</span><br><span class="line">| 2  | Henry |</span><br><span class="line">| 3  | Sam   |</span><br><span class="line">| 4  | Max   |</span><br><span class="line">+<span class="comment">----+-------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Table: <code>Orders</code>.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+------------+</span></span><br><span class="line">| Id | CustomerId |</span><br><span class="line">+<span class="comment">----+------------+</span></span><br><span class="line">| 1  | 3          |</span><br><span class="line">| 2  | 1          |</span><br><span class="line">+<span class="comment">----+------------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Using the above tables as example, return the following:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| Customers |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| Henry     |</span><br><span class="line">| Max       |</span><br><span class="line">+<span class="comment">-----------+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<p><br></p>
<p>è¿™é¢˜å¾ˆæ˜æ˜¾æ˜¯æŒ‡çš„æ˜¯å…³ç³»ä»£æ•°ä¸­çš„<code>anti join</code>ã€‚è¿™é‡Œè¦æä¸€ä¸‹ï¼šã€€</p>
<ul>
<li>å…³ç³»ä»£æ•°ä¸­çš„<code>semi join</code>å¯¹åº”SQLä¸­çš„<code>exists</code></li>
<li>å…³ç³»ä»£æ•°ä¸­çš„<code>anti join</code>å¯¹åº”SQLä¸­çš„<code>not exists</code></li>
<li>SQL Standardä¸­<strong>æ ¹æœ¬æ²¡æœ‰</strong><code>semi join</code>å’Œ<code>anti join</code>è¿™ä¸¤ä¸ªå…³é”®è¯ (æˆ‘æ”¹æœ¬ç§‘ç”Ÿå¿…ä¿®è¯¾å·çš„æ—¶å€™å‘ç°å¾ˆå¤šåŒå­¦æ²¡æœ‰æ„è¯†åˆ°è¿™ä¸€ç‚¹)</li>
</ul>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c.name <span class="keyword">as</span> Customers </span><br><span class="line"><span class="keyword">from</span> customers c </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> * </span><br><span class="line">    <span class="keyword">from</span> orders o </span><br><span class="line">    <span class="keyword">where</span> o.customerid = c.id</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c.name <span class="keyword">as</span> Customers </span><br><span class="line"><span class="keyword">from</span> customers c </span><br><span class="line"><span class="keyword">where</span> c.id <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> o.customerid</span><br><span class="line">    <span class="keyword">from</span> orders o </span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼“"><a href="#è§£æ³•ï¼“" class="headerlink" title="è§£æ³•ï¼“"></a>è§£æ³•ï¼“</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c.name <span class="keyword">as</span> Customers </span><br><span class="line"><span class="keyword">from</span> customers c <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> orders o </span><br><span class="line"><span class="keyword">on</span> o.customerid = c.id</span><br><span class="line"><span class="keyword">where</span> o.id <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> c.name <span class="keyword">as</span> Customers </span><br><span class="line"><span class="keyword">from</span> customers c <span class="keyword">left</span> <span class="keyword">join</span> orders o </span><br><span class="line"><span class="keyword">on</span> o.customerid = c.id</span><br><span class="line"><span class="keyword">where</span> o.id <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvY3VzdG9tZXJzLXdoby1uZXZlci1vcmRlci8=" title="https://leetcode.com/problems/customers-who-never-order/">https://leetcode.com/problems/customers-who-never-order/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvY3VzdG9tZXJzLXdoby1uZXZlci1vcmRlci9kaXNjdXNzLzUzNTc5L1RocmVlLWFjY2VwdGVkLXNvbHV0aW9ucw==" title="https://leetcode.com/problems/customers-who-never-order/discuss/53579/Three-accepted-solutions">https://leetcode.com/problems/customers-who-never-order/discuss/53579/Three-accepted-solutions<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUmVsYXRpb25hbF9hbGdlYnJhI0FudGlqb2luXyglRTIlOTYlQjc=" title="https://en.wikipedia.org/wiki/Relational_algebra#Antijoin_(%E2%96%B7">https://en.wikipedia.org/wiki/Relational_algebra#Antijoin_(%E2%96%B7<i class="fa fa-external-link"></i></span>)</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNDIyNDk2OTAvd2hhdC1pcy1zZW1pLWpvaW4taW4tZGF0YWJhc2U=" title="https://stackoverflow.com/questions/42249690/what-is-semi-join-in-database">https://stackoverflow.com/questions/42249690/what-is-semi-join-in-database<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 182.duplicate.emails</title>
    <url>/2020/03/10/SQL-Leetcode-182-duplicate-emails/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>182.Duplicate Emails</p>
<p>SQL Schema</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Person (<span class="keyword">Id</span> <span class="built_in">int</span>, Email <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Person</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'a@b.com'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'c@d.com'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'a@b.com'</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Person;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Person (<span class="keyword">Id</span> <span class="built_in">int</span>, Email <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'a@b.com'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'c@d.com'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (<span class="keyword">Id</span>, Email) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'a@b.com'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query to find all duplicate emails in a table named <code>Person</code>.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| Id | Email   |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| 1  | a@b.com |</span><br><span class="line">| 2  | c@d.com |</span><br><span class="line">| 3  | a@b.com |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>For example, your query should return the following for the above table:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------+</span></span><br><span class="line">| Email   |</span><br><span class="line">+<span class="comment">---------+</span></span><br><span class="line">| a@b.com |</span><br><span class="line">+<span class="comment">---------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Note: All emails are in lowercase.</p>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span>(email)</span><br><span class="line"><span class="keyword">from</span> person p</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">select</span> email, <span class="keyword">count</span>(<span class="keyword">id</span>) <span class="keyword">as</span> counter</span><br><span class="line">        <span class="keyword">from</span> person</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> email</span><br><span class="line">    ) <span class="keyword">as</span> temp</span><br><span class="line">    <span class="keyword">where</span> counter &gt; <span class="number">1</span> <span class="keyword">and</span> p.email = temp.email</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> Email <span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">  <span class="keyword">select</span> Email, <span class="keyword">count</span>(Email) <span class="keyword">as</span> <span class="keyword">num</span></span><br><span class="line">  <span class="keyword">from</span> Person</span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> Email</span><br><span class="line">) <span class="keyword">as</span> statistic</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">num</span> &gt; <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼“"><a href="#è§£æ³•ï¼“" class="headerlink" title="è§£æ³•ï¼“"></a>è§£æ³•ï¼“</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> Email</span><br><span class="line"><span class="keyword">from</span> Person</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> Email</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">count</span>(Email) &gt; <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZHVwbGljYXRlLWVtYWlscw==" title="https://leetcode.com/problems/duplicate-emails">https://leetcode.com/problems/duplicate-emails<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZHVwbGljYXRlLWVtYWlscy9zb2x1dGlvbi8=" title="https://leetcode.com/problems/duplicate-emails/solution/">https://leetcode.com/problems/duplicate-emails/solution/<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 181.employees.earning.more.than.their.managers</title>
    <url>/2020/03/10/SQL-Leetcode-181-employees-earning-more-than-their-managers/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>181.Employees Earning More Than Their Managers</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>), Salary <span class="built_in">int</span>, ManagerId <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Employee</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, ManagerId) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Joe'</span>, <span class="string">'70000'</span>, <span class="string">'3'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, ManagerId) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Henry'</span>, <span class="string">'80000'</span>, <span class="string">'4'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, ManagerId) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Sam'</span>, <span class="string">'60000'</span>, <span class="string">'None'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, ManagerId) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Max'</span>, <span class="string">'90000'</span>, <span class="string">'None'</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Employee;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Name</span> <span class="built_in">varchar</span>(<span class="number">255</span>), Salary <span class="built_in">int</span>, ManagerId <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, ManagerId) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Joe'</span>, <span class="string">'70000'</span>, <span class="string">'3'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, ManagerId) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'Henry'</span>, <span class="string">'80000'</span>, <span class="string">'4'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, ManagerId) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'Sam'</span>, <span class="string">'60000'</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, <span class="keyword">Name</span>, Salary, ManagerId) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'Max'</span>, <span class="string">'90000'</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>Employee</code> table holds all employees including their managers. Every employee has an Id, and there is also a column for the manager Id.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+-------+--------+-----------+</span></span><br><span class="line">| Id | Name  | Salary | ManagerId |</span><br><span class="line">+<span class="comment">----+-------+--------+-----------+</span></span><br><span class="line">| 1  | Joe   | 70000  | 3         |</span><br><span class="line">| 2  | Henry | 80000  | 4         |</span><br><span class="line">| 3  | Sam   | 60000  | NULL      |</span><br><span class="line">| 4  | Max   | 90000  | NULL      |</span><br><span class="line">+<span class="comment">----+-------+--------+-----------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>Given the <code>Employee</code> table, write a SQL query that finds out employees who earn more than their managers. For the above table, Joe is the only employee who earns more than his manager.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| Employee |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| Joe      |</span><br><span class="line">+<span class="comment">----------+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e.name <span class="keyword">as</span> Employee </span><br><span class="line"><span class="keyword">from</span> employee e </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> * </span><br><span class="line">    <span class="keyword">from</span> employee m </span><br><span class="line">    <span class="keyword">where</span> e.salary &gt; m.salary <span class="keyword">and</span> e.managerid = m.id</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e.name <span class="keyword">as</span> Employee </span><br><span class="line"><span class="keyword">from</span> employee e, employee m </span><br><span class="line"><span class="keyword">where</span> e.salary &gt; m.salary <span class="keyword">and</span> e.managerid = m.id;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvZW1wbG95ZWVzLWVhcm5pbmctbW9yZS10aGFuLXRoZWlyLW1hbmFnZXJzLw==" title="https://leetcode.com/problems/employees-earning-more-than-their-managers/">https://leetcode.com/problems/employees-earning-more-than-their-managers/<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 180.consecutive.numbers</title>
    <url>/2020/03/09/SQL-Leetcode-180-consecutive-numbers/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>180.Consecutive Numbers</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Num</span> <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="keyword">Logs</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'2'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'2'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'7'</span>, <span class="string">'2'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="keyword">Logs</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span> <span class="built_in">int</span>, <span class="keyword">Num</span> <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">Logs</span> (<span class="keyword">Id</span>, <span class="keyword">Num</span>) <span class="keyword">values</span> (<span class="string">'7'</span>, <span class="string">'2'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query to find all numbers that appear at least three times consecutively.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">| Id | Num |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">| 1  |  1  |</span><br><span class="line">| 2  |  1  |</span><br><span class="line">| 3  |  1  |</span><br><span class="line">| 4  |  2  |</span><br><span class="line">| 5  |  1  |</span><br><span class="line">| 6  |  2  |</span><br><span class="line">| 7  |  2  |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br></pre></td></tr></tbody></table></figure>
<p>For example, given the above <code>Logs</code> table, 1 is the only number that appears consecutively for at least three times.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">-----------------+</span></span><br><span class="line">| ConsecutiveNums |</span><br><span class="line">+<span class="comment">-----------------+</span></span><br><span class="line">| 1               |</span><br><span class="line">+<span class="comment">-----------------+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><p><strong>é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">num</span> <span class="keyword">as</span> ConsecutiveNums </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">num</span>, </span><br><span class="line">           lag(<span class="keyword">num</span>, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>) <span class="keyword">as</span> <span class="keyword">last</span>, </span><br><span class="line">           <span class="keyword">lead</span>(<span class="keyword">num</span>, <span class="number">1</span>, <span class="literal">NULL</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>) <span class="keyword">as</span> <span class="keyword">next</span> <span class="keyword">from</span> <span class="keyword">logs</span>) <span class="keyword">as</span> temp </span><br><span class="line"><span class="keyword">where</span> temp.num = temp.last <span class="keyword">and</span> temp.num = temp.next;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvY29uc2VjdXRpdmUtbnVtYmVycy8=" title="https://leetcode.com/problems/consecutive-numbers/">https://leetcode.com/problems/consecutive-numbers/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjYvZnVuY3Rpb25zLXdpbmRvdy5odG1s" title="https://www.postgresql.org/docs/9.6/functions-window.html">https://www.postgresql.org/docs/9.6/functions-window.html<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 178.rank.scores</title>
    <url>/2020/03/09/SQL-Leetcode-178-rank-scores/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>178.Rank Scores</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Scores (<span class="keyword">Id</span> <span class="built_in">int</span>, Score <span class="built_in">DECIMAL</span>(<span class="number">3</span>,<span class="number">2</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Scores</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'3.5'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'3.65'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'4.0'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'3.85'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'4.0'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'3.65'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Scores;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Scores (<span class="keyword">Id</span> <span class="built_in">int</span>, Score <span class="built_in">DECIMAL</span>(<span class="number">3</span>,<span class="number">2</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'3.5'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'3.65'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'4.0'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'4'</span>, <span class="string">'3.85'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'5'</span>, <span class="string">'4.0'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Scores (<span class="keyword">Id</span>, Score) <span class="keyword">values</span> (<span class="string">'6'</span>, <span class="string">'3.65'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query to rank scores. If there is a tie between two scores, both should have the same ranking. Note that after a tie, the next ranking number should be the next consecutive integer value. In other words, there should be no â€œholesâ€ between ranks.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+-------+</span></span><br><span class="line">| Id | Score |</span><br><span class="line">+<span class="comment">----+-------+</span></span><br><span class="line">| 1  | 3.50  |</span><br><span class="line">| 2  | 3.65  |</span><br><span class="line">| 3  | 4.00  |</span><br><span class="line">| 4  | 3.85  |</span><br><span class="line">| 5  | 4.00  |</span><br><span class="line">| 6  | 3.65  |</span><br><span class="line">+<span class="comment">----+-------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>For example, given the above <code>Scores</code> table, your query should generate the following report (order by highest score):</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">-------+------+</span></span><br><span class="line">| Score | Rank |</span><br><span class="line">+<span class="comment">-------+------+</span></span><br><span class="line">| 4.00  | 1    |</span><br><span class="line">| 4.00  | 1    |</span><br><span class="line">| 3.85  | 2    |</span><br><span class="line">| 3.65  | 3    |</span><br><span class="line">| 3.65  | 3    |</span><br><span class="line">| 3.50  | 4    |</span><br><span class="line">+<span class="comment">-------+------+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><p><strong>é€‚ç”¨äºPostgreSQL</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> score, <span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">Rank</span> <span class="keyword">from</span> scores;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> S.Score, <span class="keyword">COUNT</span>(S2.Score) <span class="keyword">AS</span> <span class="keyword">Rank</span> </span><br><span class="line"><span class="keyword">FROM</span> Scores S, (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> Score <span class="keyword">FROM</span> Scores) S2</span><br><span class="line"><span class="keyword">WHERE</span> S.Score &lt;= S2.Score</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> S.Id </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> S.Score <span class="keyword">DESC</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvcmFuay1zY29yZXMv" title="https://leetcode.com/problems/rank-scores/">https://leetcode.com/problems/rank-scores/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvcmFuay1zY29yZXMvZGlzY3Vzcy80NTY2MTAvTXlTUUwtVHdvLVNpbXBsZS1Tb2x1dGlvbnMtYW5kLUV4cGxhbmF0aW9ucy1mb3ItQmVnaW5uZXJz" title="https://leetcode.com/problems/rank-scores/discuss/456610/MySQL-Two-Simple-Solutions-and-Explanations-for-Beginners">https://leetcode.com/problems/rank-scores/discuss/456610/MySQL-Two-Simple-Solutions-and-Explanations-for-Beginners<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjYvZnVuY3Rpb25zLXdpbmRvdy5odG1s" title="https://www.postgresql.org/docs/9.6/functions-window.html">https://www.postgresql.org/docs/9.6/functions-window.html<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 177.nth.highest.salary</title>
    <url>/2020/03/09/SQL-Leetcode-177-nth-highest-salary/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>177.Nth Highest Salary</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, Salary <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Employee</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'100'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'200'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'300'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Employee;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, Salary <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'100'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'200'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'300'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query to get the n-th highest salary from the <code>Employee</code> table.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+--------+</span></span><br><span class="line">| Id | Salary |</span><br><span class="line">+<span class="comment">----+--------+</span></span><br><span class="line">| 1  | 100    |</span><br><span class="line">| 2  | 200    |</span><br><span class="line">| 3  | 300    |</span><br><span class="line">+<span class="comment">----+--------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>For example, given the above Employee table, the n-th highest salary where n = 2 is <code>200</code>. If there is no n-th highest salary, then the query should return <code>null</code>.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">------------------------+</span></span><br><span class="line">| getNthHighestSalary(2) |</span><br><span class="line">+<span class="comment">------------------------+</span></span><br><span class="line">| 200                    |</span><br><span class="line">+<span class="comment">------------------------+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> getNthHighestSalary(@N <span class="built_in">INT</span>) <span class="keyword">RETURNS</span> <span class="built_in">INT</span> <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> (</span><br><span class="line">        <span class="keyword">select</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> salary <span class="keyword">from</span> (<span class="keyword">select</span> *, <span class="keyword">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="keyword">rank</span> <span class="keyword">from</span> employee) <span class="keyword">as</span> temp <span class="keyword">where</span> temp.rank = @N)</span><br><span class="line">    );</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>distinct</code>æ˜¯ä¸ºäº†å°†å¹¶åˆ—çš„æ•°å€¼èšåˆä¸ºåŒä¸€ä¸ªæ•°å­—ã€‚</li>
</ul>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvbnRoLWhpZ2hlc3Qtc2FsYXJ5Lw==" title="https://leetcode.com/problems/nth-highest-salary/">https://leetcode.com/problems/nth-highest-salary/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy85LjYvZnVuY3Rpb25zLXdpbmRvdy5odG1s" title="https://www.postgresql.org/docs/9.6/functions-window.html">https://www.postgresql.org/docs/9.6/functions-window.html<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 176.second.highest.salary</title>
    <url>/2020/03/09/SQL-Leetcode-176-second-highest-salary/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>176.Second Highest Salary</p>
<p>SQL Schema:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="keyword">If</span> <span class="keyword">Not</span> <span class="keyword">Exists</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, Salary <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Employee</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'100'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'200'</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'300'</span>)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Employee;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Employee (<span class="keyword">Id</span> <span class="built_in">int</span>, Salary <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'100'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'2'</span>, <span class="string">'200'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Employee (<span class="keyword">Id</span>, Salary) <span class="keyword">values</span> (<span class="string">'3'</span>, <span class="string">'300'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query to get the second highest salary from the <code>Employee</code> table.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----+--------+</span></span><br><span class="line">| Id | Salary |</span><br><span class="line">+<span class="comment">----+--------+</span></span><br><span class="line">| 1  | 100    |</span><br><span class="line">| 2  | 200    |</span><br><span class="line">| 3  | 300    |</span><br><span class="line">+<span class="comment">----+--------+</span></span><br></pre></td></tr></tbody></table></figure>
<p>For example, given the above <code>Employee</code> table, the query should return <code>200</code> as the second highest salary. If there is no second highest salary, then the query should return <code>null</code>.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| SecondHighestSalary |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| 200                 |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> e.salary</span><br><span class="line">    <span class="keyword">from</span> Employee e</span><br><span class="line">    <span class="keyword">where</span> <span class="number">1</span> = (</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">count</span>(*) </span><br><span class="line">        <span class="keyword">from</span> Employee top </span><br><span class="line">        <span class="keyword">where</span> top.salary &gt; e.salary</span><br><span class="line">    )</span><br><span class="line">) <span class="keyword">as</span> SecondHighestSalary;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>distinct</code>æ˜¯ä¸ºäº†å°†å¹¶åˆ—çš„ç¬¬äºŒæ•°å€¼èšåˆä¸ºåŒä¸€ä¸ªæ•°å­—ã€‚</li>
<li><code>distinct</code>ä¹Ÿä½¿è¿™ä¸ªè§£æ³•çš„è¿è¡Œæ—¶é—´å˜æ…¢ã€‚</li>
</ul>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">max</span>(e2.salary) <span class="keyword">as</span> SecondHighestSalary </span><br><span class="line"><span class="keyword">from</span> employee e1 <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> employee e2 </span><br><span class="line"><span class="keyword">on</span> e1.salary &gt; e2.salary;</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœæˆ‘ä»¬çš„æ•°æ®é‡éå¸¸å¤§ï¼Œè¿™ä¸ªè§£æ³•çš„è¿è¡Œæ—¶é—´ä¹Ÿä¼šå¾ˆæ…¢ã€‚</p>
<p><br></p>
<h1 id="è§£æ³•ï¼“"><a href="#è§£æ³•ï¼“" class="headerlink" title="è§£æ³•ï¼“"></a>è§£æ³•ï¼“</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">            Salary</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            Employee</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> Salary <span class="keyword">DESC</span></span><br><span class="line">        <span class="keyword">LIMIT</span> <span class="number">1</span> <span class="keyword">OFFSET</span> <span class="number">1</span>) <span class="keyword">AS</span> SecondHighestSalary</span><br><span class="line">;</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªè§£æ³•çš„è¿è¡Œæ—¶é—´è¾ƒå¥½ï¼Œä½†æ˜¯<code>limit</code>æ²¡æœ‰è¢«ANSI SQL Standardæ”¶å½•ã€‚(ç”šè‡³åœ¨æˆ‘ä»¬å­¦æ ¡æœ¬ç§‘ç”Ÿæ•°æ®åº“è€ƒè¯•ä¸­ä¸ç®—åˆ†)ã€€<br><!-- TODO: LIMIT ANSI --></p>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTUyODYwNC9ob3ctdW5pdmVyc2FsLWlzLXRoZS1saW1pdC1zdGF0ZW1lbnQtaW4tc3Fs" title="https://stackoverflow.com/questions/1528604/how-universal-is-the-limit-statement-in-sql">https://stackoverflow.com/questions/1528604/how-universal-is-the-limit-statement-in-sql<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYmEuc3RhY2tleGNoYW5nZS5jb20vcXVlc3Rpb25zLzIxNDM2Ny93aGF0LWlzLXRoZS1zcWwtc3RhbmRhcmQtbWV0aG9kLW9mLWRvaW5nLWxpbWl0LW9mZnNldA==" title="https://dba.stackexchange.com/questions/214367/what-is-the-sql-standard-method-of-doing-limit-offset">https://dba.stackexchange.com/questions/214367/what-is-the-sql-standard-method-of-doing-limit-offset<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTk1MTIzL2lzLXRoZXJlLWFuLWFuc2ktc3FsLWFsdGVybmF0aXZlLXRvLXRoZS1teXNxbC1saW1pdC1rZXl3b3Jk" title="https://stackoverflow.com/questions/595123/is-there-an-ansi-sql-alternative-to-the-mysql-limit-keyword">https://stackoverflow.com/questions/595123/is-there-an-ansi-sql-alternative-to-the-mysql-limit-keyword<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-SQL] 175.combine.two.tables</title>
    <url>/2020/03/09/SQL-Leetcode-175-combine-two-tables/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>175.Combine Two Tables</p>
<p>SQL Schema</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> Person (PersonId <span class="built_in">int</span>, FirstName <span class="built_in">varchar</span>(<span class="number">255</span>), LastName <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> Address (AddressId <span class="built_in">int</span>, PersonId <span class="built_in">int</span>, City <span class="built_in">varchar</span>(<span class="number">255</span>), State <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Person;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (PersonId, LastName, FirstName) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Wang'</span>, <span class="string">'Allen'</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Address;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Address (AddressId, PersonId, City, State) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'New York City'</span>, <span class="string">'New York'</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> Pelson;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Person (PersonId <span class="built_in">int</span>, FirstName <span class="built_in">varchar</span>(<span class="number">255</span>), LastName <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Address (AddressId <span class="built_in">int</span>, PersonId <span class="built_in">int</span>, City <span class="built_in">varchar</span>(<span class="number">255</span>), State <span class="built_in">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Person (PersonId, LastName, FirstName) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'Wang'</span>, <span class="string">'Allen'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Address (AddressId, PersonId, City, State) <span class="keyword">values</span> (<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'New York City'</span>, <span class="string">'New York'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Table: <code>Person</code></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">-------------+---------+</span></span><br><span class="line">| Column Name | Type    |</span><br><span class="line">+<span class="comment">-------------+---------+</span></span><br><span class="line">| PersonId    | int     |</span><br><span class="line">| FirstName   | varchar |</span><br><span class="line">| LastName    | varchar |</span><br><span class="line">+<span class="comment">-------------+---------+</span></span><br><span class="line">PersonId is the primary key column for this table.</span><br></pre></td></tr></tbody></table></figure>
<p>Table: <code>Address</code></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">-------------+---------+</span></span><br><span class="line">| Column Name | Type    |</span><br><span class="line">+<span class="comment">-------------+---------+</span></span><br><span class="line">| AddressId   | int     |</span><br><span class="line">| PersonId    | int     |</span><br><span class="line">| City        | varchar |</span><br><span class="line">| State       | varchar |</span><br><span class="line">+<span class="comment">-------------+---------+</span></span><br><span class="line">AddressId is the primary key column for this table.</span><br></pre></td></tr></tbody></table></figure>
<p>Write a SQL query for a report that provides the following information for each person in the <code>Person</code> table, regardless if there is an address for each of those people:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">FirstName, LastName, City, State</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="è§£æ³•"><a href="#è§£æ³•" class="headerlink" title="è§£æ³•"></a>è§£æ³•</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> p.firstname, p.lastname, a.city, a.state </span><br><span class="line"><span class="keyword">from</span> person p <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> address a </span><br><span class="line"><span class="keyword">on</span> p.personid = a.personid;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> p.firstname, p.lastname, a.city, a.state </span><br><span class="line"><span class="keyword">from</span> person p <span class="keyword">left</span> <span class="keyword">join</span> address a </span><br><span class="line"><span class="keyword">on</span> p.personid = a.personid;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvY29tYmluZS10d28tdGFibGVzLw==" title="https://leetcode.com/problems/combine-two-tables/">https://leetcode.com/problems/combine-two-tables/<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
        <category>Leetcode</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]HomeWork1_17Fall</title>
    <url>/2020/03/08/CMU-15445-HomeWork1-17Fall/</url>
    <content><![CDATA[<p>2017 Fall: HOMEWORK #1 - SQL</p>
<p>Homework: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTcvaG9tZXdvcmsxLw==" title="https://15445.courses.cs.cmu.edu/fall2017/homework1/">https://15445.courses.cs.cmu.edu/fall2017/homework1/<i class="fa fa-external-link"></i></span><br>Solution: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTcvZmlsZXMvaHcxLXNvbHMudGFyLmd6" title="https://15445.courses.cs.cmu.edu/fall2017/files/hw1-sols.tar.gz">https://15445.courses.cs.cmu.edu/fall2017/files/hw1-sols.tar.gz<i class="fa fa-external-link"></i></span></p>
<a id="more"></a>
<p>CMUæ¨èä½¿ç”¨ SQLite: <span class="exturl" data-url="aHR0cHM6Ly93d3cuc3FsaXRlLm9yZy9pbmRleC5odG1s" title="https://www.sqlite.org/index.html">https://www.sqlite.org/index.html<i class="fa fa-external-link"></i></span></p>
<p>å·²æ£€æŸ¥è¿‡æˆ‘çš„è§£æ³•å’Œç­”æ¡ˆç”Ÿæˆçš„ç»“æœä¸€æ ·ã€‚</p>
<!-- TODO: link æ–‡ç«  SQLITE å®‰è£… å’ŒSQLITEæ•°æ®é›† -->
<h1 id="ç†Ÿæ‚‰æ•°æ®é›†"><a href="#ç†Ÿæ‚‰æ•°æ®é›†" class="headerlink" title="ç†Ÿæ‚‰æ•°æ®é›†"></a>ç†Ÿæ‚‰æ•°æ®é›†</h1><p><span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTcvaG9tZXdvcmsxLw==" title="https://15445.courses.cs.cmu.edu/fall2017/homework1/">https://15445.courses.cs.cmu.edu/fall2017/homework1/<i class="fa fa-external-link"></i></span>  -&gt; CHECK THE SCHEMA</p>
<h1 id="Q0"><a href="#Q0" class="headerlink" title="Q0"></a>Q0</h1><p>Count the number of cases in the Maryland Judiciary Court System. The output should look like this (only a single number):</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">sqlite&gt; select ...;</span><br><span class="line">12345</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Make use of the <code>count</code> function.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(case_id) <span class="keyword">from</span> cases;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q1"><a href="#Q1" class="headerlink" title="Q1"></a>Q1</h1><p>Count the number of attorneys in the system. The output should look like this (only a single number):</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">sqlite&gt; select ...;</span><br><span class="line">12345</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Ensure that there are no duplicates.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Count the number of attorneys</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">name</span>)</span><br><span class="line"><span class="keyword">from</span> attorneys;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q2"><a href="#Q2" class="headerlink" title="Q2"></a>Q2</h1><p>Repeated phone calls can sometimes land you in jail. Count the number of charges related to phone calls by examining their description. The output should look like this:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">12345</span><br></pre></td></tr></tbody></table></figure>
<p>Details: The search string for the appropriate column is <code>%PHONE%</code>.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Count the number of cases related to repeated phone calls.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(case_id)</span><br><span class="line"><span class="keyword">from</span> charges</span><br><span class="line"><span class="keyword">where</span> description <span class="keyword">like</span> <span class="string">'%PHONE%'</span> ;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q3"><a href="#Q3" class="headerlink" title="Q3"></a>Q3</h1><p>Reckless endangerment is another reason why one can end up in a courthouse. Count the number of cases related to reckless endangerment in each county. The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">County A|500</span><br><span class="line">County B|400</span><br><span class="line">County C|300</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the county name and number of cases in that particular county. Sort the counties by the number of cases in descending order, and break ties by ordering them in ascending order with respect to the county name. Report only the top <code>3</code> counties with the maximum number of cases. The search string for the appropriate column is <code>%RECKLESS%</code>. Ensure that you only fetch the cases whose county name is not empty.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ca.violation_county, <span class="keyword">count</span>(ca.case_id) <span class="keyword">as</span> num_cases</span><br><span class="line"><span class="keyword">from</span> cases ca, charges ch</span><br><span class="line"><span class="keyword">where</span> ca.case_id = ch.case_id <span class="keyword">and</span></span><br><span class="line">      ch.description <span class="keyword">like</span> <span class="string">'%RECKLESS%'</span> <span class="keyword">and</span></span><br><span class="line">      ca.violation_county != <span class="string">''</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> ca.violation_county</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_cases <span class="keyword">desc</span>, cases.violation_county <span class="keyword">asc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Count the number of cases related to reckless endangerment in each county: </span></span><br><span class="line"><span class="comment">--- Print county name and number of cases</span></span><br><span class="line"><span class="comment">--- Sort by number of cases (descending),</span></span><br><span class="line"><span class="comment">--- and break ties by county name (ascending),</span></span><br><span class="line"><span class="comment">--- and report only the top 3 counties.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> cases.violation_county, <span class="keyword">count</span>(cases.case_id) <span class="keyword">as</span> cnt </span><br><span class="line"><span class="keyword">from</span> cases, charges</span><br><span class="line"><span class="keyword">where</span> cases.case_id = charges.case_id</span><br><span class="line">      <span class="keyword">and</span> cases.violation_county &lt;&gt; <span class="string">''</span></span><br><span class="line">      <span class="keyword">and</span> charges.description <span class="keyword">like</span> <span class="string">'%RECKLESS%'</span> </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> cases.violation_county</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>, cases.violation_county <span class="keyword">asc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q4"><a href="#Q4" class="headerlink" title="Q4"></a>Q4</h1><p>Letâ€™s now go back in time and look at the cases filed in the 1950s. The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">CASE1|1950-03-12</span><br><span class="line">CASE2|1951-01-01</span><br><span class="line">CASE3|1952-01-01</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the case id and filing date for the cases filed in the 1950s. List the oldest cases first, and report only the earliest <code>3</code> cases.</p>
<p>æœ‰ç”¨çš„é“¾æ¥ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly93d3cuc3FsaXRlLm9yZy9sYW5nX2RhdGVmdW5jLmh0bWw=" title="https://www.sqlite.org/lang_datefunc.html">https://www.sqlite.org/lang_datefunc.html<i class="fa fa-external-link"></i></span></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> case_id, filing_date</span><br><span class="line"><span class="keyword">from</span> cases</span><br><span class="line"><span class="keyword">where</span> strftime(<span class="string">'%Y'</span>, filing_date) <span class="keyword">between</span> strftime(<span class="string">'%Y'</span>, <span class="built_in">date</span>(<span class="string">'1950-01-01'</span>)) <span class="keyword">and</span> strftime(<span class="string">'%Y'</span>, <span class="built_in">date</span>(<span class="string">'1959-01-01'</span>))</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> filing_date <span class="keyword">asc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Cases filed in the 1950s</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> case_id, filing_date</span><br><span class="line"><span class="keyword">from</span> cases</span><br><span class="line"><span class="keyword">where</span> filing_date &gt;= <span class="string">'1950-01-01'</span> <span class="keyword">and</span> filing_date &lt; <span class="string">'1960-01-01'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> filing_date</span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q5"><a href="#Q5" class="headerlink" title="Q5"></a>Q5</h1><p>It looks like a lot of cases got filed in the 1950s. In which decades did the most number of cases get filed? The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">10000|1970s</span><br><span class="line">5000|2000s</span><br><span class="line">1000|1980s</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the number of cases and the relevant decade. We will print the relevant decade in a fancier format by constructing a string that looks like this <code>1970s</code>. Sort the decades in decreasing order with respect to the number of cases. Report only the top <code>3</code> decades wherein the most number of cases got filed. Ensure that you only fetch the cases whose filing date is not empty.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(case_decade.case_id) <span class="keyword">as</span> num_cases, <span class="keyword">cast</span> (case_decade.decade <span class="keyword">as</span> <span class="built_in">char</span>(<span class="number">3</span>)) || <span class="string">'0s'</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> case_id, <span class="keyword">cast</span>(strftime(<span class="string">'%Y'</span>, filing_date) <span class="keyword">as</span> <span class="built_in">integer</span>) / <span class="number">10</span> <span class="keyword">as</span> decade</span><br><span class="line">    <span class="keyword">from</span> cases</span><br><span class="line">    <span class="keyword">where</span> filing_date != <span class="string">''</span>) <span class="keyword">as</span> case_decade</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> case_decade.decade</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_cases <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- In which 3 decades did the most number of cases get filed?</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(case_id) <span class="keyword">as</span> case_count,</span><br><span class="line"><span class="keyword">substr</span>(filing_date, <span class="number">1</span>, <span class="number">3</span>) || <span class="string">'0s'</span> <span class="keyword">as</span> decade <span class="keyword">from</span> cases</span><br><span class="line"><span class="keyword">where</span> filing_date &lt;&gt; <span class="string">''</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> decade</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> case_count <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>æ€è·¯ç±»ä¼¼è¿™ä¸€é¢˜ã€€<a href="https://cakebytheoceanluo.github.io/2020/03/07/CMU-15445-HomeWork1-19Fall/#Q4">Fall19 Homework1 Q4</a></p>
<ul>
<li>æˆ‘çš„è§£æ³•: cast into integer</li>
<li>ç­”æ¡ˆ: cast into string</li>
<li>è¿™ä¸¤ä¸ªè§£æ³•çœ‹èµ·æ¥æ€§èƒ½å·®è·ä¸å¤§</li>
</ul>
<h1 id="Q6"><a href="#Q6" class="headerlink" title="Q6"></a>Q6</h1><p>Cases can often be closed for bizzare reasons. One such reason is statistics. Determine the percentage of cases that were statistically closed. The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">5.123456789</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the percentage of cases. To compute the percentage, you will need to multiply the numerator of the fraction by <code>100.0</code>. While searching the caseâ€™s status, use the following string: <code>Case Closed Statistically</code>. To keep things simple, there is no need to truncate or round numbers. To compute the percentage, simply multiply the numerator by <code>100.0</code> and divide by the appropriate denominator.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">100.0</span> * <span class="keyword">count</span>(*) / (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> cases)</span><br><span class="line"><span class="keyword">from</span> cases</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">status</span> = <span class="string">'Case Closed Statistically'</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Fraction of cases closed statistically</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> statistically_closed_cases.cnt * <span class="number">100.0</span> / all_cases.cnt <span class="keyword">as</span> percentage </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(case_id) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">from</span> cases</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">status</span> = <span class="string">'Case Closed Statistically'</span> ) <span class="keyword">as</span> statistically_closed_cases,</span><br><span class="line">    (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(case_id) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">from</span> cases</span><br><span class="line">    ) <span class="keyword">as</span> all_cases;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q7"><a href="#Q7" class="headerlink" title="Q7"></a>Q7</h1><p>Letâ€™s look at some prolific defendants. List the top 3 parties who have been charged in the most number of distinct counties. The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">A|100</span><br><span class="line">B|50</span><br><span class="line">C|10</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the name of the party along with the number of distinct counties. Sort the parties by the number of distinct counties in descending order, and report only the top <code>3</code> parties. Ensure that you only fetch the parties who are defendants (<code>Defendant</code>) and whose name is not empty.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> p.name, <span class="keyword">count</span>(<span class="keyword">distinct</span> c.violation_county) <span class="keyword">as</span> num_vc</span><br><span class="line"><span class="keyword">from</span> parties p, cases c</span><br><span class="line"><span class="keyword">where</span> p.case_id = c.case_id <span class="keyword">and</span></span><br><span class="line">      p.name != <span class="string">''</span> <span class="keyword">and</span></span><br><span class="line">      p.type = <span class="string">'Defendant'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> p.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_vc <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- List the top 3 parties who have been</span></span><br><span class="line"><span class="comment">--- charged in the most number of distinct counties.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> parties.name, <span class="keyword">count</span>(<span class="keyword">distinct</span>(cases.violation_county)) <span class="keyword">as</span> cnt</span><br><span class="line"><span class="keyword">from</span> cases, parties</span><br><span class="line"><span class="keyword">where</span> cases.case_id = parties.case_id</span><br><span class="line"><span class="keyword">and</span> parties.type = <span class="string">'Defendant'</span></span><br><span class="line"><span class="keyword">and</span> parties.name &lt;&gt; <span class="string">''</span> </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> parties.name </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q8"><a href="#Q8" class="headerlink" title="Q8"></a>Q8</h1><p>How does the average age of guilty criminals vary over time? The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">2017|50.123456789</span><br><span class="line">2016|55.123456789</span><br><span class="line">2015|60.123456789</span><br><span class="line">2014|55.123456789</span><br><span class="line">2013|50.123456789</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the filing year and the average age of the criminals that were found guilty in cases filed in that particular year. To compute the average age, first determine the age of the criminal by using the caseâ€™s filing date and the partyâ€™s date of birth. Use the <code>strftime('%Y.%m%d',...)</code> function for this purpose. To determine the filing year from the filing date, again make use of the <code>strftime('%Y',...)</code> function. Look at the disposition to pick only <code>Guilty</code> parties (<code>charges.disposition = 'Guilty'</code>). Ensure that you only fetch the cases whose filing date is not empty. Also, ensure that you only fetch the parties who are defendants (<code>parties.type = Defendant</code>), whose name is not empty, whose date of birth is not empty, and whose computed age is greater than <code>0</code> and less than <code>100</code> years. List the tuples in descending order with respect to the filing year and only display <code>5</code> tuples. You might want to leverage common table expressions (CTEs) in this query. Hereâ€™s more information on <span class="exturl" data-url="aHR0cHM6Ly9zcWxpdGUub3JnL2xhbmdfd2l0aC5odG1s" title="https://sqlite.org/lang_with.html">using CTEs in SQLite<i class="fa fa-external-link"></i></span>.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> strftime(<span class="string">'%Y'</span>, ca.filing_date) <span class="keyword">as</span> filing_year,</span><br><span class="line">       <span class="keyword">avg</span>(strftime(<span class="string">'%Y.%m%d'</span>, ca.filing_date) - strftime(<span class="string">'%Y.%m%d'</span>, p.dob)) <span class="keyword">as</span> avg_age</span><br><span class="line"><span class="keyword">from</span> parties p, charges ch, cases ca</span><br><span class="line"><span class="keyword">where</span> p.case_id = ca.case_id <span class="keyword">and</span></span><br><span class="line">      ch.case_id = ca.case_id <span class="keyword">and</span></span><br><span class="line">      ch.disposition = <span class="string">'Guilty'</span> <span class="keyword">and</span></span><br><span class="line">      ca.filing_date != <span class="string">''</span> <span class="keyword">and</span></span><br><span class="line">      p.name != <span class="string">''</span> <span class="keyword">and</span></span><br><span class="line">      p.type = <span class="string">'Defendant'</span> <span class="keyword">and</span></span><br><span class="line">      p.dob <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span></span><br><span class="line">      (strftime(<span class="string">'%Y.%m%d'</span>, ca.filing_date) - strftime(<span class="string">'%Y.%m%d'</span>, p.dob)) &gt; <span class="number">0</span> <span class="keyword">and</span></span><br><span class="line">      (strftime(<span class="string">'%Y.%m%d'</span>, ca.filing_date) - strftime(<span class="string">'%Y.%m%d'</span>, p.dob)) &lt; <span class="number">100</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> filing_year</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> filing_year <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Average age of guilty criminals over time</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> filing_year_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> cases.case_id, strftime(<span class="string">'%Y'</span>, filing_date) <span class="keyword">as</span> filing_year</span><br><span class="line">    <span class="keyword">from</span> cases, charges</span><br><span class="line">    <span class="keyword">where</span> cases.case_id = charges.case_id</span><br><span class="line">    <span class="keyword">and</span> charges.disposition = <span class="string">'Guilty'</span></span><br><span class="line">    <span class="keyword">and</span> cases.filing_date &lt;&gt; <span class="string">''</span></span><br><span class="line">), age_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> cases.case_id,</span><br><span class="line">    strftime(<span class="string">'%Y.%m%d'</span>, cases.filing_date) - strftime(<span class="string">'%Y.%m%d'</span>, parties.dob) <span class="keyword">as</span> age </span><br><span class="line">    <span class="keyword">from</span> cases, parties</span><br><span class="line">    <span class="keyword">where</span> cases.case_id = parties.case_id</span><br><span class="line">    <span class="keyword">and</span> parties.type = <span class="string">'Defendant'</span></span><br><span class="line">    <span class="keyword">and</span> parties.name &lt;&gt; <span class="string">''</span></span><br><span class="line">    <span class="keyword">and</span> parties.dob <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">and</span> age &gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">and</span> age &lt; <span class="number">100</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> filing_year_table.filing_year, <span class="keyword">avg</span>(age_table.age) <span class="keyword">as</span> average_age</span><br><span class="line"><span class="keyword">from</span> cases, filing_year_table, age_table</span><br><span class="line"><span class="keyword">where</span> cases.case_id = filing_year_table.case_id</span><br><span class="line">      <span class="keyword">and</span> cases.case_id = age_table.case_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> filing_year_table.filing_year</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> filing_year <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q9"><a href="#Q9" class="headerlink" title="Q9"></a>Q9</h1><p>Letâ€™s next look at case disposition by race to see if there is any inherent bias in the system. The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">African American|Guilty|60.000</span><br><span class="line">African American|Not Guilty|40.000</span><br><span class="line">Caucasian|Guilty|50.000</span><br><span class="line">Caucasian|Not Guilty|50.000</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the race, the case disposition, and the percentage of cases disposed with that verdict. Letâ€™s restrict our focus to <code>2</code> races (<code>African American</code>, <code>Caucasian</code>), and 2 types of case disposition (<code>Guilty</code>, <code>Not Guilty</code>). To compute the percentage, you will need to multiply the numerator of the fraction by <code>100.0</code>. Ensure that the race of the party is not empty. You might want to leverage common table expressions (CTEs) in this query. <span class="exturl" data-url="aHR0cHM6Ly9zcWxpdGUub3JnL2xhbmdfd2l0aC5odG1s" title="https://sqlite.org/lang_with.html">using CTEs in SQLite<i class="fa fa-external-link"></i></span>.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> temp <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> p.race, c.disposition</span><br><span class="line">    <span class="keyword">from</span> parties p, charges c</span><br><span class="line">    <span class="keyword">where</span> p.case_id = c.case_id <span class="keyword">and</span></span><br><span class="line">          p.race &lt;&gt; <span class="string">''</span> <span class="keyword">and</span></span><br><span class="line">          p.race <span class="keyword">in</span> (<span class="string">'African American'</span>, <span class="string">'Caucasian'</span>) <span class="keyword">and</span></span><br><span class="line">          c.disposition <span class="keyword">in</span> (<span class="string">'Guilty'</span>, <span class="string">'Not Guilty'</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="string">'African American'</span>, t.disposition, <span class="number">100.0</span> * <span class="keyword">count</span>(*) / (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> temp t_ <span class="keyword">where</span> t_.disposition = t.disposition)</span><br><span class="line"><span class="keyword">from</span> temp t</span><br><span class="line"><span class="keyword">where</span> t.race = <span class="string">'African American'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t.disposition</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'Caucasian'</span>, t.disposition, <span class="number">100.0</span> * <span class="keyword">count</span>(*) / (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> temp t_ <span class="keyword">where</span> t_.disposition = t.disposition)</span><br><span class="line"><span class="keyword">from</span> temp t</span><br><span class="line"><span class="keyword">where</span> t.race = <span class="string">'Caucasian'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t.disposition;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Disposition by race</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> disposition_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> race, charges.disposition, parties.case_id <span class="keyword">as</span> case_id</span><br><span class="line">    <span class="keyword">from</span> charges, parties</span><br><span class="line">    <span class="keyword">where</span> charges.case_id = parties.case_id</span><br><span class="line">    <span class="keyword">and</span> race &lt;&gt; <span class="string">''</span></span><br><span class="line">    <span class="keyword">and</span> disposition <span class="keyword">in</span> (<span class="string">'Guilty'</span>, <span class="string">'Not Guilty'</span>)</span><br><span class="line">    <span class="keyword">and</span> race <span class="keyword">in</span> (<span class="string">'African American'</span>, <span class="string">'Caucasian'</span>)</span><br><span class="line">),</span><br><span class="line">disposition_aggregate_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> disposition, <span class="keyword">count</span>(case_id) <span class="keyword">as</span> case_count</span><br><span class="line">    <span class="keyword">from</span> disposition_table</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> disposition</span><br><span class="line">),</span><br><span class="line">race_aggregate_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> race, disposition, <span class="keyword">count</span>(case_id) <span class="keyword">as</span> case_count</span><br><span class="line">    <span class="keyword">from</span> disposition_table</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> race, disposition</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> race,</span><br><span class="line">       race_aggregate_table.disposition,</span><br><span class="line">       (race_aggregate_table.case_count * <span class="number">100.0</span>) / disposition_aggregate_table.case_count</span><br><span class="line"><span class="keyword">from</span> race_aggregate_table, disposition_aggregate_table</span><br><span class="line"><span class="keyword">where</span> race_aggregate_table.disposition = disposition_aggregate_table.disposition;</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é¢˜çš„ç»“æœè¿˜æ˜¯æŒºéš¾çœ‹æ‡‚</p>
<ul>
<li>æˆ‘çš„è§£æ³•ã€€ç”±ä¸¤ä¸ªå°è¡¨æ ¼ç»„æˆï¼Œã€€execution timeè¾ƒçŸ­ï¼Œfetching timeè¾ƒé•¿</li>
<li>ç­”æ¡ˆå°±æ˜¯ç›¸å¯¹ç›´æ¥çš„æ€è·¯ï¼Œç›´æ¥ç”Ÿäº§å¯¹åº”çš„åˆ†å­åˆ†æ¯ç›¸é™¤ã€‚</li>
</ul>
<h1 id="Q10"><a href="#Q10" class="headerlink" title="Q10"></a>Q10</h1><p>Certain zip codes might have â€” ahem â€” more interesting citizens than Squirrel Hill. Retrieve the top 3 zip codes in Maryland where the most number of cases were filed. The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">21000|500</span><br><span class="line">21001|400</span><br><span class="line">21002|300</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the zip code along with the number of cases filed in that particular zip code. List them in decreasing order with respect to the number of cases. Display only the top <code>3</code> zip codes. Ensure that the zip code is not empty.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> p.zip, <span class="keyword">count</span>(c.case_id) <span class="keyword">as</span> num_cases</span><br><span class="line"><span class="keyword">from</span> parties p, charges c</span><br><span class="line"><span class="keyword">where</span> p.case_id = c.case_id <span class="keyword">and</span> p.zip != <span class="string">''</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> p.zip</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_cases <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Top zip codes with most criminals</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> parties.zip, <span class="keyword">count</span>(parties.case_id) <span class="keyword">as</span> case_count</span><br><span class="line"><span class="keyword">from</span> parties, charges</span><br><span class="line"><span class="keyword">where</span> parties.case_id = charges.case_id</span><br><span class="line"><span class="keyword">and</span> parties.zip &lt;&gt; <span class="string">''</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> parties.zip</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> case_count <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q11"><a href="#Q11" class="headerlink" title="Q11"></a>Q11</h1><p>Some attorneys are awesome at their job. List the top 5 attorneys in Maryland by examining the number of cases that an attorney handles and the percentage of cases wherein they were successful. The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">A|100|60.123</span><br><span class="line">B|200|45.123</span><br><span class="line">C|100|30.123</span><br><span class="line">D|500|20.123</span><br><span class="line">E|100|10.123</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the attorneyâ€™s name, number of cases handled, and the percentage of cases won (i.e. the disposition was <code>Not Guilty</code>). Examine only attorneys who have handled more than <code>100</code> cases. List the attorneys in decreasing order with respect to their success percentage and number of cases handled, respectively. Display only the top <code>5</code> attorneys. Ensure that the attorneyâ€™s name is not empty. You might want to leverage common table expressions (CTEs) in this query. <span class="exturl" data-url="aHR0cHM6Ly9zcWxpdGUub3JnL2xhbmdfd2l0aC5odG1s" title="https://sqlite.org/lang_with.html">using CTEs in SQLite<i class="fa fa-external-link"></i></span>.</p>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Attorney performance</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> attorney_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> charges.case_id <span class="keyword">as</span> case_id, disposition, <span class="keyword">name</span> <span class="keyword">from</span> charges, attorneys</span><br><span class="line">    <span class="keyword">where</span> charges.case_id = attorneys.case_id</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">name</span> &lt;&gt; <span class="string">''</span></span><br><span class="line">), aggregate_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(case_id) <span class="keyword">as</span> total_count, <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">from</span> attorney_table</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br><span class="line">), success_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(case_id) <span class="keyword">as</span> success_count, <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">from</span> attorney_table</span><br><span class="line">    <span class="keyword">where</span> disposition = <span class="string">'Not Guilty'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> aggregate_table.name, total_count, (success_count * <span class="number">100.0</span>/total_count) <span class="keyword">as</span> success_percent</span><br><span class="line"><span class="keyword">from</span> aggregate_table, success_table</span><br><span class="line"><span class="keyword">where</span> aggregate_table.name = success_table.name <span class="keyword">and</span> total_count &gt; <span class="number">100</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> success_percent <span class="keyword">desc</span>, total_count <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">5</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q12"><a href="#Q12" class="headerlink" title="Q12"></a>Q12</h1><p>Find the attorney with the seventh highest success percentage (by extending the previous query). The output should look like this:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">G|50|5.123</span><br></pre></td></tr></tbody></table></figure>
<p>Details: Print the attorneyâ€™s name, number of cases handled, and the percentage of cases won (i.e. the disposition was Not Guilty). Examine only attorneys who have handled more than 100 cases. Ensure that the attorneyâ€™s name is not empty.</p>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">--- Attorney with seventh highest success percentage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> attorney_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> charges.case_id <span class="keyword">as</span> case_id, disposition, <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">from</span> charges, attorneys</span><br><span class="line">    <span class="keyword">where</span> charges.case_id = attorneys.case_id</span><br><span class="line">          <span class="keyword">and</span> <span class="keyword">name</span> &lt;&gt; <span class="string">''</span></span><br><span class="line">), aggregate_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(case_id) <span class="keyword">as</span> total_count, <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">from</span> attorney_table</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">having</span> total_count &gt; <span class="number">100</span></span><br><span class="line">), success_table <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(case_id) <span class="keyword">as</span> success_count, <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">from</span> attorney_table</span><br><span class="line">    <span class="keyword">where</span> disposition = <span class="string">'Not Guilty'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> aggregate_table.name, total_count, (success_count * <span class="number">100.0</span>/total_count) <span class="keyword">as</span> success_percent</span><br><span class="line"><span class="keyword">from</span> aggregate_table, success_table</span><br><span class="line"><span class="keyword">where</span> aggregate_table.name = success_table.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> success_percent <span class="keyword">desc</span>, total_count <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">offset</span> <span class="number">6</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>Q11å’ŒQ12åªæœ‰æœ€åçš„<code>LIMIT</code>, <code>OFFSET</code>æœ‰åŒºåˆ«ã€‚</p>
<p><code>LIMIT</code>, <code>OFFSET</code>: è§ <a href="https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/#LIMIT-OFFSET">https://cakebytheoceanluo.github.io/2020/03/06/CMU-15445-Lec02-part2/#LIMIT-OFFSET</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>SQLite</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]HomeWork1_18Fall</title>
    <url>/2020/03/08/CMU-15445-HomeWork1-18Fall/</url>
    <content><![CDATA[<p>2018 Fall: HOMEWORK #1 - SQL</p>
<p>Homework: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTgvaG9tZXdvcmsxLw==" title="https://15445.courses.cs.cmu.edu/fall2018/homework1/">https://15445.courses.cs.cmu.edu/fall2018/homework1/<i class="fa fa-external-link"></i></span><br>Solution: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTgvZmlsZXMvaHcxLXNvbHMudGFyLmd6" title="https://15445.courses.cs.cmu.edu/fall2018/files/hw1-sols.tar.gz">https://15445.courses.cs.cmu.edu/fall2018/files/hw1-sols.tar.gz<i class="fa fa-external-link"></i></span></p>
<a id="more"></a>
<p>CMUæ¨èä½¿ç”¨ SQLite: <span class="exturl" data-url="aHR0cHM6Ly93d3cuc3FsaXRlLm9yZy9pbmRleC5odG1s" title="https://www.sqlite.org/index.html">https://www.sqlite.org/index.html<i class="fa fa-external-link"></i></span></p>
<p>å·²æ£€æŸ¥è¿‡æˆ‘çš„è§£æ³•å’Œç­”æ¡ˆç”Ÿæˆçš„ç»“æœä¸€æ ·ã€‚</p>
<!-- TODO: link æ–‡ç«  SQLITE å®‰è£… å’ŒSQLITEæ•°æ®é›† -->
<h1 id="ç†Ÿæ‚‰æ•°æ®é›†"><a href="#ç†Ÿæ‚‰æ•°æ®é›†" class="headerlink" title="ç†Ÿæ‚‰æ•°æ®é›†"></a>ç†Ÿæ‚‰æ•°æ®é›†</h1><p><span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTgvaG9tZXdvcmsxLw==" title="https://15445.courses.cs.cmu.edu/fall2018/homework1/">https://15445.courses.cs.cmu.edu/fall2018/homework1/<i class="fa fa-external-link"></i></span>  -&gt; CHECK THE SCHEMA</p>
<p><img data-src="https://15445.courses.cs.cmu.edu/fall2018/files/schema.png" alt="schema"></p>
<blockquote>
<p>When calculating the duration of a bike trip, please use <code>trip.start_time</code> and <code>trip.end_time</code>. Please do NOT use <code>trip.duration</code>, there is inconsistency in <code>trip.duration</code> in the data we have.</p>
</blockquote>
<h1 id="Q1"><a href="#Q1" class="headerlink" title="Q1"></a>Q1</h1><p>Count the number of cities. The purpose of this query is to make sure that the formatting of your output matches exactly the formatting of our auto- grading script.</p>
<p>Details: Print the number of cities (eliminating duplicates).</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span>(city)) <span class="keyword">from</span> station;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q2"><a href="#Q2" class="headerlink" title="Q2"></a>Q2</h1><p>Count the number of stations in each city.</p>
<p>Details: Print city name and number of stations. Sort by number of stations (increasing), and break ties by city name (increasing).</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> city, <span class="keyword">count</span>(station_id) <span class="keyword">as</span> num_station</span><br><span class="line"><span class="keyword">from</span> station</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> city</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_station <span class="keyword">asc</span>, city <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> city, <span class="keyword">count</span>(station_id) <span class="keyword">as</span> cnt <span class="keyword">from</span> station <span class="keyword">group</span> <span class="keyword">by</span> city <span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">asc</span>, city <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q3"><a href="#Q3" class="headerlink" title="Q3"></a>Q3</h1><p>Find the percentage of trips in each city. A trip belongs to a city as long as its start station or end station is in the city. For example, if a trip started from station A in city P and ended in station B in city Q, then the trip belongs to both city P and city Q. If P equals to Q, the trip is only counted once.</p>
<p>Details: Print city name and ratio between the number of trips that belong to that city against the total number of trips (a decimal between 0-1, round to <code>four</code> decimal places using <code>ROUND()</code>). Sort by ratio (decreasing), and break ties by city name (increasing).</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> count_once <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> start_station_id</span><br><span class="line">    <span class="keyword">from</span> trip t, station s1, station s2</span><br><span class="line">    <span class="keyword">where</span> t.start_station_id = s1.station_id <span class="keyword">and</span> t.end_station_id = s2.station_id <span class="keyword">and</span> s1.city = s2.city</span><br><span class="line">    ),</span><br><span class="line">     count_twice <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> start_station_id, end_station_id</span><br><span class="line">    <span class="keyword">from</span> trip t, station s1, station s2</span><br><span class="line">    <span class="keyword">where</span> t.start_station_id = s1.station_id <span class="keyword">and</span> t.end_station_id = s2.station_id <span class="keyword">and</span> s1.city != s2.city</span><br><span class="line">     ),</span><br><span class="line">     occurrence (station_id) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">from</span> count_once</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> start_station_id <span class="keyword">from</span> count_twice</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> end_station_id <span class="keyword">from</span> count_twice</span><br><span class="line">      ),</span><br><span class="line">     num_occurrence (val) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> trip</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> s.city, <span class="keyword">ROUND</span>(<span class="number">1.0</span> * <span class="keyword">count</span>(o.station_id) / no.val, <span class="number">4</span>) <span class="keyword">as</span> precentage</span><br><span class="line"><span class="keyword">from</span> occurrence o, station s, num_occurrence <span class="keyword">no</span></span><br><span class="line"><span class="keyword">where</span> o.station_id = s.station_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.city</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> precentage <span class="keyword">desc</span>, s.city <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> city_trip_cnt.city, <span class="keyword">round</span>(city_trip_cnt.cnt * <span class="number">1.0</span> / trip_cnt.cnt, <span class="number">4</span>) <span class="keyword">as</span> ratio</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     (<span class="keyword">select</span> city, <span class="keyword">count</span>(<span class="keyword">distinct</span>(<span class="keyword">id</span>)) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> trip, station</span><br><span class="line">      <span class="keyword">where</span> station_id = start_station_id <span class="keyword">or</span> station_id = end_station_id <span class="keyword">group</span> <span class="keyword">by</span> city) <span class="keyword">as</span> city_trip_cnt,</span><br><span class="line">     (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> cnt <span class="keyword">from</span> trip) <span class="keyword">as</span> trip_cnt</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> ratio <span class="keyword">desc</span>, city <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><strong>the total number of trips</strong>æŒ‡ <code>select count(*) from trip</code></li>
<li>ç­”æ¡ˆè¿™æ ·åˆ†å­åˆ†æ¯å…¶å®ä¸å¯¹åº”</li>
<li>æˆ‘ä¸ªäººè§‰å¾—<strong>the total number of trips</strong>åº”è¯¥å¯¹åº” <code>select count(*) from occurrence</code>, è¿™æ ·æ‰€æœ‰åˆ†å­ç›¸åŠ æ‰ç­‰äºåˆ†æ¯ï¼Œæ‰€æœ‰çš„ç™¾åˆ†æ¯”ç›¸åŠ æ­£å¥½æ˜¯1</li>
<li>æˆ‘è§‰å¾—ç­”æ¡ˆä¸æ°å½“ï¼Œæ¯•ç«Ÿç­”æ¡ˆä¸­æ‰€æœ‰çš„ç™¾åˆ†æ¯”ç›¸åŠ æ˜¯ <code>1.0016</code>, å·²ç»å¤§äº1äº†ã€‚ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8">ğŸ˜„</span></li>
</ul>
<h1 id="Q4"><a href="#Q4" class="headerlink" title="Q4"></a>Q4</h1><p>For each city, find the most popular station in that city. â€œPopularâ€ means that the station has the highest count of visits. As above, either starting a trip or finishing a trip at a station, the trip is counted as one â€œvisitâ€ to that station. The trip is only counted once if the start station and the end station are the same.</p>
<p>Details: For each station, print city name, most popular station name and its visit count. Sort by city name, ascending.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> count_once <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> start_station_id</span><br><span class="line">    <span class="keyword">from</span> trip</span><br><span class="line">    <span class="keyword">where</span> start_station_id = end_station_id</span><br><span class="line">    ),</span><br><span class="line">     count_twice <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> start_station_id, end_station_id</span><br><span class="line">    <span class="keyword">from</span> trip</span><br><span class="line">    <span class="keyword">where</span> start_station_id != end_station_id</span><br><span class="line">     ),</span><br><span class="line">     occurrence (station_id) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">from</span> count_once</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> start_station_id <span class="keyword">from</span> count_twice</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> end_station_id <span class="keyword">from</span> count_twice</span><br><span class="line">      ),</span><br><span class="line">     popular_station <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> station_id, <span class="keyword">count</span>(*) <span class="keyword">as</span> num_visit</span><br><span class="line">    <span class="keyword">from</span> occurrence</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> station_id</span><br><span class="line">     ), popular_city_station <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.city, s.station_name, ps.num_visit</span><br><span class="line">    <span class="keyword">from</span> popular_station ps, station s</span><br><span class="line">    <span class="keyword">where</span> ps.station_id = s.station_id <span class="keyword">and</span> ps.num_visit =</span><br><span class="line">        (<span class="keyword">select</span> <span class="keyword">max</span>(ps_.num_visit) <span class="keyword">from</span> popular_station ps_, station s_ <span class="keyword">where</span> ps_.station_id = s_.station_id <span class="keyword">and</span> s.city = s_.city)</span><br><span class="line">     )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> popular_city_station</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> city;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> visit(station_id, station_name, city, cnt) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> station_id, station_name, city, <span class="keyword">count</span>(<span class="keyword">id</span>) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">from</span> trip, station</span><br><span class="line">    <span class="keyword">where</span> station_id = start_station_id <span class="keyword">or</span> station_id = end_station_id</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> station_id</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> visit.city, visit.station_name, visit.cnt</span><br><span class="line"><span class="keyword">from</span> visit</span><br><span class="line"><span class="keyword">where</span> visit.cnt =</span><br><span class="line">      (<span class="keyword">select</span> <span class="keyword">max</span>(cnt)</span><br><span class="line">      <span class="keyword">from</span> visit <span class="keyword">as</span> max_visit</span><br><span class="line">      <span class="keyword">where</span> max_visit.city = visit.city)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> city;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q5"><a href="#Q5" class="headerlink" title="Q5"></a>Q5</h1><p>Find the top 10 days that have the highest average bike utilization. For simplicity, we only consider trips that use bikes with <code>id &lt;= 100</code>. The average bike utilization on date D is calculated as the sum of the durations of all the trips that happened on date D divided by the total number of bikes with <code>id &lt;= 100</code>, which is a <code>constant</code>. If a trip overlaps with date D, but starts before date D or ends after date D, then only the interval that overlaps with date D (from 0:00 to 24:00) will be counted when calculating the average bike utilization of date D. And we only calculate the average bike utilization for the date that has been either a start or an end date of a trip. You can assume that no trip has negative time (i.e., for all trips, start time &lt;= end time).</p>
<p>Details: For the dates with the top 10 average duration, print the date and the average bike duration on that date (in seconds, round to four decimal places using the <code>ROUND()</code> function). Sort by the average duration, decreasing. <code>Please refer to the updated note before Q1 when calculating the duration of a trip.</code></p>
<p>Hint: All timestamps are stored as text after loaded from csv in sqlite. You can use <code>datetime(timestamp string)</code> to get the timestamp out of the string and <code>date(timestamp string)</code> to get the date out of the string. You may also find the funtion <code>strftime()</code> helpful in computing the duration between two timestamps.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> dates <span class="keyword">as</span> ( <span class="comment">-- list all possible date</span></span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">date</span>(start_time) <span class="keyword">as</span> tdate</span><br><span class="line">    <span class="keyword">from</span> trip</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">date</span>(end_time) <span class="keyword">as</span> tdate</span><br><span class="line">    <span class="keyword">from</span> trip)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tdate,</span><br><span class="line">       <span class="keyword">round</span>(</span><br><span class="line">           <span class="keyword">sum</span>(strftime(<span class="string">'%s'</span>, <span class="keyword">min</span>(datetime(end_time), datetime(tdate, <span class="string">'+1 day'</span>)))</span><br><span class="line">               - strftime(<span class="string">'%s'</span>, <span class="keyword">max</span>(datetime(start_time), datetime(tdate))))</span><br><span class="line">           * <span class="number">1.0</span> / (<span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span>(bike_id)) <span class="keyword">from</span> trip <span class="keyword">where</span> bike_id &lt;= <span class="number">100</span>),</span><br><span class="line">        <span class="number">4</span>) <span class="keyword">as</span> avg_duration</span><br><span class="line"><span class="keyword">from</span> trip, dates</span><br><span class="line"><span class="keyword">where</span> bike_id &lt;= <span class="number">100</span> <span class="keyword">and</span></span><br><span class="line">      <span class="comment">-- overlap with this date</span></span><br><span class="line">      datetime(start_time, <span class="string">'-1 day'</span>) &lt; datetime(tdate) <span class="keyword">and</span></span><br><span class="line">      datetime(end_time) &gt; datetime(tdate)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> tdate</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> avg_duration <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> dates <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">date</span>(start_time) <span class="keyword">as</span> tdate</span><br><span class="line">    <span class="keyword">from</span> trip</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">date</span>(end_time) <span class="keyword">as</span> tdate</span><br><span class="line">    <span class="keyword">from</span> trip)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tdate,</span><br><span class="line">       <span class="keyword">round</span>(</span><br><span class="line">           <span class="keyword">sum</span>(strftime(<span class="string">'%s'</span>, <span class="keyword">min</span>(datetime(end_time), datetime(tdate, <span class="string">'+1 day'</span>)))</span><br><span class="line">               - strftime(<span class="string">'%s'</span>, <span class="keyword">max</span>(datetime(start_time), datetime(tdate))))</span><br><span class="line">           * <span class="number">1.0</span> / (<span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span>(bike_id)) <span class="keyword">from</span> trip <span class="keyword">where</span> bike_id &lt;= <span class="number">100</span>),</span><br><span class="line">        <span class="number">4</span>) <span class="keyword">as</span> avg_duration</span><br><span class="line"><span class="keyword">from</span> trip, dates</span><br><span class="line"><span class="keyword">where</span> bike_id &lt;= <span class="number">100</span> <span class="keyword">and</span></span><br><span class="line">      datetime(start_time) &lt; datetime(tdate, <span class="string">'+1 day'</span>) <span class="keyword">and</span></span><br><span class="line">      datetime(end_time) &gt; datetime(tdate)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> tdate</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> avg_duration <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é¦–å…ˆï¼Œæ•°æ®é›†ä¿è¯äº†ä¸€ä¸ª invariantä¸å˜é‡ ï¼š $\forall \mathrm{trip t}: \mathrm{t.start_time} &lt; \mathrm{t.end_time}$</li>
<li>å¦å¤–ä¸€ä¸ªå¸¸è¯†çš„ ä¸å˜é‡ ä¹Ÿå¾ˆé‡è¦ï¼š $\forall \mathrm{tdate}: \mathrm{tdate} &lt; \mathrm{tdate + 1 day}$</li>
</ul>
<p><br></p>
<p><code>strftime('%s', min(datetime(end_time), datetime(tdate, '+1 day'))) - strftime('%s', max(datetime(start_time), datetime(tdate)))</code> ï¼š è®¡ç®—çš„æ˜¯è¿™ä¸ªtripçš„<strong>åœ¨ç‰¹å®štdateè¿™ä¸€å¤©ä¸­çš„</strong>æŒç»­æ—¶é—´</p>
<ul>
<li>æˆ‘ä»¬ä¸ºäº†è®²è§£ï¼Œç®€åŒ–è¿™ä¸ªè¡¨è¾¾å¼ï¼š<code>min(end_time, tdate + 1 day) - max(start_time, tdate)</code></li>
<li>æˆ‘ä»¬ä»<strong>å‡æ•°ï¼Œã€€è¢«å‡æ•°</strong>è§’åº¦åˆ†æ<code>start_time</code>, <code>end_time</code>çš„ä¸¤ç§æƒ…å†µï¼š<ul>
<li>è¢«å‡æ•°ï¼š<ul>
<li>è¿™ä¸ªtrip <code>start_time</code>åœ¨<code>tdate</code>ä¹‹å‰ï¼š$\mathrm{start_time} &lt; \mathrm{tdate}$:ã€€è¢«å‡æ•°å–<code>tdate</code></li>
<li>æˆ–ã€€</li>
<li>è¿™ä¸ªtrip <code>start_time</code>åœ¨<code>tdate</code>ä¹‹å: $\mathrm{tdate} &lt; \mathrm{start_time}$:ã€€è¢«å‡æ•°å–<code>start_time</code></li>
<li>æ‰€ä»¥è¢«å‡æ•°æ€»æ˜¯<code>max(start_time, tdate)</code></li>
</ul>
</li>
<li>å‡æ•°åŒç†(æˆ‘å†å•°å—¦ä¸€ä¼šå„¿)ï¼š<ul>
<li>è¿™ä¸ªtrip <code>end_time</code>åœ¨<code>tdate + 1 day</code>ä¹‹å‰ï¼š$\mathrm{end_time} &lt; \mathrm{tdate + 1 day}$:ã€€å‡æ•°å–<code>end_time</code></li>
<li>æˆ–ã€€</li>
<li>è¿™ä¸ªtrip <code>end_time</code>åœ¨<code>tdate + 1 day</code>ä¹‹å: $\mathrm{tdate + 1 day} &lt; \mathrm{end_time}$:ã€€å‡æ•°å–<code>tdate + 1 day</code></li>
<li>æ‰€ä»¥å‡æ•°æ€»æ˜¯<code>min(end_time, tdate + 1 day)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><br></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸¤ä¸ªå¯ä»¥æ›¿æ¢çš„è¡¨è¾¾(è¿™é¢˜çš„æ ¸å¿ƒ)ï¼š</p>
<ul>
<li><code>datetime(start_time, '-1 day') &lt; datetime(tdate) and datetime(end_time) &gt; datetime(tdate)</code> â€” æ¥è‡ªæˆ‘çš„è§£æ³•</li>
<li><code>datetime(start_time) &lt; datetime(tdate, '+1 day') and datetime(end_time) &gt; datetime(tdate)</code> â€” æ¥è‡ªç­”æ¡ˆ</li>
</ul>
<p>ç„¶åæˆ‘ç”¨ä¸‹å›¾æ¥è§£é‡Š<strong>æ¥è‡ªç­”æ¡ˆ</strong>çš„è¡¨è¾¾ï¼Œå³æˆ‘ä»¬è§‚å¯Ÿå››ä¸ªæ—¶é—´ç‚¹ï¼š</p>
<ul>
<li><code>tdate</code></li>
<li><code>tdate + 1 day</code></li>
<li><code>start_time</code></li>
<li><code>end_time</code></li>
</ul>
<p><img data-src="https://cakebytheoceanluo.github.io/images/CMU1544564/num_range.jpg" alt="num_range"></p>
<ul>
<li>$\forall \mathrm{tdate}: \mathrm{tdate} &lt; \mathrm{tdate + 1 day}$</li>
<li>ä½†æ˜¯ã€€<code>end_time</code> å’Œã€€<code>start_time</code> çš„å·®å€¼ä¸å›ºå®šã€€</li>
<li>é•¿æ•°è½´ä¸Šæ–¹çš„å››ä¸ªå°æ•°å€¼åŒºé—´ï¼Œæ˜¯æ—¶é—´åŸŸå’Œ<code>tdate</code>é‡å (ovelap)çš„æ‰€æœ‰å¯èƒ½æ€§</li>
<li>åœ¨è¿™æ‰€æœ‰çš„å¯èƒ½æ€§ä¸­ï¼Œå‡æ»¡è¶³ $\mathrm{start_time} &lt; \mathrm{tdate + 1 day} \wedge \mathrm{end_time} &gt; \mathrm{tdate}$, å³ <code>datetime(start_time) &lt; datetime(tdate, '+1 day') and datetime(end_time) &gt; datetime(tdate)</code><br>â€” æ¥è‡ªç­”æ¡ˆçš„è¡¨è¾¾å¼</li>
<li>é•¿æ•°è½´ä¸‹æ–¹çš„çº¢è‰²å°æ•°å€¼åŒºé—´æ˜¯ä¸€ä¸ªåä¾‹ï¼Œã€€å‰é¢æåˆ°çš„æ¡ä»¶åœ¨è¿™é‡Œæ²¡æœ‰è¢«æ»¡è¶³ã€‚</li>
</ul>
<h1 id="Q6"><a href="#Q6" class="headerlink" title="Q6"></a>Q6</h1><p>One of the possible data-entry errors is to record a bike as being used in two different trips, at the same time. Thus, we want to spot pairs of overlapping intervals (start time, end time). To keep the output manageable, we ask you to do this check for bikes with <code>id between 100 and 200 (both inclusive)</code>. Note: Assume that no trip has negative time, i.e., for all trips, start time &lt;= end time.</p>
<p>Details: For each conflict (a pair of conflict trips), print the bike id, former trip id, former start time, former end time, latter trip id, latter start time, latter end time. Sort by bike id (increasing), break ties with former trip id (increasing) and then latter trip id (increasing).</p>
<p>Hint: (1) Report each conflict pair only once, so that <code>former trip id &lt; latter trip id</code>. (2) We give you the (otherwise tricky) condition for conflicts: start1 &lt; end2 AND end1 &gt; start2</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t1.bike_id, t1.id, t1.start_time, t1.end_time, t2.id, t2.start_time, t2.end_time</span><br><span class="line"><span class="keyword">from</span> trip t1, trip t2</span><br><span class="line"><span class="keyword">where</span> t1.start_time &lt; t2.end_time <span class="keyword">and</span></span><br><span class="line">      t1.end_time &gt; t2.start_time <span class="keyword">and</span></span><br><span class="line">      t1.id &lt; t2.id <span class="keyword">and</span></span><br><span class="line">      t1.bike_id <span class="keyword">between</span> <span class="number">100</span> <span class="keyword">and</span> <span class="number">200</span> <span class="keyword">and</span></span><br><span class="line">      t1.bike_id = t2.bike_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> t1.bike_id <span class="keyword">asc</span>, t1.id <span class="keyword">asc</span>, t2.id <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t1.bike_id, t1.id, t1.start_time, t1.end_time, t2.id, t2.start_time, t2.end_time </span><br><span class="line"><span class="keyword">from</span> trip <span class="keyword">as</span> t1, trip <span class="keyword">as</span> t2 </span><br><span class="line"><span class="keyword">where</span> t1.bike_id = t2.bike_id <span class="keyword">and</span> </span><br><span class="line">      t1.bike_id <span class="keyword">between</span> <span class="number">100</span> <span class="keyword">and</span> <span class="number">200</span> <span class="keyword">and</span> </span><br><span class="line">      t1.id &lt; t2.id <span class="keyword">and</span> t1.start_time &lt; t2.end_time <span class="keyword">and</span> </span><br><span class="line">      t2.start_time &lt; t1.end_time </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> t1.bike_id <span class="keyword">asc</span>, t1.id <span class="keyword">asc</span>, t2.id <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q7"><a href="#Q7" class="headerlink" title="Q7"></a>Q7</h1><p>Find all the bikes that have been to more than one city. A bike has been to a city as long as the start station or end station in one of its trips is in that city.</p>
<p>Details: For each bike that has been to more than one city, print the bike id and the number of cities it has been to. Sort by the number of cities (decreasing), then bike id (increasing).</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> trip2cities (bike_id, city1, city2)<span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> t.bike_id, s1.city, s2.city</span><br><span class="line">    <span class="keyword">from</span> trip t, station s1, station s2</span><br><span class="line">    <span class="keyword">where</span> t.start_station_id = s1.station_id <span class="keyword">and</span></span><br><span class="line">          t.end_station_id = s2.station_id),</span><br><span class="line">     tripCity (bike_id, city) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> bike_id, city1</span><br><span class="line">    <span class="keyword">from</span> trip2cities</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> bike_id, city2</span><br><span class="line">    <span class="keyword">from</span> trip2cities</span><br><span class="line">     )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> bike_id, <span class="keyword">count</span>(<span class="keyword">distinct</span> city) <span class="keyword">as</span> num_city</span><br><span class="line"><span class="keyword">from</span> tripCity</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> bike_id</span><br><span class="line"><span class="keyword">having</span> num_city &gt; <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_city <span class="keyword">desc</span>, bike_id <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> bike_id, <span class="keyword">count</span>(<span class="keyword">distinct</span>(city)) <span class="keyword">as</span> cnt </span><br><span class="line"><span class="keyword">from</span> trip, station </span><br><span class="line"><span class="keyword">where</span> start_station_id = station_id <span class="keyword">or</span> </span><br><span class="line">      end_station_id = station_id </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> bike_id </span><br><span class="line"><span class="keyword">having</span> <span class="keyword">count</span>(<span class="keyword">distinct</span>(city)) &gt; <span class="number">1</span> </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>, bike_id <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿™æ¬¡çš„ç­”æ¡ˆæ€»æ˜¯ç”¨ä¸€ä¸ª<code>or</code>æ¥æ··åˆæ‰€æœ‰çš„startå’Œend</li>
<li>æˆ‘æ€»æ˜¯ç”¨<code>union all</code>æˆ–<code>union</code>, æˆ‘çš„ç›®çš„æ˜¯åŠªåŠ›ç”Ÿæˆæ•°é‡æœ€å°çš„ä¸­é—´ç»“æœï¼Œæ¥åŠ é€ŸSQLæŸ¥è¯¢</li>
<li>ç»å¤§å¤šæ•°æƒ…å†µï¼Œæˆ‘çš„è§£æ³•æ¯”ç­”æ¡ˆè¦å¿«ã€‚(æ¯”å¦‚è¿™ä¸€é¢˜)</li>
</ul>
<h1 id="Q8"><a href="#Q8" class="headerlink" title="Q8"></a>Q8</h1><p>Find what is the average number of trips made per day on each type of weather day. The type of weather on a day is specified by weather.events, such as â€˜Rainâ€™, â€˜Fogâ€™ and so on. For simplicity, we consider all days that does not have a weather event (<code>weather.events = '\N'</code>) as a single type of weather. Here a trip belongs to a date only if its start time is on that date. We use the weather at the starting position of that trip as its weather type as well. There are also â€˜Rainâ€™ and â€˜rainâ€™ in weather.events. For simplicity, we consider them as different types of weathers. When counting the total number of days for a weather, we consider a weather happened on a date as long as it happened in at least one region on that date.</p>
<p>Details: Print the name of the weather and the average number of trips made per day on that type of weather (round to <code>four</code> decimal places using <code>ROUND()</code>). Sort by the average number of trips (decreasing), then weather name (increasing).</p>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> weather_days(<span class="keyword">events</span>, cnt) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> w.events, <span class="keyword">count</span>(<span class="keyword">distinct</span> w.date) <span class="keyword">as</span> cnt </span><br><span class="line">    <span class="keyword">from</span> weather w </span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> w.events</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> w.events, <span class="keyword">round</span>(<span class="keyword">cast</span>(<span class="keyword">count</span>(<span class="keyword">distinct</span> t.id) <span class="keyword">as</span> <span class="built_in">float</span>)/<span class="keyword">cast</span>(wd.cnt <span class="keyword">as</span> <span class="built_in">float</span>), <span class="number">4</span>) <span class="keyword">as</span> <span class="keyword">avg</span> </span><br><span class="line"><span class="keyword">from</span> trip t, station s, weather w, weather_days wd</span><br><span class="line"><span class="keyword">where</span> t.start_station_id = s.station_id <span class="keyword">and</span> s.zip_code = w.zip_code <span class="keyword">and</span> <span class="built_in">date</span>(t.start_time) = w.date <span class="keyword">and</span> w.events = wd.events</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> w.events</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">avg</span> <span class="keyword">desc</span>, w.events <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>(æˆ‘çœ‹å®Œç­”æ¡ˆæ‰ç†è§£è¿™é¢˜çš„æ„æ€: When counting the total number of days for a weather, we consider a weather happened on a date as long as it happened in at least one region on that date.)</p>
<h1 id="Q9"><a href="#Q9" class="headerlink" title="Q9"></a>Q9</h1><p>A short trip is a trip whose duration is <code>&lt;= 60 seconds</code>. Compute the average temperature that a short trip starts versus the average temperature that a non-short trip starts. We use weather.mean_temp on the date of the start time as the Temperature measurement.</p>
<p>Details: Print the average temperature that a short trip starts and the average temperature that a non-short trip starts. (on the same row, and both round to <code>four</code> decimal places using <code>ROUND()</code>) <code>Please refer to the updated note before Q1 when calculating the duration of a trip.</code></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> shortT <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(w.mean_temp) <span class="keyword">as</span> <span class="keyword">avg</span></span><br><span class="line">    <span class="keyword">from</span> trip t, station s, weather w</span><br><span class="line">    <span class="keyword">where</span> <span class="built_in">date</span>(t.start_time) = w.date <span class="keyword">and</span></span><br><span class="line">          strftime(<span class="string">'%s'</span>, end_time) - strftime(<span class="string">'%s'</span>, start_time) &lt;= <span class="number">60</span> <span class="keyword">and</span></span><br><span class="line">          t.start_station_id = s.station_id <span class="keyword">and</span></span><br><span class="line">          s.zip_code = w.zip_code),</span><br><span class="line">     non_shortT <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(w.mean_temp) <span class="keyword">as</span> <span class="keyword">avg</span></span><br><span class="line">    <span class="keyword">from</span> trip t, station s, weather w</span><br><span class="line">    <span class="keyword">where</span> <span class="built_in">date</span>(t.start_time) = w.date <span class="keyword">and</span></span><br><span class="line">          strftime(<span class="string">'%s'</span>, end_time) - strftime(<span class="string">'%s'</span>, start_time) &gt; <span class="number">60</span> <span class="keyword">and</span></span><br><span class="line">          t.start_station_id = s.station_id <span class="keyword">and</span></span><br><span class="line">          s.zip_code = w.zip_code</span><br><span class="line">     )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">ROUND</span>(s.avg, <span class="number">4</span>), <span class="keyword">ROUND</span>(ns.avg, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">from</span> shortT s, non_shortT ns;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">round</span>(x.avg, <span class="number">4</span>), <span class="keyword">round</span>(y.avg, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(mean_temp) <span class="keyword">as</span> <span class="keyword">avg</span></span><br><span class="line">    <span class="keyword">from</span> weather, station, trip</span><br><span class="line">    <span class="keyword">where</span> <span class="built_in">date</span>(start_time) = <span class="built_in">date</span> <span class="keyword">and</span></span><br><span class="line">          strftime(<span class="string">'%s'</span>, end_time) - strftime(<span class="string">'%s'</span>, start_time) &lt;= <span class="number">60</span> <span class="keyword">and</span></span><br><span class="line">          start_station_id = station_id <span class="keyword">and</span></span><br><span class="line">          station.zip_code = weather.zip_code) <span class="keyword">as</span> x,</span><br><span class="line">     (<span class="keyword">select</span> <span class="keyword">avg</span>(mean_temp) <span class="keyword">as</span> <span class="keyword">avg</span></span><br><span class="line">     <span class="keyword">from</span> weather, station, trip</span><br><span class="line">     <span class="keyword">where</span> <span class="built_in">date</span>(start_time) = <span class="built_in">date</span> <span class="keyword">and</span></span><br><span class="line">           strftime(<span class="string">'%s'</span>, end_time) - strftime(<span class="string">'%s'</span>, start_time) &gt; <span class="number">60</span> <span class="keyword">and</span></span><br><span class="line">           start_station_id = station_id <span class="keyword">and</span> station.zip_code = weather.zip_code) <span class="keyword">as</span> y;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q10"><a href="#Q10" class="headerlink" title="Q10"></a>Q10</h1><p>For each zip code that has experienced â€˜Rain-Thunderstormâ€™ weather, find the station that has the most number of trips in that zip code under the storm weather. For simplicity, we only consider the start time of a trip when deciding the station and the weather for that trip.</p>
<p>Details: Print the zip code that has experienced the â€˜Rain-Thunderstormâ€™ weather, the name of the station that has the most number of trips under the strom weather in that zip code, and the total number of trips that station has under the storm weather. Sort by the zip code (increasing). You do not need to print the zip code that has experienced â€˜Rain-Thunderstormâ€™ weather but no trip happens on any storm day in that zip code.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.zip_code, s.station_name, <span class="keyword">count</span>(<span class="keyword">distinct</span> t.id) <span class="keyword">as</span> num_trips</span><br><span class="line"><span class="keyword">from</span> weather w, station s, trip t</span><br><span class="line"><span class="keyword">where</span> w.events = <span class="string">'Rain-Thunderstorm'</span> <span class="keyword">and</span></span><br><span class="line">      w.date = <span class="built_in">date</span>(t.start_time) <span class="keyword">and</span></span><br><span class="line">      s.station_id = t.start_station_id <span class="keyword">and</span></span><br><span class="line">      s.zip_code = w.zip_code</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.zip_code, s.station_name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_trips <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> storm_count(zip_code, station_id, station_name, cnt) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> station.zip_code, station_id, station_name, <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">from</span> weather, station, trip</span><br><span class="line">    <span class="keyword">where</span> <span class="built_in">date</span>(start_time) = <span class="built_in">date</span> <span class="keyword">and</span></span><br><span class="line">          <span class="keyword">events</span> = <span class="string">'Rain-Thunderstorm'</span> <span class="keyword">and</span></span><br><span class="line">          start_station_id = station_id <span class="keyword">and</span></span><br><span class="line">          station.zip_code = weather.zip_code</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> station.zip_code, station_id)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> zip_code, station_name, cnt</span><br><span class="line"><span class="keyword">from</span> storm_count</span><br><span class="line"><span class="keyword">where</span> cnt = (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">max</span>(max_count.cnt)</span><br><span class="line">    <span class="keyword">from</span> storm_count <span class="keyword">as</span> max_count</span><br><span class="line">    <span class="keyword">where</span> max_count.zip_code = storm_count.zip_code)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> zip_code <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>(æˆ‘è§‰å¾—ç­”æ¡ˆè¿‡äºå¤æ‚äº†ï¼Œæ²¡æœ‰å¿…è¦ç”Ÿæˆæ‰€æœ‰çš„ä¸­é—´ç»“æœï¼Œå†æœ€åå’Œmax join)</p>
<p><br><br><br></p>
<p>è¿™æ¬¡æœ€éš¾çš„é¢˜ï¼Œè‚¯å®šæ˜¯ç¬¬äº”é¢˜ï¼</p>
<p>è¿™é‡Œæœ‰åˆ«äººçš„ç­”æ¡ˆï¼Œä¹Ÿå¯ä»¥å€Ÿé‰´ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9mNjg4ZjBhNGVhZjk=" title="https://www.jianshu.com/p/f688f0a4eaf9">https://www.jianshu.com/p/f688f0a4eaf9<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>SQLite</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]HomeWork1_19Fall</title>
    <url>/2020/03/07/CMU-15445-HomeWork1-19Fall/</url>
    <content><![CDATA[<p>2019 Fall: HOMEWORK #1 - SQL</p>
<p>Homework: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvaG9tZXdvcmsxLw==" title="https://15445.courses.cs.cmu.edu/fall2019/homework1/">https://15445.courses.cs.cmu.edu/fall2019/homework1/<i class="fa fa-external-link"></i></span><br>Solution: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvZmlsZXMvaHcxLXNvbHMudGFyLmd6" title="https://15445.courses.cs.cmu.edu/fall2019/files/hw1-sols.tar.gz">https://15445.courses.cs.cmu.edu/fall2019/files/hw1-sols.tar.gz<i class="fa fa-external-link"></i></span></p>
<a id="more"></a>
<p>CMUæ¨èä½¿ç”¨ SQLite: <span class="exturl" data-url="aHR0cHM6Ly93d3cuc3FsaXRlLm9yZy9pbmRleC5odG1s" title="https://www.sqlite.org/index.html">https://www.sqlite.org/index.html<i class="fa fa-external-link"></i></span></p>
<p>å·²æ£€æŸ¥è¿‡æˆ‘çš„è§£æ³•å’Œç­”æ¡ˆç”Ÿæˆçš„ç»“æœä¸€æ ·ã€‚</p>
<!-- TODO: link æ–‡ç«  SQLITE å®‰è£… å’ŒSQLITEæ•°æ®é›† -->
<h1 id="ç†Ÿæ‚‰æ•°æ®é›†"><a href="#ç†Ÿæ‚‰æ•°æ®é›†" class="headerlink" title="ç†Ÿæ‚‰æ•°æ®é›†"></a>ç†Ÿæ‚‰æ•°æ®é›†</h1><p><span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvaG9tZXdvcmsxLw==" title="https://15445.courses.cs.cmu.edu/fall2019/homework1/">https://15445.courses.cs.cmu.edu/fall2019/homework1/<i class="fa fa-external-link"></i></span>  -&gt; CHECK THE SCHEMA</p>
<h1 id="Q1"><a href="#Q1" class="headerlink" title="Q1"></a>Q1</h1><p>The purpose of this query is to make sure that the formatting of your output matches exactly the formatting of our auto-grading script.</p>
<p>Details: List all distinct types of titles ordered by type.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span>(<span class="keyword">type</span>) </span><br><span class="line"><span class="keyword">from</span> titles </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">type</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q2"><a href="#Q2" class="headerlink" title="Q2"></a>Q2</h1><p>List the longest title of each type along with the runtime minutes.</p>
<p>Details: Find the titles which are the longest by runtime minutes. There might be cases where there is a tie for the longest titles - in that case return all of them. Display the types, primary titles and runtime minutes, and order it according to type (ascending) and use primary titles (ascending) as tie-breaker.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> longestINtype <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">max</span>(runtime_minutes) <span class="keyword">as</span> <span class="keyword">max</span>, <span class="keyword">type</span></span><br><span class="line">    <span class="keyword">from</span> titles</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">type</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> t.type, t.primary_title, t.runtime_minutes</span><br><span class="line"><span class="keyword">from</span> titles t, longestINtype l</span><br><span class="line"><span class="keyword">where</span> t.runtime_minutes = l.max <span class="keyword">and</span> t.type = l.type</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> t.type <span class="keyword">asc</span>, t.primary_title <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> types(<span class="keyword">type</span>, runtime_minutes) <span class="keyword">AS</span> ( </span><br><span class="line">  <span class="keyword">SELECT</span> <span class="keyword">type</span>, <span class="keyword">MAX</span>(runtime_minutes)</span><br><span class="line">    <span class="keyword">FROM</span> titles</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">type</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> titles.type, titles.primary_title, titles.runtime_minutes</span><br><span class="line"><span class="keyword">FROM</span> titles</span><br><span class="line"><span class="keyword">JOIN</span> types</span><br><span class="line"><span class="keyword">ON</span> titles.runtime_minutes == types.runtime_minutes <span class="keyword">AND</span> titles.type == types.type</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> titles.type, titles.primary_title;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q3"><a href="#Q3" class="headerlink" title="Q3"></a>Q3</h1><p>List all types of titles along with the number of associated titles.<br>Details: Print type and number of associated titles. For example, <code>tvShort|4075</code>. Sort by number of titles in ascending order.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">type</span>, <span class="keyword">count</span>(*) <span class="keyword">as</span> counter</span><br><span class="line"><span class="keyword">from</span> titles</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">type</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> counter <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">type</span>, <span class="keyword">count</span>(*) <span class="keyword">AS</span> title_count <span class="keyword">FROM</span> titles <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">type</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> title_count <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q4"><a href="#Q4" class="headerlink" title="Q4"></a>Q4</h1><p>Which decades saw the most number of titles getting premiered? List the number of titles in every decade. Like <code>2010s|2789741</code>.</p>
<p>Details: Print all decades and the number of titles. Print the relevant decade in a fancier format by constructing a string that looks like this: <code>2010s</code>. Sort the decades in decreasing order with respect to the number of titles. Remember to exclude titles which have not been premiered (i.e. where <code>premiered</code> is <code>NULL</code>)</p>
<p>PS: Add this to your watchlist: <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW1kYi5jb20vdGl0bGUvdHQ1MTc0NjQwLw==" title="https://www.imdb.com/title/tt5174640/">100 Years (2115)<i class="fa fa-external-link"></i></span></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> premieredASchar (title_id, pre) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> title_id, <span class="keyword">cast</span>(premiered <span class="keyword">as</span> <span class="built_in">char</span>(<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">from</span> titles</span><br><span class="line">    <span class="keyword">where</span> premiered <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    ),</span><br><span class="line">     premieredDecades (title_id, decade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> title_id, <span class="keyword">substr</span>(pre, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">from</span> premieredASchar</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> decade || <span class="string">'0s'</span> <span class="keyword">as</span> decade, <span class="keyword">count</span>(<span class="keyword">distinct</span> title_id) <span class="keyword">as</span> num_mov</span><br><span class="line"><span class="keyword">from</span> premieredDecades</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> decade</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_mov <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æˆ‘çš„æ€è·¯ï¼š<ul>
<li>å°†ä¸æ˜¯<code>NULL</code>çš„<code>premiered</code>è§†ä½œä¸€ä¸ªå›ºå®šé•¿åº¦ä¸º4çš„<code>CHAR</code></li>
<li>å°†è¿™ä¸ª<code>CHAR</code>çš„æœ€åä¸€ä¸ªå­—ç¬¦æŠ¹å»</li>
<li>ç„¶ååŒä¸€ä¸ªdecadeçš„tupleä¼šè¢« <code>GROUP BY</code> è¿›ä¸€ä¸ªç»„ (ä¾‹å¦‚<code>2015</code> -&gt; <code>201</code>, è¿™ä¸ª<code>201</code>å°±æ˜¯æˆ‘ä»¬çš„Hash Key/Hash Bucket)</li>
<li>Hash Function: $f(char[0:3]) = char[0:2]$</li>
</ul>
</li>
</ul>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"><span class="keyword">CAST</span>(premiered/<span class="number">10</span>*<span class="number">10</span> <span class="keyword">AS</span> <span class="built_in">TEXT</span>) || <span class="string">'s'</span> <span class="keyword">AS</span> decade,</span><br><span class="line"><span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> num_movies</span><br><span class="line"><span class="keyword">FROM</span> titles</span><br><span class="line"><span class="keyword">WHERE</span> premiered <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> decade</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> num_movies <span class="keyword">DESC</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç­”æ¡ˆæ€è·¯ç±»ä¼¼ï¼Œåªæ˜¯å°†<code>premiered</code>åš<code>INTEGER</code>åšæ•°å€¼è¿ç®—</li>
</ul>
<h1 id="Q5"><a href="#Q5" class="headerlink" title="Q5"></a>Q5</h1><p>List the decades and the percentage of titles which premiered in the corresponding decade. Display like : <code>2010s|45.7042</code></p>
<p>Details: The percentage of titles for a decade is the number of titles which premiered that decade divided by the total number of titles. For the total number of titles, count all titles including ones that have not been premiered. Round the percentage to four decimal places using <code>ROUND()</code>.</p>
<p>(è¿™é¢˜å®Œå…¨åŸºäºQ4)</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> premieredASchar (title_id, pre) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> title_id, <span class="keyword">cast</span>(premiered <span class="keyword">as</span> <span class="built_in">char</span>(<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">from</span> titles</span><br><span class="line">    <span class="keyword">where</span> premiered <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    ),</span><br><span class="line">     premieredDecades (title_id, decade) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> title_id, <span class="keyword">substr</span>(pre, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">from</span> premieredASchar</span><br><span class="line">    ),</span><br><span class="line">     num_title (<span class="keyword">num</span>) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">from</span> titles</span><br><span class="line">     )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> p.decade || <span class="string">'0s'</span> <span class="keyword">as</span> decade,</span><br><span class="line">       <span class="keyword">ROUND</span>(<span class="number">100.0</span> * <span class="keyword">count</span>(<span class="keyword">distinct</span> p.title_id) / n.num, <span class="number">4</span>) <span class="keyword">as</span> percentage</span><br><span class="line"><span class="keyword">from</span> premieredDecades p, num_title n</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> p.decade</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> percentage <span class="keyword">desc</span>, p.decade <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"><span class="keyword">CAST</span>(premiered/<span class="number">10</span>*<span class="number">10</span> <span class="keyword">AS</span> <span class="built_in">TEXT</span>) || <span class="string">'s'</span> <span class="keyword">AS</span> decade,</span><br><span class="line"><span class="keyword">ROUND</span>(<span class="keyword">CAST</span>(<span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="built_in">REAL</span>) / (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> titles) * <span class="number">100.0</span>, <span class="number">4</span>) <span class="keyword">as</span> percentage</span><br><span class="line"><span class="keyword">FROM</span> titles</span><br><span class="line"><span class="keyword">WHERE</span> premiered <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> decade</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> percentage <span class="keyword">DESC</span>, decade <span class="keyword">ASC</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q6"><a href="#Q6" class="headerlink" title="Q6"></a>Q6</h1><p>List the top 10 dubbed titles with the number of dubs.</p>
<p>Details: Count the number of titles in <code>akas</code> for each title in the <code>titles</code> table, and list only the top ten. Print the primary title and the number of corresponding dubbed movies.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t.primary_title, <span class="keyword">count</span>(a.title) <span class="keyword">as</span> num_dubs</span><br><span class="line"><span class="keyword">from</span> akas a, titles t</span><br><span class="line"><span class="keyword">where</span> a.title_id = t.title_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t.title_id, t.primary_title</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_dubs <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> translations <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> title_id, <span class="keyword">count</span>(*) <span class="keyword">as</span> num_translations</span><br><span class="line">    <span class="keyword">FROM</span> akas</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> title_id</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> num_translations <span class="keyword">DESC</span>, title_id</span><br><span class="line">    <span class="keyword">LIMIT</span> <span class="number">10</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> titles.primary_title, translations.num_translations</span><br><span class="line"><span class="keyword">FROM</span> translations</span><br><span class="line"><span class="keyword">JOIN</span> titles</span><br><span class="line"><span class="keyword">ON</span> titles.title_id == translations.title_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> translations.num_translations <span class="keyword">DESC</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q7"><a href="#Q7" class="headerlink" title="Q7"></a>Q7</h1><p>List the IMDB Top 250 movies along with its weighted rating.</p>
<p>Details: The weighted rating of a movie is calculated according to the following formula:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">Weighted rating (WR) = (v/(v+m)) * R + (m/(v+m)) * C</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>R = average rating for the movie (mean), i.e. ratings.rating</li>
<li>v = number of votes for the movie, i.e. ratings.votes</li>
<li>m = minimum votes required to be listed in the Top 250 (current 25000)</li>
<li>C = weighted average rating of all movies</li>
</ul>
<p>Print the movie name along with its weighted rating. For example: <code>The Shawshank Redemption|9.27408375213064</code>.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> C (val) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">sum</span>(r.rating * r.votes) / <span class="keyword">sum</span>(votes)</span><br><span class="line">    <span class="keyword">from</span> ratings r, titles t</span><br><span class="line">    <span class="keyword">where</span> t.title_id = r.title_id <span class="keyword">and</span> t.type = <span class="string">'movie'</span></span><br><span class="line">), WR (primary_title, val) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> t.primary_title,</span><br><span class="line">           (r.votes / (r.votes + <span class="number">25000.0</span>)) * r.rating + (<span class="number">25000.0</span> / (r.votes + <span class="number">25000.0</span>)) * c.val</span><br><span class="line">    <span class="keyword">from</span> ratings r, titles t, c</span><br><span class="line">    <span class="keyword">where</span> t.title_id = r.title_id <span class="keyword">and</span> t.type = <span class="string">'movie'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> WR</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> val <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">250</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span></span><br><span class="line">  av(average_rating) <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">SUM</span>(rating * votes) / <span class="keyword">SUM</span>(votes)</span><br><span class="line">      <span class="keyword">FROM</span> ratings</span><br><span class="line">      <span class="keyword">JOIN</span> titles</span><br><span class="line">      <span class="keyword">ON</span> titles.title_id == ratings.title_id <span class="keyword">AND</span> titles.type == <span class="string">"movie"</span></span><br><span class="line">  ),</span><br><span class="line">  mn(min_rating) <span class="keyword">AS</span> (<span class="keyword">SELECT</span> <span class="number">25000.0</span>)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">primary_title,</span><br><span class="line">(votes / (votes + min_rating)) * rating + (min_rating / (votes + min_rating)) * average_rating <span class="keyword">as</span> weighed_rating</span><br><span class="line"><span class="keyword">FROM</span> ratings, av, mn</span><br><span class="line"><span class="keyword">JOIN</span> titles</span><br><span class="line"><span class="keyword">ON</span> titles.title_id == ratings.title_id <span class="keyword">and</span> titles.type == <span class="string">"movie"</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> weighed_rating <span class="keyword">DESC</span></span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">250</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q8"><a href="#Q8" class="headerlink" title="Q8"></a>Q8</h1><p>List the number of actors / actresses who have appeared in any title with Mark Hamill (born in 1951).</p>
<p>Details: Print only the total number of actors and actresses. The answer should include Mark Hamill himself.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> c.person_id)</span><br><span class="line"><span class="keyword">from</span> people mh, crew c_mh, crew c</span><br><span class="line"><span class="keyword">where</span> mh.name = <span class="string">'Mark Hamill'</span> <span class="keyword">and</span> mh.born = <span class="number">1951</span> <span class="keyword">and</span></span><br><span class="line">      mh.person_id = c_mh.person_id <span class="keyword">and</span></span><br><span class="line">      c_mh.title_id = c.title_id <span class="keyword">and</span></span><br><span class="line">      (c.category = <span class="string">'actor'</span> <span class="keyword">or</span> c.category = <span class="string">'actress'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> hamill_titles <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>(crew.title_id)</span><br><span class="line">    <span class="keyword">FROM</span> people</span><br><span class="line">    <span class="keyword">JOIN</span> crew</span><br><span class="line">    <span class="keyword">ON</span> crew.person_id == people.person_id <span class="keyword">AND</span> people.name == <span class="string">"Mark Hamill"</span> <span class="keyword">AND</span> people.born == <span class="number">1951</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span>(crew.person_id))</span><br><span class="line"><span class="keyword">FROM</span> crew</span><br><span class="line"><span class="keyword">WHERE</span> (crew.category == <span class="string">"actor"</span> <span class="keyword">OR</span> crew.category == <span class="string">"actress"</span>) <span class="keyword">AND</span> crew.title_id <span class="keyword">in</span> hamill_titles;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Q9"><a href="#Q9" class="headerlink" title="Q9"></a>Q9</h1><p>List the number of actors / actresses who have appeared in any title with Mark Hamill (born in 1951).</p>
<p>Details: Print only the total number of actors and actresses. The answer should include Mark Hamill himself.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> t.primary_title</span><br><span class="line"><span class="keyword">from</span> people mh, crew c_mh, people gl, crew c_gl, titles t</span><br><span class="line"><span class="keyword">where</span> mh.name = <span class="string">'Mark Hamill'</span> <span class="keyword">and</span> mh.born = <span class="number">1951</span> <span class="keyword">and</span> mh.person_id = c_mh.person_id <span class="keyword">and</span></span><br><span class="line">      gl.name = <span class="string">'George Lucas'</span> <span class="keyword">and</span> gl.born = <span class="number">1944</span> <span class="keyword">and</span> gl.person_id = c_gl.person_id <span class="keyword">and</span></span><br><span class="line">      c_mh.title_id = t.title_id <span class="keyword">and</span></span><br><span class="line">      c_gl.title_id = t.title_id <span class="keyword">and</span></span><br><span class="line">      t.type = <span class="string">'movie'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> t.primary_title <span class="keyword">asc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> hamill_movies(title_id) <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> crew.title_id</span><br><span class="line">    <span class="keyword">FROM</span> crew</span><br><span class="line">    <span class="keyword">JOIN</span> people</span><br><span class="line">    <span class="keyword">ON</span> crew.person_id == people.person_id <span class="keyword">AND</span> people.name == <span class="string">"Mark Hamill"</span> <span class="keyword">AND</span> people.born == <span class="number">1951</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> titles.primary_title</span><br><span class="line"><span class="keyword">FROM</span> crew</span><br><span class="line"><span class="keyword">JOIN</span> people</span><br><span class="line"><span class="keyword">ON</span> crew.person_id == people.person_id <span class="keyword">AND</span> people.name == <span class="string">"George Lucas"</span> <span class="keyword">AND</span> people.born == <span class="number">1944</span> <span class="keyword">AND</span> crew.title_id <span class="keyword">IN</span> hamill_movies</span><br><span class="line"><span class="keyword">JOIN</span> titles</span><br><span class="line"><span class="keyword">ON</span> crew.title_id == titles.title_id <span class="keyword">AND</span> titles.type == <span class="string">"movie"</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> titles.primary_title;</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="https://upload.wikimedia.org/wikipedia/en/3/3c/SW_-_Empire_Strikes_Back.jpg" alt="The Empire Strikes Back"><br>â€” <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVGhlX0VtcGlyZV9TdHJpa2VzX0JhY2sjL21lZGlhL0ZpbGU6U1dfLV9FbXBpcmVfU3RyaWtlc19CYWNrLmpwZw==" title="https://en.wikipedia.org/wiki/The_Empire_Strikes_Back#/media/File:SW_-_Empire_Strikes_Back.jpg">https://en.wikipedia.org/wiki/The_Empire_Strikes_Back#/media/File:SW_-_Empire_Strikes_Back.jpg<i class="fa fa-external-link"></i></span></p>
<h1 id="Q10"><a href="#Q10" class="headerlink" title="Q10"></a>Q10</h1><p>List all distinct genres and the number of titles associated with them.</p>
<p>Details: The <code>titles</code> table contains the titles with their genres. Each title is associated with zero or more genres stored in the <code>genres</code> column as comma-separated values (like â€œDocumentary,Shortâ€). Count the number of titles associated with each genre, and list the genres and the counts, and order it according to the counts (greatest to least). Donâ€™t forget to filter empty genres (where <code>genres</code> is blank).</p>
<p>Hint: You might find <span class="exturl" data-url="aHR0cHM6Ly9zcWxpdGUub3JnL2xhbmdfd2l0aC5odG1s" title="https://sqlite.org/lang_with.html">CTEs<i class="fa fa-external-link"></i></span> useful.</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> genres <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span> genres <span class="keyword">as</span> g</span><br><span class="line">    <span class="keyword">from</span> titles</span><br><span class="line">    <span class="keyword">where</span> genres != <span class="string">'\N'</span></span><br><span class="line">    ),</span><br><span class="line">     <span class="keyword">split</span>(word, <span class="keyword">str</span>) <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">''</span>, g || <span class="string">','</span></span><br><span class="line">    <span class="keyword">from</span> genres</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        <span class="keyword">substr</span>(<span class="keyword">str</span>, <span class="number">0</span>, <span class="keyword">instr</span>(<span class="keyword">str</span>, <span class="string">','</span>)),</span><br><span class="line">        <span class="keyword">substr</span>(<span class="keyword">str</span>, <span class="keyword">instr</span>(<span class="keyword">str</span>, <span class="string">','</span>) + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">from</span> <span class="keyword">split</span></span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">str</span> != <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> word, <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">count</span></span><br><span class="line"><span class="keyword">from</span> <span class="keyword">split</span></span><br><span class="line"><span class="keyword">where</span> word != <span class="string">''</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> word</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span> <span class="keyword">desc</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ç­”æ¡ˆï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> <span class="keyword">split</span>(genre, rest) <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> <span class="string">''</span>, genres || <span class="string">','</span> <span class="keyword">FROM</span> titles <span class="keyword">WHERE</span> genres != <span class="string">"\N"</span></span><br><span class="line">   <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">  <span class="keyword">SELECT</span> <span class="keyword">substr</span>(rest, <span class="number">0</span>, <span class="keyword">instr</span>(rest, <span class="string">','</span>)),</span><br><span class="line">         <span class="keyword">substr</span>(rest, <span class="keyword">instr</span>(rest, <span class="string">','</span>)+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">FROM</span> <span class="keyword">split</span></span><br><span class="line">   <span class="keyword">WHERE</span> rest != <span class="string">''</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> genre, <span class="keyword">count</span>(*) <span class="keyword">as</span> genre_count</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">split</span> </span><br><span class="line"><span class="keyword">WHERE</span> genre != <span class="string">''</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> genre</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> genre_count <span class="keyword">DESC</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªæœ€åä¸€é¢˜èŠ±äº†æˆ‘åŠä¸ªå°æ—¶ï¼Œå› ä¸ºSQLite æ²¡æœ‰<code>string split</code>ç±»å‹çš„åº“å‡½æ•°ï¼Œæˆ‘å‚è€ƒäº†ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMjQyNTg4NzgvaG93LXRvLXNwbGl0LWNvbW1hLXNlcGFyYXRlZC12YWx1ZS1pbi1zcWxpdGU=" title="https://stackoverflow.com/questions/24258878/how-to-split-comma-separated-value-in-sqlite">https://stackoverflow.com/questions/24258878/how-to-split-comma-separated-value-in-sqlite<i class="fa fa-external-link"></i></span></p>
<p>æˆ‘å¾ˆæ€€ç–‘ç­”æ¡ˆä¹Ÿå‚è€ƒè¿™ä¸ªé¡µé¢ï¼Œå› ä¸ºç»“æ„å®Œå…¨ç±»ä¼¼ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">ğŸ˜‚</span></p>
<p>å¦å¤–å®ådissè¿™ä¸ªè¡¨æ ¼ä¸ç¬¦åˆ <code>1NF: ç¬¬ä¸€èŒƒå¼</code>ï¼š <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU2JTk1JUIwJUU2JThEJUFFJUU1JUJBJTkzJUU4JUE3JTg0JUU4JThDJTgzJUU1JThDJTk2" title="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A7%84%E8%8C%83%E5%8C%96">https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A7%84%E8%8C%83%E5%8C%96<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>SQLite</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]Lec02_part2 Advanced SQL - é«˜çº§SQL</title>
    <url>/2020/03/06/CMU-15445-Lec02-part2/</url>
    <content><![CDATA[<p>Advanced SQL é«˜çº§SQL</p>
<p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzAyLWFkdmFuY2Vkc3FsLnBkZg==" title="https://15445.courses.cs.cmu.edu/fall2019/slides/02-advancedsql.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/02-advancedsql.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDItYWR2YW5jZWRzcWwucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/02-advancedsql.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/02-advancedsql.pdf<i class="fa fa-external-link"></i></span><br>Reading: Chapters 3-5</p>
<p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¼šäº†è§£é«˜çº§çš„SQLå¥æ³•ã€‚(ä½†æ˜¯å®é™…ä¸Šè¿™é—¨è¯¾å¯¹SQLçš„è¦æ±‚å¾ˆä½ï¼Œå¤§é‡å…¶ä»–çš„SQLç»ƒä¹ ä¾æ—§å¯ä»¥åœ¨æˆ‘çš„åšå®¢ä¸­æ‰¾åˆ°)</p>
<p>å¦‚æœå¤§å®¶çš„ç›®çš„æ˜¯ä¸ºäº†å­¦ä¹ SQLï¼Œæˆ‘å»ºè®®ä½¿ç”¨PostgreSQLï¼Œå®ƒå‡ºè‡ªäºå­¦æœ¯ç•Œï¼Œæ•´ä½“è¡Œä¸ºç›¸å¯¹MySQLå’ŒSQLiteæ›´åˆç†ã€‚å¦å¤–TUMå’ŒCMUåœ¨SQLæ•™å­¦ä¸Šéƒ½é‡‡ç”¨PostgreSQLã€‚</p>
<p>æˆ‘å°†è¿™æ¬¡ç¬”è®°åˆ†æˆå‰åä¸¤ä¸ªéƒ¨åˆ†ï¼Œè¿™æ˜¯ç¬¬äºŒéƒ¨åˆ†ã€‚</p>
<!-- å¯¹åº”çš„ç»ƒä¹ ã€€TODO:æˆ‘çš„åšå®¢ -->
<a id="more"></a>
<h1 id="OUTPUT-REDIRECTION"><a href="#OUTPUT-REDIRECTION" class="headerlink" title="OUTPUT REDIRECTION"></a>OUTPUT REDIRECTION</h1><p><img data-src="/images/CMU1544564/Lec02/29.jpg" alt="29.jpg"></p>
<ul>
<li><code>INTO</code> ç›¸å½“äº <code>create table</code> on the fly (æŒ‡è¯¥SQLæŸ¥è¯¢æ‰§è¡Œçš„è¿‡ç¨‹ä¸­)</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec02/30.jpg" alt="30.jpg"></p>
<p><br></p>
<h1 id="OUTPUT-CONTROL"><a href="#OUTPUT-CONTROL" class="headerlink" title="OUTPUT CONTROL"></a>OUTPUT CONTROL</h1><h2 id="ORDER-BY"><a href="#ORDER-BY" class="headerlink" title="ORDER BY"></a><code>ORDER BY</code></h2><p><img data-src="/images/CMU1544564/Lec02/32.jpg" alt="32.jpg"></p>
<h2 id="LIMIT-OFFSET"><a href="#LIMIT-OFFSET" class="headerlink" title="LIMIT OFFSET"></a><code>LIMIT</code> <code>OFFSET</code></h2><p><img data-src="/images/CMU1544564/Lec02/34.jpg" alt="34.jpg"></p>
<ul>
<li><code>LIMIT 10</code>: å¾—åˆ°å‰$[1, 10]$ä¸ªtuple</li>
<li><code>LIMIT 20 OFFSET 10</code>: å¾—åˆ°å‰$[10 + 1, 10 + 20]$ä¸ªtuple, å³å‰$[11, 30]$ä¸ªtuple, å…±20ä¸ªtupleã€‚</li>
</ul>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼š<code>LIMIT</code>èƒ½ä¿è¯ç»™å‡ºå¯¹åº”çš„tupleæ•°é‡ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯è¿è¡Œ<strong>åŒä¸€æ¡</strong>å¸¦<code>LIMIT</code>è€Œä¸å¸¦<code>ORDER BY</code>çš„SQLå¤šæ¬¡ï¼Œæ€»èƒ½å¾—åˆ°åŒæ ·çš„ç»“æœã€‚</p>
<p><strong>æ³¨æ„<code>LIMIT</code>å¹¶ä¸æ˜¯SQL Standardï¼Œä½†æ˜¯æœ‰SQL Standardçš„ç­‰ä»·è¯­å¥å»åšåŒä¸€ä»¶äº‹æƒ…ã€‚<code>LIMIT</code>ä¹Ÿè¢«å¤§éƒ¨åˆ†DBMSsæ‰€é‡‡ç”¨ã€‚</strong></p>
<!-- TODO: -->
<p><br></p>
<h1 id="NESTED-QUERIES"><a href="#NESTED-QUERIES" class="headerlink" title="NESTED QUERIES"></a>NESTED QUERIES</h1><p>æˆ‘åœ¨æˆ‘çš„åšå®¢ä¸­æ‰€æœ‰ <a href="https://cakebytheoceanluo.github.io/categories/SQL/">ä¸­çº§SQL</a> çš„æ–‡ç« éƒ½å’ŒNested Queryæœ‰å…³ï¼Œä½ å¯ä»¥è·å¾—å¤§é‡çš„ç»ƒä¹ ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec02/35.jpg" alt="35.jpg"></p>
<h2 id="ä¾‹å­ï¼š-Get-the-names-of-students-in-â€˜15-445â€™"><a href="#ä¾‹å­ï¼š-Get-the-names-of-students-in-â€˜15-445â€™" class="headerlink" title="ä¾‹å­ï¼š Get the names of students in â€˜15-445â€™"></a>ä¾‹å­ï¼š Get the names of students in â€˜15-445â€™</h2><p><img data-src="/images/CMU1544564/Lec02/36.jpg" alt="36.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/37.jpg" alt="37.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/39.jpg" alt="39.jpg"></p>
<p>æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åœ°ç”¨Nested Queryå®Œæˆäº†è¿™ä¸ªä¾‹å­ã€‚</p>
<p>å®é™…ä¸Šå®ƒä¼šè¢«å¤„ç†æˆä¸€ä¸ªJoin: </p>
<ul>
<li>Outer Queryæœ‰<code>sid</code>è¿™ä¸ªå­—æ®µ, ä¼ é€’ç»™Inner Query</li>
<li>Inner Queryæ¥å—Outer Queryçš„<code>sid</code>å­—æ®µï¼Œç„¶ååœ¨<code>enrolled</code>è¿™ä¸ªè¡¨æ ¼é‡Œé¢æ£€æŸ¥ã€‚</li>
<li>å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬å‘ç°Outer Query å’Œ Inner Queryæœ‰ç€æŸç§ä¾èµ–ï¼Œæˆ‘ä»¬ç§°è¿™æ ·çš„ä¸º Dependent Join.</li>
<li>æ•°æ®åº“å¦‚ä½•é«˜æ•ˆå¤„ç†è¿™ç§ã€€Dependent Joinï¼šã€€è§ä¸€ç¯‡è®ºæ–‡è§£è¯»ã€€<a href="https://cakebytheoceanluo.github.io/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/">[Paper]BTW 2015 | Unnesting Arbitrary Queries</a></li>
</ul>
<h3 id="ALL-ANY-IN-EXISTS"><a href="#ALL-ANY-IN-EXISTS" class="headerlink" title="ALL, ANY, IN, EXISTS"></a><code>ALL</code>, <code>ANY</code>, <code>IN</code>, <code>EXISTS</code></h3><p><img data-src="/images/CMU1544564/Lec02/40.jpg" alt="40.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/41.jpg" alt="41.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/42.jpg" alt="42.jpg"></p>
<p><br></p>
<h2 id="ä¾‹å­ï¼š-Student-record-with-the-highest-id-that-is-enrolled-in-at-least-one-course"><a href="#ä¾‹å­ï¼š-Student-record-with-the-highest-id-that-is-enrolled-in-at-least-one-course" class="headerlink" title="ä¾‹å­ï¼š Student record with the highest id that is enrolled in at least one course"></a>ä¾‹å­ï¼š Student record with the highest id that is enrolled in at least one course</h2><p><img data-src="/images/CMU1544564/Lec02/44.jpg" alt="44.jpg"></p>
<ul>
<li>MySQL (v5.7 with strict mode) æŒ‡ã€€<code>set session sql_mode = 'ansi';</code> (æˆ‘ä»¬åœ¨è¿™æ¬¡è¯¾çš„ä¸Šä¸€éƒ¨åˆ†ç¬”è®°æåˆ°è¿‡)</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec02/45.jpg" alt="45.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/46.jpg" alt="46.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/47.jpg" alt="47.jpg"></p>
<p>ä¸Šé¢è¯¾ä»¶è¿™æ¡SQLæœ‰å¥æ³•é”™è¯¯</p>
<!-- 
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sid</span>, <span class="keyword">name</span> <span class="keyword">FROM</span> student</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">sid</span> =&gt; <span class="keyword">ALL</span>(</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sid</span> <span class="keyword">FROM</span> enrolled</span><br><span class="line">)</span><br><span class="line"><span class="string">``</span><span class="string">` --&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">![48.jpg](/images/CMU1544564/Lec02/48.jpg)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">![49.jpg](/images/CMU1544564/Lec02/49.jpg)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å¦å¤–ä¸€ç§ä½¿ç”¨`</span>=<span class="string">`è§£æ³•:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">sql</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sid</span>, <span class="keyword">name</span> <span class="keyword">FROM</span> student</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">sid</span> = (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">MAX</span>(<span class="keyword">sid</span>) <span class="keyword">FROM</span> enrolled</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><br></p>
<h2 id="ä¾‹å­ï¼šFind-all-courses-that-has-no-students-enrolled"><a href="#ä¾‹å­ï¼šFind-all-courses-that-has-no-students-enrolled" class="headerlink" title="ä¾‹å­ï¼šFind all courses that has no students enrolled"></a>ä¾‹å­ï¼šFind all courses that has no students enrolled</h2><p>è¿™ä¸ªä¾‹å­å®é™…ä¸Šæ˜¯åœ¨é—®ã€€å…³ç³»ä»£æ•°ä¸­çš„ <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUmVsYXRpb25hbF9hbGdlYnJhI0FudGlqb2luXyglRTIlOTYlQjc=" title="https://en.wikipedia.org/wiki/Relational_algebra#Antijoin_(%E2%96%B7">Anti Join<i class="fa fa-external-link"></i></span>)ã€‚å®ƒå¯¹åº”çš„SQLå®ç°æ˜¯<code>NOT EXISTS</code>å’Œ<code>NOT INT</code></p>
<p><img data-src="/images/CMU1544564/Lec02/50.jpg" alt="50.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/51.jpg" alt="51.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/53.jpg" alt="53.jpg"></p>
<p>å¦å¤–ä¸€ç§ä½¿ç”¨<code>NOT IN</code>è§£æ³•:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> course</span><br><span class="line"><span class="keyword">WHERE</span> cid <span class="keyword">NOT</span> <span class="keyword">IN</span>(</span><br><span class="line">    <span class="keyword">SELECT</span> cid <span class="keyword">FROM</span> enrolled</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h1 id="WINDOW-FUNCTIONS-çª—å£å‡½æ•°"><a href="#WINDOW-FUNCTIONS-çª—å£å‡½æ•°" class="headerlink" title="WINDOW FUNCTIONS çª—å£å‡½æ•°"></a>WINDOW FUNCTIONS çª—å£å‡½æ•°</h1><!-- TODO: è§æˆ‘çš„é«˜çº§SQL + FDE + LEETCODE å±…å¤šç»ƒä¹  FDE -->
<p>çª—å£å‡½æ•°æ˜¯æˆ‘ä»¬åœ¨OLAPä¸­éå¸¸æœ‰åŠ›çš„åŠ©æ‰‹ã€‚å®ƒå¾ˆåƒ aggregationèšåˆå‡½æ•°ï¼Œåœ¨å…¶ä¹‹ä¸Šç»“åˆäº† sliding windowï¼Œã€€å¹¶ä¸”ä¸èšåˆç»“æœã€‚å¤§å®¶å¯ä»¥å¾ˆå¿«ä»å…·ä½“çš„ä¾‹å­æ‰¾åˆ°æ‰‹æ„Ÿï¼Œå¦å¤–å»ºè®®ä½¿ç”¨PostgreSQLå»ä½¿ç”¨çª—å£å‡½æ•°ã€‚</p>
<p>åœ¨çª—å£å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ç§°ä¹‹å‰çš„<code>group</code>ä¸º<code>frame</code>ï¼Œå³åœ¨<code>PARTITION BY</code>ä¹‹åæœ‰åŒä¸€ä¸ªç‰¹å¾çš„tupleé›†åˆï¼š</p>
<p><img data-src="/images/CMU1544564/Lec02/55.jpg" alt="55.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/57.jpg" alt="57.jpg"></p>
<ul>
<li>ä¸Šé¡µä¸­æˆ‘ä»¬å°†æ•´ä¸ªè¡¨æ ¼çœ‹åšä¸€ä¸ªframeã€€(å› ä¸ºæ²¡æœ‰<code>PARTITION BY</code>)</li>
</ul>
<p><br></p>
<p><img data-src="/images/CMU1544564/Lec02/59.jpg" alt="59.jpg"></p>
<ul>
<li>ä¸Šé¡µä¸­æˆ‘ä»¬å°†æ¯ä¸€ä¸ª<code>cid</code>çœ‹åšä¸€ä¸ªframe</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec02/60.jpg" alt="60.jpg"></p>
<h2 id="ä¾‹å­ï¼š-Find-the-student-with-the-highest-grade-for-each-course"><a href="#ä¾‹å­ï¼š-Find-the-student-with-the-highest-grade-for-each-course" class="headerlink" title="ä¾‹å­ï¼š Find the student with the highest grade for each course"></a>ä¾‹å­ï¼š Find the student with the highest grade for each course</h2><p><img data-src="/images/CMU1544564/Lec02/62.jpg" alt="62.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/63.jpg" alt="63.jpg"></p>
<p>ä¸­é—´è¿‡ç¨‹ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> *,</span><br><span class="line">        <span class="keyword">RANK</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cid</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> grade <span class="keyword">ASC</span>) <span class="keyword">AS</span> <span class="keyword">rank</span></span><br><span class="line">    <span class="keyword">FROM</span> enrolled) <span class="keyword">AS</span> ranking;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  sid  |  cid   | grade | rank </span><br><span class="line"><span class="comment">-------+--------+-------+------</span></span><br><span class="line"> 53655 | 15-445 | B     |    1</span><br><span class="line"> 53666 | 15-445 | C     |    2</span><br><span class="line"> 53688 | 15-721 | A     |    1</span><br><span class="line"> 53666 | 15-721 | C     |    2</span><br><span class="line"> 53666 | 15-826 | B     |    1</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h3 id="å¦‚æœæ²¡æœ‰-ORDER-BY"><a href="#å¦‚æœæ²¡æœ‰-ORDER-BY" class="headerlink" title="å¦‚æœæ²¡æœ‰ ORDER BY"></a>å¦‚æœæ²¡æœ‰ <code>ORDER BY</code></h3><p>å¦‚æœæ²¡æœ‰ <code>ORDER BY</code>ï¼Œå³frameå†…æ²¡æœ‰æ’åºï¼Œ<strong>äººäººéƒ½æ˜¯ä¸€ä¸ªåæ¬¡ï¼Œäººäººéƒ½æ˜¯ç¬¬ä¸€å</strong>ï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# SELECT *, RANK() OVER (PARTITION BY cid) AS rank FROM enrolled;</span><br><span class="line"></span><br><span class="line">  sid  |  cid   | grade | rank </span><br><span class="line">-------+--------+-------+------</span><br><span class="line"> <span class="number">53666</span> | <span class="number">15</span><span class="number">-445</span> | C     |    <span class="number">1</span></span><br><span class="line"> <span class="number">53655</span> | <span class="number">15</span><span class="number">-445</span> | B     |    <span class="number">1</span></span><br><span class="line"> <span class="number">53688</span> | <span class="number">15</span><span class="number">-721</span> | A     |    <span class="number">1</span></span><br><span class="line"> <span class="number">53666</span> | <span class="number">15</span><span class="number">-721</span> | C     |    <span class="number">1</span></span><br><span class="line"> <span class="number">53666</span> | <span class="number">15</span><span class="number">-826</span> | B     |    <span class="number">1</span></span><br><span class="line">(<span class="number">5</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<h1 id="COMMON-TABLE-EXPRESSIONS-CTEs"><a href="#COMMON-TABLE-EXPRESSIONS-CTEs" class="headerlink" title="COMMON TABLE EXPRESSIONS (CTEs)"></a>COMMON TABLE EXPRESSIONS (CTEs)</h1><p>å®é™…ä¸ŠCTEä¸­çš„<code>with</code>ä»å¥éå¸¸ç±»ä¼¼Nested Queryï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæš‚æ—¶çš„è¾…åŠ©è¡¨æ ¼(anxiliary statement):</p>
<p><img data-src="/images/CMU1544564/Lec02/65.jpg" alt="65.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/66.jpg" alt="66.jpg"></p>
<h2 id="ä¾‹å­-Find-student-record-with-the-highest-id-that-is-enrolled-in-at-least-one-course"><a href="#ä¾‹å­-Find-student-record-with-the-highest-id-that-is-enrolled-in-at-least-one-course" class="headerlink" title="ä¾‹å­: Find student record with the highest id that is enrolled in at least one course"></a>ä¾‹å­: Find student record with the highest id that is enrolled in at least one course</h2><p><img data-src="/images/CMU1544564/Lec02/68.jpg" alt="68.jpg"></p>
<p><br></p>
<h1 id="RECURSION-é€’å½’"><a href="#RECURSION-é€’å½’" class="headerlink" title="RECURSION é€’å½’"></a>RECURSION é€’å½’</h1><p>CTEçš„èƒ½åŠ›æ¯”Nested Queryæ›´å¤§ï¼Œå®ƒå¯ä»¥å®Œæˆã€€SQL ä¸­çš„é€’å½’è¯­å¥ã€‚ã€€æˆ‘ä¸ªäººè§‰å¾—è¿™ä¸ªå¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬çš„æ•°æ®é›†æ˜¯ä¸€ä¸ªå›¾çš„æŠ½è±¡ï¼Œæˆ‘ä»¬éœ€è¦ç”¨é€’å½’çš„è¯­å¥å»å®Œæˆå›¾è®ºä¸­çš„ç®—æ³•ï¼Œæˆ–è€…å»éå†è¿™ä¸ªå›¾ã€‚æ›´å¤šçš„ç»ƒä¹ å¯ä»¥åœ¨æˆ‘çš„ã€€<a href="https://cakebytheoceanluo.github.io/categories/SQL/">é«˜çº§SQL-é€’å½’</a> ä¸­æ‰¾åˆ°ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec02/69.jpg" alt="69.jpg"></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> <span class="keyword">source</span>(counter) <span class="keyword">as</span> (</span><br><span class="line">    (<span class="keyword">select</span> <span class="number">1</span>) </span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">    (<span class="keyword">select</span> counter + <span class="number">1</span> </span><br><span class="line">     <span class="keyword">from</span> <span class="keyword">source</span> </span><br><span class="line">     <span class="keyword">where</span> counter &lt; <span class="number">10</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> <span class="keyword">source</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> counter </span><br><span class="line"><span class="comment">---------</span></span><br><span class="line">       1</span><br><span class="line">       2</span><br><span class="line">       3</span><br><span class="line">       4</span><br><span class="line">       5</span><br><span class="line">       6</span><br><span class="line">       7</span><br><span class="line">       8</span><br><span class="line">       9</span><br><span class="line">      10</span><br><span class="line">(10 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¦å¤–PostgreSQLä¸­æœ‰åº“å‡½æ•° <code>GENERATE_SERIES</code> ï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select GENERATE_SERIES(<span class="number">1</span>, <span class="number">10</span>) as counter;</span><br><span class="line"></span><br><span class="line"> counter </span><br><span class="line">---------</span><br><span class="line">       <span class="number">1</span></span><br><span class="line">       <span class="number">2</span></span><br><span class="line">       <span class="number">3</span></span><br><span class="line">       <span class="number">4</span></span><br><span class="line">       <span class="number">5</span></span><br><span class="line">       <span class="number">6</span></span><br><span class="line">       <span class="number">7</span></span><br><span class="line">       <span class="number">8</span></span><br><span class="line">       <span class="number">9</span></span><br><span class="line">      <span class="number">10</span></span><br><span class="line">(<span class="number">10</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="UNION-ALL-vs-UNION"><a href="#UNION-ALL-vs-UNION" class="headerlink" title="UNION ALL vs UNION"></a><code>UNION ALL</code> vs <code>UNION</code></h2><ul>
<li><code>UNION ALL</code> é‡‡ç”¨åŒ…è¯­ä¹‰ (Bag Semantics)ï¼Œå®ƒä¸ä¼šæ¶ˆé™¤é‡å¤ (duplicates)ã€‚</li>
<li><code>UNION</code> é‡‡ç”¨é›†åˆè¯­ä¹‰ (Set Semantics)ï¼Œå®ƒä¼šæ¶ˆé™¤é‡å¤ã€‚</li>
</ul>
<p><code>UNION ALL</code> å¯èƒ½ä¼šå¯¼è‡´<strong>ä¸èƒ½ç»ˆæ­¢</strong>:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# set statement_timeout = '10s';</span><br><span class="line">SET</span><br><span class="line"></span><br><span class="line">testdb=# \timing</span><br><span class="line">Timing is on.</span><br><span class="line"></span><br><span class="line">testdb=# with recursive source(counter) as ((select <span class="number">1</span>) <span class="keyword">union</span> all (select counter + <span class="number">1</span> from source)) select * from source;</span><br><span class="line">ERROR:  canceling statement due to statement timeout</span><br><span class="line">Time: <span class="number">10223.416</span> ms (<span class="number">00</span>:<span class="number">10.223</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>set statement_timeout = '10s';</code> è®¾ç½®æ¯ä¸ªSQLçš„ timeout, å³æœ€é•¿å…è®¸è¿è¡Œæ—¶é—´</li>
<li><code>\timing</code> æ‰“å¼€è®¡æ—¶å™¨ï¼Œèƒ½å¯¹æ¯ä¸ªSQLçš„è¿è¡Œæ—¶é—´è¿›è¡Œè®¡æ—¶ã€‚</li>
</ul>
<p><br></p>
<h1 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h1><p><img data-src="/images/CMU1544564/Lec02/70.jpg" alt="70.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/71.jpg" alt="71.jpg"></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Window Function</tag>
        <tag>Recursion</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]Lec02_part1 Advanced SQL - é«˜çº§SQL</title>
    <url>/2020/03/06/CMU-15445-Lec02-part1/</url>
    <content><![CDATA[<p>Advanced SQL - é«˜çº§SQL</p>
<p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzAyLWFkdmFuY2Vkc3FsLnBkZg==" title="https://15445.courses.cs.cmu.edu/fall2019/slides/02-advancedsql.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/02-advancedsql.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDItYWR2YW5jZWRzcWwucGRm" title="https://15445.courses.cs.cmu.edu/fall2019/notes/02-advancedsql.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/02-advancedsql.pdf<i class="fa fa-external-link"></i></span><br>Reading: Chapters 3-5</p>
<p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¼šäº†è§£é«˜çº§çš„SQLå¥æ³•ã€‚(ä½†æ˜¯å®é™…ä¸Šè¿™é—¨è¯¾å¯¹SQLçš„è¦æ±‚å¾ˆä½ï¼Œå¤§é‡å…¶ä»–çš„SQLç»ƒä¹ ä¾æ—§å¯ä»¥åœ¨æˆ‘çš„åšå®¢ä¸­æ‰¾åˆ°)</p>
<p>å¦‚æœå¤§å®¶çš„ç›®çš„æ˜¯ä¸ºäº†å­¦ä¹ SQLï¼Œæˆ‘å»ºè®®ä½¿ç”¨PostgreSQLï¼Œå®ƒå‡ºè‡ªäºå­¦æœ¯ç•Œï¼Œæ•´ä½“è¡Œä¸ºç›¸å¯¹MySQLå’ŒSQLiteæ›´åˆç†ã€‚å¦å¤–TUMå’ŒCMUåœ¨SQLæ•™å­¦ä¸Šéƒ½é‡‡ç”¨PostgreSQLã€‚</p>
<p>æˆ‘å°†è¿™æ¬¡ç¬”è®°åˆ†æˆå‰åä¸¤ä¸ªéƒ¨åˆ†ï¼Œè¿™æ˜¯ç¬¬ä¸€éƒ¨åˆ†ã€‚</p>
<!-- å¯¹åº”çš„ç»ƒä¹ ã€€TODO:æˆ‘çš„åšå®¢ -->
<a id="more"></a>
<p><img data-src="/images/CMU1544564/Lec02/1.jpg" alt="1.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/2.jpg" alt="2.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/3.jpg" alt="3.jpg"></p>
<p>SQL(a.k.a. Strutured Query Language)å¹¶ä¸æ˜¯è¿™é—¨è¯­è¨€ä¸€å¼€å§‹åå­—ï¼ŒIBMç»™è¿™ä¸ªè¯­è¨€çš„æœ€åˆçš„åå­—æ˜¯ã€€SEQUELã€‚æ‰€æœ‰ç°åœ¨å¤§éƒ¨åˆ†äººä¾æ—§å°†ã€€SQL è¯»ä½œã€€SEQUELã€‚</p>
<p>æœ€å¥½èƒ½è®²ä¸Šé¢å‡ ä¸ªæ¦‚å¿µè®°ä½ï¼Œæˆ‘ä»¬å­¦æ ¡åœ¨æœ¬ç§‘ç”Ÿçš„æ•°æ®åº“è¯¾ä¸­è€ƒSQLçš„å…¨ç§°ï¼Œç™¾åˆ†ä¹‹ä¹åçš„åŒå­¦å›ç­”é”™è¯¯ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec02/4.jpg" alt="4.jpg"></p>
<p>Comparison of different SQL implementationsï¼šã€€<span class="exturl" data-url="aHR0cDovL3Ryb2Vscy5hcnZpbi5kay9kYi9yZGJtcy8=" title="http://troels.arvin.dk/db/rdbms/">http://troels.arvin.dk/db/rdbms/<i class="fa fa-external-link"></i></span> <!-- TODO: --></p>
<p>æœ€å¥½å¤§è‡´å¯¹SQLçš„æ ‡å‡†æœ‰ä¸€å®šçš„å°è±¡ï¼Œå› ä¸ºå„ä¸ªRDBMSå¯¹SQLæ ‡å‡†çš„æ”¯æŒéƒ½ä¸ä¸€æ ·ï¼Œå¤§æœ‰ç™¾èŠ±é½æ”¾ä¹‹åŠ¿ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™èŠ‚è¯¾åé¢çš„éƒ¨åˆ†è§åˆ°ã€‚</p>
<p><img data-src="/images/CMU1544564/Lec02/5.jpg" alt="5.jpg"></p>
<p><strong>è¿™é‡Œè¦æ³¨æ„: SQLä½¿ç”¨çš„æ˜¯bag semanticï¼Œå³å…è®¸é‡å¤å€¼å‡ºç°ã€‚</strong></p>
<p><img data-src="/images/CMU1544564/Lec02/6.jpg" alt="6.jpg"></p>
<h1 id="EXAMPLE-DATABASE"><a href="#EXAMPLE-DATABASE" class="headerlink" title="EXAMPLE DATABASE"></a>EXAMPLE DATABASE</h1><p>æˆ‘ä½¿ç”¨ä¸€ä¸ªå¾ˆå°çš„<strong>æµè¡Œæ­Œæ‰‹</strong>æ•°æ®é›†(æˆ‘å¹¶ä¸è§‰å¾—Bieberæ˜¯ä¸€ä¸ªrapper<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">ğŸ˜‚</span>)</p>
<p><img data-src="/images/CMU1544564/Lec02/7.jpg" alt="7.jpg"></p>
<p>å¯¹åº”çš„SQLè¯­å¥ã€€<a href="https://cakebytheoceanluo.github.io/download/CMU15445/lec02_schema.sql">ä¸‹è½½</a>ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> student <span class="keyword">CASCADE</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> course <span class="keyword">CASCADE</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> enrolled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student </span><br><span class="line">   (<span class="keyword">sid</span> <span class="built_in">int</span> primary <span class="keyword">key</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">16</span>), </span><br><span class="line">    login <span class="built_in">varchar</span>(<span class="number">32</span>), </span><br><span class="line">    age <span class="built_in">smallint</span>, </span><br><span class="line">    gpa <span class="built_in">numeric</span>(<span class="number">2</span>, <span class="number">1</span>) <span class="keyword">check</span> (gpa <span class="keyword">between</span> <span class="number">0.0</span> <span class="keyword">and</span> <span class="number">4.0</span>)</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> course </span><br><span class="line">   (cid <span class="built_in">varchar</span>(<span class="number">32</span>) primary <span class="keyword">key</span>, </span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> enrolled </span><br><span class="line">   (<span class="keyword">sid</span> <span class="built_in">int</span> <span class="keyword">references</span> student (<span class="keyword">sid</span>) <span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">cascade</span>, </span><br><span class="line">    cid <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">references</span> course (cid) <span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">cascade</span>, </span><br><span class="line">    grade <span class="built_in">char</span>(<span class="number">1</span>) <span class="keyword">check</span> (grade <span class="keyword">in</span> (<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>)),</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">sid</span>, cid)</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (<span class="keyword">sid</span>, <span class="keyword">name</span>, login, age, gpa) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'Kanye'</span>, <span class="string">'kanye@cs'</span>, <span class="number">39</span>, <span class="number">4.0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (<span class="keyword">sid</span>, <span class="keyword">name</span>, login, age, gpa) <span class="keyword">values</span> (<span class="number">53688</span>, <span class="string">'Bieber'</span>, <span class="string">'jbieber@cs'</span>, <span class="number">22</span>, <span class="number">3.9</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (<span class="keyword">sid</span>, <span class="keyword">name</span>, login, age, gpa) <span class="keyword">values</span> (<span class="number">53655</span>, <span class="string">'Tupac'</span>, <span class="string">'shakur@cs'</span>, <span class="number">26</span>, <span class="number">3.5</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-445'</span>, <span class="string">'Database Systems'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-721'</span>, <span class="string">'Advanced Database Systems'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-826'</span>, <span class="string">'Data Mining'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course (cid, <span class="keyword">name</span>) <span class="keyword">values</span> (<span class="string">'15-823'</span>, <span class="string">'Advanced Topics in Databases'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'15-445'</span>, <span class="string">'C'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53688</span>, <span class="string">'15-721'</span>, <span class="string">'A'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'15-826'</span>, <span class="string">'B'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53655</span>, <span class="string">'15-445'</span>, <span class="string">'B'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> enrolled (<span class="keyword">sid</span>, cid, grade) <span class="keyword">values</span> (<span class="number">53666</span>, <span class="string">'15-721'</span>, <span class="string">'C'</span>);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯ä»¥åœ¨PostgreSQL, MySQL, SQLiteä¸­ä½¿ç”¨</li>
</ul>
<h2 id="check"><a href="#check" class="headerlink" title="check"></a><code>check</code></h2><p><code>check</code>æ˜¯ç¡®è®¤insertæŒ‡æ˜¯å¦æ»¡è¶³æˆ‘ä»¬è§„å®šçš„ä¸å˜é‡(invariant):</p>
<ul>
<li><code>gpa numeric(2, 1) check (gpa between 0.0 and 4.0)</code></li>
<li><code>grade char(1) check (grade in ('A', 'B', 'C')</code></li>
</ul>
<p>æˆ‘ä»¬å°è¯•åœ¨PostgreSQLä¸­ï¼Œinsertä¸€ä¸ªè¿èƒŒè¿™ä¸ªä¸å˜é‡çš„tuple,ã€€æˆ‘ä»¬å°±èƒ½çœ‹åˆ°å¯¹åº”çš„ERROR:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# insert into enrolled (sid, cid, grade) values (53666, '15-445', 'Z');</span><br><span class="line">ERROR:  <span class="keyword">new</span> row <span class="keyword">for</span> relation <span class="string">"enrolled"</span> violates check constraint <span class="string">"enrolled_grade_check"</span></span><br><span class="line">DETAIL:  Failing row contains (<span class="number">53666</span>, <span class="number">15</span><span class="number">-445</span>, Z).</span><br></pre></td></tr></tbody></table></figure>
<h2 id="on-delete-cascade"><a href="#on-delete-cascade" class="headerlink" title="on delete cascade"></a><code>on delete cascade</code></h2><p><code>cascade</code>: å¾ˆè±¡å¾åœ°æè¿°äº†ä¸€ç§åƒç€‘å¸ƒä¸€æ ·çš„è¿é”æ•ˆåº”ã€‚è¿™ä¸ªè¯åœ¨è¥¿æ–¹è¯­å¢ƒä¸‹æ¯”è¾ƒå¸¸ç”¨ï¼Œå¯¹åº”æˆ‘ä»¬å¯ä»¥ç†è§£æˆ<strong>è¿é”æ•ˆåº”</strong>å³å¯ã€‚(è¿™ä¸ªè¯è¿™ä¸ªé—¨è¯¾æœ€åçš„äº‹åŠ¡transactionè¿˜ä¼šå‡ºç°ã€‚)</p>
<p><code>enrolled</code>è¿™ä¸ªè¡¨æ ¼çš„å­—æ®µéƒ½æ˜¯æ¥è‡ª<code>student</code>å’Œ<code>course</code>çš„å¤–é”®ï¼Œå› æ­¤è¿™ä¸ªè¡¨æ ¼ä¾èµ–äºå…¶ä»–ä¸¤ä¸ªè¡¨æ ¼ã€‚è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬åˆ å»ä¸€ä¸ª<code>student</code>æˆ–<code>course</code>ï¼Œå¦‚æœåˆ å»çš„tupleåœ¨<code>enrolled</code>æ‹¥æœ‰å¤–é”®ï¼Œé‚£ä¹ˆå¯¹åº”åœ¨<code>enrolled</code>çš„tupleä¹Ÿéœ€è¦è¢«åˆ é™¤ã€‚ä¸ç„¶<code>enrolled</code>ä¸­å°±å‡ºç°äº†ä¸€ä¸ª<strong>åƒµå°¸</strong>ï¼šå¯¹åº”ä¸åˆ°<code>student</code>æˆ–<code>course</code>ã€‚</p>
<p>æˆ‘ä»¬å°è¯•åœ¨PostgreSQLä¸­ï¼Œåˆ é™¤<code>student Bieber</code>, çœ‹çœ‹ä»–çš„<code>enrolled</code>æ€ä¹ˆå˜åŒ–ï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select * from enrolled;</span><br><span class="line">  sid  |  cid   | grade </span><br><span class="line">-------+--------+-------</span><br><span class="line"> <span class="number">53666</span> | <span class="number">15</span><span class="number">-445</span> | C</span><br><span class="line"> <span class="number">53688</span> | <span class="number">15</span><span class="number">-721</span> | A</span><br><span class="line"> <span class="number">53666</span> | <span class="number">15</span><span class="number">-826</span> | B</span><br><span class="line"> <span class="number">53655</span> | <span class="number">15</span><span class="number">-445</span> | B</span><br><span class="line"> <span class="number">53666</span> | <span class="number">15</span><span class="number">-721</span> | C</span><br><span class="line">(<span class="number">5</span> rows)</span><br><span class="line"></span><br><span class="line">testdb=# delete from student where name = 'Bieber';</span><br><span class="line">DELETE <span class="number">1</span></span><br><span class="line"></span><br><span class="line">testdb=# select * from enrolled;</span><br><span class="line">  sid  |  cid   | grade </span><br><span class="line">-------+--------+-------</span><br><span class="line"> <span class="number">53666</span> | <span class="number">15</span><span class="number">-445</span> | C</span><br><span class="line"> <span class="number">53666</span> | <span class="number">15</span><span class="number">-826</span> | B</span><br><span class="line"> <span class="number">53655</span> | <span class="number">15</span><span class="number">-445</span> | B</span><br><span class="line"> <span class="number">53666</span> | <span class="number">15</span><span class="number">-721</span> | C</span><br><span class="line">(<span class="number">4</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ç”¨åˆ é™¤å‰å<code>enrollled</code>è¡¨æ ¼ï¼Œå‘ç°<code>Bieber</code>å¯¹åº”çš„<code>sid 53688</code>ä¹Ÿè¢«åˆ é™¤äº†ã€‚</p>
<p>(æ³¨æ„å†é‡æ–°å°†åŠ å…¥åˆ é™¤çš„tupleæˆ–è€…é‡æ–°<code>drop table ... create table ... insert</code>ï¼Œæˆ‘ä»¬åé¢çš„ç»ƒä¹ ä»¥åŠéœ€è¦<code>Bieber</code>)</p>
<p><br><br><br></p>
<h1 id="AGGREGATES-èšåˆå‡½æ•°"><a href="#AGGREGATES-èšåˆå‡½æ•°" class="headerlink" title="AGGREGATESã€€èšåˆå‡½æ•°"></a>AGGREGATESã€€èšåˆå‡½æ•°</h1><p><img data-src="/images/CMU1544564/Lec02/8.jpg" alt="8.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/9.jpg" alt="9.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/11.jpg" alt="11.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/12.jpg" alt="12.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/13.jpg" alt="13.jpg"></p>
<ul>
<li>ä¸Šå›¾ä¸­ç»“æœè¡¨æ ¼é”™è¯¯, åº”ä¸ºï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">        avg         | count </span><br><span class="line"><span class="comment">--------------------+-------</span></span><br><span class="line"> 3.8000000000000000 |     3</span><br><span class="line">(1 row)</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/images/CMU1544564/Lec02/14.jpg" alt="14.jpg"></p>
<h2 id="Undefined-e-cid-select-not-from-group-by"><a href="#Undefined-e-cid-select-not-from-group-by" class="headerlink" title="Undefined e.cid: select not from group by"></a>Undefined <code>e.cid</code>: select not from group by</h2><p><img data-src="/images/CMU1544564/Lec02/15.jpg" alt="15.jpg"></p>
<p>ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä¸€ä¸ªå­—æ®µ<code>e.cid</code>ï¼Œå®ƒå¹¶ä¸å‡ºç°åœ¨<code>group by</code>ä»å¥ä¸­(æ ¹æœ¬æ²¡æœ‰ä»»ä½•<code>group by</code>ä»å¥), è¿™è¿åäº†SQL  syntaxå¥æ³•ã€‚ä½†æ˜¯è¿™ä¸ªè¡Œä¸ºåœ¨ä¸åŒçš„DBMS, æœ‰ä¸ä¸€æ ·çš„ä½œç”¨ï¼š</p>
<h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">testdb=#  select avg(s.gpa), e.cid from enrolled as e, student as s where e.sid = s.sid;</span><br><span class="line">ERROR:  column <span class="string">"e.cid"</span> must appear in the GROUP BY clause <span class="keyword">or</span> be used in an aggregate function</span><br><span class="line">LINE 1: select avg(s.gpa), e.cid from enrolled as e, student as s wh...</span><br></pre></td></tr></tbody></table></figure>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>MySQL åŒºåˆ†ã€€ä¸¤ç§æ¨¡å¼mode:</p>
<ul>
<li>ANSI: <code>set session sql_mode = 'ansi';</code> å³SQL Standard</li>
<li>traditional: <code>set session sql_mode = 'traditional';</code>ã€€</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">mysql&gt; set session sql_mode = 'ansi';</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select avg(s.gpa), e.cid from enrolled as e, student as s where e.sid = s.sid;</span><br><span class="line">ERROR 1140 (42000): In aggregated query without GROUP BY, expression <span class="comment">#2 of SELECT list contains nonaggregated column 'test_db.e.cid'; this is incompatible with sql_mode=only_full_group_by</span></span><br><span class="line"></span><br><span class="line">mysql&gt; set session sql_mode = 'traditional';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select avg(s.gpa), e.cid from enrolled as e, student as s where e.sid = s.sid;</span><br><span class="line">+<span class="comment">------------+--------+</span></span><br><span class="line">| avg(s.gpa) | cid    |</span><br><span class="line">+<span class="comment">------------+--------+</span></span><br><span class="line">|    3.88000 | 15-445 |</span><br><span class="line">+<span class="comment">------------+--------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">sqlite&gt; select avg(s.gpa), e.cid from enrolled as e, student as s where e.sid = s.sid;</span><br><span class="line">3.88|</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="GROUP-BY"><a href="#GROUP-BY" class="headerlink" title="GROUP BY"></a><code>GROUP BY</code></h1><p><img data-src="/images/CMU1544564/Lec02/18.jpg" alt="18.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/19.jpg" alt="19.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/20.jpg" alt="20.jpg"></p>
<h2 id="HAVING"><a href="#HAVING" class="headerlink" title="HAVING"></a><code>HAVING</code></h2><p><img data-src="/images/CMU1544564/Lec02/21.jpg" alt="21.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/22.jpg" alt="22.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/23.jpg" alt="23.jpg"></p>
<p><code>HAVING</code>ä»å¥å¯ä»¥è¯´æ˜¯<code>WHERE</code>ä»å¥å¸¦èšåˆå‡½æ•°çš„ç‰ˆæœ¬ã€‚å®ƒä»¬ä¿©éƒ½åœ¨å¯¹tupleåšä¸€äº›ç­›é€‰çš„å·¥ä½œã€‚åé¢æˆ‘ä»¬ä¼šåœ¨query optimizationä¸­æåˆ°logical planä¸­çš„selection pushdown / early filteringã€‚è¿™ä¸ªä¼˜åŒ–å°±æ˜¯å°½å¯èƒ½æ—©å¾—å¯¹æå‰ç­›é€‰å‡ºç¬¦åˆ<code>WHERE</code>å’Œ<code>HAVING</code>ä»å¥æ¡ä»¶çš„tupleï¼Œå°½é‡è®©æŸ¥è¯¢ä¸­é—´ç»“æœçš„é›†åˆå°½å¯èƒ½å°ã€‚</p>
<h3 id="PostgreSQL-1"><a href="#PostgreSQL-1" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><p>ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œä¸é€‚ç”¨äºPostgreSQL:</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select avg(s.gpa) as avg_gpa, e.cid from enrolled e, student s where e.sid = s.sid group by e.cid having avg_gpa &gt; <span class="number">3.9</span>;</span><br><span class="line">ERROR:  column <span class="string">"avg_gpa"</span> does <span class="keyword">not</span> exist</span><br><span class="line">LINE <span class="number">1</span>: ...udent s where e.sid = s.sid group by e.cid having avg_gpa &gt; ...</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select avg(s.gpa) as avg_gpa, e.cid from enrolled e, student s where e.sid = s.sid group by e.cid having avg(s.gpa) &gt; <span class="number">3.9</span>;</span><br><span class="line">      avg_gpa       |  cid   </span><br><span class="line">--------------------+--------</span><br><span class="line"> <span class="number">4.0000000000000000</span> | <span class="number">15</span><span class="number">-826</span></span><br><span class="line"> <span class="number">3.9500000000000000</span> | <span class="number">15</span><span class="number">-721</span></span><br><span class="line">(<span class="number">2</span> rows)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="MySQL-1"><a href="#MySQL-1" class="headerlink" title="MySQL"></a>MySQL</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">mysql&gt; select avg(s.gpa) as avg_gpa, e.cid from enrolled e, student s where e.sid = s.sid group by e.cid having avg_gpa &gt; 3.9;</span><br><span class="line">+<span class="comment">---------+--------+</span></span><br><span class="line">| avg_gpa | cid    |</span><br><span class="line">+<span class="comment">---------+--------+</span></span><br><span class="line">| 3.95000 | 15-721 |</span><br><span class="line">| 4.00000 | 15-826 |</span><br><span class="line">+<span class="comment">---------+--------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="SQLite-1"><a href="#SQLite-1" class="headerlink" title="SQLite"></a>SQLite</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">sqlite&gt; select avg(s.gpa) as avg_gpa, e.cid from enrolled e, student s where e.sid = s.sid group by e.cid having avg(s.gpa) &gt; 3.9;</span><br><span class="line">4|15-826</span><br><span class="line">3.95|15-721</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="STRING-OPERATIONS"><a href="#STRING-OPERATIONS" class="headerlink" title="STRING OPERATIONS"></a>STRING OPERATIONS</h1><p>åœ¨å­—ç¬¦ä¸²çš„å¤„ç†ä¸Šï¼Œå„ä¸ªæ•°æ®åº“å¼€å§‹æ”¾é£è‡ªæˆ‘ï¼Œç‚¹åMySQL, SQLiteä¸éµå®ˆSQL Standard</p>
<p><img data-src="/images/CMU1544564/Lec02/24.jpg" alt="24.jpg"></p>
<h2 id="PostgreSQL-2"><a href="#PostgreSQL-2" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">testdb=<span class="comment"># select * from student where upper(name) = upper('KaNyE');</span></span><br><span class="line">  sid  | name  |  login   | age | gpa </span><br><span class="line"><span class="comment">-------+-------+----------+-----+-----</span></span><br><span class="line"> 53666 | Kanye | kanye@cs |  39 | 4.0</span><br><span class="line">(1 row)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="MySQL-2"><a href="#MySQL-2" class="headerlink" title="MySQL"></a>MySQL</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">mysql&gt; set session sql_mode = 'traditional';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student where name = 'KaNyE';</span><br><span class="line">+<span class="comment">-------+-------+----------+------+------+</span></span><br><span class="line">| sid   | name  | login    | age  | gpa  |</span><br><span class="line">+<span class="comment">-------+-------+----------+------+------+</span></span><br><span class="line">| 53666 | Kanye | kanye@cs |   39 |  4.0 |</span><br><span class="line">+<span class="comment">-------+-------+----------+------+------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">set</span> <span class="keyword">session</span> sql_mode = <span class="string">'ansi'</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student where name = 'KaNyE';</span><br><span class="line">+<span class="comment">-------+-------+----------+------+------+</span></span><br><span class="line">| sid   | name  | login    | age  | gpa  |</span><br><span class="line">+<span class="comment">-------+-------+----------+------+------+</span></span><br><span class="line">| 53666 | Kanye | kanye@cs |   39 |  4.0 |</span><br><span class="line">+<span class="comment">-------+-------+----------+------+------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">mysql&gt; select 'An' 'Dy' ' Pavlo';</span><br><span class="line">+<span class="comment">------------+</span></span><br><span class="line">| An         |</span><br><span class="line">+<span class="comment">------------+</span></span><br><span class="line">| AnDy Pavlo |</span><br><span class="line">+<span class="comment">------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/images/CMU1544564/Lec02/25.jpg" alt="25.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/26.jpg" alt="26.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec02/27.jpg" alt="27.jpg"></p>
<p><br></p>
<h1 id="DATE-TIME-OPERATIONS"><a href="#DATE-TIME-OPERATIONS" class="headerlink" title="DATE/TIME OPERATIONS"></a>DATE/TIME OPERATIONS</h1><p>åœ¨æ—¶é—´æ—¥æœŸçš„å¤„ç†ä¸Šï¼Œå„ä¸ªæ•°æ®åº“çœŸæ­£éƒ½ä¸å¤ªä¸€æ ·äº†ï¼š</p>
<p><img data-src="/images/CMU1544564/Lec02/28.jpg" alt="28.jpg"></p>
<h2 id="Get-the-of-days-since-the-beginning-of-the-year"><a href="#Get-the-of-days-since-the-beginning-of-the-year" class="headerlink" title="Get the # of days since the beginning of the year."></a>Get the # of days since the beginning of the year.</h2><h3 id="PostgreSQL-3"><a href="#PostgreSQL-3" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><ul>
<li><code>now()</code>: a function</li>
<li><code>current_timestamp</code>: a keyword</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">testdb=# select now();</span><br><span class="line">              now              </span><br><span class="line">-------------------------------</span><br><span class="line"> <span class="number">2020</span><span class="number">-03</span><span class="number">-04</span> <span class="number">14</span>:<span class="number">02</span>:<span class="number">08.170335</span>+<span class="number">01</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">testdb=# select current_timestamp;</span><br><span class="line">       current_timestamp       </span><br><span class="line">-------------------------------</span><br><span class="line"> <span class="number">2020</span><span class="number">-03</span><span class="number">-04</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">04.507685</span>+<span class="number">01</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">testdb=# select extract(day from (select now()));</span><br><span class="line"> date_part </span><br><span class="line">-----------</span><br><span class="line">         <span class="number">4</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">testdb=# select extract(day from (now()));</span><br><span class="line"> date_part </span><br><span class="line">-----------</span><br><span class="line">         <span class="number">4</span></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">testdb=# select date(now()) - date('2020-01-01') as days;</span><br><span class="line"> days </span><br><span class="line">------</span><br><span class="line">   <span class="number">63</span></span><br><span class="line">(<span class="number">1</span> row)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="MySQL-3"><a href="#MySQL-3" class="headerlink" title="MySQL"></a>MySQL</h3><ul>
<li><code>now()</code>: a function</li>
<li><code>current_timestamp</code>: a keyword</li>
<li><code>unix_timestamp</code>: use unix timestamp in seconds</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">mysql&gt; select now();</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| now()               |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| 2020-03-04 14:03:41 |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">current_timestamp</span>;</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| current_timestamp   |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| 2020-03-04 14:04:22 |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">extract</span>(<span class="keyword">day</span> <span class="keyword">from</span> (<span class="keyword">now</span>()));</span><br><span class="line">+<span class="comment">---------------------------+</span></span><br><span class="line">| extract(day from (now())) |</span><br><span class="line">+<span class="comment">---------------------------+</span></span><br><span class="line">|                         4 |</span><br><span class="line">+<span class="comment">---------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- wrong answer!!!</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="built_in">date</span>(<span class="keyword">now</span>()) - <span class="built_in">date</span>(<span class="string">'2020-01-01'</span>) <span class="keyword">as</span> <span class="keyword">days</span>;</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">| days |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">|  203 |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">round</span>((<span class="keyword">unix_timestamp</span>(<span class="built_in">date</span>(<span class="keyword">now</span>())) - <span class="keyword">unix_timestamp</span>(<span class="built_in">date</span>(<span class="string">'2020-01-01'</span>))) / (<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>), <span class="number">0</span>) <span class="keyword">as</span> <span class="keyword">days</span>;</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">| days |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">|   63 |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">datediff</span>(<span class="built_in">date</span>(<span class="keyword">now</span>()), <span class="built_in">date</span>(<span class="string">'2020-01-01'</span>)) <span class="keyword">as</span> <span class="keyword">days</span>;</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">| days |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">|   63 |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="SQLite-2"><a href="#SQLite-2" class="headerlink" title="SQLite"></a>SQLite</h3><ul>
<li>julianday: <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSnVsaWFuX2RheQ==" title="https://en.wikipedia.org/wiki/Julian_day">https://en.wikipedia.org/wiki/Julian_day<i class="fa fa-external-link"></i></span></li>
<li>å„’ç•¥æ—¥: <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTg0JTkyJUU3JTk1JUE1JUU2JTk3JUE1" title="https://zh.wikipedia.org/wiki/%E5%84%92%E7%95%A5%E6%97%A5">https://zh.wikipedia.org/wiki/%E5%84%92%E7%95%A5%E6%97%A5<i class="fa fa-external-link"></i></span></li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- To return the current date and time in UTC, you use the following statement:</span></span><br><span class="line">sqlite&gt; SELECT datetime('now');</span><br><span class="line">2020-03-04 13:26:51</span><br><span class="line"></span><br><span class="line">sqlite&gt; SELECT datetime('now','localtime');</span><br><span class="line">2020-03-04 14:26:53</span><br><span class="line"></span><br><span class="line">sqlite&gt; SELECT strftime('%d', datetime('now','localtime'));</span><br><span class="line">04</span><br><span class="line"></span><br><span class="line"><span class="comment">-- wrong answer!!!</span></span><br><span class="line">sqlite&gt; SELECT date('now') - date('2020-01-01') as days;</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">sqlite&gt; SELECT julianday(date('now')) - julianday('2020-01-01') as days;</span><br><span class="line">63</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>SQLite</tag>
        <tag>DBMS</tag>
        <tag>PostgreSQL</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]Lec01 The Relational Model - å…³ç³»ä»£æ•°</title>
    <url>/2020/03/05/CMU-15445-Lec01/</url>
    <content><![CDATA[<p>The Relational Model - å…³ç³»ä»£æ•°</p>
<p>Slide: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvc2xpZGVzLzAxLWludHJvZHVjdGlvbi5wZGY=" title="https://15445.courses.cs.cmu.edu/fall2019/slides/01-introduction.pdf">https://15445.courses.cs.cmu.edu/fall2019/slides/01-introduction.pdf<i class="fa fa-external-link"></i></span><br>Note: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkvbm90ZXMvMDEtaW50cm9kdWN0aW9uLnBkZg==" title="https://15445.courses.cs.cmu.edu/fall2019/notes/01-introduction.pdf">https://15445.courses.cs.cmu.edu/fall2019/notes/01-introduction.pdf<i class="fa fa-external-link"></i></span><br>Reading: Chapters 1-2, 6</p>
<p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¼šäº†è§£æ•°æ®åº“çš„æ¦‚å†µï¼Œç„¶ååŒæ—¶äº†è§£ä¸€ä¸‹å…³ç³»ä»£æ•°å’ŒåŸºç¡€çš„SQLã€‚</p>
<p>æ›´å¤šçš„åŸºç¡€SQLç»ƒä¹ å¯ä»¥åœ¨æˆ‘ä¹‹å‰çš„åšå®¢æ‰¾åˆ°ï¼šã€€è§ <a href="https://cakebytheoceanluo.github.io/2020/02/22/SQL-%E5%9F%BA%E7%A1%80SQL/">[SQL]åŸºç¡€SQL</a></p>
<a id="more"></a>
<p><img data-src="/images/CMU1544564/Lec01/1.jpg" alt="1.jpg"></p>
<h1 id="DBMS-æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ"><a href="#DBMS-æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ" class="headerlink" title="DBMS æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ"></a>DBMS æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</h1><p>è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ç²—ç•¥çš„å»äº†è§£ï¼ŒDBMSsçš„æ„ä¹‰ã€‚å®ƒæ˜¯System Program(æˆ–System Programming)æœ€æœ‰ç‰¹å¾çš„ä»£è¡¨ï¼Œå› ä¸ºHigh Endçš„DBMSså§‹ç»ˆä»¥è¿è¡Œåœ¨æœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿä¸Šï¼ŒåŒæ—¶å®ƒåˆéœ€è¦å‘æ™®é€šçš„ç”¨æˆ·çš„User Programæä¾›æœåŠ¡ã€‚ä»æŸç§ç¨‹åº¦ä¸Šè¯´ï¼Œæ•°æ®åº“çš„ç¡®æ˜¯å­˜åœ¨äºæ“ä½œç³»ç»Ÿå’Œæ™®é€šåº”ç”¨çš„ä¸€å±‚ä»‹è´¨ï¼Œå®ƒçš„æœ€ä¸»è¦åŠŸèƒ½æ˜¯é«˜æ•ˆå¿«é€Ÿä¸”å®‰å…¨åœ°å‘æ™®é€šåº”ç”¨æä¾›æ•°æ®å€Ÿå£å’ŒæœåŠ¡ï¼Œå› æ­¤æ™®é€šåº”ç”¨çš„å¼€å‘è€…åªéœ€è¦æ³¨æ„å¯¹åº”çš„å€Ÿå£ï¼Œè€Œä¸éœ€è¦è‡ªå·±èŠ±å¾ˆå¤šæ—¶é—´å»å®ç°æ•°æ®åº“çš„åŠŸèƒ½ã€‚</p>
<p>(å½“ç„¶å­˜åœ¨ä¸€ä¸ªå­¦æœ¯æ–¹å‘æ˜¯æ•°æ®åº“çš„æ€»ä½“ç»Ÿä¸€: æ•°æ®åº“è¿è¡Œåœ¨ä¸“å±çš„èŠ¯ç‰‡å’Œæ“ä½œç³»ç»Ÿä¸Šï¼Œå®ƒä»¬éƒ½å¯¹å¤§æ•°æ®å¤„ç†(large scaled data processing)ä½œäº†æœ€å¤§ç¨‹åº¦çš„ä¼˜åŒ–ã€‚ã€€è§ <span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2dpY2V2YS9tYXRlcmlhbHMvcmVzZWFyY2gucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/people/sites/giceva/materials/research.pdf?lang=de">https://db.in.tum.de/people/sites/giceva/materials/research.pdf?lang=de<i class="fa fa-external-link"></i></span> )</p>
<p><img data-src="/images/CMU1544564/Lec01/16.jpg" alt="16.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/17.jpg" alt="17.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/18.jpg" alt="18.jpg"></p>
<h2 id="FLAT-FILE-STRAWMAN-çº¯æ–‡æœ¬ç¨»è‰äºº"><a href="#FLAT-FILE-STRAWMAN-çº¯æ–‡æœ¬ç¨»è‰äºº" class="headerlink" title="FLAT FILE STRAWMAN çº¯æ–‡æœ¬ç¨»è‰äºº"></a>FLAT FILE STRAWMAN çº¯æ–‡æœ¬ç¨»è‰äºº</h2><p>Flat Fileï¼šã€€ä¸€ç§åŒ…å«æ²¡æœ‰ç›¸å¯¹å…³ç³»ç»“æ„çš„è®°å½•çš„æ–‡ä»¶ã€‚ è¿™ä¸ªç±»å‹é€šå¸¸ç”¨æ¥æè¿°æ–‡å­—å¤„ç†ã€å…¶ä»–ç»“æ„å­—ç¬¦æˆ–æ ‡è®°è¢«ç§»é™¤äº†çš„æ–‡æœ¬</p>
<p><img data-src="/images/CMU1544564/Lec01/19.jpg" alt="19.jpg"></p>
<h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>å‡è®¾æˆ‘ä»¬æ²¡æœ‰ä»»ä½•æ•°æ®åº“ï¼Œæˆ‘ä»¬ä»¥çº¯æ–‡æœ¬æ–‡ä»¶(è¿™é‡Œç”¨<code>.csv</code>è¡¨æ ¼æ–‡ä»¶)æ¥å­˜å‚¨æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼š</p>
<ul>
<li><a href="https://cakebytheoceanluo.github.io/download/CMU15445/Lec01_album.csv">lec01_album.csvã€€ä¸‹è½½</a></li>
<li><a href="https://cakebytheoceanluo.github.io/download/CMU15445/Lec01_artist.csv">lec01_artist.csvã€€ä¸‹è½½</a></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec01/20.jpg" alt="20.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/21.jpg" alt="21.jpg"></p>
<p>å¦‚æœæˆ‘ä»¬åœ¨å¼€å‘ä¸€ä¸ªæ™®é€šåº”ç”¨ï¼Œè€Œä¸ä½¿ç”¨ä»»ä½•æ•°æ®åº“ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­ä½¿ç”¨é«˜çº§è¯­è¨€å»ä»£æ›¿SQLæŸ¥è¯¢ã€‚è¿™å½“ç„¶è®©å¼€å‘è¿‡ç¨‹å˜å¾—è‰°éš¾ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ä»…éœ€è¦å®Œæˆæˆ‘ä»¬è‡ªå·±åº”ç”¨çš„å¼€å‘ï¼Œç”šè‡³è¿˜éœ€è¦å®Œæˆä¸€ä¸ªç±»ä¼¼æ•°æ®åº“çš„åº”ç”¨ã€‚ä¸æ­¢å¼€å‘ä»»åŠ¡çš„åŠ é‡ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹è¿™ç§çº¯æ–‡æœ¬å­˜å‚¨çš„ä½œæ³•å…¶ä»–çš„ç¼ºç‚¹ã€‚è¿™äº›ç¼ºç‚¹å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„è®ºç‚¹ã€‚</p>
<h3 id="çº¯æ–‡æœ¬å­˜å‚¨çš„ç¼ºç‚¹ï¼"><a href="#çº¯æ–‡æœ¬å­˜å‚¨çš„ç¼ºç‚¹ï¼" class="headerlink" title="çº¯æ–‡æœ¬å­˜å‚¨çš„ç¼ºç‚¹ï¼"></a>çº¯æ–‡æœ¬å­˜å‚¨çš„ç¼ºç‚¹ï¼</h3><h4 id="DATA-INTEGRITY-æ•°æ®å®Œæ•´æ€§"><a href="#DATA-INTEGRITY-æ•°æ®å®Œæ•´æ€§" class="headerlink" title="DATA INTEGRITY æ•°æ®å®Œæ•´æ€§"></a>DATA INTEGRITY æ•°æ®å®Œæ•´æ€§</h4><p><img data-src="/images/CMU1544564/Lec01/22.jpg" alt="22.jpg"></p>
<blockquote>
<ul>
<li>æˆ‘ä»¬è¯¥å¦‚ä½•ç¡®ä¿è¿™ä¸ªéŸ³ä¹å®¶å¯¹æ¯ä¸ªä¸“è¾‘ éƒ½æ˜¯åŒæ ·çš„é‚£ä¸ªéŸ³ä¹å®¶å‘¢ï¼Ÿ</li>
<li>å¦‚æœæœ‰äººåœ¨å‡ºé“æ—¥æœŸä¸Šå†™äº†ä¸ªâ€˜å“ˆå“ˆå“ˆâ€™ï¼Œæ€ä¹ˆåŠå‘¢</li>
<li>æˆ‘ä»¬è¦å¦‚ä½•å­˜å‚¨å¤šä¸ªéŸ³ä¹å®¶åˆä½œå‘å¸ƒçš„ä¸“è¾‘å‘¢ï¼Ÿ</li>
</ul>
</blockquote>
<p><br></p>
<ul>
<li>æˆ‘ä»¬æˆ–è€…å…¶ä»–ç”¨æˆ·åœ¨æœ‰æ–‡ä»¶æ“ä½œæƒé™çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä»»æ„ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ã€‚è¿™æ ·è¿™ä¸ªæ–‡ä»¶ä¾æ—§æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ™®é€šåº”ç”¨ä¸å†èƒ½ç†è§£è¿™ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶ï¼šæ¯”å¦‚è¯¾ä»¶ä¸­çš„ä¸‰ä¸ªæƒ…å†µ</li>
</ul>
<h4 id="IMPLEMENTATION-å®ç°"><a href="#IMPLEMENTATION-å®ç°" class="headerlink" title="IMPLEMENTATION å®ç°"></a>IMPLEMENTATION å®ç°</h4><p><img data-src="/images/CMU1544564/Lec01/23.jpg" alt="23.jpg"></p>
<ul>
<li>ç¬¬ä¸€ç‚¹ï¼šæˆ‘ä»¬åªèƒ½æ¯æ¬¡è¯»å–æ•´ä¸ªæ–‡ä»¶å»æ‰¾å…¶ä¸­çš„ä¸€ä¸ªrecordï¼Œè¿™æ ·æ˜¯æ²¡æœ‰æ•ˆç‡çš„ã€‚</li>
<li>ç¬¬äºŒç‚¹ï¼šæˆ‘ä»¬ä¹‹å‰æåˆ°äº†ï¼Œå¼€å‘æ•ˆç‡å¾ˆä½ã€‚</li>
</ul>
<h4 id="DURABILITY-æŒä¹…æ€§"><a href="#DURABILITY-æŒä¹…æ€§" class="headerlink" title="DURABILITY æŒä¹…æ€§"></a>DURABILITY æŒä¹…æ€§</h4><p><img data-src="/images/CMU1544564/Lec01/24.jpg" alt="24.jpg"></p>
<ul>
<li>ç¬¬ä¸€ç‚¹: å¦‚æœåœ¨å†™æ–‡ä»¶çš„æ—¶å€™æœºå™¨å®•æœºï¼Œé‚£æ­£åœ¨è¿›è¡Œçš„æ–‡ä»¶ä¿®æ”¹å°±ä¼šæ¶ˆå¤±ã€‚äº‹åŠ¡ transaction</li>
<li>ç¬¬äºŒç‚¹: å¦‚ä½•å¯¹è¿™ä¸ªæ–‡ä»¶æ”¯æŒåˆ†å¸ƒå¼çš„æƒ…å†µ? Scale Out</li>
</ul>
<h2 id="DATABASE-MANAGEMENT-SYSTEM"><a href="#DATABASE-MANAGEMENT-SYSTEM" class="headerlink" title="DATABASE MANAGEMENT SYSTEM"></a>DATABASE MANAGEMENT SYSTEM</h2><p><img data-src="/images/CMU1544564/Lec01/25.jpg" alt="25.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/26.jpg" alt="26.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/27.jpg" alt="27.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/28.jpg" alt="28.jpg"></p>
<p>Edgar F. Codd (Ted Codd.): <span class="exturl" data-url="aHR0cHM6Ly93d3cubmFwLmVkdS9yZWFkLzEyNDczL2NoYXB0ZXIvMTUjODI=" title="https://www.nap.edu/read/12473/chapter/15#82">https://www.nap.edu/read/12473/chapter/15#82<i class="fa fa-external-link"></i></span></p>
<p>Edgar F. Codd (Ted Codd.)æ˜¯æ•°æ®åº“ä¸­å…³ç³»ä»£æ•°çš„å¥ åŸºäººï¼Œå› æ­¤ä»–è·å¾—äº†<span class="exturl" data-url="aHR0cHM6Ly9hbXR1cmluZy5hY20ub3JnL2F3YXJkX3dpbm5lcnMvY29kZF8xMDAwODkyLmNmbQ==" title="https://amturing.acm.org/award_winners/codd_1000892.cfm">1981å¹´çš„å›¾çµå¥–<i class="fa fa-external-link"></i></span>ã€‚</p>
<ul>
<li>A relational model of data for large shared data banks: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzM2MjM4NC4zNjI2ODU=" title="https://dl.acm.org/doi/10.1145/362384.362685">https://dl.acm.org/doi/10.1145/362384.362685<i class="fa fa-external-link"></i></span></li>
<li>Derivability, redundancy and consistency of relations stored in large data banks: <span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzE1NTgzMzQuMTU1ODMzNg==" title="https://dl.acm.org/doi/10.1145/1558334.1558336">https://dl.acm.org/doi/10.1145/1558334.1558336<i class="fa fa-external-link"></i></span></li>
</ul>
<p>å½“æ—¶æ˜¯æ•°æ®åº“çš„è›®è’å¹´ä»£ï¼Œç”šè‡³æ²¡æœ‰relationå…³ç³»ä¸€è¯´ã€‚IBMåœ¨å¼€å‘å½“æ—¶çš„æ•°æ®åº“æ—¶ï¼Œç»å¸¸éœ€è¦æµªè´¹æ—¶é—´å»é‡å†™é‡æ„ä»¥å‰çš„ä»£ç ã€‚è¿™å°±æ˜¯Ted Codd.æå‡ºå…³ç³»ä»£æ•°çš„åŸå› ï¼Œè¿ç”¨å…³ç³»è¿™ä¸ªæ•°å­¦æ¨¡å‹ï¼Œèƒ½å¯¹æ•°æ®å¾ˆå¥½è¿›è¡Œå»ºæ¨¡ï¼Œå‡å°‘ä¸å¿…è¦çš„å¼€å‘æ—¶é—´æµªè´¹ï¼š</p>
<ul>
<li>Store database in simple data structures: å³å…³ç³»relationï¼Œå®ƒæ˜¯å¯¹è¡¨æ ¼çš„æ•°å­¦æŠ½è±¡è¡¨è¾¾ã€‚</li>
<li>Access data through high-level language: æˆ‘ä»¬å¯ä»¥ç†è§£æˆSQL (Ted Codd.å½“æ—¶ç”¨æ˜¯ä¸æ˜¯SQL, ä½†æ˜¯åœ¨å‡ åå¹´çš„å‘å±•ä¸­ï¼Œåªæœ‰SQLå­˜æ´»äº†ä¸‹æ¥ã€‚)</li>
<li>Physical storage left up to implementation: æˆ‘ä»¬ç§° å…³ç³»æ¨¡å‹relation modelä¸ºé€»è¾‘æ¨¡å‹ logical model, å®ƒå’ŒçœŸæ­£çš„å®ç° physical storage æ²¡æœ‰å¾ˆå¤§å…³ç³»ã€‚æ­£æ˜¯å› ä¸ºè¿™ä¸ªlogical å’Œ physical çš„è§£è€¦ï¼ŒIBMå½“æ—¶æ‰èƒ½é¿å…ä¸æ–­é‡æ„ä»£ç è€Œå»èŠ‚çœæ—¶é—´ã€‚</li>
</ul>
<h2 id="DATA-MODELS"><a href="#DATA-MODELS" class="headerlink" title="DATA MODELS"></a>DATA MODELS</h2><p><img data-src="/images/CMU1544564/Lec01/29.jpg" alt="29.jpg"></p>
<ul>
<li>data model: High level abstraction of relation</li>
<li>schemaæ¶æ„: å¯¹åº”SQL<code>create table</code>è¯­å¥ï¼Œå…³ç³»æ•°æ®åº“ä¸­æ¯ä¸€ä¸ªè¡¨æ ¼ä¸­æ¯ä¸€ä¸ªå­—æ®µçš„å­—æ®µåå’Œå­—æ®µå€¼çš„æ•°æ®ç±»å‹éœ€è¦ä¸€å¼€å§‹å°±è¢«æŒ‡å®šï¼Œä¸èƒ½æ›´æ”¹ã€‚ </li>
</ul>
<p><img data-src="/images/CMU1544564/Lec01/30.jpg" alt="30.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/31.jpg" alt="31.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/32.jpg" alt="32.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/33.jpg" alt="33.jpg"><br>æœ€åçš„ Hierachical å’Œã€€Networkå±äº é—äº§ç³»ç»Ÿ Legacy systemã€‚</p>
<p><img data-src="/images/CMU1544564/Lec01/34.jpg" alt="34.jpg"></p>
<p><br><br><br></p>
<h1 id="RELATIONAL-MODEL-å…³ç³»æ¨¡å‹"><a href="#RELATIONAL-MODEL-å…³ç³»æ¨¡å‹" class="headerlink" title="RELATIONAL MODEL å…³ç³»æ¨¡å‹"></a>RELATIONAL MODEL å…³ç³»æ¨¡å‹</h1><p><img data-src="/images/CMU1544564/Lec01/35.jpg" alt="35.jpg"></p>
<p>å…³ç³»æ¨¡å‹æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>Structure: table schema</li>
<li>Integrity: ç¡®ä¿æ•°æ®åº“çš„å†…å®¹æ»¡è¶³é™åˆ¶ï¼Œä¹ŸåŒ…å«table schema å’Œ <code>create table</code>ä¸­çš„æŒ‡ä»¤, æ¯”å¦‚<code>check</code></li>
<li>Manipulation: SQL</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec01/36.jpg" alt="36.jpg"></p>
<ul>
<li><strong>å…³ç³»ä»£æ•°çš„å…³ç³»æ˜¯ä¸€ä¸ªä¸å¸¦é¡ºåºçš„é›†åˆ</strong></li>
<li><code>NULL</code> æ˜¯ä¸€ä¸ªæœªå®šä¹‰ã€€æœªçŸ¥çš„å€¼ï¼Œå®ƒåœ¨æ•°æ®åº“çš„çš„è¡¨è¾¾å’Œå…·ä½“å®ç°ç›¸å…³ã€‚</li>
</ul>
<h2 id="PRIMARY-KEYS-ä¸»é”®"><a href="#PRIMARY-KEYS-ä¸»é”®" class="headerlink" title="PRIMARY KEYS ä¸»é”®"></a>PRIMARY KEYS ä¸»é”®</h2><p><img data-src="/images/CMU1544564/Lec01/37.jpg" alt="37.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/38.jpg" alt="38.jpg"></p>
<h2 id="FOREIGN-KEYS-å¤–é”®"><a href="#FOREIGN-KEYS-å¤–é”®" class="headerlink" title="FOREIGN KEYSã€€å¤–é”®"></a>FOREIGN KEYSã€€å¤–é”®</h2><p><img data-src="/images/CMU1544564/Lec01/39.jpg" alt="39.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/40.jpg" alt="40.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/41.jpg" alt="41.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/42.jpg" alt="42.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/43.jpg" alt="43.jpg"></p>
<ul>
<li>Cascade Deletion: å¦‚æœä¸€ä¸ªè¡¨çš„ä¸€ä¸ªtuple(å…ƒç»„)è¢«åˆ é™¤ï¼Œå¯¹åº”çš„å…¶ä»–è¡¨ä¸­çš„å¤–é”®ç›¸å…³è”çš„tupleä¹Ÿä¼šè¢«åˆ é™¤</li>
<li><code>ArtistAlbum</code>è¡¨æ ¼çš„å­˜åœ¨ï¼š<ul>
<li>å…è®¸ä¸€ä¸ªArtistå¯¹åº”å¤šä¸ªAlbum (<code>1:N</code>çš„å…³ç³»)</li>
<li>å…è®¸ä¸€ä¸ªAlbumå¯¹åº”å¤šä¸ªArtist (<code>1:N</code>çš„å…³ç³»)</li>
</ul>
</li>
</ul>
<h2 id="DATA-MANIPULATION-LANGUAGES-DML"><a href="#DATA-MANIPULATION-LANGUAGES-DML" class="headerlink" title="DATA MANIPULATION LANGUAGES (DML)"></a>DATA MANIPULATION LANGUAGES (DML)</h2><p><img data-src="/images/CMU1544564/Lec01/44.jpg" alt="44.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/45.jpg" alt="45.jpg"></p>
<p>æˆ‘ä»¬åœ¨è¿™é—¨è¯¾ä¸­åªå­¦ä¹  relation algebraå…³ç³»ä»£æ•°ã€‚</p>
<p><br><br><br></p>
<h1 id="RELATIONAL-ALGEBRA-å…³ç³»ä»£æ•°"><a href="#RELATIONAL-ALGEBRA-å…³ç³»ä»£æ•°" class="headerlink" title="RELATIONAL ALGEBRA å…³ç³»ä»£æ•°"></a>RELATIONAL ALGEBRA å…³ç³»ä»£æ•°</h1><p><img data-src="/images/CMU1544564/Lec01/46.jpg" alt="46.jpg"></p>
<p>å…³ç³»ä»£æ•°åŸºäºé›†åˆä»£æ•°(set algebra)ï¼Œä½†æ˜¯æ‹¥æœ‰æ›´å¤šçš„è¿ç®—ç¬¦å·ã€‚</p>
<h2 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a>SELECT</h2><p><img data-src="/images/CMU1544564/Lec01/47.jpg" alt="47.jpg"></p>
<p>SELECTèµ·åˆ°ä¸€ä¸ªå¯¹è°“è¯åˆ¤æ–­(predicate)çš„ç­›é€‰ä½œç”¨ï¼š è¿ç”¨æ¡ä»¶ï¼Œç­›é€‰å¾—åˆ°æ»¡è¶³æ¡ä»¶çš„tupleï¼Œä½†æ˜¯ä¸æ”¹å˜è¿™äº›tupleã€‚ã€</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼š<strong>å…³ç³»ä»£æ•°ä¸­çš„SELECTè¿ç®—ç¬¦ã€€å¯¹åº”ã€€SQLä¸­çš„WHEREä»å¥</strong></p>
<h2 id="PROJECTION"><a href="#PROJECTION" class="headerlink" title="PROJECTION"></a>PROJECTION</h2><p><img data-src="/images/CMU1544564/Lec01/48.jpg" alt="48.jpg"></p>
<p>PROJECTIONæ˜¯å¯¹åŸtupleè¿›è¡Œæ“ä½œï¼ŒæŠ•å½±å‡ºæ‰€éœ€è¦çš„å­—æ®µï¼Œå»æ‰ä¸éœ€è¦çš„å­—æ®µ</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼š<strong>å…³ç³»ä»£æ•°ä¸­çš„PROJECTIONè¿ç®—ç¬¦ã€€å¯¹åº”ã€€SQLä¸­çš„SELECTä»å¥</strong></p>
<h2 id="UNION"><a href="#UNION" class="headerlink" title="UNION"></a>UNION</h2><p><img data-src="/images/CMU1544564/Lec01/49.jpg" alt="49.jpg"></p>
<h2 id="INTERSECTION"><a href="#INTERSECTION" class="headerlink" title="INTERSECTION"></a>INTERSECTION</h2><p><img data-src="/images/CMU1544564/Lec01/50.jpg" alt="50.jpg"></p>
<h2 id="DIFFERENCE"><a href="#DIFFERENCE" class="headerlink" title="DIFFERENCE"></a>DIFFERENCE</h2><p><img data-src="/images/CMU1544564/Lec01/51.jpg" alt="51.jpg"></p>
<!-- TODO: union all, intersection all, except all -->
<h2 id="PRODUCT"><a href="#PRODUCT" class="headerlink" title="PRODUCT"></a>PRODUCT</h2><p><img data-src="/images/CMU1544564/Lec01/52.jpg" alt="52.jpg"></p>
<h2 id="JOIN"><a href="#JOIN" class="headerlink" title="JOIN"></a>JOIN</h2><p><img data-src="/images/CMU1544564/Lec01/53.jpg" alt="53.jpg"></p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼š <code>NATURAL JOIN</code>åªæ˜¯joinçš„ä¸€ç§æƒ…å†µï¼ŒæŒ‡ä¸¤ä¸ªè¡¨æ ¼çš„<strong>ç›¸åŒåå­—ï¼Œç›¸åŒæ•°æ®ç±»å‹</strong>çš„å­—æ®µè¿›è¡Œè¿æ¥(Join)ã€‚æˆ‘ä»¬ä»»ç„¶æœ‰å¾ˆå¤šå¾ˆå¤šé€”å¾„å»å®Œæˆjoin, è§ <a href="https://cakebytheoceanluo.github.io/2020/02/22/SQL-%E5%9F%BA%E7%A1%80SQL/">[SQL]åŸºç¡€SQL</a></p>
<h2 id="EXTRA-OPERATORS"><a href="#EXTRA-OPERATORS" class="headerlink" title="EXTRA OPERATORS"></a>EXTRA OPERATORS</h2><p><img data-src="/images/CMU1544564/Lec01/54.jpg" alt="54.jpg"></p>
<p>å…¶ä»–è¯¾ä¸Šæ²¡æœ‰è®²çš„è¿ç®—ç¬¦ä¾ç„¶å¾ˆé‡è¦ï¼Œéœ€è¦è‡ªå·±å»çœ‹ä¹¦äº†è§£ã€‚è¿™äº›ç¬¦å·ç»å¸¸ä¼šåœ¨æ•°æ®åº“è®ºæ–‡ä¸­å‡ºç°ã€‚</p>
<!-- TODO: å…³ç³»ä»£æ•°ç¬¦å· -->
<p><br></p>
<h1 id="ç»“è®ºå’Œå…¶ä»–"><a href="#ç»“è®ºå’Œå…¶ä»–" class="headerlink" title="ç»“è®ºå’Œå…¶ä»–"></a>ç»“è®ºå’Œå…¶ä»–</h1><p><img data-src="/images/CMU1544564/Lec01/55.jpg" alt="55.jpg"></p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä¸€ä¸ªæŸ¥è¯¢ï¼Œå¯ä»¥æœ‰ä¸åŒçš„é€”å¾„(å…³ç³»ä»£æ•°è¡¨è¾¾å¼)å»å®Œæˆã€‚è¿™äº›é€”å¾„çš„å¤æ‚åº¦å¾ˆå¯èƒ½ä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ˜¯æ•°æ®åº“SQLçš„ä¸€ä¸ªä¼˜åŒ–ç‚¹ã€‚ã€€(logical plan)</li>
<li>SQLæ˜¯å±äº<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRGVjbGFyYXRpdmVfcHJvZ3JhbW1pbmc=" title="https://en.wikipedia.org/wiki/Declarative_programming">å£°æ˜å¼ç¼–ç¨‹ Declarative programming<i class="fa fa-external-link"></i></span>ï¼Œå°±æ˜¯æˆ‘ä»¬åªæ˜¯æŒ‡å®šæˆ‘ä»¬æƒ³å¾—åˆ°ä»€ä¹ˆæ•°æ®ï¼Œè€Œä¸æŒ‡å®šé€šè¿‡ä»€ä¹ˆå½¢å¼å»è·å¾—å®ƒã€‚è¿™ä¸ªç»™äº†æ•°æ®åº“å»æ‰¾å‡ºæœ€ä½³çš„(æœ€å¿«é€Ÿçš„)é€”å¾„å»è§£å†³SQLæŸ¥è¯¢ã€‚ä¹Ÿæ˜ ç…§äº†ä¸Šä¸€ç‚¹æåˆ°çš„<strong>ä¼˜åŒ–ç‚¹</strong>ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec01/56.jpg" alt="56.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/57.jpg" alt="57.jpg"> </p>
<h1 id="Last-Word-joy"><a href="#Last-Word-joy" class="headerlink" title="Last Word (:joy:)"></a>Last Word (<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">ğŸ˜‚</span>)</h1><blockquote>
<p>The most important thing you need to understand about databases throughout this, through the rest of your life is the following: when you look back at the 36 Chambers, understand who were the original 9 involved in it. You have the RZA, the GZA, Inspectah Deck, Ghostface Killah, Masta Killa, U-God, Method Man, Olâ€™ Dirty Bastard, Raekwon. But, the other important thing too is Cappadonna was in jail at the time, so he was actually an original member of the clan. But because he was in jail, he couldnâ€™t be on the 36 Chambers. So, thatâ€™s the most important thing you need to understand throughout this entire semester.</p>
</blockquote>
<p>å¼•ç”¨ï¼š</p>
<p>CMU 15445 1.å…³ç³»æ¨¡å‹ - è¥¿éƒ¨å°ç¬¼åŒ…: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9kZDRlNDgwYjRjODQ=" title="https://www.jianshu.com/p/dd4e480b4c84">https://www.jianshu.com/p/dd4e480b4c84<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
        <category>SQL</category>
        <category>Relation Algebra</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Relation Algebra</tag>
      </tags>
  </entry>
  <entry>
    <title>[CMU-15445]Lec00</title>
    <url>/2020/03/05/CMU-15445-Lec00/</url>
    <content><![CDATA[<p>CMU 15-445/645 Intro to Database Systems æ˜¯ä¸€é—¨éå¸¸ä¼˜ç§€çš„<strong>å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</strong>å…¥é—¨çš„è¯¾ã€‚å®ƒä»ç³»ç»Ÿçš„è§’åº¦ï¼Œå¯¹å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„å„ä¸ªç»„æˆéƒ¨åˆ†è¿›è¡Œä»‹ç»ã€‚å®ƒå¸®åŠ©æˆ‘æ³¨æ„åˆ°äº†å¾ˆå¤šæˆ‘ä¹‹å‰ç–æ¼çš„åœ°æ–¹ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½å¯¹æ‰€æœ‰æ•°æ®åº“æ¦‚å¿µæŸ¥æ¼è¡¥ç¼ºçš„æœºä¼šã€‚è¿™é‡Œæˆ‘ä»¥2019 Fallå­¦æœŸçš„å†…å®¹ä¸ºä¸»ï¼Œåˆ†äº«æˆ‘çš„ç¬”è®°ã€‚</p>
<a id="more"></a>
<h1 id="æ•™æˆ"><a href="#æ•™æˆ" class="headerlink" title="æ•™æˆ"></a>æ•™æˆ</h1><p>å¤§åé¼é¼çš„<span class="exturl" data-url="aHR0cHM6Ly93d3cuY3MuY211LmVkdS9+cGF2bG8v" title="https://www.cs.cmu.edu/~pavlo/">Andy Pavlo<i class="fa fa-external-link"></i></span></p>
<p>æˆ‘å¾ˆæœ‰å¹¸åœ¨ä»–æ¥TUMçš„æ—¶å€™ï¼Œå¬äº†ä¸€æ¬¡ä»–çš„ guest lectureã€‚</p>
<h1 id="è¯¾ç¨‹é¡µé¢"><a href="#è¯¾ç¨‹é¡µé¢" class="headerlink" title="è¯¾ç¨‹é¡µé¢"></a>è¯¾ç¨‹é¡µé¢</h1><p>åœ¨è¯¾ç¨‹é¡µé¢ä¸­å¯ä»¥æ‰¾åˆ°è¯¾ä»¶ï¼Œä½œä¸š(ä»¥åŠç­”æ¡ˆ)ï¼Œå®éªŒ(Assignment)ç­‰ç­‰ææ–™ï¼š</p>
<ul>
<li>2019: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTkv" title="https://15445.courses.cs.cmu.edu/fall2019/">https://15445.courses.cs.cmu.edu/fall2019/<i class="fa fa-external-link"></i></span></li>
<li>2018: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTgv" title="https://15445.courses.cs.cmu.edu/fall2018/">https://15445.courses.cs.cmu.edu/fall2018/<i class="fa fa-external-link"></i></span></li>
<li>2017: <span class="exturl" data-url="aHR0cHM6Ly8xNTQ0NS5jb3Vyc2VzLmNzLmNtdS5lZHUvZmFsbDIwMTcv" title="https://15445.courses.cs.cmu.edu/fall2017/">https://15445.courses.cs.cmu.edu/fall2017/<i class="fa fa-external-link"></i></span></li>
</ul>
<p>2018å’Œ2019å¾ˆåƒï¼Œä½†æ˜¯2017å¹´çš„å†…å®¹ä¸å¤ªä¸€æ ·ã€‚</p>
<h1 id="è¯¾ç¨‹è§†é¢‘å½•åƒ"><a href="#è¯¾ç¨‹è§†é¢‘å½•åƒ" class="headerlink" title="è¯¾ç¨‹è§†é¢‘å½•åƒ"></a>è¯¾ç¨‹è§†é¢‘å½•åƒ</h1><h2 id="YouTube"><a href="#YouTube" class="headerlink" title="YouTube"></a>YouTube</h2><ul>
<li>2019: <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1vZVlCZGdoYUlqYyZhbXA7bGlzdD1QTFNFOE9EaGpaWGpib2hrTkJXUXNfb3RUckJUcmp5b2hp" title="https://www.youtube.com/watch?v=oeYBdghaIjc&amp;list=PLSE8ODhjZXjbohkNBWQs_otTrBTrjyohi">https://www.youtube.com/watch?v=oeYBdghaIjc&amp;list=PLSE8ODhjZXjbohkNBWQs_otTrBTrjyohi<i class="fa fa-external-link"></i></span></li>
<li>2018: <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj12eVZHbV8yaUZ3VSZhbXA7bGlzdD1QTFNFOE9EaGpaWGphM2hnbXV3aGY4OXFib1Yxa094TXg3" title="https://www.youtube.com/watch?v=vyVGm_2iFwU&amp;list=PLSE8ODhjZXja3hgmuwhf89qboV1kOxMx7">https://www.youtube.com/watch?v=vyVGm_2iFwU&amp;list=PLSE8ODhjZXja3hgmuwhf89qboV1kOxMx7<i class="fa fa-external-link"></i></span></li>
<li>2017: <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj14amhRMGU5SGxkcyZhbXA7bGlzdD1QTFNFOE9EaGpaWGpZdXRWelRlQWRzOHhVdDFyY215VDd4" title="https://www.youtube.com/watch?v=xjhQ0e9Hlds&amp;list=PLSE8ODhjZXjYutVzTeAds8xUt1rcmyT7x">https://www.youtube.com/watch?v=xjhQ0e9Hlds&amp;list=PLSE8ODhjZXjYutVzTeAds8xUt1rcmyT7x<i class="fa fa-external-link"></i></span></li>
</ul>
<h2 id="å“”å“©å“”å“©"><a href="#å“”å“©å“”å“©" class="headerlink" title="å“”å“©å“”å“©"></a>å“”å“©å“”å“©</h2><p>è¯¾ç¨‹è§†é¢‘æ˜¯åº”ç”¨Creative Commonsç‰ˆæƒåè®®ï¼Œè§ã€€<span class="exturl" data-url="aHR0cHM6Ly9zdXBwb3J0Lmdvb2dsZS5jb20veW91dHViZS9hbnN3ZXIvMjc5NzQ2OA==" title="https://support.google.com/youtube/answer/2797468">https://support.google.com/youtube/answer/2797468<i class="fa fa-external-link"></i></span> ã€‚å› æ­¤æˆ‘ä»¬åœ¨Bç«™ä¹Ÿå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ï¼š</p>
<ul>
<li>2019: <span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL2F2OTE5MTkzMjk/ZnJvbT1zZWFyY2gmYW1wO3NlaWQ9MTU5ODIyNTc4MDMxODkyNDIxNjY=" title="https://www.bilibili.com/video/av91919329?from=search&amp;seid=15982257803189242166">https://www.bilibili.com/video/av91919329?from=search&amp;seid=15982257803189242166<i class="fa fa-external-link"></i></span></li>
<li>2018: <span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL2F2Mzk3MzExODU/ZnJvbT1zZWFyY2gmYW1wO3NlaWQ9MTU5ODIyNTc4MDMxODkyNDIxNjY=" title="https://www.bilibili.com/video/av39731185?from=search&amp;seid=15982257803189242166">https://www.bilibili.com/video/av39731185?from=search&amp;seid=15982257803189242166<i class="fa fa-external-link"></i></span></li>
<li>2017: æ— </li>
</ul>
<h1 id="éŸ³ä¹-joy"><a href="#éŸ³ä¹-joy" class="headerlink" title="éŸ³ä¹ (:joy:)"></a>éŸ³ä¹ (<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">ğŸ˜‚</span>)</h1><ul>
<li>2018å¼€åœºéŸ³ä¹:<br>ã€€A Tribe Called Quest - Vibes and Stuff <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj0yZmtiZ1IyRnN3aw==" title="https://www.youtube.com/watch?v=2fkbgR2Fswk">https://www.youtube.com/watch?v=2fkbgR2Fswk<i class="fa fa-external-link"></i></span></li>
<li>2018ç»“æŸéŸ³ä¹:<br>ã€€Geto Boys &amp; Ice Cube - 5th Ward South Central Malt <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1WRERQOUozR2Y4cw==" title="https://www.youtube.com/watch?v=VDDP9J3Gf8s">https://www.youtube.com/watch?v=VDDP9J3Gf8s<i class="fa fa-external-link"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1aZDd3alJDR2otUQ==" title="https://www.youtube.com/watch?v=Zd7wjRCGj-Q">https://www.youtube.com/watch?v=Zd7wjRCGj-Q<i class="fa fa-external-link"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly9nZW5pdXMuY29tL0dldG8tYm95cy01dGgtd2FyZC1zb3V0aC1jZW50cmFsLW1hbHQtbHlyaWNz" title="https://genius.com/Geto-boys-5th-ward-south-central-malt-lyrics">https://genius.com/Geto-boys-5th-ward-south-central-malt-lyrics<i class="fa fa-external-link"></i></span></li>
<li>2019å¼€åœºéŸ³ä¹:<br>ã€€Dan Le Sac &amp; Scroobius Pip - Thou Shalt Always Kill <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1DV3JNR1h3aEZMaw==" title="https://www.youtube.com/watch?v=CWrMGXwhFLk">https://www.youtube.com/watch?v=CWrMGXwhFLk<i class="fa fa-external-link"></i></span></li>
<li>2019ç»“æŸéŸ³ä¹:<br>ã€€Wu-Tang Clan - Shaolin Brew <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1WcmhZMHFSXzdVMA==" title="https://www.youtube.com/watch?v=VrhY0qR_7U0">https://www.youtube.com/watch?v=VrhY0qR_7U0<i class="fa fa-external-link"></i></span></li>
</ul>
<h1 id="SYLLABUS-COURSE-INFORMATION"><a href="#SYLLABUS-COURSE-INFORMATION" class="headerlink" title="SYLLABUS -  COURSE INFORMATION"></a>SYLLABUS -  COURSE INFORMATION</h1><blockquote>
<p>This course is on the design and implementation of database management systems. Topics include data models (relational, document, key/value), storage models (n-ary, decomposition), query languages (SQL, stored procedures), storage architectures (heaps, log-structured), indexing (order preserving trees, hash tables), transaction processing (ACID, concurrency control), recovery (logging, checkpoints), query processing (joins, sorting, aggregation, optimization), and parallel architectures (multi-core, distributed). Case studies on open-source and commercial database systems are used to illustrate these techniques and trade-offs. The course is appropriate for students with lit systems programming skills.</p>
</blockquote>
<h1 id="è¯¾ç¨‹è¦æ±‚"><a href="#è¯¾ç¨‹è¦æ±‚" class="headerlink" title="è¯¾ç¨‹è¦æ±‚"></a>è¯¾ç¨‹è¦æ±‚</h1><p>è¿™éƒ¨åˆ†æ˜¯æˆ‘<strong>ä¸»è§‚</strong>çš„æƒ³æ³•å’Œç»éªŒï¼Œæˆ‘åŸºæœ¬çœ‹è¿‡æ•´ä¸ªè¯¾å†…å®¹ï¼ŒæŠ½è±¡å‡ºè¿™é—¨è¯¾å†…å®¹ä¸Šçš„è¦æ±‚ï¼š</p>
<ul>
<li>æœ¬ç§‘ç”ŸåŸºç¡€è¯¾ç¨‹åº¦çš„ è®¡ç®—æœºç»„æˆ <ul>
<li>CPUä¸­æŒ‡ä»¤çš„æ‰§è¡Œ</li>
<li>å­˜å‚¨å±‚æ¬¡(<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTWVtb3J5X2hpZXJhcmNoeQ==" title="https://en.wikipedia.org/wiki/Memory_hierarchy">Memory hierarchy<i class="fa fa-external-link"></i></span>)</li>
<li>æŒ‡ä»¤æµæ°´çº¿ï¼Œåˆ†æ”¯é¢„æµ‹(<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJlZGljYXRpb25fKGNvbXB1dGVyX2FyY2hpdGVjdHVyZQ==" title="https://en.wikipedia.org/wiki/Predication_(computer_architecture">Predication<i class="fa fa-external-link"></i></span>))</li>
<li>å•æŒ‡ä»¤æµå¤šæ•°æ®æµ Single instruction, multiple data (SIMD)</li>
</ul>
</li>
<li>æœ¬ç§‘ç”ŸåŸºç¡€è¯¾ç¨‹åº¦çš„ æ“ä½œç³»ç»Ÿ<ul>
<li>çº¿ç¨‹ä¸è¿›ç¨‹å…³è”å’Œé€šä¿¡</li>
<li>å†…å­˜ç®¡ç†ï¼Œè™šæ‹Ÿå†…å­˜</li>
<li>æ–‡ä»¶ç³»ç»Ÿ</li>
</ul>
</li>
<li>æœ¬ç§‘ç”ŸåŸºç¡€è¯¾ç¨‹åº¦çš„ã€€æ•°æ®åº“è¯¾ç¨‹<ul>
<li>äº†è§£ç†è®ºæ¦‚å¿µå³å¯</li>
</ul>
</li>
<li>è¶…è¿‡æœ¬ç§‘ç”ŸåŸºç¡€è¯¾ç¨‹åº¦çš„ã€€ç°ä»£C++ç¼–ç¨‹èƒ½åŠ›<ul>
<li>C++11 å’Œ C++17</li>
<li>çº¿ç¨‹å®‰å…¨</li>
<li>C++é¡¹ç›®ç®¡ç†<ul>
<li>git</li>
<li>CMake</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>åè€Œå•çº¯æ•°æ®åº“ä¸­ç†è®ºçš„ä¸œè¥¿ä¸å†é‡è¦ï¼Œå¦‚Function Dependency, Normal Form, Tuple Calculus, Domain Calculusã€‚(2019 Fall)è¿™é—¨è¯¾èˆå¼ƒäº†è¿™äº›ä¸œè¥¿ï¼Œæ¥æœ‰æ›´å¤šæ—¶é—´èŠ±åœ¨æ•°æ®åº“æ“ä½œç³»ç»Ÿå†…éƒ¨çš„æ¶æ„å’Œå®ç°ã€‚æˆ‘ä¸ªäººå»ºè®®æœ€å¥½åŒæ—¶ä¹Ÿä¸Šè¿‡æœ¬ç§‘ç”Ÿç¨‹åº¦çš„æ•°æ®åº“è¯¾ç¨‹ï¼Œè¿™æ ·èƒ½å°†æ‰€æœ‰ç†è®ºæ¦‚å¿µå’Œå®ç°è”ç³»åœ¨ä¸€èµ·ã€‚ä½†æ˜¯æ€»ä½“ä¸Šï¼Œå¯¹ç³»ç»Ÿæ–¹å‘çš„è¦æ±‚è¿œè¿œé«˜äºå¯¹ç†è®ºçš„è¦æ±‚ã€‚</p>
<h1 id="å…¶ä»–äººçš„ç¬”è®°"><a href="#å…¶ä»–äººçš„ç¬”è®°" class="headerlink" title="å…¶ä»–äººçš„ç¬”è®°"></a>å…¶ä»–äººçš„ç¬”è®°</h1><h2 id="å®Œæ•´ç¬”è®°"><a href="#å®Œæ•´ç¬”è®°" class="headerlink" title="å®Œæ•´ç¬”è®°"></a>å®Œæ•´ç¬”è®°</h2><p>æ•°æ®åº“è®¾è®¡ - è¥¿éƒ¨å°ç¬¼åŒ… <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vbmIvMzYyNjU4NDE=" title="https://www.jianshu.com/nb/36265841">https://www.jianshu.com/nb/36265841<i class="fa fa-external-link"></i></span></p>
<p>Database - fxjwindã€€<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnhqd2luZC9jYXRlZ29yeS8xNDkzODMzLmh0bWw=" title="https://www.cnblogs.com/fxjwind/category/1493833.html">https://www.cnblogs.com/fxjwind/category/1493833.html<i class="fa fa-external-link"></i></span></p>
<h2 id="éå®Œæ•´ç¬”è®°"><a href="#éå®Œæ•´ç¬”è®°" class="headerlink" title="éå®Œæ•´ç¬”è®°"></a>éå®Œæ•´ç¬”è®°</h2><p>Gexriorçš„åšå®¢ <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0dleHJpb3I=" title="https://blog.csdn.net/Gexrior">https://blog.csdn.net/Gexrior<i class="fa fa-external-link"></i></span></p>
<p>CMUæ•°æ®åº“ç³»ç»Ÿæ€»ç»“ - liu-jianhaoâ€™s Blog <span class="exturl" data-url="aHR0cHM6Ly9saXUtamlhbmhhby5naXRodWIuaW8vMjAxOC8xMC9jbXUlRTYlOTUlQjAlRTYlOEQlQUUlRTUlQkElOTMlRTclQjMlQkIlRTclQkIlOUYlRTYlODAlQkIlRTclQkIlOTMv" title="https://liu-jianhao.github.io/2018/10/cmu%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%80%BB%E7%BB%93/">https://liu-jianhao.github.io/2018/10/cmu%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%80%BB%E7%BB%93/<i class="fa fa-external-link"></i></span></p>
<p><br><br><br></p>
<hr>
<h1 id="ADMINISTRIVIA"><a href="#ADMINISTRIVIA" class="headerlink" title="ADMINISTRIVIA"></a>ADMINISTRIVIA</h1><p>ç¬¬ä¸€æ¬¡è¯¾çš„æ—¶å€™æåˆ°è¿™é—¨è¯¾çš„ç»“æ„ç­‰äº‹é¡¹ï¼Œæˆ‘ä»¬ç§»æ­¥åˆ°è¿™ä¸€æ¬¡ç¬”è®°ä¸­ï¼š</p>
<p><img data-src="/images/CMU1544564/Lec01/6.jpg" alt="6.jpg"></p>
<p><img data-src="/images/CMU1544564/Lec01/8.jpg" alt="8.jpg"></p>
<ul>
<li>ç¬¬å…­ç‰ˆï¼š<span class="exturl" data-url="aHR0cHM6Ly9kYi1ib29rLmNvbS9kYjYvaW5kZXguaHRtbA==" title="https://db-book.com/db6/index.html">https://db-book.com/db6/index.html<i class="fa fa-external-link"></i></span></li>
<li>ç¬¬ä¸ƒç‰ˆï¼š<span class="exturl" data-url="aHR0cHM6Ly9kYi1ib29rLmNvbS9kYjcvaW5kZXguaHRtbA==" title="https://db-book.com/db7/index.html">https://db-book.com/db7/index.html<i class="fa fa-external-link"></i></span></li>
<li>è¿™ä¸€é—¨è¯¾ä¸»è¦ä»‹ç»çš„å†…å®¹éƒ½æ˜¯å‡ åå¹´å‰æˆç†Ÿçš„æŠ€æœ¯ã€‚æ‰€æœ‰ä¸¤ç‰ˆä¹¦å¯¹æˆ‘ä»¬å­¦ç”Ÿéƒ½ä¸€æ ·ã€‚</li>
<li>è¿™ä¸ªä¹¦æˆ‘æ¨èè‹±æ–‡ç‰ˆçš„ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yNjA0NTkzMS8=" title="https://book.douban.com/subject/26045931/">https://book.douban.com/subject/26045931/<i class="fa fa-external-link"></i></span>ã€€é«˜ç­‰æ•™è‚²å‡ºç‰ˆç¤¾å‡ºç‰ˆäº†å½±å°ç‰ˆï¼Œé€‚åˆå›½å†…å–œæ¬¢å®ä½“çº¸è´¨ä¹¦çš„åŒå­¦ã€‚</li>
</ul>
<p><img data-src="/images/CMU1544564/Lec01/12.jpg" alt="12.jpg"></p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NtdS1kYi9idXN0dWI=" title="https://github.com/cmu-db/bustub">https://github.com/cmu-db/bustub<i class="fa fa-external-link"></i></span></li>
</ul>
<p><img data-src="/images/CMU1544564/Lec01/15.jpg" alt="15.jpg"></p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5jcy5jbXUuZWR1Lw==" title="https://db.cs.cmu.edu/">https://db.cs.cmu.edu/<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NtdS1kYi90ZXJyaWVy" title="https://github.com/cmu-db/terrier">https://github.com/cmu-db/terrier<i class="fa fa-external-link"></i></span></li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>CMU-15445</category>
      </categories>
  </entry>
  <entry>
    <title>[Security]GPGç®¡ç†å’Œæ–‡ä»¶åŠ å¯†</title>
    <url>/2020/03/03/Security-GPG-encrypt/</url>
    <content><![CDATA[<p>æˆ‘ä»¬åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­è®¤è¯†äº†GPGå’Œå®ƒåœ¨GitHubä¸­å®‰å…¨ç­¾åçš„ä½œç”¨ã€‚è§<a href="https://cakebytheoceanluo.github.io/2020/03/02/Security-GPG-intro/">[Security] GPG ä»‹ç»ä¸å¯†é’¥ç”Ÿæˆ</a> å’Œ <a href="https://cakebytheoceanluo.github.io/2020/03/02/Security-GPG-intro/">[Security] GPG ä»‹ç»ä¸å¯†é’¥ç”Ÿæˆ</a>ã€‚</p>
<p>é™¤äº†ä¸Šé¢æåˆ°çš„ç”¨é€”ä»¥å¤–ï¼Œgpgè¿˜æœ‰è®¸å¤šä½œç”¨ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»gpgçš„ç®¡ç†å’Œæ–‡ä»¶åŠ å¯†ã€‚</p>
<a id="more"></a>
<p><br></p>
<h1 id="å¯†é’¥ç®¡ç†"><a href="#å¯†é’¥ç®¡ç†" class="headerlink" title="å¯†é’¥ç®¡ç†"></a>å¯†é’¥ç®¡ç†</h1><h2 id="åˆ—å‡ºå¯†é’¥"><a href="#åˆ—å‡ºå¯†é’¥" class="headerlink" title="åˆ—å‡ºå¯†é’¥"></a>åˆ—å‡ºå¯†é’¥</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --list-keys</span><br><span class="line"></span><br><span class="line">/home/jigao/.gnupg/pubring.kbx</span><br><span class="line">------------------------------</span><br><span class="line">pub   rsa4096 2020-03-02 [SC]</span><br><span class="line">      704A75374771234881B10559F98069D551217BFD</span><br><span class="line">uid           [ultimate] Jigao Luo &lt;luojigao@outlook.com&gt;</span><br><span class="line">sub   rsa4096 2020-03-02 [E]</span><br></pre></td></tr></tbody></table></figure>
<p>ç¬¬ä¸€è¡Œæ˜¾ç¤ºå…¬é’¥æ–‡ä»¶å(pubring.gpg)ï¼Œç¬¬äºŒè¡Œæ˜¾ç¤ºå…¬é’¥ç‰¹å¾(4096ä½ï¼ŒHashå­—ç¬¦ä¸²å’Œç”Ÿæˆæ—¶é—´)ï¼Œç¬¬ä¸‰è¡Œæ˜¾ç¤ºâ€ç”¨æˆ·ID uidâ€ï¼Œç¬¬å››è¡Œæ˜¾ç¤ºç§é’¥ç‰¹å¾ã€‚<sup><a href="#myfootnote1">1</a></sup></p>
<p>æˆ–è€…å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå»åˆ—å‡ºå¯†é’¥ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --list-secret-keys --keyid-format LONG</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><br></p>
<h2 id="è·å¾—å®Œæ•´å…¬é’¥"><a href="#è·å¾—å®Œæ•´å…¬é’¥" class="headerlink" title="è·å¾—å®Œæ•´å…¬é’¥"></a>è·å¾—å®Œæ•´å…¬é’¥</h2><p>å…¬é’¥(public key)æ–‡ä»¶(.gnupg/pubring.gpg)ä»¥äºŒè¿›åˆ¶å½¢å¼å‚¨å­˜ï¼Œ<code>--armorå‚æ•°</code>å¯ä»¥å°†å…¶è½¬æ¢ä¸ºASCIIç æ˜¾ç¤ºã€‚</p>
<ul>
<li>æˆ‘ä»¬éœ€è¦ä»¥standard outçš„æ–¹å¼è¾“å‡ºæˆ‘ä»¬çš„å…¬é’¥: <code>gpg --armor --export [Key ID]</code></li>
<li>æˆ–è€…æˆ‘ä»¬åŠ ä¸Š<code>--output &lt;filename&gt;</code>å‚æ•°ï¼Œå¯ä»¥å°†è¿™ä¸ªå…¬é’¥å†™å…¥ä¸€ä¸ªè¾“å‡ºæ–‡ä»¶: <code>gpg --armor --output public-key.txt --export [Key ID]</code></li>
</ul>
<p>å®é™…ä¸Šçš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --armor --<span class="built_in">export</span> 704A75374771234881B10559F98069D551217BFD</span><br><span class="line">-----BEGIN PGP PUBLIC KEY BLOCK-----</span><br><span class="line"><span class="comment"># ...............</span></span><br><span class="line"><span class="comment"># .....å·²åˆ å».....</span></span><br><span class="line"><span class="comment"># ...............</span></span><br><span class="line">-----END PGP PUBLIC KEY BLOCK-----</span><br></pre></td></tr></tbody></table></figure>
<p>äº‹å®ä¸Špublic keyå¯ä»¥å…¬å¼€ï¼Œè¿™é‡Œæˆ‘ä»¬èŠ‚çœæ–‡ç« ç©ºé—´å°†å…¶åˆ å»ã€‚</p>
<p><br></p>
<h2 id="è·å¾—å®Œæ•´ç§é’¥"><a href="#è·å¾—å®Œæ•´ç§é’¥" class="headerlink" title="è·å¾—å®Œæ•´ç§é’¥"></a>è·å¾—å®Œæ•´ç§é’¥</h2><p>å®Œå…¨ç±»ä¼¼å…¬é’¥çš„è·å–ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„å‘½ä»¤è·å–ç§é’¥(private key)ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --armor --<span class="built_in">export</span>-secret-keys 704A75374771234881B10559F98069D551217BFD</span><br><span class="line">-----BEGIN PGP PRIVATE KEY BLOCK-----</span><br><span class="line"><span class="comment"># ...............</span></span><br><span class="line"><span class="comment"># .....å·²åˆ å».....</span></span><br><span class="line"><span class="comment"># ...............</span></span><br><span class="line">-----END PGP PRIVATE KEY BLOCK-----</span><br></pre></td></tr></tbody></table></figure>
<p><strong>ç§é’¥æ˜¯ç»å¯¹ä¸å¯ä»¥å…¬å¼€çš„ï¼Œéœ€è¦æ³¨æ„å®‰å…¨ã€‚</strong></p>
<p><br></p>
<h2 id="ä¸Šä¼ å…¬é’¥-1"><a href="#ä¸Šä¼ å…¬é’¥-1" class="headerlink" title="ä¸Šä¼ å…¬é’¥ 1"></a>ä¸Šä¼ å…¬é’¥ <sup><a href="#myfootnote1">1</a></sup></h2><p>å…¬é’¥æœåŠ¡å™¨æ˜¯ç½‘ç»œä¸Šä¸“é—¨å‚¨å­˜ç”¨æˆ·å…¬é’¥çš„æœåŠ¡å™¨ã€‚send-keyså‚æ•°å¯ä»¥å°†å…¬é’¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚(å¦å¤–å…¶ä»–çš„ä¸­æ–‡æ•™ç¨‹è¿™éƒ¨åˆ†gpgæŒ‡ä»¤å·²ç»è¿‡æ—¶)</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --send-keys [Key ID]</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --send-keys 704A75374771234881B10559F98069D551217BFD</span><br><span class="line">gpg: sending key F98069D551217BFD to hkps://hkps.pool.sks-keyservers.net</span><br></pre></td></tr></tbody></table></figure>
<p>ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ï¼Œä½ çš„å…¬é’¥å°±è¢«ä¼ åˆ°äº†æœåŠ¡å™¨ hkps://hkps.pool.sks-keyservers.net ï¼Œç„¶åé€šè¿‡äº¤æ¢æœºåˆ¶ï¼Œæ‰€æœ‰çš„å…¬é’¥æœåŠ¡å™¨æœ€ç»ˆéƒ½ä¼šåŒ…å«ä½ çš„å…¬é’¥ã€‚</p>
<p><br></p>
<p>ç”±äºå…¬é’¥æœåŠ¡å™¨æ²¡æœ‰æ£€æŸ¥æœºåˆ¶ï¼Œä»»ä½•äººéƒ½å¯ä»¥ç”¨ä½ çš„åä¹‰ä¸Šä¼ å…¬é’¥ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•ä¿è¯æœåŠ¡å™¨ä¸Šçš„å…¬é’¥çš„å¯é æ€§ã€‚é€šå¸¸ï¼Œä½ å¯ä»¥åœ¨ç½‘ç«™ä¸Šå…¬å¸ƒä¸€ä¸ªå…¬é’¥æŒ‡çº¹ï¼Œè®©å…¶ä»–äººæ ¸å¯¹ä¸‹è½½åˆ°çš„å…¬é’¥æ˜¯å¦ä¸ºçœŸã€‚</p>
<p><code>--fingerprint</code>å‚æ•°ç”Ÿæˆå…¬é’¥æŒ‡çº¹ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --fingerprint [Key ID]</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --fingerprint 704A75374771234881B10559F98069D551217BFD</span><br><span class="line">pub   rsa4096 2020-03-02 [SC]</span><br><span class="line">      704A 7537 4771 2348 81B1  0559 F980 69D5 5121 7BFD</span><br><span class="line">uid           [ultimate] Jigao Luo &lt;luojigao@outlook.com&gt;</span><br><span class="line">sub   rsa4096 2020-03-02 [E]</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="è¾“å…¥å¯†é’¥-1"><a href="#è¾“å…¥å¯†é’¥-1" class="headerlink" title="è¾“å…¥å¯†é’¥ 1"></a>è¾“å…¥å¯†é’¥ <sup><a href="#myfootnote1">1</a></sup></h2><p>é™¤äº†ç”Ÿæˆè‡ªå·±çš„å¯†é’¥ï¼Œè¿˜éœ€è¦å°†ä»–äººçš„å…¬é’¥æˆ–è€…ä½ çš„å…¶ä»–å¯†é’¥è¾“å…¥ç³»ç»Ÿã€‚è¿™æ—¶å¯ä»¥ä½¿ç”¨importå‚æ•°ã€‚</p>
<blockquote>
<pre><code> --import                import/merge keys
</code></pre></blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --import [å¯†é’¥æ–‡ä»¶]</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸ºäº†è·å¾—ä»–äººçš„å…¬é’¥ï¼Œå¯ä»¥è®©å¯¹æ–¹ç›´æ¥å‘ç»™ä½ ï¼Œæˆ–è€…åˆ°å…¬é’¥æœåŠ¡å™¨ä¸Šå¯»æ‰¾ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --search-keys [Key ID]</span><br></pre></td></tr></tbody></table></figure>
<p>ä½œä¸ºä¾‹å­ï¼Œæˆ‘æœäº†ä¸€ä¸‹è‡ªå·±çš„key:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --search-keys F98069D551217BFD</span><br><span class="line">gpg: data <span class="built_in">source</span>: https://209.244.105.201:443</span><br><span class="line">(1)	Jigao Luo &lt;luojigao@outlook.com&gt;</span><br><span class="line">	  4096 bit RSA key F98069D551217BFD, created: 2020-03-02</span><br><span class="line">Keys 1-1 of 1 <span class="keyword">for</span> <span class="string">"F98069D551217BFD"</span>.  Enter number(s), N)ext, or Q)uit &gt; 1</span><br><span class="line">gpg: key F98069D551217BFD: <span class="string">"Jigao Luo &lt;luojigao@outlook.com&gt;"</span> not changed</span><br><span class="line">gpg: Total number processed: 1</span><br><span class="line">gpg:              unchanged: 1</span><br></pre></td></tr></tbody></table></figure>
<p>æ­£å¦‚å‰é¢æåˆ°çš„ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯æœåŠ¡å™¨ä¸Šçš„å…¬é’¥æ˜¯å¦å¯é ï¼Œä¸‹è½½åè¿˜éœ€è¦ç”¨fingerprintéªŒè¯ã€‚</p>
<p><br></p>
<h2 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h2><p>æ¯”å¦‚æˆ‘ä»¬æƒ³æŠŠä¸‹åˆ—è¿™ä¸ªkey pairç»™åˆ é™¤ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --list-keys</span><br><span class="line">/home/jigao/.gnupg/pubring.kbx</span><br><span class="line">------------------------------</span><br><span class="line">pub   rsa3072 2020-03-03 [SC] [expires: 2022-03-03]</span><br><span class="line">      35BF00DD4737307A75C0E7A2C8C3592484FDBAD9</span><br><span class="line">uid           [ultimate] Abc Def &lt;abc.def@domain.com&gt;</span><br><span class="line">sub   rsa3072 2020-03-03 [E] [expires: 2022-03-03]</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>éœ€è¦ä½¿ç”¨<code>gpg --delete-secret-keys [Key ID]</code>å»åˆ é™¤å¯†é’¥ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --delete-secret-keys 35BF00DD4737307A75C0E7A2C8C3592484FDBAD9</span><br><span class="line">gpg (GnuPG) 2.2.4; Copyright (C) 2017 Free Software Foundation, Inc.</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sec  rsa3072/C8C3592484FDBAD9 2020-03-03 Abc Def &lt;abc.def@domain.com&gt;</span><br><span class="line"></span><br><span class="line">Delete this key from the keyring? (y/N) y</span><br><span class="line">This is a secret key! - really delete? (y/N) y</span><br><span class="line"></span><br><span class="line">$ gpg --list-keys</span><br><span class="line">/home/jigao/.gnupg/pubring.kbx</span><br><span class="line">------------------------------</span><br><span class="line">pub   rsa3072 2020-03-03 [SC] [expires: 2022-03-03]</span><br><span class="line">      35BF00DD4737307A75C0E7A2C8C3592484FDBAD9</span><br><span class="line">uid           [ultimate] Abc Def &lt;abc.def@domain.com&gt;</span><br><span class="line">sub   rsa3072 2020-03-03 [E] [expires: 2022-03-03]</span><br></pre></td></tr></tbody></table></figure>
<p>ä½†æ˜¯æˆ‘ä»¬å‘ç°<code>gpg --list-keys</code>å‘½ä»¤åä¾æ—§èƒ½çœ‹è§è¿™ä¸ªkeyã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¹‹åˆ å»äº†å¯†é’¥ï¼Œä½†æ˜¯å¯¹åº”çš„å…¬é’¥è¿˜å­˜åœ¨ã€‚</p>
<p><br></p>
<p>éœ€è¦ä½¿ç”¨<code>gpg --delete-keys [Key ID]</code>å»åˆ é™¤å…¬é’¥ï¼Œä¹‹åè¿™ä¸ªkey pairå°±çœŸæ­£æ¶ˆå¤±äº†ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --delete-keys 35BF00DD4737307A75C0E7A2C8C3592484FDBAD9</span><br><span class="line">gpg (GnuPG) 2.2.4; Copyright (C) 2017 Free Software Foundation, Inc.</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">pub  rsa3072/C8C3592484FDBAD9 2020-03-03 Abc Def &lt;abc.def@domain.com&gt;</span><br><span class="line"></span><br><span class="line">Delete this key from the keyring? (y/N) y</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h1 id="åŠ å¯†å’Œè§£å¯†"><a href="#åŠ å¯†å’Œè§£å¯†" class="headerlink" title="åŠ å¯†å’Œè§£å¯†"></a>åŠ å¯†å’Œè§£å¯†</h1><h2 id="åŠ å¯†"><a href="#åŠ å¯†" class="headerlink" title="åŠ å¯†"></a>åŠ å¯†</h2><p>æˆ‘ä»¬å‡è®¾ä¸€ç§å®éªŒï¼ŒæŸäººæƒ³å‘ä¸€ä¸ªæ–‡ä»¶ç»™æˆ‘ã€‚ä»–æƒ³ç”¨æˆ‘çš„public keyå»åŠ å¯†è¿™ä¸ªæ–‡ä»¶ï¼Œ æ¥ä¿è¯è¿™ä¸ªä¼ è¾“çš„å®‰å…¨æ€§å¹¶ä¸”è¿™ä¸ªæ–‡ä»¶åªèƒ½è¢«æˆ‘æ‰€é˜…è¯»ã€‚</p>
<p>TAåˆ›å»ºä¸€ä¸ªæ–‡ä»¶<code>file.txt</code>ä½œä¸ºä¾‹å­ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ touch file.txt</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"This is a message."</span> &gt; file.txt </span><br><span class="line"></span><br><span class="line">$ cat file.txt </span><br><span class="line">This is a message.</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>--r [Key ID]</code>æˆ–<code>--recipient [Key ID]</code>å‚æ•°ï¼šæŒ‡å®šä½¿ç”¨æ¥å—è€…çš„å…¬é’¥</p>
<blockquote>
<p> -r, â€”recipient USER-ID     encrypt for USER-ID</p>
</blockquote>
</li>
<li><p><code>-e</code>æˆ–<code>--encrypt</code>å‚æ•°ï¼š æŒ‡å®šåŠ å¯†æ•°æ®</p>
<blockquote>
<p> -e, â€”encrypt               encrypt data</p>
</blockquote>
</li>
<li><p><code>-o</code> æˆ– <code>--outpu</code>å‚æ•°: æŒ‡å®šè¾“å‡ºæ–‡ä»¶</p>
<blockquote>
<p> -o, â€”output FILE           write output to FILE</p>
</blockquote>
</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --recipient [Key ID] --output file_encrypted.txt  --encrypt file.txt</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>ç»§ç»­æˆ‘ä»¬çš„ä¾‹å­:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --recipient F98069D551217BFD --output file_encrypted.txt  --encrypt file.txt </span><br><span class="line"></span><br><span class="line">$ file file_encrypted.txt </span><br><span class="line">file_encrypted.txt: PGP RSA encrypted session key - keyid: E2067632 AA759BAE RSA (Encrypt or Sign) 4096b .</span><br><span class="line"></span><br><span class="line">$ xxd file_encrypted.txt </span><br><span class="line">00000000: 8502 0c03 3276 06e2 ae9b 75aa 0110 00ab  ....2v....u.....</span><br><span class="line">00000010: 442a 4ce4 a044 50e3 c769 e287 5e7d 3b22  D*L..DP..i..^};<span class="string">"</span></span><br><span class="line"><span class="string">00000020: 7d32 ff25 ff99 2297 ec62 b2ed e9f2 4635  }2.%.."</span>..b....F5</span><br><span class="line">00000030: b6e4 76b1 f2dc 7f1a bbf1 c2c7 0ba7 7978  ..v...........yx</span><br><span class="line">00000040: f2b5 5821 fa1b 6dbe f1b3 4b9e e82c de32  ..X!..m...K..,.2</span><br><span class="line">00000050: e6bd ff1c 7655 9708 edb6 95aa e55d f858  ....vU.......].X</span><br><span class="line">00000060: 3a99 c823 f132 0b61 2b6d 41d6 5a13 9ca1  :..<span class="comment">#.2.a+mA.Z...</span></span><br><span class="line">00000070: f0b2 8530 ae43 6bbb 97b9 2e0f 16d3 4ae3  ...0.Ck.......J.</span><br><span class="line">00000080: 7048 3f7b ead6 bd9e e147 e503 3d54 937c  pH?{.....G..=T.|</span><br><span class="line">00000090: f7d7 9b44 a197 f10a 71de 9333 da37 bbd4  ...D....q..3.7..</span><br><span class="line">000000a0: de3e ceaf 90e7 d555 69be 8e11 8655 5dfb  .&gt;.....Ui....U].</span><br><span class="line">000000b0: c0ac 7eaa 4389 6bcc 3da3 ecc7 dd45 8a03  ..~.C.k.=....E..</span><br><span class="line">000000c0: a124 acd1 a082 21d6 81f1 79d3 d8a0 ce7c  .$....!...y....|</span><br><span class="line">000000d0: 9433 5a43 140b 84e1 b814 4184 577d 1485  .3ZC......A.W}..</span><br><span class="line">000000e0: 9f49 82ba 83dd 1419 8c29 cf6d de09 4373  .I.......).m..Cs</span><br><span class="line">000000f0: e1b9 e1a3 3f65 e2c5 5642 4a5d eec9 862e  ....?e..VBJ]....</span><br><span class="line">00000100: 41cf d68b ef93 8c2e b29b 5ac4 a415 c6d0  A.........Z.....</span><br><span class="line">00000110: d80b 4bda 0f4a 03e2 6342 64e1 9382 0dc5  ..K..J..cBd.....</span><br><span class="line">00000120: b74c d8da c0d1 ea94 2553 705b 18e1 f82e  .L......%Sp[....</span><br><span class="line">00000130: cbaa df9a 6b4c fa5e 7db6 f5fa 13e9 635c  ....kL.^}.....c\</span><br><span class="line">00000140: 92a0 3cc6 e74f eba7 340c 7bff 2d09 6dcf  ..&lt;..O..4.{.-.m.</span><br><span class="line">00000150: 7315 caef e6e2 c0a5 8bf2 c562 5b52 b146  s..........b[R.F</span><br><span class="line">00000160: a7a1 ef0f 15f4 1b9c 2faa 5667 f0d9 4aee  ......../.Vg..J.</span><br><span class="line">00000170: 6e63 e2bc b819 5599 d9f9 ee42 4762 29e1  nc....U....BGb).</span><br><span class="line">00000180: 49ec 5974 95ba 8ecb 2304 b9f0 4649 a23c  I.Yt....<span class="comment">#...FI.&lt;</span></span><br><span class="line">00000190: 0ba5 cb75 e7f6 b725 939a 26d5 251a 3d8e  ...u...%..&amp;.%.=.</span><br><span class="line">000001a0: f2b5 829c c428 3083 0be3 edb0 d5d2 3574  .....(0.......5t</span><br><span class="line">000001b0: eb16 c2e4 987b 46b8 4080 e252 f94c fafe  .....{F.@..R.L..</span><br><span class="line">000001c0: 5655 e273 ee86 7fa9 7814 4c2a b62b 4c86  VU.s....x.L*.+L.</span><br><span class="line">000001d0: 1e69 6dab 7ded 7385 bca1 cc43 ae4b 19f0  .im.}.s....C.K..</span><br><span class="line">000001e0: f43e 4b4c fafd aa10 6a5f ac5e 32a1 0c69  .&gt;KL....j_.^2..i</span><br><span class="line">000001f0: fe69 36fb a76f 3b34 2dd8 3e15 c5c4 7aaf  .i6..o;4-.&gt;...z.</span><br><span class="line">00000200: cc8f bfc4 e916 3e00 49c5 477e cbd8 43d2  ......&gt;.I.G~..C.</span><br><span class="line">00000210: 5401 dccd 617c 7104 4982 0286 72d8 a48f  T...a|q.I...r...</span><br><span class="line">00000220: 06f6 e1a8 a64e cffd 1120 b732 87e3 5683  .....N... .2..V.</span><br><span class="line">00000230: 5137 445a adae c261 8701 c5e2 42ed 4950  Q7DZ...a....B.IP</span><br><span class="line">00000240: 168c 5d3a ae9d f810 85fb f37e 0620 613f  ..]:.......~. a?</span><br><span class="line">00000250: 58ef ae75 886e fc72 2e86 eda6 44b8 b163  X..u.n.r....D..c</span><br><span class="line">00000260: 0d2f 41f4 97</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>file_encrypted.txt</code>å³æˆ‘ä»¬çš„åŠ å¯†è¿‡åçš„æ–‡ä»¶ï¼Œå®ƒæ˜¯ä»¥äºŒè¿›åˆ¶æ¥ä¿å­˜çš„ã€‚</li>
<li><code>file</code> å‘½ä»¤è¡Œå·¥å…·ï¼šæŸ¥çœ‹æ–‡ä»¶ç±»å‹ã€‚</li>
<li><code>xxd</code> å‘½ä»¤è¡Œå·¥å…·ï¼š ä»¥åå…­è¿›åˆ¶<code>hex</code>çš„å½¢å¼æŸ¥çœ‹ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚ç±»ä¼¼<code>hexdump</code>å‘½ä»¤è¡Œå·¥å…·ã€‚</li>
</ul>
<p>æ€»ä¹‹æˆ‘ä»¬åŠ å¯†è¿‡åï¼Œè¿™ä¸ªæ–‡ä»¶å·²ç»æˆä¸ºé¢ç›®å…¨éçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ–‡ä»¶æ ¼å¼ä¹Ÿå˜æˆäº†<code>PGP RSA encrypted session key</code>ã€‚</p>
<p><br></p>
<h2 id="è§£å¯†"><a href="#è§£å¯†" class="headerlink" title="è§£å¯†"></a>è§£å¯†</h2><p>TAè¿›è¡ŒåŠ å¯†ä»¥åï¼Œå¹¶ä¸”æˆåŠŸå‘é€ç»™äº†æˆ‘ã€‚ç°åœ¨éœ€è¦æˆ‘å»è§£å¯†ï¼Œè¿™éœ€è¦æˆ‘çš„private keyã€‚å› æ­¤è¿™ä¸ªæ–‡ä»¶åªèƒ½è¢«æˆ‘æ‰€è¯»ã€‚</p>
<p>è¿™é‡Œæä¸€ä¸‹ï¼Œè§£å¯†ä¸€ä¸ªæ–‡ä»¶æ˜¯<code>gpg</code> é»˜è®¤çš„è¡Œä¸º, æˆ‘ä»¬å¯ä»¥ä¸ç”¨ä»»ä½•flag, ç›´æ¥æŒ‡å®šæˆ‘ä»¬éœ€è¦è§£å¯†çš„æ–‡ä»¶å³å¯ï¼š</p>
<blockquote>
<p> -d, â€”decrypt               decrypt data (default)</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg file_encrypted.txt</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>ç»§ç»­æˆ‘ä»¬çš„ä¾‹å­:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg file_encrypted.txt </span><br><span class="line">gpg: WARNING: no <span class="built_in">command</span> supplied.  Trying to guess what you mean ...</span><br><span class="line">gpg: encrypted with 4096-bit RSA key, ID 327606E2AE9B75AA, created 2020-03-02</span><br><span class="line">      <span class="string">"Jigao Luo &lt;luojigao@outlook.com&gt;"</span></span><br><span class="line">gpg: file_encrypted.txt: unknown suffix</span><br><span class="line">Enter new filename [file.txt]: file_decrypted.txt</span><br><span class="line"></span><br><span class="line">$ cat file_decrypted.txt </span><br><span class="line">This is a message.</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™æ ·æˆ‘(a.k.a.å¯¹åº”å¯†é’¥çš„æ‹¥æœ‰è€…)å°±å¯ä»¥è¯»å–è¿™ä¸ªåŠ å¯†çš„æ–‡ä»¶ã€‚</p>
<p>è¿™ä¸ªè¿‡ç¨‹åŒæ—¶å¯ä»¥åº”ç”¨äºé‚®ä»¶å‘é€æ¥å—ï¼Œç½‘ç»œæ¶ˆæ¯çš„å‘é€æ¥æ”¶ï¼Œæ€»ä¹‹å¹¿ä¹‰ä¿¡æ¯äº¤äº’ä¸­éœ€è¦éªŒè¯äºå®‰å…¨çš„åœºåˆã€‚</p>
<p><br></p>
<h1 id="ç­¾å"><a href="#ç­¾å" class="headerlink" title="ç­¾å"></a>ç­¾å</h1><h2 id="æ–‡ä»¶ç­¾åæˆäºŒè¿›åˆ¶æ–‡ä»¶"><a href="#æ–‡ä»¶ç­¾åæˆäºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="æ–‡ä»¶ç­¾åæˆäºŒè¿›åˆ¶æ–‡ä»¶"></a>æ–‡ä»¶ç­¾åæˆäºŒè¿›åˆ¶æ–‡ä»¶</h2><p>å¦‚æœæˆ‘ä¸éœ€è¦åŠ å¯†æ–‡ä»¶ï¼Œä½†åªéœ€è¦å¯¹æ–‡ä»¶ç­¾åæ¥è¡¨ç¤ºè¿™ä¸ªæ–‡ä»¶ç¡®å®æ˜¯æˆ‘æœ¬äººå‘å‡ºçš„ã€‚ è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦<code>--sign</code>å‚æ•°ï¼š</p>
<blockquote>
<p>-s, â€”sign                  make a signature</p>
</blockquote>
<p><br></p>
<p>æˆ‘ä»¬ç»§ç»­ä»¥é‚£ä¸ªæ–‡ä»¶<code>file.txt</code>ä½œä¸ºä¾‹å­ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --sign file.txt</span><br><span class="line"></span><br><span class="line">$ file file.txt.gpg </span><br><span class="line">file.txt.gpg: data</span><br><span class="line"></span><br><span class="line">$ xxd file.txt.gpg </span><br><span class="line">00000000: a301 01e8 0117 fe90 0d03 000a 01c4 794a  ..............yJ</span><br><span class="line">00000010: 7a8d cff1 6d01 ac21 6208 6669 6c65 2e74  z...m..!b.file.t</span><br><span class="line">00000020: 7874 5e5e 7fa6 5468 6973 2069 7320 6120  xt^^..This is a </span><br><span class="line">00000030: 6d65 7373 6167 652e 0a89 01b3 0400 010a  message.........</span><br><span class="line">00000040: 001d 1621 04d7 9c54 1d63 6bbb aeed 16b2  ...!...T.ck.....</span><br><span class="line">00000050: e5c4 794a 7a8d cff1 6d05 025e 5e7f a600  ..yJz...m..^^...</span><br><span class="line">00000060: 0a09 10c4 794a 7a8d cff1 6d9e 870b fd1f  ....yJz...m.....</span><br><span class="line">00000070: 0f84 a7e0 f5d6 50c8 5b0f 1948 ad44 e0a1  ......P.[..H.D..</span><br><span class="line">00000080: 1d52 21f9 26df 7d18 6f85 0323 39e5 0335  .R!.&amp;.}.o..<span class="comment">#9..5</span></span><br><span class="line">00000090: 057b 6887 f8d6 6d0f fa84 b2bf 3384 6536  .{h...m.....3.e6</span><br><span class="line">000000a0: 6737 352c 7019 defe fed3 3a8e 44b8 75c3  g75,p.....:.D.u.</span><br><span class="line">000000b0: bb4f 3df8 89c1 ccad 1aef 260d e6c4 99d3  .O=.......&amp;.....</span><br><span class="line">000000c0: 976f 5b22 707e 2a29 3e61 2a19 ea4e fc89  .o[<span class="string">"p~*)&gt;a*..N..</span></span><br><span class="line"><span class="string">000000d0: 89e2 18bc cf53 0dba 6d5d cc4e f9bf 3641  .....S..m].N..6A</span></span><br><span class="line"><span class="string">000000e0: 6097 1334 9296 d99e 2229 774b a129 172b  `..4...."</span>)wK.).+</span><br><span class="line">000000f0: 856c 0558 8940 54af 934c 198c d603 bcff  .l.X.@T..L......</span><br><span class="line">00000100: ad1e 9fc6 2f57 3ec9 0641 6207 37b2 27eb  ..../W&gt;..Ab.7.<span class="string">'.</span></span><br><span class="line"><span class="string">00000110: 9a67 388d 8dc2 02a2 cf6e 6bb3 35c9 3e90  .g8......nk.5.&gt;.</span></span><br><span class="line"><span class="string">00000120: 2c3b f224 4ade 01a6 a4fb 9a4d c751 43a6  ,;.$J......M.QC.</span></span><br><span class="line"><span class="string">00000130: ce9a 10ae f234 76ee 50fb 5cd4 7cc0 22f7  .....4v.P.\.|.".</span></span><br><span class="line"><span class="string">00000140: 52ce 17d0 1893 3952 8817 f193 c42e 72f1  R.....9R......r.</span></span><br><span class="line"><span class="string">00000150: 180f 797b 8199 8f10 ce5b bbb0 a822 9e02  ..y{.....[..."..</span></span><br><span class="line"><span class="string">00000160: 98df 775e 3592 469f 6cb0 41e9 fb25 de19  ..w^5.F.l.A..%..</span></span><br><span class="line"><span class="string">00000170: 5f01 b317 7c5b c1e2 9e48 9ed0 84c3 d22c  _...|[...H.....,</span></span><br><span class="line"><span class="string">00000180: f3e0 c2ad f20b 3363 0c9d c6a6 5823 6579  ......3c....X#ey</span></span><br><span class="line"><span class="string">00000190: 78ba 62cd 6534 e5c6 14f8 89cb dbdc 0238  x.b.e4.........8</span></span><br><span class="line"><span class="string">000001a0: 048e 876a f927 4ecd bad4 dd8a 6785 d783  ...j.'</span>N.....g...</span><br><span class="line">000001b0: c4b7 4dd5 014a 47df a6bc 2314 2db8 a289  ..M..JG...<span class="comment">#.-...</span></span><br><span class="line">000001c0: b690 a328 f5b0 006e f1c8 fc6b 3952 4261  ...(...n...k9RBa</span><br><span class="line">000001d0: 03eb f184 da0c 0dcd db99 600e 97b2 2ac5  ..........`...*.</span><br><span class="line">000001e0: 1386 47dd 58f1 185f b99b c316 3045 d7    ..G.X.._....0E.</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹åº”çš„å‘½ä»¤ä¼šåœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ç”Ÿæˆ<code>file.txt.gpg</code>æ–‡ä»¶ï¼Œè¿™å°±æ˜¯ç­¾ååçš„æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶é»˜è®¤é‡‡ç”¨äºŒè¿›åˆ¶å‚¨å­˜ã€‚</p>
<h2 id="æ–‡ä»¶ç­¾åæˆASCIIå½¢å¼"><a href="#æ–‡ä»¶ç­¾åæˆASCIIå½¢å¼" class="headerlink" title="æ–‡ä»¶ç­¾åæˆASCIIå½¢å¼"></a>æ–‡ä»¶ç­¾åæˆASCIIå½¢å¼</h2><p>å¦‚æœæƒ³ç”Ÿæˆ<code>ASCII</code>å½¢å¼çš„æ–‡ä»¶äºç­¾åï¼Œå¯ä»¥ä½¿ç”¨<code>--clear-sign</code>å‚æ•°ã€‚</p>
<blockquote>
<pre><code> --clear-sign            make a clear text signature
</code></pre></blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --clear-sign file.txt </span><br><span class="line"></span><br><span class="line">$ file file.txt</span><br><span class="line">file.txt      file.txt.asc  file.txt.gpg  </span><br><span class="line"></span><br><span class="line">$ file file.txt.asc </span><br><span class="line">file.txt.asc: ASCII text</span><br><span class="line"></span><br><span class="line">$ cat file.txt.asc</span><br><span class="line">-----BEGIN PGP SIGNED MESSAGE-----</span><br><span class="line">Hash: SHA512</span><br><span class="line"></span><br><span class="line">This is a message.</span><br><span class="line">-----BEGIN PGP SIGNATURE-----</span><br><span class="line"></span><br><span class="line">iQGzBAEBCgAdFiEE15xUHWNru67tFrLlxHlKeo3P8W0FAl5egKQACgkQxHlKeo3P</span><br><span class="line">8W2nqQwAn3YbhunmFuYvMWL4mxnJlpRK5XuAFPP5rU7MqvW6YM4qSyQ/UeGuEpqj</span><br><span class="line">veJCl2VI2Dx02wnh16EbVgDBolkwuC7QkIddWBSU8e6R1pL/kopLAdIbmE+HdnCr</span><br><span class="line">ggjWg7MgkhBmxKfOa+MHHaNgBfHepiWhor4J3EwqqWhzfRl1CL392Gqe7jJ+SEp1</span><br><span class="line">I5QOpkOsFEQQhQEVmiqPDeHRcIj9qKPA47z4WMujuP78c0Zr2rOdlUSnuv7Ly/1G</span><br><span class="line">5EqjCAc+ATNZO+SgUW5xXOalSGodDfUcK57ATORS3tztBDlTHn5zgaHxcoWaqsov</span><br><span class="line">5d68lxx75Q9nLr3MaMyRtMYtbN0Llef9DA3QAKd+bx3TWsB0HbXmrBXW0KxDh3oD</span><br><span class="line">F2IJ5vT1NrqvwqH2qzLZStqfGwcuyVQzmrfgSDnfhIViLk/tTiioJyBNqnU697L9</span><br><span class="line">1Xz2tZXXCqA+TgPLupd60bswpkVvg0DDCvEM2NvjhfwRATQ3iO1j7IDap1lzCiP1</span><br><span class="line">l/pjf/Su</span><br><span class="line">=Klzn</span><br><span class="line">-----END PGP SIGNATURE-----</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹åº”çš„å‘½ä»¤ä¼šåœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ç”Ÿæˆ<code>file.txt.asc</code>æ–‡ä»¶ï¼Œè¿™å°±æ˜¯ç­¾ååçš„æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯è¢«<code>ASCII</code>å½¢å¼å­˜å‚¨çš„ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¯¹åº”æ–‡ä»¶æ²¡æœ‰è¢«åŠ å¯†ï¼Œè€Œæ˜¯åœ¨æ–‡ä»¶ä¸­åŠ å…¥äº†è¯æ˜å‘é€è€…èº«ä»½çš„ç­¾åã€‚</p>
<h2 id="æ–‡ä»¶ä¸ç­¾ååˆ†ç¦»"><a href="#æ–‡ä»¶ä¸ç­¾ååˆ†ç¦»" class="headerlink" title="æ–‡ä»¶ä¸ç­¾ååˆ†ç¦»"></a>æ–‡ä»¶ä¸ç­¾ååˆ†ç¦»</h2><p>å¦‚æœæƒ³ç”Ÿæˆå•ç‹¬çš„ç­¾åæ–‡ä»¶ï¼Œä¸æ–‡ä»¶å†…å®¹åˆ†å¼€å­˜æ”¾ï¼Œå¯ä»¥ä½¿ç”¨<code>-b</code>æˆ–<code>--ç”¨detach-sign</code>å‚æ•°ã€‚</p>
<blockquote>
<p> -b, â€”detach-sign           make a detached signature</p>
</blockquote>
<p>åŒæ ·çš„ï¼Œä¾æ—§æœ‰äºŒè¿›åˆ¶ç­¾åå’Œ<code>ASCII</code>å½¢å¼ç­¾åä¸¤ç§æƒ…å†µï¼š</p>
<h3 id="äºŒè¿›åˆ¶ç­¾å"><a href="#äºŒè¿›åˆ¶ç­¾å" class="headerlink" title="äºŒè¿›åˆ¶ç­¾å"></a>äºŒè¿›åˆ¶ç­¾å</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --detach-sign file.txt</span><br><span class="line"></span><br><span class="line">$ file file.txt.sig </span><br><span class="line">file.txt.sig: data</span><br><span class="line"></span><br><span class="line">$ xxd file.txt.sig</span><br><span class="line">00000000: 8901 b304 0001 0a00 1d16 2104 d79c 541d  ..........!...T.</span><br><span class="line">00000010: 636b bbae ed16 b2e5 c479 4a7a 8dcf f16d  ck.......yJz...m</span><br><span class="line">00000020: 0502 5e5e 8209 000a 0910 c479 4a7a 8dcf  ..^^.......yJz..</span><br><span class="line">00000030: f16d 6726 0bff 4300 4721 eaef 002e 883d  .mg&amp;..C.G!.....=</span><br><span class="line">00000040: f4de c34a 39c5 2626 7c7b bddd 5bfc 2012  ...J9.&amp;&amp;|{..[. .</span><br><span class="line">00000050: 170a 90ec 37df 51e3 743e bbab 50b3 bfd1  ....7.Q.t&gt;..P...</span><br><span class="line">00000060: af2c d068 e99f ec59 8283 b812 a6a8 3a20  .,.h...Y......: </span><br><span class="line">00000070: e8a2 3701 c742 e24b d088 5b58 5df5 d6f4  ..7..B.K..[X]...</span><br><span class="line">00000080: b955 96fb 2c8e e006 4c6f 5de9 7dfb f625  .U..,...Lo].}..%</span><br><span class="line">00000090: 8f3c d254 b107 30b2 e6da 57c2 d986 d821  .&lt;.T..0...W....!</span><br><span class="line">000000a0: b8f7 4cdb aeb6 caa3 9bca a4de 62fd 5887  ..L.........b.X.</span><br><span class="line">000000b0: 5013 a1c8 d8f9 d7dd 67ee e104 f7c7 60b1  P.......g.....`.</span><br><span class="line">000000c0: 4145 8ea5 6950 66da 3718 66e2 6334 f0a0  AE..iPf.7.f.c4..</span><br><span class="line">000000d0: 3deb a604 9447 ef3d 3176 a831 fb7c 95d2  =....G.=1v.1.|..</span><br><span class="line">000000e0: 3289 4569 f6c2 8187 0550 d69e e6a8 325a  2.Ei.....P....2Z</span><br><span class="line">000000f0: 3194 f972 dfc1 1e76 9f44 19a2 3d69 74a2  1..r...v.D..=it.</span><br><span class="line">00000100: c52d 3d69 823d c799 41c1 a529 b02b 5143  .-=i.=..A..).+QC</span><br><span class="line">00000110: 9ecb 3560 a66b 32a6 f601 bb7d 05cf c1ed  ..5`.k2....}....</span><br><span class="line">00000120: 2652 bbfb 9d13 ffef d63a a417 905a 47b7  &amp;R.......:...ZG.</span><br><span class="line">00000130: c815 3125 b497 89a6 e72f a9bb 2513 57b4  ..1%...../..%.W.</span><br><span class="line">00000140: 1aa7 f527 1333 c4d8 8f80 d9bf f9b5 5686  ...<span class="string">'.3........V.</span></span><br><span class="line"><span class="string">00000150: 376c 39a2 1d09 7408 9c81 97d7 8fea 610a  7l9...t.......a.</span></span><br><span class="line"><span class="string">00000160: 54eb 1eed 8501 6b63 ea18 6a4d e4b0 b7cc  T.....kc..jM....</span></span><br><span class="line"><span class="string">00000170: fd79 c2dc 7c36 db97 b159 7f1c d994 3918  .y..|6...Y....9.</span></span><br><span class="line"><span class="string">00000180: f2f0 52e2 0b0f eaeb eead a851 df40 77ac  ..R........Q.@w.</span></span><br><span class="line"><span class="string">00000190: d19c b06a 9c9f 5bc2 1069 6854 6b1b acfd  ...j..[..ihTk...</span></span><br><span class="line"><span class="string">000001a0: 28c3 428c b7c8 a7d6 0b25 48c2 c608 29eb  (.B......%H...).</span></span><br><span class="line"><span class="string">000001b0: e3fd 9fd2 c9e0                           ......</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹åº”çš„å‘½ä»¤ä¼šåœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ç”Ÿæˆ<code>file.txt.sig</code>æ–‡ä»¶ï¼Œè¿™å°±æ˜¯å•ç‹¬çš„äºŒè¿›åˆ¶ç­¾åæ–‡ä»¶ã€‚</p>
<h3 id="ASCIIå½¢å¼ç­¾å"><a href="#ASCIIå½¢å¼ç­¾å" class="headerlink" title="ASCIIå½¢å¼ç­¾å"></a><code>ASCII</code>å½¢å¼ç­¾å</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --armor --detach-sign file.txt</span><br><span class="line"></span><br><span class="line">$ file file.txt.asc </span><br><span class="line">file.txt.asc: PGP signature Signature (old)</span><br><span class="line"></span><br><span class="line">$ cat file.txt.asc </span><br><span class="line">-----BEGIN PGP SIGNATURE-----</span><br><span class="line"></span><br><span class="line">iQGzBAABCgAdFiEE15xUHWNru67tFrLlxHlKeo3P8W0FAl5egiwACgkQxHlKeo3P</span><br><span class="line">8W2I8gv/SDRWfH+up0JYEsrT/JG9MhyVw8Bc0nK11pJTfpIq12Pph0KA3h60Wa2U</span><br><span class="line">C2X+j1yNhaw8ajCAxMzZzpup2iwx5C1bRmKPxGfnKopM8Z531SRCan/GkDrPD0Sj</span><br><span class="line">NeBW/UzADhden+lKqRrEhGfuoCUr64XBJERA2gGZqcLqzIKKOf53nKKMox2MfLGa</span><br><span class="line">wTVT1tXEA6yBREdirq0w3ZKzcil+qSRUpaaHzvg2ohIn9M5V6eTVESciyIvD9L+D</span><br><span class="line">eVsnHlcKal4iVZNkISFmoJN9Krqdsjcnpxpu+QEyfbQ1jZL6mIvaz/OQLI/FJThh</span><br><span class="line">HwjUaCQqphlVQGGZhFyCbn+KHYMRttcvrXo482kadaLYGXMl8WVtFPTU0U+GDUOm</span><br><span class="line">vg6rZPm8q9LwFLNHhkajk0ebN0zqv3MDSnopI0PJEV0rzDd1M6ggdX5I9fbLOI/t</span><br><span class="line">RciB1za54BWvXZzgtHO5qJUCNlt0Cz1VGZnTqH3VFzwa3N9zzzMBWikpohgiw9df</span><br><span class="line">w6iUgMVs</span><br><span class="line">=gmx8</span><br><span class="line">-----END PGP SIGNATURE-----</span><br></pre></td></tr></tbody></table></figure>
<p>åŠ ä¸Š<code>--armor</code>å‚æ•°çš„å¯¹åº”å‘½ä»¤ä¼šåœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ç”Ÿæˆ<code>file.txt.asc</code> æ–‡ä»¶ï¼Œè¿™å°±æ˜¯å•ç‹¬çš„<code>ASCII</code>å½¢å¼ç­¾åæ–‡ä»¶ã€‚</p>
<h2 id="ç­¾åå¹¶åŠ å¯†"><a href="#ç­¾åå¹¶åŠ å¯†" class="headerlink" title="ç­¾åå¹¶åŠ å¯†"></a>ç­¾åå¹¶åŠ å¯†</h2><p>æˆ‘ä»¬ä¹‹å‰è®²çš„éƒ½åªæ˜¯ç­¾åæˆ–åŠ å¯†ä¸­çš„ä¸€ç§ã€‚ä½†æ›´å®‰å…¨çš„æ˜¯ä¸¤è€…åŒæ—¶ä½¿ç”¨ï¼š</p>
<ul>
<li>å‘é€è€…ç”¨è‡ªå·±çš„private keyæ¥å¯¹è‡ªå·±å‘é€çš„æ–‡ä»¶è¿›è¡Œç­¾åã€‚</li>
<li>å‘é€è€…ç”¨æ¥å—è€…public keyæ¥å¯¹è‡ªå·±çš„å‘é€è¿›è¡ŒåŠ å¯†ã€‚</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --<span class="built_in">local</span>-user [å‘ä¿¡è€… Key ID] --recipient [æ¥æ”¶è€… Key ID] --armor --sign --encrypt file.txt</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>--local-user</code>å‚æ•°æŒ‡å®šç”¨å‘ä¿¡è€…çš„ç§é’¥ç­¾å</li>
<li><code>--recipient</code>å‚æ•°æŒ‡å®šç”¨æ¥æ”¶è€…çš„å…¬é’¥åŠ å¯†</li>
<li><code>--armor</code>å‚æ•°è¡¨ç¤ºé‡‡ç”¨ASCIIç å½¢å¼æ˜¾ç¤º</li>
<li><code>--sign</code>å‚æ•°è¡¨ç¤ºéœ€è¦ç­¾å</li>
<li><code>--encrypt</code>å‚æ•°è¡¨ç¤ºåŠ å¯†æŒ‡å®šæ–‡ä»¶</li>
</ul>
<h2 id="éªŒè¯ç­¾å"><a href="#éªŒè¯ç­¾å" class="headerlink" title="éªŒè¯ç­¾å"></a>éªŒè¯ç­¾å</h2><p>æˆ‘ä»¬æ”¶åˆ°åˆ«äººç­¾ååçš„æ–‡ä»¶ï¼Œéœ€è¦ç”¨å¯¹æ–¹çš„å…¬é’¥éªŒè¯ç­¾åæ˜¯å¦ä¸ºçœŸã€‚<code>--verify</code>å‚æ•°ç”¨æ¥éªŒè¯ã€‚</p>
<p>æˆ‘ä»¬æœ€åéªŒè¯ä¹‹å‰ç”Ÿæˆçš„ä¾‹å­ç­¾åï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --verify file.txt.asc file.txt</span><br><span class="line">gpg: Signature made Tue 03 Mar 2020 05:13:32 PM CET</span><br><span class="line">gpg:                using RSA key D79C541D636BBBAEED16B2E5C4794A7A8DCFF16D</span><br><span class="line">gpg: Good signature from <span class="string">"Jigao &lt;jigao.luo@tum.de&gt;"</span> [ultimate]</span><br><span class="line"></span><br><span class="line">$ gpg --verify file.txt.sig file.txt</span><br><span class="line">gpg: Signature made Tue 03 Mar 2020 05:12:57 PM CET</span><br><span class="line">gpg:                using RSA key D79C541D636BBBAEED16B2E5C4794A7A8DCFF16D</span><br><span class="line">gpg: Good signature from <span class="string">"Jigao &lt;jigao.luo@tum.de&gt;"</span> [ultimate]</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¼•ç”¨ï¼š</p>
<p><a name="myfootnote1">1</a>:ã€€GPGå…¥é—¨æ•™ç¨‹ é˜®ä¸€å³° <span class="exturl" data-url="aHR0cDovL3d3dy5ydWFueWlmZW5nLmNvbS9ibG9nLzIwMTMvMDcvZ3BnLmh0bWw=" title="http://www.ruanyifeng.com/blog/2013/07/gpg.html">http://www.ruanyifeng.com/blog/2013/07/gpg.html<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<p>æ¨èçš„é˜…è¯»ï¼š</p>
<p>Paul Heinlein, GPG Quick Start <span class="exturl" data-url="aHR0cHM6Ly93d3cubWFkYm9hLmNvbS9nZWVrL2dwZy1xdWlja3N0YXJ0Lw==" title="https://www.madboa.com/geek/gpg-quickstart/">https://www.madboa.com/geek/gpg-quickstart/<i class="fa fa-external-link"></i></span></p>
<p>Ubuntu helpï¼ŒGnuPrivacyGuardHowto <span class="exturl" data-url="aHR0cHM6Ly9oZWxwLnVidW50dS5jb20vY29tbXVuaXR5L0dudVByaXZhY3lHdWFyZEhvd3Rv" title="https://help.ubuntu.com/community/GnuPrivacyGuardHowto">https://help.ubuntu.com/community/GnuPrivacyGuardHowto<i class="fa fa-external-link"></i></span></p>
<p>Reading OpenPGP E-mail - Ubuntu help <span class="exturl" data-url="aHR0cHM6Ly9oZWxwLnVidW50dS5jb20vY29tbXVuaXR5L0dudVByaXZhY3lHdWFyZEhvd3RvI1JlYWRpbmdfT3BlblBHUF9FLW1haWw=" title="https://help.ubuntu.com/community/GnuPrivacyGuardHowto#Reading_OpenPGP_E-mail">https://help.ubuntu.com/community/GnuPrivacyGuardHowto#Reading_OpenPGP_E-mail<i class="fa fa-external-link"></i></span></p>
<p>Alan Eliasen. GPG Tutorial <span class="exturl" data-url="aHR0cHM6Ly9mdXR1cmVib3kudXMvcGdwLmh0bWw=" title="https://futureboy.us/pgp.html">https://futureboy.us/pgp.html<i class="fa fa-external-link"></i></span></p>
<p>GnuPG è¢–ç HOWTO (ä¸­æ–‡ç‰ˆ) <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ251cGcub3JnL2hvd3Rvcy96aC9pbmRleC5odG1s" title="https://www.gnupg.org/howtos/zh/index.html">https://www.gnupg.org/howtos/zh/index.html<i class="fa fa-external-link"></i></span></p>
<p>The GNU Privacy Handbook <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ251cGcub3JnL2dwaC9lbi9tYW51YWwuaHRtbA==" title="https://www.gnupg.org/gph/en/manual.html">https://www.gnupg.org/gph/en/manual.html<i class="fa fa-external-link"></i></span></p>
<p>Symmetric-Key Message Encryption - RFC 4880ï¼Œ OpenPGP Message Format <span class="exturl" data-url="aHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzQ4ODAjc2VjdGlvbi0zLjcuMi4y" title="https://tools.ietf.org/html/rfc4880#section-3.7.2.2">https://tools.ietf.org/html/rfc4880#section-3.7.2.2<i class="fa fa-external-link"></i></span></p>
<!-- 
è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Operating System</category>
      </categories>
      <tags>
        <tag>Security</tag>
        <tag>GPG</tag>
      </tags>
  </entry>
  <entry>
    <title>[Security]GPGåœ¨githubçš„åº”ç”¨</title>
    <url>/2020/03/02/Security-GPG-github/</url>
    <content><![CDATA[<p>åœ¨æœ¬åœ°çš„ git ä»“åº“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ç”¨æˆ·åå’Œé‚®ç®±åœ°å€æ‰èƒ½æäº¤æ–°çš„æ›´æ”¹ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™å¹¶ä¸éœ€è¦è·Ÿä½ çš„ GitHub è´¦å·ç›¸åŒã€‚è¿™å¸¦æ¥äº†ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ï¼šä»»ä½•äººéƒ½å¯ä»¥è®¾ç½®ç”¨æˆ·åå’Œé‚®ç®±åœ°å€æ¥ä¼ªè£…æˆä½ ï¼Œç”±äº GitHub ä¼šè‡ªåŠ¨æ ¹æ®ç”¨æˆ·åå’Œé‚®ç®±åœ°å€å…³è”å•æ¬¡çš„æäº¤ä¸ºæ³¨å†Œçš„ GitHub çš„è´¦æˆ·ï¼Œæ‰€ä»¥åˆ«äººå¯ä»¥ä»¿å†’ä½ çš„èº«ä»½è¿›è¡Œæäº¤æ›´æ”¹ã€‚<sup><a href="#myfootnote1">1</a></sup></p>
<p>å¦å¤–ä½ æ˜¯å¦è§è¿‡åˆ«äººçš„github commitå‡ºç°ä¸€ä¸ª<code>verified</code>å°æ ‡ç­¾ï¼š<br><img data-src="https://help.github.com/assets/images/help/commits/gpg-signed-commit-verified-without-details.png" alt="verified_commit"></p>
<p>ä¸Šè¿°è¿™ä¸¤ä»¶äº‹æƒ…å’Œæˆ‘ä»¬ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« æ¯æ¯ç›¸å…³ï¼š<a href="https://cakebytheoceanluo.github.io/2020/03/02/Security-GPG-intro/">[Security] GPG ä»‹ç»ä¸å¯†é’¥ç”Ÿæˆ</a>ã€‚</p>
<a id="more"></a>
<p><br></p>
<h1 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h1><p>åœ¨æœ¬åœ°çš„ git ä»“åº“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ç”¨æˆ·åå’Œé‚®ç®±åœ°å€æ‰èƒ½æäº¤æ–°çš„æ›´æ”¹ã€‚<span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9ib29rL2VuL3Yy" title="https://git-scm.com/book/en/v2">Pro Git<i class="fa fa-external-link"></i></span>è¿™æœ¬ä¹¦ä¸­æåˆ°ï¼šè®¾ç½®ç”¨æˆ·åå’Œé‚®ä»¶åœ°å€æ˜¯æˆ‘ä»¬ä¸‹è½½å®Œ<code>git</code>è¿™ä¸ªè½¯ä»¶åå¿…é¡»åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git config --global user.name <span class="string">"Abc Def"</span></span><br><span class="line">$ git config --global user.email <span class="string">"email@example.com"</span></span><br></pre></td></tr></tbody></table></figure>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™å¹¶ä¸éœ€è¦è·Ÿä½ çš„ GitHub è´¦å·ç›¸åŒã€‚è¿™å¸¦æ¥äº†ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ï¼šä»»ä½•äººéƒ½å¯ä»¥è®¾ç½®ç”¨æˆ·åå’Œé‚®ç®±åœ°å€æ¥ä¼ªè£…æˆä½ ï¼Œç”±äº GitHub ä¼šè‡ªåŠ¨æ ¹æ®ç”¨æˆ·åå’Œé‚®ç®±åœ°å€å…³è”å•æ¬¡çš„æäº¤ä¸ºæ³¨å†Œçš„ GitHub çš„è´¦æˆ·ï¼Œæ‰€ä»¥åˆ«äººå¯ä»¥ä»¿å†’ä½ çš„èº«ä»½è¿›è¡Œæäº¤æ›´æ”¹ã€‚è¿™å¸¦æ¥äº†ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ï¼šä»»ä½•äººéƒ½å¯ä»¥è®¾ç½®ç”¨æˆ·åå’Œé‚®ç®±åœ°å€æ¥ä¼ªè£…æˆä½ ï¼Œç”±äº GitHub ä¼šè‡ªåŠ¨æ ¹æ®ç”¨æˆ·åå’Œé‚®ç®±åœ°å€å…³è”å•æ¬¡çš„æäº¤ä¸ºæ³¨å†Œçš„ GitHub çš„è´¦æˆ·ï¼Œæ‰€ä»¥åˆ«äººå¯ä»¥ä»¿å†’ä½ çš„èº«ä»½è¿›è¡Œæäº¤æ›´æ”¹ã€‚<sup><a href="#myfootnote1">1</a></sup></p>
<p>GitHubä½¿ç”¨GPGè¿™ä¸ªåŠ å¯†æ–¹æ³•æ¥å¯¹commitè¿›è¡ŒéªŒè¯ï¼Œæ¥ç¡®å®šæœ¬æ¬¡commitçš„æ ‡ç­¾(tag)æ˜¯ç”±<code>gpg</code>å¯†é’¥æ‰€æœ‰è€…æ‰€æäº¤çš„ã€‚è¿™ç§è¢«éªŒè¯è¿‡çš„commitä¼šå¸¦æœ‰ä¸€ä¸ªå¾ˆ<strong>é…·</strong>åŒæ—¶<strong>å¾ˆå®‰å…¨</strong>çš„<code>verfified</code>æ ‡ç­¾ï¼š</p>
<p><img data-src="https://help.github.com/assets/images/help/commits/gpg-signed-commit-verified-without-details.png" alt="verified_commit"></p>
<p>è€Œæ²¡æœ‰è¯¥<code>verified</code>æ ‡ç­¾æœªå¿…æ˜¯æœ¬äººæäº¤ï¼Œå› ä¸ºgithubçš„æäº¤logä¸­çš„æäº¤äººå¯ä»¥éšæ„ä¿®æ”¹ã€‚</p>
<p><br></p>
<h1 id="GPGç®€ä»‹"><a href="#GPGç®€ä»‹" class="headerlink" title="GPGç®€ä»‹"></a>GPGç®€ä»‹</h1><p>è¿™é‡Œä¸å†èµ˜è¿°ï¼Œè¯·ç§»æ­¥è‡³ï¼š <a href="https://cakebytheoceanluo.github.io/2020/03/02/Security-GPG-intro/">[Security] GPG ä»‹ç»ä¸å¯†é’¥ç”Ÿæˆ</a>ã€‚</p>
<p>æ­£å¦‚æˆ‘ä»¬åœ¨å¼•å…¥éƒ¨åˆ†ä¸­æåˆ°çš„ï¼š <strong>å¯†é’¥ç”Ÿæˆæ—¶éœ€è¦æ³¨æ„ï¼Œé‚®ç®±éœ€è¦å’ŒGitHubå¯¹åº”çš„é‚®ç®±ç›¸åŒã€‚</strong></p>
<p><br></p>
<h1 id="åˆ—å‡ºå¯†é’¥"><a href="#åˆ—å‡ºå¯†é’¥" class="headerlink" title="åˆ—å‡ºå¯†é’¥"></a>åˆ—å‡ºå¯†é’¥</h1><p>å½“æˆ‘ä»¬å®Œæˆç§˜é’¥çš„ç”Ÿæˆåï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤å¯¹æœ¬æœºæ‰€æ‹¥æœ‰çš„<code>gpg</code>ç§˜é’¥è¿›è¡ŒæŸ¥çœ‹:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --list-keys</span><br><span class="line"></span><br><span class="line">/home/jigao/.gnupg/pubring.kbx</span><br><span class="line">------------------------------</span><br><span class="line">pub   rsa4096 2020-03-02 [SC]</span><br><span class="line">      704A75374771234881B10559F98069D551217BFD</span><br><span class="line">uid           [ultimate] Jigao Luo &lt;luojigao@outlook.com&gt;</span><br><span class="line">sub   rsa4096 2020-03-02 [E]</span><br></pre></td></tr></tbody></table></figure>
<p>ç¬¬ä¸€è¡Œæ˜¾ç¤ºå…¬é’¥æ–‡ä»¶å(pubring.gpg)ï¼Œç¬¬äºŒè¡Œæ˜¾ç¤ºå…¬é’¥ç‰¹å¾(4096ä½ï¼ŒHashå­—ç¬¦ä¸²å’Œç”Ÿæˆæ—¶é—´)ï¼Œç¬¬ä¸‰è¡Œæ˜¾ç¤ºâ€ç”¨æˆ·ID uidâ€ï¼Œç¬¬å››è¡Œæ˜¾ç¤ºç§é’¥ç‰¹å¾ã€‚<sup><a href="#myfootnote1">1</a></sup></p>
<p>æˆ–è€…å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå»åˆ—å‡ºå¯†é’¥ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --list-secret-keys --keyid-format LONG</span><br></pre></td></tr></tbody></table></figure><br><br><p></p>
<h1 id="æ·»åŠ -public-key-åˆ°-GitHub"><a href="#æ·»åŠ -public-key-åˆ°-GitHub" class="headerlink" title="æ·»åŠ  public key åˆ° GitHub"></a>æ·»åŠ  public key åˆ° GitHub</h1><p>å…¬é’¥(public key)æ–‡ä»¶().gnupg/pubring.gpg)ä»¥äºŒè¿›åˆ¶å½¢å¼å‚¨å­˜ï¼Œ<code>--armorå‚æ•°</code>å¯ä»¥å°†å…¶è½¬æ¢ä¸ºASCIIç æ˜¾ç¤ºã€‚</p>
<ul>
<li>æˆ‘ä»¬éœ€è¦ä»¥standard outçš„æ–¹å¼è¾“å‡ºæˆ‘ä»¬çš„å…¬é’¥: <code>gpg --armor --export [Key ID]</code></li>
<li>æˆ–è€…æˆ‘ä»¬åŠ ä¸Š<code>--output &lt;filename&gt;</code>å‚æ•°ï¼Œå¯ä»¥å°†è¿™ä¸ªå…¬é’¥å†™å…¥ä¸€ä¸ªè¾“å‡ºæ–‡ä»¶: <code>gpg --armor --output public-key.txt --export [Key ID]</code></li>
</ul>
<p>å®é™…ä¸Šçš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --armor --<span class="built_in">export</span> 704A75374771234881B10559F98069D551217BFD</span><br><span class="line">-----BEGIN PGP PUBLIC KEY BLOCK-----</span><br><span class="line"><span class="comment"># ...............</span></span><br><span class="line"><span class="comment"># .....å·²åˆ å».....</span></span><br><span class="line"><span class="comment"># ...............</span></span><br><span class="line">-----END PGP PUBLIC KEY BLOCK-----</span><br></pre></td></tr></tbody></table></figure>
<p>äº‹å®ä¸Špublic keyå¯ä»¥å…¬å¼€ï¼Œè¿™é‡Œæˆ‘ä»¬èŠ‚çœæ–‡ç« ç©ºé—´å°†å…¶åˆ å»ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å¤åˆ¶ä»<code>-----BEGIN PGP PUBLIC KEY BLOCK-----</code>(å«) å¼€å§‹ï¼Œåˆ° <code>-----END PGP PUBLIC KEY BLOCK-----</code>ç»“æŸ(å«)åˆ°æˆ‘ä»¬GitHubçš„settingä¸‹ï¼š</p>
<p><img data-src="https://help.github.com/assets/images/help/settings/userbar-account-settings.png" alt="setting"></p>
<p><br></p>
<p><img data-src="https://help.github.com/assets/images/help/settings/settings-sidebar-ssh-keys.png" alt="ssh_gpg"></p>
<p><br></p>
<p><img data-src="https://help.github.com/assets/images/help/settings/gpg-add-gpg-key.png" alt="new_gpg_ket"></p>
<p><br></p>
<p><img data-src="https://help.github.com/assets/images/help/settings/gpg-key-paste.png" alt="copy_key"></p>
<p><br></p>
<h1 id="è®¾ç½®æœ¬åœ°-Git-2"><a href="#è®¾ç½®æœ¬åœ°-Git-2" class="headerlink" title="è®¾ç½®æœ¬åœ° Git 2:"></a>è®¾ç½®æœ¬åœ° Git <sup><a href="#myfootnote2">2</a></sup>:</h1><p>å¦‚æœæˆ‘ä»¬å·²ç»æˆåŠŸåœ¨GitHubä¸Šæäº¤æˆ‘ä»¬çš„å…¬é’¥ï¼Œæˆ‘ä»¬åªç¦»é‚£ä¸ªå¾ˆ<strong>é…·</strong>åŒæ—¶<strong>å¾ˆå®‰å…¨</strong>çš„<code>verfified</code>æ ‡ç­¾åªå‰©æœ€åä¸€æ­¥: è®¾ç½®æœ¬åœ° Gitã€‚</p>
<p>æˆ‘ä»¬éœ€è¦è¿è¡Œå¦‚ä¸‹çš„å‘½ä»¤ï¼š </p>
<ul>
<li>è®¾ç½® git GPG å‘½ä»¤ã€‚  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git config --global gpg.program gpg</span><br></pre></td></tr></tbody></table></figure></li>
<li>è®¾ç½® git GPG keyã€‚æˆ‘çš„GPG key ID æ˜¯ 704A75374771234881B10559F98069D551217BFDï¼Œä½ è‡ªå·±åšçš„æ—¶å€™éœ€è¦æ›¿æ¢æˆè‡ªå·±çš„GPG key IDã€‚  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git config --global user.signingkey 704A75374771234881B10559F98069D551217BFD</span><br></pre></td></tr></tbody></table></figure></li>
<li>å¼ºåˆ¶æ¯æ¬¡æäº¤éƒ½è‡ªåŠ¨ä½¿ç”¨ GPG ç­¾åã€‚  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git config --global commit.gpgsign <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>è®²GPG keyåŠ å…¥æˆ‘ä»¬çš„<code>.profile</code>æ–‡ä»¶ <sup><a href="#myfootnote3">3</a></sup>ï¼š  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">test</span> -r ~/.bash_profile &amp;&amp; <span class="built_in">echo</span> <span class="string">'export GPG_TTY=$(tty)'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'export GPG_TTY=$(tty)'</span> &gt;&gt; ~/.profile</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>å½“æˆ‘ä»¬æäº¤æ–°çš„ commit çš„æ—¶å€™ï¼Œgit å°±ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨ä½¿ç”¨ GPG æ¥ç­¾åã€‚ç„¶ä¹Ÿå¯ä»¥åœ¨æäº¤çš„æ—¶å€™ä½¿ç”¨<code>git commit -S</code>å‚æ•°æ¥æ˜¾å¼å¯ç”¨éªŒè¯ã€‚ç„¶åæˆ‘ä»¬å°±å¯ä»¥çœ‹è§é‚£ä¸ªå¾ˆ<strong>é…·</strong>åŒæ—¶<strong>å¾ˆå®‰å…¨</strong>çš„<code>verfified</code>æ ‡ç­¾äº†ã€‚</p>
<p><br></p>
<h1 id="è¡¥å……æ³¨é‡Š"><a href="#è¡¥å……æ³¨é‡Š" class="headerlink" title="è¡¥å……æ³¨é‡Š"></a>è¡¥å……æ³¨é‡Š</h1><p><a name="myfootnote2">2</a>: </p>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„å‰ææ˜¯<code>git config --global</code>ï¼Œå³å¯¹å½“å‰ç”¨æˆ· <strong>è¿›è¡Œè®¾ç½®</strong>ã€‚å¦‚æœä½ çš„æƒ³æ³•<strong>åªæ˜¯åœ¨ä¸€ä¸ªå½“å‰é¡¹ç›®ä¸­ä½¿ç”¨gpg keyæ¥éªŒè¯</strong>ï¼Œé‚£å°±åœ¨å½“å‰é¡¹ç›®çš„æ–‡ä»¶å¤¹ä¸­ï¼Œè¾“å…¥ä»¥ä¸Šå‘½ä»¤ä¸å¸¦<code>--global</code>ã€‚æ¯”å¦‚<code>git config commit.gpgsign true</code>ã€‚</p>
<p>è¿™é‡Œæˆ‘ä¸»è§‚åœ°å¤šä¸€å¥å˜´ï¼Œ<code>gpg</code>æ˜¯ä¸€ä¸ªå¾ˆå®‰å…¨å¯é çš„å·¥å…·ï¼Œå®ƒå€¼å¾—æˆ‘ä»¬ä½¿ç”¨<code>--global</code>è¿™ä¸ªflagã€‚</p>
<p>ç„¶åæˆ‘ä»¬å¤ä¹ ä¸€ä¸‹<span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9ib29rL2VuL3Yy" title="https://git-scm.com/book/en/v2">Pro Git<i class="fa fa-external-link"></i></span>ä¸­çš„ä¸€ç‚¹æœ‰å…³å†…å®¹ï¼š</p>
<p>gité…ç½®ä¿å­˜åœ¨3å¤„ï¼Œå¯¹åº”ç€ä¸‰ä¸ªçº§åˆ«ã€‚é…ç½®ä¼˜å…ˆçº§ä¸º: æœ¬é¡¹ç›® &gt; å½“å‰ç”¨æˆ· &gt; ç³»ç»Ÿå…¨å±€: </p>
<div class="table-container">
<table>
<thead>
<tr>
<th>ä½œç”¨èŒƒå›´</th>
<th>é…ç½®æ–‡ä»¶</th>
<th>git configé€‰é¡¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç³»ç»Ÿå…¨å±€</td>
<td><code>/etc/gitconfig</code></td>
<td><code>--system</code></td>
</tr>
<tr>
<td>å½“å‰ç”¨æˆ·</td>
<td><code>~/.gitconfig</code>æˆ–<code>~/.config/git/config</code></td>
<td><code>--global</code></td>
</tr>
<tr>
<td>æœ¬é¡¹ç›®</td>
<td><code>é¡¹ç›®ç›®å½•/.git/config</code></td>
<td>æ— flag</td>
</tr>
</tbody>
</table>
</div>
<p><br></p>
<p><a name="myfootnote3">3</a>: </p>
<ul>
<li><code>test</code>å‘½ä»¤è¡Œå·¥å…·ï¼šå®ƒæ£€æŸ¥ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå®ƒæ²¡æœ‰standard outï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªboolå€¼ã€‚</li>
<li><code>test -r</code> çœ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶æ˜¯å¦æœ‰è¯»çš„æƒé™ï¼š  <figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">-r FILE</span><br><span class="line">       FILE exists and read permission is granted</span><br></pre></td></tr></tbody></table></figure></li>
<li><code>test -r ~/.bash_profile &amp;&amp; (...)</code>: æŸ¥çœ‹<code>~/.bash_profile</code>è¿™ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå®ƒå­˜åœ¨å¹¶ä¸”å½“å‰ç”¨æˆ·æœ‰è¯»æƒé™ï¼Œå°±æ‰§è¡Œ<code>(...)</code>è¿™ä¸€æ¡å‘½ä»¤ã€‚</li>
</ul>
<p><br></p>
<p>å¼•ç”¨ï¼š</p>
<p><a name="myfootnote1">1</a>:ã€€GitHub ä½¿ç”¨ GPG ç®€ä»‹ <span class="exturl" data-url="aHR0cHM6Ly93d3cuY29kZXJjdG8uY29tL2EvNDk3MTEuaHRtbA==" title="https://www.codercto.com/a/49711.html">https://www.codercto.com/a/49711.html<i class="fa fa-external-link"></i></span></p>
<p>å›¾ç‰‡æ¥è‡ªï¼š Adding a new GPG key to your GitHub account: <span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmdpdGh1Yi5jb20vZW4vZ2l0aHViL2F1dGhlbnRpY2F0aW5nLXRvLWdpdGh1Yi9hZGRpbmctYS1uZXctZ3BnLWtleS10by15b3VyLWdpdGh1Yi1hY2NvdW50" title="https://help.github.com/en/github/authenticating-to-github/adding-a-new-gpg-key-to-your-github-account">https://help.github.com/en/github/authenticating-to-github/adding-a-new-gpg-key-to-your-github-account<i class="fa fa-external-link"></i></span></p>
<p>Telling Git about your signing keyï¼š <span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmdpdGh1Yi5jb20vZW4vZ2l0aHViL2F1dGhlbnRpY2F0aW5nLXRvLWdpdGh1Yi90ZWxsaW5nLWdpdC1hYm91dC15b3VyLXNpZ25pbmcta2V5" title="https://help.github.com/en/github/authenticating-to-github/telling-git-about-your-signing-key">https://help.github.com/en/github/authenticating-to-github/telling-git-about-your-signing-key<i class="fa fa-external-link"></i></span></p>
<p>å›¾ç‰‡æ¥è‡ªï¼š Signing commitsï¼š <span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmdpdGh1Yi5jb20vZW4vZ2l0aHViL2F1dGhlbnRpY2F0aW5nLXRvLWdpdGh1Yi9zaWduaW5nLWNvbW1pdHM=" title="https://help.github.com/en/github/authenticating-to-github/signing-commits">https://help.github.com/en/github/authenticating-to-github/signing-commits<i class="fa fa-external-link"></i></span></p>
<p>Pro Git: <span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9ib29rL2VuL3Yy" title="https://git-scm.com/book/en/v2">https://git-scm.com/book/en/v2<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<p>æ¨èçš„é˜…è¯»:</p>
<p>Managing Commit Signature Verification GitHub <span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmdpdGh1Yi5jb20vZW4vZ2l0aHViL2F1dGhlbnRpY2F0aW5nLXRvLWdpdGh1Yi9tYW5hZ2luZy1jb21taXQtc2lnbmF0dXJlLXZlcmlmaWNhdGlvbg==" title="https://help.github.com/en/github/authenticating-to-github/managing-commit-signature-verification">https://help.github.com/en/github/authenticating-to-github/managing-commit-signature-verification<i class="fa fa-external-link"></i></span></p>
<p>Paul Heinlein, GPG Quick Start <span class="exturl" data-url="aHR0cHM6Ly93d3cubWFkYm9hLmNvbS9nZWVrL2dwZy1xdWlja3N0YXJ0Lw==" title="https://www.madboa.com/geek/gpg-quickstart/">https://www.madboa.com/geek/gpg-quickstart/<i class="fa fa-external-link"></i></span></p>
<p>Ubuntu helpï¼ŒGnuPrivacyGuardHowto <span class="exturl" data-url="aHR0cHM6Ly9oZWxwLnVidW50dS5jb20vY29tbXVuaXR5L0dudVByaXZhY3lHdWFyZEhvd3Rv" title="https://help.ubuntu.com/community/GnuPrivacyGuardHowto">https://help.ubuntu.com/community/GnuPrivacyGuardHowto<i class="fa fa-external-link"></i></span></p>
<p>Alan Eliasen. GPG Tutorial <span class="exturl" data-url="aHR0cHM6Ly9mdXR1cmVib3kudXMvcGdwLmh0bWw=" title="https://futureboy.us/pgp.html">https://futureboy.us/pgp.html<i class="fa fa-external-link"></i></span></p>
<p>GnuPG è¢–ç HOWTO (ä¸­æ–‡ç‰ˆ) <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ251cGcub3JnL2hvd3Rvcy96aC9pbmRleC5odG1s" title="https://www.gnupg.org/howtos/zh/index.html">https://www.gnupg.org/howtos/zh/index.html<i class="fa fa-external-link"></i></span></p>
<p>The GNU Privacy Handbook <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ251cGcub3JnL2dwaC9lbi9tYW51YWwuaHRtbA==" title="https://www.gnupg.org/gph/en/manual.html">https://www.gnupg.org/gph/en/manual.html<i class="fa fa-external-link"></i></span></p>
<!-- 
è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ -->
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Operating System</category>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Security</tag>
        <tag>GPG</tag>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>[Security]GPGä»‹ç»ä¸å¯†é’¥ç”Ÿæˆ</title>
    <url>/2020/03/02/Security-GPG-intro/</url>
    <content><![CDATA[<p>å…¬å¼€å¯†é’¥å¯†ç å­¦(Public-key cryptography)æˆ–éå¯¹ç§°å¼å¯†ç å­¦(Asymmetric cryptography)æ˜¯ä¸€ç§éå¸¸æµè¡Œçš„åŠ å¯†ç®—æ³•ï¼Œå®ƒåº”ç”¨äºå»ä¸­å¿ƒåŒ–çš„ä¿¡ä»»ç½‘ç»œä»¥åŠæ“ä½œç³»ç»Ÿä¸­ã€‚è¿™ä¸ªç®—æ³•åœ¨ç°å®ä¸­å¯¹ä¿¡æ¯åŠ å¯†å’Œè§£å¯†ï¼Œå¯ä»¥ç”¨åˆ°GnuPGè½¯ä»¶(ç®€ç§°GPG)ï¼Œå®ƒæ˜¯ç›®å‰æœ€æµè¡Œçš„åŠ å¯†å·¥å…·ä¹‹ä¸€ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»gpgè½¯ä»¶çš„ä½¿ç”¨å’Œç”Ÿäº§å¯†é’¥å¯¹ã€‚æœ¬æ–‡çš„ä½¿ç”¨ç¯å¢ƒä¸ºLinux Ubuntuå‘½ä»¤è¡Œã€‚å¦å¤–åœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä½¿ç”¨çš„æ˜¯<code>gpg (GnuPG) 2.2.4. libgcrypt 1.8.1.ã€€Copyright (C) 2017 Free Software Foundation, Inc.</code>çš„è‹±æ–‡ç‰ˆæœ¬ã€‚</p>
<p><img data-src="https://gnupg.org/share/logo-gnupg-light-purple-bg.png" alt="GnuPG"></p>
<a id="more"></a>
<p><br></p>
<h1 id="GPGä»‹ç»"><a href="#GPGä»‹ç»" class="headerlink" title="GPGä»‹ç»"></a>GPGä»‹ç»</h1><p>è¦äº†è§£ä»€ä¹ˆæ˜¯GPGï¼Œå°±è¦å…ˆäº†è§£<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJldHR5X0dvb2RfUHJpdmFjeQ==" title="https://en.wikipedia.org/wiki/Pretty_Good_Privacy">PGP<i class="fa fa-external-link"></i></span>(Pretty Good Privacy)ã€‚</p>
<p>1991å¹´ï¼Œç¨‹åºå‘˜Phil Zimmermannä¸ºäº†é¿å¼€æ”¿åºœç›‘è§†ï¼Œå¼€å‘äº†åŠ å¯†è½¯ä»¶PGPã€‚è¿™ä¸ªè½¯ä»¶éå¸¸å¥½ç”¨ï¼Œè¿…é€Ÿæµä¼ å¼€æ¥ï¼Œæˆäº†è®¸å¤šç¨‹åºå‘˜çš„å¿…å¤‡å·¥å…·ã€‚ä½†æ˜¯ï¼Œå®ƒæ˜¯å•†ä¸šè½¯ä»¶ï¼Œä¸èƒ½è‡ªç”±ä½¿ç”¨ã€‚æ‰€ä»¥ï¼Œè‡ªç”±è½¯ä»¶åŸºé‡‘ä¼šå†³å®šï¼Œå¼€å‘ä¸€ä¸ªPGPçš„æ›¿ä»£å“ï¼Œå–åä¸ºGnuPGã€‚è¿™å°±æ˜¯GPGçš„ç”±æ¥ã€‚<sup><a href="#myfootnote1">1</a></sup></p>
<p><br></p>
<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>æœ‰å¤šç§é€”å¾„ï¼š</p>
<ul>
<li>ä»<span class="exturl" data-url="aHR0cHM6Ly93d3cuZ251cGcub3JnL2Rvd25sb2FkLw==" title="https://www.gnupg.org/download/">GPGç½‘ç«™ä¸‹è½½<i class="fa fa-external-link"></i></span>ï¼Œç„¶åè‡ªå·±ç¼–è¯‘å®‰è£…ã€‚  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></tbody></table></figure></li>
<li>ä»è½¯ä»¶æºå®‰è£…ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶åŒ…ï¼š<code>sudo apt-get install gnupg</code></li>
</ul>
<p><br></p>
<p>ç„¶åæˆ‘ä»¬æ¥ç”¨<code>gpg --help</code>æ£€éªŒä¸€ä¸‹è½¯ä»¶æ˜¯å¦æˆåŠŸå®‰è£…:<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --<span class="built_in">help</span></span><br><span class="line">gpg (GnuPG) 2.2.4</span><br><span class="line">libgcrypt 1.8.1</span><br><span class="line">Copyright (C) 2017 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;https://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"><span class="comment">## ........................</span></span><br><span class="line"><span class="comment">## ........å¤ªé•¿ã€€ç•¥å»........</span></span><br><span class="line"><span class="comment">## ........................</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p><br></p>
<h1 id="ç”Ÿæˆå¯†é’¥å¯¹key-pair"><a href="#ç”Ÿæˆå¯†é’¥å¯¹key-pair" class="headerlink" title="ç”Ÿæˆå¯†é’¥å¯¹key pair"></a>ç”Ÿæˆå¯†é’¥å¯¹key pair</h1><p>åœ¨è¿™ä¸€æ­¥æˆ‘æä¸€ä¸‹ï¼Œè¿™ç¯‡æ–‡ç« æ‰€å¼•ç”¨çš„å…¶ä»–ä¸­æ–‡æ•™ç¨‹ä½¿ç”¨çš„<code>gpg</code>éƒ½æ˜¯2.1.17ä¹‹å‰çš„ç‰ˆæœ¬ã€‚è¿™äº›è€ç‰ˆæœ¬çš„å‘½ä»¤è¡Œæœ‰äº›ä¸ä¸€æ ·ã€‚ä¸å†å»ºè®®å‚è€ƒè¿™äº›è€çš„ä¸­æ–‡æ•™ç¨‹ã€‚ä¹Ÿä¸å†å»ºè®®ä½¿ç”¨è€ç‰ˆæœ¬çš„<code>gpg</code>ã€‚æœ¬æ–‡ä¸å†å…³æ³¨è€ç‰ˆæœ¬çš„<code>gpg</code>ï¼Œé’ˆå¯¹è€ç‰ˆæœ¬çš„æ“ä½œå¯ä»¥å‚è€ƒã€€<span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmdpdGh1Yi5jb20vZW4vZ2l0aHViL2F1dGhlbnRpY2F0aW5nLXRvLWdpdGh1Yi9nZW5lcmF0aW5nLWEtbmV3LWdwZy1rZXk=" title="https://help.github.com/en/github/authenticating-to-github/generating-a-new-gpg-key">https://help.github.com/en/github/authenticating-to-github/generating-a-new-gpg-key<i class="fa fa-external-link"></i></span>ã€€ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬<code>gpg</code>çš„ç‰ˆæœ¬æ˜¯2.1.17æˆ–å®ƒä¹‹åçš„æ–°ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ç”¨å¦‚ä¸‹çš„å‘½ä»¤å»ç”ŸæˆGPG key pairï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --full-generate-key</span><br><span class="line">gpg (GnuPG) 2.2.4; Copyright (C) 2017 Free Software Foundation, Inc.</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">Please select what kind of key you want:</span><br><span class="line">   (1) RSA and RSA (default)</span><br><span class="line">   (2) DSA and Elgamal</span><br><span class="line">   (3) DSA (sign only)</span><br><span class="line">   (4) RSA (sign only)</span><br><span class="line">Your selection?</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>è¿™ä¸ªé—®é¢˜æ˜¯è®©ç”¨æˆ·è‡ªå·±é€‰æ‹©åŠ å¯†ç®—æ³•ã€‚å¯ä»¥ç›´æ¥æŒ‰<code>Enterå›è½¦é”®</code>é€‰æ‹©é»˜è®¤ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼Œè¡¨ç¤ºåŠ å¯†å’Œç­¾åéƒ½ä½¿ç”¨RSAç®—æ³•ã€‚</p>
<p><br></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">RSA keys may be between 1024 and 4096 bits long.</span><br><span class="line">What keysize <span class="keyword">do</span> you want? (3072)</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œé—®ç”¨æˆ·å¯†é’¥çš„é•¿åº¦ã€‚æœ€å¥½æˆ‘ä»¬è¾“å…¥æœ€é•¿çš„<code>4096</code>ï¼Œç„¶åæŒ‰<code>Enterå›è½¦é”®</code>ã€‚</p>
<p><br></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Please specify how long the key should be valid.</span><br><span class="line">         0 = key does not expire</span><br><span class="line">      &lt;n&gt;  = key expires <span class="keyword">in</span> n days</span><br><span class="line">      &lt;n&gt;w = key expires <span class="keyword">in</span> n weeks</span><br><span class="line">      &lt;n&gt;m = key expires <span class="keyword">in</span> n months</span><br><span class="line">      &lt;n&gt;y = key expires <span class="keyword">in</span> n years</span><br><span class="line">Key is valid <span class="keyword">for</span>? (0)</span><br></pre></td></tr></tbody></table></figure>
<p>æ¥ç€æˆ‘å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œè¦æ±‚è®¾ç½®å¯†é’¥çš„æœ‰æ•ˆæœŸ(valid time length)ã€‚å¦‚æœå¯†é’¥åªæ˜¯ä¸ªäººä½¿ç”¨ï¼Œå¹¶ä¸”ç¡®è®¤å¯ä»¥æœ‰æ•ˆä¿ç®¡ç§é’¥ï¼Œå»ºè®®é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼Œå³æ°¸ä¸è¿‡æœŸ(expire)ã€‚è¾“å…¥<code>0</code>ï¼Œç„¶åæŒ‰<code>Enterå›è½¦é”®</code>ã€‚</p>
<p><br></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Is this correct? (y/N)</span><br></pre></td></tr></tbody></table></figure>
<p>å›ç­”å®Œä¸Šé¢ä¸‰ä¸ªé—®é¢˜ä»¥åï¼Œéœ€è¦ç¡®è®¤ã€‚åœ¨ç¡®è®¤ä»¥åï¼Œè¾“å…¥<code>y</code>ï¼Œç„¶åæŒ‰<code>Enterå›è½¦é”®</code>ã€‚</p>
<p><br></p>
<p>ç„¶åæˆ‘ä»¬éœ€è¦è¾“å…¥è‡ªå·±çš„åå­—å’Œé‚®ç®±ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦å¯†é’¥ç»™GitHubä½¿ç”¨çš„è¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„é‚®ç®±éœ€è¦å’ŒGitHubå¯¹åº”çš„é‚®ç®±ç›¸åŒã€‚</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmdpdGh1Yi5jb20vZW4vZ2l0aHViL2dldHRpbmctc3RhcnRlZC13aXRoLWdpdGh1Yi92ZXJpZnlpbmcteW91ci1lbWFpbC1hZGRyZXNz" title="https://help.github.com/en/github/getting-started-with-github/verifying-your-email-address">https://help.github.com/en/github/getting-started-with-github/verifying-your-email-address<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmdpdGh1Yi5jb20vZW4vZ2l0aHViL3NldHRpbmctdXAtYW5kLW1hbmFnaW5nLXlvdXItZ2l0aHViLXVzZXItYWNjb3VudC9zZXR0aW5nLXlvdXItY29tbWl0LWVtYWlsLWFkZHJlc3M=" title="https://help.github.com/en/github/setting-up-and-managing-your-github-user-account/setting-your-commit-email-address">https://help.github.com/en/github/setting-up-and-managing-your-github-user-account/setting-your-commit-email-address<i class="fa fa-external-link"></i></span></li>
</ul>
<p>è¾“å…¥å®Œä¹‹åçš„è¾“å‡ºç±»ä¼¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GnuPG needs to construct a user ID to identify your key.</span><br><span class="line"></span><br><span class="line">Real name: Jigao Luo</span><br><span class="line">Email address: luojigao@outlook.com</span><br><span class="line">Comment: </span><br><span class="line">You selected this USER-ID:</span><br><span class="line">    <span class="string">"Jigao Luo &lt;luojigao@outlook.com&gt;"</span></span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit?</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœæˆ‘ä»¬éƒ½ç¡®è®¤çš„è¯ï¼Œè¾“å…¥<code>o</code>ï¼Œç„¶åæŒ‰<code>Enterå›è½¦é”®</code>ã€‚</p>
<p>è¿™ä¹‹åç³»ç»Ÿä¼šè¦æ±‚æˆ‘ä»¬è®¾å®šä¸€ä¸ªç»™å¯†é’¥çš„å¯†ç ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢è¯¯æ“ä½œï¼Œæˆ–è€…ç³»ç»Ÿè¢«ä¾µå…¥æ—¶æœ‰äººæ“…è‡ªåŠ¨ç”¨ç§é’¥ã€‚</p>
<p>æœ€å<code>gpg</code>å¼€å§‹ç”Ÿäº§å¯†é’¥å¯¹ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">We need to generate a lot of random bytes. It is a good idea to perform</span><br><span class="line">some other action (<span class="built_in">type</span> on the keyboard, move the mouse, utilize the</span><br><span class="line">disks) during the prime generation; this gives the random number</span><br><span class="line">generator a better chance to gain enough entropy.</span><br></pre></td></tr></tbody></table></figure>
<p>ç”Ÿæˆå®Œä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">gpg: key F98069D551217BFD marked as ultimately trusted</span><br><span class="line">gpg: revocation certificate stored as <span class="string">'&lt;å­˜å‚¨è·¯å¾„å·²åˆ å»&gt;'</span></span><br><span class="line">public and secret key created and signed.</span><br><span class="line"></span><br><span class="line">pub   rsa4096 2020-03-02 [SC]</span><br><span class="line">      704A75374771234881B10559F98069D551217BFD</span><br><span class="line">uid                      Jigao Luo &lt;luojigao@outlook.com&gt;</span><br><span class="line">sub   rsa4096 2020-03-02 [E]</span><br></pre></td></tr></tbody></table></figure>
<p><code>F98069D551217BFD</code>è¿™ä¸ªå­—ç¬¦ä¸²å¾ˆé‡è¦ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬è¿™ä¸ªå¯†é’¥å¯¹çš„Hashå­—ç¬¦ä¸²ï¼Œå®ƒå¯¹åº”æˆ‘ä»¬è¾“å…¥çš„é‚®ç®±ã€‚</p>
<p><br></p>
<h1 id="ç”Ÿæˆå¯†é’¥å¯¹çš„æ’¤é”€è¯ä¹¦"><a href="#ç”Ÿæˆå¯†é’¥å¯¹çš„æ’¤é”€è¯ä¹¦" class="headerlink" title="ç”Ÿæˆå¯†é’¥å¯¹çš„æ’¤é”€è¯ä¹¦"></a>ç”Ÿæˆå¯†é’¥å¯¹çš„æ’¤é”€è¯ä¹¦</h1><p>åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„pgpå¯†é’¥å¯¹å·²ç»ç”Ÿæˆå®Œæˆã€‚ä½†æ˜¯æœ€å¥½æˆ‘ä»¬ç°åœ¨å†ç”Ÿäº§ä¸€å¼ æ’¤é”€è¯ä¹¦(revocation certificate)ï¼Œä»¥å¤‡ä»¥åå¯†é’¥ä½œåºŸæ—¶ï¼Œå¯ä»¥è¯·æ±‚å¤–éƒ¨çš„å…¬é’¥æœåŠ¡å™¨æ’¤é”€ä½ çš„å…¬é’¥ã€‚<sup><a href="#myfootnote1">1</a></sup></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --gen-revoke [Key ID]</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸Šé¢çš„â€Key IDâ€éƒ¨åˆ†ï¼Œå¯ä»¥å¡«å…¥ä½ çš„é‚®ä»¶åœ°å€æˆ–è€…Hashå­—ç¬¦ä¸²ã€‚ä¹‹åæˆ‘ä»¬ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">-----BEGIN PGP PUBLIC KEY BLOCK-----</span><br><span class="line">Comment: This is a revocation certificate</span><br><span class="line"></span><br><span class="line">&lt;............................................&gt;</span><br><span class="line">&lt;............................................&gt;</span><br><span class="line">-----END PGP PUBLIC KEY BLOCK-----</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åæŠŠè¿™å—stanard outputè¾“å‡ºä¿å­˜ï¼</p>
<p>æˆ–è€…:<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --output revoke.asc --gen-revoke</span><br></pre></td></tr></tbody></table></figure><br>è¿™æ ·å¯¹åº”çš„æ’¤é”€è¯ä¹¦è¢«ä¿å­˜åœ¨<code>revoke.asc</code>æ–‡ä»¶ä¸­ã€‚<p></p>
<p><br></p>
<p>æœ€é‡è¦çš„ä¸€ç‚¹:ã€€è¿™ä¸ªæ’¤é”€è¯ä¹¦ä¸èƒ½ç»™åˆ«äººï¼</p>
<blockquote>
<p>Please move it to a medium which you can hide away; if Mallory gets<br>access to this certificate he can use it to make your key unusable.<br>It is smart to print this certificate and store it away, just in case<br>your media become unreadable.  But have some caution:  The print system of<br>your machine might store the data and make it available to others!</p>
</blockquote>
<p><br></p>
<h1 id="åˆ—å‡ºå¯†é’¥"><a href="#åˆ—å‡ºå¯†é’¥" class="headerlink" title="åˆ—å‡ºå¯†é’¥"></a>åˆ—å‡ºå¯†é’¥</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --list-keys</span><br><span class="line"></span><br><span class="line">/home/jigao/.gnupg/pubring.kbx</span><br><span class="line">------------------------------</span><br><span class="line">pub   rsa4096 2020-03-02 [SC]</span><br><span class="line">      704A75374771234881B10559F98069D551217BFD</span><br><span class="line">uid           [ultimate] Jigao Luo &lt;luojigao@outlook.com&gt;</span><br><span class="line">sub   rsa4096 2020-03-02 [E]</span><br></pre></td></tr></tbody></table></figure>
<p>ç¬¬ä¸€è¡Œæ˜¾ç¤ºå…¬é’¥æ–‡ä»¶å(pubring.gpg)ï¼Œç¬¬äºŒè¡Œæ˜¾ç¤ºå…¬é’¥ç‰¹å¾(4096ä½ï¼ŒHashå­—ç¬¦ä¸²å’Œç”Ÿæˆæ—¶é—´)ï¼Œç¬¬ä¸‰è¡Œæ˜¾ç¤ºâ€ç”¨æˆ·ID uidâ€ï¼Œç¬¬å››è¡Œæ˜¾ç¤ºç§é’¥ç‰¹å¾ã€‚ã€‚<sup><a href="#myfootnote1">1</a></sup></p>
<p>æˆ–è€…å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå»åˆ—å‡ºå¯†é’¥ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gpg --list-secret-keys --keyid-format LONG</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><a name="myfootnote1">1</a>:ã€€GPGå…¥é—¨æ•™ç¨‹ é˜®ä¸€å³° <span class="exturl" data-url="aHR0cDovL3d3dy5ydWFueWlmZW5nLmNvbS9ibG9nLzIwMTMvMDcvZ3BnLmh0bWw=" title="http://www.ruanyifeng.com/blog/2013/07/gpg.html">http://www.ruanyifeng.com/blog/2013/07/gpg.html<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmdpdGh1Yi5jb20vZW4vZ2l0aHViL2F1dGhlbnRpY2F0aW5nLXRvLWdpdGh1Yi9nZW5lcmF0aW5nLWEtbmV3LWdwZy1rZXk=" title="https://help.github.com/en/github/authenticating-to-github/generating-a-new-gpg-key">https://help.github.com/en/github/authenticating-to-github/generating-a-new-gpg-key<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZ251cGcub3JnL2dwaC9lbi9tYW51YWwvYzE0Lmh0bWw=" title="https://www.gnupg.org/gph/en/manual/c14.html">https://www.gnupg.org/gph/en/manual/c14.html<i class="fa fa-external-link"></i></span></p>
<p><br></p>
<p>Paul Heinlein, GPG Quick Start <span class="exturl" data-url="aHR0cHM6Ly93d3cubWFkYm9hLmNvbS9nZWVrL2dwZy1xdWlja3N0YXJ0Lw==" title="https://www.madboa.com/geek/gpg-quickstart/">https://www.madboa.com/geek/gpg-quickstart/<i class="fa fa-external-link"></i></span></p>
<p>Ubuntu helpï¼ŒGnuPrivacyGuardHowto <span class="exturl" data-url="aHR0cHM6Ly9oZWxwLnVidW50dS5jb20vY29tbXVuaXR5L0dudVByaXZhY3lHdWFyZEhvd3Rv" title="https://help.ubuntu.com/community/GnuPrivacyGuardHowto">https://help.ubuntu.com/community/GnuPrivacyGuardHowto<i class="fa fa-external-link"></i></span></p>
<p>Alan Eliasen. GPG Tutorial <span class="exturl" data-url="aHR0cHM6Ly9mdXR1cmVib3kudXMvcGdwLmh0bWw=" title="https://futureboy.us/pgp.html">https://futureboy.us/pgp.html<i class="fa fa-external-link"></i></span></p>
<p>GnuPG è¢–ç HOWTO (ä¸­æ–‡ç‰ˆ) <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ251cGcub3JnL2hvd3Rvcy96aC9pbmRleC5odG1s" title="https://www.gnupg.org/howtos/zh/index.html">https://www.gnupg.org/howtos/zh/index.html<i class="fa fa-external-link"></i></span></p>
<p>The GNU Privacy Handbook <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ251cGcub3JnL2dwaC9lbi9tYW51YWwuaHRtbA==" title="https://www.gnupg.org/gph/en/manual.html">https://www.gnupg.org/gph/en/manual.html<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Operating System</category>
      </categories>
      <tags>
        <tag>Security</tag>
        <tag>GPG</tag>
      </tags>
  </entry>
  <entry>
    <title>[Shell]RegEx æ­£åˆ™è¡¨è¾¾å¼</title>
    <url>/2020/02/25/Shell-RegEx/</url>
    <content><![CDATA[<h1 id="æ­£åˆ™è¡¨è¾¾å¼-Regular-Expression"><a href="#æ­£åˆ™è¡¨è¾¾å¼-Regular-Expression" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼ Regular Expression"></a>æ­£åˆ™è¡¨è¾¾å¼ Regular Expression</h1><h2 id="å†å²"><a href="#å†å²" class="headerlink" title="å†å²"></a>å†å²</h2><p>æ­£åˆ™è¡¨è¾¾å¼å‡ºç°äºç†è®ºè®¡ç®—æœºç§‘å­¦çš„è‡ªåŠ¨æ§åˆ¶ç†è®ºå’Œå½¢å¼åŒ–è¯­è¨€ç†è®ºä¸­ã€‚åœ¨è¿™äº›é¢†åŸŸä¸­æœ‰å¯¹è®¡ç®—ï¼ˆè‡ªåŠ¨æ§åˆ¶ï¼‰çš„æ¨¡å‹å’Œå¯¹å½¢å¼åŒ–è¯­è¨€æè¿°ä¸åˆ†ç±»çš„ç ”ç©¶ã€‚<sup><a href="#myfootnote1">1</a></sup><br>å®ƒå¯ä»¥è½¬åŒ–æˆå½¢å¼åŒ–è¯­è¨€æˆ–è€…ç¡®å®šå‹è‡ªåŠ¨æœºã€‚å®ƒä»¬æ˜¯è¯­ä¹‰ä¸Šç­‰ä»·çš„ï¼Œå¯ä»¥æè¿°åŒä¸€ç§è¯­è¨€ã€‚</p>
<p><br></p>
<h2 id="Unix-RegExä»‹ç»"><a href="#Unix-RegExä»‹ç»" class="headerlink" title="Unix RegExä»‹ç»"></a>Unix RegExä»‹ç»</h2><p>è¿™ç¯‡æ–‡ç« åŸºäºã€€<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ppaXNoYW5lZC9sZWFybi1yZWdleA==" title="https://github.com/ziishaned/learn-regex">https://github.com/ziishaned/learn-regex<i class="fa fa-external-link"></i></span><br></p><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">ç‰ˆæƒ: https://github.com/ziishaned/learn-regex</span><br><span class="line">ç‰ˆæƒæ–¹å¼: MIT Â©  </span><br><span class="line">https://github.com/ziishaned/learn-regex/blob/master/LICENSE.md</span><br><span class="line">ä½œè€…: Zeeshan Ahmad, https://twitter.com/ziishaned</span><br></pre></td></tr></tbody></table></figure><p></p>
<a id="more"></a>
<p><br><br></p>
<h2 id="ä»€ä¹ˆæ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ</h2><blockquote>
<p>æ­£åˆ™è¡¨è¾¾å¼æ˜¯ä¸€ç»„ç”±å­—æ¯å’Œç¬¦å·ç»„æˆçš„ç‰¹æ®Šæ–‡æœ¬ï¼Œå®ƒå¯ä»¥ç”¨æ¥ä»æ–‡æœ¬ä¸­æ‰¾å‡ºæ»¡è¶³ä½ æƒ³è¦çš„æ ¼å¼çš„å¥å­ã€‚</p>
</blockquote>
<p>ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ˜¯ä¸€ç§ä»å·¦åˆ°å³åŒ¹é…ä¸»ä½“å­—ç¬¦ä¸²çš„æ¨¡å¼ã€‚<br>â€œRegular expressionâ€å¯è¢«ç¼©å†™ä¸ºâ€œregexâ€æˆ–â€œregexpâ€ã€‚<br>æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥ä»ä¸€ä¸ªåŸºç¡€å­—ç¬¦ä¸²ä¸­æ ¹æ®ä¸€å®šçš„åŒ¹é…æ¨¡å¼æ›¿æ¢æ–‡æœ¬ä¸­çš„å­—ç¬¦ä¸²ã€éªŒè¯è¡¨å•ã€æå–å­—ç¬¦ä¸²ç­‰ç­‰ã€‚</p>
<p>æƒ³è±¡ä½ æ­£åœ¨å†™ä¸€ä¸ªåº”ç”¨ï¼Œç„¶åä½ æƒ³è®¾å®šä¸€ä¸ªç”¨æˆ·å‘½åçš„è§„åˆ™ï¼Œè®©ç”¨æˆ·ååŒ…å«å­—ç¬¦ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼Œä»¥åŠé™åˆ¶å­—ç¬¦çš„ä¸ªæ•°ï¼Œå¥½è®©åå­—çœ‹èµ·æ¥æ²¡é‚£ä¹ˆä¸‘ã€‚<br>æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹æ­£åˆ™è¡¨è¾¾å¼æ¥éªŒè¯ä¸€ä¸ªç”¨æˆ·åï¼š</p>
<p><br><br></p>
<p><img data-src="https://raw.githubusercontent.com/ziishaned/learn-regex/master/img/regexp-cn.png" alt="RegEx"></p>
<p>ä»¥ä¸Šçš„æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥æ¥å— <code>john_doe</code>ã€<code>jo-hn_doe</code>ã€<code>john12_as</code>ã€‚</p>
<p>ä½†ä¸åŒ¹é…<code>Jo</code>ï¼Œå› ä¸ºï¼š</p>
<ul>
<li>å®ƒåŒ…å«äº†å¤§å†™çš„å­—æ¯<code>J</code></li>
<li>é•¿åº¦å°äºï¼“</li>
</ul>
<h2 id="1-åŸºæœ¬åŒ¹é…"><a href="#1-åŸºæœ¬åŒ¹é…" class="headerlink" title="1. åŸºæœ¬åŒ¹é…"></a>1. åŸºæœ¬åŒ¹é…</h2><p>æ­£åˆ™è¡¨è¾¾å¼å…¶å®å°±æ˜¯åœ¨æ‰§è¡Œæœç´¢æ—¶çš„æ ¼å¼ï¼Œå®ƒç”±ä¸€äº›å­—æ¯å’Œæ•°å­—ç»„åˆè€Œæˆã€‚<br>ä¾‹å¦‚ï¼šä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ <code>the</code>ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªè§„åˆ™ï¼šç”±å­—æ¯<code>t</code>å¼€å§‹ï¼Œæ¥ç€æ˜¯<code>h</code>ï¼Œå†æ¥ç€æ˜¯<code>e</code>ã€‚</p>
<pre>"the" =&gt; The fat cat sat on <a href="#learn-regex"><strong>the</strong></a> mat.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9kbVJ5Z1QvMQ==" title="https://regex101.com/r/dmRygT/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<p>æ­£åˆ™è¡¨è¾¾å¼<code>123</code>åŒ¹é…å­—ç¬¦ä¸²<code>123</code>ã€‚å®ƒé€ä¸ªå­—ç¬¦çš„ä¸è¾“å…¥çš„æ­£åˆ™è¡¨è¾¾å¼åšæ¯”è¾ƒã€‚</p>
<p>æ­£åˆ™è¡¨è¾¾å¼æ˜¯<strong>å¤§å°å†™æ•æ„Ÿ</strong>çš„ï¼Œæ‰€ä»¥<code>The</code>ä¸ä¼šåŒ¹é…<code>the</code>ã€‚</p>
<pre>"The" =&gt; <a href="#learn-regex"><strong>The</strong></a> fat cat sat on the mat.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci8xcGFYc3kvMQ==" title="https://regex101.com/r/1paXsy/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="2-å…ƒå­—ç¬¦-Meta-Characters"><a href="#2-å…ƒå­—ç¬¦-Meta-Characters" class="headerlink" title="2. å…ƒå­—ç¬¦ Meta Characters"></a>2. å…ƒå­—ç¬¦ Meta Characters</h2><p>æ­£åˆ™è¡¨è¾¾å¼ä¸»è¦ä¾èµ–äºå…ƒå­—ç¬¦ã€‚<br>å…ƒå­—ç¬¦ä¸ä»£è¡¨ä»–ä»¬æœ¬èº«çš„å­—é¢æ„æ€ï¼Œä»–ä»¬éƒ½æœ‰ç‰¹æ®Šçš„å«ä¹‰ã€‚ä¸€äº›å…ƒå­—ç¬¦å†™åœ¨æ–¹æ‹¬å·ä¸­çš„æ—¶å€™æœ‰ä¸€äº›ç‰¹æ®Šçš„æ„æ€ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å…ƒå­—ç¬¦çš„ä»‹ç»ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">å…ƒå­—ç¬¦</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">.</td>
<td>å¥å·åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦é™¤äº†æ¢è¡Œç¬¦ã€‚</td>
</tr>
<tr>
<td style="text-align:center">[ ]</td>
<td>å­—ç¬¦ç§ç±»ã€‚åŒ¹é…æ–¹æ‹¬å·å†…çš„ä»»æ„å­—ç¬¦ã€‚</td>
</tr>
<tr>
<td style="text-align:center"><sup><a href="#fn_ " id="reffn_ "> </a></sup></td>
<td>å¦å®šçš„å­—ç¬¦ç§ç±»ã€‚åŒ¹é…é™¤äº†æ–¹æ‹¬å·é‡Œçš„ä»»æ„å­—ç¬¦</td>
</tr>
<tr>
<td style="text-align:center">*</td>
<td>åŒ¹é…&gt;=0ä¸ªé‡å¤çš„åœ¨*å·ä¹‹å‰çš„å­—ç¬¦ã€‚</td>
</tr>
<tr>
<td style="text-align:center">+</td>
<td>åŒ¹é…&gt;=1ä¸ªé‡å¤çš„+å·å‰çš„å­—ç¬¦ã€‚</td>
</tr>
<tr>
<td style="text-align:center">?</td>
<td>æ ‡è®°?ä¹‹å‰çš„å­—ç¬¦ä¸ºå¯é€‰.</td>
</tr>
<tr>
<td style="text-align:center">{n}</td>
<td>åŒ¹é…nä¸ªå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦.</td>
</tr>
<tr>
<td style="text-align:center">{n,m}</td>
<td>åŒ¹é…numä¸ªå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ (n &lt;= num &lt;= m).</td>
</tr>
<tr>
<td style="text-align:center">{n,}</td>
<td>åŒ¹é…numä¸ªå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ (n &lt;= num).</td>
</tr>
<tr>
<td style="text-align:center">(xyz)</td>
<td>å­—ç¬¦é›†ï¼ŒåŒ¹é…ä¸ xyz å®Œå…¨ç›¸ç­‰çš„å­—ç¬¦ä¸².</td>
</tr>
<tr>
<td style="text-align:center">|</td>
<td>æˆ–è¿ç®—ç¬¦ï¼ŒåŒ¹é…ç¬¦å·å‰æˆ–åçš„å­—ç¬¦.</td>
</tr>
<tr>
<td style="text-align:center">\</td>
<td>è½¬ä¹‰å­—ç¬¦,ç”¨äºåŒ¹é…ä¸€äº›ä¿ç•™çš„å­—ç¬¦ <code>[ ] ( ) { } . * + ? ^ $ \ |</code></td>
</tr>
<tr>
<td style="text-align:center">^</td>
<td>ä»å¼€å§‹è¡Œå¼€å§‹åŒ¹é….</td>
</tr>
<tr>
<td style="text-align:center">$</td>
<td>ä»æœ«ç«¯å¼€å§‹åŒ¹é….</td>
</tr>
</tbody>
</table>
</div>
<h2 id="2-1-ç‚¹è¿ç®—ç¬¦-Full-stop"><a href="#2-1-ç‚¹è¿ç®—ç¬¦-Full-stop" class="headerlink" title="2.1 ç‚¹è¿ç®—ç¬¦ . Full stop"></a>2.1 ç‚¹è¿ç®—ç¬¦ <code>.</code> Full stop</h2><p><strong><code>.</code>åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦ï¼Œä½†ä¸åŒ¹é…æ¢è¡Œç¬¦ã€‚</strong><br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼<code>.ar</code>åŒ¹é…ä¸€ä¸ªä»»æ„å­—ç¬¦åé¢è·Ÿç€æ˜¯<code>a</code>å’Œ<code>r</code>çš„å­—ç¬¦ä¸²ã€‚</p>
<pre>".ar" =&gt; The <a href="#learn-regex"><strong>car</strong></a> <a href="#learn-regex"><strong>par</strong></a>ked in the <a href="#learn-regex"><strong>gar</strong></a>age.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci94YzlHa1UvMQ==" title="https://regex101.com/r/xc9GkU/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="2-2-å­—ç¬¦é›†-Character-set"><a href="#2-2-å­—ç¬¦é›†-Character-set" class="headerlink" title="2.2 å­—ç¬¦é›† Character set"></a>2.2 å­—ç¬¦é›† Character set</h2><p>å­—ç¬¦é›†ä¹Ÿå«åšå­—ç¬¦ç±»ã€‚<br>æ–¹æ‹¬å·ç”¨æ¥æŒ‡å®šä¸€ä¸ªå­—ç¬¦é›†ã€‚<br>åœ¨æ–¹æ‹¬å·ä¸­ä½¿ç”¨è¿å­—ç¬¦æ¥æŒ‡å®šå­—ç¬¦é›†çš„èŒƒå›´ã€‚<br>åœ¨æ–¹æ‹¬å·ä¸­çš„å­—ç¬¦é›†ä¸å…³å¿ƒé¡ºåºã€‚<br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼<code>[Tt]he</code> åŒ¹é… <code>the</code> å’Œ <code>The</code>ã€‚</p>
<pre>"[Tt]he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car parked in <a href="#learn-regex"><strong>the</strong></a> garage.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci8ySVRMUTQvMQ==" title="https://regex101.com/r/2ITLQ4/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<p><strong>æ–¹æ‹¬å·çš„å¥å·å°±è¡¨ç¤ºå¥å·, è€Œä¸æ˜¯ç‚¹è¿ç®—ç¬¦ã€‚</strong><br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>ar[.]</code> åŒ¹é… <code>ar.</code>å­—ç¬¦ä¸²</p>
<pre>"ar[.]" =&gt; A garage is a good place to park a c<a href="#learn-regex"><strong>ar.</strong></a>
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci93TDN4dEUvMQ==" title="https://regex101.com/r/wL3xtE/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="2-2-1-å¦å®šå­—ç¬¦é›†-Negated-character-set"><a href="#2-2-1-å¦å®šå­—ç¬¦é›†-Negated-character-set" class="headerlink" title="2.2.1 å¦å®šå­—ç¬¦é›† Negated character set"></a>2.2.1 å¦å®šå­—ç¬¦é›† Negated character set</h3><p>ä¸€èˆ¬æ¥è¯´ <code>^</code> è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²çš„å¼€å¤´ï¼Œä½†å®ƒç”¨åœ¨ä¸€ä¸ªæ–¹æ‹¬å·çš„å¼€å¤´çš„æ—¶å€™ï¼Œå®ƒè¡¨ç¤ºè¿™ä¸ªå­—ç¬¦é›†æ˜¯å¦å®šçš„ã€‚<br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼<code>[^c]ar</code> åŒ¹é…ä¸€ä¸ªåé¢è·Ÿç€<code>ar</code>çš„é™¤äº†<code>c</code>çš„ä»»æ„å­—ç¬¦ã€‚</p>
<pre>"[^c]ar" =&gt; The car <a href="#learn-regex"><strong>par</strong></a>ked in the <a href="#learn-regex"><strong>gar</strong></a>age.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9uTk5scTMvMQ==" title="https://regex101.com/r/nNNlq3/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="2-3-é‡å¤æ¬¡æ•°-Repetitions"><a href="#2-3-é‡å¤æ¬¡æ•°-Repetitions" class="headerlink" title="2.3 é‡å¤æ¬¡æ•° Repetitions"></a>2.3 é‡å¤æ¬¡æ•° Repetitions</h2><p>åé¢è·Ÿç€å…ƒå­—ç¬¦ <code>+</code>ï¼Œ<code>*</code> or <code>?</code> çš„ï¼Œç”¨æ¥æŒ‡å®šåŒ¹é…å­æ¨¡å¼çš„æ¬¡æ•°ã€‚<br>è¿™äº›å…ƒå­—ç¬¦åœ¨ä¸åŒçš„æƒ…å†µä¸‹æœ‰ç€ä¸åŒçš„æ„æ€ã€‚</p>
<h3 id="2-3-1-å·-The-Star"><a href="#2-3-1-å·-The-Star" class="headerlink" title="2.3.1 * å· The Star"></a>2.3.1 <code>*</code> å· The Star</h3><p><code>*</code>å·åŒ¹é… åœ¨<code>*</code>ä¹‹å‰çš„å­—ç¬¦å‡ºç°<code>å¤§äºç­‰äº0</code>æ¬¡ã€‚<br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>a*</code> åŒ¹é…0æˆ–æ›´å¤šä¸ªä»¥aå¼€å¤´çš„å­—ç¬¦ã€‚è¡¨è¾¾å¼<code>[a-z]*</code> åŒ¹é…ä¸€ä¸ªè¡Œä¸­æ‰€æœ‰ä»¥å°å†™å­—æ¯å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚ä¸‹é¢ä¾‹å­ä¸­æ˜¯ä»<code>he</code>åˆ°<code>garage</code>éƒ½è¢«åŒ¹é…ï¼Œ<strong>ä¸åŒ…æ‹¬å…¶ä¸­çš„ç©ºæ ¼</strong>ã€‚</p>
<pre>"[a-z]*" =&gt; T<a href="#learn-regex"><strong>he</strong></a> <a href="#learn-regex"><strong>car</strong></a> <a href="#learn-regex"><strong>parked</strong></a> <a href="#learn-regex"><strong>in</strong></a> <a href="#learn-regex"><strong>the</strong></a> <a href="#learn-regex"><strong>garage</strong></a> #21.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci83bThtZTUvMQ==" title="https://regex101.com/r/7m8me5/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<p><code>*</code>å­—ç¬¦å’Œ<code>.</code>å­—ç¬¦æ­é…å¯ä»¥åŒ¹é…æ‰€æœ‰çš„å­—ç¬¦<code>.*</code>ã€‚</p>
<p><code>*</code>å’Œè¡¨ç¤º<strong>åŒ¹é…ç©ºæ ¼çš„ç¬¦å·<code>\s</code></strong>è¿èµ·æ¥ç”¨ï¼Œå¦‚è¡¨è¾¾å¼<code>\s*cat\s*</code>åŒ¹é…<strong>0æˆ–æ›´å¤šä¸ªç©ºæ ¼å¼€å¤´å’Œ0æˆ–æ›´å¤šä¸ªç©ºæ ¼ç»“å°¾çš„catå­—ç¬¦ä¸²</strong>ã€‚ä¸‹é¢ä¾‹å­ä¸­æ˜¯ä»<code>\scat\s</code>åˆ°<code>cat</code>éƒ½è¢«åŒ¹é…ã€‚</p>
<pre>"\s*cat\s*" =&gt; The fat<a href="#learn-regex"><strong> cat </strong></a>sat on the con<a href="#learn-regex"><strong>cat</strong></a>enation.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9nR3J3dXovMQ==" title="https://regex101.com/r/gGrwuz/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="2-3-2-å·-The-Plus"><a href="#2-3-2-å·-The-Plus" class="headerlink" title="2.3.2 + å· The Plus"></a>2.3.2 <code>+</code> å· The Plus</h3><p><code>+</code>å·åŒ¹é…<code>+</code>å·ä¹‹å‰çš„å­—ç¬¦å‡ºç° &gt;=1 æ¬¡ã€‚<br>ä¾‹å¦‚è¡¨è¾¾å¼<code>c.+t</code> åŒ¹é…ä»¥é¦–å­—æ¯<code>c</code>å¼€å¤´ä»¥<code>t</code>ç»“å°¾ï¼Œä¸­é—´è·Ÿç€è‡³å°‘ä¸€ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚ä¸‹é¢ä¾‹å­ä¸­æ˜¯ä»<code>cat\s</code>åˆ°<code>\smat</code>éƒ½è¢«åŒ¹é…ï¼Œ<strong>åŒ…æ‹¬å…¶ä¸­çš„ç©ºæ ¼</strong>ã€‚</p>
<pre>"c.+t" =&gt; The fat <a href="#learn-regex"><strong>cat sat on the mat</strong></a>.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9EemY5QWEvMQ==" title="https://regex101.com/r/Dzf9Aa/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="2-3-3-å·-The-Question-Mark"><a href="#2-3-3-å·-The-Question-Mark" class="headerlink" title="2.3.3 ? å· The Question Mark"></a>2.3.3 <code>?</code> å· The Question Mark</h3><p>åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­å…ƒå­—ç¬¦ <code>?</code> æ ‡è®°åœ¨ç¬¦å·å‰é¢çš„å­—ç¬¦ä¸ºå¯é€‰ï¼Œå³å‡ºç° 0 æˆ– 1 æ¬¡ã€‚<br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>[T]?he</code> åŒ¹é…å­—ç¬¦ä¸² <code>he</code> å’Œ <code>The</code>ã€‚</p>
<pre>"[T]he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car is parked in the garage.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9jSWc5em0vMQ==" title="https://regex101.com/r/cIg9zm/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<pre>"[T]?he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car is parked in t<a href="#learn-regex"><strong>he</strong></a> garage.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9rUHBPMngvMQ==" title="https://regex101.com/r/kPpO2x/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<p>ä¹Ÿç­‰ä»·äºï¼š</p>
<pre>"T?he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car is parked in t<a href="#learn-regex"><strong>he</strong></a> garage.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9rUHBPMngvMjk=" title="https://regex101.com/r/kPpO2x/29">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="2-4-å·-Braces"><a href="#2-4-å·-Braces" class="headerlink" title="2.4 {} å· Braces"></a>2.4 <code>{}</code> å· Braces</h2><p>åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ <code>{}</code> æ˜¯ä¸€ä¸ªé‡è¯ï¼Œå¸¸ç”¨æ¥ä¸€ä¸ªæˆ–ä¸€ç»„å­—ç¬¦å¯ä»¥é‡å¤å‡ºç°çš„æ¬¡æ•°ã€‚<br>ä¾‹å¦‚ï¼Œ è¡¨è¾¾å¼ <code>[0-9]{2,3}</code> åŒ¹é…æœ€å°‘ 2 ä½æœ€å¤š 3 ä½ 0~9 çš„æ•°å­—ã€‚</p>
<pre>"[0-9]{2,3}" =&gt; The number was 9.<a href="#learn-regex"><strong>999</strong></a>7 but we rounded it off to <a href="#learn-regex"><strong>10</strong></a>.0.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9qdU04NnMvMQ==" title="https://regex101.com/r/juM86s/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<p>æˆ‘ä»¬å¯ä»¥çœç•¥ç¬¬äºŒä¸ªå‚æ•°ã€‚<br>ä¾‹å¦‚ï¼Œ<code>[0-9]{2,}</code> åŒ¹é…è‡³å°‘ä¸¤ä½ 0~9 çš„æ•°å­—ã€‚</p>
<pre>"[0-9]{2,}" =&gt; The number was 9.<a href="#learn-regex"><strong>9997</strong></a> but we rounded it off to <a href="#learn-regex"><strong>10</strong></a>.0.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9HZHk0dzUvMQ==" title="https://regex101.com/r/Gdy4w5/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<p>å¦‚æœé€—å·ä¹Ÿçœç•¥æ‰åˆ™è¡¨ç¤ºé‡å¤å›ºå®šçš„æ¬¡æ•°ã€‚<br>ä¾‹å¦‚ï¼Œ<code>[0-9]{3}</code> åŒ¹é…3ä½æ•°å­—</p>
<pre>"[0-9]{3}" =&gt; The number was 9.<a href="#learn-regex"><strong>999</strong></a>7 but we rounded it off to 10.0.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9TaXZ1MzAvMQ==" title="https://regex101.com/r/Sivu30/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="2-5-æ•è·ç»„-ç‰¹å¾æ ‡ç¾¤-Capturing-Group"><a href="#2-5-æ•è·ç»„-ç‰¹å¾æ ‡ç¾¤-Capturing-Group" class="headerlink" title="2.5 (...) æ•è·ç»„ ç‰¹å¾æ ‡ç¾¤ Capturing Group"></a>2.5 <code>(...)</code> æ•è·ç»„ ç‰¹å¾æ ‡ç¾¤ Capturing Group</h2><p>ç‰¹å¾æ ‡ç¾¤æ˜¯ä¸€ç»„å†™åœ¨ <code>(...)</code> ä¸­çš„å­æ¨¡å¼ã€‚ä¾‹å¦‚ä¹‹å‰è¯´çš„ <code>{}</code> æ˜¯ç”¨æ¥è¡¨ç¤ºå‰é¢ä¸€ä¸ªå­—ç¬¦å‡ºç°æŒ‡å®šæ¬¡æ•°ã€‚ä½†å¦‚æœåœ¨ <code>{}</code> å‰åŠ å…¥ç‰¹å¾æ ‡ç¾¤åˆ™è¡¨ç¤ºæ•´ä¸ªæ ‡ç¾¤å†…çš„å­—ç¬¦é‡å¤ N æ¬¡ã€‚ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>(ab)*</code> åŒ¹é…è¿ç»­å‡ºç° 0 æˆ–æ›´å¤šä¸ª <code>ab</code>ã€‚</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ <code>()</code> ä¸­ç”¨æˆ–å­—ç¬¦ <code>|</code> è¡¨ç¤ºæˆ–ã€‚ä¾‹å¦‚ï¼Œ<code>(c|g|p)ar</code> åŒ¹é… <code>car</code> æˆ– <code>gar</code> æˆ– <code>par</code>.</p>
<pre>"(c|g|p)ar" =&gt; The <a href="#learn-regex"><strong>car</strong></a> is <a href="#learn-regex"><strong>par</strong></a>ked in the <a href="#learn-regex"><strong>gar</strong></a>age.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci90VXhyQkcvMQ==" title="https://regex101.com/r/tUxrBG/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<p>æˆ‘ä»¬éœ€è¦æ³¨æ„ç‰¹å¾æ ‡ç¾¤ä¸ä»…å¯ä»¥åŒ¹é…ï¼Œè€Œå·²å¯ä»¥æ•è·æºç¼–ç¨‹è¯­è¨€çš„å­—ç¬¦ã€‚æºç¼–ç¨‹è¯­è¨€ (the parent language)å¯ä»¥æ˜¯Pythonï¼ŒJavascriptæˆ–è€…ä»»æ„å…¶ä»–å®ç°äº†æ­£åˆ™è¡¨è¾¾å¼çš„ç¼–ç¨‹è¯­è¨€ã€‚</p>
<h3 id="2-5-1-éç‰¹å¾æ ‡ç¾¤-éæ•è·ç»„-Non-capturing-group"><a href="#2-5-1-éç‰¹å¾æ ‡ç¾¤-éæ•è·ç»„-Non-capturing-group" class="headerlink" title="2.5.1 éç‰¹å¾æ ‡ç¾¤ éæ•è·ç»„ Non capturing group"></a>2.5.1 éç‰¹å¾æ ‡ç¾¤ éæ•è·ç»„ Non capturing group</h3><p>éæ•è·ç»„æ˜¯ä¸€ä¸ªä»…ä»…åŒ¹é…å­—ç¬¦çš„æ•è·ç»„ï¼Œä½†æ˜¯å®ƒä¸æ•è·ä»»æ„ç»„ã€‚éæ•è·ç»„å¯ä»¥ç”±è¢«<code>:</code>è·Ÿç€çš„<code>?</code>æ‰€è¡¨ç¤ºï¼Œæ•´ä¸ªè¡¨è¾¾è¢«<code>(...)</code>å›Šæ‹¬ã€‚ä¾‹å¦‚ï¼Œæ­£åˆ™è¡¨è¾¾å¼<code>(?:c|g|p)ar</code>ä¸<code>(c|g|p)ar</code>ç›¸ä¼¼ï¼Œå®ƒä»¬åŒ¹é…ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯å‰è€…å¹¶ä¸ä¼šæ•è·ä»»æ„ä¸€ä¸ªç»„ã€‚</p>
<pre>"(?:c|g|p)ar" =&gt; The <a href="#learn-regex"><strong>car</strong></a> is <a href="#learn-regex"><strong>par</strong></a>ked in the <a href="#learn-regex"><strong>gar</strong></a>age.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9SbTdNZTgvMQ==" title="https://regex101.com/r/Rm7Me8/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<p>éæ•è·ç»„åœ¨â€œæŸ¥æ‰¾å’Œæ›¿æ¢â€çš„æƒ…å†µ(find-and-replace functionality)ä¸‹ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚<br>å¦å¤–ï¼Œå¦‚æœéæ•è·ç»„å’Œæ•è·ç»„è¢«æ··åˆçš„æ—¶å€™ï¼Œéæ•è·ç»„å¯ä»¥å¸®åŠ©æˆ‘ä»¬å»å¾—åˆ°ä¸€ä¸ªåŒ¹é…çš„æ¦‚å†µã€‚<br>å¦è¯·å‚é˜…<a href="#4-é›¶å®½åº¦æ–­è¨€">4. é›¶å®½åº¦æ–­è¨€</a>ã€‚</p>
<h2 id="2-6-æˆ–è¿ç®—ç¬¦-Alternation"><a href="#2-6-æˆ–è¿ç®—ç¬¦-Alternation" class="headerlink" title="2.6 | æˆ–è¿ç®—ç¬¦ Alternation"></a>2.6 <code>|</code> æˆ–è¿ç®—ç¬¦ Alternation</h2><p>æˆ–è¿ç®—ç¬¦å°±è¡¨ç¤ºæˆ–ï¼Œç”¨ä½œåˆ¤æ–­æ¡ä»¶ã€‚</p>
<p>ä¾‹å¦‚ <code>(T|t)he|car</code> åŒ¹é… <code>(T|t)he</code> æˆ– <code>car</code>ã€‚</p>
<pre>"(T|t)he|car" =&gt; <a href="#learn-regex"><strong>The</strong></a> <a href="#learn-regex"><strong>car</strong></a> is parked in <a href="#learn-regex"><strong>the</strong></a> garage.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9mQlh5WDAvMQ==" title="https://regex101.com/r/fBXyX0/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="2-7-è½¬ç ç‰¹æ®Šå­—ç¬¦-Escaping-special-character"><a href="#2-7-è½¬ç ç‰¹æ®Šå­—ç¬¦-Escaping-special-character" class="headerlink" title="2.7 è½¬ç ç‰¹æ®Šå­—ç¬¦ Escaping special character"></a>2.7 è½¬ç ç‰¹æ®Šå­—ç¬¦ Escaping special character</h2><p>åæ–œçº¿ <code>\</code> åœ¨è¡¨è¾¾å¼ä¸­ç”¨äºè½¬ç ç´§è·Ÿå…¶åçš„å­—ç¬¦ã€‚ç”¨äºæŒ‡å®š <code>{ } [ ] / \ + * . $ ^ | ?</code> è¿™äº›ç‰¹æ®Šå­—ç¬¦ã€‚å¦‚æœæƒ³è¦åŒ¹é…è¿™äº›ç‰¹æ®Šå­—ç¬¦åˆ™è¦åœ¨å…¶å‰é¢åŠ ä¸Šåæ–œçº¿ <code>\</code>ã€‚</p>
<p>ä¾‹å¦‚ <code>.</code> æ˜¯ç”¨æ¥åŒ¹é…é™¤æ¢è¡Œç¬¦å¤–çš„æ‰€æœ‰å­—ç¬¦çš„ã€‚å¦‚æœæƒ³è¦åŒ¹é…å¥å­ä¸­çš„ <code>.</code> åˆ™è¦å†™æˆ <code>\.</code> ä»¥ä¸‹è¿™ä¸ªä¾‹å­ <code>\.?</code>æ˜¯é€‰æ‹©æ€§åŒ¹é…<code>.</code></p>
<pre>"(f|c|m)at\.?" =&gt; The <a href="#learn-regex"><strong>fat</strong></a> <a href="#learn-regex"><strong>cat</strong></a> sat on the <a href="#learn-regex"><strong>mat.</strong></a>
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9ET2M1TnUvMQ==" title="https://regex101.com/r/DOc5Nu/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="2-8-é”šç‚¹-Anchors"><a href="#2-8-é”šç‚¹-Anchors" class="headerlink" title="2.8 é”šç‚¹ Anchors"></a>2.8 é”šç‚¹ Anchors</h2><p>åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œæƒ³è¦åŒ¹é…æŒ‡å®šå¼€å¤´æˆ–ç»“å°¾çš„å­—ç¬¦ä¸²å°±è¦ä½¿ç”¨åˆ°é”šç‚¹ã€‚<strong><code>^</code> æŒ‡å®šå¼€å¤´ï¼Œ<code>$</code> æŒ‡å®šç»“å°¾ã€‚</strong></p>
<h3 id="2-8-1-å·-Caret"><a href="#2-8-1-å·-Caret" class="headerlink" title="2.8.1 ^ å· Caret"></a>2.8.1 <code>^</code> å· Caret</h3><p><code>^</code> ç”¨æ¥æ£€æŸ¥åŒ¹é…çš„å­—ç¬¦ä¸²æ˜¯å¦åœ¨æ‰€åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å¤´ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ <code>abc</code> ä¸­ä½¿ç”¨è¡¨è¾¾å¼ <code>^a</code> ä¼šå¾—åˆ°ç»“æœ <code>a</code>ã€‚ä½†å¦‚æœä½¿ç”¨ <code>^b</code> å°†åŒ¹é…ä¸åˆ°ä»»ä½•ç»“æœã€‚å› ä¸ºåœ¨å­—ç¬¦ä¸² <code>abc</code> ä¸­å¹¶ä¸æ˜¯ä»¥ <code>b</code> å¼€å¤´ã€‚</p>
<p>ä¾‹å¦‚ï¼Œ<code>^(T|t)he</code> åŒ¹é…ä»¥ <code>The</code> æˆ– <code>the</code> å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚</p>
<pre>"(T|t)he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car is parked in <a href="#learn-regex"><strong>the</strong></a> garage.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci81bGpqZ0IvMQ==" title="https://regex101.com/r/5ljjgB/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<pre>"^(T|t)he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car is parked in the garage.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9qWHJLbmUvMQ==" title="https://regex101.com/r/jXrKne/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="2-8-2-å·-Dollar"><a href="#2-8-2-å·-Dollar" class="headerlink" title="2.8.2 $ å· Dollar"></a>2.8.2 <code>$</code> å· Dollar</h3><p>åŒç†äº <code>^</code> å·ï¼Œ<code>$</code> å·ç”¨æ¥åŒ¹é…å­—ç¬¦æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªã€‚</p>
<p>ä¾‹å¦‚ï¼Œ<code>(at\.)$</code> åŒ¹é…ä»¥ <code>at.</code> ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</p>
<pre>"(at\.)" =&gt; The fat c<a href="#learn-regex"><strong>at.</strong></a> s<a href="#learn-regex"><strong>at.</strong></a> on the m<a href="#learn-regex"><strong>at.</strong></a>
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci95NEF1NEQvMQ==" title="https://regex101.com/r/y4Au4D/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<pre>"(at\.)$" =&gt; The fat cat. sat. on the m<a href="#learn-regex"><strong>at.</strong></a>
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci90MEFrT2QvMQ==" title="https://regex101.com/r/t0AkOd/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="3-ç®€å†™å­—ç¬¦é›†-Shorthand-Character-Sets"><a href="#3-ç®€å†™å­—ç¬¦é›†-Shorthand-Character-Sets" class="headerlink" title="3. ç®€å†™å­—ç¬¦é›† Shorthand Character Sets"></a>3. ç®€å†™å­—ç¬¦é›† Shorthand Character Sets</h2><p>æ­£åˆ™è¡¨è¾¾å¼æä¾›ä¸€äº›å¸¸ç”¨çš„å­—ç¬¦é›†ç®€å†™ã€‚å¦‚ä¸‹:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">ç®€å†™</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">.</td>
<td>é™¤æ¢è¡Œç¬¦å¤–çš„æ‰€æœ‰å­—ç¬¦</td>
</tr>
<tr>
<td style="text-align:center">\w</td>
<td>åŒ¹é…æ‰€æœ‰å­—æ¯æ•°å­—ï¼Œç­‰åŒäº <code>[a-zA-Z0-9_]</code></td>
</tr>
<tr>
<td style="text-align:center">\W</td>
<td>åŒ¹é…æ‰€æœ‰éå­—æ¯æ•°å­—ï¼Œå³ç¬¦å·ï¼Œç­‰åŒäºï¼š <code>[^\w]</code></td>
</tr>
<tr>
<td style="text-align:center">\d</td>
<td>åŒ¹é…æ•°å­—ï¼š <code>[0-9]</code></td>
</tr>
<tr>
<td style="text-align:center">\D</td>
<td>åŒ¹é…éæ•°å­—ï¼š <code>[^\d]</code></td>
</tr>
<tr>
<td style="text-align:center">\s</td>
<td>åŒ¹é…æ‰€æœ‰ç©ºæ ¼å­—ç¬¦ï¼Œç­‰åŒäºï¼š <code>[\t\n\f\r\p{Z}]</code></td>
</tr>
<tr>
<td style="text-align:center">\S</td>
<td>åŒ¹é…æ‰€æœ‰éç©ºæ ¼å­—ç¬¦ï¼š <code>[^\s]</code></td>
</tr>
<tr>
<td style="text-align:center">\f</td>
<td>åŒ¹é…ä¸€ä¸ªæ¢é¡µç¬¦</td>
</tr>
<tr>
<td style="text-align:center">\n</td>
<td>åŒ¹é…ä¸€ä¸ªæ¢è¡Œç¬¦</td>
</tr>
<tr>
<td style="text-align:center">\r</td>
<td>åŒ¹é…ä¸€ä¸ªå›è½¦ç¬¦</td>
</tr>
<tr>
<td style="text-align:center">\t</td>
<td>åŒ¹é…ä¸€ä¸ªåˆ¶è¡¨ç¬¦</td>
</tr>
<tr>
<td style="text-align:center">\v</td>
<td>åŒ¹é…ä¸€ä¸ªå‚ç›´åˆ¶è¡¨ç¬¦</td>
</tr>
<tr>
<td style="text-align:center">\p</td>
<td>åŒ¹é… CR/LFï¼ˆç­‰åŒäº <code>\r\n</code>ï¼‰ï¼Œç”¨æ¥åŒ¹é… DOS è¡Œç»ˆæ­¢ç¬¦</td>
</tr>
<tr>
<td style="text-align:center">\b</td>
<td>åŒ¹é…ä¸€ä¸ªè¯çš„è¾¹ç•Œï¼Œä¸ä¼šæ¶ˆè€—ä»»ä½•å­—ç¬¦åªåŒ¹é…ä¸€ä¸ªä½ç½®</td>
</tr>
<tr>
<td style="text-align:center">\B</td>
<td>åŒ¹é…ä¸æ˜¯å•è¯å¼€å¤´æˆ–ç»“æŸçš„ä½ç½®</td>
</tr>
</tbody>
</table>
</div>
<p>å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œå¤§å†™å­—æ¯å¾€å¾€æ˜¯å°å†™å­—æ¯çš„åä¹‰ã€‚</p>
<p><code>\b</code>: <span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci90MEFrT2QvMzM=" title="https://regex101.com/r/t0AkOd/33">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<p>åŒ¹é…æœ‰abcå¼€å¤´çš„å­—ç¬¦ä¸²ï¼šã€€<code>\babc</code>æˆ–è€…<code>^abc</code></p>
<h2 id="4-é›¶å®½åº¦æ–­è¨€ï¼ˆå‰åé¢„æŸ¥ï¼‰-Lookaround"><a href="#4-é›¶å®½åº¦æ–­è¨€ï¼ˆå‰åé¢„æŸ¥ï¼‰-Lookaround" class="headerlink" title="4. é›¶å®½åº¦æ–­è¨€ï¼ˆå‰åé¢„æŸ¥ï¼‰ Lookaround"></a>4. é›¶å®½åº¦æ–­è¨€ï¼ˆå‰åé¢„æŸ¥ï¼‰ Lookaround</h2><p>å…ˆè¡Œæ–­è¨€å’Œåå‘æ–­è¨€éƒ½å±äº<strong>éæ•è·ç°‡ non-capturing groups</strong>ï¼ˆä¸æ•è·æ–‡æœ¬ ï¼Œä¹Ÿä¸é’ˆå¯¹ç»„åˆè®¡è¿›è¡Œè®¡æ•°ï¼‰ã€‚<br>å…ˆè¡Œæ–­è¨€ç”¨äºåˆ¤æ–­æ‰€åŒ¹é…çš„æ ¼å¼æ˜¯å¦åœ¨å¦ä¸€ä¸ªç¡®å®šçš„æ ¼å¼ä¹‹å‰ï¼ŒåŒ¹é…ç»“æœä¸åŒ…å«è¯¥ç¡®å®šæ ¼å¼ï¼ˆä»…ä½œä¸ºçº¦æŸï¼‰ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³è¦è·å¾—æ‰€æœ‰è·Ÿåœ¨ <code>$</code> ç¬¦å·åçš„æ•°å­—ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­£åå‘æ–­è¨€ <code>(?&lt;=\$)[0-9\.]*</code>ã€‚<br>è¿™ä¸ªè¡¨è¾¾å¼åŒ¹é… <code>$</code> å¼€å¤´ï¼Œä¹‹åè·Ÿç€ <code>0,1,2,3,4,5,6,7,8,9,.</code> è¿™äº›å­—ç¬¦å¯ä»¥å‡ºç°å¤§äºç­‰äº 0 æ¬¡ã€‚</p>
<p>é›¶å®½åº¦æ–­è¨€å¦‚ä¸‹ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">ç¬¦å·</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">?=</td>
<td>æ­£å…ˆè¡Œæ–­è¨€-å­˜åœ¨ Positive Lookahead</td>
</tr>
<tr>
<td style="text-align:center">?!</td>
<td>è´Ÿå…ˆè¡Œæ–­è¨€-æ’é™¤ Negative Lookahead</td>
</tr>
<tr>
<td style="text-align:center">?&lt;=</td>
<td>æ­£åå‘æ–­è¨€-å­˜åœ¨ Positive Lookbehind</td>
</tr>
<tr>
<td style="text-align:center">?&lt;!</td>
<td>è´Ÿåå‘æ–­è¨€-æ’é™¤ Negative Lookbehind</td>
</tr>
</tbody>
</table>
</div>
<p>æ›´å¤šä¾‹å­ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzQ4MjE5NDAxL2Fuc3dlci83NDI0NDQzMjY=" title="https://www.zhihu.com/question/48219401/answer/742444326">https://www.zhihu.com/question/48219401/answer/742444326<i class="fa fa-external-link"></i></span></p>
<h3 id="4-1-æ­£å…ˆè¡Œæ–­è¨€-Positive-Lookahead"><a href="#4-1-æ­£å…ˆè¡Œæ–­è¨€-Positive-Lookahead" class="headerlink" title="4.1 ?=... æ­£å…ˆè¡Œæ–­è¨€ Positive Lookahead"></a>4.1 <code>?=...</code> æ­£å…ˆè¡Œæ–­è¨€ Positive Lookahead</h3><p><code>?=...</code> æ­£å…ˆè¡Œæ–­è¨€ï¼Œè¡¨ç¤ºç¬¬ä¸€éƒ¨åˆ†è¡¨è¾¾å¼ä¹‹åå¿…é¡»è·Ÿç€ <code>?=...</code>å®šä¹‰çš„è¡¨è¾¾å¼ã€‚</p>
<p>è¿”å›ç»“æœåªåŒ…å«æ»¡è¶³åŒ¹é…æ¡ä»¶çš„ç¬¬ä¸€éƒ¨åˆ†è¡¨è¾¾å¼ã€‚<br>å®šä¹‰ä¸€ä¸ªæ­£å…ˆè¡Œæ–­è¨€è¦ä½¿ç”¨ <code>()</code>ã€‚åœ¨æ‹¬å·å†…éƒ¨ä½¿ç”¨ä¸€ä¸ªé—®å·å’Œç­‰å·ï¼š <code>(?=...)</code>ã€‚</p>
<p>æ­£å…ˆè¡Œæ–­è¨€çš„å†…å®¹å†™åœ¨æ‹¬å·ä¸­çš„ç­‰å·åé¢ã€‚<br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>(T|t)he(?=\sfat)</code> åŒ¹é… <code>The</code> å’Œ <code>the</code>ï¼Œåœ¨æ‹¬å·ä¸­æˆ‘ä»¬åˆå®šä¹‰äº†æ­£å…ˆè¡Œæ–­è¨€ <code>(?=\sfat)</code> ï¼Œå³ <code>The</code> å’Œ <code>the</code> åé¢ç´§è·Ÿç€ <code>(ç©ºæ ¼)fat</code>ã€‚</p>
<pre>"(T|t)he(?=\sfat)" =&gt; <a href="#learn-regex"><strong>The</strong></a> fat cat sat on the mat.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9JRERBUnQvMQ==" title="https://regex101.com/r/IDDARt/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="4-2-è´Ÿå…ˆè¡Œæ–­è¨€-Negative-Lookahead"><a href="#4-2-è´Ÿå…ˆè¡Œæ–­è¨€-Negative-Lookahead" class="headerlink" title="4.2 ?!... è´Ÿå…ˆè¡Œæ–­è¨€ Negative Lookahead"></a>4.2 <code>?!...</code> è´Ÿå…ˆè¡Œæ–­è¨€ Negative Lookahead</h3><p>è´Ÿå…ˆè¡Œæ–­è¨€ <code>?!</code> ç”¨äºç­›é€‰æ‰€æœ‰åŒ¹é…ç»“æœï¼Œç­›é€‰æ¡ä»¶ä¸º å…¶åä¸è·Ÿéšç€æ–­è¨€ä¸­å®šä¹‰çš„æ ¼å¼ã€‚<br><code>æ­£å…ˆè¡Œæ–­è¨€</code>  å®šä¹‰å’Œ <code>è´Ÿå…ˆè¡Œæ–­è¨€</code> ä¸€æ ·ï¼ŒåŒºåˆ«å°±æ˜¯ <code>=</code> æ›¿æ¢æˆ <code>!</code> ä¹Ÿå°±æ˜¯ <code>(?!...)</code>ã€‚</p>
<p>è¡¨è¾¾å¼ <code>(T|t)he(?!\sfat)</code> åŒ¹é… <code>The</code> å’Œ <code>the</code>ï¼Œä¸”å…¶åä¸è·Ÿç€ <code>(ç©ºæ ¼)fat</code>ã€‚</p>
<pre>"(T|t)he(?!\sfat)" =&gt; The fat cat sat on <a href="#learn-regex"><strong>the</strong></a> mat.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9WMzJOcGcvMQ==" title="https://regex101.com/r/V32Npg/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="4-3-lt-æ­£åå‘æ–­è¨€-Positive-Lookbehind"><a href="#4-3-lt-æ­£åå‘æ–­è¨€-Positive-Lookbehind" class="headerlink" title="4.3 ?<= ... æ­£åå‘æ–­è¨€ Positive Lookbehind"></a>4.3 <code>?&lt;= ...</code> æ­£åå‘æ–­è¨€ Positive Lookbehind</h3><p>æ­£åå‘æ–­è¨€ è®°ä½œ<code>(?&lt;=...)</code> ç”¨äºç­›é€‰æ‰€æœ‰åŒ¹é…ç»“æœï¼Œç­›é€‰æ¡ä»¶ä¸º å…¶å‰è·Ÿéšç€æ–­è¨€ä¸­å®šä¹‰çš„æ ¼å¼ã€‚<br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>(?&lt;=(T|t)he\s)(fat|mat)</code> åŒ¹é… <code>fat</code> å’Œ <code>mat</code>ï¼Œä¸”å…¶å‰è·Ÿç€ <code>The</code> æˆ– <code>the</code>ã€‚</p>
<pre>"(?&lt;=(T|t)he\s)(fat|mat)" =&gt; The <a href="#learn-regex"><strong>fat</strong></a> cat sat on the <a href="#learn-regex"><strong>mat</strong></a>.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9hdkgxNjUvMQ==" title="https://regex101.com/r/avH165/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="4-4-lt-è´Ÿåå‘æ–­è¨€-Negative-Lookbehind"><a href="#4-4-lt-è´Ÿåå‘æ–­è¨€-Negative-Lookbehind" class="headerlink" title="4.4 ?<!... è´Ÿåå‘æ–­è¨€ Negative Lookbehind"></a>4.4 <code>?&lt;!...</code> è´Ÿåå‘æ–­è¨€ Negative Lookbehind</h3><p>è´Ÿåå‘æ–­è¨€ è®°ä½œ <code>(?&lt;!...)</code> ç”¨äºç­›é€‰æ‰€æœ‰åŒ¹é…ç»“æœï¼Œç­›é€‰æ¡ä»¶ä¸º å…¶å‰ä¸è·Ÿéšç€æ–­è¨€ä¸­å®šä¹‰çš„æ ¼å¼ã€‚<br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>(?&lt;!(T|t)he\s)(cat)</code> åŒ¹é… <code>cat</code>ï¼Œä¸”å…¶å‰ä¸è·Ÿç€ <code>The</code> æˆ– <code>the</code>ã€‚</p>
<pre>"(?&lt;!(T|t)he\s)(cat)" =&gt; The cat sat on <a href="#learn-regex"><strong>cat</strong></a>.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci84RWZ4NUcvMQ==" title="https://regex101.com/r/8Efx5G/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="5-æ ‡å¿—-Flags"><a href="#5-æ ‡å¿—-Flags" class="headerlink" title="5. æ ‡å¿— Flags"></a>5. æ ‡å¿— Flags</h2><p>æ ‡å¿—ä¹Ÿå«æ¨¡å¼ä¿®æ­£ç¬¦ï¼Œå› ä¸ºå®ƒå¯ä»¥ç”¨æ¥ä¿®æ”¹è¡¨è¾¾å¼çš„æœç´¢ç»“æœã€‚<br>è¿™äº›æ ‡å¿—å¯ä»¥ä»»æ„çš„ç»„åˆä½¿ç”¨ï¼Œå®ƒä¹Ÿæ˜¯æ•´ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">æ ‡å¿—</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">i</td>
<td>å¿½ç•¥å¤§å°å†™ã€‚</td>
</tr>
<tr>
<td style="text-align:center">g</td>
<td>å…¨å±€æœç´¢ã€‚</td>
</tr>
<tr>
<td style="text-align:center">m</td>
<td>å¤šè¡Œä¿®é¥°ç¬¦ï¼šé”šç‚¹å…ƒå­—ç¬¦ <code>^</code> <code>$</code> å·¥ä½œèŒƒå›´åœ¨æ¯è¡Œçš„èµ·å§‹ã€‚</td>
</tr>
</tbody>
</table>
</div>
<h3 id="5-1-å¿½ç•¥å¤§å°å†™-Case-Insensitive"><a href="#5-1-å¿½ç•¥å¤§å°å†™-Case-Insensitive" class="headerlink" title="5.1 å¿½ç•¥å¤§å°å†™ Case Insensitive"></a>5.1 å¿½ç•¥å¤§å°å†™ Case Insensitive</h3><p>ä¿®é¥°è¯­ <code>i</code> ç”¨äºå¿½ç•¥å¤§å°å†™ã€‚<br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>/The/gi</code> è¡¨ç¤ºåœ¨å…¨å±€æœç´¢ <code>The</code>ï¼Œåœ¨åé¢çš„ <code>i</code> å°†å…¶æ¡ä»¶ä¿®æ”¹ä¸ºå¿½ç•¥å¤§å°å†™ï¼Œåˆ™å˜æˆæœç´¢ <code>the</code> å’Œ <code>The</code>ï¼Œ<code>g</code> è¡¨ç¤ºå…¨å±€æœç´¢ã€‚</p>
<pre>"The" =&gt; <a href="#learn-regex"><strong>The</strong></a> fat cat sat on the mat.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9kcFF5ZjkvMQ==" title="https://regex101.com/r/dpQyf9/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<pre>"/The/gi" =&gt; <a href="#learn-regex"><strong>The</strong></a> fat cat sat on <a href="#learn-regex"><strong>the</strong></a> mat.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9haGZpdWgvMQ==" title="https://regex101.com/r/ahfiuh/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="5-2-å…¨å±€æœç´¢-Global-search"><a href="#5-2-å…¨å±€æœç´¢-Global-search" class="headerlink" title="5.2 å…¨å±€æœç´¢ Global search"></a>5.2 å…¨å±€æœç´¢ Global search</h3><p>ä¿®é¥°ç¬¦ <code>g</code> å¸¸ç”¨äºæ‰§è¡Œä¸€ä¸ªå…¨å±€æœç´¢åŒ¹é…ï¼Œå³ï¼ˆä¸ä»…ä»…è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„ï¼Œè€Œæ˜¯è¿”å›å…¨éƒ¨ï¼‰ã€‚<br>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>/.(at)/g</code> è¡¨ç¤ºæœç´¢ ä»»æ„å­—ç¬¦ï¼ˆé™¤äº†æ¢è¡Œï¼‰+ <code>at</code>ï¼Œå¹¶è¿”å›å…¨éƒ¨ç»“æœã€‚</p>
<pre>"/.(at)/" =&gt; The <a href="#learn-regex"><strong>fat</strong></a> cat sat on the mat.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9qbms2Z00vMQ==" title="https://regex101.com/r/jnk6gM/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<pre>"/.(at)/g" =&gt; The <a href="#learn-regex"><strong>fat</strong></a> <a href="#learn-regex"><strong>cat</strong></a> <a href="#learn-regex"><strong>sat</strong></a> on the <a href="#learn-regex"><strong>mat</strong></a>.
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9kTzFuZWYvMQ==" title="https://regex101.com/r/dO1nef/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="5-3-å¤šè¡Œä¿®é¥°ç¬¦-Multiline"><a href="#5-3-å¤šè¡Œä¿®é¥°ç¬¦-Multiline" class="headerlink" title="5.3 å¤šè¡Œä¿®é¥°ç¬¦ Multiline"></a>5.3 å¤šè¡Œä¿®é¥°ç¬¦ Multiline</h3><p>å¤šè¡Œä¿®é¥°ç¬¦ <code>m</code> å¸¸ç”¨äºæ‰§è¡Œä¸€ä¸ªå¤šè¡ŒåŒ¹é…ã€‚</p>
<p>åƒä¹‹å‰ä»‹ç»çš„ <code>(^,$)</code> ç”¨äºæ£€æŸ¥æ ¼å¼æ˜¯å¦æ˜¯åœ¨å¾…æ£€æµ‹å­—ç¬¦ä¸²çš„å¼€å¤´æˆ–ç»“å°¾ã€‚ä½†æˆ‘ä»¬å¦‚æœæƒ³è¦å®ƒåœ¨æ¯è¡Œçš„å¼€å¤´å’Œç»“å°¾ç”Ÿæ•ˆï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å¤šè¡Œä¿®é¥°ç¬¦ <code>m</code>ã€‚</p>
<p>ä¾‹å¦‚ï¼Œè¡¨è¾¾å¼ <code>/at(.)?$/gm</code> è¡¨ç¤ºå°å†™å­—ç¬¦ <code>a</code> åè·Ÿå°å†™å­—ç¬¦ <code>t</code> ï¼Œæœ«å°¾å¯é€‰é™¤æ¢è¡Œç¬¦å¤–ä»»æ„å­—ç¬¦ã€‚æ ¹æ® <code>m</code> ä¿®é¥°ç¬¦ï¼Œç°åœ¨è¡¨è¾¾å¼åŒ¹é…æ¯è¡Œçš„ç»“å°¾ã€‚</p>
<pre>"/.at(.)?$/" =&gt; The fat
                cat sat
                on the <a href="#learn-regex"><strong>mat.</strong></a>
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9ob0dNa1AvMQ==" title="https://regex101.com/r/hoGMkP/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<pre>"/.at(.)?$/gm" =&gt; The <a href="#learn-regex"><strong>fat</strong></a>
                  cat <a href="#learn-regex"><strong>sat</strong></a>
                  on the <a href="#learn-regex"><strong>mat.</strong></a>
</pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9FODhXRTIvMQ==" title="https://regex101.com/r/E88WE2/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h3 id="6-è´ªå©ªåŒ¹é…ä¸æƒ°æ€§åŒ¹é…ï¼ˆGreedy-vs-lazy-matchingï¼‰"><a href="#6-è´ªå©ªåŒ¹é…ä¸æƒ°æ€§åŒ¹é…ï¼ˆGreedy-vs-lazy-matchingï¼‰" class="headerlink" title="6. è´ªå©ªåŒ¹é…ä¸æƒ°æ€§åŒ¹é…ï¼ˆGreedy vs lazy matchingï¼‰"></a>6. è´ªå©ªåŒ¹é…ä¸æƒ°æ€§åŒ¹é…ï¼ˆGreedy vs lazy matchingï¼‰</h3><p>æ­£åˆ™è¡¨è¾¾å¼é»˜è®¤é‡‡ç”¨è´ªå©ªåŒ¹é…æ¨¡å¼ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹æ„å‘³ç€ä¼šåŒ¹é…å°½å¯èƒ½é•¿çš„å­ä¸²ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>?</code> å°†è´ªå©ªåŒ¹é…æ¨¡å¼è½¬åŒ–ä¸ºæƒ°æ€§åŒ¹é…æ¨¡å¼ã€‚</p>
<blockquote>
<p>è´ªå©ªåŒ¹é…ï¼šå½“æ­£åˆ™è¡¨è¾¾å¼ä¸­åŒ…å«èƒ½æ¥å—é‡å¤çš„é™å®šç¬¦æ—¶ï¼Œé€šå¸¸çš„è¡Œä¸ºæ˜¯ï¼ˆåœ¨ä½¿æ•´ä¸ªè¡¨è¾¾å¼èƒ½å¾—åˆ°åŒ¹é…çš„å‰æä¸‹ï¼‰åŒ¹é…å°½å¯èƒ½å¤šçš„å­—ç¬¦ï¼Œè¿™åŒ¹é…æ–¹å¼å«åšè´ªå©ªåŒ¹é…ã€‚ç‰¹æ€§ï¼šä¸€æ¬¡æ€§è¯»å…¥æ•´ä¸ªå­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…ï¼Œæ¯å½“ä¸åŒ¹é…å°±èˆå¼ƒæœ€å³è¾¹ä¸€ä¸ªå­—ç¬¦ï¼Œç»§ç»­åŒ¹é…ï¼Œä¾æ¬¡åŒ¹é…å’Œèˆå¼ƒï¼ˆè¿™ç§åŒ¹é…-èˆå¼ƒçš„æ–¹å¼ä¹Ÿå«åšå›æº¯ï¼‰ï¼Œç›´åˆ°åŒ¹é…æˆåŠŸæˆ–è€…æŠŠæ•´ä¸ªå­—ç¬¦ä¸²èˆå¼ƒå®Œä¸ºæ­¢ï¼Œå› æ­¤å®ƒæ˜¯ä¸€ç§æœ€å¤§åŒ–çš„æ•°æ®è¿”å›ï¼Œèƒ½å¤šä¸ä¼šå°‘ã€‚<sup><a href="#myfootnote2">2</a></sup>ã€€</p>
</blockquote>
<pre>"/(.*at)/" =&gt; <a href="#learn-regex"><strong>The fat cat sat on the mat</strong></a>. </pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9BeUFkZ0ovMQ==" title="https://regex101.com/r/AyAdgJ/1">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<blockquote>
<p>æ‡’æƒ°åŒ¹é…ï¼šå½“æ­£åˆ™è¡¨è¾¾å¼ä¸­åŒ…å«èƒ½æ¥å—é‡å¤çš„é™å®šç¬¦æ—¶ï¼Œé€šå¸¸çš„è¡Œä¸ºæ˜¯ï¼ˆåœ¨ä½¿æ•´ä¸ªè¡¨è¾¾å¼èƒ½å¾—åˆ°åŒ¹é…çš„å‰æä¸‹ï¼‰åŒ¹é…å°½å¯èƒ½å°‘çš„å­—ç¬¦ï¼Œè¿™åŒ¹é…æ–¹å¼å«åšæ‡’æƒ°åŒ¹é…ã€‚ç‰¹æ€§ï¼šä»å·¦åˆ°å³ï¼Œä»å­—ç¬¦ä¸²çš„æœ€å·¦è¾¹å¼€å§‹åŒ¹é…ï¼Œæ¯æ¬¡è¯•å›¾ä¸è¯»å…¥å­—ç¬¦åŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸï¼Œåˆ™å®ŒæˆåŒ¹é…ï¼Œå¦åˆ™è¯»å…¥ä¸€ä¸ªå­—ç¬¦å†åŒ¹é…ï¼Œä¾æ­¤å¾ªç¯ï¼ˆè¯»å…¥å­—ç¬¦ã€åŒ¹é…ï¼‰ç›´åˆ°åŒ¹é…æˆåŠŸæˆ–è€…æŠŠå­—ç¬¦ä¸²çš„å­—ç¬¦åŒ¹é…å®Œä¸ºæ­¢ã€‚æ‡’æƒ°é‡è¯æ˜¯åœ¨è´ªå©ªé‡è¯åé¢åŠ ä¸ªâ€œï¼Ÿâ€ã€‚<sup><a href="#myfootnote2">2</a></sup></p>
</blockquote>
<pre>"/(.*?at)/" =&gt; <a href="#learn-regex"><strong>The fat</strong></a> cat sat on the mat. </pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20vci9BeUFkZ0ovMg==" title="https://regex101.com/r/AyAdgJ/2">åœ¨çº¿ç»ƒä¹ <i class="fa fa-external-link"></i></span></p>
<h2 id="é¢å¤–è¡¥å……-3"><a href="#é¢å¤–è¡¥å……-3" class="headerlink" title="é¢å¤–è¡¥å…… 3"></a>é¢å¤–è¡¥å…… <sup><a href="#myfootnote3">3</a></sup></h2><ul>
<li><em>æ•´æ•°</em>: <code>^-?\d+$</code></li>
<li><em>æ•°å­—</em>ï¼š<code>^[0-9]*$</code></li>
<li><em>nä½çš„æ•°å­—</em>ï¼š<code>^\d{n}$</code></li>
<li><em>è‡³å°‘nä½çš„æ•°å­—</em>ï¼š<code>^\d{n,}$</code></li>
<li><em>m-nä½çš„æ•°å­—</em>ï¼š<code>^\d{m,n}$</code></li>
<li><em>é›¶å’Œéé›¶å¼€å¤´çš„æ•°å­—</em>ï¼š<code>^(0|[1-9][0-9]*)$</code></li>
<li><em>éé›¶å¼€å¤´çš„æœ€å¤šå¸¦ä¸¤ä½å°æ•°çš„æ•°å­—</em>ï¼š<code>^([1-9][0-9]*)+(.[0-9]{1,2})?$</code></li>
<li><em>å¸¦1-2ä½å°æ•°çš„æ­£æ•°æˆ–è´Ÿæ•°</em>ï¼š<code>^(\-)?\d+(\.\d{1,2})?$</code></li>
<li><em>æ­£æ•°ã€è´Ÿæ•°ã€å’Œå°æ•°</em>ï¼š<code>^(\-|\+)?\d+(\.\d+)?$</code></li>
<li><em>æœ‰ä¸¤ä½å°æ•°çš„æ­£å®æ•°</em>ï¼š<code>^[0-9]+(.[0-9]{2})?$</code></li>
<li><em>æœ‰1~3ä½å°æ•°çš„æ­£å®æ•°</em>ï¼š<code>^[0-9]+(.[0-9]{1,3})?$</code></li>
<li><em>æ­£æ•´æ•°</em>: <code>^\d+$</code></li>
<li><em>è´Ÿæ•´æ•°</em>: <code>^-\d+$</code></li>
<li><em>éé›¶çš„æ­£æ•´æ•°</em>ï¼š<code>^[1-9]\d*$</code> æˆ– <code>^([1-9][0-9]*){1,3}$</code> æˆ– <code>^\+?[1-9][0-9]*$</code></li>
<li><em>éé›¶çš„è´Ÿæ•´æ•°</em>ï¼š<code>^\-[1-9][]0-9"*$</code> æˆ– <code>^-[1-9]\d*$</code></li>
<li><em>éè´Ÿæ•´æ•°</em>ï¼š<code>^\d+$</code> æˆ– <code>^[1-9]\d*|0$</code></li>
<li><em>éæ­£æ•´æ•°</em>ï¼š<code>^-[1-9]\d*|0$</code> æˆ– <code>^((-\d+)|(0+))$</code></li>
<li><em>éè´Ÿæµ®ç‚¹æ•°</em>ï¼š<code>^\d+(\.\d+)?$</code> æˆ– <code>^[1-9]\d*\.\d*|0\.\d*[1-9]\d*|0?\.0+|0$</code></li>
<li><em>éæ­£æµ®ç‚¹æ•°</em>ï¼š<code>^((-\d+(\.\d+)?)|(0+(\.0+)?))$</code> æˆ– <code>^(-([1-9]\d*\.\d*|0\.\d*[1-9]\d*))|0?\.0+|0$</code></li>
<li><em>æ­£æµ®ç‚¹æ•°</em>ï¼š<code>^[1-9]\d*\.\d*|0\.\d*[1-9]\d*$</code> æˆ– <code>^(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*))$</code></li>
<li><em>è´Ÿæµ®ç‚¹æ•°</em>ï¼š<code>^-([1-9]\d*\.\d*|0\.\d*[1-9]\d*)$</code> æˆ– <code>^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$</code></li>
<li><em>æµ®ç‚¹æ•°</em>ï¼š<code>^(-?\d+)(\.\d+)?$</code> æˆ– <code>^-?([1-9]\d*\.\d*|0\.\d*[1-9]\d*|0?\.0+|0)$</code></li>
</ul>
<p><br></p>
<ul>
<li><em>çº¯å°å†™å­—æ¯</em>: <code>^([a-z])*$</code></li>
<li><em>çº¯å¤§å†™å­—æ¯</em>: <code>^([A-Z])*$</code></li>
<li><em>ä¸­æ–‡å­—ç¬¦çš„æ­£åˆ™è¡¨è¾¾å¼</em>ï¼š<code>[\u4e00-\u9fa5]</code></li>
<li><em>æ±‰å­— ä¸­æ–‡å­—ç¬¦</em>ï¼š<code>^[\u4e00-\u9fa5]{0,}$</code></li>
<li><em>è‹±æ–‡å’Œæ•°å­—</em>ï¼š<code>^[A-Za-z0-9]+$</code> æˆ– <code>^[A-Za-z0-9]{4,40}$</code></li>
<li><em>é•¿åº¦ä¸º3-20çš„æ‰€æœ‰å­—ç¬¦</em>ï¼š<code>^.{3,20}$</code></li>
<li><em>æ•°å­—å’Œè‹±æ–‡å­—æ¯</em>: <code>^[a-zA-Z0-9]*$</code></li>
<li><em>æ•°å­—å’Œåº”ä¸ºå­—æ¯å’Œç©ºæ ¼</em>: <code>^[a-zA-Z0-9 ]*$</code></li>
<li><em>ç”±26ä¸ªè‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²</em>ï¼š<code>^[A-Za-z]+$</code></li>
<li><em>ç”±26ä¸ªå¤§å†™è‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²</em>ï¼š<code>^[A-Z]+$</code></li>
<li><em>ç”±26ä¸ªå°å†™è‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²</em>ï¼š<code>^[a-z]+$</code></li>
<li><em>ç”±æ•°å­—å’Œ26ä¸ªè‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²</em>ï¼š<code>^[A-Za-z0-9]+$</code></li>
<li><em>ç”±æ•°å­—ã€26ä¸ªè‹±æ–‡å­—æ¯æˆ–è€…ä¸‹åˆ’çº¿ç»„æˆçš„å­—ç¬¦ä¸²</em>ï¼š<code>^\w+$</code> æˆ– <code>^\w{3,20}$</code></li>
<li><em>ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—åŒ…æ‹¬ä¸‹åˆ’çº¿</em>ï¼š<code>^[\u4E00-\u9FA5A-Za-z0-9_]+$</code></li>
<li><em>ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ä½†ä¸åŒ…æ‹¬ä¸‹åˆ’çº¿ç­‰ç¬¦å·</em>ï¼š<code>^[\u4E00-\u9FA5A-Za-z0-9]+$</code> æˆ– <code>^[\u4E00-\u9FA5A-Za-z0-9]{2,20}$</code></li>
<li><em>å¯ä»¥è¾“å…¥å«æœ‰^%&amp;â€™,;=?$\â€ç­‰å­—ç¬¦</em>ï¼š<code>[^%&amp;',;=?$\x22]+</code></li>
<li><em>ç¦æ­¢è¾“å…¥å«æœ‰~çš„å­—ç¬¦</em>ï¼š<code>[^~\x22]+</code></li>
<li><em>åŒå­—èŠ‚å­—ç¬¦</em><code>ï¼š[^\x00-\xff]</code>   (åŒ…æ‹¬æ±‰å­—åœ¨å†…ï¼Œå¯ä»¥ç”¨æ¥è®¡ç®—å­—ç¬¦ä¸²çš„é•¿åº¦(ä¸€ä¸ªåŒå­—èŠ‚å­—ç¬¦é•¿åº¦è®¡2ï¼ŒASCIIå­—ç¬¦è®¡1))</li>
<li><em>ç©ºç™½è¡Œçš„æ­£åˆ™è¡¨è¾¾å¼</em>ï¼š<code>\n\s*\r</code>    (å¯ä»¥ç”¨æ¥åˆ é™¤ç©ºç™½è¡Œ)</li>
<li><em>é¦–å°¾ç©ºç™½å­—ç¬¦çš„æ­£åˆ™è¡¨è¾¾å¼</em>ï¼š<code>^\s*|\s*$æˆ–(^\s*)|(\s*$)</code>    (å¯ä»¥ç”¨æ¥åˆ é™¤è¡Œé¦–è¡Œå°¾çš„ç©ºç™½å­—ç¬¦(åŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢é¡µç¬¦ç­‰ç­‰)ï¼Œéå¸¸æœ‰ç”¨çš„è¡¨è¾¾å¼)</li>
</ul>
<p><br></p>
<ul>
<li><em>æ‰‹æœºå›½å®¶å·</em>: <code>^+?[\d\s]{3,}$</code></li>
<li><em>æ‰‹æœºå·</em>: <code>^+?[\d\s]+(?[\d\s]{10,}$</code></li>
<li><em>ä¸­å›½å›½å†…æ‰‹æœºå·(ä»¥0å¼€å¤´å‰4ä½å7ä½ï¼Œå¦‚0737-5686123)</em>: <code>^0\d\d\d-\d\d\d\d\d\d\d$</code> æˆ– <code>^\d{3}-\d{7}$</code> æˆ– <code>^(13[0-9]|14[0-9]|15[0-9]|166|17[0-9]|18[0-9]|19[8|9])\d{8}$</code></li>
<li><em>ç”µè¯å·ç </em> (â€œXXX-XXXXXXXâ€ã€â€XXXX-XXXXXXXXâ€ã€â€XXX-XXXXXXXâ€ã€â€XXX-XXXXXXXXâ€ã€â€XXXXXXXâ€å’Œâ€XXXXXXXX)ï¼š<code>^(\(\d{3,4}-)|\d{3.4}-)?\d{7,8}$</code></li>
<li><em>å›½å†…ç”µè¯å·ç </em> (0511-4405222ã€021-87888822)ï¼š<code>\d{3}-\d{8}|\d{4}-\d{7}</code> </li>
<li><em>ä¸­å›½é‚®æ”¿ç¼–ç </em>ï¼š<code>[1-9]\d{5}(?!\d)</code>    (ä¸­å›½é‚®æ”¿ç¼–ç ä¸º6ä½æ•°å­—)</li>
<li><em>8ä½æ•°å­—çš„QQå·ç </em>: <code>^\d\d\d\d\d\d\d\d$</code> æˆ– <code>^\d{8}$</code></li>
<li><em>è…¾è®¯QQå·</em>ï¼š<code>[1-9][0-9]{4,}</code>    (è…¾è®¯QQå·ä»10000å¼€å§‹)</li>
<li><em>18ä½èº«ä»½è¯å·ç (æ•°å­—ã€å­—æ¯xç»“å°¾)</em>ï¼š<code>^((\d{18})|([0-9x]{18})|([0-9X]{18}))$</code></li>
<li><em>ç”¨æˆ·å</em>: <code>^[\w\d_.]{4,16}$</code></li>
<li><em>å¸å·æ˜¯å¦åˆæ³•(å­—æ¯å¼€å¤´ï¼Œå…è®¸5-16å­—èŠ‚ï¼Œå…è®¸å­—æ¯æ•°å­—ä¸‹åˆ’çº¿)</em>ï¼š<code>^[a-zA-Z][a-zA-Z0-9_]{4,15}$</code></li>
<li><em>å¯†ç (ä»¥å­—æ¯å¼€å¤´ï¼Œé•¿åº¦åœ¨6~18ä¹‹é—´ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿)</em>ï¼š<code>^[a-zA-Z]\w{5,17}$</code></li>
<li><em>å¯†ç </em>: <code>^(?=^.{6,}$)((?=.*[A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z]))^.*$</code></li>
<li><em>å¼ºå¯†ç (å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—çš„ç»„åˆï¼Œä¸èƒ½ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦ï¼Œé•¿åº¦åœ¨8-10ä¹‹é—´)</em>ï¼š<code>^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,10}$</code>  </li>
<li><em>é‚®ç®±</em>: <code>^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4})*$</code> æˆ– <code>^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$</code></li>
<li><em>IP4 åœ°å€</em>: <code>^((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))*$</code> æˆ–ã€€<code>\d+\.\d+\.\d+\.\d+</code> æˆ–ã€€<code>((?:(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d)\\.){3}(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d))</code></li>
<li><em>URL</em>: <code>^(((http|https|ftp):\/\/)?([[a-zA-Z0-9]\-\.])+(\.)([[a-zA-Z0-9]]){2,4}([[a-zA-Z0-9]\/+=%&amp;_\.~?\-]*))*$</code> æˆ–ã€€<code>[a-zA-z]+://[^\s]* æˆ– ^http://([\w-]+\.)+[\w-]+(/[\w-./?%&amp;=]*)?$</code></li>
<li><em>åŸŸå</em>ï¼š<code>[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(/.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+/.?</code></li>
<li><em>VISA ä¿¡ç”¨å¡å·</em>: <code>^(4[0-9]{12}(?:[0-9]{3})?)*$</code></li>
<li><em>ä¸€å¹´çš„12ä¸ªæœˆ(01ï½09å’Œ1ï½12)</em>ï¼š<code>^(0?[1-9]|1[0-2])$</code></li>
<li><em>ä¸€ä¸ªæœˆçš„31å¤©(01ï½09å’Œ1ï½31)</em>ï¼š<code>^((0?[1-9])|((1|2)[0-9])|30|31)$</code> </li>
<li><em>æ—¥æœŸ (MM/DD/YYYY)</em>: <code>^(0?[1-9]|1[012])[- /.](0?[1-9]|[12][0-9]|3[01])[- /.](19|20)?[0-9]{2}$</code></li>
<li><em>æ—¥æœŸ (YYYY/MM/DD)</em>: <code>^(19|20)?[0-9]{2}[- /.](0?[1-9]|1[012])[- /.](0?[1-9]|[12][0-9]|3[01])$</code></li>
<li><em>MasterCard ä¿¡ç”¨å¡å·</em>: <code>^(5[1-5][0-9]{14})*$</code></li>
<li><em>xmlæ–‡ä»¶</em>ï¼š<code>^([a-zA-Z]+-?)+[a-zA-Z0-9]+\\.[x|X][m|M][l|L]$</code></li>
<li><em>HTMLæ ‡è®°çš„æ­£åˆ™è¡¨è¾¾å¼</em>ï¼š<code>&lt;(\S*?)[^&gt;]*&gt;.*?&lt;/\1&gt;|&lt;.*? /&gt;</code>    (ç½‘ä¸Šæµä¼ çš„ç‰ˆæœ¬å¤ªç³Ÿç³•ï¼Œä¸Šé¢è¿™ä¸ªä¹Ÿä»…ä»…èƒ½éƒ¨åˆ†ï¼Œå¯¹äºå¤æ‚çš„åµŒå¥—æ ‡è®°ä¾æ—§æ— èƒ½ä¸ºåŠ›)</li>
</ul>
<p><br></p>
<ul>
<li><em>é’±çš„è¾“å…¥æ ¼å¼</em>ï¼š<ol>
<li>æœ‰å››ç§é’±çš„è¡¨ç¤ºå½¢å¼æˆ‘ä»¬å¯ä»¥æ¥å—:â€10000.00â€ å’Œ â€œ10,000.00â€, å’Œæ²¡æœ‰ â€œåˆ†â€ çš„ â€œ10000â€ å’Œ â€œ10,000â€ï¼š<code>^[1-9][0-9]*$</code></li>
<li>è¿™è¡¨ç¤ºä»»æ„ä¸€ä¸ªä¸ä»¥0å¼€å¤´çš„æ•°å­—,ä½†æ˜¯,è¿™ä¹Ÿæ„å‘³ç€ä¸€ä¸ªå­—ç¬¦â€0â€ä¸é€šè¿‡,æ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨ä¸‹é¢çš„å½¢å¼ï¼š<code>^(0|[1-9][0-9]*)$</code></li>
<li>ä¸€ä¸ª0æˆ–è€…ä¸€ä¸ªä¸ä»¥0å¼€å¤´çš„æ•°å­—.æˆ‘ä»¬è¿˜å¯ä»¥å…è®¸å¼€å¤´æœ‰ä¸€ä¸ªè´Ÿå·ï¼š<code>^(0|-?[1-9][0-9]*)$</code></li>
<li>è¿™è¡¨ç¤ºä¸€ä¸ª0æˆ–è€…ä¸€ä¸ªå¯èƒ½ä¸ºè´Ÿçš„å¼€å¤´ä¸ä¸º0çš„æ•°å­—.è®©ç”¨æˆ·ä»¥0å¼€å¤´å¥½äº†.æŠŠè´Ÿå·çš„ä¹Ÿå»æ‰,å› ä¸ºé’±æ€»ä¸èƒ½æ˜¯è´Ÿçš„å§.ä¸‹é¢æˆ‘ä»¬è¦åŠ çš„æ˜¯è¯´æ˜å¯èƒ½çš„å°æ•°éƒ¨åˆ†ï¼š<code>^[0-9]+(.[0-9]+)?$</code> </li>
<li>å¿…é¡»è¯´æ˜çš„æ˜¯,å°æ•°ç‚¹åé¢è‡³å°‘åº”è¯¥æœ‰1ä½æ•°,æ‰€ä»¥â€10.â€æ˜¯ä¸é€šè¿‡çš„,ä½†æ˜¯ â€œ10â€ å’Œ â€œ10.2â€ æ˜¯é€šè¿‡çš„ï¼š<code>^[0-9]+(.[0-9]{2})?$</code></li>
<li>è¿™æ ·æˆ‘ä»¬è§„å®šå°æ•°ç‚¹åé¢å¿…é¡»æœ‰ä¸¤ä½,å¦‚æœä½ è®¤ä¸ºå¤ªè‹›åˆ»äº†,å¯ä»¥è¿™æ ·ï¼š<code>^[0-9]+(.[0-9]{1,2})?$</code> </li>
<li>è¿™æ ·å°±å…è®¸ç”¨æˆ·åªå†™ä¸€ä½å°æ•°.ä¸‹é¢æˆ‘ä»¬è¯¥è€ƒè™‘æ•°å­—ä¸­çš„é€—å·äº†,æˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼š<code>^[0-9]{1,3}(,[0-9]{3})*(.[0-9]{1,2})?$</code></li>
<li>1åˆ°3ä¸ªæ•°å­—,åé¢è·Ÿç€ä»»æ„ä¸ª é€—å·+3ä¸ªæ•°å­—,é€—å·æˆä¸ºå¯é€‰,è€Œä¸æ˜¯å¿…é¡»ï¼š<code>^([0-9]+|[0-9]{1,3}(,[0-9]{3})*)(.[0-9]{1,2})?$</code></li>
</ol>
<ul>
<li>å¤‡æ³¨ï¼šè¿™å°±æ˜¯æœ€ç»ˆç»“æœäº†,åˆ«å¿˜äº†â€+â€å¯ä»¥ç”¨â€*â€æ›¿ä»£å¦‚æœä½ è§‰å¾—ç©ºå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ¥å—çš„è¯(å¥‡æ€ª,ä¸ºä»€ä¹ˆ?)æœ€å,åˆ«å¿˜äº†åœ¨ç”¨å‡½æ•°æ—¶å»æ‰å»æ‰é‚£ä¸ªåæ–œæ ,ä¸€èˆ¬çš„é”™è¯¯éƒ½åœ¨è¿™é‡Œ</li>
</ul>
</li>
</ul>
<p><br></p>
<p>å¼•ç”¨: </p>
<p><a name="myfootnote1">1</a>:ã€€æ­£åˆ™è¡¨è¾¾å¼ ç»´åŸºç™¾ç§‘. <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU2JUFEJUEzJUU1JTg4JTk5JUU4JUExJUE4JUU4JUJFJUJFJUU1JUJDJThG" title="https://zh.wikipedia.org/wiki/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F">https://zh.wikipedia.org/wiki/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F<i class="fa fa-external-link"></i></span><br><a name="myfootnote2">2</a>: è¿™æ¬¡ä¸ä¼šè¯´æˆ‘çš„æ­£åˆ™æ•™ç¨‹æ²¡å†™å…¨äº†å§ï¼Ÿï¼Ÿ.  <span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81YjllN2I2Y2U1MWQ0NTBlOGE2NWVkNmI=" title="https://juejin.im/post/5b9e7b6ce51d450e8a65ed6b">https://juejin.im/post/5b9e7b6ce51d450e8a65ed6b<i class="fa fa-external-link"></i></span><br><a name="myfootnote3">3</a>: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20venhpbi9hcmNoaXZlLzIwMTMvMDEvMjYvMjg3Nzc2NS5odG1s" title="https://www.cnblogs.com/zxin/archive/2013/01/26/2877765.html">https://www.cnblogs.com/zxin/archive/2013/01/26/2877765.html<i class="fa fa-external-link"></i></span> æœ€å…¨çš„å¸¸ç”¨æ­£åˆ™è¡¨è¾¾å¼å¤§å…¨â€”â€”åŒ…æ‹¬æ ¡éªŒæ•°å­—ã€å­—ç¬¦ã€ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ç­‰ç­‰</p>
<p><br></p>
<p>æœ‰ç”¨çš„é“¾æ¥:   </p>
<ul>
<li>æ­£åˆ™è¡¨è¾¾å¼çœŸçš„å¾ˆéªšï¼Œå¯æƒœä½ ä¸ä¼šå†™ï¼ï¼ï¼: <span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81Yjk2YThlMmU1MWQ0NTBlNmEyZGUxMTU=" title="https://juejin.im/post/5b96a8e2e51d450e6a2de115">https://juejin.im/post/5b96a8e2e51d450e6a2de115<i class="fa fa-external-link"></i></span></li>
<li>Pythonæ­£åˆ™è¡¨è¾¾å¼: <span class="exturl" data-url="aHR0cHM6Ly93d3cubGlhb3h1ZWZlbmcuY29tL3dpa2kvODk3NjkyODg4NzI1MzQ0LzkyMzA1NjEyODEyODg2NA==" title="https://www.liaoxuefeng.com/wiki/897692888725344/923056128128864">https://www.liaoxuefeng.com/wiki/897692888725344/923056128128864<i class="fa fa-external-link"></i></span></li>
<li>è¯»æ‡‚æ­£åˆ™è¡¨è¾¾å¼å°±è¿™ä¹ˆç®€å•: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vemVyeS9wLzM0Mzg4NDUuaHRtbA==" title="https://www.cnblogs.com/zery/p/3438845.html">https://www.cnblogs.com/zery/p/3438845.html<i class="fa fa-external-link"></i></span></li>
<li>æ­£åˆ™è¡¨è¾¾å¼ - æ•™ç¨‹: <span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9yZWdleHAvcmVnZXhwLXR1dG9yaWFsLmh0bWw=" title="https://www.runoob.com/regexp/regexp-tutorial.html">https://www.runoob.com/regexp/regexp-tutorial.html<i class="fa fa-external-link"></i></span></li>
</ul>
<p><br></p>
<p>åœ¨çº¿åŒ¹é…å·¥å…·ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9yZWdleDEwMS5jb20v" title="https://regex101.com/">https://regex101.com/<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL3d3dy5yZWdleHBhbC5jb20v" title="http://www.regexpal.com/">http://www.regexpal.com/<i class="fa fa-external-link"></i></span> </li>
<li><span class="exturl" data-url="aHR0cDovL3J1YnVsYXIuY29tLw==" title="http://rubular.com/">http://rubular.com/<i class="fa fa-external-link"></i></span> </li>
<li><span class="exturl" data-url="aHR0cHM6Ly9yZWdleHBlci5jb20v" title="https://regexper.com/">https://regexper.com/<i class="fa fa-external-link"></i></span></li>
</ul>
<!-- è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Shell</tag>
        <tag>Regular Expression</tag>
      </tags>
  </entry>
  <entry>
    <title>[Paper]BTW 2015 | Unnesting Arbitrary Queries</title>
    <url>/2020/02/25/Paper-BTW-2015-Unnesting-Arbitrary-Queries/</url>
    <content><![CDATA[<pre><code>  - è®ºæ–‡ï¼š Unnesting Arbitrary Queries
  - ä½œè€…ï¼š Thomas Neumann and Alfons Kemper
  - å¹´ä»½ï¼š 2015
  - ä¼šè®®ï¼š Datenbanksysteme fÃ¼r Business, Technologie und Web (BTW 2015)
  - https://dl.gi.de/handle/20.500.12116/2418;jsessionid=6988827FF07E4B508A0C50DC4367E1FA
  - http://www.btw-2015.de/res/proceedings/Hauptband/Wiss/Neumann-Unnesting_Arbitrary_Querie.pdf
</code></pre><!-- TODO:çœ‹å¯¹åº”çš„è¯¾ä»¶slide pdf -->
<p>SQL-99æ ‡å‡†ä¸­è¿è¡Œå­æŸ¥è¯¢(subquery)å‡ ä¹å¯ä»¥å‡ºç°åœ¨queryçš„ä»»ä½•åœ°æ–¹ã€‚<br>è¿™ä¸ªç‰¹æ€§å¯ä»¥è®©æˆ‘ä»¬å®Œæˆå¾ˆå¤šå¤æ‚çš„æŸ¥è¯¢ï¼Œä½†æ˜¯å¾€å¾€è¿™æ ·çš„queryçš„è¿è¡Œæ—¶é—´(runtime)éœ€è¦å¾ˆé•¿ã€‚<br>åŸå› æ˜¯å¤§éƒ¨åˆ†æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å™¨(query optimizer)åªèƒ½ç”¨nested subqueryçš„æ–¹å¼å»è¿›è¡Œæ±‚èŒï¼Œè¿™æ ·çš„æ—¶é—´å¤æ‚åº¦(time complexity)å¾€å¾€æ˜¯æš´åŠ›çš„<code>O(n^2)</code>ã€‚<br>è¿™ç¯‡è®ºæ–‡çš„ç›®çš„å°±åƒå®ƒåå­—æ‰€è¯´ï¼Œå¯¹ä»»æ„çš„SQL queryè¿›è¡Œè§£é™¤å…³è”(de-corrleation), æ¥è·å¾—ä¸€ä¸ªæ›´å¥½çš„run timeã€‚<br>è¿™ç¯‡è®ºæ–‡çš„å‰æè¦æ±‚æ˜¯ï¼šå…³ç³»ä»£æ•°(relation algebra)å’Œé€»è¾‘è®¡åˆ’(logical plan)ã€‚  </p>
<p>è¿™ä¸€ç¯‡è®ºæ–‡æåˆ°çš„å†…å®¹ï¼Œå·²ç»åœ¨HyPeræ•°æ®åº“ä¸­å®ç°ï¼š<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbCM=" title="https://hyper-db.de/interface.html#">https://hyper-db.de/interface.html#<i class="fa fa-external-link"></i></span><br>åŒæ—¶è¿™ä¸ªç½‘é¡µæ¥å£æä¾›äº†å¯¹Query Plançš„æŸ¥çœ‹ã€‚</p>
<a id="more"></a>
<hr>
<h1 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h1><p>æˆ‘ä»¬ç”¨ä¸€ä¸ªå¤§å­¦schemaï¼ŒåŒ…æ‹¬äº†<em>å­¦ç”Ÿstudent</em>å’Œ<em>è€ƒè¯•exams</em>è¿™ä¸¤ä¸ªè¡¨æ ¼ï¼š</p>
<ul>
<li>$students: \{[id, name, major, year, \dots]\}$</li>
<li>$exams: \{[sid, course, curriculum, date, \dots]\}$</li>
</ul>
<p><strong>è¿™é‡Œéœ€è¦æåˆ°ï¼Œ(å¾·å›½å¤§å­¦æˆç»©)gradeæ•°å€¼è¶Šå°ï¼Œæˆç»©è¶Šå¥½ã€‚</strong></p>
<h2 id="Q1-å¯¹æ¯ä¸ªåŒå­¦æœç´¢Taçš„æœ€å¥½æˆç»©"><a href="#Q1-å¯¹æ¯ä¸ªåŒå­¦æœç´¢Taçš„æœ€å¥½æˆç»©" class="headerlink" title="Q1: å¯¹æ¯ä¸ªåŒå­¦æœç´¢Taçš„æœ€å¥½æˆç»©"></a>Q1: å¯¹æ¯ä¸ªåŒå­¦æœç´¢Taçš„æœ€å¥½æˆç»©</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- Q1</span></span><br><span class="line"><span class="keyword">select</span> s.name,e.course</span><br><span class="line"><span class="keyword">from</span> students s,exams e</span><br><span class="line"><span class="keyword">where</span> s.id=e.sid <span class="keyword">and</span></span><br><span class="line">      e.grade=(<span class="keyword">select</span> <span class="keyword">min</span>(e2.grade)</span><br><span class="line">      <span class="keyword">from</span> exams e2</span><br><span class="line">      <span class="keyword">where</span> s.id=e2.sid)</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°å¯¹äºsubqueryï¼Œå®ƒéœ€è¦ä¾èµ–ä¸€ä¸ªå¤–éƒ¨å…ƒç»„(tupel)<code>students s</code>çš„<code>id</code>å­—æ®µã€‚<br>è¿™ä¸ªSQLä¸ºäº†å¾—åˆ°ä¸€ä¸ªæœ€ç»ˆç»“æœä¸­çš„tupelï¼Œéƒ½éœ€è¦å¯¹subqueryæ ¹æ®å¯¹åº”çš„<code>students s</code>è¿›è¡Œæ±‚å€¼ã€‚<br>è¿™æ ·çš„subqueryï¼Œæˆ‘ä»¬ç§°ä¸ºcorelated subquery(å…³è”å­æŸ¥è¯¢)ã€‚<br>è¿™æ ·çš„joinæˆ‘ä»¬ç§°ä¹‹ä¸º<em>dependent join</em>ï¼ŒæŒ‡ä¸€ä¸ªnested loop joinä¸­ï¼Œä¸€ä¾§çš„æ±‚å€¼ä¾èµ–äºå¦å¤–ä¸€ä¾§ã€‚</p>
<blockquote>
<p>A dependent join, i.e., a nested loop join where the evaluation of the right hand side depends on the current value of the left-hand side.</p>
</blockquote>
<p>è¿™æ ·çš„dependent joinå¾€å¾€æ˜¯éå¸¸ä½æ•ˆçš„ï¼Œæ—¶é—´å¤æ‚åº¦åœ¨å¹³æ–¹é˜¶ç­‰çº§ã€‚</p>
<p><br></p>
<p>å¯¹äºè¿™ä¸ª<code>Q1</code>ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«æ€è€ƒå‡ºä¸€ä¸ªuncorelated subquery(æ— å…³è”å­æŸ¥è¯¢):</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- Q1'</span></span><br><span class="line"><span class="keyword">select</span> s.name,e.course</span><br><span class="line"><span class="keyword">from</span> students s,exams e,</span><br><span class="line">     (<span class="keyword">select</span> e2.sid <span class="keyword">as</span> <span class="keyword">id</span>, <span class="keyword">min</span>(e2.grade) <span class="keyword">as</span> best</span><br><span class="line">     <span class="keyword">from</span> exams e2</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> e2.sid) m</span><br><span class="line"><span class="keyword">where</span> s.id=e.sid <span class="keyword">and</span> m.id=s.id <span class="keyword">and</span> e.grade=m.best</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªæ”¹å–„è¿‡çš„<code>Q1'</code>ä¸­ï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼<code>m</code>ï¼Œå¯¹å®ƒçš„æ±‚å€¼ä¸ä¾èµ–äºå¤–ç•Œçš„tupelã€‚<br>æˆ‘ä»¬ç”¨ä¸€ä¸ªå®Œå…¨å†…éƒ¨å˜é‡<strong>å–ä»£(substitue)</strong> äº†åŸæ¥æ¥è‡ªouter queryçš„<code>students s</code>çš„<code>id</code>å­—æ®µã€‚<br>å› æ­¤è¿™é‡Œçš„joinä¸å†æ˜¯depedent joinï¼Œè€Œæ˜¯ä¸€ä¸ªregular joinã€‚è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†ä¸€æ¬¡unnestingæˆ–è€…de-correlation(å»å…³è”)ã€‚  </p>
<h2 id="Q2-æœç´¢CSæˆ–Games-Engineeringä¸“ä¸šçš„å­¦ç”Ÿå’ŒTaçš„ç§‘ç›®ï¼Œæˆç»©æ¯”è‡ªå·±è€ƒè¯•æˆ–è€…å­¦é•¿å­¦å§æˆç»©çš„å¹³å‡å€¼å·®-å¤§"><a href="#Q2-æœç´¢CSæˆ–Games-Engineeringä¸“ä¸šçš„å­¦ç”Ÿå’ŒTaçš„ç§‘ç›®ï¼Œæˆç»©æ¯”è‡ªå·±è€ƒè¯•æˆ–è€…å­¦é•¿å­¦å§æˆç»©çš„å¹³å‡å€¼å·®-å¤§" class="headerlink" title="Q2: æœç´¢CSæˆ–Games Engineeringä¸“ä¸šçš„å­¦ç”Ÿå’ŒTaçš„ç§‘ç›®ï¼Œæˆç»©æ¯”è‡ªå·±è€ƒè¯•æˆ–è€…å­¦é•¿å­¦å§æˆç»©çš„å¹³å‡å€¼å·®(å¤§)"></a>Q2: æœç´¢CSæˆ–Games Engineeringä¸“ä¸šçš„å­¦ç”Ÿå’ŒTaçš„ç§‘ç›®ï¼Œæˆç»©æ¯”è‡ªå·±è€ƒè¯•æˆ–è€…å­¦é•¿å­¦å§æˆç»©çš„å¹³å‡å€¼å·®(å¤§)</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name, e.course</span><br><span class="line"><span class="keyword">from</span> students s, exams e</span><br><span class="line"><span class="keyword">where</span> s.id=e.sid <span class="keyword">and</span> (s.major = â€™CSâ€™ <span class="keyword">or</span> s.major = â€™Games Engâ€™) <span class="keyword">and</span></span><br><span class="line">      e.grade&gt;=(<span class="keyword">select</span> <span class="keyword">avg</span>(e2.grade)+<span class="number">1</span> <span class="comment">--one grade worse</span></span><br><span class="line">                <span class="keyword">from</span> exams e2 <span class="comment">--than the average grade</span></span><br><span class="line">                <span class="keyword">where</span> s.id=e2.sid <span class="keyword">or</span> <span class="comment">--of exams taken by</span></span><br><span class="line">                (e2.curriculum=s.major <span class="keyword">and</span> <span class="comment">--him/her or taken</span></span><br><span class="line">                s.year&gt;e2.date)) <span class="comment">--by elder peers</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªå¤æ‚çš„ä¾‹å­è®©æˆ‘ä»¬å¾ˆéš¾ç›´æ¥<strong>å¾ˆå¿«æ€è€ƒå‡º</strong>ä¸€ä¸ªå¯¹åº”çš„unnestedç‰ˆæœ¬ã€‚<br>æˆ‘ä»¬å¾ˆéš¾å»è¿›è¡Œä¸€æ¬¡<strong>å–ä»£(substitution)</strong>ï¼Œæ¥æ›¿æ¢<code>s.year</code>å’Œ<code>s.major</code>ã€‚</p>
<hr>
<h1 id="å…³ç³»ä»£æ•°"><a href="#å…³ç³»ä»£æ•°" class="headerlink" title="å…³ç³»ä»£æ•°"></a>å…³ç³»ä»£æ•°</h1><h2 id="The-Dependent-Join"><a href="#The-Dependent-Join" class="headerlink" title="The Dependent Join"></a>The Dependent Join</h2><p><img data-src="/images/Paper/Unnesting/dep_join.png" alt="dep_join"></p>
<p>è¿™é‡Œå¯¹$T_1$çš„æ¯ä¸€ä¸ªtupelï¼Œéƒ½éœ€è¦å¯¹æ‰€æœ‰$T_2$çš„tupelè¿›è¡Œæ±‚å€¼(evaluated)ã€‚</p>
<ul>
<li>$\mathcal{A}(T)$: æŒ‡è¡¨è¾¾å¼T(expression)æ‰€äº§ç”Ÿçš„å­—æ®µ(attributes)</li>
<li>$\mathcal{F}(T)$: æŒ‡å‡ºç°åœ¨è¡¨è¾¾å¼T(expression)è‡ªç”±å˜é‡(free variables)</li>
</ul>
<p>å¯¹äºThe Dependent Joinï¼Œå¦‚ä¸‹ä¸€å®šæˆç«‹ï¼š$\mathcal{F}(T_2) \subseteq \mathcal{A}(T_1)$</p>
<ul>
<li>å³ï¼š$T_2$æ‰€éœ€è¦çš„å­—æ®µå¿…é¡»å…ˆè¢«$T_1$æ‰€äº§ç”Ÿï¼Œè¿™é‡Œä½“ç°äº†<strong>å…³è”æ€§</strong>ã€‚</li>
</ul>
<h2 id="Group-By"><a href="#Group-By" class="headerlink" title="Group By"></a>Group By</h2><p><img data-src="/images/Paper/Unnesting/group_by.png" alt="group_by"></p>
<ul>
<li>$e$: è¾“å…¥çš„å…³ç³»(è¡¨æ ¼)ï¼Œå®ƒçš„éƒ¨åˆ†å­—æ®µè¢«èšåˆï¼Œå‰©ä¸‹çš„å­—æ®µè¢«ç•™ä¸‹æ¥</li>
<li>$A$: è¢«èšåˆçš„å­—æ®µï¼Œå³ <code>group by A</code></li>
<li>$x$: è¢«èšåˆçš„å­—æ®µ($A$)å¯¹åº”çš„è¡¨æ ¼å†…å®¹ï¼Œè‡ªç„¶æ˜¯$e$çš„ä¸€éƒ¨åˆ†</li>
<li>$y$: æ˜¯ä¸€ä¸ªé›†åˆï¼Œå…ƒç´ æ˜¯æ‰€æœ‰ä¸è¢«èšåˆçš„å­—æ®µ(å³ä¸å‡ºç°åœ¨<code>group by</code>åé¢çš„å­—æ®µ)ï¼Œå®ƒä»¬åœ¨$A$ä¸­çš„å­—æ®µä¸­æ‹¥æœ‰ç›¸åŒçš„å€¼ï¼Œæ‰€ä»¥è¢«åˆ†åˆ°ä¸€ç»„(group)ã€‚</li>
<li>$f$: èšåˆå‡½æ•°ï¼Œå®ƒçš„è¾“å…¥æ˜¯ä¸€ä¸ªé›†åˆ(å¸¸å¸¸æ˜¯å¤šä¸ªå…ƒç´ )ã€‚<code>sum, avg, median, min, max</code>éƒ½æ˜¯å¸¸è§çš„èšåˆå‡½æ•°ã€‚</li>
<li>$a$: å³ä¸€ä¸ª(æˆ–ä¸€äº›)æ–°çš„å­—æ®µï¼Œæä¾›ç»™$f(y)$çš„è¾“å‡ºã€‚</li>
</ul>
<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><p><img data-src="/images/Paper/Unnesting/map.png" alt="map"></p>
<ul>
<li>$f$: æ˜ å°„å‡½æ•°ï¼Œå®ƒçš„è¾“å…¥æ˜¯$x$ï¼Œå³$e$è¡¨æ ¼ä¸­çš„tupel</li>
<li>$a$: å³ä¸€ä¸ªæ–°çš„å­—æ®µï¼Œæä¾›ç»™$f(x)$çš„è¾“å‡ºã€‚</li>
<li><code>map</code>å¾ˆç±»ä¼¼SQLä¸­çš„<code>case ... when ... else ... end</code>ã€‚</li>
</ul>
<h2 id="Sets-of-attributes-comparison"><a href="#Sets-of-attributes-comparison" class="headerlink" title="Sets of attributes comparison"></a>Sets of attributes comparison</h2><p><img data-src="/images/Paper/Unnesting/comparison.png" alt="comparison"></p>
<ul>
<li>$A$: æ˜¯ä¸€ä¸ªå­—æ®µçš„é›†åˆ</li>
</ul>
<hr>
<h1 id="å»å…³è”-Unnesting-Decorrelation"><a href="#å»å…³è”-Unnesting-Decorrelation" class="headerlink" title="å»å…³è”(Unnesting, Decorrelation)"></a>å»å…³è”(Unnesting, Decorrelation)</h1><h2 id="Simple-Unnesting"><a href="#Simple-Unnesting" class="headerlink" title="Simple Unnesting"></a>Simple Unnesting</h2><p>æœ‰ä¸€äº›Subqueryçš„ä¾èµ–åªæ˜¯å‡ºäºå¥æ³•(syntactic)åŸå› ï¼Œè¿™æ ·çš„subqueryæˆ‘ä»¬å¾€å¾€å¯ä»¥ç›´æ¥çœ‹å‡ºå»å…³è”çš„ç‰ˆæœ¬ã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- a fragment from TPC-H Query 21</span></span><br><span class="line"><span class="keyword">select</span> ...</span><br><span class="line"><span class="keyword">from</span> lineitem l1 ...</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> *</span><br><span class="line">              <span class="keyword">from</span> lineitem l2</span><br><span class="line">              <span class="keyword">where</span> l2.l_orderkey = l1.l_orderkey)</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹åº”çš„å…³ç³»ä»£æ•°ï¼š</p>
<p><img data-src="/images/Paper/Unnesting/Q21_1.png" alt="Q21_1"></p>
<p>æˆ‘ä»¬å¯ä»¥è¯´è¿™ä¸ª<code>exists</code>å…¶å®æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºä¸¤ä¾§çš„è¡¨æ ¼æ˜¯ä¸€è‡´çš„ï¼Œå¦å¤–ä¹Ÿæ˜¯æ¯”è¾ƒåŒä¸€ä¸ªå­—æ®µçš„ç›¸ç­‰ã€‚è¿™ä¸ª<code>exists</code>è‚¯å®šæˆç«‹ã€‚æˆ‘ä»¬å¯ä»¥<strong>æŠŠselectionå‘ä¸Šæ</strong>ï¼Œä½¿è¿™ä¸ªdependent joinè½¬åŒ–æˆä¸€ä¸ªå¸¦æ¡ä»¶çš„left semi join:</p>
<p><img data-src="/images/Paper/Unnesting/Q21_2.png" alt="Q21_2"></p>
<p>Simple Unnesting:</p>
<ul>
<li>å°†æ‰€æœ‰æœ‰ä¾èµ–çš„åˆ¤æ–­è°“è¯(dependent predicates)å°½å¯èƒ½æé«˜(pull up in the algebra tree)ï¼Œæ¯”å¦‚é«˜äºjoin, selection, group byç­‰ç­‰è¿ç®—ç¬¦ï¼Œåªåˆ°æé«˜è‡³ä¾èµ–æ¶ˆå¤±ã€‚</li>
<li>æŒ‰ç…§ä¸Šé¢çš„åšæ³•ï¼Œå¯ä»¥ä½¿ä¸€ä¸ªdependent joinå˜æˆregular joinã€‚</li>
<li>è¿™é‡Œè¦è¯´æ˜ï¼šè¿™ä¸ªpredicate pull-upçš„ç›®çš„æ˜¯ä¸ºäº†å»å…³è”ã€‚æˆ‘ä»¬å¾—åˆ°ç»“æœä¹‹åï¼Œå¯ä»¥å†ä½¿ç”¨logical plançš„ä¼˜åŒ–æ–¹å¼ï¼Œæ¯”å¦‚selection push downã€‚è¿™æ˜¯ä¼˜åŒ–çš„å‰åæ­¥éª¤ï¼Œå¹¶ä¸ç›¸äº’å†²çªã€‚</li>
</ul>
<h2 id="General-Unnesting"><a href="#General-Unnesting" class="headerlink" title="General Unnesting"></a>General Unnesting</h2><p>å¦‚æœä¸Šé¢çš„Simple Unnestingè¡Œä¸é€šï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•General Unnestingï¼Œå®ƒæ€»ä½“ä¸Šåˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ul>
<li>ç°å°†dependent joinæ”¹å†™æˆä¸€ä¸ª<strong>é€‚åˆè½¬åŒ–çš„dependent join</strong>ï¼Œ</li>
<li>å†å°†ä¸Šä¸€æ­¥ç”Ÿæˆçš„dependent joinå‘ä¸‹æ¨(push down)ï¼Œä¸ºäº†è·å¾—ä¸€ä¸ªregular joinã€‚</li>
</ul>
<h3 id="é€‚åˆè½¬åŒ–çš„dependent-join"><a href="#é€‚åˆè½¬åŒ–çš„dependent-join" class="headerlink" title="é€‚åˆè½¬åŒ–çš„dependent join"></a>é€‚åˆè½¬åŒ–çš„dependent join</h3><p><img data-src="/images/Paper/Unnesting/euivalence_dependent_join.png" alt="euivalence_dependent_join"></p>
<ul>
<li>å·¦ä¾§æ˜¯æˆ‘ä»¬ä¸€ç›´æåˆ°çš„dependent join: å¯¹æ¯ä¸€ä¸ª$T_1$çš„tupelï¼Œæˆ‘ä»¬éƒ½éœ€è¦å¯¹æ‰€æœ‰$T_2$çš„tupelè¿›è¡Œæ±‚å€¼ã€‚</li>
<li>å³ä¾§æ˜¯ä¸€ä¸ªç­‰ä»·è¡¨è¾¾ï¼š  <ul>
<li>$D$: æŒ‡æ‰€æœ‰çš„å˜é‡(variable bindings)çš„åŸŸ(Domain)ï¼Œå®ƒæ˜¯ä¸€ä¸ªé›†åˆï¼Œä¸å«é‡å¤çš„æŒ‡ã€‚  </li>
<li>$T_1 =_{\mathcal{A}(D)} D$: $T_1$å’Œ$D$åœ¨$\mathcal{A}(D)$å­—æ®µä¸­ï¼Œéƒ½ç›¸ç­‰ã€‚  </li>
<li>ç°åœ¨<strong>åªéœ€è¦</strong>å¯¹$T_2$é’ˆå¯¹Dä¸­çš„æ¯ä¸€ä¸ªä¸åŒå˜é‡(distinct variable binding)è¿›è¡Œæ±‚å€¼ã€‚  </li>
<li>æœ€åç”¨ä¸€ä¸ªregular joinå’Œå·¦ä¾§çš„$T_1$è¿æ¥ã€‚  </li>
<li>å¦‚æœ$T_1$æœ‰å¾ˆå¤šé‡å¤å€¼ï¼Œé‚£ä¹ˆé›†åˆä¸­$D$å…ƒç´ ä¸ªæ•°å°±ä¸å¤šï¼Œ$T_2$çš„æ±‚å€¼æ¬¡æ•°ä¼šå¤§å¤§é™ä½ã€‚  </li>
</ul>
</li>
</ul>
<h3 id="æœ€ç»ˆç›®æ ‡"><a href="#æœ€ç»ˆç›®æ ‡" class="headerlink" title="æœ€ç»ˆç›®æ ‡"></a>æœ€ç»ˆç›®æ ‡</h3><p><img data-src="/images/Paper/Unnesting/aim.png" alt="aim"></p>
<p>æˆ‘ä»¬ç›®æ ‡æ˜¯ä¸¤ä¸ªï¼š</p>
<ul>
<li>è·å¾—ä¸€ä¸ªregular joinï¼Œ$T$ä¸å†ä¾èµ–äº$D$ã€‚</li>
<li>ç”šè‡³ç”¨å·²å­˜åœ¨çš„å­—æ®µå–ä»£regular joinã€‚è¿™ä¸€æ­¥æˆ‘ä»¬ä¼šåœ¨<a href="#ä¼˜åŒ–">ä¼˜åŒ–</a>éƒ¨åˆ†ä¸­è®¨è®ºã€‚</li>
</ul>
<h3 id="Push-Down-ä¸‹æ¨"><a href="#Push-Down-ä¸‹æ¨" class="headerlink" title="Push Down(ä¸‹æ¨)"></a>Push Down(ä¸‹æ¨)</h3><p>è¿™éƒ¨åˆ†æˆ‘ä»¬è®¨è®ºå…³ç³»ä»£æ•°è¿ç®—ç¬¦çš„ä¸‹æ¨dependent joinè§„åˆ™ã€‚è¿™é‡Œéœ€è¦æ³¨æ„æˆ‘ä»¬è®²çš„ä¸€ç›´æ˜¯ï¼š<strong>ä¸‹æ¨dependent join</strong>ã€‚</p>
<h4 id="Selection"><a href="#Selection" class="headerlink" title="Selection"></a>Selection</h4><p><img data-src="/images/Paper/Unnesting/selection.png" alt="selection"></p>
<h4 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h4><p><img data-src="/images/Paper/Unnesting/join.png" alt="join"></p>
<ul>
<li>é¦–å…ˆè¿™é‡Œå³ä¾§$T_1\bowtie_p T_2$ä½œä¸ºä»¥æ•´ä½“ï¼Œä¾èµ–$D$ä¸­çš„tupelã€‚</li>
<li>æˆ‘ä»¬åœ¨è¿™äº›éœ€è¦è¿›è¡Œä¸€äº›æƒ…å†µåˆ¤æ–­ï¼š<ul>
<li>å¦‚æœå¯¹$T_2$çš„joinä¸ä¾èµ–äº$D$ï¼Œå³$\mathcal{F}(T_2) \cap \mathcal{A}(D) = \emptyset$ï¼Œæˆ‘ä»¬ä½¿ç”¨regular joinå»è¿æ¥$T_2$  </li>
<li>å¦‚æœå¯¹$T_1$çš„joinä¸ä¾èµ–äº$D$: ç±»ä¼¼ä¸Šé¢è¿™ç§æƒ…å†µ  </li>
<li>å¦‚æœå¯¹$T_1$ï¼Œ$T_2$çš„joinéƒ½ä¾èµ–äº$D$: åªèƒ½åº”ç”¨ç±»ä¼¼ä¹˜æ³•åˆ†é…å¾‹(FOIL method)çš„åŸåˆ™ï¼Œæ³¨æ„ä»$D$å¼€å§‹çš„dependent joinä¼šå‡ºç°ä¸¤æ¬¡(replication)ã€‚  è¿™å¹¶ä¸ä¼šå˜å¾—ä½æ•ˆã€‚åœ¨è½¬åŒ–å‰æƒ…å†µå’Œè½¬åŒ–åï¼Œè¿™ä¸¤ç§æƒ…å†µå‡éœ€è¦å¯¹$T_1$å’Œ$T_2$è¿›è¡Œ$|D|$æ¬¡æ±‚å€¼ã€‚  </li>
</ul>
</li>
<li>è¿™é‡Œçš„è½¬åŒ–æ˜¯æ‚²è§‚çš„(perssimistic)ï¼Œæ›´å¥½çš„æ–¹å¼æˆ‘ä»¬ä¼šåœ¨<a href="#ä¼˜åŒ–">ä¼˜åŒ–</a>éƒ¨åˆ†ä¸­è®¨è®ºã€‚</li>
</ul>
<h4 id="Outer-Join"><a href="#Outer-Join" class="headerlink" title="Outer Join"></a>Outer Join</h4><p><img data-src="/images/Paper/Unnesting/outer_join.png" alt="outer_join"></p>
<p>å¯¹äºleft outer joinï¼š</p>
<ul>
<li>å¦‚æœå¯¹$T_2$çš„joinä¸ä¾èµ–äº$D$ï¼Œæˆ‘ä»¬ä½¿ç”¨left outer joinå»è¿æ¥$T_2$</li>
<li>å¦‚æœå¯¹$T_2$çš„joinä¾èµ–äº$D$ï¼Œæˆ‘ä»¬åªèƒ½replicationï¼Œä½¿ç”¨ä¸¤æ¬¡ä»$D$å¼€å§‹çš„dependent joinã€‚</li>
</ul>
<h4 id="Semi-Join-amp-Anti-Join"><a href="#Semi-Join-amp-Anti-Join" class="headerlink" title="Semi Join &amp; Anti Join"></a>Semi Join &amp; Anti Join</h4><p><img data-src="/images/Paper/Unnesting/SemiJoin_AntiJoin.png" alt="SemiJoin_AntiJoin"></p>
<h4 id="Group-By-1"><a href="#Group-By-1" class="headerlink" title="Group By"></a>Group By</h4><p><img data-src="/images/Paper/Unnesting/Group_By.png" alt="Group_By"></p>
<p>æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿè¿™ä¸ªç­‰å¼å·¦å³ä¸¤ä¾§ï¼š</p>
<ul>
<li>å·¦ä¾§è‚¯å®šæ˜¯å¸¦æœ‰$D$ä¸­çš„å­—æ®µ$\mathcal{A}(D)$</li>
<li>å³ä¾§éœ€è¦å¯¹äº$D$ä¸­çš„å­—æ®µï¼Œæ‰€ä»¥éœ€è¦å°†$\mathcal{A}(D)$åŠ å…¥å¯¹åº”çš„<code>group by</code>çš„ä½ç½®ï¼Œç¡®ä¿è¿™äº›å­—æ®µåœ¨group byä¹‹åè¿˜ä¼šå‡ºç°ã€‚</li>
</ul>
<h4 id="Projection"><a href="#Projection" class="headerlink" title="Projection"></a>Projection</h4><p><img data-src="/images/Paper/Unnesting/Projection.png" alt="Projection"></p>
<p>æˆ‘ä»¬ä½¿ç”¨åŒä¸Šçš„è§‚å¯Ÿæ–¹æ³•ã€‚</p>
<h4 id="Set-Operation"><a href="#Set-Operation" class="headerlink" title="Set Operation"></a>Set Operation</h4><p><img data-src="/images/Paper/Unnesting/Set_Operation.png" alt="Set_Operation"></p>
<h2 id="å®ç°ç›¸å…³"><a href="#å®ç°ç›¸å…³" class="headerlink" title="å®ç°ç›¸å…³"></a>å®ç°ç›¸å…³</h2><p>é›†åˆ$D$çš„å…ƒç´ ä¸ªæ•°ä¼šå¾ˆå¤§å—ï¼Ÿ<br>è¿™ä¸ªé—®é¢˜å½“ç„¶å–å†³å®é™…æƒ…å†µ(å®é™…è¡¨æ ¼å’Œå®é™…SQLæŸ¥è¯¢)ã€‚</p>
<p>é¦–å…ˆ: $|D| \leq |T_1|$è¿™ä¸ªç­‰å¼ä¸€ç›´æˆç«‹ã€‚<br>ç„¶åæˆ‘ä»¬å‡è®¾æœ€é«˜å¤„çš„æ˜¯ä¸€ä¸ªhash joinï¼Œè¿™ä¸ªå“ˆå¸Œè¡¨ä¸­ä¿å­˜äº†$T_1$çš„tupelã€‚</p>
<ul>
<li><strong>worst case</strong>: æˆ‘ä»¬éœ€è¦é¢å¤–å­˜å‚¨$D$ï¼Œè€Œå®ƒçš„å¤§å°å’Œ$T_1$ä¸€æ ·ã€‚æ¯”å¦‚æˆ‘ä»¬éœ€è¦å¦å¤–ä¸€ä¸ªå“ˆå¸Œé›†åˆ(hashset)å»æ„å»º$D$è¿™ä¸ªé›†åˆã€‚è¿™ä¸ªæ‰€éœ€è¦çš„å“ˆå¸Œé›†åˆå¤§å°åº”è¯¥å’Œä¹‹å‰çš„å“ˆå¸Œè¡¨å¤„äºåŒä¸€é‡çº§ï¼Œå®ƒä»¬åˆåœ¨ä¸€èµ·çš„ç©ºé—´å¤æ‚åº¦æ˜¯$O(2n)$</li>
<li><strong>best case</strong>: å¦‚æœæˆ‘ä»¬èƒ½é¢„å…ˆçŸ¥é“$T_1$æ˜¯ä¸€ä¸ªä¸å¸¦é‡å¤çš„é›†åˆï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä»schemaçœ‹å‡ºå®ƒæ˜¯keyã€‚é‚£ä¹ˆæˆ‘ä»¬å°±ä¸å¿…å®ä½“åŒ–(materialization)$D$ï¼Œåªéœ€è¦éå†(iterate, probe)ä¸€éæˆ‘ä»¬çš„å“ˆå¸Œè¡¨ã€‚è¿™æ—¶å€™æˆ‘ä»¬æ²¡æœ‰é¢å¤–å­˜å‚¨çš„èŠ±é”€ï¼Œåªç”¨äº†ä¸€ä¸ªå“ˆå¸Œè¡¨ç»™hash joinï¼Œç©ºé—´å¤æ‚åº¦æ˜¯$O(n)$ã€‚</li>
</ul>
<p>æœ€åï¼Œå³ä½¿æ˜¯ä¸Šè¿°çš„worst caseä¹Ÿæ˜¯å€¼å¾—å»å®ç°è¿™ä¸ª<strong>å»å…³è”</strong>åŠŸèƒ½ï¼Œå› ä¸ºå®ƒèƒ½å°†æ—¶é—´å¤æ‚åº¦$O(n^2)$é™è‡³$O(n)$ã€‚å³ä½¿æœ‰å†…å­˜èŠ±é”€(memory overhead)ï¼Œçº¿æ€§çš„æ—¶é—´å¤æ‚åº¦èƒ½å¾ˆå¤§æ”¹å–„è¿è¡Œæ—¶é—´ã€‚</p>
<h2 id="ä¾‹å­ï¼šQ1"><a href="#ä¾‹å­ï¼šQ1" class="headerlink" title="ä¾‹å­ï¼šQ1"></a>ä¾‹å­ï¼šQ1</h2><p>ç›´æ¥å¯¹åº”çš„å…³ç³»ä»£æ•°ï¼š<br><img data-src="/images/Paper/Unnesting/Q1_relation_algebra.png" alt="Q1_relation_algebra"></p>
<p>å¯¹åº”é€‚åˆè½¬åŒ–çš„dependent joinï¼š</p>
<p><img data-src="/images/Paper/Unnesting/Q1'_relation_algebra.png" alt="Q1'_relation_algebra"></p>
<ul>
<li>ä»<em>ç›´æ¥å¯¹åº”çš„å…³ç³»ä»£æ•°</em>ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œdependent joinå³ä¾§åªéœ€è¦<code>s.id</code>è¿™ä¸ªå­—æ®µã€‚</li>
<li>å› æ­¤<em>é€‚åˆè½¬åŒ–çš„dependent join</em>ä¸­ï¼Œdependent joinåªæä¾›äº†å¿…é¡»çš„<code>s.id</code>è¿™ä¸ªå­—æ®µã€‚æˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªæŠ•å½±Projectionå»é™¤äº†å…¶ä»–æ²¡æœ‰å¿…è¦çš„å­—æ®µã€‚</li>
</ul>
<p>å¯¹åº”çš„å…³ç³»ä»£æ•°æ ‘ï¼š</p>
<p><img data-src="/images/Paper/Unnesting/Q1_Step1.png" alt="Q1_Step1"></p>
<p>1.æˆ‘ä»¬æ¶ˆå»äº†é‡å¤(eliminate redundancy)ï¼ŒåŒæ—¶ä¹ŸæŠŠjoinå³ä¾§(right or inner)éœ€è¦çš„å­—æ®µä»joinå·¦ä¾§(left or outer)ä¼ é€’äº†è¿‡å»ã€‚<br>æ›´é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªæœ€é«˜çš„é€šç”¨(generic)dependent joinè½¬åŒ–æˆäº†ä¸€ä¸ªregular joinå’Œä¸€ä¸ª<strong>é€šè¿‡é›†åˆ</strong>$D$çš„dependent joinï¼Œå¼ºè°ƒä¸€ä¸‹é›†åˆ$D$ä¸­è‡ªç„¶æ²¡æœ‰ä»»ä½•é‡å¤çš„å…ƒç´ ã€‚ <a href="#link">å¯¹åº”çš„å‡è®¾</a></p>
<p><img data-src="/images/Paper/Unnesting/Q1_Step2.png" alt="Q1_Step2"></p>
<p>2.æˆ‘ä»¬å°†dependent joinæ¨åˆ°group byä¸‹é¢ã€‚æ³¨æ„éœ€è¦å°†$D$ä¸­çš„å­—æ®µ$\mathcal{A}(D)$åŠ å…¥group byã€‚</p>
<p><img data-src="/images/Paper/Unnesting/Q1_Step3.png" alt="Q1_Step3"></p>
<p>3.æˆ‘ä»¬å°†dependent joinæ¨åˆ°selectionä¸‹é¢ã€‚</p>
<p><img data-src="/images/Paper/Unnesting/Q1_Step4.png" alt="Q1_Step4"></p>
<p>4.è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç”¨regular joinä»£æ›¿dependent joinã€‚Unnestingç»“æŸã€‚</p>
<p><img data-src="/images/Paper/Unnesting/Q1_Step5.png" alt="Q1_Step5"></p>
<p>5.selection push down</p>
<p><img data-src="/images/Paper/Unnesting/Q1_Step6.png" alt="Q1_Step6"></p>
<p>6.å»é™¤åµŒå¥—(decoupling)ï¼Œå¹¶ä¸”å»é™¤æ²¡æœ‰å¿…è¦çš„éƒ¨åˆ†ã€‚ä¸Šä¸€æ­¥å³ä¾§çš„å¯¹$D$çš„joinè¢«æ¶ˆé™¤ã€‚å› ä¸ºæˆ‘ä»¬è§‚å¯Ÿjoinä¹‹åï¼Œ$d.id=e2.sid$æˆç«‹ã€‚è¿™ä¸ªç›®æ ‡å¯ä»¥å¾ˆå¿«ç”¨ä¸€ä¸ª<code>map</code>ç„¶å<code>selection</code>å®Œæˆã€‚<a href="#link2">å¯¹åº”çš„å‡è®¾</a>ï¼Œ <a href="#ä¼˜åŒ–">æ›´å¤šçš„è§£é‡Š</a></p>
<h2 id="ä¾‹å­ï¼šQ2"><a href="#ä¾‹å­ï¼šQ2" class="headerlink" title="ä¾‹å­ï¼šQ2"></a>ä¾‹å­ï¼šQ2</h2><p><img data-src="/images/Paper/Unnesting/Q2.png" alt="Q2"></p>
<p>å¯¹äº$Q2$ï¼Œ$D$ä¸èƒ½è¢«æ¶ˆå»ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ä¸€ä¸ªå¯¹$D$çš„non-euqi joinï¼Œè¿™ç§æƒ…å†µä¸èƒ½ä½¿ç”¨æ¶ˆå»æˆ–ä»£æ›¿(substitution)ã€‚å»é™¤åµŒå¥—(decoupling)ä¹Ÿæ˜¯ä¸å…è®¸çš„ï¼Œå› ä¸º$s.year$ä¸æ˜¯å’Œ$e2.date$è¿›è¡Œequi joinã€‚</p>
<p>è¿™é‡Œå¿…é¡»è¦æåˆ°ä¸€ä¸‹åŸè®ºæ–‡çš„é”™è¯¯ï¼šæœ€ä¸Šé¢çš„joinçš„æ¡ä»¶åº”è¯¥ä¸º<code>e.grade &gt; m + 1 and d.id = s.id  and d.year = e.date and e.curriculum = d.major</code>ã€‚è¿™ä¸ªåœ¨æˆ‘å’Œä¸€ä¸ªåšå£«ç”Ÿçš„è®¨è®ºä¸­è¢«ç¡®è®¤ã€‚</p>
<h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><ul>
<li>Simple Unnestingå¯ä»¥å°†æŸ¥è¯¢ä¸­çš„å…³è”å»é™¤å¾ˆå¹²å‡€ã€‚  </li>
<li>General Unnestingå¿…é¡»ä¸€ä¸ªæŠ•å½±å»è·å¾—é›†åˆ$D$ï¼Œå†å’Œå®ƒjoinã€‚å¯¹åº”çš„èŠ±é”€æ¯”Simple Unnestingå¤§ã€‚å½“ç„¶é›†åˆ$D$æ˜¯å€¼å¾—çš„ï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦è¿›è¡Œ<strong>ä¸€æ¬¡</strong>å¯¹$D$çš„æ±‚å€¼å’Œ<strong>ä¸€æ¬¡</strong>å’Œ$D$çš„joinï¼Œè¿™æ¯”å…³è”queryä¸­çš„$O(n^2)$æ—¶é—´å¤æ‚åº¦è¦ä¼˜åŒ–çš„å¤šã€‚å¦å¤–åœ¨ä¸€äº›æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å®Œå…¨æ¶ˆå»é›†åˆ$D$ï¼Œä¾‹å­æ˜¯<a href="#q1">Q1</a>çš„æœ€åä¸€æ­¥ã€‚</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹ï¼Œå¦‚ä½•åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç”¨ä¸€ä¸ªå·²ç»å­˜åœ¨åœ¨å­—æ®µæ¥ä»£æ›¿(substitute)é›†åˆ$D$ã€‚</p>
<ul>
<li>é¦–å…ˆè¿™ä¸ªä»£æ›¿çš„æƒ…å†µåªèƒ½å‘ç”Ÿåœ¨equi-joinçš„æƒ…å†µï¼Œå³æ¯”è¾ƒä¸¤ä¸ªå­—æ®µæ˜¯å¦ç›¸ç­‰ã€‚ æ¯”å¦‚ $D\bowtie_{D.a=R.b} R$ã€‚æˆ‘ä»¬å¯ä»¥è®©$D$å¯¹åº”å­—æ®µæ˜¯æ•°æ®æˆä¸ºjoinçš„ç»“æœã€‚å½“ç„¶è¿™éƒ¨åˆ†æ•°æ®å¯èƒ½åŒ…å«äº†$R.b$ä¸­æ²¡æœ‰çš„å…ƒç´ ï¼Œä½†æ˜¯è¿™æ ·çš„å…ƒç´ è‡ªç„¶ä¹Ÿä¸ä¼šå‡ºç°åœ¨joinçš„ç»“æœä¸­ã€‚æ‰€ä»¥è¿™æ ·ä¼šå¯¼è‡´ä¸­é—´æ­¥éª¤ç»“æœåå¤šï¼ŒåŒ…å«äº†ä¸€äº›æœ¬ä¸åº”è¯¥å‡ºç°çš„å…ƒç´ ã€‚</li>
<li><p>å¦å¤–æˆ‘ä»¬è¿˜éœ€è¦æ‰¾åˆ°è¢«joinçš„åˆ¤æ–­è°“è¯å’Œfilterçš„åˆ¤æ–­è°“è¯é€ æˆçš„ç­‰ä»·ç±»(equivalence classes)ã€‚æ¯”å¦‚ $\sigma_{a=b}$æ„å‘³ $a$ å’Œ $b$å±äºåŒä¸€ä¸ªç­‰ä»·ç±»ï¼Œå®ƒä»¬æœ‰åŒæ ·çš„æ•°å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ $b$ æ¥ä»£æ›¿ $a$ã€‚<a href="#link3">ä¸€ç‚¹è¡¥å……</a></p>
</li>
<li><p>æ‰¾åˆ°ç­‰ä»·ç±»$C$åï¼Œä¸‹é¢çš„ç­‰å¼æˆç«‹(å‰ææ˜¯$D$æ˜¯ä¸€ä¸ªé›†åˆ)ï¼š<br><img data-src="/images/Paper/Unnesting/substitution.png" alt="substitution"></p>
<ul>
<li>$B$: $T$è¡¨æ ¼ä¸­çš„ä¸€äº›å­—æ®µã€‚($T$è¡¨æ ¼çš„æ‰€æœ‰å­—æ®µ$\mathcal{A}(T)$çš„ä¸€ä¸ªå­é›†)</li>
<li>$\mathcal{A}(D)$: æŒ‡é›†åˆ$D$å¯¹åº”çš„å­—æ®µï¼Œä¹Ÿæ˜¯åœ¨$T$è¡¨æ ¼ä¸­$B$æ˜ å°„å¯¹åº”(map)çš„æ–°å­—æ®µã€‚</li>
<li>$\mathcal{A}(D)$å’Œ$B$å…±å±äºåŒä¸€ä¸ªç­‰ä»·ç±»$C$ã€‚</li>
</ul>
</li>
<li>ä¸Šé¢çš„ç­‰å¼æ„å‘³ï¼šæˆ‘ä»¬ä¸å¿…å¯¹$D$çš„joinæ±‚å€¼ï¼Œè€Œæ˜¯å¯ä»¥ç”¨<code>map</code>è¿ç®—ç¬¦ï¼Œæ‰©å±•$T$è¡¨æ ¼ï¼Œç„¶åé€šè¿‡ç­‰ä»·å­—æ®µ(equivalent attributes)å†è®¡ç®—$D$å¯¹åº”çš„å­—æ®µå€¼(attribute value)ã€‚æˆ‘ä»¬çš„ç”Ÿæˆçš„ä¸­é—´æ­¥éª¤çš„å€¼å¯èƒ½åå¤šï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰çœŸæ­£çš„å¯¹joinçš„æ¡ä»¶è¿›è¡Œåˆ¤æ–­å’Œè¿‡æ»¤ï¼Œå¯¼è‡´ä¸€äº›<strong>ä¸åº”è¯¥è¢«join</strong>å‡ºç°åœ¨æˆ‘ä»¬ä¸­é—´æ­¥éª¤çš„ç»“æœä¸­ã€‚å¯¹äºè¿™äº›å¤šç”Ÿæˆçš„tupelï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ª<code>map</code>è¿ç®—ç¬¦ä¹‹ä¸Šï¼Œæ¯”å¦‚ä½¿ç”¨ä¸€ä¸ª<code>selection</code>è¿ç®—ç¬¦å»è¿‡æ»¤æ‰è¿™äº›å¤šä½™å¹¶é”™è¯¯çš„tupelï¼Œæˆ–è€…ä½¿ç”¨ä¸€ä¸ªå¸¦ç­›é€‰æ¡ä»¶çš„joinã€‚</li>
<li>åŸºäºä¸Šé¢çš„æ‰€æœ‰ç‚¹ï¼Œä»£æ›¿(substitute)åœ¨ä¸$D$é›†åˆjoinç­›é€‰åº¦å¾ˆä½(unselectiveï¼Œå› æ­¤$D$æœ‰å¾ˆå¤šå…ƒç´ )çš„æƒ…å†µä¸‹æ˜¯å€¼å¾—çš„ï¼Œæ¯”å¦‚Q1çš„æƒ…å†µã€‚ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ˜¯å¦å€¼å¾—ç”¨ä»£æ›¿çš„æ–¹å¼ï¼Œè¿™ä¸ªå†³å®šéœ€è¦æŸ¥è¯¢ä¼˜åŒ–å™¨åœ¨æ¯”è¾ƒå„ç§æƒ…å†µä¸‹çš„code modelä»¥åï¼Œæ‰èƒ½çœŸæ­£ä¸‹ç»“è®ºã€‚</li>
</ul>
<hr>
<h1 id="å¦å¤–çš„è¯"><a href="#å¦å¤–çš„è¯" class="headerlink" title="å¦å¤–çš„è¯"></a>å¦å¤–çš„è¯</h1><ul>
<li><h7 id="link"> æˆ‘ä»¬å‡è®¾$D$æ˜¯ä¸€ä¸ªé›†åˆï¼Œå³ä¸åŒ…å«ä»»ä½•é‡å¤å…ƒç´ ã€‚è¿™ç¯‡æ–‡ç« å·²ç»å¯¹åº”è®ºæ–‡ä¸­ï¼Œdependent joinçš„å·¦ä¾§æ˜¯ä¸€ä¸ªé›†åˆï¼Œè¢«æä¾›ç»™å³ä¾§ã€‚è¿™ä¸ªä¼˜åŒ–ä»…ä»…åœ¨$D$æ²¡æœ‰ä¿ç•™SQLçš„åŒ…è¯­ä¹‰(bag semantics)ï¼Œåœ¨queryçš„å…¶ä½™åœ°æ–¹ä»¥åŠæ˜¯ä¿ç•™åŒ…è¯­ä¹‰çš„ã€‚å½“ç„¶å¦‚æœqueryåº”ç”¨äº†`distinct`çš„è¯ï¼Œæˆ‘ä»¬è‡ªç„¶å¯ä»¥ä¸‹æ¨(push down)å¯¹åº”å­—æ®µã€‚</h7>
</li>
<li><h7 id="link2"> æˆ‘ä»¬å‡è®¾$e2.sid$å¯ä»¥æ˜¯NULLå€¼ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ä¿ç•™è¿™ä¸ª`selection`ã€‚å¦‚æœæˆ‘ä»¬çœ‹schemaï¼Œå‘ç°$e2.sid$ä¸å¯èƒ½æ˜¯NULLå€¼(not nullable)ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæƒ…å†µä¸­çš„ç¡®å¯ä»¥å»æ‰è¿™ä¸ªselectionã€‚</h7>
</li>
<li><h7 id="link3"> æœ‰ä¸€ä¸ªä¾‹å¤–æ˜¯outer joinï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„å€¼ï¼Œouter joinä¼šç”Ÿæˆä¸€ä¸ªNULLã€‚æ¯”å¦‚ $D\bowtie_{left outer\;D.a=R.b} R$: å¦‚æœ$D.a$æ²¡æœ‰å¯¹åº”çš„å€¼ï¼Œå®ƒä¼šå’ŒNULLè¿æ¥ã€‚é‚£è‡ªç„¶$D.a$å’ŒNULLä¸ç›¸ç­‰ã€‚å¦‚æœæœ€ä¸Šé¢çš„joinå¦‚æœæ‹’ç»NULLï¼Œé‚£è¿™ä¸ªé—®é¢˜å°±è¢«è§£å†³ã€‚</h7>
</li>
<li><p>Unnestingçš„é‡è¦æ­¥éª¤æ˜¯dependent join push downã€‚å½“æˆ‘ä»¬å®Œæˆunnestingä¹‹åï¼Œå¯¹ç»“æœçš„logical planï¼Œå½“ç„¶å¯ä»¥ç»§ç»­è¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨selection push downå’Œjoin reorderingã€‚è¿™äº›æ˜¯å¯¹æŸ¥è¯¢ä¼˜åŒ–ä¸­ä¸¤ä¸ªå­˜åœ¨å…ˆåé¡ºåºçš„æ­¥éª¤ï¼Œå¹¶ä¸å†²çªã€‚</p>
</li>
<li><p>æœ‰ä¸€äº›éå¸¸å°çš„æƒ…å†µä¸­dependent joinçš„nested evaluationæœ‰æ›´å¥½çš„runtimeè¡¨ç°ã€‚æ¯”å¦‚outer queryçš„è¡¨æ ¼éå¸¸å°ï¼Œè€Œinner query(subquery)æ¶‰åŠçš„è¡¨æ ¼ç‰¹åˆ«å¤§ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨index look upã€‚å½“ç„¶åœ¨åº”è¯¥ä¼šè¢«æŸ¥è¯¢ä¼˜åŒ–å™¨(cost-based optimizer)çš„cost modelè®¡ç®—ä¸­æ„è¯†åˆ°ï¼Œå¦‚æœunnestingçš„èŠ±è´¹(cost)å¾ˆé«˜ï¼Œå¯¹è¿™æ ·çš„æŸ¥è¯¢å°±ä¸è¿›è¡Œunnestingè½¬åŒ–ã€‚</p>
</li>
<li><p>Dependent Anti Joinä¾‹å­: $R: \{[A, \dots, X, \dots]\}$ å’Œ $S: \{[B, \dots, Y, \dots]\}$</p>
</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- Q3</span></span><br><span class="line"><span class="keyword">select</span> R.*</span><br><span class="line"><span class="keyword">from</span> R</span><br><span class="line"><span class="keyword">where</span> R.X = <span class="keyword">all</span> (<span class="keyword">select</span> S.Y</span><br><span class="line">                 <span class="keyword">from</span> S</span><br><span class="line">                 <span class="keyword">where</span> S.B = R.A)</span><br></pre></td></tr></tbody></table></figure>
<p>é¦–å…ˆè¿™ä¸ªSQLæŸ¥è¯¢ä¸å¯èƒ½å»unnestingã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¦å®šè¿™ä¸ªåˆ¤æ–­è°“è¯ï¼Œå†ç”¨ä¸€ä¸ªdependent anti joinå»è¡¨è¾¾è¿™ä¸ªSQLã€‚ç„¶åå†è¿›è¡Œè½¬åŒ–ï¼Œè§ä¸‹å›¾ï¼š<br><img data-src="/images/Paper/Unnesting/anti_join.png" alt="anti_join"></p>
<ul>
<li>Evaluationéƒ¨åˆ†å‚è§åŸè®ºæ–‡ã€‚è¿™ä¸€ç¯‡è®ºæ–‡æ²¡æœ‰æ€§èƒ½æ¯”è¾ƒå›¾è¡¨ï¼Œä»…ä»…åˆ—å‡ºäº†ä¸åŒçš„runtimeã€‚</li>
</ul>
<hr>
<h1 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h1><p>æˆ‘ä»¬å¯ä»¥å¯¹ä»»æ„queryï¼Œåº”ç”¨push downçš„æ–¹æ³•è½¬åŒ–å…¶ä¸­çš„dependent joinã€‚æˆ‘ä»¬å¯ä»¥è·å¾—ä¸€ä¸ªregular joinæˆ–è€…ç›´æ¥ç”¨å­˜åœ¨å­—æ®µå»ä»£æ›¿joinã€‚<br>æ—¶é—´å¤æ‚åº¦ä»$O(n^2)$è¢«ä¼˜åŒ–è‡³$O(n)$ã€‚<br>å¯¹äºå¤§éƒ¨åˆ†å¤§æ•°æ®queryï¼Œè¿™ä¸ªæŸ¥è¯¢ä¼˜åŒ–å™¨ä¸­è¿›è¡Œçš„logical planè½¬åŒ–æ˜¯å®Œå…¨å€¼å¾—çš„ï¼Œåœ¨queryçš„runtimeæˆ‘ä»¬å¯ä»¥æŠŠè¿™è½¬åŒ–æ‰€èŠ±çš„æ—¶é—´å®Œå…¨èµ¢å›æ¥ã€‚<br>å› ä¸ºdependent joinå‡ ä¹åªèƒ½ç”¨nested loop join(å…³ç³»ä»£æ•°ä¸­çš„é›†åˆç¬›å¡å°”ç§¯)å®ç°ï¼Œæ—¶é—´å¤æ‚åº¦åœ¨<code>O(n^2)</code>ã€‚<br>è€Œè½¬åŒ–åçš„ç‰ˆæœ¬çš„æœ€å¥½æƒ…å†µ(best case)çš„æ—¶é—´å¤æ‚åº¦æ˜¯<code>O(n)</code>,åœ¨æ•°æ®é‡å¤§æƒ…å†µä¸‹ï¼Œå¯ä»¥æœ‰å¤šæ•°é‡çº§çš„runtimeåŠ é€Ÿã€‚<br>å¦å¤–ä»å·¥ç¨‹çš„è§’åº¦ï¼Œä¸ç›¸å…³çš„å­æŸ¥è¯¢å®Œå…¨å¯ä»¥ä½¿ç”¨æœ‰æ•ˆçš„å®ç°æ–¹å¼ï¼Œæ¯”å¦‚æ— é”å¤šçº¿ç¨‹æˆ–é«˜æ•ˆçš„joinç®—æ³•ã€‚<br>è¿™å¤§å¤§æé«˜äº†ç³»ç»Ÿçš„å¯ç¼©æ”¾æ€§(Scalability)å’Œå¯¹ä¸»æµCPUçš„é€‚åº”æ€§ã€‚  </p>
<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ol>
<li><span class="exturl" data-url="aHR0cHM6Ly9kbC5naS5kZS9iaXRzdHJlYW0vaGFuZGxlLzIwLjUwMC4xMjExNi8yNDE4LzM4My5wZGY/c2VxdWVuY2U9MQ==" title="https://dl.gi.de/bitstream/handle/20.500.12116/2418/383.pdf?sequence=1">Unnesting Arbitrary Queries - Thomas Neumann and Alfons Kemper - (BTW 2015)<i class="fa fa-external-link"></i></span></li>
</ol>
<!-- è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Paper</category>
        <category>Query Optimizer</category>
      </categories>
      <tags>
        <tag>Paper</tag>
        <tag>Query Optimizer</tag>
        <tag>Subquery Optimization</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(2)</title>
    <url>/2020/02/25/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-2/</url>
    <content><![CDATA[<p>åœ¨è¿™ç¯‡æ–‡ç« <strong>é«˜çº§SQL</strong>ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå…¬å…±äº¤é€šæ•°æ®é›†ï¼Œæœ€åæˆ‘ä»¬è¿˜æ˜¯å¯¹<code>union</code>å’Œ<code>union all</code>åœ¨å›¾è®ºçš„ä¾‹å­ä¸­è¿›è¡Œç»ƒä¹ å’ŒåŒºåˆ†ã€‚</p>
<a id="more"></a>
<h1 id="ç¬¬äºŒéƒ¨åˆ†æ•°æ®é›†-å…¬å…±äº¤é€š-Schema"><a href="#ç¬¬äºŒéƒ¨åˆ†æ•°æ®é›†-å…¬å…±äº¤é€š-Schema" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†æ•°æ®é›† - å…¬å…±äº¤é€š Schema"></a>ç¬¬äºŒéƒ¨åˆ†æ•°æ®é›† - å…¬å…±äº¤é€š Schema</h1><p>å…¬å…±äº¤é€šæ•°æ®é›†<code>Fahrplan</code>åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p><strong>æœ¬åœ°è½½å…¥æ”¹æ•°æ®é›†</strong>ï¼š <span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAyMTYyMzY5MyNpdGVtLTMtMw==" title="https://segmentfault.com/a/1190000021623693#item-3-3">https://segmentfault.com/a/1190000021623693#item-3-3<i class="fa fa-external-link"></i></span></p>
<p>è‹±æ–‡Schemaï¼š <script type="math/tex">Fahrplan = \{\underline{From\_, To\_, Line\_}, depart, arrival\}</script></p>
<p>å¾·æ–‡Schemaï¼š <script type="math/tex">Fahrplan = \{\underline{Von, Nach, Linie}, Abfahrt, Ankunft\}</script></p>
<p>æœ‰å…³è‹±æ–‡Schemaï¼šåœ¨<span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAyMTYyMzY5MyNpdGVtLTMtMw==" title="https://segmentfault.com/a/1190000021623693#item-3-3">æˆ‘çš„æ–‡ç« <i class="fa fa-external-link"></i></span>æåˆ°è¿™ä¸€å—å†…å®¹ã€‚å¾·æ–‡schemaå¯ä»¥ç›´æ¥åœ¨HyPerç½‘é¡µæ¥å£è¿è¡Œã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿å¤§å®¶ç›´æ¥åœ¨ç½‘é¡µä¸Šè¿è¡Œï¼Œæˆ‘é‡‡ç”¨å¾·æ–‡schemaã€‚<br><!-- TODO:é“¾æ¥åˆ°blog --></p>
<p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p>
<p>è¯¾ä»¶ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li>
</ul>
<p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<h2 id="ç†Ÿæ‚‰æ•°æ®é›†"><a href="#ç†Ÿæ‚‰æ•°æ®é›†" class="headerlink" title="ç†Ÿæ‚‰æ•°æ®é›†"></a>ç†Ÿæ‚‰æ•°æ®é›†</h2><p>é¦–å…ˆæˆ‘ä»¬å…ˆè¿è¡Œä¸€äº›ç®€å•SQLï¼Œæ¥è®¤è¯†ä¸€ä¸‹è¿™ä¸ªæ•°æ®é›†å†…ä¹‹é—´çš„å…³ç³»ã€‚</p>
<ul>
<li><code>von</code>è¿™ä¸€è¡Œå­—ç¬¦ä¸²(string)åŒ¹é…ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> von</span><br><span class="line"><span class="keyword">from</span> fahrplan</span><br><span class="line"><span class="keyword">where</span> von <span class="keyword">like</span> <span class="string">'%Garching%'</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">             von             </span><br><span class="line">-----------------------------</span><br><span class="line">Garching</span><br><span class="line">Garching, Forschungszentrum</span><br><span class="line">Garching-HochbrÃ¼ck</span><br><span class="line">(3 rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>case</code></li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> linie,</span><br><span class="line">       <span class="keyword">case</span></span><br><span class="line">           <span class="keyword">when</span> linie <span class="keyword">like</span> <span class="string">'U%'</span> <span class="keyword">then</span> <span class="string">'U-Bahn'</span></span><br><span class="line">           <span class="keyword">when</span> linie <span class="keyword">like</span> <span class="string">'S%'</span> <span class="keyword">then</span> <span class="string">'S-Bahn'</span></span><br><span class="line">           <span class="keyword">else</span> <span class="string">'Bus/Tram'</span></span><br><span class="line">           <span class="keyword">end</span> <span class="keyword">as</span> public_transportation</span><br><span class="line"><span class="keyword">from</span> fahrplan</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line"> linie | public_transportation </span><br><span class="line">-------+-----------------------</span><br><span class="line"> U6    | U-Bahn</span><br><span class="line"> U6    | U-Bahn</span><br><span class="line"> U6    | U-Bahn</span><br><span class="line"> U6    | U-Bahn</span><br><span class="line"> U6    | U-Bahn</span><br><span class="line"> U6    | U-Bahn</span><br><span class="line"> 690   | Bus/Tram</span><br><span class="line">(7 rows)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ±‚ä»<code>Garching, Forschungszentrum</code>å‡ºå‘ï¼Œæˆ‘ä»¬ç°åœ¨(<code>current_time</code>)èƒ½èµ¶ä¸Šçš„äº¤é€šå·¥å…·ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> fahrplan</span><br><span class="line"><span class="keyword">where</span> abfahrt &gt; <span class="keyword">current_time</span> <span class="keyword">and</span> von = <span class="string">'Garching, Forschungszentrum'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> abfahrt</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢ä¸¤ä¸ªè½¦ç«™ï¼Œè¿™ä¿©ä¹‹é—´éœ€è¦3åˆ†é’Ÿåˆ°5åˆ†é’Ÿèƒ½å¤Ÿåˆ°è¾¾(æ³¨æ„ç¬¬ä¸€å¤©åˆå¤œå‘è½¦ï¼Œç¬¬äºŒå¤©å‡Œæ™¨åˆ°è¾¾çš„æƒ…å†µ):</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">duration</span> <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *,</span><br><span class="line">    (<span class="keyword">case</span> <span class="keyword">when</span> ankunft &lt; abfahrt <span class="keyword">then</span> <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> - <span class="keyword">extract</span>(epoch <span class="keyword">from</span> abfahrt - ankunft)</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">extract</span>(epoch <span class="keyword">from</span> ankunft - abfahrt)</span><br><span class="line">    <span class="keyword">end</span>) <span class="keyword">as</span> duration_in_sec</span><br><span class="line">    <span class="keyword">from</span> fahrplan</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">duration</span></span><br><span class="line"><span class="keyword">where</span> duration_in_sec <span class="keyword">between</span> <span class="number">3</span>*<span class="number">60</span> <span class="keyword">and</span> <span class="number">5</span>*<span class="number">60</span></span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">duration</span> <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *,</span><br><span class="line">    (<span class="keyword">case</span> <span class="keyword">when</span> ankunft &lt; abfahrt <span class="keyword">then</span> <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> - <span class="keyword">extract</span>(epoch <span class="keyword">from</span> abfahrt - ankunft)</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">extract</span>(<span class="keyword">minute</span> <span class="keyword">from</span> ankunft - abfahrt)</span><br><span class="line">    <span class="keyword">end</span>) <span class="keyword">as</span> duration_in_min</span><br><span class="line">    <span class="keyword">from</span> fahrplan</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">duration</span></span><br><span class="line"><span class="keyword">where</span> duration_in_min <span class="keyword">between</span> <span class="number">3</span> <span class="keyword">and</span> <span class="number">5</span></span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<p>å¾ˆæ˜¾ç„¶ä¸‹é¢çš„å†™æ³•ä¼šå¿½ç•¥<strong>ç¬¬ä¸€å¤©åˆå¤œå‘è½¦ï¼Œç¬¬äºŒå¤©å‡Œæ™¨åˆ°è¾¾çš„æƒ…å†µ</strong>:</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> fahrplan</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">extract</span>(epoch <span class="keyword">from</span> ankunft - abfahrt) <span class="keyword">between</span> <span class="number">3</span>*<span class="number">60</span> <span class="keyword">and</span> <span class="number">5</span>*<span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> fahrplan</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">extract</span>(<span class="keyword">minute</span> <span class="keyword">from</span> ankunft - abfahrt) <span class="keyword">between</span> <span class="number">3</span> <span class="keyword">and</span> <span class="number">5</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥ï¼š"><a href="#åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥ï¼š" class="headerlink" title="åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥ï¼š"></a>åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥ï¼š</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> fahrplan_rec <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- von -&gt; nach</span></span><br><span class="line">    <span class="keyword">select</span> von, nach, abfahrt, ankunft <span class="keyword">from</span> fahrplan</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="comment">-- fr. von -&gt; fr.nach = f.von -&gt; f.nach å¤šèµ°ä¸€æ­¥</span></span><br><span class="line">    <span class="comment">-- ä»fr.vonåˆ°f.nach</span></span><br><span class="line">    <span class="keyword">select</span> fr.von, f.nach, fr.abfahrt, f.ankunft</span><br><span class="line">    <span class="keyword">from</span> fahrplan_rec fr, fahrplan f</span><br><span class="line">    <span class="keyword">where</span> fr.nach = f.von <span class="keyword">and</span> fr.ankunft &lt;= f.abfahrt <span class="keyword">and</span> fr.von != f.nach <span class="comment">-- ä¸èƒ½æ˜¯ç¯</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> fahrplan_rec</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>fr.ankunft &lt;= f.abfahrt</code>ï¼šæˆ‘ä»¬çš„å‰æ</li>
<li><code>fr.von != f.nach</code>: æ’é™¤æˆ‘ä»¬ä»Aåˆ°A(å³æˆç¯çš„æƒ…å†µ)ã€‚</li>
</ul>
<h2 id="åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥-ä¹˜è½¦æ—¶é—´-ï¼‹-ç­‰è½¦æ—¶é—´ï¼š"><a href="#åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥-ä¹˜è½¦æ—¶é—´-ï¼‹-ç­‰è½¦æ—¶é—´ï¼š" class="headerlink" title="åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥ + ä¹˜è½¦æ—¶é—´ ï¼‹ ç­‰è½¦æ—¶é—´ï¼š"></a>åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥ + ä¹˜è½¦æ—¶é—´ ï¼‹ ç­‰è½¦æ—¶é—´ï¼š</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> fahrplan_rec_linie <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- von -&gt; nach</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        von,</span><br><span class="line">        nach,</span><br><span class="line">        abfahrt,</span><br><span class="line">        ankunft,</span><br><span class="line">        ankunft - abfahrt <span class="keyword">as</span> fahrtzeit,</span><br><span class="line">        <span class="built_in">INTERVAL</span> <span class="string">'00:00:00'</span> <span class="keyword">as</span> wartezeit</span><br><span class="line">    <span class="keyword">from</span> fahrplan</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="comment">-- fr. von -&gt; fr.nach = f.von -&gt; f.nach å¤šèµ°ä¸€æ­¥</span></span><br><span class="line">    <span class="comment">-- ä»fr.vonåˆ°f.nach</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        fr.von,</span><br><span class="line">        f.nach,</span><br><span class="line">        fr.abfahrt,</span><br><span class="line">        f.ankunft,</span><br><span class="line">        fr.fahrtzeit + (f.ankunft - f.abfahrt),</span><br><span class="line">        fr.wartezeit + (f.abfahrt - fr.ankunft)</span><br><span class="line">        <span class="keyword">from</span> fahrplan_rec_linie fr, fahrplan f</span><br><span class="line">    <span class="keyword">where</span> fr.nach = f.von <span class="keyword">and</span> fr.ankunft &lt;= f.abfahrt <span class="keyword">and</span> fr.von != f.nach</span><br><span class="line">), fahrplan_rec <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        von,</span><br><span class="line">        nach,</span><br><span class="line">        abfahrt,</span><br><span class="line">        ankunft,</span><br><span class="line">        fahrtzeit,</span><br><span class="line">        wartezeit,</span><br><span class="line">        fahrtzeit + wartezeit <span class="keyword">as</span> reisezeit</span><br><span class="line">    <span class="keyword">from</span> fahrplan_rec_linie</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> fahrplan_rec</span><br></pre></td></tr></tbody></table></figure>
<h2 id="åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥-ä¹˜è½¦æ—¶é—´-ï¼‹-ç­‰è½¦æ—¶é—´-è½¬ä¹˜æ¬¡æ•°ï¼š"><a href="#åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥-ä¹˜è½¦æ—¶é—´-ï¼‹-ç­‰è½¦æ—¶é—´-è½¬ä¹˜æ¬¡æ•°ï¼š" class="headerlink" title="åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥ + ä¹˜è½¦æ—¶é—´ ï¼‹ ç­‰è½¦æ—¶é—´ + è½¬ä¹˜æ¬¡æ•°ï¼š"></a>åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å…¬å…±äº¤é€šè¿æ¥ + ä¹˜è½¦æ—¶é—´ ï¼‹ ç­‰è½¦æ—¶é—´ + è½¬ä¹˜æ¬¡æ•°ï¼š</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> fahrplan_rec_linie <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- von -&gt; nach</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        von,</span><br><span class="line">        nach,</span><br><span class="line">        abfahrt,</span><br><span class="line">        ankunft,</span><br><span class="line">        linie <span class="keyword">as</span> aktuelle_linie,</span><br><span class="line">        <span class="number">0</span> <span class="keyword">as</span> umstiege,</span><br><span class="line">        ankunft - abfahrt <span class="keyword">as</span> fahrtzeit,</span><br><span class="line">        <span class="built_in">INTERVAL</span> <span class="string">'00:00:00'</span> <span class="keyword">as</span> wartezeit</span><br><span class="line">    <span class="keyword">from</span> fahrplan</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="comment">-- fr. von -&gt; fr.nach = f.von -&gt; f.nach å¤šèµ°ä¸€æ­¥</span></span><br><span class="line">    <span class="comment">-- ä»fr.vonåˆ°f.nach</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        fr.von,</span><br><span class="line">        f.nach,</span><br><span class="line">        fr.abfahrt,</span><br><span class="line">        f.ankunft,</span><br><span class="line">        f.linie,</span><br><span class="line">        fr.umstiege +</span><br><span class="line">            <span class="keyword">case</span></span><br><span class="line">                <span class="keyword">when</span> f.linie != fr.aktuelle_linie <span class="keyword">or</span> f.abfahrt &gt; fr.ankunft <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span>,</span><br><span class="line">        fr.fahrtzeit + (f.ankunft - f.abfahrt),</span><br><span class="line">        fr.wartezeit + (f.abfahrt - fr.ankunft)</span><br><span class="line">        <span class="keyword">from</span> fahrplan_rec_linie fr, fahrplan f</span><br><span class="line">    <span class="keyword">where</span> fr.nach = f.von <span class="keyword">and</span> fr.ankunft &lt;= f.abfahrt <span class="keyword">and</span> fr.von != f.nach</span><br><span class="line">), fahrplan_rec <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        von,</span><br><span class="line">        nach,</span><br><span class="line">        abfahrt,</span><br><span class="line">        ankunft,</span><br><span class="line">        umstiege,</span><br><span class="line">        fahrtzeit,</span><br><span class="line">        wartezeit,</span><br><span class="line">        fahrtzeit + wartezeit <span class="keyword">as</span> reisezeit</span><br><span class="line">    <span class="keyword">from</span> fahrplan_rec_linie</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> fahrplan_rec</span><br></pre></td></tr></tbody></table></figure>
<h2 id="10-30ä¹‹å‰ä»Frottmaningåˆ°è¾¾Garching-Forschungszentrum"><a href="#10-30ä¹‹å‰ä»Frottmaningåˆ°è¾¾Garching-Forschungszentrum" class="headerlink" title="10:30ä¹‹å‰ä»FrÃ¶ttmaningåˆ°è¾¾Garching, Forschungszentrum"></a>10:30ä¹‹å‰ä»<code>FrÃ¶ttmaning</code>åˆ°è¾¾<code>Garching, Forschungszentrum</code></h2><p>æˆ‘ä»¬éœ€è¦ä¸€æ¬¡å¥½çš„å…¬å…±äº¤é€šï¼šæœ€è¿Ÿéœ€è¦åœ¨10:30åˆ°è¾¾ï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•ä¸€ä¸ªå¦å¤–çš„å…¬å…±äº¤é€šè¿Ÿå‡ºå‘ä½†æ˜¯ä¹Ÿèƒ½åœ¨10:30ä¹‹å‰åˆ°, è€Œä¸”æ€»æ—¶é—´æ›´å°‘, è€Œä¸”æ¢ä¹˜æ•°ä¹Ÿæ›´å°‘ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> fahrplan_rec_linie <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- von -&gt; nach</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        von,</span><br><span class="line">        nach,</span><br><span class="line">        abfahrt,</span><br><span class="line">        ankunft,</span><br><span class="line">        linie <span class="keyword">as</span> aktuelle_linie,</span><br><span class="line">        <span class="number">0</span> <span class="keyword">as</span> umstiege,</span><br><span class="line">        ankunft - abfahrt <span class="keyword">as</span> fahrtzeit,</span><br><span class="line">        <span class="built_in">INTERVAL</span> <span class="string">'00:00:00'</span> <span class="keyword">as</span> wartezeit</span><br><span class="line">    <span class="keyword">from</span> fahrplan</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="comment">-- fr. von -&gt; fr.nach = f.von -&gt; f.nach å¤šèµ°ä¸€æ­¥</span></span><br><span class="line">    <span class="comment">-- ä»fr.vonåˆ°f.nach</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        fr.von,</span><br><span class="line">        f.nach,</span><br><span class="line">        fr.abfahrt,</span><br><span class="line">        f.ankunft,</span><br><span class="line">        f.linie,</span><br><span class="line">        fr.umstiege +</span><br><span class="line">            <span class="keyword">case</span></span><br><span class="line">                <span class="keyword">when</span> f.linie != fr.aktuelle_linie <span class="keyword">or</span> f.abfahrt &gt; fr.ankunft <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span>,</span><br><span class="line">        fr.fahrtzeit + (f.ankunft - f.abfahrt),</span><br><span class="line">        fr.wartezeit + (f.abfahrt - fr.ankunft)</span><br><span class="line">        <span class="keyword">from</span> fahrplan_rec_linie fr, fahrplan f</span><br><span class="line">    <span class="keyword">where</span> fr.nach = f.von <span class="keyword">and</span> fr.ankunft &lt;= f.abfahrt <span class="keyword">and</span> fr.von != f.nach</span><br><span class="line">), fahrplan_rec <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        von,</span><br><span class="line">        nach,</span><br><span class="line">        abfahrt,</span><br><span class="line">        ankunft,</span><br><span class="line">        umstiege,</span><br><span class="line">        fahrtzeit,</span><br><span class="line">        wartezeit,</span><br><span class="line">        fahrtzeit + wartezeit <span class="keyword">as</span> reisezeit</span><br><span class="line">    <span class="keyword">from</span> fahrplan_rec_linie</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> fahrplan_rec fr</span><br><span class="line"><span class="keyword">where</span> fr.von = <span class="string">'FrÃ¶ttmaning'</span> <span class="keyword">and</span> fr.nach = <span class="string">'Garching, Forschungszentrum'</span></span><br><span class="line">      <span class="keyword">and</span> fr.ankunft &lt;= <span class="built_in">TIME</span> <span class="string">'10:30:00'</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">          <span class="keyword">select</span> * <span class="keyword">from</span> fahrplan_rec fr2</span><br><span class="line">          <span class="keyword">where</span> fr2.von = fr.von <span class="keyword">and</span> fr2.nach = fr.nach <span class="keyword">and</span> fr2.ankunft &lt;= <span class="built_in">TIME</span> <span class="string">'10:30:00'</span> <span class="keyword">and</span></span><br><span class="line">                fr2.abfahrt &gt; fr.abfahrt <span class="keyword">and</span> fr2.reisezeit &lt; fr.reisezeit <span class="keyword">and</span> fr2.umstiege &lt; fr.umstiege</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure>
<hr>
<h2 id="union-vs-union-all"><a href="#union-vs-union-all" class="headerlink" title="ã€€union vs. union all"></a>ã€€<code>union</code> vs. <code>union all</code></h2><p>ä¸‹é¢æˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹å›¾è®º(graph theory)æ¥åŠ å¼ºå¯¹<code>union</code>å’Œ<code>union all</code>çš„å°è±¡ã€‚</p>
<h3 id="æ±‚ä»Garching-Forschungszentrumèƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹-å¯åˆ°è¾¾æ€§-st-connectivity-ï¼š"><a href="#æ±‚ä»Garching-Forschungszentrumèƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹-å¯åˆ°è¾¾æ€§-st-connectivity-ï¼š" class="headerlink" title="æ±‚ä»Garching, Forschungszentrumèƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹(å¯åˆ°è¾¾æ€§(st-connectivity))ï¼š"></a>æ±‚ä»<code>Garching, Forschungszentrum</code>èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹(å¯åˆ°è¾¾æ€§(st-connectivity))ï¼š</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> closure <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> von, nach</span><br><span class="line">    <span class="keyword">from</span> fahrplan</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    <span class="keyword">select</span> c.von, f.nach</span><br><span class="line">    <span class="keyword">from</span> closure c, fahrplan f</span><br><span class="line">    <span class="keyword">where</span> c.nach = f.von</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> von, nach</span><br><span class="line"><span class="keyword">from</span> closure</span><br><span class="line"><span class="keyword">where</span> von = <span class="string">'Garching, Forschungszentrum'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> nach</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œåªèƒ½æ˜¯<code>union</code>ï¼Œä¸èƒ½æ˜¯<code>union all</code>ã€‚<br>æ¯”å¦‚æœ‰<code>A-&gt;B, B-&gt;A</code>åœ¨<code>union all</code>çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šç»ˆæ­¢ã€‚</p>
<h3 id="æ±‚ä»Garchingä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š"><a href="#æ±‚ä»Garchingä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š" class="headerlink" title="æ±‚ä»Garchingä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š"></a>æ±‚ä»<code>Garching</code>ä»ä¸¤ä¸ªæ–¹å‘èƒ½åˆ°è¾¾çš„æ‰€æœ‰åœ°æ–¹ï¼š</h3><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> closure <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> von, nach</span><br><span class="line">    <span class="keyword">from</span> fahrplan</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    <span class="keyword">select</span> f.von , c.nach</span><br><span class="line">    <span class="keyword">from</span> fahrplan f, closure c</span><br><span class="line">    <span class="keyword">where</span> f.nach = c.von</span><br><span class="line">) , connected_graph <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> von, nach</span><br><span class="line">    <span class="keyword">from</span> fahrplan</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- Set(é›†åˆ)</span></span><br><span class="line">    <span class="keyword">select</span> c.von , cg.nach</span><br><span class="line">    <span class="keyword">from</span> closure c , connected_graph cg</span><br><span class="line">    <span class="keyword">where</span> c.nach = cg.von</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> *</span><br><span class="line"><span class="keyword">from</span> connected_graph</span><br><span class="line"><span class="keyword">where</span> von = <span class="string">'Garching'</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> von;</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Recursion</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]é«˜çº§SQL-é€’å½’(1)</title>
    <url>/2020/02/25/SQL-%E9%AB%98%E7%BA%A7SQL-%E9%80%92%E5%BD%92-1/</url>
    <content><![CDATA[<p>åœ¨è¿™ç¯‡æ–‡ç« <strong>é«˜çº§SQL</strong>ä¸­æˆ‘ä»¬ä¼šé‡åˆ°é€’å½’æŸ¥è¯¢ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å¯¹é€’å½’è¿›è¡Œä¸€ä¸ªåˆæ­¥ä»‹ç»ï¼Œç„¶åç”¨SQLçš„é€’å½’å®ç°ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­çš„é€’å½’å‡½æ•°ï¼Œå†å¯¹å¤§å­¦æ•°æ®é›†è¿›è¡Œé€’å½’çš„æŸ¥è¯¢ã€‚</p>
<a id="more"></a>
<h1 id="é€’å½’-Recursion"><a href="#é€’å½’-Recursion" class="headerlink" title="é€’å½’ Recursion"></a>é€’å½’ Recursion</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨å¹¶ä»‹ç»PostgreSQLçš„SQLé€’å½’(Recursion)è¯­æ³•ã€‚<br>é€’å½’åŒæ—¶æ˜¯ä¸€ä¸ªæ•°æ®åº“ä¹‹å†…æœ‰è¯­æ³•syntaxå·®å¼‚çš„åœ°æ–¹ï¼Œå¯èƒ½æ¯ä¸€ä¸ªæ•°æ®åº“éƒ½å®ç°äº†é€’å½’ï¼Œä½†æ˜¯å…³é”®è¯<code>key word</code>ä¸ä¸€æ ·ã€‚æ¯”å¦‚ä¸€ä¸ª<code>Oracle</code>çš„SQLï¼šä½¿ç”¨<code>CONNECT BY</code>å…³é”®è¯å»å®ç°é€’å½’ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« (æˆ–è€…æˆ‘çš„SQLæ–‡ç« ç³»åˆ—)ä¸»è¦ä»‹ç»å¦‚æœä½¿ç”¨SQLè¯­å¥ï¼Œè€Œä¸”é‡ç‚¹åœ¨ä½¿ç”¨æ•°æ®é›†æ¥ç”¨SQLæ¥è§£å†³ä¸€äº›æŸ¥è¯¢é—®é¢˜ã€‚è¿™ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šå…ˆå¤§è‡´ä»‹ç»ä¸€ä¸‹SQLé€’å½’çš„ç»“æ„ï¼Œç„¶åä¼šç”¨å¤šç§æ•°æ®é›†è¿›è¡Œç»ƒä¹ ï¼ŒåŠ æ·±å°è±¡ã€‚</p>
<h2 id="SQLé€’å½’ç»“æ„"><a href="#SQLé€’å½’ç»“æ„" class="headerlink" title="SQLé€’å½’ç»“æ„"></a>SQLé€’å½’ç»“æ„</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> tmp_name (att1, att2, ...) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- basic case</span></span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- union / union all</span></span><br><span class="line">    <span class="comment">-- recursive case</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>å¯ä»¥å†ç¨å¾®ä»”ç»†ä¸€äº›ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> tmp_name (att1, att2, ...) <span class="keyword">as</span> (</span><br><span class="line">    <span class="comment">-- basic case</span></span><br><span class="line">    <span class="keyword">select</span> ... <span class="keyword">from</span> ...</span><br><span class="line">    <span class="keyword">union</span> <span class="comment">-- union / union all</span></span><br><span class="line">    <span class="comment">-- recursive case</span></span><br><span class="line">    <span class="keyword">select</span> ... <span class="keyword">from</span> ..., tmp_name </span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>é‡ç‚¹æ˜¯<code>recursive case</code>ä¸­æˆ‘ä»¬åœ¨ä½¿ç”¨<code>tmp_name</code>ï¼Œè€Œè¿™ä¸ªæ­£æ˜¯æˆ‘ä»¬æ­£åœ¨å®šä¹‰çš„è¡¨æ ¼ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯é€’å½’çš„æ ¸å¿ƒ(æˆ‘ä»¬åœ¨å®šä¹‰è¿™ä¸ªè¡¨æ ¼çš„æ—¶å€™ï¼Œä¹Ÿç”¨åˆ°äº†è¿™ä¸ªè¡¨æ ¼è‡ªå·±)ã€‚<code>with recursive</code>è¿™ä¸ªå…³é”®è¯ç”¨é€’å½’çš„æ–¹å¼æ–°å»ºäº†ä¸€ä¸ªæš‚æ—¶çš„è¡¨æ ¼<code>tmp_name</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¹‹åç”¨ã€‚</p>
<p>è¿™ä¸ªå®šä¹‰å…¶å®å’Œå›¾è®º(Graph theory)ä¸­çš„<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVHJhbnNpdGl2ZV9jbG9zdXJl" title="https://en.wikipedia.org/wiki/Transitive_closure">ä¼ é€’é—­åŒ…(Transitive closure)<i class="fa fa-external-link"></i></span>å’Œ<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3QtY29ubmVjdGl2aXR5" title="https://en.wikipedia.org/wiki/St-connectivity">å¯åˆ°è¾¾æ€§(st-connectivity)<i class="fa fa-external-link"></i></span>å¾ˆç±»ä¼¼ã€‚</p>
<h2 id="SQLé€’å½’å†…éƒ¨å¤„ç†"><a href="#SQLé€’å½’å†…éƒ¨å¤„ç†" class="headerlink" title="SQLé€’å½’å†…éƒ¨å¤„ç†"></a>SQLé€’å½’å†…éƒ¨å¤„ç†</h2><p>åœ¨SQLå¼•æ“å†…éƒ¨ï¼Œé€’å½’å¹¶ä¸æ˜¯çœŸæ­£çš„è¢«â€é€’å½’åœ°å¤„ç†â€ã€‚â€é€’å½’åœ°å¤„ç†â€æŒ‡ï¼šæ¯ä¸€æ¬¡æ–°å»ºä¸€ä¸ªcall stackï¼Œç„¶åç»§ç»­è¿›è¡ŒåŒä¸€ä¸ªå‡½æ•°ä½¿ç”¨ä¸åŒå‚æ•°çš„è¿ç®—ã€‚è¿™ä¸ªæˆ‘ä»¬å¯ä»¥å¾ˆ<code>black box</code>åœ°å»æµ‹è¯•ï¼šå†™ä¸€ä¸ªä¸ç»ˆæ­¢çš„é€’å½’ï¼Œä½†æ˜¯å®ƒæœ€åä»…ä»…åªæ˜¯ä¸ç»ˆæ­¢ï¼Œè€Œä¸æ˜¯stack overflowã€‚è¿™å¯ä»¥é—´æ¥çš„è¯´æ˜é€’å½’æ˜¯è¢«å†…éƒ¨å¤„ç†æˆä¸€ä¸ªç±»ä¼¼<code>while</code>çš„å¾ªç¯ã€‚</p>
<h2 id="union-vs-union-all"><a href="#union-vs-union-all" class="headerlink" title="union vs. union all"></a><code>union</code> vs. <code>union all</code></h2><ul>
<li><p><code>union</code>: å¯¹ä¸¤ä¸ªé›†åˆè¿›è¡Œå¹¶é›†æ“ä½œï¼Œé™¤å»é‡å¤è¡Œ(å³é›†åˆè¯­ä¹‰ Set Semantics)ï¼ŒåŒæ—¶è¿›è¡Œé»˜è®¤è§„åˆ™(ç¬¬ä¸€åˆ—å‡åº)çš„æ’åºã€‚</p>
</li>
<li><p><code>union all</code>: å¯¹ä¸¤ä¸ªé›†åˆè¿›è¡Œå¹¶é›†æ“ä½œï¼Œä¸é™¤å»é‡å¤è¡Œ(å³åŒ…è¯­ä¹‰ Bag Semantics)ï¼Œä¸è¿›è¡Œæ’åºã€‚</p>
</li>
</ul>
<p>å¾ˆæ˜¾ç„¶<code>union all</code>åšçš„æ“ä½œç›¸å¯¹è¾ƒå°‘ï¼Œæ‰€ä»¥å®ƒé€Ÿåº¦æ›´å¿«(å¦‚æœæ•°æ®é‡ç›¸åŒï¼Œä¹Ÿæ— é‡å¤ç”Ÿæˆçš„å‰æä¸‹)ã€‚ä½†æ˜¯<code>union all</code>å¾ˆå¯èƒ½åœ¨é€’å½’çš„æƒ…å†µå¯¼è‡´SQLæ— æ³•ç»ˆæ­¢ï¼ŒåŸå› å°±æ˜¯ä¸æ–­æœ‰(é‡å¤çš„)tupleè¢«ç”Ÿæˆã€‚è¿™ä¸€ç‚¹ä¹Ÿå’Œä¸Šä¸€ç‚¹æœ‰ç›¸å…³:<strong>é€’å½’å…¶å®æ˜¯è¢«å¤„ç†æˆå¾ªç¯</strong>ã€‚</p>
<p>ä¸€ä¸ªå°å°çš„ä¾‹å­æ˜¯ï¼š<br>å‡è®¾$A$å·²ç»åœ¨ç»“æœçš„é›†åˆé‡Œé¢ï¼Œä½†æ˜¯ä¸‹ä¸€æ­¥åˆäº§ç”Ÿä¸€ä¸ªæ–°çš„$A$ã€‚</p>
<ul>
<li>å¯¹äº<code>union</code>ï¼Œå®ƒå¯ä»¥å‘ç°è¿™ä¸ªé›†åˆå¹¶ä¸ä¼šå¢åŠ æ–°å…ƒç´ ï¼Œé‚£ä¹ˆè¿™ä¸ªSQLå¼•æ“å†…éƒ¨çš„å¾ªç¯å°±ç»“æŸäº†ã€‚å¯¹äºæˆ‘ä»¬<code>top user</code>ï¼Œè¿™ä¸ªé€’å½’çš„SQLä¹Ÿå°±ç»“æŸäº†ã€‚</li>
<li>å¯¹äº<code>union all</code>, å®ƒå¯ä»¥å‘ç°è¿™ä¸ªåŒ…(Bag)åˆå¤šäº†ä¸€ä¸ªæ–°å…ƒç´ $A$ï¼Œå†ä¸‹ä¸€æ­¥åˆä¼šæ–°ç”Ÿæˆä¸€ä¸ª$A$ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šä¸€ç›´è¿›è¡Œä¸‹å»ã€‚å¯¹äºSQLå¼•æ“ï¼Œè¿™å°±å˜æˆäº†ä¸€ä¸ªæ— æ­¢å¢ƒçš„å¾ªç¯ã€‚å¯¹äºæˆ‘ä»¬<code>top user</code>ï¼Œè¿™ä¸ªé€’å½’SQLæ— æ³•ç»ˆæ­¢ã€‚</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬çš„æ•°æ®åº“çš„è¡Œä¸ºæ˜¯ä¸Šè¿°é‚£æ ·ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥çŒœæƒ³ï¼šè¿™ä¸ªé€’å½’SQLä¼šè¢«å†…éƒ¨å¤„ç†æˆä¸€ä¸ª<code>while</code>å¾ªç¯ï¼Œç»“æŸçš„æ¡ä»¶æ˜¯è¿™ä¸ªé›†åˆ/åŒ…æ²¡æœ‰æ–°çš„å…ƒç´ å†è¢«ç”Ÿæˆã€‚</p>
<p>æˆ‘ä»¬ä¼šåœ¨<span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAyMTYyNTczNSNpdGVtLTI=" title="https://segmentfault.com/a/1190000021625735#item-2">ä¸‹ä¸€ç¯‡æ–‡ç« <i class="fa fa-external-link"></i></span>ä¼šé‡åˆ°çœŸæ­£çš„ä¾‹å­ä»¥åŠè¿™æ–¹é¢å¾ˆå¤šç»ƒä¹ ã€‚</p>
<h2 id="ç¬¬ä¸€éƒ¨åˆ†æ•°æ®é›†-Uni-Schema"><a href="#ç¬¬ä¸€éƒ¨åˆ†æ•°æ®é›†-Uni-Schema" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†æ•°æ®é›† - Uni Schema"></a>ç¬¬ä¸€éƒ¨åˆ†æ•°æ®é›† - Uni Schema</h2><p>Uni Schema æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p>æ¶æ„ Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p>
<p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p>
<p>ä¸‹è½½:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p>
<p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p>
<p>è¯¾ä»¶ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li>
</ul>
<p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<h3 id="å‰å¯¼è¯¾-voraussetzen"><a href="#å‰å¯¼è¯¾-voraussetzen" class="headerlink" title="å‰å¯¼è¯¾(voraussetzen)"></a>å‰å¯¼è¯¾(voraussetzen)</h3><ul>
<li><p>æ‰¾Der Wiener Kreisè¿™é—¨è¯¾çš„å‰å¯¼è¯¾(voraussetzen)ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> vorgaenger</span><br><span class="line"><span class="keyword">from</span> voraussetzen, vorlesungen</span><br><span class="line"><span class="keyword">where</span> nachfolger = vorlnr <span class="keyword">and</span> titel = <span class="string">'Der Wiener Kreis'</span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>æ‰¾Der Wiener Kreisè¿™é—¨è¯¾çš„å‰å¯¼è¯¾(voraussetzen)çš„å‰å¯¼è¯¾(voraussetzen)ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> v1.vorgaenger</span><br><span class="line"><span class="keyword">from</span> voraussetzen v1, voraussetzen v2, vorlesungen vorl </span><br><span class="line"><span class="keyword">where</span> v1.nachfolger = v2.vorgaenger <span class="keyword">and</span> v2.nachfolger = vorl.vorlnr <span class="keyword">and</span> vorl.titel = <span class="string">'Der Wiener Kreis'</span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ä¼ é€’é—­åŒ…(Transitive closure)</p>
</li>
</ul>
<script type="math/tex; mode=display">tran_{A, B}(R) = \{(a, b) | \exists k \in \mathbb{N} (\exists \Gamma 1, \dots, \Gamma k \in R \\ (\Gamma 1.A = \Gamma 2.B \wedge \dots \Gamma k-1.A = \Gamma k.B \wedge \Gamma 1.A=a \wedge \Gamma k.B = b))\}</script><p>ä¹Ÿå°±æ˜¯æ‰¾å‡ºä¸€æ¡è·¯å¾„ã€‚</p>
<ul>
<li>Der Wiener Kreisæ˜¯æ‰€æœ‰(ç›´æ¥å’Œé—´æ¥)å‰æä»¬ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> transVorl (vorg, nachf) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> vorgaenger, nachfolger</span><br><span class="line">    <span class="keyword">from</span> voraussetzen</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> t.vorg, v.nachfolger</span><br><span class="line">    <span class="keyword">from</span> transVorl t, voraussetzen v</span><br><span class="line">    <span class="keyword">where</span> t.nachf = v.vorgaenger</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> titel</span><br><span class="line"><span class="keyword">from</span> vorlesungen</span><br><span class="line"><span class="keyword">where</span> vorlnr <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> vorg</span><br><span class="line">    <span class="keyword">from</span> transVorl</span><br><span class="line">    <span class="keyword">where</span> nachf <span class="keyword">in</span> (</span><br><span class="line">        <span class="keyword">select</span> nachf</span><br><span class="line">        <span class="keyword">from</span> vorlesungen</span><br><span class="line">        <span class="keyword">where</span> titel = <span class="string">'Der Wiener Kreis'</span></span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> transVorl (vorg, nachf) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> vorgaenger, nachfolger</span><br><span class="line">    <span class="keyword">from</span> voraussetzen</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> t.vorg, v.nachfolger</span><br><span class="line">    <span class="keyword">from</span> transVorl t, voraussetzen v</span><br><span class="line">    <span class="keyword">where</span> t.nachf = v.vorgaenger</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> v1.titel</span><br><span class="line"><span class="keyword">from</span> vorlesungen v1, transVorl t, vorlesungen v2</span><br><span class="line"><span class="keyword">where</span> v1.vorlnr = t.vorg <span class="keyword">and</span> t.nachf = v2.vorlnr <span class="keyword">and</span> v2.titel = <span class="string">'Der Wiener Kreis'</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>Bioethikæ˜¯æ‰€æœ‰(ç›´æ¥å’Œé—´æ¥)å‰æä»¬ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> voraussetzen_rec <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">select</span> vorlnr</span><br><span class="line"><span class="keyword">from</span> vorlesungen v</span><br><span class="line"><span class="keyword">where</span> titel = <span class="string">'Bioethik'</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> vor.vorgaenger</span><br><span class="line"><span class="keyword">from</span> voraussetzen_rec v, voraussetzen vor</span><br><span class="line"><span class="keyword">where</span> v.vorlnr = vor.nachfolger</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> v.titel</span><br><span class="line"><span class="keyword">from</span> vorlesungen v, voraussetzen_rec vor</span><br><span class="line"><span class="keyword">where</span> v.vorlnr = vor.vorlnr <span class="keyword">and</span> v.titel != <span class="string">'Bioethik'</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªä¹Ÿæ˜¯æ¢äº†å¦å¤–ä¸€ç§æ€è·¯å»è¡¨è¾¾ã€‚</p>
<h3 id="å‰å¯¼è¯¾-voraussetzen-å¯¹è·¯å¾„é•¿åº¦è®¡æ•°"><a href="#å‰å¯¼è¯¾-voraussetzen-å¯¹è·¯å¾„é•¿åº¦è®¡æ•°" class="headerlink" title="å‰å¯¼è¯¾(voraussetzen), å¯¹è·¯å¾„é•¿åº¦è®¡æ•°"></a>å‰å¯¼è¯¾(voraussetzen), å¯¹è·¯å¾„é•¿åº¦è®¡æ•°</h3><ul>
<li>è®¡ç®—å®Œæˆè¿™äº›è¯¾è‡³å°‘éœ€è¦å¤šå°‘å­¦æœŸï¼š<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> transVorl (vorg, nachf, <span class="keyword">len</span>) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> vorgaenger, nachfolger, <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> voraussetzen</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> t.vorg, v.nachfolger, t.len + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> transVorl t, voraussetzen v</span><br><span class="line">    <span class="keyword">where</span> t.nachf = v.vorgaenger</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">max</span>(t.len) + <span class="number">1</span> <span class="keyword">as</span> MinStudySemester</span><br><span class="line"><span class="keyword">from</span> transVorl t, vorlesungen v</span><br><span class="line"><span class="keyword">where</span> v.titel = <span class="string">'Der Wiener Kreis'</span>;</span><br></pre></td></tr></tbody></table></figure>
æˆ–è€…<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> transVorl (vorlnr, <span class="keyword">len</span>) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> vorlnr, <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> vorlesungen</span><br><span class="line">    <span class="keyword">where</span> titel = <span class="string">'Der Wiener Kreis'</span></span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> v.vorgaenger, t.len + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> transVorl t, voraussetzen v</span><br><span class="line">    <span class="keyword">where</span> t.vorlnr = v.nachfolger</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">len</span>) MinStudySemester</span><br><span class="line"><span class="keyword">from</span> transVorl;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<hr>
<h2 id="ç”»ä¸€é¢—æ ‘ï¼š"><a href="#ç”»ä¸€é¢—æ ‘ï¼š" class="headerlink" title="ç”»ä¸€é¢—æ ‘ï¼š"></a>ç”»ä¸€é¢—æ ‘ï¼š</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> tree (step, <span class="built_in">text</span>) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">0</span>, <span class="string">'              *'</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> step + <span class="number">1</span>,</span><br><span class="line">        (<span class="keyword">case</span></span><br><span class="line">            <span class="keyword">when</span> step = <span class="keyword">length</span>(<span class="built_in">text</span>) / <span class="number">2</span> <span class="keyword">then</span> <span class="keyword">concat</span>(<span class="keyword">repeat</span>(<span class="string">' '</span>, <span class="keyword">length</span>(<span class="built_in">text</span>) / <span class="number">2</span>), <span class="string">'*'</span>)</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">concat</span>(</span><br><span class="line">                <span class="keyword">substring</span>(<span class="built_in">text</span> <span class="keyword">from</span> <span class="number">0</span> <span class="keyword">for</span> <span class="keyword">length</span>(<span class="built_in">text</span>) - (<span class="number">2</span> * step + <span class="number">1</span>)),</span><br><span class="line">                <span class="keyword">repeat</span>(<span class="string">'*'</span>, <span class="number">2</span> * step + <span class="number">3</span>))</span><br><span class="line">        <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">from</span> tree</span><br><span class="line">    <span class="keyword">where</span> step &lt;= <span class="keyword">length</span>(<span class="built_in">text</span>) / <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> t.text</span><br><span class="line"><span class="keyword">from</span> tree t</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> step;</span><br></pre></td></tr></tbody></table></figure>
<p>è¾“å‡º(è¿™é‡Œåªå»ºè®®ç”¨shellè¿è¡Œpostgresqlï¼Œç”¨å…¶ä»–æ¥å£ä¸ä¸€å®šçœ‹å¾—å‡ºæ˜¯æ ‘)ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">             text              </span><br><span class="line">-------------------------------</span><br><span class="line">               *</span><br><span class="line">              ***</span><br><span class="line">             *****</span><br><span class="line">            *******</span><br><span class="line">           *********</span><br><span class="line">          ***********</span><br><span class="line">         *************</span><br><span class="line">        ***************</span><br><span class="line">       *****************</span><br><span class="line">      *******************</span><br><span class="line">     *********************</span><br><span class="line">    ***********************</span><br><span class="line">   *************************</span><br><span class="line">  ***************************</span><br><span class="line"> *****************************</span><br><span class="line">               *</span><br><span class="line">(16 rows)</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œç”¨<code>||</code>ä»£æ›¿<code>concate</code>ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> tree (step, <span class="built_in">text</span>) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">0</span>, <span class="string">'              *'</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> step + <span class="number">1</span>,</span><br><span class="line">        (<span class="keyword">case</span></span><br><span class="line">            <span class="keyword">when</span> step = <span class="keyword">length</span>(<span class="built_in">text</span>) / <span class="number">2</span> <span class="keyword">then</span> <span class="keyword">repeat</span>(<span class="string">' '</span>, <span class="keyword">length</span>(<span class="built_in">text</span>) / <span class="number">2</span>) || <span class="string">'*'</span></span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">                <span class="keyword">substring</span>(<span class="built_in">text</span> <span class="keyword">from</span> <span class="number">0</span> <span class="keyword">for</span> <span class="keyword">length</span>(<span class="built_in">text</span>) - (<span class="number">2</span> * step + <span class="number">1</span>)) || <span class="keyword">repeat</span>(<span class="string">'*'</span>, <span class="number">2</span> * step + <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">from</span> tree</span><br><span class="line">    <span class="keyword">where</span> step &lt;= <span class="keyword">length</span>(<span class="built_in">text</span>) / <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> t.text</span><br><span class="line"><span class="keyword">from</span> tree t</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> step;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ±‚10çš„é˜¶ä¹˜"><a href="#æ±‚10çš„é˜¶ä¹˜" class="headerlink" title="æ±‚10çš„é˜¶ä¹˜"></a>æ±‚10çš„é˜¶ä¹˜</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> r (fac, counter) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> fac * (counter + <span class="number">1</span>), counter + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> r</span><br><span class="line">    <span class="keyword">where</span> counter &lt; <span class="number">10</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> fac</span><br><span class="line"><span class="keyword">from</span> r;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ±‚å‰20ä¸ªçš„æ–æ³¢é‚£å¥‘æ•°åˆ—å…ƒç´ "><a href="#æ±‚å‰20ä¸ªçš„æ–æ³¢é‚£å¥‘æ•°åˆ—å…ƒç´ " class="headerlink" title="æ±‚å‰20ä¸ªçš„æ–æ³¢é‚£å¥‘æ•°åˆ—å…ƒç´ "></a>æ±‚å‰20ä¸ªçš„æ–æ³¢é‚£å¥‘æ•°åˆ—å…ƒç´ </h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> r (fibonacci, last_fibonacci, counter) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> fibonacci + last_fibonacci, fibonacci, counter + <span class="number">1</span></span><br><span class="line">    <span class="keyword">from</span> r</span><br><span class="line">    <span class="keyword">where</span> counter &lt; <span class="number">20</span></span><br><span class="line">    ),</span><br><span class="line">     <span class="keyword">result</span> (fibonacci, last_fibonacci, counter) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> r</span><br><span class="line">     )</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> fibonacci</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">result</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<!-- è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ -->
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Recursion</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]ä¸­çº§SQL(4)</title>
    <url>/2020/02/25/SQL-%E4%B8%AD%E7%BA%A7SQL-4/</url>
    <content><![CDATA[<p>åœ¨è¿™ç¯‡æ–‡ç« <strong>ä¸­çº§SQL</strong>ä¸­æˆ‘ä»¬ä¼šé‡åˆ°subqueryã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ–°çš„ä½“è‚²æ¯”èµ›æ•°æ®é›†ï¼Œæˆ‘ä»¬æ¥æŸ¥è¯¢æ¯”èµ›ä¸­çš„æ’åã€‚å®é™…ä¸Šæœ‰éƒ¨åˆ†æŸ¥è¯¢å¯ä»¥ä½¿ç”¨window functionæ¥æ±‚è§£ï¼Œä½†å®ƒä¸å±äº<strong>ä¸­çº§SQL</strong>çš„èŒƒç•´ã€‚æˆ‘ä»¬ä¼šåœ¨ä»¥åçš„æ–‡ç« <strong>é«˜çº§SQL</strong>çš„éƒ¨åˆ†é‡ç‚¹è®²window functionã€‚</p>
<a id="more"></a>
<h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br>åé¡¹å…¨èƒ½<code>ZehnkampfD</code>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p><strong>æœ¬åœ°è½½å…¥æ”¹æ•°æ®é›†</strong>ï¼š <span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAyMTYyMzY5MyNpdGVtLTMtMg==" title="https://segmentfault.com/a/1190000021623693#item-3-2">https://segmentfault.com/a/1190000021623693#item-3-2<i class="fa fa-external-link"></i></span></p>
<p>è‹±æ–‡Schemaï¼š <script type="math/tex">ZehnkampfD = \{\underline{Name, Discipline}, points\}</script></p>
<p>å¾·æ–‡Schemaï¼š <script type="math/tex">ZehnkampfD = \{\underline{Name, Disziplin}, punkte\}</script></p>
<p>æœ‰å…³è‹±æ–‡Schemaï¼šåœ¨<span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL2EvMTE5MDAwMDAyMTYyMzY5MyNpdGVtLTMtMg==" title="https://segmentfault.com/a/1190000021623693#item-3-2">æˆ‘çš„æ–‡ç« <i class="fa fa-external-link"></i></span>æåˆ°è¿™ä¸€å—å†…å®¹ã€‚å¾·æ–‡schemaå¯ä»¥ç›´æ¥åœ¨HyPerç½‘é¡µæ¥å£è¿è¡Œã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿å¤§å®¶ç›´æ¥åœ¨ç½‘é¡µä¸Šè¿è¡Œï¼Œæˆ‘é‡‡ç”¨å¾·æ–‡schemaã€‚</p>
<!-- TODO:é“¾æ¥åˆ°blog -->
<p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p>
<p>è¯¾ä»¶ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li>
</ul>
<p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<h1 id="ä¸­çº§SQL"><a href="#ä¸­çº§SQL" class="headerlink" title="ä¸­çº§SQL"></a>ä¸­çº§SQL</h1><ul>
<li>æ‰¾å‡ºåœ¨æ‰€æœ‰<code>Diszipplin</code>éƒ½æ¯”<code>Bolt</code>å¥½çš„è¿åŠ¨å‘˜ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> z.name</span><br><span class="line"><span class="keyword">from</span> zehnkampfd <span class="keyword">as</span> z</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd z2</span><br><span class="line">    <span class="keyword">where</span> z2.name = z.name <span class="keyword">and</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> zehnkampfd z3</span><br><span class="line">        <span class="keyword">where</span> z2.punkte &lt;= z3.punkte <span class="keyword">and</span> z2.disziplin = z3.disziplin <span class="keyword">and</span> z3.name = <span class="string">'Bolt'</span></span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> a.name</span><br><span class="line"><span class="keyword">from</span> zehnkampfd a</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd bolt</span><br><span class="line">    <span class="keyword">where</span> bolt.name = <span class="string">'Bolt'</span> <span class="keyword">and</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> zehnkampfd b</span><br><span class="line">        <span class="keyword">where</span> bolt.disziplin = b.disziplin <span class="keyword">and</span> b.name = a.name <span class="keyword">and</span> bolt.punkte &gt;= b.punkte</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>ç”¨ä¸­æ–‡å°±æ˜¯ï¼šä¸å­˜åœ¨ä»»æ„ä¸€ä¸ªé¡¹ç›®ï¼Œè¿™ä¸ªé¡¹ç›®å­˜åœ¨<code>bolt</code>æ¯”å½“å‰è¿åŠ¨å‘˜ä¼˜ç§€ã€‚</p>
<p>æˆ‘ä»¬æ¥è¯¦ç»†çœ‹çœ‹ä¸­é—´è¡¨æ ¼çš„ç»“æœæ˜¯ï¼š<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd z2</span><br><span class="line">    <span class="keyword">where</span>  <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> zehnkampfd z3</span><br><span class="line">        <span class="keyword">where</span> z2.punkte &lt;= z3.punkte <span class="keyword">and</span> z2.disziplin = z3.disziplin <span class="keyword">and</span> z3.name = <span class="string">'Bolt'</span></span><br><span class="line">        )</span><br></pre></td></tr></tbody></table></figure><p></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">    name     | disziplin  | punkte </span><br><span class="line">-------------+------------+--------</span><br><span class="line"> Bolt        | 100m       |     50</span><br><span class="line"> Bolt        | Weitsprung |     50</span><br><span class="line"> Eaton       | 100m       |     40</span><br><span class="line"> Behrenbruch | 100m       |     30</span><br><span class="line"> Behrenbruch | Weitsprung |     50</span><br><span class="line">(5 rows)</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<p>æˆ–è€…ç”¨<code>count</code>è¡¨è¾¾è¿™ä¸ªå…¨éƒ¨ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> better_as_bolt <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> z.name, z.disziplin</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd z, zehnkampfd b</span><br><span class="line">    <span class="keyword">where</span> z.punkte &gt; b.punkte <span class="keyword">and</span> z.disziplin = b.disziplin <span class="keyword">and</span> b.name = <span class="string">'Bolt'</span></span><br><span class="line">), num_dis <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> disziplin) <span class="keyword">as</span> <span class="keyword">num</span></span><br><span class="line">    <span class="keyword">from</span> zehnkampfd</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">from</span> better_as_bolt</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">having</span> <span class="keyword">count</span>(*) = (<span class="keyword">select</span> <span class="keyword">num</span> <span class="keyword">from</span> num_dis)</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªé¢˜ç›®å¾ˆç±»ä¼¼<a href="https://cakebytheoceanluo.github.io/2020/02/22/SQL-%E4%B8%AD%E7%BA%A7SQL-1/">ä¸­çº§SQL(1)</a>ä¸­çš„è¿™ä¸€é¢˜<code>æœç´¢å¬äº†æ‰€æœ‰sws=4 vorlesungençš„å­¦ç”Ÿï¼š</code>ã€‚</p>
<ul>
<li>æœç´¢<code>100m</code>çš„å† å†›(å† å†›å®šä¹‰ä¸ºï¼šæ²¡æœ‰äººæ¯”è¿™ä¸ªè¿åŠ¨å‘˜æ›´å¥½)ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- with correlated sub-query</span></span><br><span class="line"><span class="keyword">select</span> gold.name</span><br><span class="line"><span class="keyword">from</span> zehnkampfd gold</span><br><span class="line"><span class="keyword">where</span> gold.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd other</span><br><span class="line">    <span class="keyword">where</span> other.disziplin = gold.disziplin  <span class="keyword">and</span> gold.punkte &lt; other.punkte</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- with correlated sub-query</span></span><br><span class="line"><span class="keyword">select</span> gold.name</span><br><span class="line"><span class="keyword">from</span> zehnkampfd gold</span><br><span class="line"><span class="keyword">where</span> gold.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> gold.name <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="comment">-- å­˜åœ¨æœ‰è¿åŠ¨å‘˜æ¯”å½“å‰è¿åŠ¨å‘˜æ›´å¥½çš„çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">select</span> z1.name</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd z1, zehnkampfd z2</span><br><span class="line">    <span class="keyword">where</span> z1.disziplin = z2.disziplin <span class="keyword">and</span> z1.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> z1.punkte &lt; z2.punkte</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸æ•°å­—æ¯”è¾ƒ</span></span><br><span class="line"><span class="keyword">select</span> gold.name</span><br><span class="line"><span class="keyword">from</span> zehnkampfd gold</span><br><span class="line"><span class="keyword">where</span> gold.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> gold.punkte = (<span class="keyword">select</span> <span class="keyword">max</span>(punkte) <span class="keyword">from</span> zehnkampfd <span class="keyword">where</span> disziplin = <span class="string">'100m'</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢<code>100m</code>çš„äºšå†›(äºšå†›å®šä¹‰ä¸ºï¼šåªå­˜åœ¨ä¸€ä¸ªè¿åŠ¨å‘˜æ¯”å½“å‰è¿åŠ¨å‘˜æ›´å¥½)ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> silver.name</span><br><span class="line"><span class="keyword">from</span> zehnkampfd silver</span><br><span class="line"><span class="keyword">where</span> silver.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> <span class="number">1</span> = (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd gold <span class="comment">-- è¿™ä¸ªæ˜¯å† å†›ï¼Œæ¯”æˆ‘ä»¬æƒ³é€‰çš„è¿åŠ¨å‘˜æ›´å¥½ï¼Œæˆ‘ä»¬åªå…è®¸è¿™æ ·çš„äººå‡ºç°ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">where</span> gold.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> gold.punkte &gt; silver.punkte</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> silver.name</span><br><span class="line"><span class="keyword">from</span> zehnkampfd silver</span><br><span class="line"><span class="keyword">where</span> silver.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd gold <span class="comment">-- è¿™ä¸ªæ˜¯å† å†›ï¼Œæ¯”æˆ‘ä»¬æƒ³é€‰çš„è¿åŠ¨å‘˜æ›´å¥½ï¼Œæˆ‘ä»¬åªå…è®¸è¿™æ ·çš„äººå‡ºç°ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">where</span> gold.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> gold.punkte &gt; silver.punkte <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> zehnkampfd nobody <span class="comment">-- ä¸å†è¿è¡Œéå† å†›ï¼Œæ¯”æˆ‘ä»¬æƒ³é€‰çš„è¿åŠ¨å‘˜æ›´å¥½</span></span><br><span class="line">        <span class="keyword">where</span> nobody.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> gold.name != nobody.name <span class="keyword">and</span> nobody.punkte &gt; silver.punkte)</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢<code>100m</code>çš„å­£å†›(å­£å†›å®šä¹‰ä¸ºï¼šåªå­˜åœ¨ä¸¤ä¸ªè¿åŠ¨å‘˜æ¯”å½“å‰è¿åŠ¨å‘˜æ›´å¥½)ï¼š<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> bronze.name</span><br><span class="line"><span class="keyword">from</span> zehnkampfd bronze</span><br><span class="line"><span class="keyword">where</span> bronze.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> <span class="number">2</span> = (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd other</span><br><span class="line">    <span class="keyword">where</span> other.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> other.punkte &gt; bronze.punkte</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> bronze.name</span><br><span class="line"><span class="keyword">from</span> zehnkampfd bronze</span><br><span class="line"><span class="keyword">where</span> bronze.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> zehnkampfd gold, zehnkampfd silver</span><br><span class="line">    <span class="keyword">where</span> gold.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> gold.punkte &gt; bronze.punkte <span class="keyword">and</span></span><br><span class="line">          silver.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> silver.punkte &gt; bronze.punkte <span class="keyword">and</span></span><br><span class="line">          gold.name != silver.name <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> zehnkampfd nobody <span class="comment">-- ä¸å†å…è®¸éå† å†›å’Œäºšå†›</span></span><br><span class="line">        <span class="keyword">where</span> nobody.disziplin = <span class="string">'100m'</span> <span class="keyword">and</span> gold.name != nobody.name <span class="keyword">and</span> silver.name != nobody.name <span class="keyword">and</span> nobody.punkte &gt; bronze.punkte)</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<!-- è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]ä¸­çº§SQL(3)</title>
    <url>/2020/02/25/SQL-%E4%B8%AD%E7%BA%A7SQL-3/</url>
    <content><![CDATA[<p>åœ¨è¿™ç¯‡æ–‡ç« <strong>ä¸­çº§SQL</strong>ä¸­æˆ‘ä»¬ä¼šé‡åˆ°subqueryï¼Œå®ƒå¯ä»¥å‡ºç°åœ¨<code>selectå­å¥</code>ä¸­æˆ–è€…<code>whereå­å¥</code>æˆ–è€…<code>fromå­å¥</code>ä¸­ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šç»ƒä¹ ç¨å¾®å¤æ‚çš„subqueryã€‚</p>
<a id="more"></a>
<h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p>æ¶æ„ Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p>
<p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p>
<p>ä¸‹è½½:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p>
<p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p>
<p>è¯¾ä»¶ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li>
</ul>
<p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<h1 id="ä¸­çº§SQL"><a href="#ä¸­çº§SQL" class="headerlink" title="ä¸­çº§SQL"></a>ä¸­çº§SQL</h1><p><img data-src="/images/SQL/sql1.png" alt="sql1"></p>
<p>å‡è®¾æˆ‘ä»¬çš„schemaå˜æˆä¸Šå›¾(SQLä¸èƒ½ç›´æ¥è¿è¡Œã€€æ•°æ®é›†ä¸å¯¹åº”ä¸Šå›¾)ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åŠ å…¥æš‚æ—¶çš„<code>view</code>è¿›å…¥ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> professorenF <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *,</span><br><span class="line">           (<span class="keyword">case</span> <span class="keyword">when</span> p.persnr <span class="keyword">in</span> (<span class="number">2125</span>, <span class="number">2126</span>, <span class="number">2133</span>, <span class="number">2137</span>) <span class="keyword">then</span> <span class="string">'Philosophie'</span></span><br><span class="line">                 <span class="keyword">when</span> p.persnr <span class="keyword">in</span> (<span class="number">2127</span>, <span class="number">2136</span>) <span class="keyword">then</span> <span class="string">'Physik'</span></span><br><span class="line">               <span class="keyword">else</span> <span class="string">'Theologie'</span></span><br><span class="line">           <span class="keyword">end</span>) <span class="keyword">as</span> fakname</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> professorenF</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> studentenGF <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *,</span><br><span class="line">           (<span class="keyword">case</span> <span class="keyword">when</span> s.matrnr <span class="keyword">in</span> (<span class="number">24002</span>, <span class="number">26830</span>, <span class="number">27550</span>, <span class="number">29120</span>) <span class="keyword">then</span> <span class="string">'M'</span></span><br><span class="line">                 <span class="keyword">else</span> <span class="string">'W'</span></span><br><span class="line">           <span class="keyword">end</span>) <span class="keyword">as</span> geschlecht,</span><br><span class="line">           (<span class="keyword">case</span> <span class="keyword">when</span> s.matrnr <span class="keyword">in</span> (<span class="number">24002</span>, <span class="number">26120</span>, <span class="number">26830</span>, <span class="number">27550</span>) <span class="keyword">then</span> <span class="string">'Philosophie'</span></span><br><span class="line">                 <span class="keyword">when</span> s.matrnr <span class="keyword">in</span> (<span class="number">28106</span>, <span class="number">29120</span>) <span class="keyword">then</span> <span class="string">'Physik'</span></span><br><span class="line">               <span class="keyword">else</span> <span class="string">'Theologie'</span></span><br><span class="line">           <span class="keyword">end</span>) <span class="keyword">as</span> fakname</span><br><span class="line">    <span class="keyword">from</span> studenten s</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> studentenGF</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬ä¸‹é¢æ¯ä¸€ä¸ªqueryéƒ½éœ€è¦åŠ å…¥ä¸Šé¢ä¸¤ä¸ª<code>view</code>, å³å¦‚ä¸‹æ¨¡å¼:<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> professorenF <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *,</span><br><span class="line">           (<span class="keyword">case</span> <span class="keyword">when</span> p.persnr <span class="keyword">in</span> (<span class="number">2125</span>, <span class="number">2126</span>, <span class="number">2133</span>, <span class="number">2137</span>) <span class="keyword">then</span> <span class="string">'Philosophie'</span></span><br><span class="line">                 <span class="keyword">when</span> p.persnr <span class="keyword">in</span> (<span class="number">2127</span>, <span class="number">2136</span>) <span class="keyword">then</span> <span class="string">'Physik'</span></span><br><span class="line">               <span class="keyword">else</span> <span class="string">'Theologie'</span></span><br><span class="line">           <span class="keyword">end</span>) <span class="keyword">as</span> fakname</span><br><span class="line">    <span class="keyword">from</span> professoren p</span><br><span class="line">), studentenGF <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *,</span><br><span class="line">           (<span class="keyword">case</span> <span class="keyword">when</span> s.matrnr <span class="keyword">in</span> (<span class="number">24002</span>, <span class="number">26830</span>, <span class="number">27550</span>, <span class="number">29120</span>) <span class="keyword">then</span> <span class="string">'M'</span></span><br><span class="line">                 <span class="keyword">else</span> <span class="string">'W'</span></span><br><span class="line">           <span class="keyword">end</span>) <span class="keyword">as</span> geschlecht,</span><br><span class="line">           (<span class="keyword">case</span> <span class="keyword">when</span> s.matrnr <span class="keyword">in</span> (<span class="number">24002</span>, <span class="number">26120</span>, <span class="number">26830</span>, <span class="number">27550</span>) <span class="keyword">then</span> <span class="string">'Philosophie'</span></span><br><span class="line">                 <span class="keyword">when</span> s.matrnr <span class="keyword">in</span> (<span class="number">28106</span>, <span class="number">29120</span>) <span class="keyword">then</span> <span class="string">'Physik'</span></span><br><span class="line">               <span class="keyword">else</span> <span class="string">'Theologie'</span></span><br><span class="line">           <span class="keyword">end</span>) <span class="keyword">as</span> fakname</span><br><span class="line">    <span class="keyword">from</span> studenten s</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æˆ‘ä»¬çš„query</span></span><br><span class="line"><span class="keyword">select</span> ...</span><br><span class="line"><span class="keyword">from</span> ...</span><br><span class="line"><span class="keyword">where</span> ...</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><br></p>
<hr>
<ul>
<li>æ±‚æ¯ä¸€ä¸ªFakNameå¯¹åº”çš„å¥³æ€§å æ¯”ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> anz(Fakname,AnzStudenten) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.FakName, <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">from</span> StudentenGF s</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.FakNAme),</span><br><span class="line">     anzw(Fakname,AnzWeiblich) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> sw.FakName,<span class="keyword">count</span>(*) <span class="keyword">as</span> AnzWeiblich</span><br><span class="line">    <span class="keyword">from</span> StudentenGF sw</span><br><span class="line">    <span class="keyword">where</span> sw.Geschlecht =<span class="string">'W'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> sw.FakName)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> anz.FakName, anz.AnzStudenten, anzw.AnzWeiblich, (<span class="keyword">cast</span>(anzw.AnzWeiblich <span class="keyword">as</span> <span class="built_in">decimal</span>(<span class="number">5</span>,<span class="number">2</span>))/anz.AnzStudenten * <span class="number">100</span>) <span class="keyword">as</span> ProzentWeiblich</span><br><span class="line"><span class="keyword">from</span> anz, anzw</span><br><span class="line"><span class="keyword">where</span> anz.FakName = anzw.FakName</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ±‚æ¯ä¸€ä¸ªFakNameå¯¹åº”çš„ç”·æ€§å æ¯”ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> anz(Fakname, AnzStudenten) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.FakName, <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">from</span> StudentenGF s</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.FakNAme),</span><br><span class="line">     anzm(Fakname, AnzMaenner) <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> sw.FakName, <span class="keyword">count</span>(*) <span class="keyword">as</span> AnzWeiblich</span><br><span class="line">         <span class="keyword">from</span> StudentenGF sw</span><br><span class="line">         <span class="keyword">where</span> sw.Geschlecht = <span class="string">'M'</span></span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> sw.FakName)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> anz.FakName,</span><br><span class="line">       anz.AnzStudenten,</span><br><span class="line">       anzm.AnzMaenner,</span><br><span class="line">       (<span class="keyword">case</span> <span class="keyword">when</span> anzm.AnzMaenner <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">0</span> <span class="keyword">else</span> anzm.AnzMaenner <span class="keyword">end</span>) / anz.AnzStudenten * <span class="number">100.00</span> <span class="keyword">as</span> ProzentMaenner</span><br><span class="line"><span class="keyword">from</span> anz <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> anzm</span><br><span class="line"><span class="keyword">on</span> anz.FakName = anzm.FakName</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œå¹¶ä¸æ˜¯å¥³æ€§ç‰ˆç›´æ¥æ›´æ”¹æˆç”·æ€§ã€‚ä¸€ä¸ªé‡ç‚¹æ˜¯:<strong>å­˜åœ¨ç³»æ²¡æœ‰ä»»ä½•ç”·æ€§</strong>ã€‚<br><code>case</code>ä¹Ÿå¯ä»¥è¢«æ›¿æ¢ä¸º: <code>COALESCE(anzm.AnzMaenner, 0) / anz.AnzStudenten * 100.00 as ProzentMaenner</code></p>
<p>æˆ–è€…å†æ¢ä¸€ç§ï¼š<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> fakname,</span><br><span class="line">       (<span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> geschlecht = <span class="string">'M'</span> <span class="keyword">then</span> <span class="number">1.00</span> <span class="keyword">else</span> <span class="number">0.00</span> <span class="keyword">end</span>)) / <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">from</span> studentenGF</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> fakname</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>æœç´¢æ‰€æœ‰å­¦ç”ŸæŠŠè‡ªå·±ç³»æ•™æˆæä¾›çš„è¯¾éƒ½å¬å®Œäº†ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studentenGF s</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> vorlesungen v, professorenF p</span><br><span class="line">    <span class="keyword">where</span> v.gelesenvon = p.persnr <span class="keyword">and</span> p.fakname = s.fakname <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> hoeren h</span><br><span class="line">        <span class="keyword">where</span> h.vorlnr = v.vorlnr <span class="keyword">and</span> h.matrnr = s.matrnr</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>ç”¨ä¸­æ–‡å°±æ˜¯ï¼šå¯¹è¿™ä¸ªå­¦ç”Ÿï¼Œä¸å­˜åœ¨ä¸€é—¨ä»–ç³»é‡Œæ•™æˆçš„è¯¾ï¼Œè¿™ä¸ªå­¦ç”Ÿæ²¡æœ‰å¬è¿‡ã€‚</p>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studentenGF s</span><br><span class="line"><span class="keyword">where</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">from</span> vorlesungen v, professorenF p</span><br><span class="line">    <span class="keyword">where</span> v.gelesenvon = p.persnr <span class="keyword">and</span> p.fakname = s.fakname</span><br><span class="line">          )</span><br><span class="line">=</span><br><span class="line">      (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*)</span><br><span class="line">    <span class="keyword">from</span> hoeren h, vorlesungen v, professorenF p</span><br><span class="line">    <span class="keyword">where</span> h.matrnr = s.matrnr <span class="keyword">and</span> h.vorlnr = v.vorlnr <span class="keyword">and</span> p.persnr = v.gelesenvon <span class="keyword">and</span> p.fakname= s.fakname</span><br><span class="line">          )</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<!-- è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]ä¸­çº§SQL(2)</title>
    <url>/2020/02/25/SQL-%E4%B8%AD%E7%BA%A7SQL-2/</url>
    <content><![CDATA[<p>åœ¨è¿™ç¯‡æ–‡ç« <strong>ä¸­çº§SQL</strong>ä¸­æˆ‘ä»¬ä¼šé‡åˆ°subqueryï¼Œå®ƒå¯ä»¥å‡ºç°åœ¨<code>selectå­å¥</code>ä¸­æˆ–è€…<code>whereå­å¥</code>æˆ–è€…<code>fromå­å¥</code>ä¸­ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šç»ƒä¹ ç¨å¾®å¤æ‚çš„subqueryã€‚</p>
<a id="more"></a>
<h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æqueryã€€(analytical query)ã€‚<br>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p>æ¶æ„ Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p>
<p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p>
<p>ä¸‹è½½:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p>
<p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p>
<p>è¯¾ä»¶ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li>
</ul>
<p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<h1 id="ä¸­çº§SQL"><a href="#ä¸­çº§SQL" class="headerlink" title="ä¸­çº§SQL"></a>ä¸­çº§SQL</h1><ul>
<li>æ¯”è¾ƒå¬è¯¾å¹¶è€ƒè¯•çš„åŒå­¦çš„æˆç»©å’Œä¸å¬è¯¾åªè€ƒè¯•çš„åŒå­¦æˆç»©ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> no_lec <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(note) <span class="keyword">as</span> avg_note</span><br><span class="line">    <span class="keyword">from</span> pruefen p</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> hoeren h</span><br><span class="line">        <span class="keyword">where</span> h.matrnr = p.matrnr</span><br><span class="line">        )),</span><br><span class="line">     with_lec <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(note) <span class="keyword">as</span> avg_note</span><br><span class="line">    <span class="keyword">from</span> pruefen p</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> hoeren h</span><br><span class="line">        <span class="keyword">where</span> h.matrnr = p.matrnr</span><br><span class="line">        ))</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> no_lec, with_lec;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<ul>
<li>è®¡ç®—æƒé‡çš„æˆç»©(<code>sws</code>å°±æ˜¯æˆ‘ä»¬çš„æƒé‡)ï¼š<br>æˆ‘ä»¬é‡‡ç”¨ä¸€ä¸ªæ›´å¤§çš„è¡¨æ ¼ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> pruefenxl (matrnr, vorlnr, persnr, note) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">values</span></span><br><span class="line">        (<span class="number">25403</span> , <span class="number">5049</span> , <span class="number">2126</span> , <span class="number">1</span>),</span><br><span class="line">        (<span class="number">26120</span> , <span class="number">5001</span> , <span class="number">2137</span> , <span class="number">1</span>),</span><br><span class="line">        (<span class="number">26120</span> , <span class="number">5043</span> , <span class="number">2126</span> , <span class="number">3</span>),</span><br><span class="line">        (<span class="number">26120</span> , <span class="number">5052</span> , <span class="number">2126</span> , <span class="number">4</span>),</span><br><span class="line">        (<span class="number">26120</span> , <span class="number">4630</span> , <span class="number">2137</span> , <span class="number">1</span>)</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> pruefenxl (matrnr, vorlnr, persnr, note) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">values</span></span><br><span class="line">        (<span class="number">25403</span>, <span class="number">5049</span>, <span class="number">2126</span>, <span class="number">1</span>),</span><br><span class="line">        (<span class="number">26120</span>, <span class="number">5001</span>, <span class="number">2137</span>, <span class="number">1</span>),</span><br><span class="line">        (<span class="number">26120</span>, <span class="number">5043</span>, <span class="number">2126</span>, <span class="number">3</span>),</span><br><span class="line">        (<span class="number">26120</span>, <span class="number">5052</span>, <span class="number">2126</span>, <span class="number">4</span>),</span><br><span class="line">        (<span class="number">26120</span>, <span class="number">4630</span>, <span class="number">2137</span>, <span class="number">1</span>)</span><br><span class="line">), factorGrade <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.name, s.matrnr, v.titel, p.note, v.sws <span class="keyword">as</span> factor, (p.note * v.sws) <span class="keyword">as</span> finalGrade</span><br><span class="line">    <span class="keyword">from</span> studenten s, pruefenxl p, vorlesungen v</span><br><span class="line">    <span class="keyword">where</span> p.vorlnr = v.vorlnr <span class="keyword">and</span> s.matrnr = p.matrnr</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> matrnr, <span class="keyword">name</span>, <span class="keyword">sum</span>(finalGrade) / <span class="keyword">sum</span>(factor) <span class="keyword">as</span> finalAVG</span><br><span class="line"><span class="keyword">from</span> factorGrade</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> matrnr, <span class="keyword">name</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> matrnr</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> pruefenxl (matrnr, vorlnr, persnr, note) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">from</span> pruefen</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">values</span></span><br><span class="line">        (<span class="number">25403</span> , <span class="number">5049</span> , <span class="number">2126</span> , <span class="number">1</span>),</span><br><span class="line">        (<span class="number">26120</span> , <span class="number">5001</span> , <span class="number">2137</span> , <span class="number">1</span>),</span><br><span class="line">        (<span class="number">26120</span> , <span class="number">5043</span> , <span class="number">2126</span> , <span class="number">3</span>),</span><br><span class="line">        (<span class="number">26120</span> , <span class="number">5052</span> , <span class="number">2126</span> , <span class="number">4</span>),</span><br><span class="line">        (<span class="number">26120</span> , <span class="number">4630</span> , <span class="number">2137</span> , <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> s.matrnr, s.name, <span class="keyword">sum</span>(p.note * v.sws) / <span class="keyword">sum</span>(v.sws) <span class="keyword">as</span> <span class="keyword">avg</span></span><br><span class="line"><span class="keyword">from</span> studenten s, pruefenxl p, vorlesungen v</span><br><span class="line"><span class="keyword">where</span> s.matrnr = p.matrnr <span class="keyword">and</span> p.vorlnr = v.vorlnr</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.matrnr , s.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> s.matrnr</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p><br></p>
<p>1.æœç´¢å­¦ç”Ÿé€šè¿‡ä¸Šè¯¾èƒ½è®¤è¯†çš„å…¶ä»–å­¦ç”Ÿåå­—ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s1.name, s2.name</span><br><span class="line"><span class="keyword">from</span> studenten s1, hoeren h1, hoeren h2, studenten s2</span><br><span class="line"><span class="keyword">where</span> h1.vorlnr = h2.vorlnr <span class="keyword">and</span> h1.matrnr = s1.matrnr  <span class="keyword">and</span> h2.matrnr = s2.matrnr <span class="keyword">and</span> s1.matrnr != s2.matrnr</span><br></pre></td></tr></tbody></table></figure>
<p>2.å¯¹æ¯ä¸€ä¸ªåŒå­¦è®¤è¯†çš„äººè¿›è¡Œè®¡æ•°ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> friend <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s1.matrnr <span class="keyword">as</span> student, s2.matrnr <span class="keyword">as</span> his_friend</span><br><span class="line">    <span class="keyword">from</span> studenten s1,</span><br><span class="line">        hoeren h1,</span><br><span class="line">        hoeren h2,</span><br><span class="line">        studenten s2</span><br><span class="line">    <span class="keyword">where</span> h1.vorlnr = h2.vorlnr</span><br><span class="line">    <span class="keyword">and</span> h1.matrnr = s1.matrnr</span><br><span class="line">    <span class="keyword">and</span> h2.matrnr = s2.matrnr</span><br><span class="line">    <span class="keyword">and</span> s1.matrnr != s2.matrnr</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> s.matrnr, s.name, <span class="keyword">count</span>(b.his_friend) <span class="keyword">as</span> num_friends</span><br><span class="line"><span class="keyword">from</span> studenten s, friend b</span><br><span class="line"><span class="keyword">where</span> s.matrnr = b.student</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, s.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_friends <span class="keyword">desc</span></span><br></pre></td></tr></tbody></table></figure>
<p>3.åœ¨2.çš„åŸºç¡€ä¸Šå†è€ƒè™‘ï¼šä¸ä¸Šè¯¾(ä¹Ÿå°±ä¸è®¤è¯†åŒå­¦)çš„äºº </p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> friend <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s1.matrnr <span class="keyword">as</span> student, s2.matrnr <span class="keyword">as</span> his_friend</span><br><span class="line">    <span class="keyword">from</span> studenten s1,</span><br><span class="line">        hoeren h1,</span><br><span class="line">        hoeren h2,</span><br><span class="line">        studenten s2</span><br><span class="line">    <span class="keyword">where</span> h1.vorlnr = h2.vorlnr</span><br><span class="line">    <span class="keyword">and</span> h1.matrnr = s1.matrnr</span><br><span class="line">    <span class="keyword">and</span> h2.matrnr = s2.matrnr</span><br><span class="line">    <span class="keyword">and</span> s1.matrnr != s2.matrnr</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> s.matrnr, s.name, <span class="keyword">count</span>(b.his_friend) <span class="keyword">as</span> num_friends</span><br><span class="line"><span class="keyword">from</span> studenten s <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> friend b</span><br><span class="line"><span class="keyword">on</span> s.matrnr = b.student</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, s.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num_friends <span class="keyword">desc</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œç”¨äº†ä¸€ä¸ª<code>left outer join</code>ã€‚å³è¾¹çš„è¡¨æ ¼<code>friend b</code>åªå«æœ‰ä¸Šè¯¾çš„åŒå­¦(å³å‡ºç°åœ¨<code>hoeren</code>è¡¨æ ¼ä¸­çš„åŒå­¦)ï¼Œä½†æ˜¯å·¦è¾¹çš„è¡¨æ ¼<code>studenten s</code>å«æœ‰æ‰€æœ‰å­¦ç”Ÿã€‚</p>
<hr>
<p><br></p>
<p>1.æ±‚æ¯ä¸ªå­¦ç”Ÿçš„é€‰è¯¾æ•°é‡çš„å¹³å‡æ•°ï¼Œéœ€è¦è€ƒè™‘ä¸ä¸Šè¯¾çš„å­¦ç”Ÿï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(h.vorlnr), <span class="keyword">count</span>(<span class="keyword">distinct</span> s.matrnr) <span class="comment">-- å¬è¯¾å’Œä¸å¬è¯¾çš„å­¦ç”Ÿéƒ½åœ¨</span></span><br><span class="line"><span class="keyword">from</span> studenten s <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> hoeren h <span class="keyword">on</span> s.matrnr = h.matrnr</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> hcount / (scount * <span class="number">1.00</span>)</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> hcount <span class="keyword">from</span> hoeren) h,</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> scount <span class="keyword">from</span> studenten) s <span class="comment">-- å¬è¯¾å’Œä¸å¬è¯¾çš„å­¦ç”Ÿéƒ½åœ¨</span></span><br></pre></td></tr></tbody></table></figure>
<p>2.æœç´¢é€‰è¯¾è¶…è¿‡å­¦ç”Ÿé€‰è¯¾swså¹³å‡æ•°çš„å­¦ç”Ÿï¼Œéœ€è¦è€ƒè™‘ä¸ä¸Šè¯¾çš„å­¦ç”Ÿï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> num_stu <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> count_stu</span><br><span class="line">    <span class="keyword">from</span> studenten),</span><br><span class="line">    num_sws <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">sum</span>(vor.sws) <span class="keyword">as</span> count_sws</span><br><span class="line">    <span class="keyword">from</span> hoeren h, vorlesungen vor</span><br><span class="line">    <span class="keyword">where</span> h.vorlnr = vor.vorlnr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> s.matrnr <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> h.matrnr</span><br><span class="line">    <span class="keyword">from</span> hoeren h, vorlesungen v</span><br><span class="line">    <span class="keyword">where</span> h.vorlnr = v.vorlnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> h.matrnr</span><br><span class="line">    <span class="keyword">having</span> <span class="keyword">sum</span>(sws) &gt; (<span class="keyword">select</span> <span class="keyword">cast</span>(num_sws.count_sws <span class="keyword">as</span> <span class="built_in">decimal</span> (<span class="number">5</span>, <span class="number">2</span>)) / num_stu.count_stu <span class="keyword">from</span> num_sws, num_stu)</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> num_stu <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> count_stu</span><br><span class="line">    <span class="keyword">from</span> studenten),</span><br><span class="line">    num_sws <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">sum</span>(vor.sws) <span class="keyword">as</span> count_sws</span><br><span class="line">    <span class="keyword">from</span> hoeren h, vorlesungen vor</span><br><span class="line">    <span class="keyword">where</span> h.vorlnr = vor.vorlnr),</span><br><span class="line">    avg_sws <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">cast</span>(num_sws.count_sws <span class="keyword">as</span> <span class="built_in">decimal</span>(<span class="number">5</span>, <span class="number">2</span>)) / num_stu.count_stu <span class="keyword">as</span> sws</span><br><span class="line">    <span class="keyword">from</span> num_stu, num_sws),</span><br><span class="line">    stu_sws <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, s.name, s.semester, <span class="keyword">sum</span>(v.sws) <span class="keyword">as</span> sum_sws</span><br><span class="line">    <span class="keyword">from</span> studenten s, hoeren h, vorlesungen v</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = h.matrnr <span class="keyword">and</span> h.vorlnr = v.vorlnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, s.name, s.semester)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> stu_sws s, avg_sws</span><br><span class="line"><span class="keyword">where</span> s.sum_sws &gt; avg_sws.sws</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> swsProStudent <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> s.matrnr, s.name,</span><br><span class="line">        <span class="keyword">cast</span>((<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">sum</span>(v.sws) <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">0</span></span><br><span class="line">                                <span class="keyword">else</span> <span class="keyword">sum</span>(v.sws) <span class="keyword">end</span>) <span class="keyword">as</span> <span class="built_in">real</span>) <span class="keyword">as</span> anzSWS</span><br><span class="line">    <span class="keyword">from</span> studenten s</span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> hoeren h <span class="keyword">on</span> s.matrnr = h.matrnr</span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> vorlesungen v <span class="keyword">on</span> h.vorlnr = v.vorlnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, s.name</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> s.matrnr <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> sws.matrnr</span><br><span class="line">    <span class="keyword">from</span> swsProStudent sws</span><br><span class="line">    <span class="keyword">where</span> sws.anzSWS &gt; (</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">avg</span>(anzSWS)</span><br><span class="line">        <span class="keyword">from</span> swsProStudent</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>1.ç¡®å®šä¸€é—¨çš„<code>semester</code>å±æ€§ï¼š</p>
<ul>
<li>è¿™ä¸ªæ ¹æ®å¬è¿™é—¨è¯¾ä¸­äººæ•°æœ€å¤šçš„ä¸€ä¸ªå­¦ç”Ÿ<code>semester</code>ç»„å†³å®šã€‚</li>
<li>å¦‚æœæœ‰å¾ˆå¤šç»„äººæ•°ç›¸åŒï¼Œå–è¿™äº›ç»„ä»¬ä¸­<code>semester</code>æœ€å°çš„æ•°å€¼ã€‚</li>
<li>æ¯”å¦‚ä¸€é—¨è¯¾è¢«100ç¬¬ä¸€å­¦æœŸçš„åŒå­¦å’Œ100ä¸ªç¬¬ä¸‰å­¦æœŸçš„åŒå­¦ä¸Šï¼Œæˆ‘ä»¬å½“è¿™é—¨è¯¾æ˜¯å±äºç¬¬ä¸€å­¦æœŸçš„è¯¾(é‚£100ç¬¬ä¸‰å­¦æœŸçš„è¢«æˆ‘ä»¬å½“åšå‰ä¸€å¹´æŒ‚ç§‘é‡ä¿®çš„äºº)ã€‚</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> vorl_semester_anz <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> h.vorlnr, s.semester, <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">num</span></span><br><span class="line">    <span class="keyword">from</span> hoeren h, studenten s</span><br><span class="line">    <span class="keyword">where</span> h.matrnr = s.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> h.vorlnr, s.semester</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> v.vorlnr, <span class="keyword">min</span>(v.semester) <span class="keyword">as</span> semester</span><br><span class="line"><span class="keyword">from</span> vorl_semester_anz v</span><br><span class="line"><span class="keyword">where</span> v.num = (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">max</span>(vhelp.num)</span><br><span class="line">    <span class="keyword">from</span> vorl_semester_anz vhelp</span><br><span class="line">    <span class="keyword">where</span> v.vorlnr = vhelp.vorlnr</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> v.vorlnr</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªç»“æ„å…¶å®å¾ˆéš¾ç”¨<code>join</code>å®Œæˆï¼Œä½†æ˜¯ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚å¦å¤–ä¸€ç§é—´æ¥çš„æ–¹å¼ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> vorl_semester_anz <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> h.vorlnr, s.semester, <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">num</span></span><br><span class="line">    <span class="keyword">from</span> hoeren h, studenten s</span><br><span class="line">    <span class="keyword">where</span> h.matrnr = s.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> h.vorlnr, s.semester</span><br><span class="line">), vorl_semester_maxanz <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> v.vorlnr, <span class="keyword">max</span>(<span class="keyword">num</span>) <span class="keyword">as</span> <span class="keyword">max</span> <span class="comment">-- æ¯ä¸€é—¨è¯¾æœ€å¤šçš„äººæ•°æ˜¯ä¸€ä¸ªç¡®å®šçš„æ•°å­—ï¼Œç”¨è¿™ä¸ªæ•°å­—å¯ä»¥æ‰¾å›semester</span></span><br><span class="line">    <span class="keyword">from</span> vorl_semester_anz v</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> v.vorlnr</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> v1.vorlnr, <span class="keyword">min</span>(v1.semester) <span class="keyword">as</span> semester</span><br><span class="line"><span class="keyword">from</span> vorl_semester_anz v1, vorl_semester_maxanz v2</span><br><span class="line"><span class="keyword">where</span> v1.vorlnr = v2.vorlnr <span class="keyword">and</span> v1.num = v2.max</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> v1.vorlnr</span><br></pre></td></tr></tbody></table></figure>
<p>2.æœç´¢æå‰ä¸Šè¯¾çš„åŒå­¦(åŒå­¦çš„<code>semester</code>æ¯”è¯¾ç¨‹çš„<code>semester</code>è¦å°)ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> vorl_semester_anz <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> h.vorlnr, s.semester, <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">num</span></span><br><span class="line">    <span class="keyword">from</span> hoeren h, studenten s</span><br><span class="line">    <span class="keyword">where</span> h.matrnr = s.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> h.vorlnr, s.semester</span><br><span class="line">), vorl_semester <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> v.vorlnr, <span class="keyword">min</span>(v.semester) <span class="keyword">as</span> semester</span><br><span class="line">    <span class="keyword">from</span> vorl_semester_anz v</span><br><span class="line">    <span class="keyword">where</span> v.num = (</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">max</span>(vhelp.num)</span><br><span class="line">        <span class="keyword">from</span> vorl_semester_anz vhelp</span><br><span class="line">        <span class="keyword">where</span> v.vorlnr = vhelp.vorlnr</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> v.vorlnr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> v.vorlnr, v.titel, <span class="keyword">count</span>(s.matrnr) <span class="keyword">as</span> num_advanced_stu</span><br><span class="line"><span class="keyword">from</span> vorlesungen v <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> vorl_semester vs <span class="keyword">on</span> v.vorlnr = vs.vorlnr</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> hoeren h <span class="keyword">on</span> v.vorlnr = h.vorlnr</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> studenten s <span class="keyword">on</span> h.matrnr = s.matrnr <span class="keyword">and</span> s.semester &lt; vs.semester</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> v.vorlnr, v.titel</span><br></pre></td></tr></tbody></table></figure>
<p>å½“ç„¶è¿˜æœ‰å¦ä¸€ç§ï¼š</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> vorl_semester_anz <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> h.vorlnr, s.semester, <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">num</span></span><br><span class="line">    <span class="keyword">from</span> hoeren h, studenten s</span><br><span class="line">    <span class="keyword">where</span> h.matrnr = s.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> h.vorlnr, s.semester</span><br><span class="line">), vorl_semester_maxanz <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> v.vorlnr, <span class="keyword">max</span>(<span class="keyword">num</span>) <span class="keyword">as</span> <span class="keyword">max</span> <span class="comment">-- æ¯ä¸€é—¨è¯¾æœ€å¤šçš„äººæ•°æ˜¯ä¸€ä¸ªç¡®å®šçš„æ•°å­—ï¼Œç”¨è¿™ä¸ªæ•°å­—å¯ä»¥æ‰¾å›semester</span></span><br><span class="line">    <span class="keyword">from</span> vorl_semester_anz v</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> v.vorlnr</span><br><span class="line">), vorl_semester <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> v1.vorlnr, <span class="keyword">min</span>(v1.semester) <span class="keyword">as</span> semester</span><br><span class="line">    <span class="keyword">from</span> vorl_semester_anz v1, vorl_semester_maxanz v2</span><br><span class="line">    <span class="keyword">where</span> v1.vorlnr = v2.vorlnr <span class="keyword">and</span> v1.num = v2.max</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> v1.vorlnr</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> v.vorlnr, v.titel, <span class="keyword">count</span>(s.matrnr) <span class="keyword">as</span> num_advanced_stu</span><br><span class="line"><span class="keyword">from</span> vorlesungen v <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> vorl_semester vs <span class="keyword">on</span> v.vorlnr = vs.vorlnr</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> hoeren h <span class="keyword">on</span> v.vorlnr = h.vorlnr</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> studenten s <span class="keyword">on</span> h.matrnr = s.matrnr <span class="keyword">and</span> s.semester &lt; vs.semester</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> v.vorlnr, v.titel</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œå¿…é¡»è¦æåˆ°ä¸€ä¸‹:</p>
<ul>
<li><code>count(s.matrnr) as num_advanced_stu</code>ä¸èƒ½å†™æˆ<code>count(*)</code></li>
<li>åŸå› æ˜¯ï¼š<code>left outer join</code>ä¼šç”Ÿæˆå¾ˆå¤š<code>null</code>ï¼Œå› ä¸ºå¾ˆå¤šè¯¾æ²¡æœ‰äººå¬ï¼Œå› æ­¤è¿™äº›è¯¾ä¹Ÿæ²¡æœ‰<code>semester</code>ã€‚<br>ä½†æ˜¯<code>count(*)</code>ä¼šå°†è¿™äº›è¯¾è®¡æ•°ï¼Œè€Œ<code>count(s.matrnr)</code>è®¡çš„æ•°å­—æ˜¯<strong>çœŸæ­£</strong>ä¸Šè¿™ä¸ªè¯¾å­¦ç”Ÿäººæ•°ï¼Œè€Œä¸æ˜¯<code>null</code>ã€‚</li>
</ul>
<p>å¼•ç”¨ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<!-- è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]ä¸­çº§SQL(1)</title>
    <url>/2020/02/22/SQL-%E4%B8%AD%E7%BA%A7SQL-1/</url>
    <content><![CDATA[<p>åœ¨è¿™ç¯‡æ–‡ç« <strong>ä¸­çº§SQL</strong>ä¸­æˆ‘ä»¬ä¼šé‡åˆ°subqueryï¼Œå®ƒå¯ä»¥å‡ºç°åœ¨<code>selectå­å¥</code>ä¸­æˆ–è€…<code>whereå­å¥</code>æˆ–è€…<code>fromå­å¥</code>ä¸­ã€‚å®ƒä¼šäº§ç”Ÿä¸€ä¸ªå¯¹åº”çš„ç»“æœè¡¨æ ¼ï¼Œæˆ‘ä»¬å¯ä»¥ç»™è¿™ä¸ªæš‚æ—¶çš„è¡¨ç¤ºå‘½åã€‚</p>
<a id="more"></a>
<h1 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æå‹æŸ¥è¯¢(analytical query)ã€‚<br>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p>æ¶æ„ Schema:<br><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p>
<p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p>
<p>ä¸‹è½½:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p>
<p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p>
<p>è¯¾ä»¶ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li>
</ul>
<p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<h1 id="ä¸­çº§SQL"><a href="#ä¸­çº§SQL" class="headerlink" title="ä¸­çº§SQL"></a>ä¸­çº§SQL</h1><ul>
<li>åœ¨pruefenä¸­æœç´¢noteå°äºå¹³å±€å€¼çš„ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> pruefen</span><br><span class="line"><span class="keyword">where</span> note &lt; (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">avg</span>(note)</span><br><span class="line">    <span class="keyword">from</span> pruefen</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<ul>
<li>å¯¹æ¯ä¸€ä¸ªprofessorenï¼Œå¯¹åº”çš„vorlesungençš„swsæ±‚å’Œï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- correlated sub-query</span></span><br><span class="line"><span class="keyword">select</span> p.persnr, p.name, (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">sum</span>(v.sws) <span class="keyword">as</span> lehrbelastung</span><br><span class="line">    <span class="keyword">from</span> vorlesungen v</span><br><span class="line">    <span class="keyword">where</span> v.gelesenvon = p.persnr</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">from</span> professoren p</span><br><span class="line"></span><br><span class="line"><span class="comment">-- no sub-query</span></span><br><span class="line"><span class="keyword">select</span> p.persnr, p.name, <span class="keyword">sum</span>(sws)</span><br><span class="line"><span class="keyword">from</span> professoren p <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> vorlesungen v <span class="keyword">on</span> p.persnr = v.gelesenvon</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> p.name, p.persnr</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<ul>
<li>æœç´¢ä¸Šè¯¾æ•°å¤§äºï¼’çš„å­¦ç”Ÿï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> tmp.matrnr, tmp.name, tmp.vorlanzahl</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> s.matrnr, s.name, <span class="keyword">count</span>(*) <span class="keyword">as</span> vorlanzahl</span><br><span class="line">    <span class="keyword">from</span> studenten s, hoeren h</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = h.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, s.name) tmp</span><br><span class="line"><span class="keyword">where</span> tmp.vorlanzahl &gt; <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¿™æ—¶å€™æˆ‘ä»¬å¯¹è¿™ä¸ªsubqueryçš„ç»“æœè¡¨æ ¼è¿›è¡Œå‘½å<code>tmp</code>ã€‚å½“ç„¶æˆ‘ä»¬å¯ä»¥ç”¨<code>withå­å¥</code>æ¥åšåŒæ ·çš„äº‹æƒ…ã€‚æˆ‘ä¸»è§‚ä¸Šæ›´å–œæ¬¢ç”¨<code>with</code>,å®ƒå¾ˆæ¸…æ™°åœ°æŠŠæš‚æ—¶éœ€è¦çš„è¡¨æ ¼å†™åœ¨æœ€ä¸Šæ–¹ï¼Œè€Œä¸”å¯¹debugä¹Ÿæ›´åŠ å‹å¥½ã€‚å½“ç„¶ä¸¤è€…æ˜¯ç»“æœç­‰ä»·ï¼Œè¿è¡Œæ—¶é—´ä¹Ÿç­‰ä»·çš„ã€‚</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span> (<span class="keyword">select</span> s.matrnr, s.name, <span class="keyword">count</span>(*) <span class="keyword">as</span> vorlanzahl</span><br><span class="line">    <span class="keyword">from</span> studenten s, hoeren h</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = h.matrnr</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, s.name) </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tmp.matrnr, tmp.name, tmp.vorlanzahl</span><br><span class="line"><span class="keyword">from</span> tmp</span><br><span class="line"><span class="keyword">where</span> tmp.vorlanzahl &gt; <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<ul>
<li>è®¡ç®—æ¯ä¸€ä¸ªvorlesungençš„äººæ•°å æ¯”ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> h.vorlnr, h.anzProVorl, g.gesamtAnz, <span class="keyword">cast</span>(h.anzProVorl <span class="keyword">as</span> <span class="built_in">decimal</span>(<span class="number">6</span>, <span class="number">1</span>)) / g.gesamtAnz <span class="keyword">as</span> MarkAnteil</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> vorlnr, <span class="keyword">count</span>(*) <span class="keyword">as</span> anzProVorl</span><br><span class="line">    <span class="keyword">from</span> hoeren</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> vorlnr) <span class="keyword">as</span> h,</span><br><span class="line">     (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> gesamtAnz</span><br><span class="line">    <span class="keyword">from</span> studenten) g</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- withå­å¥ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">with</span> h <span class="keyword">as</span> (<span class="keyword">select</span> vorlnr, <span class="keyword">count</span>(*) <span class="keyword">as</span> anzProVorl</span><br><span class="line">    <span class="keyword">from</span> hoeren</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> vorlnr),</span><br><span class="line">     g <span class="keyword">as</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> gesamtAnz</span><br><span class="line">    <span class="keyword">from</span> studenten)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> h.vorlnr, h.anzProVorl, g.gesamtAnz, <span class="keyword">cast</span>(h.anzProVorl <span class="keyword">as</span> <span class="built_in">decimal</span>(<span class="number">6</span>, <span class="number">1</span>)) / g.gesamtAnz <span class="keyword">as</span> MarkAnteil</span><br><span class="line"><span class="keyword">from</span> h, g</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<ul>
<li>è®¡ç®—æ¯ä¸€ä¸ªprofessorené€šè¿‡ä¸Šè¯¾è®¤è¯†çš„studentenä¸ªæ•°ä»¥åŠæ¯”ä¾‹ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> kenntSich <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> v.gelesenvon <span class="keyword">as</span> profpersnr, h.matrnr <span class="keyword">as</span> studmatrnr</span><br><span class="line">    <span class="keyword">from</span> hoeren h <span class="keyword">join</span> vorlesungen v <span class="keyword">on</span> h.vorlnr =v.vorlnr</span><br><span class="line">    ),</span><br><span class="line">     kenntAnzahl <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> profpersnr, <span class="keyword">count</span>(*) <span class="keyword">as</span> anzstudenten</span><br><span class="line">    <span class="keyword">from</span> kenntSich</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> profpersnr),</span><br><span class="line">     wieviel <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> gesamtanz</span><br><span class="line">    <span class="keyword">from</span> studenten)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> k.profpersnr, p.name, k.anzstudenten, w.gesamtanz, <span class="number">1.00</span> * k.anzstudenten / w.gesamtanz <span class="keyword">as</span> bekanntheitsgard</span><br><span class="line"><span class="keyword">from</span> kenntAnzahl k, wieviel w, professoren p</span><br><span class="line"><span class="keyword">where</span> k.profpersnr = p.persnr</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> bekanntheitsgard <span class="keyword">desc</span></span><br></pre></td></tr></tbody></table></figure>
<hr>
<ul>
<li>æœç´¢å¬äº†æ‰€æœ‰sws=4 vorlesungençš„å­¦ç”Ÿï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s.*</span><br><span class="line"><span class="keyword">FROM</span> studenten s</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> vorlesungen v</span><br><span class="line">    <span class="keyword">where</span> v.sws = <span class="number">4</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> hoeren h</span><br><span class="line">        <span class="keyword">where</span> h.vorlnr = v.vorlnr <span class="keyword">and</span> h.matrnr = s.matrnr</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>SQL92ä¸­æ²¡æœ‰å®šä¹‰for all Quantifier(å…¨ç§°é‡è¯)ã€‚æ‰€ä»¥æˆ‘ä»¬åªèƒ½æ”¹å†™å…³ç³»ä»£æ•°ï¼š</p>
<p>$ \{s|s\in studenten \wedge \forall v \in vorlesungen (v.sws = 4 \Rightarrow \\ \exists h \in hoeren (h.vorlnr = v.vorlnr \wedge h.matrnr = s.matrnr)) \} $</p>
<p>æˆ‘ä»¬å…ˆæŠŠ$\forall t \in R (P(t))$æ”¹å†™æˆ$\neg (\exists t \in R(\neg P(t)))$:</p>
<script type="math/tex; mode=display">\{s|s\in studenten \wedge \neg (\exists v \in vorlesungen \; \neg (v.sws = 4 \Rightarrow \\ \exists h \in hoeren (h.vorlnr = v.vorlnr \wedge h.matrnr = s.matrnr))) \}</script><p>å†æŠŠ$R \Rightarrow T$æ”¹å†™æˆ$\neg R \vee T$:</p>
<script type="math/tex; mode=display">\{s|s\in studenten \wedge \neg (\exists v \in vorlesungen \; \neg (\neg (v.sws = 4) \vee \\ \exists h \in hoeren (h.vorlnr = v.vorlnr \wedge h.matrnr = s.matrnr))) \}</script><p>å†ç”¨DeMorganå¾‹ç®€åŒ–ä¸€ä¸‹ï¼š</p>
<script type="math/tex; mode=display">\{s|s\in studenten \wedge \neg (\exists v \in vorlesungen (v.sws = 4) \wedge \\ \neg (\exists h \in hoeren (h.vorlnr = v.vorlnr \wedge h.matrnr = s.matrnr))) \}</script><p>ç”¨ä¸­æ–‡è¯´ï¼šä¸å­˜åœ¨ä¸€é—¨sws=4çš„è¯¾ï¼Œæ²¡æœ‰è¢«è¿™ä¸ªå­¦ç”Ÿå¬ã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥å¯¹åº”å…³ç³»ä»£æ•°åˆ°ä¸Šé¢çš„SQLã€‚</p>
<p><br></p>
<p>å¦å¤–ä¸€ç§trickè§£æ³•ï¼Œä½¿ç”¨<code>count</code>:<br></p><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- å…ˆæŠŠhoerenå˜æˆsws=4hoeren: hoerenStudentenWith4SWS</span></span><br><span class="line"><span class="keyword">with</span> hoerenStudentenWith4SWS (matrnr,&nbsp;vorlnr) <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> h.matrnr, v.vorlnr</span><br><span class="line">    <span class="keyword">from</span> hoeren h, vorlesungen v</span><br><span class="line">    <span class="keyword">where</span> h.vorlnr = v.vorlnr <span class="keyword">and</span> v.sws = <span class="number">4</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å†çœ‹å­¦ç”Ÿæ˜¯ä¸æ˜¯å¬å®Œäº†æ‰€æœ‰hoerenStudentenWith4SWS</span></span><br><span class="line"><span class="keyword">select</span> h.matrnr</span><br><span class="line"><span class="keyword">from</span> hoerenStudentenWith4SWS h</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> h.matrnr</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">count</span>(*) = (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> vorlesungen v <span class="keyword">where</span> v.sws = <span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><br></p>
<ul>
<li>(å¯¹ä¸Šé¢çš„ç±»ä¼¼ç»ƒä¹ ) æœç´¢å­¦ç”Ÿæ‰€æœ‰è€ƒè¿‡çš„è¯•å¯¹åº”çš„ç§‘ç›®ï¼Œéƒ½æ˜¯è¿™ä¸ªåŒå­¦æ‰€å¬è¿‡ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.*</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> pruefen p</span><br><span class="line">    <span class="keyword">where</span> p.matrnr = s.matrnr <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> hoeren h</span><br><span class="line">        <span class="keyword">where</span> h.vorlnr = p.vorlnr <span class="keyword">and</span> h.matrnr = s.matrnr</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>ç”¨ä¸­æ–‡è¯´ï¼šæ²¡æœ‰ä¸€é—¨è¢«è€ƒè¿‡çš„ç§‘ç›®ï¼Œæ²¡æœ‰å‡ºç°åœ¨å¯¹åº”å­¦ç”Ÿhoerenè¡¨æ ¼ä¸­ã€‚</p>
<p>å¦å¤–å› ä¸ºè¿™ä¸ªè¦æ±‚æ˜¯ç‹¬ç«‹å¾—åº”ç”¨åœ¨æ¯ä¸€ä¸ªå­¦ç”Ÿä¸Šï¼Œæ¯ä¸€ä¸ªå­¦ç”Ÿå› ä¸ºè€ƒè¯•ä¸åŒï¼Œæ‰€æœ‰è¦æ±‚å¬çš„ç§‘ç›®ä¹Ÿä¸åŒã€‚å› æ­¤ä¸Šé¢é‚£é¢˜çš„<code>trick</code>ä¸å†é€‚ç”¨ã€‚<code>trick</code>åº”ç”¨æ¡ä»¶æ˜¯å¯¹æ‰€æœ‰å­¦ç”Ÿéœ€è¦æ™®éæ€§ï¼Œè€Œæ’é™¤ç‹¬ç«‹æ€§ â€” <code>ä¸€è§†åŒä»</code>ã€‚</p>
<p><br></p>
<ul>
<li>(å¯¹ä¸Šé¢çš„ç±»ä¼¼ç»ƒä¹ ) æœç´¢å­¦ç”Ÿæ‰€æœ‰å¬è¿‡çš„ç§‘ç›®ï¼Œéƒ½è€ƒè¯•å¹¶é€šè¿‡(<code>note</code>&lt;=4)ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> Studenten s</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> hoeren h</span><br><span class="line">    <span class="keyword">where</span> h.MatrNr = s.MatrNr <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span> * </span><br><span class="line">        <span class="keyword">from</span> pruefen p</span><br><span class="line">        <span class="keyword">where</span> p.MatrNr = s.MatrNr <span class="keyword">and</span> p.VorlNr = h.VorlNr <span class="keyword">and</span> p.Note &lt;= <span class="number">4</span></span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<p>ç”¨ä¸­æ–‡è¯´ï¼šæ²¡æœ‰ä¸€é—¨ä¸Šè¿‡è¯¾çš„ç§‘ç›®ï¼Œæ²¡æœ‰å‡ºç°åœ¨å¯¹åº”å­¦ç”Ÿ<code>pruefen</code>è¡¨æ ¼ä¸­å¹¶æ²¡æœ‰é€šè¿‡ã€‚</p>
<p>è¿™ä¸ªä¾æ—§å¾ˆéš¾ç”¨<code>trick</code>ã€‚</p>
<hr>
<p><br></p>
<ul>
<li>æ±‚è‡³å°‘å¬Sokratesä¸€é—¨è¯¾çš„å­¦ç”Ÿä»¬çš„å¹³å‡å­¦æœŸæ•°ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> vl_von_sokrates <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> vorlesungen v, professoren p</span><br><span class="line">    <span class="keyword">where</span> v.gelesenvon = p.persnr <span class="keyword">and</span> p.name = <span class="string">'Sokrates'</span></span><br><span class="line">), studenten_von_sokrates <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> s.name, s.matrnr, s.semester</span><br><span class="line">    <span class="keyword">from</span> studenten s, hoeren h, vl_von_sokrates v</span><br><span class="line">    <span class="keyword">where</span> s.matrnr = h.matrnr <span class="keyword">and</span> h.vorlnr = v.vorlnr</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(semester)</span><br><span class="line"><span class="keyword">from</span> studenten_von_sokrates;</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é¢˜ä¸€å®šè¦æ³¨æ„,å¯èƒ½ä¸€ä¸ªå­¦ç”Ÿå¬äº†Sokratesçš„å¾ˆå¤šè¯¾ï¼Œä½†æ˜¯è¿™ç§åŒå­¦ä¸èƒ½è¢«é‡å¤è®¡æ•°ã€‚æˆ‘ä»¬å¯ä»¥ç”¨<code>distinct</code>ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬ä¹Ÿæœ‰ä¸€ç§è§£æ³•ä¸éœ€è¦<code>distinct</code>ï¼Œå®ƒä¸ç”¨<code>join</code>,è€Œæ˜¯å¸¦<code>exists</code>çš„correlated subquery: </p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> vl_von_sokrates <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> vorlesungen v, professoren p</span><br><span class="line">    <span class="keyword">where</span> v.gelesenvon = p.persnr <span class="keyword">and</span> p.name = <span class="string">'Sokrates'</span></span><br><span class="line">), studenten_von_sokrates <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> studenten s</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> *</span><br><span class="line">        <span class="keyword">from</span> hoeren h, vl_von_sokrates vl</span><br><span class="line">        <span class="keyword">where</span> h.matrnr = s.matrnr <span class="keyword">and</span> h.vorlnr = vl.vorlnr</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(semester)</span><br><span class="line"><span class="keyword">from</span> studenten_von_sokrates;</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<ul>
<li>æ±‚æ¯ä¸ªå­¦ç”Ÿå¬å‡ èŠ‚è¯¾ï¼Œéœ€è¦è€ƒè™‘ä¸å¬ä»»ä½•è¯¾çš„å­¦ç”Ÿï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> h <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> hcount</span><br><span class="line">    <span class="keyword">from</span> hoeren</span><br><span class="line">    ),</span><br><span class="line">     s <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> scount</span><br><span class="line">    <span class="keyword">from</span> studenten</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> hcount / (scount * <span class="number">1.00</span>) <span class="keyword">as</span> avg_vl</span><br><span class="line"><span class="keyword">from</span> h, s</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> h <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> hcount</span><br><span class="line">    <span class="keyword">from</span> hoeren</span><br><span class="line">    ),</span><br><span class="line">     s <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> scount</span><br><span class="line">    <span class="keyword">from</span> studenten</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> hcount / (<span class="keyword">cast</span>(scount <span class="keyword">as</span> <span class="built_in">decimal</span>(<span class="number">10</span>, <span class="number">4</span>))) <span class="keyword">as</span> avg_vl</span><br><span class="line"><span class="keyword">from</span> h, s</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span><br><!-- 
è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL]åŸºç¡€SQL</title>
    <url>/2020/02/22/SQL-%E5%9F%BA%E7%A1%80SQL/</url>
    <content><![CDATA[<p>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä»‹ç»SQLä¸­æœ€åŸºç¡€çš„è¯­å¥ã€‚</p>
<a id="more"></a>
<h1 id="SQLç®€ä»‹"><a href="#SQLç®€ä»‹" class="headerlink" title="SQLç®€ä»‹"></a>SQLç®€ä»‹</h1><p>SQLæ˜¯ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€(Structure Query Language)çš„ç¼©å†™ï¼Œå®ƒæ˜¯ä½¿ç”¨å…³ç³»æ¨¡å‹çš„æ•°æ®åº“(RDBMS)åº”ç”¨è¯­è¨€ã€‚</p>
<h1 id="SQLå†å²"><a href="#SQLå†å²" class="headerlink" title="SQLå†å²"></a>SQLå†å²</h1><blockquote>
<p>åœ¨1970å¹´ä»£åˆï¼Œç”±IBMå…¬å¸San Jose,Californiaç ”ç©¶å®éªŒå®¤çš„Edgar Frank Codd(åˆç§°Ted Codd)å‘è¡¨å°†æ•°æ®ç»„æˆè¡¨æ ¼çš„åº”ç”¨åŸåˆ™ï¼ˆCoddâ€™s Relational Algebraï¼‰ã€‚1974å¹´ï¼ŒåŒä¸€å®éªŒå®¤çš„D.D.Chamberlinå’ŒR.F. Boyceå¯¹Coddâ€™s Relational Algebraåœ¨ç ”åˆ¶å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»ŸSystem Rä¸­ï¼Œç ”åˆ¶å‡ºä¸€å¥—è§„èŒƒè¯­è¨€-SEQUELï¼ˆStructured English Query Languageï¼‰ï¼Œå¹¶åœ¨1976å¹´11æœˆçš„IBM Journal of R&amp;Dä¸Šå…¬å¸ƒæ–°ç‰ˆæœ¬çš„SQLï¼ˆå«SEQUEL/2ï¼‰ã€‚1980å¹´æ”¹åä¸ºSQLã€‚<br>1979å¹´ORACLEå…¬å¸é¦–å…ˆæä¾›å•†ç”¨çš„SQLï¼ŒIBMå…¬å¸åœ¨DB2å’ŒSQL/DSæ•°æ®åº“ç³»ç»Ÿä¸­ä¹Ÿå®ç°äº†SQLã€‚<sup><a href="#myfootnote1">1</a></sup></p>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRWRnYXJfRi5fQ29kZA==" title="https://en.wikipedia.org/wiki/Edgar_F._Codd">Ted Codd<i class="fa fa-external-link"></i></span>æ˜¯æ•°æ®åº“å¼€åˆ›è€…ï¼Œä»¥<code>relation model</code>è·å¾—1981å¹´å›¾çµå¥–ã€‚æˆ‘ä»¬åœ¨å…³ç³»æ¨¡å‹ä¸­çš„<code>Boyce-Codd Normal From</code>(ä»‹äºç¬¬ä¸‰èŒƒå¼å’Œç¬¬å››èŒƒå¼)ä¹Ÿæ¥è‡ªäºä»–çš„åå­—ã€‚</p>
<p><code>System R</code>åœ¨æ•°æ®åº“å†å²ä¸Šä¹Ÿéå¸¸é‡è¦ã€‚ç‰¹åˆ«æ˜¯çœ‹æ•°æ®åº“ä¹¦çš„æ—¶ä¸æ–­è¢«æèµ·ã€‚</p>
<h1 id="SQLæ ‡å‡†"><a href="#SQLæ ‡å‡†" class="headerlink" title="SQLæ ‡å‡†"></a>SQLæ ‡å‡†</h1><blockquote>
<p>1986å¹´10æœˆï¼Œç¾å›½ANSIé‡‡ç”¨SQLä½œä¸ºå…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„æ ‡å‡†è¯­è¨€ï¼ˆANSI X3. 135-1986ï¼‰ï¼Œåä¸ºå›½é™…æ ‡å‡†åŒ–ç»„ç»‡ï¼ˆISOï¼‰é‡‡çº³ä¸ºå›½é™…æ ‡å‡†ã€‚<br>1989å¹´ï¼Œç¾å›½ANSIé‡‡çº³åœ¨ANSI X3.135-1989æŠ¥å‘Šä¸­å®šä¹‰çš„å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„SQLæ ‡å‡†è¯­è¨€ï¼Œç§°ä¸ºANSI SQL 89ï¼Œè¯¥æ ‡å‡†æ›¿ä»£ANSI X3.135-1986ç‰ˆæœ¬ã€‚è¯¥æ ‡å‡†ä¸ºä¸‹åˆ—ç»„ç»‡æ‰€é‡‡çº³ï¼š<br>å›½é™…æ ‡å‡†åŒ–ç»„ç»‡ï¼ˆISOï¼‰ï¼Œä¸ºISO 9075-1989æŠ¥å‘Šâ€œDatabase Language SQL With Integrity Enhancementâ€<br>ç¾å›½è”é‚¦æ”¿åºœï¼Œå‘å¸ƒåœ¨The Federal Information Processing Standard Publication(FIPS PUB)127<br>å½“å‰ï¼Œæ‰€æœ‰ä¸»è¦çš„å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿæ”¯æŒæŸäº›å½¢å¼çš„SQLï¼Œå¤§éƒ¨åˆ†æ•°æ®åº“è‡³å°‘éµå®ˆANSI SQL89æ ‡å‡†ã€‚<br>ANSI SQL92æ ‡å‡†åœ¨äº¤å‰è¿æ¥ï¼ˆcross joinï¼‰å’Œå†…éƒ¨è¿æ¥ä¹‹ä¸Šï¼Œæ–°å¢åŠ äº†å¤–éƒ¨è¿æ¥ï¼Œå¹¶æ”¯æŒåœ¨FROMå­å¥ä¸­å†™è¿æ¥è¡¨è¾¾å¼ã€‚æ”¯æŒé›†åˆçš„å¹¶è¿ç®—ã€äº¤è¿ç®—ã€‚æ”¯æŒCase (SQL)è¡¨è¾¾å¼ã€‚æ”¯æŒCHECKçº¦æŸã€‚åˆ›å»ºä¸´æ—¶è¡¨ã€‚æ”¯æŒcursorã€‚<br>æ”¯æŒäº‹åŠ¡éš”ç¦»ã€‚<sup><a href="#myfootnote1">1</a></sup></p>
</blockquote>
<h1 id="å…³äºæ­¤æ–‡ç« "><a href="#å…³äºæ­¤æ–‡ç« " class="headerlink" title="å…³äºæ­¤æ–‡ç« "></a>å…³äºæ­¤æ–‡ç« </h1><p>æˆ‘ä»¬è¿™ä¸€ç¯‡æ–‡ç« é‡‡ç”¨PostgreSQLçš„SQLè¯­æ³•ã€‚é‡ç‚¹æˆ‘ä»¬å…³æ³¨<code>select...from...where</code>è¿™ç§è¯»æ“ä½œï¼Œåˆ†æå‹æŸ¥è¯¢(analytical query)ã€‚<br>æ•°æ®é›†åœ¨ã€€<span class="exturl" data-url="aHR0cHM6Ly9oeXBlci1kYi5kZS9pbnRlcmZhY2UuaHRtbA==" title="https://hyper-db.de/interface.html">https://hyper-db.de/interface.html<i class="fa fa-external-link"></i></span>ã€€å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦å¤–åœ¨è¿™ä¸ªç½‘é¡µä¸å…è®¸è¿›è¡Œå†™æ“ä½œ:<code>insert</code>, <code>update</code>, <code>delete</code>ä¹‹ç±»çš„transactional queryã€‚å½“ç„¶<code>create table</code>å’Œ<code>drop table</code>ä¹Ÿä¸è¢«å…è®¸ã€‚</p>
<p>æ¶æ„ Schema:  </p>
<p><img data-src="https://db.in.tum.de/teaching/ws1920/grundlagen/uni.png?lang=de" alt="schema_de"></p>
<p><img data-src="https://hyper-db.de/uniEngl.png" alt="schema_en"></p>
<p>ä¸‹è½½:<br><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvd3MxOTIwL2dydW5kbGFnZW4vdW5pX215c3FsLnNxbD9sYW5nPWRl" title="https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de">https://db.in.tum.de/teaching/ws1920/grundlagen/uni_mysql.sql?lang=de<i class="fa fa-external-link"></i></span></p>
<p>Schmaå’Œå¤§éƒ¨åˆ†SQLè¯­å¥æ¥è‡ª<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvcGVvcGxlL3NpdGVzL2tlbXBlci8/bGFuZz1kZQ==" title="https://db.in.tum.de/people/sites/kemper/?lang=de">Prof. Alfons Kemper, Ph.D.<i class="fa fa-external-link"></i></span>çš„è¯¾ä»¶å’Œä¹¦ã€‚</p>
<p>è¯¾ä»¶ï¼š</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></li>
</ul>
<p>ä¹¦ï¼šã€€<span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<h1 id="åŸºç¡€SQL"><a href="#åŸºç¡€SQL" class="headerlink" title="åŸºç¡€SQL"></a>åŸºç¡€SQL</h1><ul>
<li>æœç´¢æ‰€æœ‰rangæ˜¯C4çš„æ•™æˆï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> persnr, <span class="keyword">name</span></span><br><span class="line"><span class="keyword">from</span> professoren</span><br><span class="line"><span class="keyword">where</span> rang = <span class="string">'C4'</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹æ‰€æœ‰çš„æ•™æˆå…ˆå¯¹rangå€’åºæ’åºï¼Œå†å¯¹nameæ­£åºæ’åºï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> persnr, <span class="keyword">name</span>, rang</span><br><span class="line"><span class="keyword">from</span> professoren</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> rang <span class="keyword">desc</span>, <span class="keyword">name</span> <span class="keyword">asc</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¾—åˆ°professorençš„rankçš„æ‰€æœ‰å¯èƒ½ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> rang</span><br><span class="line"><span class="keyword">from</span> professoren</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢å¼€Maeeutikè¿™ä¸ªè¯¾çš„æ•™æˆï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> p.name, v.titel</span><br><span class="line"><span class="keyword">from</span> professoren p, vorlesungen v</span><br><span class="line"><span class="keyword">where</span> p.persnr = v.gelesenvon <span class="keyword">and</span> titel = <span class="string">'Maeeutik'</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ—å‡ºå­¦ç”Ÿåå­—å’Œè¯¥å­¦ç”Ÿå¬è¿‡çš„è¯¾ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name, v.titel</span><br><span class="line"><span class="keyword">from</span> studenten s, hoeren h, vorlesungen v</span><br><span class="line"><span class="keyword">where</span> s.matrnr = h.matrnr <span class="keyword">and</span> h.vorlnr = v.vorlnr</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢æ¯ä¸ªè¯¾è¢«å¤šå°‘å­¦ç”Ÿå¬ï¼Œè€ƒè™‘æ²¡æœ‰äººå¬çš„è¯¾ï¼Œè¿›è¡Œå€’åºæ’åºï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> v.vorlnr, v.titel, <span class="keyword">count</span>(h.matrnr) <span class="keyword">as</span> <span class="keyword">num</span></span><br><span class="line"><span class="keyword">from</span> vorlesungen v <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> hoeren h <span class="keyword">on</span> v.vorlnr = h.vorlnr</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> v.vorlnr, v.titel</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">num</span> <span class="keyword">desc</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢assistentençš„nameå’Œprofessorençš„nameçš„å¹¶é›†ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">(<span class="keyword">select</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">from</span> assistenten)</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line">(<span class="keyword">select</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">from</span> professoren)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢æ²¡æœ‰ä»»ä½•è¯¾çš„æ•™æˆï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- correlated sub-query</span></span><br><span class="line"><span class="keyword">select</span> p.name</span><br><span class="line"><span class="keyword">from</span> professoren p</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> vorlesungen v</span><br><span class="line">    <span class="keyword">where</span> v.gelesenvon = p.persnr</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment">-- un-correlated sub-query</span></span><br><span class="line"><span class="comment">-- not in:ã€€é›†åˆçš„æ¯”è¾ƒ</span></span><br><span class="line"><span class="keyword">select</span> p.name</span><br><span class="line"><span class="keyword">from</span> professoren p</span><br><span class="line"><span class="keyword">where</span> p.persnr <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> v.gelesenvon</span><br><span class="line">    <span class="keyword">from</span> vorlesungen v</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢ä¸ä¸Šä»»ä½•è¯¾çš„å­¦ç”Ÿï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- correlated sub-query</span></span><br><span class="line"><span class="keyword">select</span> s.name</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> hoeren h</span><br><span class="line">    <span class="keyword">where</span> h.matrnr = s.matrnr</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment">-- un-correlated sub-query</span></span><br><span class="line"><span class="comment">-- not in:ã€€é›†åˆçš„æ¯”è¾ƒ</span></span><br><span class="line"><span class="keyword">select</span> s.name</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> s.matrnr <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> h.matrnr</span><br><span class="line">    <span class="keyword">from</span> hoeren h</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¬å¤§äºç­‰äº3é—¨è¯¾å­¦ç”Ÿï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.matrnr, s.name</span><br><span class="line"><span class="keyword">from</span> studenten s, hoeren h</span><br><span class="line"><span class="keyword">where</span> s.matrnr = h.matrnr</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.matrnr, s.name</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">count</span>(*) &gt;= <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢semesteræœ€å¤§çš„å­¦ç”Ÿï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.name</span><br><span class="line"><span class="keyword">from</span> studenten s</span><br><span class="line"><span class="keyword">where</span> s.semester &gt;= <span class="keyword">all</span> (</span><br><span class="line">    <span class="keyword">select</span> semester</span><br><span class="line">    <span class="keyword">from</span> studenten</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ±‚å¾—studentençš„å¹³å‡semesterï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(semester)</span><br><span class="line"><span class="keyword">from</span> studenten</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢sws&gt;=4å¹¶ä¸”ä½œä¸ºè‡³å°‘å…¶ä»–ä¸¤é—¨è¯¾ä»¥ä¸Šçš„vorgaenger:</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> v.vorlnr, v.titel</span><br><span class="line"><span class="keyword">from</span> vorlesungen v, voraussetzen vor</span><br><span class="line"><span class="keyword">where</span> v.vorlnr = vor.vorgaenger <span class="keyword">and</span> v.sws &gt;= <span class="number">4</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> v.vorlnr, v.titel</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">count</span>(*) &gt;= <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢æ¯ä¸€ä¸ªæ•™æˆä¸Šçš„è¯¾çš„SWSçš„å„è‡ªæ€»å’Œï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> v.gelesenvon, <span class="keyword">sum</span>(v.sws)</span><br><span class="line"><span class="keyword">from</span> vorlesungen v</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> v.gelesenvon</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœç´¢æœ‰rank C4çš„professorenä¸­ä¸Šè¯¾æ€»SWSè¶…è¿‡ï¼“çš„professorenï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> v.gelesenvon, p.name, <span class="keyword">sum</span>(v.sws)</span><br><span class="line"><span class="keyword">from</span> vorlesungen v, professoren p</span><br><span class="line"><span class="keyword">where</span> v.gelesenvon = p.persnr <span class="keyword">and</span> rang = <span class="string">'C4'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> v.gelesenvon, p.name</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">avg</span>(v.sws) &gt;= <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹aggregation operationã€‚<br>å¯¹æ¯ä¸€ä¸ªgroupéƒ½ä¼šç”Ÿæˆä¸€ä¸ªtupleã€‚æ‰€ä»¥å¯¹äºå¸¦æœ‰<code>group by</code>å­å¥çš„<code>SQL</code>è¯­å¥ï¼Œ<code>select</code>å­å¥é‡Œé¢åªèƒ½æ˜¯<code>group by</code>å­å¥æåˆ°çš„å±æ€§å€¼å’Œaggregation operationã€‚</p>
<ul>
<li>æ¯”è¾ƒçš„syntax sugar(è¯­æ³•ç³–)ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> studenten </span><br><span class="line"><span class="keyword">WHERE</span> semester &gt;= <span class="number">1</span> <span class="keyword">AND</span> semester &lt;= <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> studenten </span><br><span class="line"><span class="keyword">WHERE</span> semester <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">and</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> studenten </span><br><span class="line"><span class="keyword">WHERE</span> semester <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å­—ç¬¦ä¸²æ¯”è¾ƒï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> studenten </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'T%eophrastos'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> s.name</span><br><span class="line"><span class="keyword">FROM</span> vorlesungen v, hoeren h, studenten s</span><br><span class="line"><span class="keyword">WHERE</span> s.matrnr = h.matrnr <span class="keyword">AND</span> h.vorlnr = v.vorlnr <span class="keyword">AND</span> v.titel <span class="keyword">LIKE</span> <span class="string">'%thik%'</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>case</code>ï¼š</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> matrnr, </span><br><span class="line">            (<span class="keyword">case</span> <span class="keyword">when</span> note &lt;= <span class="number">1.5</span> <span class="keyword">then</span> <span class="string">'sehr gut'</span></span><br><span class="line">               <span class="keyword">when</span> note &lt;= <span class="number">2.5</span> <span class="keyword">then</span> <span class="string">'gut'</span></span><br><span class="line">               <span class="keyword">when</span> note &lt;= <span class="number">3.5</span> <span class="keyword">then</span> <span class="string">'befriedigend'</span></span><br><span class="line">               <span class="keyword">when</span> note &lt;= <span class="number">4.0</span> <span class="keyword">then</span> <span class="string">'ausreichend'</span></span><br><span class="line">               <span class="keyword">else</span> <span class="string">'nicht bestanden'</span></span><br><span class="line">            <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">FROM</span> pruefen;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>left outer join</code>:</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> p.persnr, p.name, f.persnr, f.note, f.matrnr, s.matrnr, s.name</span><br><span class="line"><span class="keyword">FROM</span> professoren p <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> pruefen f <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">JOIN</span> studenten s <span class="keyword">ON</span> f.matrnr = s.matrnr <span class="keyword">ON</span> p.persnr = f.persnr;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>right outer join</code>:</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> p.persnr, p.name, pf.persnr, pf.note, pf.matrnr, s.matrnr, s.name</span><br><span class="line"><span class="keyword">FROM</span> professoren p <span class="keyword">right</span> <span class="keyword">outer</span> <span class="keyword">JOIN</span> pruefen pf <span class="keyword">right</span> <span class="keyword">outer</span> <span class="keyword">JOIN</span> studenten s <span class="keyword">ON</span> pf.matrnr = s.matrnr <span class="keyword">ON</span> p.persnr = pf.persnr;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>full outer join</code>:</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> p.persnr, p.name, pf.persnr, pf.note, pf.matrnr, s.matrnr, s.name</span><br><span class="line"><span class="keyword">FROM</span> professoren p <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">JOIN</span> pruefen pf <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">JOIN</span> studenten s <span class="keyword">ON</span> pf.matrnr = s.matrnr <span class="keyword">ON</span> p.persnr = pf.persnr;</span><br></pre></td></tr></tbody></table></figure>
<p><br><br><br></p>
<ul>
<li>åˆ¶ä½œä¸€ä¸ªä¹˜æ³•è¡¨(<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTXVsdGlwbGljYXRpb25fdGFibGU=" title="https://en.wikipedia.org/wiki/Multiplication_table">Multiplication table<i class="fa fa-external-link"></i></span>)</li>
</ul>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- precompute look up table</span></span><br><span class="line"><span class="keyword">with</span> mtable <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">( <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>),</span><br><span class="line">( <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">16</span>, <span class="number">18</span>, <span class="number">20</span>),</span><br><span class="line">( <span class="number">3</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">15</span>, <span class="number">18</span>, <span class="number">21</span>, <span class="number">24</span>, <span class="number">27</span>, <span class="number">30</span>),</span><br><span class="line">( <span class="number">4</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">20</span>, <span class="number">24</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">36</span>, <span class="number">40</span>),</span><br><span class="line">( <span class="number">5</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">35</span>, <span class="number">40</span>, <span class="number">45</span>, <span class="number">50</span>),</span><br><span class="line">( <span class="number">6</span>, <span class="number">12</span>, <span class="number">18</span>, <span class="number">24</span>, <span class="number">30</span>, <span class="number">36</span>, <span class="number">42</span>, <span class="number">48</span>, <span class="number">54</span>, <span class="number">60</span>),</span><br><span class="line">( <span class="number">7</span>, <span class="number">14</span>, <span class="number">21</span>, <span class="number">28</span>, <span class="number">35</span>, <span class="number">42</span>, <span class="number">49</span>, <span class="number">56</span>, <span class="number">63</span>, <span class="number">70</span>),</span><br><span class="line">( <span class="number">8</span>, <span class="number">16</span>, <span class="number">24</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">48</span>, <span class="number">56</span>, <span class="number">64</span>, <span class="number">72</span>, <span class="number">80</span>),</span><br><span class="line">( <span class="number">9</span>, <span class="number">18</span>, <span class="number">27</span>, <span class="number">36</span>, <span class="number">45</span>, <span class="number">54</span>, <span class="number">63</span>, <span class="number">72</span>, <span class="number">81</span>, <span class="number">90</span>),</span><br><span class="line">( <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>, <span class="number">60</span>, <span class="number">70</span>, <span class="number">80</span>, <span class="number">90</span>, <span class="number">100</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mtable</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> mtable_column(a, b, c, d, e, f, g, h, i, k) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>) <span class="comment">-- å…¶å®è¢«å†™æˆä¸€è¡Œ</span></span><br><span class="line">),</span><br><span class="line">mtable_row(x) <span class="keyword">as</span> (<span class="keyword">values</span></span><br><span class="line">(<span class="number">1</span>), (<span class="number">2</span>), (<span class="number">3</span>), (<span class="number">4</span>), (<span class="number">5</span>), (<span class="number">6</span>), (<span class="number">7</span>), (<span class="number">8</span>), (<span class="number">9</span>), (<span class="number">10</span>) <span class="comment">-- å…¶å®è¢«å†™æˆä¸€åˆ—</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">a * x,</span><br><span class="line">b * x,</span><br><span class="line">c * x,</span><br><span class="line">d * x,</span><br><span class="line">e * x,</span><br><span class="line">f * x,</span><br><span class="line">g * x,</span><br><span class="line">h * x,</span><br><span class="line">i * x,</span><br><span class="line">k * x</span><br><span class="line"><span class="keyword">from</span> mtable_column, mtable_row</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨ï¼š</p>
<p><a name="myfootnote1">1</a>:  SQL ç»´åŸºç™¾ç§‘. <span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvU1FM" title="https://zh.wikipedia.org/wiki/SQL">https://zh.wikipedia.org/wiki/SQL<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi8/bGFuZz1kZQ==" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mL2ZvbGllbi9wZGYvS2FwaXRlbDQucGRmP2xhbmc9ZGU=" title="https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/folien/pdf/Kapitel4.pdf?lang=de<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYi5pbi50dW0uZGUvdGVhY2hpbmcvYm9va0RCTVNlaW5mLz9sYW5nPWRl" title="https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de">https://db.in.tum.de/teaching/bookDBMSeinf/?lang=de<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>C/C++ä¸­æŒ‡é’ˆ/æ•°ç»„çš„è®¿é—®</title>
    <url>/2020/02/19/PL-C-pointer-access/</url>
    <content><![CDATA[<h1 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h1><p>æˆ‘ä»¬çš„å‰ææ˜¯ä¸‹é¢å‡ ä¸ªå˜é‡ï¼š<br></p><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">int</span> *p;</span><br><span class="line"><span class="keyword">int</span> var;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>ä¸‹é¢å…­ç§èµ‹å€¼ä¹‹åï¼Œå˜é‡<code>var</code>çš„å€¼æ˜¯å¦ç›¸åŒï¼Ÿ</p>
<ul>
<li><code>var = array[4]</code>  </li>
<li><code>var = *(array + 4)</code> </li>
<li><code>var = 4[array]</code> </li>
<li><code>p = &amp;[array4]; var = *p;</code></li>
<li><code>var = *(int *) ( (void *)array + 4 * (sizeof(int)))</code></li>
<li><code>p = &amp;var; *p = *(array + 4);</code>  </li>
</ul>
<p>å½“ç„¶çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœä½ å·²ç»æœ‰éå¸¸è‡ªä¿¡çš„ç­”æ¡ˆï¼Œä½ å½“ç„¶å¯ä»¥æ— è§†è¿™ä¸€ç¯‡æ–‡ç« åé¢çš„éƒ¨åˆ†ã€‚</p>
<a id="more"></a>
<p><br></p>
<h1 id="ç­”æ¡ˆ"><a href="#ç­”æ¡ˆ" class="headerlink" title="ç­”æ¡ˆ"></a>ç­”æ¡ˆ</h1><p><strong>ä¸Šé¢å…­ç§èµ‹å€¼ä¹‹åï¼Œå˜é‡<code>var</code>çš„å€¼ç›¸åŒã€‚</strong></p>
<p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªæ•°ç»„åœ¨ç¨‹åºçš„æ ˆçš„å¸ƒå±€ã€€(è¿™é‡Œ<code>Address 10568</code>ä»…ä¸º<code>array</code>åœ°å€çš„ä¾‹å­)ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">+---------------------+-------------+---------+</span><br><span class="line">| Variable Name       | Address     | Value   | </span><br><span class="line">+---------------------+-------------+---------+</span><br><span class="line">| array               | 10568       | 0      |</span><br><span class="line">|                     |             +---------+</span><br><span class="line">|                     |             | 1      |</span><br><span class="line">|                     |             +---------+</span><br><span class="line">|                     |             | 2      |</span><br><span class="line">|                     |             +---------+</span><br><span class="line">|                     |             | 3      |</span><br><span class="line">|                     |             +---------+</span><br><span class="line">|                     |             | 4      |</span><br><span class="line">|                     |             +---------+</span><br><span class="line">|                     |             | 5      |</span><br><span class="line">|                     |             +---------+</span><br><span class="line">|                     |             | 6      |</span><br><span class="line">|                     |             +---------+</span><br><span class="line">|                     |             | 7      |</span><br><span class="line">|                     |             +---------+</span><br><span class="line">|                     |             | 8      |</span><br><span class="line">|                     |             +---------+</span><br><span class="line">|                     |             | 9      |</span><br><span class="line">+---------------------+-------------+---------+</span><br></pre></td></tr></tbody></table></figure>
<p><code>var = array[4]</code>ï¼Œã€€<code>var = *(array + 4)</code> ï¼Œã€€<code>var = 4[array]</code>, <code>p = &amp;[array4]; var = *p;</code> ï¼š<br>è¿™å››ç§å…¶å®éå¸¸ç±»ä¼¼ï¼Œéƒ½æ˜¯å·²çŸ¥<code>array</code>æ˜¯ä¸€ä¸ª<code>int*</code>ï¼Œåœ¨<code>array</code>è¿™ä¸ªåŸºåœ°å€(ä¾‹å­ä¸­çš„10568)ä¸Šè¿›è¡Œå››ä¸ªå…ƒç´ çš„åç§»ï¼Œå› æ­¤èƒ½è½åœ¨ï¼”å·å…ƒç´ çš„åœ°å€ä¸Šï¼Œå†è®²è¿™ä¸ªåœ°å€è§†ä½œ<code>int*</code>è¯»å‡ºintå†…å®¹ã€‚</p>
<p><code>var = *(int *) ( (void *)array + 4 * (sizeof(int)))</code>ï¼š<br>è¿™ä¸ªå†™æ³•è™½ç„¶ç¹çï¼Œä½†æ˜¯éå¸¸åƒå¯¹åº”çš„æ±‡ç¼–ä»£ç ã€‚<code>(void *)array</code>é¦–å…ˆå°†<code>array</code>è½¬æˆä¸€ä¸ª<code>void*</code>ï¼Œä¹Ÿå°±æ˜¯æŠ¹å»äº†å®ƒ<code>int*</code>çš„åŸèº«ä»½ã€‚å†å¯¹è¿™ä¸ª<code>void*</code>ç©ºç±»å‹æŒ‡é’ˆè¿›è¡Œåç§»æ“ä½œï¼Œæ³¨æ„è¿™æ—¶å€™çš„<strong>åç§»é‡</strong>ä¸å†æ˜¯4ï¼Œè€Œæ˜¯å¯¹åº”<strong>ï¼”ä¸ª<code>int</code>å¯¹åº”çš„Byteé‡</strong>ï¼Œå³<code>4 * (sizeof(int)</code>ã€‚æœ€åå†å°†è¿™ä¸ªç©ºç±»å‹æŒ‡é’ˆè½¬åŒ–æˆ<code>int*</code>å»è¯»å–æ•°æ®ã€‚</p>
<p><code>p = &amp;var; *p = *(array + 4);</code>ï¼š<br>åˆ©ç”¨äº†å¦å¤–ä¸€ä¸ªæŒ‡é’ˆ<code>p</code>ï¼Œä½¿è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘å˜é‡<code>var</code>ã€‚å› æ­¤å¯ä»¥ä½¿ç”¨<code>*p</code>å¯¹<code>var</code>è¿›è¡Œèµ‹å€¼ã€‚</p>
<p><br></p>
<h1 id="å¦ä¸€ä¾‹å­"><a href="#å¦ä¸€ä¾‹å­" class="headerlink" title="å¦ä¸€ä¾‹å­"></a>å¦ä¸€ä¾‹å­</h1><p>æˆ‘ä»¬å¯ä»¥ç»ƒä¹ ï¼Œè€ƒè™‘ä¸€ä¸‹è¿™ä¸ªç¨‹åºçš„è¾“å‡ºã€‚</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">int</span> *p;</span><br><span class="line"><span class="keyword">int</span> var;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) <span class="built_in">array</span>[i]=i;</span><br><span class="line"></span><br><span class="line">var = <span class="built_in">array</span>[<span class="number">4</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%i\n"</span>, var);</span><br><span class="line"></span><br><span class="line">var = <span class="number">5</span>[<span class="built_in">array</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%i\n"</span>, var);</span><br><span class="line"></span><br><span class="line">var = *(<span class="built_in">array</span> + <span class="number">6</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%i\n"</span>, var);</span><br><span class="line"></span><br><span class="line">p = &amp;<span class="built_in">array</span>[<span class="number">7</span>];</span><br><span class="line">var = *p;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%i\n"</span>, var);</span><br><span class="line"></span><br><span class="line">p = <span class="built_in">array</span>;</span><br><span class="line">var = *p;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%i\n"</span>, var);</span><br><span class="line"></span><br><span class="line">p = &amp;var;</span><br><span class="line">*p = *(<span class="built_in">array</span> + <span class="number">3</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%i\n"</span>, var);</span><br></pre></td></tr></tbody></table></figure>
<p>è¾“å‡ºï¼š<br></p><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>å¯¹åº”çš„ä»£ç ï¼š<br><a href="/download/code/pointer_access.c">ç‚¹å‡»ä¸‹è½½</a></p>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èçš„é˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzc4NDQzNzQvODA0OTQwOA==" title="https://stackoverflow.com/a/7844374/8049408">https://stackoverflow.com/a/7844374/8049408<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cudHV0b3JpYWxjdXAuY29tL2Nwcm9ncmFtbWluZy9hcnJheS1tZW1vcnktYWxsb2NhdGlvbi5odG0=" title="https://www.tutorialcup.com/cprogramming/array-memory-allocation.htm">https://www.tutorialcup.com/cprogramming/array-memory-allocation.htm<i class="fa fa-external-link"></i></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Programming languages</category>
      </categories>
      <tags>
        <tag>C</tag>
        <tag>C++</tag>
        <tag>Pointer</tag>
      </tags>
  </entry>
  <entry>
    <title>C/C++ä¸­æŒ‡é’ˆç±»å‹å£°æ˜: `*`çš„ä½ç½®</title>
    <url>/2020/02/18/PL-C-pointer-declaration/</url>
    <content><![CDATA[<h1 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h1><p>æˆ‘ä»¬ç”¨ä¸¤ä¸ªç®€å•(?)çš„é—®é¢˜ä½œä¸ºå¼•å…¥ï¼Œå½“ç„¶æˆ‘ä»¬æ•´ç¯‡æ–‡ç« éƒ½ä¼šå›´ç»•è¿™ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>ä¸‹é¢å››ç§ç±»å‹å£°æ˜ç­‰ä»·å—ï¼Ÿ<ul>
<li><code>int* i;</code></li>
<li><code>int *i;</code></li>
<li><code>int * i;</code></li>
<li><code>int*i;</code></li>
</ul>
</li>
<li>ä¸‹é¢å››ç§ç±»å‹å£°æ˜ä¸­ï¼Œ<code>j</code>æ‹¥æœ‰å“ªä¸€ä¸ªæ•°æ®ç±»å‹ï¼Ÿæ˜¯<code>int</code>æˆ–è€…<code>int</code>çš„æŒ‡é’ˆ?<ul>
<li><code>int* i, j;</code></li>
<li><code>int *i, j;</code></li>
<li><code>int * i, j;</code></li>
<li><code>int*i, j;</code></li>
</ul>
</li>
</ol>
<p>å½“ç„¶çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœä½ å·²ç»æœ‰éå¸¸è‡ªä¿¡çš„ç­”æ¡ˆï¼Œä½ å½“ç„¶å¯ä»¥æ— è§†è¿™ä¸€ç¯‡æ–‡ç« åé¢çš„éƒ¨åˆ†ã€‚</p>
<a id="more"></a>
<p><br></p>
<h1 id="ç¬¬ä¸€ä¸ªé—®é¢˜"><a href="#ç¬¬ä¸€ä¸ªé—®é¢˜" class="headerlink" title="ç¬¬ä¸€ä¸ªé—®é¢˜"></a>ç¬¬ä¸€ä¸ªé—®é¢˜</h1><p><strong>ç¬¬ä¸€ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯:ã€€å››ç§æŒ‡é’ˆçš„ç±»å‹å£°æ˜çš„ç­‰ä»·çš„ã€‚</strong></p>
<p>å¾ˆå¥½ï¼Œæ—¢ç„¶æˆ‘ä»¬çŸ¥é“å®ƒä»¬ç­‰ä»·ï¼Œæˆ–è®¸å·²ç»è¶³å¤Ÿäº†ã€‚ä½†æ˜¯æˆ‘ä»¬æ•°æ®åº“æ•™æˆæ€»æ˜¯åœ¨è¯¾ä¸Šæé†’å¤§å®¶ï¼ŒçŸ¥é“åŒºåˆ«å¹¶ä¸è¶³å¤Ÿï¼Œè¿˜éœ€è¦é—®è‡ªå·±å…¶ä¸­çš„å“ªä¸€ä¸ªæ›´å¥½ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ç”¨å“ªä¸€ç§æ–¹å¼ã€‚</p>
<h2 id="å“ªä¸€ç§å†™æ³•æ›´å¥½å‘¢ï¼Ÿ"><a href="#å“ªä¸€ç§å†™æ³•æ›´å¥½å‘¢ï¼Ÿ" class="headerlink" title="å“ªä¸€ç§å†™æ³•æ›´å¥½å‘¢ï¼Ÿ"></a>å“ªä¸€ç§å†™æ³•æ›´å¥½å‘¢ï¼Ÿ</h2><p>C++ä¹‹çˆ¶åœ¨ä»–çš„ä¸€ç¯‡æ–‡ç« ï¼š<span class="exturl" data-url="aHR0cDovL3d3dy5zdHJvdXN0cnVwLmNvbS9ic19mYXEyLmh0bWwjd2hpdGVzcGFjZQ==" title="http://www.stroustrup.com/bs_faq2.html#whitespace">Bjarne Stroustrupâ€™s C++ Style and Technique FAQ<i class="fa fa-external-link"></i></span>ä¸­æåˆ°ï¼š</p>
<ul>
<li><blockquote>
<p>The choice between <code>int* p;</code> and <code>int *p;</code> is not about right and wrong, but about style and emphasis. C emphasized expressions; declarations were often considered little more than a necessary evil. C++, on the other hand, has a heavy emphasis on types.</p>
</blockquote>
</li>
<li><blockquote>
<p>A <code>typical C programmer</code> writes <code>int *p;</code> and explains it <code>*p is what is the int</code> emphasizing syntax, and may point to the C (and C++) declaration grammar to argue for the correctness of the style. Indeed, the * binds to the name p in the grammar.</p>
</blockquote>
</li>
<li><blockquote>
<p>A <code>typical C++ programmer</code> writes <code>int* p;</code> and explains it <code>p is a pointer to an int</code> emphasizing type. Indeed the type of p is int*. I clearly prefer that emphasis and see it as important for using the more advanced parts of C++ well.</p>
</blockquote>
</li>
</ul>
<p><br></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cua2VybmVsLm9yZy9kb2MvRG9jdW1lbnRhdGlvbi9wcm9jZXNzL2NvZGluZy1zdHlsZS5yc3Q=" title="https://www.kernel.org/doc/Documentation/process/coding-style.rst">Linux kernel coding style<i class="fa fa-external-link"></i></span>ä¸­çš„ä¹ æƒ¯è§„åˆ™æ˜¯ï¼š</p>
<blockquote>
<p>When declaring pointer data or a function that returns a pointer type, the<br>preferred use of <code>*</code> is adjacent to the data name or function name and not<br>adjacent to the type name.  Examples:<br></p><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">char</span> *linux_banner;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">memparse</span><span class="params">(<span class="keyword">char</span> *ptr, <span class="keyword">char</span> **retptr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">match_strdup</span><span class="params">(<span class="keyword">substring_t</span> *s)</span></span>;</span><br></pre></td></tr></tbody></table></figure><br>æŸç§ç¨‹åº¦ä¸Šå®ƒä¹Ÿæ‹Ÿåˆäº†C++ä¹‹çˆ¶Bjarne Stroustrupçš„æƒ³æ³•ã€‚<p></p>
</blockquote>
<p><br></p>
<h1 id="ç¬¬äºŒä¸ªé—®é¢˜"><a href="#ç¬¬äºŒä¸ªé—®é¢˜" class="headerlink" title="ç¬¬äºŒä¸ªé—®é¢˜"></a>ç¬¬äºŒä¸ªé—®é¢˜</h1><p><strong>ç¬¬äºŒä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯:ã€€<code>j</code>çš„ç±»å‹æ˜¯<code>int</code>ã€‚</strong></p>
<p>å½“ç„¶è¿™é—®é¢˜æ˜¯ç¼–è¯‘å™¨çš„è¡Œä¸ºï¼Œæˆ–è€…è¯­è¨€è‡ªèº«çš„è§„å®šï¼Œå¾ˆéš¾å»é˜è¿°è¡Œä¸ºæˆ–è§„å®šèƒŒåçš„ä¸ºä»€ä¹ˆã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­çœ‹<span class="exturl" data-url="aHR0cDovL3d3dy5zdHJvdXN0cnVwLmNvbS9ic19mYXEyLmh0bWwjd2hpdGVzcGFjZQ==" title="http://www.stroustrup.com/bs_faq2.html#whitespace">Bjarne Stroustrupâ€™s C++ Style and Technique FAQ<i class="fa fa-external-link"></i></span>ï¼Œè¿™éƒ¨åˆ†ç´§æ¥é—®é¢˜ä¸€ä¸­å¯¹åº”çš„å¼•ç”¨ï¼š</p>
<blockquote>
<p>The critical confusion comes (only) when people try to declare several pointers with a single declaration:<br>    <code>int* p, p1;    // probable error: p1 is not an int*</code><br>Placing the <em> closer to the name does not make this kind of error significantly less likely.<br>    `int </em>p, p1;    // probable error?<code>Declaring one name per declaration minimizes the problem - in particular when we initialize the variables. People are far less likely to write:</code>int<em> p = &amp;i;<code> </code>int p1 = p;    // error: int initialized by int</em>`<br>And if they do, the compiler will complain.</p>
</blockquote>
<p>ä»ä»–çš„è¿™ä¸€éƒ¨åˆ†æ–‡å­—ä¸­ï¼Œå¾ˆå®¹æ˜“å¯ä»¥çœ‹å‡ºæˆ‘ä»¬è¿™æ–‡ç« ä¸­çš„<strong>ç¬¬ä¸€ä¸ªé—®é¢˜</strong>å’Œ<strong>ç¬¬äºŒä¸ªé—®é¢˜</strong>å®Œå…¨æ˜¯ç´§å¯†ç»“åˆã€‚ç¬¬äºŒä¸ªé—®é¢˜ä¸­çš„å››ç§å†™æ³•çš„ç¡®æ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯æ— ä¸€èƒ½è®©äººè½»æ¾ç†è§£ã€‚ä»ä»–çš„è¿™ä¸€ä¸ªè§‚ç‚¹ä¸­ï¼š<code>Declaring one name per declaration minimizes the problem</code>ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¿™ç¯‡æ–‡ç« ä¸‹ä¸€ä¸ªä¸»è§‚çš„ç»“è®ºã€‚</p>
<p><br></p>
<h1 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h1><p>é’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¯¹æˆ‘æ¥è¯´æœ€å¥½çš„æ–¹å¼æ˜¯ï¼š<br></p><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">int</span>* i;</span><br><span class="line"><span class="keyword">int</span> j;</span><br></pre></td></tr></tbody></table></figure><br>è¿™ç§å†™æ³•æ›´æ¸…æ™°ï¼Œä¹Ÿæ˜¯å¤šä¸ªStackoverflowæé—®ä¸­æ‰€æå€¡çš„ã€‚<p></p>
<p>æœ€åä¸€ç‚¹å£°æ˜æ˜¯ï¼Œæ— è®ºæ€ä¹ˆå†™å¯¹ç¼–è¯‘å™¨æ¥è¯´å…¶å®éƒ½æ— æ‰€è°“ï¼Œå®ƒ<strong>åªæ˜¯å®¢è§‚</strong>åœ°å»æ£€æŸ¥èƒ½å¦é€šè¿‡ç¼–è¯‘ç„¶åç”Ÿæˆå¯¹åº”çš„ä»£ç ã€‚è¿™äº›ç­‰ä»·å†™æ³•å¯¹åº”çš„æ±‡ç¼–è¯­è¨€ç”šè‡³ä¸€æ ·ï¼Œå¯¹åº”çš„ç¨‹åºçš„æ•ˆèƒ½è‡ªç„¶ä¹Ÿæ˜¯ä¸€æ ·ã€‚è¿™äº›å†™æ³•è¿·æƒ‘çš„åªæ˜¯äººç±»(ç¼–ç¨‹çš„äººå’Œæµè§ˆä»£ç çš„äºº)ï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ–¹å¼ï¼Œä¿è¯è‡ªå·±ä¸å‡ºé”™åŒæ—¶ä¹Ÿè®©ä»£ç æµè§ˆè€…èƒ½å¿«é€Ÿç†è§£ã€‚</p>
<p><br></p>
<p>å¼•ç”¨å’Œæ¨èé˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5zdHJvdXN0cnVwLmNvbS9ic19mYXEyLmh0bWwjd2hpdGVzcGFjZQ==" title="http://www.stroustrup.com/bs_faq2.html#whitespace">http://www.stroustrup.com/bs_faq2.html#whitespace<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cua2VybmVsLm9yZy9kb2MvRG9jdW1lbnRhdGlvbi9wcm9jZXNzL2NvZGluZy1zdHlsZS5yc3Q=" title="https://www.kernel.org/doc/Documentation/process/coding-style.rst">https://www.kernel.org/doc/Documentation/process/coding-style.rst<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zb2Z0d2FyZWVuZ2luZWVyaW5nLnN0YWNrZXhjaGFuZ2UuY29tL3F1ZXN0aW9ucy83MzA1L2ludC1pLW9yLWludC1pLW9yLWludC1p" title="https://softwareengineering.stackexchange.com/questions/7305/int-i-or-int-i-or-int-i">https://softwareengineering.stackexchange.com/questions/7305/int-i-or-int-i-or-int-i<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNjk5MDcyNi9jb3JyZWN0LXdheS1vZi1kZWNsYXJpbmctcG9pbnRlci12YXJpYWJsZXMtaW4tYy1j" title="https://stackoverflow.com/questions/6990726/correct-way-of-declaring-pointer-variables-in-c-c">https://stackoverflow.com/questions/6990726/correct-way-of-declaring-pointer-variables-in-c-c<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTM4OTQyMjgvd2hlcmUtdG8tcHV0LXRoZS1zdGFyLWluLWMtYW5kLWMtcG9pbnRlci1ub3RhdGlvbg==" title="https://stackoverflow.com/questions/13894228/where-to-put-the-star-in-c-and-c-pointer-notation">https://stackoverflow.com/questions/13894228/where-to-put-the-star-in-c-and-c-pointer-notation<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMjcwNDE2Ny90eXBlLWRlY2xhcmF0aW9uLXBvaW50ZXItYXN0ZXJpc2stcG9zaXRpb24=" title="https://stackoverflow.com/questions/2704167/type-declaration-pointer-asterisk-position">https://stackoverflow.com/questions/2704167/type-declaration-pointer-asterisk-position<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzk4Mzk1L3doeS1pcy10aGUtYXN0ZXJpc2stYmVmb3JlLXRoZS12YXJpYWJsZS1uYW1lLXJhdGhlci10aGFuLWFmdGVyLXRoZS10eXBl" title="https://stackoverflow.com/questions/398395/why-is-the-asterisk-before-the-variable-name-rather-than-after-the-type">https://stackoverflow.com/questions/398395/why-is-the-asterisk-before-the-variable-name-rather-than-after-the-type<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTgwNDAxL3BsYWNlbWVudC1vZi10aGUtYXN0ZXJpc2staW4tcG9pbnRlci1kZWNsYXJhdGlvbnM=" title="https://stackoverflow.com/questions/180401/placement-of-the-asterisk-in-pointer-declarations">https://stackoverflow.com/questions/180401/placement-of-the-asterisk-in-pointer-declarations<i class="fa fa-external-link"></i></span></p>
<p>(Stackoverflowç»Ÿç»Ÿæ˜¯åœ¨é—®åŒä¸€ä»¶é—®é¢˜)<br><!-- 
è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Programming languages</category>
      </categories>
      <tags>
        <tag>C</tag>
        <tag>C++</tag>
        <tag>Pointer</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-Shell] 195.tenth line</title>
    <url>/2020/02/18/Shell-Leetcode-195TenthLine/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>195.Tenth Line</p>
<p>Given a text file <code>file.txt</code>, print just the 10th line of the file.</p>
<p>Example:</p>
<p>Assume that <code>file.txt</code> has the following content:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">Line 1</span><br><span class="line">Line 2</span><br><span class="line">Line 3</span><br><span class="line">Line 4</span><br><span class="line">Line 5</span><br><span class="line">Line 6</span><br><span class="line">Line 7</span><br><span class="line">Line 8</span><br><span class="line">Line 9</span><br><span class="line">Line 10</span><br></pre></td></tr></tbody></table></figure>
<p>Your script should output the tenth line, which is:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">Line 10</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<hr>
<h1 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h1><p>éœ€è¦æ³¨æ„ä¸€ä¸‹å®ƒæä¾›çš„noteï¼Œå…¶å®testä¹Ÿæ¶µç›–äº†noteæåˆ°çš„ä¸¤ç‚¹ï¼š</p>
<p>Note:</p>
<ol>
<li>If the file contains less than 10 lines, what should you output?</li>
<li>Thereâ€™s at least three different solutions. Try to explore all possibilities.</li>
</ol>
<h1 id="å°è¯•ï¼‘"><a href="#å°è¯•ï¼‘" class="headerlink" title="å°è¯•ï¼‘"></a>å°è¯•ï¼‘</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">head -10 file.txt | tail -1</span><br></pre></td></tr></tbody></table></figure>
<p>ç¼ºç‚¹æ˜¯é»˜è®¤äº†æ–‡ä»¶å¿…é¡»å¤§äºç­‰äºåè¡Œã€‚</p>
<ul>
<li>å¦‚æœæ–‡ä»¶å°‘äºåè¡Œ, <code>head -10 file.txt</code>ä¼šè¾“å‡ºæ•´ä¸ªæ–‡ä»¶(æ¯”å¦‚å®ƒä»…æœ‰çš„ï¼˜è¡Œ)ï¼Œ<code>tail -1</code>ä¹‹åè·å¾—å¯¹åº”çš„æœ€åä¸€è¡Œ(æ¯”å¦‚ç¬¬ï¼˜è¡Œ)ã€‚</li>
</ul>
<p><img data-src="/images/Leetcode/195_1.png" alt="195_1.png"></p>
<p><br></p>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">head -n 10 file.txt | tail -n +10</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>head -n 10 file.txt</code>: å¾—åˆ°å‰åè¡Œï¼Œæˆ–è€…æ•´ä¸ªæ–‡ä»¶(å¦‚æœè¿™ä¸ªæ–‡ä»¶å°‘äºåè¡Œ)ã€‚</li>
<li><code>tail -n +10</code>: å¾—åˆ°ä»ç¬¬åè¡Œä»¥åŠå®ƒåé¢çš„æ‰€æœ‰ã€‚</li>
</ul>
<blockquote>
<pre><code>   -n, --lines=[+]NUM
         output the last NUM lines, instead of the last 10; or use -n +NUM to output starting with line NUM
</code></pre></blockquote>
<p>è¿™æ ·å¦‚æœæ–‡ä»¶å°‘äºåè¡Œï¼Œä¸ä¼šè¾“å‡ºæœ€åä¸€è¡Œï¼Œè€Œæ˜¯è¾“å‡ºä¸º<strong>ç©º</strong>ã€‚</p>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">cat file.txt | sed -n <span class="string">'10p'</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>-n</code>: åªæ˜¾ç¤ºå¯¹åº”çš„è¡Œæ•°ã€‚è‹¥æ²¡æœ‰ä¼šè¾“å‡ºå…¨éƒ¨</li>
<li><code>'10p'</code>: ä¸­çš„<code>p</code>æŒ‡print</li>
</ul>
<blockquote>
<pre><code>   -n, --quiet, --silent
         suppress automatic printing of pattern space

   p      Print the current pattern space.

  number      Match only the specified line number (which increments  cumulaâ€
              tively  across  files, unless the -s option is specified on the
              command line).
</code></pre></blockquote>
<p><br></p>
<h1 id="è§£æ³•ï¼“"><a href="#è§£æ³•ï¼“" class="headerlink" title="è§£æ³•ï¼“"></a>è§£æ³•ï¼“</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">cat file.txt | sed <span class="string">'10!d'</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>d</code>:ã€€æŒ‡åˆ é™¤</li>
</ul>
<blockquote>
<pre><code>   d      Delete pattern space.  Start next cycle.
</code></pre></blockquote>
<p><br></p>
<h1 id="è§£æ³•ï¼”"><a href="#è§£æ³•ï¼”" class="headerlink" title="è§£æ³•ï¼”"></a>è§£æ³•ï¼”</h1><p>è¿™é‡Œæœ‰å››ç§ç­‰ä»·çš„ä½¿ç”¨<code>awk</code>çš„è¡¨è¾¾ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#awk example 1</span></span><br><span class="line">cat file.txt | awk <span class="string">'NR==10'</span></span><br><span class="line"><span class="comment">#awk example 2</span></span><br><span class="line">cat file.txt | awk <span class="string">'NR==10{print}'</span></span><br><span class="line"><span class="comment">#awk example 3</span></span><br><span class="line">cat file.txt | awk <span class="string">'{if(NR==10) print}'</span></span><br><span class="line"><span class="comment">#awk example 4 å®Œæ•´ç‰ˆ</span></span><br><span class="line">cat file.txt | awk <span class="string">'BEGIN{}; { if(NR==10) {print;} }; END{};'</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨å’Œæ¨èé˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvdGVudGgtbGluZS8=" title="https://leetcode.com/problems/tenth-line/">https://leetcode.com/problems/tenth-line/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cDovL2JpZ2RhdHVtcy5uZXQvMjAxNi8wMi8yMi8zLXdheXMtdG8tZ2V0LXRoZS1udGgtbGluZS1vZi1hLWZpbGUtaW4tbGludXgv" title="http://bigdatums.net/2016/02/22/3-ways-to-get-the-nth-line-of-a-file-in-linux/">http://bigdatums.net/2016/02/22/3-ways-to-get-the-nth-line-of-a-file-in-linux/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvdGVudGgtbGluZS9kaXNjdXNzLzU1NTQ0L1NoYXJlLWZvdXItZGlmZmVyZW50LXNvbHV0aW9uc++8mg==" title="https://leetcode.com/problems/tenth-line/discuss/55544/Share-four-different-solutionsï¼š">https://leetcode.com/problems/tenth-line/discuss/55544/Share-four-different-solutionsï¼š<i class="fa fa-external-link"></i></span> æœ‰ä¸€äº›å¥‡æ€ªçš„è§£æ³•<br><!-- 
è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Leetcode</category>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>Shell</tag>
        <tag>GNU Coreutils</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-Shell] 194.transpose file</title>
    <url>/2020/02/18/Shell-Leetcode-194TransposeFile/</url>
    <content><![CDATA[<p>194.Transpose File</p>
<p>Given a text file <code>file.txt</code>, transpose its content.</p>
<p>You may assume that each row has the same number of columns and each field is separated by the <code>' '</code> character.</p>
<p>Example:</p>
<p>If <code>file.txt</code> has the following content:<br></p><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">name age</span><br><span class="line">alice 21</span><br><span class="line">ryan 30</span><br></pre></td></tr></tbody></table></figure><br>Output the following:<br><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">name alice ryan</span><br><span class="line">age 21 30</span><br></pre></td></tr></tbody></table></figure><p></p>
<a id="more"></a>
<hr>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">awk -F <span class="string">' '</span> <span class="string">'</span></span><br><span class="line"><span class="string">BEGIN { ORS=""; i=0; nf=1;}; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">{ </span></span><br><span class="line"><span class="string">    { for(line=1; line&lt;=NF; line++)</span></span><br><span class="line"><span class="string">        { N[FNR][line] = $line; nf=NF;}; i++</span></span><br><span class="line"><span class="string">    } </span></span><br><span class="line"><span class="string">}; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">END { for(itnf=1; itnf&lt;=nf; itnf++)</span></span><br><span class="line"><span class="string">        { for(it=1;it&lt;=i;it++) {</span></span><br><span class="line"><span class="string">            print N[it][itnf]; </span></span><br><span class="line"><span class="string">            { if(it != i) print " "; } </span></span><br><span class="line"><span class="string">        }; </span></span><br><span class="line"><span class="string">        print "\n"; </span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">}'</span>ã€€file.txt</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>BEGIN { ORS=""; }</code>: æ¯æ¬¡è¾“å‡ºåä¸å¿…è‡ªåŠ¨æ¢è¡Œ, ç›´æ¥è¿ç€è¾“å‡ºä¸‹ä¸€ä¸ªã€‚(è¿™é¢˜ä¸­è¾“å‡ºç©ºæ ¼å’Œæ¢è¡Œç”±æˆ‘ä»¬è‡ªå·±æ§åˆ¶ã€‚)<blockquote>
<p>ORS         The output record separator, by default a newline.</p>
</blockquote>
</li>
<li><code>i</code>ä¸ºè¡Œå·ï¼Œè‡ªç„¶ä»0å¼€å§‹è®¡æ•°ã€‚</li>
<li><code>NR</code>: å½“å‰è¡Œå·(current line number)ï¼Œä½†æ˜¯ä¼šåœ¨å¤šä¸ªæ–‡ä»¶ä¹‹é—´è¢«ç´¯è®¡ã€‚</li>
<li><code>FNR</code>: å½“å‰æ–‡ä»¶çš„è¡Œå·ã€‚</li>
<li><code>NF</code>: å½“å‰è¡Œä¸­å­—æ®µçš„æ€»æ•°ã€‚</li>
<li>ä½†æ˜¯è¿™é¢˜ä¸­æˆ‘ä»¬çš„<strong>äºŒç»´æ•°ç»„<code>N</code>ä¸¤ä¸ªç»´åº¦çš„è§’æ ‡éƒ½ä»<code>1</code>å¼€å§‹</strong>ã€‚</li>
<li>æ€è·¯å°±æ˜¯ä½¿ç”¨ä¸€ä¸ªäºŒç»´æ•°ç»„ç”¨è¡Œçš„æ–¹å¼å»å­˜å‚¨ï¼Œä½†æ˜¯ç”¨åˆ—çš„æ–¹å¼å»è¾“å‡ºã€‚(å³Transposeè¿™è¯çš„æ„æ€ã€‚)</li>
</ul>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">awk <span class="string">'</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">    for (i = 1; i &lt;= NF; i++) {</span></span><br><span class="line"><span class="string">        if (FNR == 1) {</span></span><br><span class="line"><span class="string">            t[i] = $i;</span></span><br><span class="line"><span class="string">        } else {</span></span><br><span class="line"><span class="string">            t[i] = t[i] " " $i</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">}</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">END {</span></span><br><span class="line"><span class="string">    for (i = 1; t[i] != ""; i++) {</span></span><br><span class="line"><span class="string">        print t[i]</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">}</span></span><br><span class="line"><span class="string">'</span> file.txt</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ€è·¯ç±»ä¼¼ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨äºŒä½æ•°ç»„ã€‚</li>
<li><code>t[i] = t[i] " " $i</code>: è€Œæ˜¯å¯¹æºæ–‡ä»¶ä¸­æ¯ä¸€è¡Œä¸­çš„å­—æ®µä»¥æ­¤å¹¶å…¥(append)æ•°ç»„çš„æ¯ä¸€ä¸ªä½ç½®ã€‚</li>
</ul>
<p>å¼•ç”¨å’Œæ¨èé˜…è¯»:</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvdHJhbnNwb3NlLWZpbGUv" title="https://leetcode.com/problems/transpose-file/">https://leetcode.com/problems/transpose-file/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvdHJhbnNwb3NlLWZpbGUvZGlzY3Vzcy8xMTEzODIvU29sdXRpb24tdXNpbmctQVdLLXdpdGgtZXhwbGFuYXRpb25z" title="https://leetcode.com/problems/transpose-file/discuss/111382/Solution-using-AWK-with-explanations">https://leetcode.com/problems/transpose-file/discuss/111382/Solution-using-AWK-with-explanations<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzI0MzMxNzM1LzgwNDk0MDg=" title="https://stackoverflow.com/a/24331735/8049408">https://stackoverflow.com/a/24331735/8049408<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZ3J5bW9pcmUuY29tL1VuaXgvQXdrLmh0bWw=" title="https://www.grymoire.com/Unix/Awk.html">https://www.grymoire.com/Unix/Awk.html<i class="fa fa-external-link"></i></span><br><!-- 
è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Leetcode</category>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>Shell</tag>
        <tag>GNU Coreutils</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-Shell] 193.valid phone numbers</title>
    <url>/2020/02/18/Shell-Leetcode-193ValidPhoneNumbers/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>193.Valid Phone Numbers</p>
<p>Given a text file <code>file.txt</code> that contains list of phone numbers (one per line), write a one liner bash script to print all valid phone numbers.</p>
<p>You may assume that a valid phone number must appear in one of the following two formats: (xxx) xxx-xxxx or xxx-xxx-xxxx. (x means a digit)</p>
<p>You may also assume each line in the text file must not contain leading or trailing white spaces.</p>
<p>Example:</p>
<p>Assume that <code>file.txt</code> has the following content:<br></p><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">987-123-4567</span><br><span class="line">123 456 7890</span><br><span class="line">(123) 456-7890</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>Your script should output the following valid phone numbers:<br></p><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">987-123-4567</span><br><span class="line">(123) 456-7890</span><br></pre></td></tr></tbody></table></figure><p></p>
<a id="more"></a>
<hr>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="è§£æ³•ï¼‘"></a>è§£æ³•ï¼‘</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Read from the file file.txt and output all valid phone numbers to stdout.</span></span><br><span class="line">cat file.txt | grep -P <span class="string">'(^\(\d{3}\) \d{3}-\d{4}$)|(^\d{3}-\d{3}-\d{4}$)'</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">grep -P <span class="string">'^(\d{3}-|\(\d{3}\) )\d{3}-\d{4}$'</span> file.txt</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>\</code> è½¬ä¹‰ç¬¦: to escape next one trailing character</li>
</ul>
<blockquote>
<pre><code>   -P, --perl-regexp
          Interpret the pattern as a Perl-compatible regular expression (PCRE).  
          This is experimental and grep -P may warn of unimplemented features.
</code></pre></blockquote>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sed -n -r <span class="string">'/^([0-9]{3}-|\([0-9]{3}\) )[0-9]{3}-[0-9]{4}$/p'</span> file.txt</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<pre><code>   -n, --quiet, --silent
         suppress automatic printing of pattern space

  -E, -r, --regexp-extended
         use extended regular expressions in the script (for portability use POSIX -E).
</code></pre></blockquote>
<p><br></p>
<h1 id="è§£æ³•ï¼“"><a href="#è§£æ³•ï¼“" class="headerlink" title="è§£æ³•ï¼“"></a>è§£æ³•ï¼“</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">awk <span class="string">'/^([0-9]{3}-|\([0-9]{3}\) )[0-9]{3}-[0-9]{4}$/'</span> file.txt</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨å’Œæ¨èé˜…è¯»ï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvdmFsaWQtcGhvbmUtbnVtYmVycy8=" title="https://leetcode.com/problems/valid-phone-numbers/">https://leetcode.com/problems/valid-phone-numbers/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvdmFsaWQtcGhvbmUtbnVtYmVycy9kaXNjdXNzLzU1NDgxL1RocmVlLWRpZmZlcmVudC1zb2x1dGlvbnMtdXNpbmctZ3JlcC1zZWQtYW5kLWF3aw==" title="https://leetcode.com/problems/valid-phone-numbers/discuss/55481/Three-different-solutions-using-grep-sed-and-awk">https://leetcode.com/problems/valid-phone-numbers/discuss/55481/Three-different-solutions-using-grep-sed-and-awk<i class="fa fa-external-link"></i></span><br><!-- 
è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Leetcode</category>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>Shell</tag>
        <tag>GNU Coreutils</tag>
      </tags>
  </entry>
  <entry>
    <title>[Leetcode-Shell] 192.word frequency</title>
    <url>/2020/02/18/Shell-Leetcode-192wordfrequency/</url>
    <content><![CDATA[<h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>192.Word Frequency</p>
<p>Write a bash script to calculate the frequency of each word in a text file <code>words.txt</code>.</p>
<p>For simplicity sake, you may assume:</p>
<p><code>words.txt</code> contains only lowercase characters and space â€˜ â€˜ characters.<br>Each word must consist of lowercase characters only.<br>Words are separated by one or more whitespace characters.<br>Example:</p>
<p>Assume that <code>words.txt</code> has the following content:<br></p><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">the day is sunny the the</span><br><span class="line">the sunny is is</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>Your script should output the following, sorted by descending frequency:<br></p><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">the 4</span><br><span class="line">is 3</span><br><span class="line">sunny 2</span><br><span class="line">day 1</span><br></pre></td></tr></tbody></table></figure><p></p>
<a id="more"></a>
<hr>
<h1 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h1><p>Note:</p>
<ul>
<li>Donâ€™t worry about handling ties, it is guaranteed that each wordâ€™s frequency count is unique.</li>
<li>Could you write it in one-line using Unix pipes?</li>
</ul>
<h1 id="è§£æ³•ï¼‘"><a href="#è§£æ³•ï¼‘" class="headerlink" title="ã€€è§£æ³•ï¼‘"></a>ã€€è§£æ³•ï¼‘</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Read from the file words.txt and output the word frequency list to stdout.</span></span><br><span class="line">cat words.txt | awk -F <span class="string">' '</span> <span class="string">'{ for(i=1; i&lt;=NF; i++) print $i }'</span> | sort | uniq -c | sort -n -r | awk -F <span class="string">' '</span> <span class="string">'{ print $2, $1}'</span></span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<pre><code>   The variable NF is set to the total number of fields in the input record.
</code></pre></blockquote>
<p><br></p>
<h1 id="è§£æ³•ï¼’"><a href="#è§£æ³•ï¼’" class="headerlink" title="è§£æ³•ï¼’"></a>è§£æ³•ï¼’</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">cat words.txt | tr -s <span class="string">' '</span> <span class="string">'\n'</span> | sort | uniq -c | sort -n -r | awk <span class="string">'{ print $2, $1 }'</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>tr -s ' ' '\n'</code>:  <strong>å°†å¤šä¸ª<code>' '</code>ã€€æ›¿æ¢ä¸ºå•ä¸ª<code>\n</code></strong></li>
</ul>
<blockquote>
<p>tr - translate or delete characters</p>
<pre><code>   -s, --squeeze-repeats
          replace each sequence of a repeated character that is listed in the last specified SET, with a single occurrence of that character
</code></pre></blockquote>
<p><br></p>
<h1 id="è§£æ³•ï¼“ï¼šä¸è§£æ³•ï¼’å¯¹æ¯”"><a href="#è§£æ³•ï¼“ï¼šä¸è§£æ³•ï¼’å¯¹æ¯”" class="headerlink" title="è§£æ³•ï¼“ï¼šä¸è§£æ³•ï¼’å¯¹æ¯”"></a>è§£æ³•ï¼“ï¼šä¸è§£æ³•ï¼’å¯¹æ¯”</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">cat words.txt | sed <span class="string">'s/\s/\n/g'</span> | sort | uniq -c | sort -n -r | awk <span class="string">'{ if($2 != "") print $2, $1 }'</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>sed 's/ /\n/g'</code>:  <strong>å°†å•ä¸ª<code>' '</code>ã€€æ›¿æ¢ä¸ºå•ä¸ª<code>\n</code></strong></li>
<li>å¦‚æœæœ‰å¤šä¸ª<code>' '</code>ä¹Ÿå°±ä¼šç”Ÿæˆå¤šä¸ª<code>'\n'</code>,ä½†æ˜¯æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªã€‚</li>
<li>åŒæ—¶å¤šç”Ÿæˆçš„<code>'\n'</code>ä¹Ÿä¼šè¢«è®¡æ•°ã€‚</li>
<li><code>if($2 != "")</code>ï¼šæˆ‘ä»¬åœ¨<code>awk</code>è¾“å‡ºçš„æ—¶å€™å¯¹<strong>ç©ºè¡Œ(æ¢è¡Œç¬¦)</strong>è¿›è¡Œæ£€æŸ¥ã€‚</li>
</ul>
<p><br></p>
<h1 id="è§£æ³•ï¼”"><a href="#è§£æ³•ï¼”" class="headerlink" title="è§£æ³•ï¼”"></a>è§£æ³•ï¼”</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">awk <span class="string">'{ for (i=1; i&lt;=NF; i++) { ++D[$i]; } } END { for (i in D) { print i, D[i] } }'</span> words.txt | sort -n -r -k 2</span><br></pre></td></tr></tbody></table></figure>
<p>å¼•ç”¨å’Œæ¨èé˜…è¯»:</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvd29yZC1mcmVxdWVuY3kv" title="https://leetcode.com/problems/word-frequency/">https://leetcode.com/problems/word-frequency/<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly91bml4LnN0YWNrZXhjaGFuZ2UuY29tL2EvMzc4NTUwLzMyMzIxMA==" title="https://unix.stackexchange.com/a/378550/323210">https://unix.stackexchange.com/a/378550/323210<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvd29yZC1mcmVxdWVuY3kvZGlzY3Vzcy81NTQ0My9NeS1zaW1wbGUtc29sdXRpb24tKG9uZS1saW5lLXdpdGgtcGlwZQ==" title="https://leetcode.com/problems/word-frequency/discuss/55443/My-simple-solution-(one-line-with-pipe">https://leetcode.com/problems/word-frequency/discuss/55443/My-simple-solution-(one-line-with-pipe<i class="fa fa-external-link"></i></span>)</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvd29yZC1mcmVxdWVuY3kvZGlzY3Vzcy81NTQ2Mi9Tb2x1dGlvbi11c2luZy1hd2stYW5kLXBpcGVzLXdpdGgtZXhwbGFpbmF0aW9u" title="https://leetcode.com/problems/word-frequency/discuss/55462/Solution-using-awk-and-pipes-with-explaination">https://leetcode.com/problems/word-frequency/discuss/55462/Solution-using-awk-and-pipes-with-explaination<i class="fa fa-external-link"></i></span><br><!-- 
è¯¥æ–‡ç« éµå¾ª[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh)ï¼Œè¦æ±‚ç½²åã€éå•†ä¸š ã€ä¿æŒä¸€è‡´ã€‚åœ¨æ»¡è¶³[åˆ›ä½œå…±ç”¨ç‰ˆæƒåè®® CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) çš„åŸºç¡€ä¸Šå¯ä»¥è½¬è½½ï¼Œä½†è¯·ä»¥è¶…é“¾æ¥å½¢å¼æ³¨æ˜å‡ºå¤„ã€‚æ–‡ç« ä»…ä»£è¡¨ä½œè€…çš„çŸ¥è¯†å’Œçœ‹æ³•ï¼Œå¦‚æœ‰ä¸åŒè§‚ç‚¹ï¼Œå¯ä»¥å›å¤å¹¶è®¨è®ºã€‚ --></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>Leetcode</category>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>Shell</tag>
        <tag>GNU Coreutils</tag>
      </tags>
  </entry>
</search>
